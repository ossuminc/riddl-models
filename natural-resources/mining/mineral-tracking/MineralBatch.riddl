// Mineral Tracking - MineralBatch Entity

entity MineralBatch is {

  command RecordExtraction is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "New batch identifier."
    }
    extractionInfo is ExtractionInfo with {
      briefly "Extraction info"
      described by "Ore extraction details."
    }
  } with {
    briefly "Record extraction"
    described by "Records ore extraction from mine face."
  }

  command RecordAssayResult is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    assayResult is AssayResult with {
      briefly "Assay result"
      described by "Assay analysis result."
    }
  } with {
    briefly "Record assay result"
    described by "Records mineral assay analysis for batch."
  }

  command MoveToStockpile is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    stockpileInfo is StockpileInfo with {
      briefly "Stockpile"
      described by "Target stockpile details."
    }
  } with {
    briefly "Move to stockpile"
    described by "Moves batch to stockpile location."
  }

  command StartProcessing is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    plantId is UUID with {
      briefly "Plant"
      described by "Processing plant identifier."
    }
    inputTonnage is Decimal(12, 2) with {
      briefly "Input tonnage"
      described by "Tonnage sent to plant."
    }
  } with {
    briefly "Start processing"
    described by "Starts processing batch at plant."
  }

  command RecordProcessingResult is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    processingRecord is ProcessingRecord with {
      briefly "Processing record"
      described by "Processing throughput record."
    }
  } with {
    briefly "Record processing result"
    described by "Records processing plant output for batch."
  }

  command ReconcileGrade is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    reconciliation is GradeReconciliation with {
      briefly "Reconciliation"
      described by "Grade reconciliation data."
    }
  } with {
    briefly "Reconcile grade"
    described by "Reconciles expected versus actual mineral grade."
  }

  command ShipToSmelter is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    shipmentInfo is ShipmentInfo with {
      briefly "Shipment"
      described by "Smelter shipment details."
    }
  } with {
    briefly "Ship to smelter"
    described by "Ships concentrate to smelter."
  }

  command ConfirmDelivery is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery date and time."
    }
    receivedTonnage is Decimal(12, 2) with {
      briefly "Received tonnage"
      described by "Tonnage received at smelter."
    }
  } with {
    briefly "Confirm delivery"
    described by "Confirms smelter delivery of shipment."
  }

  command RejectBatch is {
    batchId is MineralBatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
  } with {
    briefly "Reject batch"
    described by "Rejects a mineral batch due to quality or other issues."
  }

  // Events
  event ExtractionRecorded is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    extractionInfo is ExtractionInfo with { briefly "Info" described by "Extraction details." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Extraction recorded"
    described by "Emitted when ore extraction is recorded."
  }

  event AssayResultRecorded is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    assayResult is AssayResult with { briefly "Result" described by "Assay result." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Assay result recorded"
    described by "Emitted when assay result is recorded."
  }

  event MovedToStockpile is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    stockpileId is StockpileId with { briefly "Stockpile" described by "Stockpile ID." }
    movedAt is TimeStamp with { briefly "Moved" described by "Movement time." }
  } with {
    briefly "Moved to stockpile"
    described by "Emitted when batch is moved to stockpile."
  }

  event ProcessingStarted is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    plantId is UUID with { briefly "Plant" described by "Plant ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Processing started"
    described by "Emitted when batch processing begins."
  }

  event ProcessingResultRecorded is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    processingRecord is ProcessingRecord with { briefly "Record" described by "Processing record." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Processing result recorded"
    described by "Emitted when processing result is recorded."
  }

  event GradeReconciled is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    reconciliation is GradeReconciliation with { briefly "Reconciliation" described by "Grade reconciliation." }
    reconciledAt is TimeStamp with { briefly "Reconciled" described by "Reconciliation time." }
  } with {
    briefly "Grade reconciled"
    described by "Emitted when grade reconciliation is completed."
  }

  event ShippedToSmelter is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    shipmentInfo is ShipmentInfo with { briefly "Shipment" described by "Shipment details." }
    shippedAt is TimeStamp with { briefly "Shipped" described by "Shipment time." }
  } with {
    briefly "Shipped to smelter"
    described by "Emitted when concentrate is shipped to smelter."
  }

  event DeliveryConfirmed is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Delivery confirmed"
    described by "Emitted when smelter delivery is confirmed."
  }

  event BatchRejected is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Batch rejected"
    described by "Emitted when batch is rejected."
  }

  // States
  record ActiveBatchData is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    extractionInfo is ExtractionInfo with { briefly "Extraction" described by "Extraction details." }
    status is BatchStatus with { briefly "Status" described by "Batch status." }
    assayResults is many optional AssayResult with { briefly "Assays" described by "Assay results." }
    stockpileInfo is optional StockpileInfo with { briefly "Stockpile" described by "Stockpile info." }
    processingRecords is many optional ProcessingRecord with { briefly "Processing" described by "Processing records." }
    reconciliations is many optional GradeReconciliation with { briefly "Reconciliations" described by "Grade reconciliations." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active batch state"
    described by "State for a mineral batch being tracked."
  }

  record DeliveredBatchData is {
    batchId is MineralBatchId with { briefly "Batch" described by "Batch ID." }
    shipmentInfo is ShipmentInfo with { briefly "Shipment" described by "Shipment details." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    receivedTonnage is Decimal(12, 2) with { briefly "Received" described by "Tonnage received." }
  } with {
    briefly "Delivered batch state"
    described by "State for a batch delivered to smelter."
  }

  state ActiveBatchState of MineralBatch.ActiveBatchData with {
    briefly "Batch active"
    described by "Mineral batch is being tracked through lifecycle."
  }

  state DeliveredBatchState of MineralBatch.DeliveredBatchData with {
    briefly "Batch delivered"
    described by "Mineral batch has been delivered to smelter."
  }

  handler MineralBatchHandler is {
    on command RecordExtraction {
      morph entity MineralTrackingContext.MineralBatch to state MineralTrackingContext.MineralBatch.ActiveBatchState with command RecordExtraction
      tell event ExtractionRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command RecordAssayResult {
      tell event AssayResultRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command MoveToStockpile {
      tell event MovedToStockpile to entity MineralTrackingContext.MineralBatch
    }
    on command StartProcessing {
      tell event ProcessingStarted to entity MineralTrackingContext.MineralBatch
    }
    on command RecordProcessingResult {
      tell event ProcessingResultRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command ReconcileGrade {
      tell event GradeReconciled to entity MineralTrackingContext.MineralBatch
    }
    on command ShipToSmelter {
      tell event ShippedToSmelter to entity MineralTrackingContext.MineralBatch
    }
    on command ConfirmDelivery {
      morph entity MineralTrackingContext.MineralBatch to state MineralTrackingContext.MineralBatch.DeliveredBatchState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity MineralTrackingContext.MineralBatch
    }
    on command RejectBatch {
      tell event BatchRejected to entity MineralTrackingContext.MineralBatch
    }
  } with {
    briefly "Processes mineral batch commands"
    described by "Handles mineral batch lifecycle."
  }

} with {
  briefly "MineralBatch aggregate"
  described by "Manages mineral batches from extraction through smelter delivery."
}
