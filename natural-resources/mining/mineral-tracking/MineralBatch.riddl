// Mineral Tracking - MineralBatch Entity
entity MineralBatch is {
  command RecordExtraction is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |New batch identifier.
      }
    }
    extractionInfo: ExtractionInfo with {
      briefly "Extraction info"
      described as {
        |Ore extraction details.
      }
    }
  } with {
    briefly "Record extraction"
    described as {
      |Records ore extraction from mine face.
    }
  }
  command RecordAssayResult is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    assayResult: AssayResult with {
      briefly "Assay result"
      described as {
        |Assay analysis result.
      }
    }
  } with {
    briefly "Record assay result"
    described as {
      |Records mineral assay analysis for batch.
    }
  }
  command MoveToStockpile is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    stockpileInfo: StockpileInfo with {
      briefly "Stockpile"
      described as {
        |Target stockpile details.
      }
    }
  } with {
    briefly "Move to stockpile"
    described as {
      |Moves batch to stockpile location.
    }
  }
  command StartProcessing is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    plantId: UUID with {
      briefly "Plant"
      described as {
        |Processing plant identifier.
      }
    }
    inputTonnage: Decimal(12,2) with {
      briefly "Input tonnage"
      described as {
        |Tonnage sent to plant.
      }
    }
  } with {
    briefly "Start processing"
    described as {
      |Starts processing batch at plant.
    }
  }
  command RecordProcessingResult is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    processingRecord: ProcessingRecord with {
      briefly "Processing record"
      described as {
        |Processing throughput record.
      }
    }
  } with {
    briefly "Record processing result"
    described as {
      |Records processing plant output for batch.
    }
  }
  command ReconcileGrade is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    reconciliation: GradeReconciliation with {
      briefly "Reconciliation"
      described as {
        |Grade reconciliation data.
      }
    }
  } with {
    briefly "Reconcile grade"
    described as {
      |Reconciles expected versus actual mineral grade.
    }
  }
  command ShipToSmelter is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    shipmentInfo: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Smelter shipment details.
      }
    }
  } with {
    briefly "Ship to smelter"
    described as {
      |Ships concentrate to smelter.
    }
  }
  command ConfirmDelivery is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment identifier.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery date and time.
      }
    }
    receivedTonnage: Decimal(12,2) with {
      briefly "Received tonnage"
      described as {
        |Tonnage received at smelter.
      }
    }
  } with {
    briefly "Confirm delivery"
    described as {
      |Confirms smelter delivery of shipment.
    }
  }
  command RejectBatch is  {
    batchId: MineralBatchId with {
      briefly "Batch ID"
      described as {
        |Batch identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject batch"
    described as {
      |Rejects a mineral batch due to quality or other issues.
    }
  }
  // Events
  event ExtractionRecorded is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    extractionInfo: ExtractionInfo with {
      briefly "Info"
      described as {
        |Extraction details.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Extraction recorded"
    described as {
      |Emitted when ore extraction is recorded.
    }
  }
  event AssayResultRecorded is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    assayResult: AssayResult with {
      briefly "Result"
      described as {
        |Assay result.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Assay result recorded"
    described as {
      |Emitted when assay result is recorded.
    }
  }
  event MovedToStockpile is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    stockpileId: StockpileId with {
      briefly "Stockpile"
      described as {
        |Stockpile ID.
      }
    }
    movedAt: TimeStamp with {
      briefly "Moved"
      described as {
        |Movement time.
      }
    }
  } with {
    briefly "Moved to stockpile"
    described as {
      |Emitted when batch is moved to stockpile.
    }
  }
  event ProcessingStarted is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    plantId: UUID with {
      briefly "Plant"
      described as {
        |Plant ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Processing started"
    described as {
      |Emitted when batch processing begins.
    }
  }
  event ProcessingResultRecorded is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    processingRecord: ProcessingRecord with {
      briefly "Record"
      described as {
        |Processing record.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Processing result recorded"
    described as {
      |Emitted when processing result is recorded.
    }
  }
  event GradeReconciled is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    reconciliation: GradeReconciliation with {
      briefly "Reconciliation"
      described as {
        |Grade reconciliation.
      }
    }
    reconciledAt: TimeStamp with {
      briefly "Reconciled"
      described as {
        |Reconciliation time.
      }
    }
  } with {
    briefly "Grade reconciled"
    described as {
      |Emitted when grade reconciliation is completed.
    }
  }
  event ShippedToSmelter is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    shipmentInfo: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Shipment details.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Shipment time.
      }
    }
  } with {
    briefly "Shipped to smelter"
    described as {
      |Emitted when concentrate is shipped to smelter.
    }
  }
  event DeliveryConfirmed is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Delivery confirmed"
    described as {
      |Emitted when smelter delivery is confirmed.
    }
  }
  event BatchRejected is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Batch rejected"
    described as {
      |Emitted when batch is rejected.
    }
  }
  // States
  record ActiveBatchData is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    extractionInfo: ExtractionInfo with {
      briefly "Extraction"
      described as {
        |Extraction details.
      }
    }
    status: BatchStatus with {
      briefly "Status"
      described as {
        |Batch status.
      }
    }
    assayResults: AssayResult* with {
      briefly "Assays"
      described as {
        |Assay results.
      }
    }
    updatedStockpileInfo: StockpileInfo? with {
      briefly "Stockpile"
      described as {
        |Stockpile info.
      }
    }
    processingRecords: ProcessingRecord* with {
      briefly "Processing"
      described as {
        |Processing records.
      }
    }
    reconciliations: GradeReconciliation* with {
      briefly "Reconciliations"
      described as {
        |Grade reconciliations.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active batch state"
    described as {
      |State for a mineral batch being tracked.
    }
  }
  record DeliveredBatchData is  {
    batchId: MineralBatchId with {
      briefly "Batch"
      described as {
        |Batch ID.
      }
    }
    shipmentInfo: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Shipment details.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    receivedTonnage: Decimal(12,2) with {
      briefly "Received"
      described as {
        |Tonnage received.
      }
    }
  } with {
    briefly "Delivered batch state"
    described as {
      |State for a batch delivered to smelter.
    }
  }
  state ActiveBatchState of type MineralBatch.ActiveBatchData
  state DeliveredBatchState of type MineralBatch.DeliveredBatchData
  handler MineralBatchHandler is {
    on command RecordExtraction is {
      morph entity MineralTrackingContext.MineralBatch to state MineralTrackingContext.MineralBatch.ActiveBatchState with command RecordExtraction
      tell event ExtractionRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command RecordAssayResult is {
      tell event AssayResultRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command MoveToStockpile is {
      tell event MovedToStockpile to entity MineralTrackingContext.MineralBatch
    }
    on command StartProcessing is {
      tell event ProcessingStarted to entity MineralTrackingContext.MineralBatch
    }
    on command RecordProcessingResult is {
      tell event ProcessingResultRecorded to entity MineralTrackingContext.MineralBatch
    }
    on command ReconcileGrade is {
      tell event GradeReconciled to entity MineralTrackingContext.MineralBatch
    }
    on command ShipToSmelter is {
      tell event ShippedToSmelter to entity MineralTrackingContext.MineralBatch
    }
    on command ConfirmDelivery is {
      morph entity MineralTrackingContext.MineralBatch to state MineralTrackingContext.MineralBatch.DeliveredBatchState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity MineralTrackingContext.MineralBatch
    }
    on command RejectBatch is {
      tell event BatchRejected to entity MineralTrackingContext.MineralBatch
    }
  } with {
    briefly "Processes mineral batch commands"
    described as {
      |Handles mineral batch lifecycle.
    }
  }
} with {
  briefly "MineralBatch aggregate"
  described as {
    |Manages mineral batches from extraction through smelter delivery.
  }
}
