// Mineral Tracking - MineralTracking Context

context MineralTrackingContext is {

  include "types.riddl"
  include "MineralBatch.riddl"

  repository MineralTrackingRepository is {
    schema MineralTrackingData is relational
      of mineralBatches as MineralBatch
      index on field MineralBatch.batchId
      index on field MineralBatch.extractionInfo.mineId
      index on field MineralBatch.status

    handler MineralTrackingPersistence is {
      on command MineralBatch.RecordExtraction {
        prompt "Store new mineral batch extraction"
      }
      on command MineralBatch.RecordAssayResult {
        prompt "Update batch with assay result"
      }
      on command MineralBatch.MoveToStockpile {
        prompt "Update batch stockpile location"
      }
      on command MineralBatch.RecordProcessingResult {
        prompt "Store processing result"
      }
      on command MineralBatch.ReconcileGrade {
        prompt "Store grade reconciliation"
      }
      on command MineralBatch.ShipToSmelter {
        prompt "Update batch with shipment info"
      }
      on command MineralBatch.ConfirmDelivery {
        prompt "Update batch to delivered"
      }
    } with {
      briefly "Persists mineral tracking events"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Mineral tracking data persistence"
    described by "Persistent storage for mineral tracking."
  }

  projector MineralTrackingMetrics is {
    updates repository MineralTrackingRepository

    record BatchMetrics is {
      batchesExtracted is Natural with { briefly "Extracted" described by "Batches extracted." }
      batchesProcessed is Natural with { briefly "Processed" described by "Batches processed." }
      batchesShipped is Natural with { briefly "Shipped" described by "Batches shipped." }
      batchesRejected is Natural with { briefly "Rejected" described by "Batches rejected." }
      totalTonnageExtracted is Decimal(14, 2) with { briefly "Total tonnage" described by "Total tonnage extracted." }
      averageRecoveryRate is Decimal(5, 2) with { briefly "Avg recovery" described by "Average recovery rate." }
    } with {
      briefly "Batch metrics"
      described by "Mineral batch processing metrics."
    }

    handler MetricsHandler is {
      on event MineralBatch.ExtractionRecorded {
        prompt "Increment batches extracted and total tonnage"
      }
      on event MineralBatch.ProcessingResultRecorded {
        prompt "Increment batches processed and update recovery rate"
      }
      on event MineralBatch.ShippedToSmelter {
        prompt "Increment batches shipped"
      }
      on event MineralBatch.BatchRejected {
        prompt "Increment batches rejected"
      }
    } with {
      briefly "Maintains mineral tracking metrics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Mineral tracking metrics"
    described by "Mineral tracking analytics and KPIs."
  }

} with {
  briefly "Bounded context for mineral tracking"
  described by "Mineral tracking from extraction through smelter delivery."
}
