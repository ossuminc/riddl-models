// Mine Operations - Mine Context

context MineContext is {

  include "types.riddl"
  include "ExtractionZone.riddl"

  repository MineRepository is {
    schema MineData is relational
      of extractionZones as ExtractionZone
      index on field ExtractionZone.zoneId
      index on field ExtractionZone.zone.mineId
      index on field ExtractionZone.status

    handler MinePersistence is {
      on command ExtractionZone.CreateZone {
        prompt "Store new extraction zone"
      }
      on command ExtractionZone.SurveyZone {
        prompt "Store survey data"
      }
      on command ExtractionZone.RecordProduction {
        prompt "Store production record"
      }
      on command ExtractionZone.RecordSafetyIncident {
        prompt "Store safety incident"
      }
      on command ExtractionZone.RecordEnvironmental {
        prompt "Store environmental reading"
      }
      on command ExtractionZone.ExhaustZone {
        prompt "Update zone to exhausted"
      }
    } with {
      briefly "Persists mine commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Mine data persistence"
    described by "Persistent storage for mine operations."
  }

  projector ProductionAnalytics is {
    updates repository MineRepository

    record DailyProduction is {
      productionDate is Date with { briefly "Date" described by "Production date." }
      totalExtracted is Decimal(15, 2) with { briefly "Extracted" described by "Total extracted." }
      totalProcessed is Decimal(15, 2) with { briefly "Processed" described by "Total processed." }
      averageRecovery is Decimal(5, 2) with { briefly "Recovery" described by "Average recovery rate." }
    } with {
      briefly "Daily production"
      described by "Daily production summary."
    }

    record SafetyMetrics is {
      lostTimeIncidents is Natural with { briefly "LTI" described by "Lost time incidents." }
      nearMisses is Natural with { briefly "Near misses" described by "Near miss incidents." }
      daysWithoutIncident is Natural with { briefly "Safe days" described by "Days without incident." }
    } with {
      briefly "Safety metrics"
      described by "Safety performance metrics."
    }

    handler AnalyticsHandler is {
      on event ExtractionZone.ProductionRecorded {
        prompt "Update production analytics"
      }
      on event ExtractionZone.SafetyIncidentRecorded {
        prompt "Update safety metrics"
      }
    } with {
      briefly "Maintains production analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Production analytics"
    described by "Mining production analytics."
  }

} with {
  briefly "Bounded context for mine operations"
  described by "Mine extraction and processing context."
}
