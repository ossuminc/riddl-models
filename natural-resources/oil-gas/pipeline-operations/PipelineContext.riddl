// Pipeline Operations - Pipeline Context

context PipelineContext is {

  include "types.riddl"
  include "PipelineSegment.riddl"

  repository PipelineRepository is {
    schema PipelineData is relational
      of pipelineSegments as PipelineSegment
      index on field PipelineSegment.segmentId
      index on field PipelineSegment.segmentInfo.pipelineId
      index on field PipelineSegment.status

    handler PipelinePersistence is {
      on command PipelineSegment.CommissionSegment {
        prompt "Store new pipeline segment"
      }
      on command PipelineSegment.RecordFlowReading {
        prompt "Update latest flow reading"
      }
      on command PipelineSegment.ReportLeakIndicator {
        prompt "Store leak indicator"
      }
      on command PipelineSegment.CompleteMaintenance {
        prompt "Update maintenance record"
      }
      on command PipelineSegment.RecordInspection {
        prompt "Store inspection report"
      }
      on command PipelineSegment.ShutDownSegment {
        prompt "Update segment to shut down"
      }
    } with {
      briefly "Persists pipeline commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Pipeline data persistence"
    described by "Persistent storage for pipeline operations."
  }

  projector PipelineMetrics is {
    updates repository PipelineRepository

    record OperationsMetrics is {
      segmentsOperational is Natural with { briefly "Operational" described by "Operational segments." }
      segmentsUnderMaintenance is Natural with { briefly "Maintenance" described by "Segments under maintenance." }
      leakAlertsActive is Natural with { briefly "Leak alerts" described by "Active leak alerts." }
      inspectionsCompleted is Natural with { briefly "Inspections" described by "Inspections completed." }
      averageFlowRate is Decimal(12, 3) with { briefly "Avg flow" described by "Average flow rate." }
    } with {
      briefly "Operations metrics"
      described by "Pipeline operations metrics."
    }

    handler MetricsHandler is {
      on event PipelineSegment.SegmentCommissioned {
        prompt "Increment operational segments"
      }
      on event PipelineSegment.LeakIndicatorReported {
        prompt "Increment active leak alerts"
      }
      on event PipelineSegment.InspectionRecorded {
        prompt "Increment inspections completed"
      }
      on event PipelineSegment.SegmentShutDown {
        prompt "Decrement operational segments"
      }
    } with {
      briefly "Maintains pipeline metrics"
      described by "Projects events into operations metrics."
    }
  } with {
    briefly "Pipeline metrics"
    described by "Pipeline operations analytics."
  }

} with {
  briefly "Bounded context for pipeline operations"
  described by "Oil and gas pipeline operations context."
}
