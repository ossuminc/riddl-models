// Pipeline Operations - Pipeline Context
context PipelineContext is {
  include "types.riddl"
  include "PipelineSegment.riddl"
  repository PipelineRepository is {
    schema PipelineData is relational
      of pipelineSegments as type PipelineSegment
        index on field PipelineSegment.segmentId
        index on field PipelineSegment.segmentInfo.pipelineId
        index on field PipelineSegment.status

    handler PipelinePersistence is {
      on command PipelineSegment.CommissionSegment is {
        prompt "Store new pipeline segment"
      }
      on command PipelineSegment.RecordFlowReading is {
        prompt "Update latest flow reading"
      }
      on command PipelineSegment.ReportLeakIndicator is {
        prompt "Store leak indicator"
      }
      on command PipelineSegment.CompleteMaintenance is {
        prompt "Update maintenance record"
      }
      on command PipelineSegment.RecordInspection is {
        prompt "Store inspection report"
      }
      on command PipelineSegment.ShutDownSegment is {
        prompt "Update segment to shut down"
      }
    } with {
      briefly "Persists pipeline commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Pipeline data persistence"
    described as {
      |Persistent storage for pipeline operations.
    }
  }
  projector PipelineMetrics is {
    record OperationsMetrics is  {
      segmentsOperational: Natural with {
        briefly "Operational"
        described as {
          |Operational segments.
        }
      }
      segmentsUnderMaintenance: Natural with {
        briefly "Maintenance"
        described as {
          |Segments under maintenance.
        }
      }
      leakAlertsActive: Natural with {
        briefly "Leak alerts"
        described as {
          |Active leak alerts.
        }
      }
      inspectionsCompleted: Natural with {
        briefly "Inspections"
        described as {
          |Inspections completed.
        }
      }
      averageFlowRate: Decimal(12,3) with {
        briefly "Avg flow"
        described as {
          |Average flow rate.
        }
      }
    } with {
      briefly "Operations metrics"
      described as {
        |Pipeline operations metrics.
      }
    }
    handler MetricsHandler is {
      on event PipelineSegment.SegmentCommissioned is {
        prompt "Increment operational segments"
      }
      on event PipelineSegment.LeakIndicatorReported is {
        prompt "Increment active leak alerts"
      }
      on event PipelineSegment.InspectionRecorded is {
        prompt "Increment inspections completed"
      }
      on event PipelineSegment.SegmentShutDown is {
        prompt "Decrement operational segments"
      }
    } with {
      briefly "Maintains pipeline metrics"
      described as {
        |Projects events into operations metrics.
      }
    }
  } with {
    briefly "Pipeline metrics"
    described as {
      |Pipeline operations analytics.
    }
  }
} with {
  briefly "Bounded context for pipeline operations"
  described as {
    |Oil and gas pipeline operations context.
  }
}
