// Pipeline Operations - PipelineSegment Entity
entity PipelineSegment is {
  command CommissionSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |New segment identifier.
      }
    }
    segmentInfo: SegmentInfo with {
      briefly "Segment info"
      described as {
        |Pipeline segment details.
      }
    }
  } with {
    briefly "Commission segment"
    described as {
      |Commissions a new pipeline segment.
    }
  }
  command RecordFlowReading is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reading: FlowReading with {
      briefly "Reading"
      described as {
        |Flow telemetry reading.
      }
    }
  } with {
    briefly "Record flow reading"
    described as {
      |Records a flow and pressure reading.
    }
  }
  command ReportLeakIndicator is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    indicator: LeakIndicator with {
      briefly "Indicator"
      described as {
        |Leak indicator data.
      }
    }
  } with {
    briefly "Report leak indicator"
    described as {
      |Reports a suspected leak indicator.
    }
  }
  command ScheduleMaintenance is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    maintenance: MaintenanceRecord with {
      briefly "Maintenance"
      described as {
        |Maintenance activity details.
      }
    }
  } with {
    briefly "Schedule maintenance"
    described as {
      |Schedules maintenance for the segment.
    }
  }
  command CompleteMaintenance is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work order"
      described as {
        |Work order identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion timestamp.
      }
    }
    findings: String(3,2000)? with {
      briefly "Findings"
      described as {
        |Maintenance findings.
      }
    }
  } with {
    briefly "Complete maintenance"
    described as {
      |Records completion of maintenance.
    }
  }
  command RecordInspection is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    report: InspectionReport with {
      briefly "Report"
      described as {
        |Inspection report.
      }
    }
  } with {
    briefly "Record inspection"
    described as {
      |Records a pipeline inspection.
    }
  }
  command FileComplianceReport is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    filing: ComplianceFiling with {
      briefly "Filing"
      described as {
        |Compliance filing details.
      }
    }
  } with {
    briefly "File compliance report"
    described as {
      |Files a regulatory compliance report.
    }
  }
  command ShutDownSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Shutdown reason.
      }
    }
  } with {
    briefly "Shut down segment"
    described as {
      |Shuts down pipeline segment.
    }
  }
  command RestartSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    authorizedBy: String(3,200) with {
      briefly "Authorized by"
      described as {
        |Person authorizing restart.
      }
    }
  } with {
    briefly "Restart segment"
    described as {
      |Restarts a shut down pipeline segment.
    }
  }
  command DecommissionSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Decommission reason.
      }
    }
  } with {
    briefly "Decommission segment"
    described as {
      |Decommissions a pipeline segment.
    }
  }
  // Events
  event SegmentCommissioned is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentInfo: SegmentInfo with {
      briefly "Info"
      described as {
        |Segment info.
      }
    }
    commissionedAt: TimeStamp with {
      briefly "Commissioned"
      described as {
        |Commission time.
      }
    }
  } with {
    briefly "Segment commissioned"
    described as {
      |Emitted when segment is commissioned.
    }
  }
  event FlowReadingRecorded is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reading: FlowReading with {
      briefly "Reading"
      described as {
        |Flow reading.
      }
    }
  } with {
    briefly "Flow reading recorded"
    described as {
      |Emitted when flow reading is recorded.
    }
  }
  event LeakIndicatorReported is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    indicator: LeakIndicator with {
      briefly "Indicator"
      described as {
        |Leak indicator.
      }
    }
  } with {
    briefly "Leak indicator reported"
    described as {
      |Emitted when leak indicator is reported.
    }
  }
  event MaintenanceScheduled is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    maintenance: MaintenanceRecord with {
      briefly "Maintenance"
      described as {
        |Maintenance record.
      }
    }
  } with {
    briefly "Maintenance scheduled"
    described as {
      |Emitted when maintenance is scheduled.
    }
  }
  event MaintenanceCompleted is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work order"
      described as {
        |Work order ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Maintenance completed"
    described as {
      |Emitted when maintenance is completed.
    }
  }
  event InspectionRecorded is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    report: InspectionReport with {
      briefly "Report"
      described as {
        |Inspection report.
      }
    }
  } with {
    briefly "Inspection recorded"
    described as {
      |Emitted when inspection is recorded.
    }
  }
  event ComplianceReportFiled is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    filing: ComplianceFiling with {
      briefly "Filing"
      described as {
        |Compliance filing.
      }
    }
  } with {
    briefly "Compliance report filed"
    described as {
      |Emitted when compliance report is filed.
    }
  }
  event SegmentShutDown is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Shutdown reason.
      }
    }
    shutDownAt: TimeStamp with {
      briefly "Shut down"
      described as {
        |Shutdown time.
      }
    }
  } with {
    briefly "Segment shut down"
    described as {
      |Emitted when segment is shut down.
    }
  }
  event SegmentRestarted is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    authorizedBy: String(3,200) with {
      briefly "Authorized by"
      described as {
        |Authorizer.
      }
    }
    restartedAt: TimeStamp with {
      briefly "Restarted"
      described as {
        |Restart time.
      }
    }
  } with {
    briefly "Segment restarted"
    described as {
      |Emitted when segment is restarted.
    }
  }
  event SegmentDecommissioned is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Decommission reason.
      }
    }
    decommissionedAt: TimeStamp with {
      briefly "Decommissioned"
      described as {
        |Decommission time.
      }
    }
  } with {
    briefly "Segment decommissioned"
    described as {
      |Emitted when segment is decommissioned.
    }
  }
  // States
  record OperationalStateData is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentInfo: SegmentInfo with {
      briefly "Info"
      described as {
        |Segment info.
      }
    }
    status: SegmentStatus with {
      briefly "Status"
      described as {
        |Segment status.
      }
    }
    latestReading: FlowReading? with {
      briefly "Latest reading"
      described as {
        |Most recent flow reading.
      }
    }
    leakIndicators: LeakIndicator* with {
      briefly "Leak indicators"
      described as {
        |Active leak indicators.
      }
    }
    maintenanceHistory: MaintenanceRecord* with {
      briefly "Maintenance"
      described as {
        |Maintenance history.
      }
    }
    inspections: InspectionReport* with {
      briefly "Inspections"
      described as {
        |Inspection reports.
      }
    }
    complianceFilings: ComplianceFiling* with {
      briefly "Filings"
      described as {
        |Compliance filings.
      }
    }
    commissionedAt: TimeStamp with {
      briefly "Commissioned"
      described as {
        |Commission time.
      }
    }
  } with {
    briefly "Operational segment state"
    described as {
      |State for an operational pipeline segment.
    }
  }
  record DecommissionedStateData is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentInfo: SegmentInfo with {
      briefly "Info"
      described as {
        |Segment info.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Decommission reason.
      }
    }
    decommissionedAt: TimeStamp with {
      briefly "Decommissioned"
      described as {
        |Decommission time.
      }
    }
  } with {
    briefly "Decommissioned segment state"
    described as {
      |State for a decommissioned pipeline segment.
    }
  }
  state OperationalState of type PipelineSegment.OperationalStateData
  state DecommissionedState of type PipelineSegment.DecommissionedStateData
  handler PipelineSegmentHandler is {
    on command CommissionSegment is {
      morph entity PipelineContext.PipelineSegment to state PipelineContext.PipelineSegment.OperationalState with command CommissionSegment
      tell event SegmentCommissioned to entity PipelineContext.PipelineSegment
    }
    on command RecordFlowReading is {
      tell event FlowReadingRecorded to entity PipelineContext.PipelineSegment
    }
    on command ReportLeakIndicator is {
      tell event LeakIndicatorReported to entity PipelineContext.PipelineSegment
    }
    on command ScheduleMaintenance is {
      tell event MaintenanceScheduled to entity PipelineContext.PipelineSegment
    }
    on command CompleteMaintenance is {
      tell event MaintenanceCompleted to entity PipelineContext.PipelineSegment
    }
    on command RecordInspection is {
      tell event InspectionRecorded to entity PipelineContext.PipelineSegment
    }
    on command FileComplianceReport is {
      tell event ComplianceReportFiled to entity PipelineContext.PipelineSegment
    }
    on command ShutDownSegment is {
      tell event SegmentShutDown to entity PipelineContext.PipelineSegment
    }
    on command RestartSegment is {
      tell event SegmentRestarted to entity PipelineContext.PipelineSegment
    }
    on command DecommissionSegment is {
      morph entity PipelineContext.PipelineSegment to state PipelineContext.PipelineSegment.DecommissionedState with command DecommissionSegment
      tell event SegmentDecommissioned to entity PipelineContext.PipelineSegment
    }
  } with {
    briefly "Processes pipeline segment commands"
    described as {
      |Handles pipeline segment lifecycle.
    }
  }
} with {
  briefly "PipelineSegment aggregate"
  described as {
    |Manages pipeline segment monitoring and maintenance.
  }
}
