// Pipeline Operations - PipelineSegment Entity

entity PipelineSegment is {

  command CommissionSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "New segment identifier."
    }
    segmentInfo is SegmentInfo with {
      briefly "Segment info"
      described by "Pipeline segment details."
    }
  } with {
    briefly "Commission segment"
    described by "Commissions a new pipeline segment."
  }

  command RecordFlowReading is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reading is FlowReading with {
      briefly "Reading"
      described by "Flow telemetry reading."
    }
  } with {
    briefly "Record flow reading"
    described by "Records a flow and pressure reading."
  }

  command ReportLeakIndicator is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    indicator is LeakIndicator with {
      briefly "Indicator"
      described by "Leak indicator data."
    }
  } with {
    briefly "Report leak indicator"
    described by "Reports a suspected leak indicator."
  }

  command ScheduleMaintenance is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    maintenance is MaintenanceRecord with {
      briefly "Maintenance"
      described by "Maintenance activity details."
    }
  } with {
    briefly "Schedule maintenance"
    described by "Schedules maintenance for the segment."
  }

  command CompleteMaintenance is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    workOrderId is WorkOrderId with {
      briefly "Work order"
      described by "Work order identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion timestamp."
    }
    findings is optional String(3, 2000) with {
      briefly "Findings"
      described by "Maintenance findings."
    }
  } with {
    briefly "Complete maintenance"
    described by "Records completion of maintenance."
  }

  command RecordInspection is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    report is InspectionReport with {
      briefly "Report"
      described by "Inspection report."
    }
  } with {
    briefly "Record inspection"
    described by "Records a pipeline inspection."
  }

  command FileComplianceReport is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    filing is ComplianceFiling with {
      briefly "Filing"
      described by "Compliance filing details."
    }
  } with {
    briefly "File compliance report"
    described by "Files a regulatory compliance report."
  }

  command ShutDownSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Shutdown reason."
    }
  } with {
    briefly "Shut down segment"
    described by "Shuts down pipeline segment."
  }

  command RestartSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    authorizedBy is String(3, 200) with {
      briefly "Authorized by"
      described by "Person authorizing restart."
    }
  } with {
    briefly "Restart segment"
    described by "Restarts a shut down pipeline segment."
  }

  command DecommissionSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Decommission reason."
    }
  } with {
    briefly "Decommission segment"
    described by "Decommissions a pipeline segment."
  }

  // Events
  event SegmentCommissioned is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentInfo is SegmentInfo with { briefly "Info" described by "Segment info." }
    commissionedAt is TimeStamp with { briefly "Commissioned" described by "Commission time." }
  } with {
    briefly "Segment commissioned"
    described by "Emitted when segment is commissioned."
  }

  event FlowReadingRecorded is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reading is FlowReading with { briefly "Reading" described by "Flow reading." }
  } with {
    briefly "Flow reading recorded"
    described by "Emitted when flow reading is recorded."
  }

  event LeakIndicatorReported is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    indicator is LeakIndicator with { briefly "Indicator" described by "Leak indicator." }
  } with {
    briefly "Leak indicator reported"
    described by "Emitted when leak indicator is reported."
  }

  event MaintenanceScheduled is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    maintenance is MaintenanceRecord with { briefly "Maintenance" described by "Maintenance record." }
  } with {
    briefly "Maintenance scheduled"
    described by "Emitted when maintenance is scheduled."
  }

  event MaintenanceCompleted is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    workOrderId is WorkOrderId with { briefly "Work order" described by "Work order ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Maintenance completed"
    described by "Emitted when maintenance is completed."
  }

  event InspectionRecorded is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    report is InspectionReport with { briefly "Report" described by "Inspection report." }
  } with {
    briefly "Inspection recorded"
    described by "Emitted when inspection is recorded."
  }

  event ComplianceReportFiled is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    filing is ComplianceFiling with { briefly "Filing" described by "Compliance filing." }
  } with {
    briefly "Compliance report filed"
    described by "Emitted when compliance report is filed."
  }

  event SegmentShutDown is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Shutdown reason." }
    shutDownAt is TimeStamp with { briefly "Shut down" described by "Shutdown time." }
  } with {
    briefly "Segment shut down"
    described by "Emitted when segment is shut down."
  }

  event SegmentRestarted is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    authorizedBy is String(3, 200) with { briefly "Authorized by" described by "Authorizer." }
    restartedAt is TimeStamp with { briefly "Restarted" described by "Restart time." }
  } with {
    briefly "Segment restarted"
    described by "Emitted when segment is restarted."
  }

  event SegmentDecommissioned is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Decommission reason." }
    decommissionedAt is TimeStamp with { briefly "Decommissioned" described by "Decommission time." }
  } with {
    briefly "Segment decommissioned"
    described by "Emitted when segment is decommissioned."
  }

  // States
  record OperationalStateData is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentInfo is SegmentInfo with { briefly "Info" described by "Segment info." }
    status is SegmentStatus with { briefly "Status" described by "Segment status." }
    latestReading is optional FlowReading with { briefly "Latest reading" described by "Most recent flow reading." }
    leakIndicators is many optional LeakIndicator with { briefly "Leak indicators" described by "Active leak indicators." }
    maintenanceHistory is many optional MaintenanceRecord with { briefly "Maintenance" described by "Maintenance history." }
    inspections is many optional InspectionReport with { briefly "Inspections" described by "Inspection reports." }
    complianceFilings is many optional ComplianceFiling with { briefly "Filings" described by "Compliance filings." }
    commissionedAt is TimeStamp with { briefly "Commissioned" described by "Commission time." }
  } with {
    briefly "Operational segment state"
    described by "State for an operational pipeline segment."
  }

  record DecommissionedStateData is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentInfo is SegmentInfo with { briefly "Info" described by "Segment info." }
    reason is String(3, 500) with { briefly "Reason" described by "Decommission reason." }
    decommissionedAt is TimeStamp with { briefly "Decommissioned" described by "Decommission time." }
  } with {
    briefly "Decommissioned segment state"
    described by "State for a decommissioned pipeline segment."
  }

  state OperationalState of PipelineSegment.OperationalStateData with {
    briefly "Segment operational"
    described by "Pipeline segment is operational or under maintenance."
  }

  state DecommissionedState of PipelineSegment.DecommissionedStateData with {
    briefly "Segment decommissioned"
    described by "Pipeline segment has been decommissioned."
  }

  handler PipelineSegmentHandler is {
    on command CommissionSegment {
      morph entity PipelineContext.PipelineSegment to state PipelineContext.PipelineSegment.OperationalState with command CommissionSegment
      tell event SegmentCommissioned to entity PipelineContext.PipelineSegment
    }
    on command RecordFlowReading {
      tell event FlowReadingRecorded to entity PipelineContext.PipelineSegment
    }
    on command ReportLeakIndicator {
      tell event LeakIndicatorReported to entity PipelineContext.PipelineSegment
    }
    on command ScheduleMaintenance {
      tell event MaintenanceScheduled to entity PipelineContext.PipelineSegment
    }
    on command CompleteMaintenance {
      tell event MaintenanceCompleted to entity PipelineContext.PipelineSegment
    }
    on command RecordInspection {
      tell event InspectionRecorded to entity PipelineContext.PipelineSegment
    }
    on command FileComplianceReport {
      tell event ComplianceReportFiled to entity PipelineContext.PipelineSegment
    }
    on command ShutDownSegment {
      tell event SegmentShutDown to entity PipelineContext.PipelineSegment
    }
    on command RestartSegment {
      tell event SegmentRestarted to entity PipelineContext.PipelineSegment
    }
    on command DecommissionSegment {
      morph entity PipelineContext.PipelineSegment to state PipelineContext.PipelineSegment.DecommissionedState with command DecommissionSegment
      tell event SegmentDecommissioned to entity PipelineContext.PipelineSegment
    }
  } with {
    briefly "Processes pipeline segment commands"
    described by "Handles pipeline segment lifecycle."
  }

} with {
  briefly "PipelineSegment aggregate"
  described by "Manages pipeline segment monitoring and maintenance."
}
