// Timber Management - Stand Entity
entity Stand is {
  command RegisterStand is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |New stand identifier.
      }
    }
    standInfo: StandInfo with {
      briefly "Info"
      described as {
        |Stand information.
      }
    }
  } with {
    briefly "Register stand"
    described as {
      |Registers a new timber stand.
    }
  }
  command RecordCruise is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    cruiseData: CruiseData with {
      briefly "Cruise"
      described as {
        |Cruise data.
      }
    }
  } with {
    briefly "Record cruise"
    described as {
      |Records timber cruise results.
    }
  }
  command PlanHarvest is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    harvestMethod: HarvestMethod with {
      briefly "Method"
      described as {
        |Harvest method.
      }
    }
    plannedStartDate: Date with {
      briefly "Start"
      described as {
        |Planned start date.
      }
    }
  } with {
    briefly "Plan harvest"
    described as {
      |Plans harvest operation.
    }
  }
  command RecordTimberSale is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    saleInfo: TimberSaleInfo with {
      briefly "Sale"
      described as {
        |Timber sale details.
      }
    }
  } with {
    briefly "Record timber sale"
    described as {
      |Records timber sale.
    }
  }
  command BeginHarvest is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Harvest start date.
      }
    }
    contractor: String(1,200) with {
      briefly "Contractor"
      described as {
        |Logging contractor.
      }
    }
  } with {
    briefly "Begin harvest"
    described as {
      |Starts harvest operations.
    }
  }
  command RecordLoad is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    load: HarvestLoad with {
      briefly "Load"
      described as {
        |Harvest load data.
      }
    }
  } with {
    briefly "Record load"
    described as {
      |Records harvested load.
    }
  }
  command CompleteHarvest is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    completionDate: Date with {
      briefly "Completion"
      described as {
        |Harvest completion date.
      }
    }
    totalVolume: Decimal(12,2) with {
      briefly "Volume"
      described as {
        |Total harvested volume MBF.
      }
    }
  } with {
    briefly "Complete harvest"
    described as {
      |Completes harvest operation.
    }
  }
  command PlanRegeneration is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    plan: RegenerationPlan with {
      briefly "Plan"
      described as {
        |Regeneration plan.
      }
    }
  } with {
    briefly "Plan regeneration"
    described as {
      |Plans stand regeneration.
    }
  }
  command RecordPlanting is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    plantingDate: Date with {
      briefly "Date"
      described as {
        |Planting date.
      }
    }
    treesPlanted: Natural with {
      briefly "Trees"
      described as {
        |Trees planted.
      }
    }
    acres: Decimal(8,2) with {
      briefly "Acres"
      described as {
        |Acres planted.
      }
    }
  } with {
    briefly "Record planting"
    described as {
      |Records regeneration planting.
    }
  }
  command UpdateGrowth is  {
    standId: StandId with {
      briefly "Stand ID"
      described as {
        |Stand identifier.
      }
    }
    newAge: Natural with {
      briefly "Age"
      described as {
        |Updated age.
      }
    }
    survivalRate: Decimal(5,2) with {
      briefly "Survival"
      described as {
        |Survival rate percent.
      }
    }
  } with {
    briefly "Update growth"
    described as {
      |Updates stand growth status.
    }
  }
  // Events
  event StandRegistered is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    standInfo: StandInfo with {
      briefly "Info"
      described as {
        |Stand info.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Stand registered"
    described as {
      |Emitted when stand is registered.
    }
  }
  event CruiseRecorded is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    cruiseData: CruiseData with {
      briefly "Cruise"
      described as {
        |Cruise data.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Cruise recorded"
    described as {
      |Emitted when cruise is recorded.
    }
  }
  event HarvestPlanned is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    harvestMethod: HarvestMethod with {
      briefly "Method"
      described as {
        |Method.
      }
    }
    plannedStartDate: Date with {
      briefly "Start"
      described as {
        |Planned start.
      }
    }
  } with {
    briefly "Harvest planned"
    described as {
      |Emitted when harvest is planned.
    }
  }
  event TimberSaleRecorded is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    saleInfo: TimberSaleInfo with {
      briefly "Sale"
      described as {
        |Sale info.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Timber sale recorded"
    described as {
      |Emitted when sale is recorded.
    }
  }
  event HarvestStarted is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Start date.
      }
    }
    contractor: String(1,200) with {
      briefly "Contractor"
      described as {
        |Contractor.
      }
    }
  } with {
    briefly "Harvest started"
    described as {
      |Emitted when harvest begins.
    }
  }
  event LoadRecorded is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    load: HarvestLoad with {
      briefly "Load"
      described as {
        |Load data.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Load recorded"
    described as {
      |Emitted when load is recorded.
    }
  }
  event HarvestCompleted is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    totalVolume: Decimal(12,2) with {
      briefly "Volume"
      described as {
        |Total volume.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Harvest completed"
    described as {
      |Emitted when harvest completes.
    }
  }
  event RegenerationPlanned is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    plan: RegenerationPlan with {
      briefly "Plan"
      described as {
        |Regen plan.
      }
    }
    plannedAt: TimeStamp with {
      briefly "Planned"
      described as {
        |Planning time.
      }
    }
  } with {
    briefly "Regeneration planned"
    described as {
      |Emitted when regen is planned.
    }
  }
  event PlantingRecorded is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    treesPlanted: Natural with {
      briefly "Trees"
      described as {
        |Trees planted.
      }
    }
    acres: Decimal(8,2) with {
      briefly "Acres"
      described as {
        |Acres.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Planting recorded"
    described as {
      |Emitted when planting is recorded.
    }
  }
  event GrowthUpdated is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    newAge: Natural with {
      briefly "Age"
      described as {
        |New age.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Growth updated"
    described as {
      |Emitted when growth is updated.
    }
  }
  // States
  record ActiveStateData is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    standInfo: StandInfo with {
      briefly "Info"
      described as {
        |Stand info.
      }
    }
    status: StandStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    latestCruise: CruiseData? with {
      briefly "Cruise"
      described as {
        |Latest cruise.
      }
    }
    currentSale: TimberSaleInfo? with {
      briefly "Sale"
      described as {
        |Current sale.
      }
    }
    loads: HarvestLoad* with {
      briefly "Loads"
      described as {
        |Harvest loads.
      }
    }
    updatedRegenerationPlan: RegenerationPlan? with {
      briefly "Regen"
      described as {
        |Regen plan.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Active stand state"
    described as {
      |State for active stand.
    }
  }
  record RegeneratingStateData is  {
    standId: StandId with {
      briefly "Stand"
      described as {
        |Stand ID.
      }
    }
    regenerationPlan: RegenerationPlan with {
      briefly "Plan"
      described as {
        |Regen plan.
      }
    }
    treesPlanted: Natural with {
      briefly "Trees"
      described as {
        |Trees planted.
      }
    }
    plantingDate: Date with {
      briefly "Planted"
      described as {
        |Planting date.
      }
    }
  } with {
    briefly "Regenerating stand state"
    described as {
      |State for regenerating stand.
    }
  }
  state ActiveState of type Stand.ActiveStateData
  state RegeneratingState of type Stand.RegeneratingStateData
  handler StandHandler is {
    on command RegisterStand is {
      morph entity TimberContext.Stand to state TimberContext.Stand.ActiveState with command RegisterStand
      tell event StandRegistered to entity TimberContext.Stand
    }
    on command RecordCruise is {
      tell event CruiseRecorded to entity TimberContext.Stand
    }
    on command PlanHarvest is {
      tell event HarvestPlanned to entity TimberContext.Stand
    }
    on command RecordTimberSale is {
      tell event TimberSaleRecorded to entity TimberContext.Stand
    }
    on command BeginHarvest is {
      tell event HarvestStarted to entity TimberContext.Stand
    }
    on command RecordLoad is {
      tell event LoadRecorded to entity TimberContext.Stand
    }
    on command CompleteHarvest is {
      tell event HarvestCompleted to entity TimberContext.Stand
    }
    on command PlanRegeneration is {
      tell event RegenerationPlanned to entity TimberContext.Stand
    }
    on command RecordPlanting is {
      morph entity TimberContext.Stand to state TimberContext.Stand.RegeneratingState with command RecordPlanting
      tell event PlantingRecorded to entity TimberContext.Stand
    }
    on command UpdateGrowth is {
      tell event GrowthUpdated to entity TimberContext.Stand
    }
  } with {
    briefly "Processes stand commands"
    described as {
      |Handles stand lifecycle.
    }
  }
} with {
  briefly "Stand aggregate"
  described as {
    |Manages timber stands.
  }
}
