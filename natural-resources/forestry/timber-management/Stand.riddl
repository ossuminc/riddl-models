// Timber Management - Stand Entity

entity Stand is {

  command RegisterStand is {
    standId is StandId with {
      briefly "Stand ID"
      described by "New stand identifier."
    }
    standInfo is StandInfo with {
      briefly "Info"
      described by "Stand information."
    }
  } with {
    briefly "Register stand"
    described by "Registers a new timber stand."
  }

  command RecordCruise is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    cruiseData is CruiseData with {
      briefly "Cruise"
      described by "Cruise data."
    }
  } with {
    briefly "Record cruise"
    described by "Records timber cruise results."
  }

  command PlanHarvest is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    harvestMethod is HarvestMethod with {
      briefly "Method"
      described by "Harvest method."
    }
    plannedStartDate is Date with {
      briefly "Start"
      described by "Planned start date."
    }
  } with {
    briefly "Plan harvest"
    described by "Plans harvest operation."
  }

  command RecordTimberSale is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    saleInfo is TimberSaleInfo with {
      briefly "Sale"
      described by "Timber sale details."
    }
  } with {
    briefly "Record timber sale"
    described by "Records timber sale."
  }

  command BeginHarvest is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    startDate is Date with {
      briefly "Start"
      described by "Harvest start date."
    }
    contractor is String(1, 200) with {
      briefly "Contractor"
      described by "Logging contractor."
    }
  } with {
    briefly "Begin harvest"
    described by "Starts harvest operations."
  }

  command RecordLoad is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    load is HarvestLoad with {
      briefly "Load"
      described by "Harvest load data."
    }
  } with {
    briefly "Record load"
    described by "Records harvested load."
  }

  command CompleteHarvest is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    completionDate is Date with {
      briefly "Completion"
      described by "Harvest completion date."
    }
    totalVolume is Decimal(12, 2) with {
      briefly "Volume"
      described by "Total harvested volume MBF."
    }
  } with {
    briefly "Complete harvest"
    described by "Completes harvest operation."
  }

  command PlanRegeneration is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    plan is RegenerationPlan with {
      briefly "Plan"
      described by "Regeneration plan."
    }
  } with {
    briefly "Plan regeneration"
    described by "Plans stand regeneration."
  }

  command RecordPlanting is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    plantingDate is Date with {
      briefly "Date"
      described by "Planting date."
    }
    treesPlanted is Natural with {
      briefly "Trees"
      described by "Trees planted."
    }
    acres is Decimal(8, 2) with {
      briefly "Acres"
      described by "Acres planted."
    }
  } with {
    briefly "Record planting"
    described by "Records regeneration planting."
  }

  command UpdateGrowth is {
    standId is StandId with {
      briefly "Stand ID"
      described by "Stand identifier."
    }
    newAge is Natural with {
      briefly "Age"
      described by "Updated age."
    }
    survivalRate is Decimal(5, 2) with {
      briefly "Survival"
      described by "Survival rate percent."
    }
  } with {
    briefly "Update growth"
    described by "Updates stand growth status."
  }

  // Events
  event StandRegistered is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    standInfo is StandInfo with { briefly "Info" described by "Stand info." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Stand registered"
    described by "Emitted when stand is registered."
  }

  event CruiseRecorded is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    cruiseData is CruiseData with { briefly "Cruise" described by "Cruise data." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Cruise recorded"
    described by "Emitted when cruise is recorded."
  }

  event HarvestPlanned is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    harvestMethod is HarvestMethod with { briefly "Method" described by "Method." }
    plannedStartDate is Date with { briefly "Start" described by "Planned start." }
  } with {
    briefly "Harvest planned"
    described by "Emitted when harvest is planned."
  }

  event TimberSaleRecorded is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    saleInfo is TimberSaleInfo with { briefly "Sale" described by "Sale info." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Timber sale recorded"
    described by "Emitted when sale is recorded."
  }

  event HarvestStarted is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    startDate is Date with { briefly "Start" described by "Start date." }
    contractor is String(1, 200) with { briefly "Contractor" described by "Contractor." }
  } with {
    briefly "Harvest started"
    described by "Emitted when harvest begins."
  }

  event LoadRecorded is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    load is HarvestLoad with { briefly "Load" described by "Load data." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Load recorded"
    described by "Emitted when load is recorded."
  }

  event HarvestCompleted is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    totalVolume is Decimal(12, 2) with { briefly "Volume" described by "Total volume." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Harvest completed"
    described by "Emitted when harvest completes."
  }

  event RegenerationPlanned is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    plan is RegenerationPlan with { briefly "Plan" described by "Regen plan." }
    plannedAt is TimeStamp with { briefly "Planned" described by "Planning time." }
  } with {
    briefly "Regeneration planned"
    described by "Emitted when regen is planned."
  }

  event PlantingRecorded is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    treesPlanted is Natural with { briefly "Trees" described by "Trees planted." }
    acres is Decimal(8, 2) with { briefly "Acres" described by "Acres." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Planting recorded"
    described by "Emitted when planting is recorded."
  }

  event GrowthUpdated is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    newAge is Natural with { briefly "Age" described by "New age." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Growth updated"
    described by "Emitted when growth is updated."
  }

  // States
  record ActiveStateData is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    standInfo is StandInfo with { briefly "Info" described by "Stand info." }
    status is StandStatus with { briefly "Status" described by "Current status." }
    latestCruise is optional CruiseData with { briefly "Cruise" described by "Latest cruise." }
    currentSale is optional TimberSaleInfo with { briefly "Sale" described by "Current sale." }
    loads is many optional HarvestLoad with { briefly "Loads" described by "Harvest loads." }
    regenerationPlan is optional RegenerationPlan with { briefly "Regen" described by "Regen plan." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active stand state"
    described by "State for active stand."
  }

  record RegeneratingStateData is {
    standId is StandId with { briefly "Stand" described by "Stand ID." }
    regenerationPlan is RegenerationPlan with { briefly "Plan" described by "Regen plan." }
    treesPlanted is Natural with { briefly "Trees" described by "Trees planted." }
    plantingDate is Date with { briefly "Planted" described by "Planting date." }
  } with {
    briefly "Regenerating stand state"
    described by "State for regenerating stand."
  }

  state ActiveState of Stand.ActiveStateData with {
    briefly "Stand active"
    described by "Stand is in active management."
  }

  state RegeneratingState of Stand.RegeneratingStateData with {
    briefly "Stand regenerating"
    described by "Stand is in regeneration."
  }

  handler StandHandler is {
    on command RegisterStand {
      morph entity TimberContext.Stand to state TimberContext.Stand.ActiveState with command RegisterStand
      tell event StandRegistered to entity TimberContext.Stand
    }
    on command RecordCruise {
      tell event CruiseRecorded to entity TimberContext.Stand
    }
    on command PlanHarvest {
      tell event HarvestPlanned to entity TimberContext.Stand
    }
    on command RecordTimberSale {
      tell event TimberSaleRecorded to entity TimberContext.Stand
    }
    on command BeginHarvest {
      tell event HarvestStarted to entity TimberContext.Stand
    }
    on command RecordLoad {
      tell event LoadRecorded to entity TimberContext.Stand
    }
    on command CompleteHarvest {
      tell event HarvestCompleted to entity TimberContext.Stand
    }
    on command PlanRegeneration {
      tell event RegenerationPlanned to entity TimberContext.Stand
    }
    on command RecordPlanting {
      morph entity TimberContext.Stand to state TimberContext.Stand.RegeneratingState with command RecordPlanting
      tell event PlantingRecorded to entity TimberContext.Stand
    }
    on command UpdateGrowth {
      tell event GrowthUpdated to entity TimberContext.Stand
    }
  } with {
    briefly "Processes stand commands"
    described by "Handles stand lifecycle."
  }

} with {
  briefly "Stand aggregate"
  described by "Manages timber stands."
}
