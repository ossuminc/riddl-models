// Harvest Planning - HarvestBlock Entity
entity HarvestBlock is {
  command CreateHarvestBlock is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |New harvest block identifier.
      }
    }
    standAssessment: StandAssessment with {
      briefly "Assessment"
      described as {
        |Initial stand assessment.
      }
    }
    proposedMethod: HarvestMethod with {
      briefly "Method"
      described as {
        |Proposed harvest method.
      }
    }
  } with {
    briefly "Create harvest block"
    described as {
      |Creates a new harvest block from a stand assessment.
    }
  }
  command DelineateBlock is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    boundary: BlockBoundary with {
      briefly "Boundary"
      described as {
        |Block boundary definition.
      }
    }
  } with {
    briefly "Delineate block"
    described as {
      |Defines the geographic boundary of a harvest block.
    }
  }
  command SubmitEnvironmentalReview is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    submittedBy: String(1,100) with {
      briefly "Submitted by"
      described as {
        |Person submitting the review request.
      }
    }
  } with {
    briefly "Submit environmental review"
    described as {
      |Submits block for environmental impact review.
    }
  }
  command RecordReviewOutcome is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    review: EnvironmentalReview with {
      briefly "Review"
      described as {
        |Environmental review results.
      }
    }
  } with {
    briefly "Record review outcome"
    described as {
      |Records the environmental review decision.
    }
  }
  command ScheduleHarvest is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    schedule: HarvestSchedule with {
      briefly "Schedule"
      described as {
        |Harvest schedule details.
      }
    }
  } with {
    briefly "Schedule harvest"
    described as {
      |Schedules harvest with contractor and dates.
    }
  }
  command AssignContractor is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor identifier.
      }
    }
    contractValue: Decimal(12,2) with {
      briefly "Value"
      described as {
        |Contract value.
      }
    }
  } with {
    briefly "Assign contractor"
    described as {
      |Assigns a harvesting contractor to the block.
    }
  }
  command BeginHarvest is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    actualStart: Date with {
      briefly "Start"
      described as {
        |Actual harvest start date.
      }
    }
  } with {
    briefly "Begin harvest"
    described as {
      |Marks harvest operations as started.
    }
  }
  command CompleteHarvest is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    actualVolume: Decimal(10,2) with {
      briefly "Volume"
      described as {
        |Actual harvested volume in cubic meters.
      }
    }
    completionDate: Date with {
      briefly "Completed"
      described as {
        |Harvest completion date.
      }
    }
  } with {
    briefly "Complete harvest"
    described as {
      |Records harvest completion and actual volumes.
    }
  }
  command PlanReforestation is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    reforestationPlan: ReforestationPlan with {
      briefly "Plan"
      described as {
        |Reforestation plan details.
      }
    }
  } with {
    briefly "Plan reforestation"
    described as {
      |Creates a reforestation plan for the harvested block.
    }
  }
  command RejectBlock is  {
    blockId: HarvestBlockId with {
      briefly "Block ID"
      described as {
        |Block identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject block"
    described as {
      |Rejects harvest block due to environmental or other concerns.
    }
  }
  // Events
  event HarvestBlockCreated is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    standAssessment: StandAssessment with {
      briefly "Assessment"
      described as {
        |Stand assessment.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Harvest block created"
    described as {
      |Emitted when a harvest block is created.
    }
  }
  event BlockDelineated is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    boundary: BlockBoundary with {
      briefly "Boundary"
      described as {
        |Block boundary.
      }
    }
    delineatedAt: TimeStamp with {
      briefly "Delineated"
      described as {
        |Delineation time.
      }
    }
  } with {
    briefly "Block delineated"
    described as {
      |Emitted when block boundary is defined.
    }
  }
  event EnvironmentalReviewSubmitted is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Environmental review submitted"
    described as {
      |Emitted when block is submitted for review.
    }
  }
  event ReviewOutcomeRecorded is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    outcome: ReviewOutcome with {
      briefly "Outcome"
      described as {
        |Review outcome.
      }
    }
    reviewedAt: TimeStamp with {
      briefly "Reviewed"
      described as {
        |Review time.
      }
    }
  } with {
    briefly "Review outcome recorded"
    described as {
      |Emitted when environmental review is completed.
    }
  }
  event HarvestScheduled is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    schedule: HarvestSchedule with {
      briefly "Schedule"
      described as {
        |Harvest schedule.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Scheduling time.
      }
    }
  } with {
    briefly "Harvest scheduled"
    described as {
      |Emitted when harvest is scheduled.
    }
  }
  event ContractorAssigned is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Contractor assigned"
    described as {
      |Emitted when contractor is assigned.
    }
  }
  event HarvestBegan is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Harvest began"
    described as {
      |Emitted when harvest operations begin.
    }
  }
  event HarvestCompleted is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    actualVolume: Decimal(10,2) with {
      briefly "Volume"
      described as {
        |Harvested volume.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Harvest completed"
    described as {
      |Emitted when harvest is completed.
    }
  }
  event ReforestationPlanned is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    planId: ReforestationPlanId with {
      briefly "Plan"
      described as {
        |Reforestation plan ID.
      }
    }
    plannedAt: TimeStamp with {
      briefly "Planned"
      described as {
        |Planning time.
      }
    }
  } with {
    briefly "Reforestation planned"
    described as {
      |Emitted when reforestation plan is created.
    }
  }
  event BlockRejected is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Block rejected"
    described as {
      |Emitted when harvest block is rejected.
    }
  }
  // States
  record ActiveBlockData is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    standAssessment: StandAssessment with {
      briefly "Assessment"
      described as {
        |Stand assessment.
      }
    }
    proposedMethod: HarvestMethod with {
      briefly "Method"
      described as {
        |Proposed harvest method.
      }
    }
    status: BlockStatus with {
      briefly "Status"
      described as {
        |Block status.
      }
    }
    updatedBoundary: BlockBoundary? with {
      briefly "Boundary"
      described as {
        |Block boundary.
      }
    }
    environmentalReview: EnvironmentalReview? with {
      briefly "Review"
      described as {
        |Environmental review.
      }
    }
    updatedSchedule: HarvestSchedule? with {
      briefly "Schedule"
      described as {
        |Harvest schedule.
      }
    }
    updatedReforestationPlan: ReforestationPlan? with {
      briefly "Reforestation"
      described as {
        |Reforestation plan.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active block state"
    described as {
      |State for an active harvest block.
    }
  }
  record CompletedBlockData is  {
    blockId: HarvestBlockId with {
      briefly "Block"
      described as {
        |Block ID.
      }
    }
    actualVolume: Decimal(10,2) with {
      briefly "Volume"
      described as {
        |Actual harvested volume.
      }
    }
    reforestationPlan: ReforestationPlan with {
      briefly "Reforestation"
      described as {
        |Reforestation plan.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed block state"
    described as {
      |State for a completed harvest block.
    }
  }
  state ActiveBlockState of type HarvestBlock.ActiveBlockData
  state CompletedBlockState of type HarvestBlock.CompletedBlockData
  handler HarvestBlockHandler is {
    on command CreateHarvestBlock is {
      morph entity HarvestPlanningContext.HarvestBlock to state HarvestPlanningContext.HarvestBlock.ActiveBlockState with command CreateHarvestBlock
      tell event HarvestBlockCreated to entity HarvestPlanningContext.HarvestBlock
    }
    on command DelineateBlock is {
      tell event BlockDelineated to entity HarvestPlanningContext.HarvestBlock
    }
    on command SubmitEnvironmentalReview is {
      tell event EnvironmentalReviewSubmitted to entity HarvestPlanningContext.HarvestBlock
    }
    on command RecordReviewOutcome is {
      tell event ReviewOutcomeRecorded to entity HarvestPlanningContext.HarvestBlock
    }
    on command ScheduleHarvest is {
      tell event HarvestScheduled to entity HarvestPlanningContext.HarvestBlock
    }
    on command AssignContractor is {
      tell event ContractorAssigned to entity HarvestPlanningContext.HarvestBlock
    }
    on command BeginHarvest is {
      tell event HarvestBegan to entity HarvestPlanningContext.HarvestBlock
    }
    on command CompleteHarvest is {
      morph entity HarvestPlanningContext.HarvestBlock to state HarvestPlanningContext.HarvestBlock.CompletedBlockState with command CompleteHarvest
      tell event HarvestCompleted to entity HarvestPlanningContext.HarvestBlock
    }
    on command PlanReforestation is {
      tell event ReforestationPlanned to entity HarvestPlanningContext.HarvestBlock
    }
    on command RejectBlock is {
      tell event BlockRejected to entity HarvestPlanningContext.HarvestBlock
    }
  } with {
    briefly "Processes harvest block commands"
    described as {
      |Handles harvest block lifecycle.
    }
  }
} with {
  briefly "HarvestBlock aggregate"
  described as {
    |Manages forestry harvest blocks.
  }
}
