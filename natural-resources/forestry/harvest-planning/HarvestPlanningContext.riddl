// Harvest Planning - Harvest Planning Context

context HarvestPlanningContext is {

  include "types.riddl"
  include "HarvestBlock.riddl"

  repository HarvestPlanningRepository is {
    schema HarvestPlanningData is relational
      of harvestBlocks as HarvestBlock
      index on field HarvestBlock.blockId
      index on field HarvestBlock.standAssessment.standId
      index on field HarvestBlock.status

    handler HarvestPlanningPersistence is {
      on event HarvestBlock.HarvestBlockCreated {
        prompt "Store new harvest block"
      }
      on event HarvestBlock.BlockDelineated {
        prompt "Update block boundary"
      }
      on event HarvestBlock.ReviewOutcomeRecorded {
        prompt "Store environmental review outcome"
      }
      on event HarvestBlock.HarvestScheduled {
        prompt "Store harvest schedule"
      }
      on event HarvestBlock.HarvestCompleted {
        prompt "Update block to completed"
      }
      on event HarvestBlock.ReforestationPlanned {
        prompt "Store reforestation plan"
      }
    } with {
      briefly "Persists harvest planning events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Harvest planning data persistence"
    described by "Persistent storage for harvest planning."
  }

  projector HarvestMetrics is {
    updates repository HarvestPlanningRepository

    record BlockMetrics is {
      blocksProposed is Natural with { briefly "Proposed" described by "Blocks proposed." }
      blocksApproved is Natural with { briefly "Approved" described by "Blocks approved." }
      blocksCompleted is Natural with { briefly "Completed" described by "Blocks harvested." }
      blocksRejected is Natural with { briefly "Rejected" described by "Blocks rejected." }
      totalVolumeHarvested is Decimal(12, 2) with { briefly "Volume" described by "Total volume harvested." }
      averageBlockArea is Decimal(8, 2) with { briefly "Avg area" described by "Average block area in hectares." }
    } with {
      briefly "Block metrics"
      described by "Harvest block processing metrics."
    }

    handler MetricsHandler is {
      on event HarvestBlock.HarvestBlockCreated {
        prompt "Increment blocks proposed"
      }
      on event HarvestBlock.ReviewOutcomeRecorded {
        prompt "Increment blocks approved or rejected"
      }
      on event HarvestBlock.HarvestCompleted {
        prompt "Increment blocks completed and add volume"
      }
    } with {
      briefly "Maintains harvest metrics"
      described by "Projects events into harvest metrics."
    }
  } with {
    briefly "Harvest metrics"
    described by "Harvest planning analytics."
  }

} with {
  briefly "Bounded context for harvest planning"
  described by "Forestry harvest planning context."
}
