// Log Tracking - TimberLog Entity

entity TimberLog is {

  command RegisterLog is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "New log identifier."
    }
    fellingInfo is FellingInfo with {
      briefly "Felling info"
      described by "Log felling details."
    }
  } with {
    briefly "Register log"
    described by "Registers a newly felled log in the tracking system."
  }

  command ScaleLog is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    measurement is ScalingMeasurement with {
      briefly "Measurement"
      described by "Scaling measurement data."
    }
  } with {
    briefly "Scale log"
    described by "Records scaling measurement and grade for a log."
  }

  command LoadForTransport is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    transport is TransportInfo with {
      briefly "Transport"
      described by "Transport shipment details."
    }
  } with {
    briefly "Load for transport"
    described by "Records log being loaded onto a transport truck."
  }

  command MarkInTransit is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    departedAt is TimeStamp with {
      briefly "Departed"
      described by "Departure time from harvest site."
    }
  } with {
    briefly "Mark in transit"
    described by "Marks log as in transit to sawmill."
  }

  command RecordDelivery is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    delivery is DeliveryRecord with {
      briefly "Delivery"
      described by "Delivery record details."
    }
  } with {
    briefly "Record delivery"
    described by "Records log delivery at sawmill."
  }

  command RejectLog is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
    rejectedBy is String(3, 100) with {
      briefly "Rejected by"
      described by "Person rejecting the log."
    }
  } with {
    briefly "Reject log"
    described by "Rejects a log due to quality or compliance issues."
  }

  command QuarantineLog is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Quarantine reason such as pest detection."
    }
    quarantinedBy is String(3, 100) with {
      briefly "Quarantined by"
      described by "Person ordering quarantine."
    }
  } with {
    briefly "Quarantine log"
    described by "Places log under quarantine for inspection."
  }

  command AttachComplianceDocument is {
    logId is TimberLogId with {
      briefly "Log ID"
      described by "Log identifier."
    }
    document is ComplianceDocument with {
      briefly "Document"
      described by "Compliance document to attach."
    }
  } with {
    briefly "Attach compliance document"
    described by "Attaches a regulatory compliance document to the log."
  }

  // Events
  event LogRegistered is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    fellingInfo is FellingInfo with { briefly "Info" described by "Felling info." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Log registered"
    described by "Emitted when a new log is registered."
  }

  event LogScaled is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    measurement is ScalingMeasurement with { briefly "Measurement" described by "Scaling data." }
    scaledAt is TimeStamp with { briefly "Scaled" described by "Scaling time." }
  } with {
    briefly "Log scaled"
    described by "Emitted when log is measured and graded."
  }

  event LogLoaded is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    transport is TransportInfo with { briefly "Transport" described by "Transport details." }
    loadedAt is TimeStamp with { briefly "Loaded" described by "Loading time." }
  } with {
    briefly "Log loaded"
    described by "Emitted when log is loaded for transport."
  }

  event LogInTransit is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    departedAt is TimeStamp with { briefly "Departed" described by "Departure time." }
  } with {
    briefly "Log in transit"
    described by "Emitted when log departs for sawmill."
  }

  event LogDelivered is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    delivery is DeliveryRecord with { briefly "Delivery" described by "Delivery record." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Log delivered"
    described by "Emitted when log is delivered to sawmill."
  }

  event LogRejected is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Log rejected"
    described by "Emitted when log is rejected."
  }

  event LogQuarantined is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Quarantine reason." }
    quarantinedAt is TimeStamp with { briefly "Quarantined" described by "Quarantine time." }
  } with {
    briefly "Log quarantined"
    described by "Emitted when log is placed under quarantine."
  }

  event ComplianceDocumentAttached is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    document is ComplianceDocument with { briefly "Document" described by "Compliance document." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Compliance document attached"
    described by "Emitted when compliance document is attached to log."
  }

  // States
  record ActiveLogData is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    fellingInfo is FellingInfo with { briefly "Felling" described by "Felling information." }
    status is LogStatus with { briefly "Status" described by "Current log status." }
    measurement is optional ScalingMeasurement with { briefly "Measurement" described by "Scaling measurement." }
    transport is optional TransportInfo with { briefly "Transport" described by "Transport information." }
    complianceDocs is many optional ComplianceDocument with { briefly "Documents" described by "Compliance documents." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active log state data"
    described by "State data for a log being tracked through the supply chain."
  }

  record DeliveredLogData is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    fellingInfo is FellingInfo with { briefly "Felling" described by "Felling information." }
    measurement is ScalingMeasurement with { briefly "Measurement" described by "Scaling measurement." }
    transport is TransportInfo with { briefly "Transport" described by "Transport information." }
    delivery is DeliveryRecord with { briefly "Delivery" described by "Delivery record." }
    complianceDocs is many optional ComplianceDocument with { briefly "Documents" described by "Compliance documents." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Delivered log state data"
    described by "State data for a log that has been delivered to a sawmill."
  }

  record RejectedLogData is {
    logId is TimberLogId with { briefly "Log" described by "Log ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Rejected log state data"
    described by "State data for a rejected log."
  }

  state ActiveLog of TimberLog.ActiveLogData with {
    briefly "Log active"
    described by "Log is being tracked through the supply chain."
  }

  state DeliveredLog of TimberLog.DeliveredLogData with {
    briefly "Log delivered"
    described by "Log has been delivered to a sawmill."
  }

  state RejectedLog of TimberLog.RejectedLogData with {
    briefly "Log rejected"
    described by "Log has been rejected from the supply chain."
  }

  handler TimberLogHandler is {
    on command RegisterLog {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.ActiveLog with command RegisterLog
      tell event LogRegistered to entity LogTrackingContext.TimberLog
    }
    on command ScaleLog {
      tell event LogScaled to entity LogTrackingContext.TimberLog
    }
    on command LoadForTransport {
      tell event LogLoaded to entity LogTrackingContext.TimberLog
    }
    on command MarkInTransit {
      tell event LogInTransit to entity LogTrackingContext.TimberLog
    }
    on command RecordDelivery {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.DeliveredLog with command RecordDelivery
      tell event LogDelivered to entity LogTrackingContext.TimberLog
    }
    on command RejectLog {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.RejectedLog with command RejectLog
      tell event LogRejected to entity LogTrackingContext.TimberLog
    }
    on command QuarantineLog {
      tell event LogQuarantined to entity LogTrackingContext.TimberLog
    }
    on command AttachComplianceDocument {
      tell event ComplianceDocumentAttached to entity LogTrackingContext.TimberLog
    }
  } with {
    briefly "Processes timber log commands"
    described by "Handles timber log lifecycle from felling to delivery."
  }

} with {
  briefly "TimberLog aggregate"
  described by "Manages individual timber logs through the supply chain."
}
