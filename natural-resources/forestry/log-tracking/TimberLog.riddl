// Log Tracking - TimberLog Entity
entity TimberLog is {
  command RegisterLog is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |New log identifier.
      }
    }
    fellingInfo: FellingInfo with {
      briefly "Felling info"
      described as {
        |Log felling details.
      }
    }
  } with {
    briefly "Register log"
    described as {
      |Registers a newly felled log in the tracking system.
    }
  }
  command ScaleLog is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    measurement: ScalingMeasurement with {
      briefly "Measurement"
      described as {
        |Scaling measurement data.
      }
    }
  } with {
    briefly "Scale log"
    described as {
      |Records scaling measurement and grade for a log.
    }
  }
  command LoadForTransport is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    transport: TransportInfo with {
      briefly "Transport"
      described as {
        |Transport shipment details.
      }
    }
  } with {
    briefly "Load for transport"
    described as {
      |Records log being loaded onto a transport truck.
    }
  }
  command MarkInTransit is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time from harvest site.
      }
    }
  } with {
    briefly "Mark in transit"
    described as {
      |Marks log as in transit to sawmill.
    }
  }
  command RecordDelivery is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    delivery: DeliveryRecord with {
      briefly "Delivery"
      described as {
        |Delivery record details.
      }
    }
  } with {
    briefly "Record delivery"
    described as {
      |Records log delivery at sawmill.
    }
  }
  command RejectLog is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: String(3,100) with {
      briefly "Rejected by"
      described as {
        |Person rejecting the log.
      }
    }
  } with {
    briefly "Reject log"
    described as {
      |Rejects a log due to quality or compliance issues.
    }
  }
  command QuarantineLog is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Quarantine reason such as pest detection.
      }
    }
    quarantinedBy: String(3,100) with {
      briefly "Quarantined by"
      described as {
        |Person ordering quarantine.
      }
    }
  } with {
    briefly "Quarantine log"
    described as {
      |Places log under quarantine for inspection.
    }
  }
  command AttachComplianceDocument is  {
    logId: TimberLogId with {
      briefly "Log ID"
      described as {
        |Log identifier.
      }
    }
    document: ComplianceDocument with {
      briefly "Document"
      described as {
        |Compliance document to attach.
      }
    }
  } with {
    briefly "Attach compliance document"
    described as {
      |Attaches a regulatory compliance document to the log.
    }
  }
  // Events
  event LogRegistered is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    fellingInfo: FellingInfo with {
      briefly "Info"
      described as {
        |Felling info.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Log registered"
    described as {
      |Emitted when a new log is registered.
    }
  }
  event LogScaled is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    measurement: ScalingMeasurement with {
      briefly "Measurement"
      described as {
        |Scaling data.
      }
    }
    scaledAt: TimeStamp with {
      briefly "Scaled"
      described as {
        |Scaling time.
      }
    }
  } with {
    briefly "Log scaled"
    described as {
      |Emitted when log is measured and graded.
    }
  }
  event LogLoaded is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    transport: TransportInfo with {
      briefly "Transport"
      described as {
        |Transport details.
      }
    }
    loadedAt: TimeStamp with {
      briefly "Loaded"
      described as {
        |Loading time.
      }
    }
  } with {
    briefly "Log loaded"
    described as {
      |Emitted when log is loaded for transport.
    }
  }
  event LogInTransit is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
  } with {
    briefly "Log in transit"
    described as {
      |Emitted when log departs for sawmill.
    }
  }
  event LogDelivered is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    delivery: DeliveryRecord with {
      briefly "Delivery"
      described as {
        |Delivery record.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Log delivered"
    described as {
      |Emitted when log is delivered to sawmill.
    }
  }
  event LogRejected is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Log rejected"
    described as {
      |Emitted when log is rejected.
    }
  }
  event LogQuarantined is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Quarantine reason.
      }
    }
    quarantinedAt: TimeStamp with {
      briefly "Quarantined"
      described as {
        |Quarantine time.
      }
    }
  } with {
    briefly "Log quarantined"
    described as {
      |Emitted when log is placed under quarantine.
    }
  }
  event ComplianceDocumentAttached is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    document: ComplianceDocument with {
      briefly "Document"
      described as {
        |Compliance document.
      }
    }
    attachedAt: TimeStamp with {
      briefly "Attached"
      described as {
        |Attachment time.
      }
    }
  } with {
    briefly "Compliance document attached"
    described as {
      |Emitted when compliance document is attached to log.
    }
  }
  // States
  record ActiveLogData is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    fellingInfo: FellingInfo with {
      briefly "Felling"
      described as {
        |Felling information.
      }
    }
    status: LogStatus with {
      briefly "Status"
      described as {
        |Current log status.
      }
    }
    updatedMeasurement: ScalingMeasurement? with {
      briefly "Measurement"
      described as {
        |Scaling measurement.
      }
    }
    updatedTransport: TransportInfo? with {
      briefly "Transport"
      described as {
        |Transport information.
      }
    }
    complianceDocs: ComplianceDocument* with {
      briefly "Documents"
      described as {
        |Compliance documents.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Active log state data"
    described as {
      |State data for a log being tracked through the supply chain.
    }
  }
  record DeliveredLogData is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    fellingInfo: FellingInfo with {
      briefly "Felling"
      described as {
        |Felling information.
      }
    }
    measurement: ScalingMeasurement with {
      briefly "Measurement"
      described as {
        |Scaling measurement.
      }
    }
    transport: TransportInfo with {
      briefly "Transport"
      described as {
        |Transport information.
      }
    }
    delivery: DeliveryRecord with {
      briefly "Delivery"
      described as {
        |Delivery record.
      }
    }
    complianceDocs: ComplianceDocument* with {
      briefly "Documents"
      described as {
        |Compliance documents.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Delivered log state data"
    described as {
      |State data for a log that has been delivered to a sawmill.
    }
  }
  record RejectedLogData is  {
    logId: TimberLogId with {
      briefly "Log"
      described as {
        |Log ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Rejected log state data"
    described as {
      |State data for a rejected log.
    }
  }
  state ActiveLog of type TimberLog.ActiveLogData
  state DeliveredLog of type TimberLog.DeliveredLogData
  state RejectedLog of type TimberLog.RejectedLogData
  handler TimberLogHandler is {
    on command RegisterLog is {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.ActiveLog with command RegisterLog
      tell event LogRegistered to entity LogTrackingContext.TimberLog
    }
    on command ScaleLog is {
      tell event LogScaled to entity LogTrackingContext.TimberLog
    }
    on command LoadForTransport is {
      tell event LogLoaded to entity LogTrackingContext.TimberLog
    }
    on command MarkInTransit is {
      tell event LogInTransit to entity LogTrackingContext.TimberLog
    }
    on command RecordDelivery is {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.DeliveredLog with command RecordDelivery
      tell event LogDelivered to entity LogTrackingContext.TimberLog
    }
    on command RejectLog is {
      morph entity LogTrackingContext.TimberLog to state LogTrackingContext.TimberLog.RejectedLog with command RejectLog
      tell event LogRejected to entity LogTrackingContext.TimberLog
    }
    on command QuarantineLog is {
      tell event LogQuarantined to entity LogTrackingContext.TimberLog
    }
    on command AttachComplianceDocument is {
      tell event ComplianceDocumentAttached to entity LogTrackingContext.TimberLog
    }
  } with {
    briefly "Processes timber log commands"
    described as {
      |Handles timber log lifecycle from felling to delivery.
    }
  }
} with {
  briefly "TimberLog aggregate"
  described as {
    |Manages individual timber logs through the supply chain.
  }
}
