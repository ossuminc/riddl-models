// Licensing - License Entity

entity License is {

  // Commands
  command SubmitApplication is {
    licenseId is LicenseId with {
      briefly "License"
      described by "New license identifier."
    }
    application is LicenseApplication with {
      briefly "Application"
      described by "Application details."
    }
  } with {
    briefly "Submit application"
    described by "Submits a license application."
  }

  command UpdateApplication is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    updates is LicenseApplication with {
      briefly "Updates"
      described by "Application updates."
    }
  } with {
    briefly "Update application"
    described by "Updates application details."
  }

  command RequestAdditionalInfo is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    infoNeeded is String(1, 1000) with {
      briefly "Info needed"
      described by "Information requested."
    }
    deadline is Date with {
      briefly "Deadline"
      described by "Response deadline."
    }
  } with {
    briefly "Request additional info"
    described by "Requests more information."
  }

  command VerifyCredentials is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    credentialType is String(1, 50) with {
      briefly "Type"
      described by "Credential type."
    }
    verified is Boolean with {
      briefly "Verified"
      described by "Verification result."
    }
    verificationNotes is optional String(1, 500) with {
      briefly "Notes"
      described by "Verification notes."
    }
  } with {
    briefly "Verify credentials"
    described by "Verifies applicant credentials."
  }

  command RecordExamResult is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    examScore is ExamScore with {
      briefly "Score"
      described by "Exam result."
    }
  } with {
    briefly "Record exam result"
    described by "Records examination results."
  }

  command ApproveApplication is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    approvedBy is String(1, 200) with {
      briefly "Approved by"
      described by "Approving official."
    }
    licenseDetails is LicenseDetails with {
      briefly "Details"
      described by "License details."
    }
  } with {
    briefly "Approve application"
    described by "Approves and issues license."
  }

  command DenyApplication is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    deniedBy is String(1, 200) with {
      briefly "Denied by"
      described by "Denying official."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Denial reason."
    }
    appealDeadline is Date with {
      briefly "Appeal deadline"
      described by "Appeal filing deadline."
    }
  } with {
    briefly "Deny application"
    described by "Denies the application."
  }

  command ProcessPayment is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    payment is FeePayment with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Process payment"
    described by "Processes fee payment."
  }

  command RenewLicense is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    renewal is RenewalInfo with {
      briefly "Renewal"
      described by "Renewal details."
    }
  } with {
    briefly "Renew license"
    described by "Renews the license."
  }

  command FileComplaint is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    complaint is ComplaintInfo with {
      briefly "Complaint"
      described by "Complaint details."
    }
  } with {
    briefly "File complaint"
    described by "Files complaint against licensee."
  }

  command RecordDisciplinaryAction is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    disciplinaryRecord is DisciplinaryRecord with {
      briefly "Record"
      described by "Disciplinary action."
    }
  } with {
    briefly "Record disciplinary action"
    described by "Records enforcement action."
  }

  command SuspendLicense is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Suspension reason."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Suspension start."
    }
    endDate is optional Date with {
      briefly "End"
      described by "Suspension end."
    }
  } with {
    briefly "Suspend license"
    described by "Suspends the license."
  }

  command RevokeLicense is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Revocation reason."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Revocation date."
    }
  } with {
    briefly "Revoke license"
    described by "Revokes the license."
  }

  command ReinstateLicense is {
    licenseId is LicenseId with {
      briefly "License"
      described by "License identifier."
    }
    conditions is many optional String(1, 500) with {
      briefly "Conditions"
      described by "Reinstatement conditions."
    }
    reinstatedAt is TimeStamp with {
      briefly "Reinstated"
      described by "Reinstatement time."
    }
  } with {
    briefly "Reinstate license"
    described by "Reinstates the license."
  }

  // Events
  event ApplicationSubmitted is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    application is LicenseApplication with { briefly "Application" described by "Application." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Application submitted"
    described by "Emitted when application is filed."
  }

  event ApplicationUpdated is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Application updated"
    described by "Emitted when application is updated."
  }

  event AdditionalInfoRequested is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    infoNeeded is String(1, 1000) with { briefly "Info" described by "Info requested." }
    deadline is Date with { briefly "Deadline" described by "Response deadline." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Info requested"
    described by "Emitted when more info is needed."
  }

  event CredentialsVerified is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    credentialType is String(1, 50) with { briefly "Type" described by "Credential type." }
    verified is Boolean with { briefly "Verified" described by "Result." }
    verifiedAt is TimeStamp with { briefly "Verified" described by "Verification time." }
  } with {
    briefly "Credentials verified"
    described by "Emitted when credentials checked."
  }

  event ExamResultRecorded is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    examScore is ExamScore with { briefly "Score" described by "Exam result." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Exam result recorded"
    described by "Emitted when exam result is recorded."
  }

  event ApplicationApproved is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    licenseDetails is LicenseDetails with { briefly "Details" described by "License details." }
    approvedBy is String(1, 200) with { briefly "By" described by "Approved by." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Application approved"
    described by "Emitted when license is issued."
  }

  event ApplicationDenied is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Denial reason." }
    appealDeadline is Date with { briefly "Appeal" described by "Appeal deadline." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Application denied"
    described by "Emitted when application is denied."
  }

  event PaymentProcessed is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    payment is FeePayment with { briefly "Payment" described by "Payment." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is received."
  }

  event LicenseRenewed is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    newExpirationDate is Date with { briefly "Expires" described by "New expiration." }
    renewalCompletedAt is TimeStamp with { briefly "Renewed" described by "Renewal time." }
  } with {
    briefly "License renewed"
    described by "Emitted when license is renewed."
  }

  event ComplaintFiled is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    complaint is ComplaintInfo with { briefly "Complaint" described by "Complaint." }
  } with {
    briefly "Complaint filed"
    described by "Emitted when complaint is filed."
  }

  event DisciplinaryActionRecorded is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    disciplinaryRecord is DisciplinaryRecord with { briefly "Record" described by "Action." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Disciplinary action recorded"
    described by "Emitted for enforcement action."
  }

  event LicenseSuspended is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    effectiveDate is Date with { briefly "Effective" described by "Start date." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "License suspended"
    described by "Emitted when license is suspended."
  }

  event LicenseRevoked is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Revocation reason." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
    revokedAt is TimeStamp with { briefly "Revoked" described by "Revocation time." }
  } with {
    briefly "License revoked"
    described by "Emitted when license is revoked."
  }

  event LicenseReinstated is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    reinstatedAt is TimeStamp with { briefly "Reinstated" described by "Reinstatement time." }
  } with {
    briefly "License reinstated"
    described by "Emitted when license is reinstated."
  }

  // State Records
  record ActiveStateData is {
    licenseId is LicenseId with { briefly "License" described by "License ID." }
    application is LicenseApplication with { briefly "Application" described by "Application." }
    applicationStatus is ApplicationStatus with { briefly "App status" described by "Application status." }
    issuedLicenseDetails is optional LicenseDetails with { briefly "Details" described by "License details." }
    licenseStatus is LicenseStatus with { briefly "License status" described by "License status." }
    currentRenewal is optional RenewalInfo with { briefly "Renewal" described by "Renewal info." }
    complaints is many optional ComplaintInfo with { briefly "Complaints" described by "Complaints." }
    licenseeDisciplinaryHistory is many optional DisciplinaryRecord with { briefly "Disciplinary" described by "Disciplinary history." }
    payments is many optional FeePayment with { briefly "Payments" described by "Payment history." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active license."
  }

  // States
  state ActiveState of License.ActiveStateData with {
    briefly "License active"
    described by "License record is active."
  }

  // Handler
  handler LicenseHandler is {
    on command SubmitApplication {
      morph entity LicenseContext.License to state LicenseContext.License.ActiveState with command SubmitApplication
      tell event ApplicationSubmitted to entity LicenseContext.License
    }

    on command UpdateApplication {
      tell event ApplicationUpdated to entity LicenseContext.License
    }

    on command RequestAdditionalInfo {
      tell event AdditionalInfoRequested to entity LicenseContext.License
    }

    on command VerifyCredentials {
      tell event CredentialsVerified to entity LicenseContext.License
    }

    on command RecordExamResult {
      tell event ExamResultRecorded to entity LicenseContext.License
    }

    on command ApproveApplication {
      tell event ApplicationApproved to entity LicenseContext.License
    }

    on command DenyApplication {
      tell event ApplicationDenied to entity LicenseContext.License
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity LicenseContext.License
    }

    on command RenewLicense {
      tell event LicenseRenewed to entity LicenseContext.License
    }

    on command FileComplaint {
      tell event ComplaintFiled to entity LicenseContext.License
    }

    on command RecordDisciplinaryAction {
      tell event DisciplinaryActionRecorded to entity LicenseContext.License
    }

    on command SuspendLicense {
      tell event LicenseSuspended to entity LicenseContext.License
    }

    on command RevokeLicense {
      tell event LicenseRevoked to entity LicenseContext.License
    }

    on command ReinstateLicense {
      tell event LicenseReinstated to entity LicenseContext.License
    }
  } with {
    briefly "Processes license commands"
    described by {
      | Handles license lifecycle from application
      | through renewal and enforcement.
    }
  }

} with {
  briefly "License aggregate"
  described by {
    | The License entity manages professional
    | and business licenses.
  }
}
