// Compliance Reporting - Report Entity

entity Report is {

  // Commands
  command CreateReport is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "New report identifier."
    }
    organization is OrganizationInfo with {
      briefly "Organization"
      described by "Reporting organization."
    }
    requirement is ComplianceRequirement with {
      briefly "Requirement"
      described by "Compliance requirement."
    }
    period is ReportPeriod with {
      briefly "Period"
      described by "Reporting period."
    }
    reportType is ReportType with {
      briefly "Type"
      described by "Report type."
    }
  } with {
    briefly "Create report"
    described by "Creates a new compliance report."
  }

  command AddSection is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    section is ReportSection with {
      briefly "Section"
      described by "Report section."
    }
  } with {
    briefly "Add section"
    described by "Adds section to report."
  }

  command UpdateSection is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    section is ReportSection with {
      briefly "Section"
      described by "Updated section."
    }
  } with {
    briefly "Update section"
    described by "Updates report section."
  }

  command SubmitForReview is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    submittedBy is String(1, 200) with {
      briefly "Submitted by"
      described by "Person submitting for review."
    }
  } with {
    briefly "Submit for review"
    described by "Submits for internal review."
  }

  command ApproveReport is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    approvedBy is String(1, 200) with {
      briefly "Approved by"
      described by "Approver name."
    }
    comments is optional String(1, 1000) with {
      briefly "Comments"
      described by "Approval comments."
    }
  } with {
    briefly "Approve report"
    described by "Approves report for submission."
  }

  command RejectReport is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    rejectedBy is String(1, 200) with {
      briefly "Rejected by"
      described by "Rejector name."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Rejection reason."
    }
  } with {
    briefly "Reject report"
    described by "Rejects report with reason."
  }

  command SubmitReport is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    submittedBy is String(1, 200) with {
      briefly "Submitted by"
      described by "Person submitting."
    }
  } with {
    briefly "Submit report"
    described by "Submits to regulatory agency."
  }

  command RecordAcknowledgment is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    receipt is SubmissionReceipt with {
      briefly "Receipt"
      described by "Submission receipt."
    }
  } with {
    briefly "Record acknowledgment"
    described by "Records agency acknowledgment."
  }

  command AmendReport is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    amendment is AmendmentInfo with {
      briefly "Amendment"
      described by "Amendment details."
    }
  } with {
    briefly "Amend report"
    described by "Amends submitted report."
  }

  command RecordFinding is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    finding is ComplianceFinding with {
      briefly "Finding"
      described by "Compliance finding."
    }
  } with {
    briefly "Record finding"
    described by "Records compliance finding."
  }

  command ResolveFinding is {
    reportId is ReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    findingId is UUID with {
      briefly "Finding"
      described by "Finding to resolve."
    }
    resolution is String(1, 2000) with {
      briefly "Resolution"
      described by "Resolution description."
    }
    resolvedBy is String(1, 200) with {
      briefly "Resolved by"
      described by "Person resolving."
    }
  } with {
    briefly "Resolve finding"
    described by "Resolves compliance finding."
  }

  // Events
  event ReportCreated is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    organization is OrganizationInfo with { briefly "Organization" described by "Organization info." }
    requirement is ComplianceRequirement with { briefly "Requirement" described by "Requirement info." }
    period is ReportPeriod with { briefly "Period" described by "Report period." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Report created"
    described by "Emitted when report is created."
  }

  event SectionAdded is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    section is ReportSection with { briefly "Section" described by "Added section." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Section added"
    described by "Emitted when section is added."
  }

  event SectionUpdated is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    section is ReportSection with { briefly "Section" described by "Updated section." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Section updated"
    described by "Emitted when section is updated."
  }

  event SubmittedForReview is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    submittedBy is String(1, 200) with { briefly "Submitted by" described by "Submitter." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Submitted for review"
    described by "Emitted when submitted for review."
  }

  event ReportApproved is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    approvedBy is String(1, 200) with { briefly "Approved by" described by "Approver." }
    comments is optional String(1, 1000) with { briefly "Comments" described by "Approval comments." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Report approved"
    described by "Emitted when report is approved."
  }

  event ReportRejected is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    rejectedBy is String(1, 200) with { briefly "Rejected by" described by "Rejector." }
    reason is String(1, 1000) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Report rejected"
    described by "Emitted when report is rejected."
  }

  event ReportSubmitted is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    submittedBy is String(1, 200) with { briefly "Submitted by" described by "Submitter." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Report submitted"
    described by "Emitted when report is submitted."
  }

  event AcknowledgmentReceived is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    receipt is SubmissionReceipt with { briefly "Receipt" described by "Submission receipt." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Acknowledgment received"
    described by "Emitted when acknowledgment is received."
  }

  event ReportAmended is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    amendment is AmendmentInfo with { briefly "Amendment" described by "Amendment info." }
  } with {
    briefly "Report amended"
    described by "Emitted when report is amended."
  }

  event FindingRecorded is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    finding is ComplianceFinding with { briefly "Finding" described by "Compliance finding." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Finding recorded"
    described by "Emitted when finding is recorded."
  }

  event FindingResolved is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    findingId is UUID with { briefly "Finding" described by "Finding ID." }
    resolution is String(1, 2000) with { briefly "Resolution" described by "Resolution." }
    resolvedBy is String(1, 200) with { briefly "Resolved by" described by "Resolver." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Finding resolved"
    described by "Emitted when finding is resolved."
  }

  // State Records
  record ActiveStateData is {
    reportId is ReportId with { briefly "Report" described by "Report ID." }
    organization is OrganizationInfo with { briefly "Organization" described by "Organization info." }
    requirement is ComplianceRequirement with { briefly "Requirement" described by "Requirement info." }
    period is ReportPeriod with { briefly "Period" described by "Report period." }
    reportType is ReportType with { briefly "Type" described by "Report type." }
    sections is many optional ReportSection with { briefly "Sections" described by "Report sections." }
    reportStatus is ReportStatus with { briefly "Status" described by "Report status." }
    submissionReceipt is optional SubmissionReceipt with { briefly "Receipt" described by "Submission receipt." }
    reportFindings is many optional ComplianceFinding with { briefly "Findings" described by "Compliance findings." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active report."
  }

  // States
  state ActiveState of Report.ActiveStateData with {
    briefly "Report active"
    described by "Report is being worked on."
  }

  // Handler
  handler ReportHandler is {
    on command CreateReport {
      morph entity ReportContext.Report to state ReportContext.Report.ActiveState with command CreateReport
      tell event ReportCreated to entity ReportContext.Report
    }

    on command AddSection {
      tell event SectionAdded to entity ReportContext.Report
    }

    on command UpdateSection {
      tell event SectionUpdated to entity ReportContext.Report
    }

    on command SubmitForReview {
      tell event SubmittedForReview to entity ReportContext.Report
    }

    on command ApproveReport {
      tell event ReportApproved to entity ReportContext.Report
    }

    on command RejectReport {
      tell event ReportRejected to entity ReportContext.Report
    }

    on command SubmitReport {
      tell event ReportSubmitted to entity ReportContext.Report
    }

    on command RecordAcknowledgment {
      tell event AcknowledgmentReceived to entity ReportContext.Report
    }

    on command AmendReport {
      tell event ReportAmended to entity ReportContext.Report
    }

    on command RecordFinding {
      tell event FindingRecorded to entity ReportContext.Report
    }

    on command ResolveFinding {
      tell event FindingResolved to entity ReportContext.Report
    }
  } with {
    briefly "Processes report commands"
    described by {
      | Handles report lifecycle from creation
      | through review, submission, and remediation.
    }
  }

} with {
  briefly "Report aggregate"
  described by {
    | The Report entity manages compliance reports
    | and their lifecycle through submission.
  }
}
