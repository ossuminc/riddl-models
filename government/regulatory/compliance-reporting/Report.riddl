// Compliance Reporting - Report Entity
entity Report is {
  // Commands
  command CreateReport is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |New report identifier.
      }
    }
    organization: OrganizationInfo with {
      briefly "Organization"
      described as {
        |Reporting organization.
      }
    }
    requirement: ComplianceRequirement with {
      briefly "Requirement"
      described as {
        |Compliance requirement.
      }
    }
    period: ReportPeriod with {
      briefly "Period"
      described as {
        |Reporting period.
      }
    }
    reportType: ReportType with {
      briefly "Type"
      described as {
        |Report type.
      }
    }
  } with {
    briefly "Create report"
    described as {
      |Creates a new compliance report.
    }
  }
  command AddSection is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    section: ReportSection with {
      briefly "Section"
      described as {
        |Report section.
      }
    }
  } with {
    briefly "Add section"
    described as {
      |Adds section to report.
    }
  }
  command UpdateSection is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    section: ReportSection with {
      briefly "Section"
      described as {
        |Updated section.
      }
    }
  } with {
    briefly "Update section"
    described as {
      |Updates report section.
    }
  }
  command SubmitForReview is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    submittedBy: String(1,200) with {
      briefly "Submitted by"
      described as {
        |Person submitting for review.
      }
    }
  } with {
    briefly "Submit for review"
    described as {
      |Submits for internal review.
    }
  }
  command ApproveReport is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Approver name.
      }
    }
    comments: String(1,1000)? with {
      briefly "Comments"
      described as {
        |Approval comments.
      }
    }
  } with {
    briefly "Approve report"
    described as {
      |Approves report for submission.
    }
  }
  command RejectReport is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Rejector name.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject report"
    described as {
      |Rejects report with reason.
    }
  }
  command SubmitReport is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    submittedBy: String(1,200) with {
      briefly "Submitted by"
      described as {
        |Person submitting.
      }
    }
  } with {
    briefly "Submit report"
    described as {
      |Submits to regulatory agency.
    }
  }
  command RecordAcknowledgment is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    receipt: SubmissionReceipt with {
      briefly "Receipt"
      described as {
        |Submission receipt.
      }
    }
  } with {
    briefly "Record acknowledgment"
    described as {
      |Records agency acknowledgment.
    }
  }
  command AmendReport is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    amendment: AmendmentInfo with {
      briefly "Amendment"
      described as {
        |Amendment details.
      }
    }
  } with {
    briefly "Amend report"
    described as {
      |Amends submitted report.
    }
  }
  command RecordFinding is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    finding: ComplianceFinding with {
      briefly "Finding"
      described as {
        |Compliance finding.
      }
    }
  } with {
    briefly "Record finding"
    described as {
      |Records compliance finding.
    }
  }
  command ResolveFinding is  {
    reportId: ReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    findingId: UUID with {
      briefly "Finding"
      described as {
        |Finding to resolve.
      }
    }
    resolution: String(1,2000) with {
      briefly "Resolution"
      described as {
        |Resolution description.
      }
    }
    resolvedBy: String(1,200) with {
      briefly "Resolved by"
      described as {
        |Person resolving.
      }
    }
  } with {
    briefly "Resolve finding"
    described as {
      |Resolves compliance finding.
    }
  }
  // Events
  event ReportCreated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    organization: OrganizationInfo with {
      briefly "Organization"
      described as {
        |Organization info.
      }
    }
    requirement: ComplianceRequirement with {
      briefly "Requirement"
      described as {
        |Requirement info.
      }
    }
    period: ReportPeriod with {
      briefly "Period"
      described as {
        |Report period.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Report created"
    described as {
      |Emitted when report is created.
    }
  }
  event SectionAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    section: ReportSection with {
      briefly "Section"
      described as {
        |Added section.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Section added"
    described as {
      |Emitted when section is added.
    }
  }
  event SectionUpdated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    section: ReportSection with {
      briefly "Section"
      described as {
        |Updated section.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Section updated"
    described as {
      |Emitted when section is updated.
    }
  }
  event SubmittedForReview is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    submittedBy: String(1,200) with {
      briefly "Submitted by"
      described as {
        |Submitter.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Submitted for review"
    described as {
      |Emitted when submitted for review.
    }
  }
  event ReportApproved is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    comments: String(1,1000)? with {
      briefly "Comments"
      described as {
        |Approval comments.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Report approved"
    described as {
      |Emitted when report is approved.
    }
  }
  event ReportRejected is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Rejector.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Report rejected"
    described as {
      |Emitted when report is rejected.
    }
  }
  event ReportSubmitted is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    submittedBy: String(1,200) with {
      briefly "Submitted by"
      described as {
        |Submitter.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Report submitted"
    described as {
      |Emitted when report is submitted.
    }
  }
  event AcknowledgmentReceived is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    receipt: SubmissionReceipt with {
      briefly "Receipt"
      described as {
        |Submission receipt.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Acknowledgment received"
    described as {
      |Emitted when acknowledgment is received.
    }
  }
  event ReportAmended is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    amendment: AmendmentInfo with {
      briefly "Amendment"
      described as {
        |Amendment info.
      }
    }
  } with {
    briefly "Report amended"
    described as {
      |Emitted when report is amended.
    }
  }
  event FindingRecorded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    finding: ComplianceFinding with {
      briefly "Finding"
      described as {
        |Compliance finding.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Finding recorded"
    described as {
      |Emitted when finding is recorded.
    }
  }
  event FindingResolved is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    findingId: UUID with {
      briefly "Finding"
      described as {
        |Finding ID.
      }
    }
    resolution: String(1,2000) with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
    resolvedBy: String(1,200) with {
      briefly "Resolved by"
      described as {
        |Resolver.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Finding resolved"
    described as {
      |Emitted when finding is resolved.
    }
  }
  // State Records
  record ActiveStateData is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    organization: OrganizationInfo with {
      briefly "Organization"
      described as {
        |Organization info.
      }
    }
    requirement: ComplianceRequirement with {
      briefly "Requirement"
      described as {
        |Requirement info.
      }
    }
    period: ReportPeriod with {
      briefly "Period"
      described as {
        |Report period.
      }
    }
    reportType: ReportType with {
      briefly "Type"
      described as {
        |Report type.
      }
    }
    sections: ReportSection* with {
      briefly "Sections"
      described as {
        |Report sections.
      }
    }
    reportStatus: ReportStatus with {
      briefly "Status"
      described as {
        |Report status.
      }
    }
    submissionReceipt: SubmissionReceipt? with {
      briefly "Receipt"
      described as {
        |Submission receipt.
      }
    }
    reportFindings: ComplianceFinding* with {
      briefly "Findings"
      described as {
        |Compliance findings.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active report.
    }
  }
  // States
  state ActiveState of type Report.ActiveStateData
  // Handler
  handler ReportHandler is {
    on command CreateReport is {
      morph entity ReportContext.Report to state ReportContext.Report.ActiveState with command CreateReport
      tell event ReportCreated to entity ReportContext.Report
    }
    on command AddSection is {
      tell event SectionAdded to entity ReportContext.Report
    }
    on command UpdateSection is {
      tell event SectionUpdated to entity ReportContext.Report
    }
    on command SubmitForReview is {
      tell event SubmittedForReview to entity ReportContext.Report
    }
    on command ApproveReport is {
      tell event ReportApproved to entity ReportContext.Report
    }
    on command RejectReport is {
      tell event ReportRejected to entity ReportContext.Report
    }
    on command SubmitReport is {
      tell event ReportSubmitted to entity ReportContext.Report
    }
    on command RecordAcknowledgment is {
      tell event AcknowledgmentReceived to entity ReportContext.Report
    }
    on command AmendReport is {
      tell event ReportAmended to entity ReportContext.Report
    }
    on command RecordFinding is {
      tell event FindingRecorded to entity ReportContext.Report
    }
    on command ResolveFinding is {
      tell event FindingResolved to entity ReportContext.Report
    }
  } with {
    briefly "Processes report commands"
    described as {
      | Handles report lifecycle from creation
      | through review, submission, and remediation.
    }
  }
} with {
  briefly "Report aggregate"
  described as {
    | The Report entity manages compliance reports
    | and their lifecycle through submission.
  }
}
