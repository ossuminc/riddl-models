// Compliance Reporting - Report Context

context ReportContext is {

  include "types.riddl"
  include "Report.riddl"

  // Repository for report persistence
  repository ReportRepository is {
    schema ReportData is relational
      of reports as Report
      index on field Report.reportId
      index on field Report.organization.organizationId
      index on field Report.requirement.requirementId

    handler ReportPersistence is {
      on event Report.ReportCreated {
        prompt "Store new report"
      }
      on event Report.SectionAdded {
        prompt "Store report section"
      }
      on event Report.SectionUpdated {
        prompt "Update section"
      }
      on event Report.SubmittedForReview {
        prompt "Update to in review"
      }
      on event Report.ReportApproved {
        prompt "Update to approved"
      }
      on event Report.ReportRejected {
        prompt "Update to rejected"
      }
      on event Report.ReportSubmitted {
        prompt "Update to submitted"
      }
      on event Report.AcknowledgmentReceived {
        prompt "Store receipt"
      }
      on event Report.ReportAmended {
        prompt "Store amendment"
      }
      on event Report.FindingRecorded {
        prompt "Store finding"
      }
      on event Report.FindingResolved {
        prompt "Update finding resolution"
      }
    } with {
      briefly "Persists report events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Report data persistence"
    described by {
      | The ReportRepository provides persistent storage for
      | reports, submissions, and findings.
    }
  }

  // Projector for compliance analytics
  projector ComplianceAnalytics is {
    updates repository ReportRepository

    record ComplianceStats is {
      totalReports is Natural with { briefly "Total" described by "Total reports." }
      pendingReports is Natural with { briefly "Pending" described by "Pending reports." }
      submittedOnTime is Natural with { briefly "On time" described by "Submitted on time." }
      lateSubmissions is Natural with { briefly "Late" described by "Late submissions." }
      openFindings is Natural with { briefly "Open findings" described by "Open compliance findings." }
      complianceScore is Decimal(5, 2) with { briefly "Score" described by "Compliance score percent." }
    } with {
      briefly "Compliance statistics"
      described by "Compliance reporting metrics."
    }

    handler AnalyticsHandler is {
      on event Report.ReportCreated {
        prompt "Update report counts"
      }
      on event Report.ReportSubmitted {
        prompt "Update submission metrics"
      }
      on event Report.FindingRecorded {
        prompt "Update finding counts"
      }
      on event Report.FindingResolved {
        prompt "Update resolution metrics"
      }
    } with {
      briefly "Maintains compliance analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Compliance analytics projections"
    described by "Maintains compliance reporting analytics data."
  }

} with {
  briefly "Bounded context for compliance reporting"
  described by {
    | The ReportContext is the bounded context for
    | regulatory compliance and reporting.
  }
}
