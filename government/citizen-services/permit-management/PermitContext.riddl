// Permit Management - Permit Context

context PermitContext is {

  include "types.riddl"
  include "Permit.riddl"

  // Repository
  repository PermitRepository is {

    query FindPermitById is {
      permitId is PermitId with {
        briefly "Permit"
        described by "Permit identifier."
      }
    } with {
      briefly "Find permit by ID"
      described by "Retrieves permit by identifier."
    }

    result PermitResult is {
      permit is Permit.ActiveStateData with {
        briefly "Permit"
        described by "Permit data."
      }
    } with {
      briefly "Permit result"
      described by "Returns permit data."
    }

    query SearchPermits is {
      permitType is optional PermitType with {
        briefly "Type"
        described by "Filter by type."
      }
      status is optional PermitStatus with {
        briefly "Status"
        described by "Filter by status."
      }
      parcelId is optional ParcelId with {
        briefly "Parcel"
        described by "Filter by parcel."
      }
    } with {
      briefly "Search permits"
      described by "Searches permits by criteria."
    }

    result PermitsResult is {
      permits is many Permit.ActiveStateData with {
        briefly "Permits"
        described by "Matching permits."
      }
      totalCount is Natural with {
        briefly "Count"
        described by "Total matches."
      }
    } with {
      briefly "Permits result"
      described by "Returns matching permits."
    }

    query FindByAddress is {
      street is String(1, 200) with {
        briefly "Street"
        described by "Street address."
      }
      city is optional String(1, 100) with {
        briefly "City"
        described by "City."
      }
    } with {
      briefly "Find by address"
      described by "Finds permits at address."
    }

    query FindByApplicant is {
      applicantName is String(1, 200) with {
        briefly "Name"
        described by "Applicant name."
      }
    } with {
      briefly "Find by applicant"
      described by "Finds permits for applicant."
    }

    query FindPendingInspections is {
      inspectorId is optional InspectorId with {
        briefly "Inspector"
        described by "Filter by inspector."
      }
      date is optional Date with {
        briefly "Date"
        described by "Filter by date."
      }
    } with {
      briefly "Find pending inspections"
      described by "Finds scheduled inspections."
    }

    query FindExpiringPermits is {
      daysUntilExpiration is Natural with {
        briefly "Days"
        described by "Days until expiration."
      }
    } with {
      briefly "Find expiring permits"
      described by "Finds permits expiring soon."
    }

    handler PermitRepositoryHandler is {
      on query FindPermitById {
        ???
      }
      on query SearchPermits {
        ???
      }
      on query FindByAddress {
        ???
      }
      on query FindByApplicant {
        ???
      }
      on query FindPendingInspections {
        ???
      }
      on query FindExpiringPermits {
        ???
      }
    } with {
      briefly "Handles repository queries"
      described by "Processes permit queries."
    }

  } with {
    briefly "Permit repository"
    described by "Persistence for permit records."
  }

  // Projector for permit analytics
  projector PermitAnalytics is {

    record AnalyticsData is {
      totalApplications is Natural with {
        briefly "Applications"
        described by "Total applications."
      }
      applicationsByType is many TypeCount with {
        briefly "By type"
        described by "Applications by type."
      }
      averageReviewDays is Decimal(5, 2) with {
        briefly "Avg review"
        described by "Average review time."
      }
      pendingReviews is Natural with {
        briefly "Pending"
        described by "Pending reviews."
      }
      inspectionPassRate is Decimal(5, 2) with {
        briefly "Pass rate"
        described by "Inspection pass rate."
      }
      totalFeesCollected is Decimal(12, 2) with {
        briefly "Fees"
        described by "Total fees collected."
      }
      permitsByStatus is many StatusCount with {
        briefly "By status"
        described by "Permits by status."
      }
    } with {
      briefly "Analytics data"
      described by "Permit analytics metrics."
    }

    record TypeCount is {
      permitType is PermitType with {
        briefly "Type"
        described by "Permit type."
      }
      count is Natural with {
        briefly "Count"
        described by "Application count."
      }
    } with {
      briefly "Type count"
      described by "Count by permit type."
    }

    record StatusCount is {
      status is PermitStatus with {
        briefly "Status"
        described by "Permit status."
      }
      count is Natural with {
        briefly "Count"
        described by "Permit count."
      }
    } with {
      briefly "Status count"
      described by "Count by status."
    }

    handler AnalyticsHandler is {
      on event Permit.ApplicationSubmitted {
        ???
      }
      on event Permit.PermitApproved {
        ???
      }
      on event Permit.PermitIssued {
        ???
      }
      on event Permit.InspectionRecorded {
        ???
      }
      on event Permit.PaymentProcessed {
        ???
      }
      on event Permit.PermitClosed {
        ???
      }
    } with {
      briefly "Processes analytics events"
      described by "Updates permit analytics."
    }

  } with {
    briefly "Permit analytics"
    described by "Projects permit metrics for reporting."
  }

} with {
  briefly "Permit context"
  described by {
    | The Permit context manages building and
    | land use permits.
  }
}
