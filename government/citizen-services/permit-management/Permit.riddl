// Permit Management - Permit Entity

entity Permit is {

  // Commands
  command SubmitApplication is {
    permitId is PermitId with {
      briefly "Permit"
      described by "New permit identifier."
    }
    permitType is PermitType with {
      briefly "Type"
      described by "Permit type."
    }
    applicant is ApplicantInfo with {
      briefly "Applicant"
      described by "Applicant details."
    }
    property is PropertyInfo with {
      briefly "Property"
      described by "Property info."
    }
    project is ProjectInfo with {
      briefly "Project"
      described by "Project details."
    }
  } with {
    briefly "Submit application"
    described by "Submits permit application."
  }

  command UploadDocument is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    document is DocumentSubmission with {
      briefly "Document"
      described by "Document to upload."
    }
  } with {
    briefly "Upload document"
    described by "Uploads plans or documents."
  }

  command AssignReviewer is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    reviewType is String(1, 100) with {
      briefly "Type"
      described by "Review discipline."
    }
    reviewerId is ReviewerId with {
      briefly "Reviewer"
      described by "Assigned reviewer."
    }
  } with {
    briefly "Assign reviewer"
    described by "Assigns plan reviewer."
  }

  command SubmitReview is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    review is PlanReview with {
      briefly "Review"
      described by "Review result."
    }
  } with {
    briefly "Submit review"
    described by "Submits plan review."
  }

  command RequestCorrections is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    corrections is many String(1, 500) with {
      briefly "Corrections"
      described by "Required corrections."
    }
    requestedBy is ReviewerId with {
      briefly "By"
      described by "Requesting reviewer."
    }
  } with {
    briefly "Request corrections"
    described by "Requests plan corrections."
  }

  command SubmitCorrections is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    description is String(1, 1000) with {
      briefly "Description"
      described by "Corrections made."
    }
  } with {
    briefly "Submit corrections"
    described by "Submits requested corrections."
  }

  command CalculateFees is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    fees is many FeeInfo with {
      briefly "Fees"
      described by "Calculated fees."
    }
  } with {
    briefly "Calculate fees"
    described by "Calculates permit fees."
  }

  command ProcessPayment is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    feeType is String(1, 100) with {
      briefly "Type"
      described by "Fee type."
    }
    receiptNumber is String(1, 50) with {
      briefly "Receipt"
      described by "Receipt number."
    }
  } with {
    briefly "Process payment"
    described by "Records fee payment."
  }

  command ApprovePermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    approvedBy is ReviewerId with {
      briefly "By"
      described by "Approving official."
    }
    conditions is many optional PermitCondition with {
      briefly "Conditions"
      described by "Approval conditions."
    }
  } with {
    briefly "Approve permit"
    described by "Approves the permit."
  }

  command IssuePermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    permitNumber is String(1, 50) with {
      briefly "Number"
      described by "Permit number."
    }
    expirationDate is Date with {
      briefly "Expires"
      described by "Permit expiration."
    }
    issuedBy is ReviewerId with {
      briefly "By"
      described by "Issuing official."
    }
  } with {
    briefly "Issue permit"
    described by "Issues the permit."
  }

  command ScheduleInspection is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    inspectionType is InspectionType with {
      briefly "Type"
      described by "Inspection type."
    }
    requestedDate is Date with {
      briefly "Date"
      described by "Requested date."
    }
  } with {
    briefly "Schedule inspection"
    described by "Schedules field inspection."
  }

  command AssignInspector is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    inspectionId is InspectionId with {
      briefly "Inspection"
      described by "Inspection identifier."
    }
    inspectorId is InspectorId with {
      briefly "Inspector"
      described by "Assigned inspector."
    }
  } with {
    briefly "Assign inspector"
    described by "Assigns inspector to inspection."
  }

  command RecordInspection is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    inspection is InspectionRecord with {
      briefly "Inspection"
      described by "Inspection result."
    }
  } with {
    briefly "Record inspection"
    described by "Records inspection result."
  }

  command ExtendPermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    newExpirationDate is Date with {
      briefly "New expiration"
      described by "Extended expiration date."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Extension reason."
    }
    approvedBy is ReviewerId with {
      briefly "By"
      described by "Approving official."
    }
  } with {
    briefly "Extend permit"
    described by "Extends permit expiration."
  }

  command ClosePermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    closedBy is ReviewerId with {
      briefly "By"
      described by "Closing official."
    }
    certificateOfOccupancy is optional String(1, 50) with {
      briefly "Certificate"
      described by "CO number if applicable."
    }
  } with {
    briefly "Close permit"
    described by "Closes completed permit."
  }

  command VoidPermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Void reason."
    }
    voidedBy is ReviewerId with {
      briefly "By"
      described by "Voiding official."
    }
  } with {
    briefly "Void permit"
    described by "Voids the permit."
  }

  command RevokePermit is {
    permitId is PermitId with {
      briefly "Permit"
      described by "Permit identifier."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Revocation reason."
    }
    revokedBy is ReviewerId with {
      briefly "By"
      described by "Revoking official."
    }
  } with {
    briefly "Revoke permit"
    described by "Revokes issued permit."
  }

  // Events
  event ApplicationSubmitted is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    permitType is PermitType with { briefly "Type" described by "Permit type." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant." }
    property is PropertyInfo with { briefly "Property" described by "Property." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Application submitted"
    described by "Emitted when application is submitted."
  }

  event DocumentUploaded is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    document is DocumentSubmission with { briefly "Document" described by "Uploaded document." }
  } with {
    briefly "Document uploaded"
    described by "Emitted when document is uploaded."
  }

  event ReviewerAssigned is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    reviewType is String(1, 100) with { briefly "Type" described by "Review type." }
    reviewerId is ReviewerId with { briefly "Reviewer" described by "Assigned reviewer." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Reviewer assigned"
    described by "Emitted when reviewer is assigned."
  }

  event ReviewSubmitted is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    review is PlanReview with { briefly "Review" described by "Review result." }
  } with {
    briefly "Review submitted"
    described by "Emitted when review is submitted."
  }

  event CorrectionsRequested is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    corrections is many String(1, 500) with { briefly "Corrections" described by "Required corrections." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Corrections requested"
    described by "Emitted when corrections are requested."
  }

  event CorrectionsSubmitted is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Corrections submitted"
    described by "Emitted when corrections are submitted."
  }

  event FeesCalculated is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    fees is many FeeInfo with { briefly "Fees" described by "Calculated fees." }
    totalAmount is Decimal(10, 2) with { briefly "Total" described by "Total fees." }
  } with {
    briefly "Fees calculated"
    described by "Emitted when fees are calculated."
  }

  event PaymentProcessed is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    feeType is String(1, 100) with { briefly "Type" described by "Fee type." }
    receiptNumber is String(1, 50) with { briefly "Receipt" described by "Receipt number." }
    processedAt is TimeStamp with { briefly "Processed" described by "Payment time." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event PermitApproved is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    approvedBy is ReviewerId with { briefly "By" described by "Approved by." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Permit approved"
    described by "Emitted when permit is approved."
  }

  event PermitIssued is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    permitNumber is String(1, 50) with { briefly "Number" described by "Permit number." }
    expirationDate is Date with { briefly "Expires" described by "Expiration date." }
    issuedAt is TimeStamp with { briefly "Issued" described by "Issue time." }
  } with {
    briefly "Permit issued"
    described by "Emitted when permit is issued."
  }

  event InspectionScheduled is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    inspectionId is InspectionId with { briefly "Inspection" described by "Inspection ID." }
    inspectionType is InspectionType with { briefly "Type" described by "Inspection type." }
    scheduledDate is Date with { briefly "Date" described by "Scheduled date." }
  } with {
    briefly "Inspection scheduled"
    described by "Emitted when inspection is scheduled."
  }

  event InspectorAssigned is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    inspectionId is InspectionId with { briefly "Inspection" described by "Inspection ID." }
    inspectorId is InspectorId with { briefly "Inspector" described by "Assigned inspector." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Inspector assigned"
    described by "Emitted when inspector is assigned."
  }

  event InspectionRecorded is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    inspection is InspectionRecord with { briefly "Inspection" described by "Inspection result." }
  } with {
    briefly "Inspection recorded"
    described by "Emitted when inspection is recorded."
  }

  event PermitExtended is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    newExpirationDate is Date with { briefly "Expires" described by "New expiration." }
    extendedAt is TimeStamp with { briefly "Extended" described by "Extension time." }
  } with {
    briefly "Permit extended"
    described by "Emitted when permit is extended."
  }

  event PermitClosed is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
    certificateOfOccupancy is optional String(1, 50) with { briefly "CO" described by "CO number." }
  } with {
    briefly "Permit closed"
    described by "Emitted when permit is closed."
  }

  event PermitVoided is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "Void time." }
  } with {
    briefly "Permit voided"
    described by "Emitted when permit is voided."
  }

  event PermitRevoked is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Revocation reason." }
    revokedAt is TimeStamp with { briefly "Revoked" described by "Revocation time." }
  } with {
    briefly "Permit revoked"
    described by "Emitted when permit is revoked."
  }

  // State Records
  record ActiveStateData is {
    permitId is PermitId with { briefly "Permit" described by "Permit ID." }
    permitType is PermitType with { briefly "Type" described by "Permit type." }
    permitStatus is PermitStatus with { briefly "Status" described by "Current status." }
    assignedPermitNumber is optional String(1, 50) with { briefly "Number" described by "Permit number." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant info." }
    property is PropertyInfo with { briefly "Property" described by "Property info." }
    project is ProjectInfo with { briefly "Project" described by "Project info." }
    documents is many optional DocumentSubmission with { briefly "Documents" described by "Submitted documents." }
    reviews is many optional PlanReview with { briefly "Reviews" described by "Plan reviews." }
    permitFees is many optional FeeInfo with { briefly "Fees" described by "Permit fees." }
    conditions is many optional PermitCondition with { briefly "Conditions" described by "Approval conditions." }
    inspections is many optional InspectionRecord with { briefly "Inspections" described by "Inspection records." }
    updatedExpirationDate is optional Date with { briefly "Expires" described by "Expiration date." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
    updatedIssuedAt is optional TimeStamp with { briefly "Issued" described by "Issue time." }
    updatedClosedAt is optional TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Active state"
    described by "State for active permit."
  }

  // States
  state ActiveState of Permit.ActiveStateData with {
    briefly "Permit active"
    described by "Permit record is active."
  }

  // Handler
  handler PermitHandler is {
    on command SubmitApplication {
      morph entity PermitContext.Permit to state PermitContext.Permit.ActiveState with command SubmitApplication
      tell event ApplicationSubmitted to entity PermitContext.Permit
    }

    on command UploadDocument {
      tell event DocumentUploaded to entity PermitContext.Permit
    }

    on command AssignReviewer {
      tell event ReviewerAssigned to entity PermitContext.Permit
    }

    on command SubmitReview {
      tell event ReviewSubmitted to entity PermitContext.Permit
    }

    on command RequestCorrections {
      tell event CorrectionsRequested to entity PermitContext.Permit
    }

    on command SubmitCorrections {
      tell event CorrectionsSubmitted to entity PermitContext.Permit
    }

    on command CalculateFees {
      tell event FeesCalculated to entity PermitContext.Permit
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity PermitContext.Permit
    }

    on command ApprovePermit {
      tell event PermitApproved to entity PermitContext.Permit
    }

    on command IssuePermit {
      tell event PermitIssued to entity PermitContext.Permit
    }

    on command ScheduleInspection {
      tell event InspectionScheduled to entity PermitContext.Permit
    }

    on command AssignInspector {
      tell event InspectorAssigned to entity PermitContext.Permit
    }

    on command RecordInspection {
      tell event InspectionRecorded to entity PermitContext.Permit
    }

    on command ExtendPermit {
      tell event PermitExtended to entity PermitContext.Permit
    }

    on command ClosePermit {
      tell event PermitClosed to entity PermitContext.Permit
    }

    on command VoidPermit {
      tell event PermitVoided to entity PermitContext.Permit
    }

    on command RevokePermit {
      tell event PermitRevoked to entity PermitContext.Permit
    }
  } with {
    briefly "Processes permit commands"
    described by {
      | Handles permit lifecycle from application
      | through inspection and closure.
    }
  }

} with {
  briefly "Permit aggregate"
  described by {
    | The Permit entity manages building and
    | land use permits.
  }
}
