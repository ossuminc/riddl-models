// Permit Management - Permit Entity
entity Permit is {
  // Commands
  command SubmitApplication is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |New permit identifier.
      }
    }
    permitType: PermitType with {
      briefly "Type"
      described as {
        |Permit type.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant details.
      }
    }
    property: PropertyInfo with {
      briefly "Property"
      described as {
        |Property info.
      }
    }
    project: ProjectInfo with {
      briefly "Project"
      described as {
        |Project details.
      }
    }
  } with {
    briefly "Submit application"
    described as {
      |Submits permit application.
    }
  }
  command UploadDocument is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    document: DocumentSubmission with {
      briefly "Document"
      described as {
        |Document to upload.
      }
    }
  } with {
    briefly "Upload document"
    described as {
      |Uploads plans or documents.
    }
  }
  command AssignReviewer is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    reviewType: String(1,100) with {
      briefly "Type"
      described as {
        |Review discipline.
      }
    }
    reviewerId: ReviewerId with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
  } with {
    briefly "Assign reviewer"
    described as {
      |Assigns plan reviewer.
    }
  }
  command SubmitReview is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    review: PlanReview with {
      briefly "Review"
      described as {
        |Review result.
      }
    }
  } with {
    briefly "Submit review"
    described as {
      |Submits plan review.
    }
  }
  command RequestCorrections is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    corrections: String(1,500)+ with {
      briefly "Corrections"
      described as {
        |Required corrections.
      }
    }
    requestedBy: ReviewerId with {
      briefly "By"
      described as {
        |Requesting reviewer.
      }
    }
  } with {
    briefly "Request corrections"
    described as {
      |Requests plan corrections.
    }
  }
  command SubmitCorrections is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    description: String(1,1000) with {
      briefly "Description"
      described as {
        |Corrections made.
      }
    }
  } with {
    briefly "Submit corrections"
    described as {
      |Submits requested corrections.
    }
  }
  command CalculateFees is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    fees: FeeInfo+ with {
      briefly "Fees"
      described as {
        |Calculated fees.
      }
    }
  } with {
    briefly "Calculate fees"
    described as {
      |Calculates permit fees.
    }
  }
  command ProcessPayment is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    feeType: String(1,100) with {
      briefly "Type"
      described as {
        |Fee type.
      }
    }
    receiptNumber: String(1,50) with {
      briefly "Receipt"
      described as {
        |Receipt number.
      }
    }
  } with {
    briefly "Process payment"
    described as {
      |Records fee payment.
    }
  }
  command ApprovePermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    approvedBy: ReviewerId with {
      briefly "By"
      described as {
        |Approving official.
      }
    }
    conditions: PermitCondition* with {
      briefly "Conditions"
      described as {
        |Approval conditions.
      }
    }
  } with {
    briefly "Approve permit"
    described as {
      |Approves the permit.
    }
  }
  command IssuePermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    permitNumber: String(1,50) with {
      briefly "Number"
      described as {
        |Permit number.
      }
    }
    expirationDate: Date with {
      briefly "Expires"
      described as {
        |Permit expiration.
      }
    }
    issuedBy: ReviewerId with {
      briefly "By"
      described as {
        |Issuing official.
      }
    }
  } with {
    briefly "Issue permit"
    described as {
      |Issues the permit.
    }
  }
  command ScheduleInspection is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    inspectionType: InspectionType with {
      briefly "Type"
      described as {
        |Inspection type.
      }
    }
    requestedDate: Date with {
      briefly "Date"
      described as {
        |Requested date.
      }
    }
  } with {
    briefly "Schedule inspection"
    described as {
      |Schedules field inspection.
    }
  }
  command AssignInspector is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection identifier.
      }
    }
    inspectorId: InspectorId with {
      briefly "Inspector"
      described as {
        |Assigned inspector.
      }
    }
  } with {
    briefly "Assign inspector"
    described as {
      |Assigns inspector to inspection.
    }
  }
  command RecordInspection is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    inspection: InspectionRecord with {
      briefly "Inspection"
      described as {
        |Inspection result.
      }
    }
  } with {
    briefly "Record inspection"
    described as {
      |Records inspection result.
    }
  }
  command ExtendPermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    newExpirationDate: Date with {
      briefly "New expiration"
      described as {
        |Extended expiration date.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Extension reason.
      }
    }
    approvedBy: ReviewerId with {
      briefly "By"
      described as {
        |Approving official.
      }
    }
  } with {
    briefly "Extend permit"
    described as {
      |Extends permit expiration.
    }
  }
  command ClosePermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    closedBy: ReviewerId with {
      briefly "By"
      described as {
        |Closing official.
      }
    }
    certificateOfOccupancy: String(1,50)? with {
      briefly "Certificate"
      described as {
        |CO number if applicable.
      }
    }
  } with {
    briefly "Close permit"
    described as {
      |Closes completed permit.
    }
  }
  command VoidPermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedBy: ReviewerId with {
      briefly "By"
      described as {
        |Voiding official.
      }
    }
  } with {
    briefly "Void permit"
    described as {
      |Voids the permit.
    }
  }
  command RevokePermit is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit identifier.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Revocation reason.
      }
    }
    revokedBy: ReviewerId with {
      briefly "By"
      described as {
        |Revoking official.
      }
    }
  } with {
    briefly "Revoke permit"
    described as {
      |Revokes issued permit.
    }
  }
  // Events
  event ApplicationSubmitted is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    permitType: PermitType with {
      briefly "Type"
      described as {
        |Permit type.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant.
      }
    }
    property: PropertyInfo with {
      briefly "Property"
      described as {
        |Property.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Application submitted"
    described as {
      |Emitted when application is submitted.
    }
  }
  event DocumentUploaded is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    document: DocumentSubmission with {
      briefly "Document"
      described as {
        |Uploaded document.
      }
    }
  } with {
    briefly "Document uploaded"
    described as {
      |Emitted when document is uploaded.
    }
  }
  event ReviewerAssigned is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    reviewType: String(1,100) with {
      briefly "Type"
      described as {
        |Review type.
      }
    }
    reviewerId: ReviewerId with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Reviewer assigned"
    described as {
      |Emitted when reviewer is assigned.
    }
  }
  event ReviewSubmitted is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    review: PlanReview with {
      briefly "Review"
      described as {
        |Review result.
      }
    }
  } with {
    briefly "Review submitted"
    described as {
      |Emitted when review is submitted.
    }
  }
  event CorrectionsRequested is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    corrections: String(1,500)+ with {
      briefly "Corrections"
      described as {
        |Required corrections.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Corrections requested"
    described as {
      |Emitted when corrections are requested.
    }
  }
  event CorrectionsSubmitted is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Corrections submitted"
    described as {
      |Emitted when corrections are submitted.
    }
  }
  event FeesCalculated is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    fees: FeeInfo+ with {
      briefly "Fees"
      described as {
        |Calculated fees.
      }
    }
    totalAmount: Decimal(10,2) with {
      briefly "Total"
      described as {
        |Total fees.
      }
    }
  } with {
    briefly "Fees calculated"
    described as {
      |Emitted when fees are calculated.
    }
  }
  event PaymentProcessed is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    feeType: String(1,100) with {
      briefly "Type"
      described as {
        |Fee type.
      }
    }
    receiptNumber: String(1,50) with {
      briefly "Receipt"
      described as {
        |Receipt number.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Payment time.
      }
    }
  } with {
    briefly "Payment processed"
    described as {
      |Emitted when payment is processed.
    }
  }
  event PermitApproved is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    approvedBy: ReviewerId with {
      briefly "By"
      described as {
        |Approved by.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Permit approved"
    described as {
      |Emitted when permit is approved.
    }
  }
  event PermitIssued is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    permitNumber: String(1,50) with {
      briefly "Number"
      described as {
        |Permit number.
      }
    }
    expirationDate: Date with {
      briefly "Expires"
      described as {
        |Expiration date.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Permit issued"
    described as {
      |Emitted when permit is issued.
    }
  }
  event InspectionScheduled is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    inspectionType: InspectionType with {
      briefly "Type"
      described as {
        |Inspection type.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Scheduled date.
      }
    }
  } with {
    briefly "Inspection scheduled"
    described as {
      |Emitted when inspection is scheduled.
    }
  }
  event InspectorAssigned is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    inspectorId: InspectorId with {
      briefly "Inspector"
      described as {
        |Assigned inspector.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Inspector assigned"
    described as {
      |Emitted when inspector is assigned.
    }
  }
  event InspectionRecorded is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    inspection: InspectionRecord with {
      briefly "Inspection"
      described as {
        |Inspection result.
      }
    }
  } with {
    briefly "Inspection recorded"
    described as {
      |Emitted when inspection is recorded.
    }
  }
  event PermitExtended is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    newExpirationDate: Date with {
      briefly "Expires"
      described as {
        |New expiration.
      }
    }
    extendedAt: TimeStamp with {
      briefly "Extended"
      described as {
        |Extension time.
      }
    }
  } with {
    briefly "Permit extended"
    described as {
      |Emitted when permit is extended.
    }
  }
  event PermitClosed is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
    certificateOfOccupancy: String(1,50)? with {
      briefly "CO"
      described as {
        |CO number.
      }
    }
  } with {
    briefly "Permit closed"
    described as {
      |Emitted when permit is closed.
    }
  }
  event PermitVoided is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |Void time.
      }
    }
  } with {
    briefly "Permit voided"
    described as {
      |Emitted when permit is voided.
    }
  }
  event PermitRevoked is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Revocation reason.
      }
    }
    revokedAt: TimeStamp with {
      briefly "Revoked"
      described as {
        |Revocation time.
      }
    }
  } with {
    briefly "Permit revoked"
    described as {
      |Emitted when permit is revoked.
    }
  }
  // State Records
  record ActiveStateData is  {
    permitId: PermitId with {
      briefly "Permit"
      described as {
        |Permit ID.
      }
    }
    permitType: PermitType with {
      briefly "Type"
      described as {
        |Permit type.
      }
    }
    permitStatus: PermitStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    assignedPermitNumber: String(1,50)? with {
      briefly "Number"
      described as {
        |Permit number.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant info.
      }
    }
    property: PropertyInfo with {
      briefly "Property"
      described as {
        |Property info.
      }
    }
    project: ProjectInfo with {
      briefly "Project"
      described as {
        |Project info.
      }
    }
    documents: DocumentSubmission* with {
      briefly "Documents"
      described as {
        |Submitted documents.
      }
    }
    reviews: PlanReview* with {
      briefly "Reviews"
      described as {
        |Plan reviews.
      }
    }
    permitFees: FeeInfo* with {
      briefly "Fees"
      described as {
        |Permit fees.
      }
    }
    conditions: PermitCondition* with {
      briefly "Conditions"
      described as {
        |Approval conditions.
      }
    }
    inspections: InspectionRecord* with {
      briefly "Inspections"
      described as {
        |Inspection records.
      }
    }
    updatedExpirationDate: Date? with {
      briefly "Expires"
      described as {
        |Expiration date.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
    updatedIssuedAt: TimeStamp? with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
    updatedClosedAt: TimeStamp? with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active permit.
    }
  }
  // States
  state ActiveState of type Permit.ActiveStateData
  // Handler
  handler PermitHandler is {
    on command SubmitApplication is {
      morph entity PermitContext.Permit to state PermitContext.Permit.ActiveState with command SubmitApplication
      tell event ApplicationSubmitted to entity PermitContext.Permit
    }
    on command UploadDocument is {
      tell event DocumentUploaded to entity PermitContext.Permit
    }
    on command AssignReviewer is {
      tell event ReviewerAssigned to entity PermitContext.Permit
    }
    on command SubmitReview is {
      tell event ReviewSubmitted to entity PermitContext.Permit
    }
    on command RequestCorrections is {
      tell event CorrectionsRequested to entity PermitContext.Permit
    }
    on command SubmitCorrections is {
      tell event CorrectionsSubmitted to entity PermitContext.Permit
    }
    on command CalculateFees is {
      tell event FeesCalculated to entity PermitContext.Permit
    }
    on command ProcessPayment is {
      tell event PaymentProcessed to entity PermitContext.Permit
    }
    on command ApprovePermit is {
      tell event PermitApproved to entity PermitContext.Permit
    }
    on command IssuePermit is {
      tell event PermitIssued to entity PermitContext.Permit
    }
    on command ScheduleInspection is {
      tell event InspectionScheduled to entity PermitContext.Permit
    }
    on command AssignInspector is {
      tell event InspectorAssigned to entity PermitContext.Permit
    }
    on command RecordInspection is {
      tell event InspectionRecorded to entity PermitContext.Permit
    }
    on command ExtendPermit is {
      tell event PermitExtended to entity PermitContext.Permit
    }
    on command ClosePermit is {
      tell event PermitClosed to entity PermitContext.Permit
    }
    on command VoidPermit is {
      tell event PermitVoided to entity PermitContext.Permit
    }
    on command RevokePermit is {
      tell event PermitRevoked to entity PermitContext.Permit
    }
  } with {
    briefly "Processes permit commands"
    described as {
      | Handles permit lifecycle from application
      | through inspection and closure.
    }
  }
} with {
  briefly "Permit aggregate"
  described as {
    | The Permit entity manages building and
    | land use permits.
  }
}
