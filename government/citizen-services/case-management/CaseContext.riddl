// Case Management - Case Context

context CaseContext is {

  include "types.riddl"
  include "Case.riddl"

  // Repository
  repository CaseRepository is {

    query FindCaseById is {
      caseId is CaseId with {
        briefly "Case"
        described by "Case identifier."
      }
    } with {
      briefly "Find case by ID"
      described by "Retrieves case by identifier."
    }

    result CaseResult is {
      caseObj is Case.ActiveStateData with {
        briefly "Case"
        described by "Case data."
      }
    } with {
      briefly "Case result"
      described by "Returns case data."
    }

    query SearchCases is {
      caseType is optional CaseType with {
        briefly "Type"
        described by "Filter by type."
      }
      status is optional CaseStatus with {
        briefly "Status"
        described by "Filter by status."
      }
      workerId is optional WorkerId with {
        briefly "Worker"
        described by "Filter by worker."
      }
      priority is optional CasePriority with {
        briefly "Priority"
        described by "Filter by priority."
      }
    } with {
      briefly "Search cases"
      described by "Searches cases by criteria."
    }

    result CasesResult is {
      cases is many Case.ActiveStateData with {
        briefly "Cases"
        described by "Matching cases."
      }
      totalCount is Natural with {
        briefly "Count"
        described by "Total matches."
      }
    } with {
      briefly "Cases result"
      described by "Returns matching cases."
    }

    query FindByCitizen is {
      citizenId is CitizenId with {
        briefly "Citizen"
        described by "Citizen identifier."
      }
    } with {
      briefly "Find by citizen"
      described by "Finds cases for a citizen."
    }

    query FindBySSN is {
      ssn is String(9, 9) with {
        briefly "SSN"
        described by "Social security number."
      }
    } with {
      briefly "Find by SSN"
      described by "Finds cases by SSN."
    }

    query FindPendingTasks is {
      workerId is WorkerId with {
        briefly "Worker"
        described by "Worker identifier."
      }
    } with {
      briefly "Find pending tasks"
      described by "Finds worker's pending tasks."
    }

    query FindPendingApprovals is {
      supervisorId is WorkerId with {
        briefly "Supervisor"
        described by "Supervisor identifier."
      }
    } with {
      briefly "Find pending approvals"
      described by "Finds cases awaiting approval."
    }

    handler CaseRepositoryHandler is {
      on query FindCaseById {
        ???
      }
      on query SearchCases {
        ???
      }
      on query FindByCitizen {
        ???
      }
      on query FindBySSN {
        ???
      }
      on query FindPendingTasks {
        ???
      }
      on query FindPendingApprovals {
        ???
      }
    } with {
      briefly "Handles repository queries"
      described by "Processes case queries."
    }

  } with {
    briefly "Case repository"
    described by "Persistence for case records."
  }

  // Projector for workload analytics
  projector WorkloadAnalytics is {

    record AnalyticsData is {
      totalOpenCases is Natural with {
        briefly "Open"
        described by "Total open cases."
      }
      casesByType is many TypeCount with {
        briefly "By type"
        described by "Cases by type."
      }
      casesByStatus is many StatusCount with {
        briefly "By status"
        described by "Cases by status."
      }
      casesByWorker is many WorkerCaseload with {
        briefly "By worker"
        described by "Cases per worker."
      }
      averageProcessingDays is Decimal(6, 2) with {
        briefly "Avg days"
        described by "Average processing time."
      }
      pendingApprovals is Natural with {
        briefly "Pending"
        described by "Awaiting approval."
      }
      overdueTasks is Natural with {
        briefly "Overdue"
        described by "Overdue tasks."
      }
    } with {
      briefly "Analytics data"
      described by "Workload metrics."
    }

    record TypeCount is {
      caseType is CaseType with {
        briefly "Type"
        described by "Case type."
      }
      count is Natural with {
        briefly "Count"
        described by "Case count."
      }
    } with {
      briefly "Type count"
      described by "Count by case type."
    }

    record StatusCount is {
      status is CaseStatus with {
        briefly "Status"
        described by "Case status."
      }
      count is Natural with {
        briefly "Count"
        described by "Case count."
      }
    } with {
      briefly "Status count"
      described by "Count by status."
    }

    record WorkerCaseload is {
      workerId is WorkerId with {
        briefly "Worker"
        described by "Worker ID."
      }
      openCases is Natural with {
        briefly "Open"
        described by "Open cases."
      }
      pendingTasks is Natural with {
        briefly "Tasks"
        described by "Pending tasks."
      }
    } with {
      briefly "Worker caseload"
      described by "Worker's caseload."
    }

    handler AnalyticsHandler is {
      on event Case.CaseOpened {
        ???
      }
      on event Case.WorkerAssigned {
        ???
      }
      on event Case.TaskCreated {
        ???
      }
      on event Case.TaskCompleted {
        ???
      }
      on event Case.CaseClosed {
        ???
      }
    } with {
      briefly "Processes analytics events"
      described by "Updates workload analytics."
    }

  } with {
    briefly "Workload analytics"
    described by "Projects workload metrics for management."
  }

  // Projector for program statistics
  projector ProgramStatistics is {

    record StatisticsData is {
      programStats is many ProgramStat with {
        briefly "Stats"
        described by "Per-program statistics."
      }
      totalBenefitsPaid is Decimal(12, 2) with {
        briefly "Benefits"
        described by "Total benefits paid."
      }
      approvalRate is Decimal(5, 2) with {
        briefly "Approval"
        described by "Approval rate percentage."
      }
      averageBenefit is Decimal(10, 2) with {
        briefly "Average"
        described by "Average benefit amount."
      }
      appealCount is Natural with {
        briefly "Appeals"
        described by "Total appeals filed."
      }
      appealSuccessRate is Decimal(5, 2) with {
        briefly "Appeal success"
        described by "Appeal success rate."
      }
    } with {
      briefly "Statistics data"
      described by "Program statistics."
    }

    record ProgramStat is {
      programId is ProgramId with {
        briefly "Program"
        described by "Program ID."
      }
      programName is String(1, 200) with {
        briefly "Name"
        described by "Program name."
      }
      applicationsReceived is Natural with {
        briefly "Received"
        described by "Applications received."
      }
      approved is Natural with {
        briefly "Approved"
        described by "Applications approved."
      }
      denied is Natural with {
        briefly "Denied"
        described by "Applications denied."
      }
      totalPaid is Decimal(12, 2) with {
        briefly "Paid"
        described by "Total benefits paid."
      }
    } with {
      briefly "Program stat"
      described by "Statistics for program."
    }

    handler StatisticsHandler is {
      on event Case.ServicesRequested {
        ???
      }
      on event Case.ServicesApproved {
        ???
      }
      on event Case.ServicesDenied {
        ???
      }
      on event Case.AppealFiled {
        ???
      }
      on event Case.AppealResolved {
        ???
      }
    } with {
      briefly "Processes statistics events"
      described by "Updates program statistics."
    }

  } with {
    briefly "Program statistics"
    described by "Projects program performance metrics."
  }

} with {
  briefly "Case context"
  described by {
    | The Case context manages citizen services
    | and assistance cases.
  }
}
