// Case Management - Case Entity

entity Case is {

  // Commands
  command OpenCase is {
    caseId is CaseId with {
      briefly "Case"
      described by "New case identifier."
    }
    caseType is CaseType with {
      briefly "Type"
      described by "Case type."
    }
    citizen is CitizenInfo with {
      briefly "Citizen"
      described by "Primary citizen."
    }
    openedBy is WorkerId with {
      briefly "Opened by"
      described by "Opening worker."
    }
    priority is CasePriority with {
      briefly "Priority"
      described by "Initial priority."
    }
  } with {
    briefly "Open case"
    described by "Opens a new citizen case."
  }

  command AssignWorker is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    workerId is WorkerId with {
      briefly "Worker"
      described by "Assigned worker."
    }
  } with {
    briefly "Assign worker"
    described by "Assigns case to worker."
  }

  command UpdateCitizenInfo is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    citizen is CitizenInfo with {
      briefly "Citizen"
      described by "Updated citizen info."
    }
  } with {
    briefly "Update citizen info"
    described by "Updates citizen information."
  }

  command AddHouseholdMember is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    member is HouseholdMember with {
      briefly "Member"
      described by "Household member."
    }
  } with {
    briefly "Add household member"
    described by "Adds member to household."
  }

  command RemoveHouseholdMember is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    firstName is String(1, 100) with {
      briefly "First"
      described by "Member first name."
    }
    lastName is String(1, 100) with {
      briefly "Last"
      described by "Member last name."
    }
  } with {
    briefly "Remove household member"
    described by "Removes member from household."
  }

  command RecordIncome is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    income is IncomeSource with {
      briefly "Income"
      described by "Income source."
    }
  } with {
    briefly "Record income"
    described by "Records income source."
  }

  command UploadDocument is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    document is DocumentInfo with {
      briefly "Document"
      described by "Document details."
    }
  } with {
    briefly "Upload document"
    described by "Adds supporting document."
  }

  command SubmitServiceRequest is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    request is ServiceRequest with {
      briefly "Request"
      described by "Service request."
    }
  } with {
    briefly "Submit service request"
    described by "Requests program services."
  }

  command DetermineEligibility is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    programId is ProgramId with {
      briefly "Program"
      described by "Program to evaluate."
    }
    determinedBy is WorkerId with {
      briefly "By"
      described by "Determining worker."
    }
    result is EligibilityResult with {
      briefly "Result"
      described by "Eligibility result."
    }
  } with {
    briefly "Determine eligibility"
    described by "Determines program eligibility."
  }

  command AddNote is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    note is CaseNote with {
      briefly "Note"
      described by "Case note."
    }
  } with {
    briefly "Add note"
    described by "Adds case note."
  }

  command CreateTask is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    task is TaskInfo with {
      briefly "Task"
      described by "Task details."
    }
  } with {
    briefly "Create task"
    described by "Creates case task."
  }

  command CompleteTask is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    taskId is UUID with {
      briefly "Task"
      described by "Task identifier."
    }
    completedBy is WorkerId with {
      briefly "By"
      described by "Completing worker."
    }
  } with {
    briefly "Complete task"
    described by "Marks task complete."
  }

  command ApproveServices is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    programId is ProgramId with {
      briefly "Program"
      described by "Approved program."
    }
    approvedAmount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Approved amount."
    }
    approvedBy is WorkerId with {
      briefly "By"
      described by "Approving worker."
    }
  } with {
    briefly "Approve services"
    described by "Approves service request."
  }

  command DenyServices is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    programId is ProgramId with {
      briefly "Program"
      described by "Denied program."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Denial reason."
    }
    deniedBy is WorkerId with {
      briefly "By"
      described by "Denying worker."
    }
  } with {
    briefly "Deny services"
    described by "Denies service request."
  }

  command FileAppeal is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    appeal is AppealInfo with {
      briefly "Appeal"
      described by "Appeal details."
    }
  } with {
    briefly "File appeal"
    described by "Files an appeal."
  }

  command ResolveAppeal is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    appealId is UUID with {
      briefly "Appeal"
      described by "Appeal identifier."
    }
    decision is String(1, 1000) with {
      briefly "Decision"
      described by "Appeal decision."
    }
    resolvedBy is WorkerId with {
      briefly "By"
      described by "Resolving official."
    }
  } with {
    briefly "Resolve appeal"
    described by "Resolves the appeal."
  }

  command PlaceOnHold is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Place on hold"
    described by "Places case on hold."
  }

  command ResumeCase is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    resumedBy is WorkerId with {
      briefly "By"
      described by "Resuming worker."
    }
  } with {
    briefly "Resume case"
    described by "Resumes held case."
  }

  command CloseCase is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    resolution is String(1, 1000) with {
      briefly "Resolution"
      described by "Case resolution."
    }
    closedBy is WorkerId with {
      briefly "By"
      described by "Closing worker."
    }
  } with {
    briefly "Close case"
    described by "Closes the case."
  }

  command ReopenCase is {
    caseId is CaseId with {
      briefly "Case"
      described by "Case identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reopen reason."
    }
    reopenedBy is WorkerId with {
      briefly "By"
      described by "Reopening worker."
    }
  } with {
    briefly "Reopen case"
    described by "Reopens closed case."
  }

  // Events
  event CaseOpened is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    caseType is CaseType with { briefly "Type" described by "Case type." }
    citizen is CitizenInfo with { briefly "Citizen" described by "Primary citizen." }
    openedBy is WorkerId with { briefly "By" described by "Opening worker." }
    openedAt is TimeStamp with { briefly "Opened" described by "Open time." }
  } with {
    briefly "Case opened"
    described by "Emitted when case is opened."
  }

  event WorkerAssigned is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    workerId is WorkerId with { briefly "Worker" described by "Assigned worker." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Worker assigned"
    described by "Emitted when worker is assigned."
  }

  event CitizenInfoUpdated is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Citizen info updated"
    described by "Emitted when info is updated."
  }

  event HouseholdMemberAdded is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    member is HouseholdMember with { briefly "Member" described by "Added member." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Household member added"
    described by "Emitted when member is added."
  }

  event HouseholdMemberRemoved is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    firstName is String(1, 100) with { briefly "First" described by "First name." }
    lastName is String(1, 100) with { briefly "Last" described by "Last name." }
    removedAt is TimeStamp with { briefly "Removed" described by "Remove time." }
  } with {
    briefly "Household member removed"
    described by "Emitted when member is removed."
  }

  event IncomeRecorded is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    income is IncomeSource with { briefly "Income" described by "Income source." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Income recorded"
    described by "Emitted when income is recorded."
  }

  event DocumentUploaded is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    document is DocumentInfo with { briefly "Document" described by "Uploaded document." }
  } with {
    briefly "Document uploaded"
    described by "Emitted when document is uploaded."
  }

  event ServicesRequested is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    request is ServiceRequest with { briefly "Request" described by "Service request." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Services requested"
    described by "Emitted when services are requested."
  }

  event EligibilityDetermined is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    result is EligibilityResult with { briefly "Result" described by "Eligibility result." }
  } with {
    briefly "Eligibility determined"
    described by "Emitted when eligibility is determined."
  }

  event NoteAdded is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    note is CaseNote with { briefly "Note" described by "Added note." }
  } with {
    briefly "Note added"
    described by "Emitted when note is added."
  }

  event TaskCreated is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    task is TaskInfo with { briefly "Task" described by "Created task." }
  } with {
    briefly "Task created"
    described by "Emitted when task is created."
  }

  event TaskCompleted is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    taskId is UUID with { briefly "Task" described by "Task ID." }
    completedBy is WorkerId with { briefly "By" described by "Completing worker." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Task completed"
    described by "Emitted when task is completed."
  }

  event ServicesApproved is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    programId is ProgramId with { briefly "Program" described by "Approved program." }
    approvedAmount is Decimal(10, 2) with { briefly "Amount" described by "Approved amount." }
    approvedBy is WorkerId with { briefly "By" described by "Approving worker." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Services approved"
    described by "Emitted when services are approved."
  }

  event ServicesDenied is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    programId is ProgramId with { briefly "Program" described by "Denied program." }
    reason is String(1, 1000) with { briefly "Reason" described by "Denial reason." }
    deniedBy is WorkerId with { briefly "By" described by "Denying worker." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Services denied"
    described by "Emitted when services are denied."
  }

  event AppealFiled is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    appeal is AppealInfo with { briefly "Appeal" described by "Appeal details." }
  } with {
    briefly "Appeal filed"
    described by "Emitted when appeal is filed."
  }

  event AppealResolved is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    appealId is UUID with { briefly "Appeal" described by "Appeal ID." }
    decision is String(1, 1000) with { briefly "Decision" described by "Appeal decision." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Appeal resolved"
    described by "Emitted when appeal is resolved."
  }

  event CasePlacedOnHold is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Case placed on hold"
    described by "Emitted when case is held."
  }

  event CaseResumed is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    resumedBy is WorkerId with { briefly "By" described by "Resuming worker." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Case resumed"
    described by "Emitted when case resumes."
  }

  event CaseClosed is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    resolution is String(1, 1000) with { briefly "Resolution" described by "Case resolution." }
    closedBy is WorkerId with { briefly "By" described by "Closing worker." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Case closed"
    described by "Emitted when case is closed."
  }

  event CaseReopened is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Reopen reason." }
    reopenedBy is WorkerId with { briefly "By" described by "Reopening worker." }
    reopenedAt is TimeStamp with { briefly "Reopened" described by "Reopen time." }
  } with {
    briefly "Case reopened"
    described by "Emitted when case is reopened."
  }

  // State Records
  record ActiveStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    caseType is CaseType with { briefly "Type" described by "Case type." }
    status is CaseStatus with { briefly "Status" described by "Current status." }
    priority is CasePriority with { briefly "Priority" described by "Case priority." }
    citizen is CitizenInfo with { briefly "Citizen" described by "Primary citizen." }
    household is many optional HouseholdMember with { briefly "Household" described by "Household members." }
    income is many optional IncomeSource with { briefly "Income" described by "Income sources." }
    documents is many optional DocumentInfo with { briefly "Documents" described by "Supporting documents." }
    serviceRequests is many optional ServiceRequest with { briefly "Requests" described by "Service requests." }
    eligibilityResults is many optional EligibilityResult with { briefly "Eligibility" described by "Eligibility results." }
    notes is many optional CaseNote with { briefly "Notes" described by "Case notes." }
    tasks is many optional TaskInfo with { briefly "Tasks" described by "Case tasks." }
    appeals is many optional AppealInfo with { briefly "Appeals" described by "Filed appeals." }
    assignedWorker is optional WorkerId with { briefly "Worker" described by "Assigned worker." }
    openedAt is TimeStamp with { briefly "Opened" described by "Open time." }
    closedAt is optional TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Active state"
    described by "State for active case."
  }

  // States
  state ActiveState of Case.ActiveStateData with {
    briefly "Case active"
    described by "Case record is active."
  }

  // Handler
  handler CaseHandler is {
    on command OpenCase {
      morph entity CaseContext.Case to state CaseContext.Case.ActiveState with command OpenCase
      tell event CaseOpened to entity CaseContext.Case
    }

    on command AssignWorker {
      tell event WorkerAssigned to entity CaseContext.Case
    }

    on command UpdateCitizenInfo {
      tell event CitizenInfoUpdated to entity CaseContext.Case
    }

    on command AddHouseholdMember {
      tell event HouseholdMemberAdded to entity CaseContext.Case
    }

    on command RemoveHouseholdMember {
      tell event HouseholdMemberRemoved to entity CaseContext.Case
    }

    on command RecordIncome {
      tell event IncomeRecorded to entity CaseContext.Case
    }

    on command UploadDocument {
      tell event DocumentUploaded to entity CaseContext.Case
    }

    on command SubmitServiceRequest {
      tell event ServicesRequested to entity CaseContext.Case
    }

    on command DetermineEligibility {
      tell event EligibilityDetermined to entity CaseContext.Case
    }

    on command AddNote {
      tell event NoteAdded to entity CaseContext.Case
    }

    on command CreateTask {
      tell event TaskCreated to entity CaseContext.Case
    }

    on command CompleteTask {
      tell event TaskCompleted to entity CaseContext.Case
    }

    on command ApproveServices {
      tell event ServicesApproved to entity CaseContext.Case
    }

    on command DenyServices {
      tell event ServicesDenied to entity CaseContext.Case
    }

    on command FileAppeal {
      tell event AppealFiled to entity CaseContext.Case
    }

    on command ResolveAppeal {
      tell event AppealResolved to entity CaseContext.Case
    }

    on command PlaceOnHold {
      tell event CasePlacedOnHold to entity CaseContext.Case
    }

    on command ResumeCase {
      tell event CaseResumed to entity CaseContext.Case
    }

    on command CloseCase {
      tell event CaseClosed to entity CaseContext.Case
    }

    on command ReopenCase {
      tell event CaseReopened to entity CaseContext.Case
    }
  } with {
    briefly "Processes case commands"
    described by {
      | Handles case lifecycle from intake
      | through service delivery and closure.
    }
  }

} with {
  briefly "Case aggregate"
  described by {
    | The Case entity manages citizen service cases
    | and assistance programs.
  }
}
