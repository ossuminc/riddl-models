// Case Management - Case Entity
entity Case is {
  // Commands
  command OpenCase is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |New case identifier.
      }
    }
    caseType: CaseType with {
      briefly "Type"
      described as {
        |Case type.
      }
    }
    citizen: CitizenInfo with {
      briefly "Citizen"
      described as {
        |Primary citizen.
      }
    }
    openedBy: WorkerId with {
      briefly "Opened by"
      described as {
        |Opening worker.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Initial priority.
      }
    }
  } with {
    briefly "Open case"
    described as {
      |Opens a new citizen case.
    }
  }
  command AssignWorker is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    workerId: WorkerId with {
      briefly "Worker"
      described as {
        |Assigned worker.
      }
    }
  } with {
    briefly "Assign worker"
    described as {
      |Assigns case to worker.
    }
  }
  command UpdateCitizenInfo is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    citizen: CitizenInfo with {
      briefly "Citizen"
      described as {
        |Updated citizen info.
      }
    }
  } with {
    briefly "Update citizen info"
    described as {
      |Updates citizen information.
    }
  }
  command AddHouseholdMember is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    member: HouseholdMember with {
      briefly "Member"
      described as {
        |Household member.
      }
    }
  } with {
    briefly "Add household member"
    described as {
      |Adds member to household.
    }
  }
  command RemoveHouseholdMember is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    firstName: String(1,100) with {
      briefly "First"
      described as {
        |Member first name.
      }
    }
    lastName: String(1,100) with {
      briefly "Last"
      described as {
        |Member last name.
      }
    }
  } with {
    briefly "Remove household member"
    described as {
      |Removes member from household.
    }
  }
  command RecordIncome is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    income: IncomeSource with {
      briefly "Income"
      described as {
        |Income source.
      }
    }
  } with {
    briefly "Record income"
    described as {
      |Records income source.
    }
  }
  command UploadDocument is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    document: DocumentInfo with {
      briefly "Document"
      described as {
        |Document details.
      }
    }
  } with {
    briefly "Upload document"
    described as {
      |Adds supporting document.
    }
  }
  command SubmitServiceRequest is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    request: ServiceRequest with {
      briefly "Request"
      described as {
        |Service request.
      }
    }
  } with {
    briefly "Submit service request"
    described as {
      |Requests program services.
    }
  }
  command DetermineEligibility is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Program to evaluate.
      }
    }
    determinedBy: WorkerId with {
      briefly "By"
      described as {
        |Determining worker.
      }
    }
    result: EligibilityResult with {
      briefly "Result"
      described as {
        |Eligibility result.
      }
    }
  } with {
    briefly "Determine eligibility"
    described as {
      |Determines program eligibility.
    }
  }
  command AddNote is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    note: CaseNote with {
      briefly "Note"
      described as {
        |Case note.
      }
    }
  } with {
    briefly "Add note"
    described as {
      |Adds case note.
    }
  }
  command CreateTask is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    task: TaskInfo with {
      briefly "Task"
      described as {
        |Task details.
      }
    }
  } with {
    briefly "Create task"
    described as {
      |Creates case task.
    }
  }
  command CompleteTask is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    taskId: UUID with {
      briefly "Task"
      described as {
        |Task identifier.
      }
    }
    completedBy: WorkerId with {
      briefly "By"
      described as {
        |Completing worker.
      }
    }
  } with {
    briefly "Complete task"
    described as {
      |Marks task complete.
    }
  }
  command ApproveServices is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Approved program.
      }
    }
    approvedAmount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Approved amount.
      }
    }
    approvedBy: WorkerId with {
      briefly "By"
      described as {
        |Approving worker.
      }
    }
  } with {
    briefly "Approve services"
    described as {
      |Approves service request.
    }
  }
  command DenyServices is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Denied program.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedBy: WorkerId with {
      briefly "By"
      described as {
        |Denying worker.
      }
    }
  } with {
    briefly "Deny services"
    described as {
      |Denies service request.
    }
  }
  command FileAppeal is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    appeal: AppealInfo with {
      briefly "Appeal"
      described as {
        |Appeal details.
      }
    }
  } with {
    briefly "File appeal"
    described as {
      |Files an appeal.
    }
  }
  command ResolveAppeal is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    appealId: UUID with {
      briefly "Appeal"
      described as {
        |Appeal identifier.
      }
    }
    decision: String(1,1000) with {
      briefly "Decision"
      described as {
        |Appeal decision.
      }
    }
    resolvedBy: WorkerId with {
      briefly "By"
      described as {
        |Resolving official.
      }
    }
  } with {
    briefly "Resolve appeal"
    described as {
      |Resolves the appeal.
    }
  }
  command PlaceOnHold is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
  } with {
    briefly "Place on hold"
    described as {
      |Places case on hold.
    }
  }
  command ResumeCase is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    resumedBy: WorkerId with {
      briefly "By"
      described as {
        |Resuming worker.
      }
    }
  } with {
    briefly "Resume case"
    described as {
      |Resumes held case.
    }
  }
  command CloseCase is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |Case resolution.
      }
    }
    closedBy: WorkerId with {
      briefly "By"
      described as {
        |Closing worker.
      }
    }
  } with {
    briefly "Close case"
    described as {
      |Closes the case.
    }
  }
  command ReopenCase is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
    reopenedBy: WorkerId with {
      briefly "By"
      described as {
        |Reopening worker.
      }
    }
  } with {
    briefly "Reopen case"
    described as {
      |Reopens closed case.
    }
  }
  // Events
  event CaseOpened is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    caseType: CaseType with {
      briefly "Type"
      described as {
        |Case type.
      }
    }
    citizen: CitizenInfo with {
      briefly "Citizen"
      described as {
        |Primary citizen.
      }
    }
    openedBy: WorkerId with {
      briefly "By"
      described as {
        |Opening worker.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Open time.
      }
    }
  } with {
    briefly "Case opened"
    described as {
      |Emitted when case is opened.
    }
  }
  event WorkerAssigned is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    workerId: WorkerId with {
      briefly "Worker"
      described as {
        |Assigned worker.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Worker assigned"
    described as {
      |Emitted when worker is assigned.
    }
  }
  event CitizenInfoUpdated is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Citizen info updated"
    described as {
      |Emitted when info is updated.
    }
  }
  event HouseholdMemberAdded is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    member: HouseholdMember with {
      briefly "Member"
      described as {
        |Added member.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Household member added"
    described as {
      |Emitted when member is added.
    }
  }
  event HouseholdMemberRemoved is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    firstName: String(1,100) with {
      briefly "First"
      described as {
        |First name.
      }
    }
    lastName: String(1,100) with {
      briefly "Last"
      described as {
        |Last name.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Remove time.
      }
    }
  } with {
    briefly "Household member removed"
    described as {
      |Emitted when member is removed.
    }
  }
  event IncomeRecorded is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    income: IncomeSource with {
      briefly "Income"
      described as {
        |Income source.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Income recorded"
    described as {
      |Emitted when income is recorded.
    }
  }
  event DocumentUploaded is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    document: DocumentInfo with {
      briefly "Document"
      described as {
        |Uploaded document.
      }
    }
  } with {
    briefly "Document uploaded"
    described as {
      |Emitted when document is uploaded.
    }
  }
  event ServicesRequested is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    request: ServiceRequest with {
      briefly "Request"
      described as {
        |Service request.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Services requested"
    described as {
      |Emitted when services are requested.
    }
  }
  event EligibilityDetermined is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    result: EligibilityResult with {
      briefly "Result"
      described as {
        |Eligibility result.
      }
    }
  } with {
    briefly "Eligibility determined"
    described as {
      |Emitted when eligibility is determined.
    }
  }
  event NoteAdded is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    note: CaseNote with {
      briefly "Note"
      described as {
        |Added note.
      }
    }
  } with {
    briefly "Note added"
    described as {
      |Emitted when note is added.
    }
  }
  event TaskCreated is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    task: TaskInfo with {
      briefly "Task"
      described as {
        |Created task.
      }
    }
  } with {
    briefly "Task created"
    described as {
      |Emitted when task is created.
    }
  }
  event TaskCompleted is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    taskId: UUID with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    completedBy: WorkerId with {
      briefly "By"
      described as {
        |Completing worker.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Task completed"
    described as {
      |Emitted when task is completed.
    }
  }
  event ServicesApproved is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Approved program.
      }
    }
    approvedAmount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Approved amount.
      }
    }
    approvedBy: WorkerId with {
      briefly "By"
      described as {
        |Approving worker.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Services approved"
    described as {
      |Emitted when services are approved.
    }
  }
  event ServicesDenied is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Denied program.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedBy: WorkerId with {
      briefly "By"
      described as {
        |Denying worker.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Services denied"
    described as {
      |Emitted when services are denied.
    }
  }
  event AppealFiled is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    appeal: AppealInfo with {
      briefly "Appeal"
      described as {
        |Appeal details.
      }
    }
  } with {
    briefly "Appeal filed"
    described as {
      |Emitted when appeal is filed.
    }
  }
  event AppealResolved is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    appealId: UUID with {
      briefly "Appeal"
      described as {
        |Appeal ID.
      }
    }
    decision: String(1,1000) with {
      briefly "Decision"
      described as {
        |Appeal decision.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Appeal resolved"
    described as {
      |Emitted when appeal is resolved.
    }
  }
  event CasePlacedOnHold is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "Case placed on hold"
    described as {
      |Emitted when case is held.
    }
  }
  event CaseResumed is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    resumedBy: WorkerId with {
      briefly "By"
      described as {
        |Resuming worker.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Case resumed"
    described as {
      |Emitted when case resumes.
    }
  }
  event CaseClosed is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |Case resolution.
      }
    }
    closedBy: WorkerId with {
      briefly "By"
      described as {
        |Closing worker.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Case closed"
    described as {
      |Emitted when case is closed.
    }
  }
  event CaseReopened is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
    reopenedBy: WorkerId with {
      briefly "By"
      described as {
        |Reopening worker.
      }
    }
    reopenedAt: TimeStamp with {
      briefly "Reopened"
      described as {
        |Reopen time.
      }
    }
  } with {
    briefly "Case reopened"
    described as {
      |Emitted when case is reopened.
    }
  }
  // State Records
  record ActiveStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    caseType: CaseType with {
      briefly "Type"
      described as {
        |Case type.
      }
    }
    caseStatus: CaseStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Case priority.
      }
    }
    citizen: CitizenInfo with {
      briefly "Citizen"
      described as {
        |Primary citizen.
      }
    }
    household: HouseholdMember* with {
      briefly "Household"
      described as {
        |Household members.
      }
    }
    incomeSources: IncomeSource* with {
      briefly "Income"
      described as {
        |Income sources.
      }
    }
    documents: DocumentInfo* with {
      briefly "Documents"
      described as {
        |Supporting documents.
      }
    }
    serviceRequests: ServiceRequest* with {
      briefly "Requests"
      described as {
        |Service requests.
      }
    }
    eligibilityResults: EligibilityResult* with {
      briefly "Eligibility"
      described as {
        |Eligibility results.
      }
    }
    notes: CaseNote* with {
      briefly "Notes"
      described as {
        |Case notes.
      }
    }
    tasks: TaskInfo* with {
      briefly "Tasks"
      described as {
        |Case tasks.
      }
    }
    appeals: AppealInfo* with {
      briefly "Appeals"
      described as {
        |Filed appeals.
      }
    }
    assignedWorkerId: WorkerId? with {
      briefly "Worker"
      described as {
        |Assigned worker.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Open time.
      }
    }
    updatedClosedAt: TimeStamp? with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active case.
    }
  }
  // States
  state ActiveState of type Case.ActiveStateData
  // Handler
  handler CaseHandler is {
    on command OpenCase is {
      morph entity CaseContext.Case to state CaseContext.Case.ActiveState with command OpenCase
      tell event CaseOpened to entity CaseContext.Case
    }
    on command AssignWorker is {
      tell event WorkerAssigned to entity CaseContext.Case
    }
    on command UpdateCitizenInfo is {
      tell event CitizenInfoUpdated to entity CaseContext.Case
    }
    on command AddHouseholdMember is {
      tell event HouseholdMemberAdded to entity CaseContext.Case
    }
    on command RemoveHouseholdMember is {
      tell event HouseholdMemberRemoved to entity CaseContext.Case
    }
    on command RecordIncome is {
      tell event IncomeRecorded to entity CaseContext.Case
    }
    on command UploadDocument is {
      tell event DocumentUploaded to entity CaseContext.Case
    }
    on command SubmitServiceRequest is {
      tell event ServicesRequested to entity CaseContext.Case
    }
    on command DetermineEligibility is {
      tell event EligibilityDetermined to entity CaseContext.Case
    }
    on command AddNote is {
      tell event NoteAdded to entity CaseContext.Case
    }
    on command CreateTask is {
      tell event TaskCreated to entity CaseContext.Case
    }
    on command CompleteTask is {
      tell event TaskCompleted to entity CaseContext.Case
    }
    on command ApproveServices is {
      tell event ServicesApproved to entity CaseContext.Case
    }
    on command DenyServices is {
      tell event ServicesDenied to entity CaseContext.Case
    }
    on command FileAppeal is {
      tell event AppealFiled to entity CaseContext.Case
    }
    on command ResolveAppeal is {
      tell event AppealResolved to entity CaseContext.Case
    }
    on command PlaceOnHold is {
      tell event CasePlacedOnHold to entity CaseContext.Case
    }
    on command ResumeCase is {
      tell event CaseResumed to entity CaseContext.Case
    }
    on command CloseCase is {
      tell event CaseClosed to entity CaseContext.Case
    }
    on command ReopenCase is {
      tell event CaseReopened to entity CaseContext.Case
    }
  } with {
    briefly "Processes case commands"
    described as {
      | Handles case lifecycle from intake
      | through service delivery and closure.
    }
  }
} with {
  briefly "Case aggregate"
  described as {
    | The Case entity manages citizen service cases
    | and assistance programs.
  }
}
