// Records Management - Report Context
context ReportContext is {
  include "types.riddl"
  include "Report.riddl"
  // Repository
  repository ReportRepository is {
    query FindReportById is  {
      reportId: ReportId with {
        briefly "Report"
        described as {
          |Report identifier.
        }
      }
    } with {
      briefly "Find report by ID"
      described as {
        |Retrieves report by identifier.
      }
    }
    result ReportResult is  {
      report: Report.ActiveStateData with {
        briefly "Report"
        described as {
          |Report data.
        }
      }
    } with {
      briefly "Report result"
      described as {
        |Returns report data.
      }
    }
    query SearchReports is  {
      filterReportType: ReportType? with {
        briefly "Type"
        described as {
          |Filter by type.
        }
      }
      filterStatus: ReportStatus? with {
        briefly "Status"
        described as {
          |Filter by status.
        }
      }
      officerId: OfficerId? with {
        briefly "Officer"
        described as {
          |Filter by officer.
        }
      }
      fromDate: Date? with {
        briefly "From"
        described as {
          |Start date.
        }
      }
      toDate: Date? with {
        briefly "To"
        described as {
          |End date.
        }
      }
      filterOffense: String(1,50)? with {
        briefly "Offense"
        described as {
          |Filter by offense statute.
        }
      }
    } with {
      briefly "Search reports"
      described as {
        |Searches reports by criteria.
      }
    }
    result ReportsResult is  {
      reports: Report.ActiveStateData+ with {
        briefly "Reports"
        described as {
          |Matching reports.
        }
      }
      totalCount: Natural with {
        briefly "Count"
        described as {
          |Total matches.
        }
      }
    } with {
      briefly "Reports result"
      described as {
        |Returns matching reports.
      }
    }
    query FindByPerson is  {
      searchFirstName: String(1,100)? with {
        briefly "First"
        described as {
          |First name.
        }
      }
      lastName: String(1,100) with {
        briefly "Last"
        described as {
          |Last name.
        }
      }
      searchDateOfBirth: Date? with {
        briefly "DOB"
        described as {
          |Date of birth.
        }
      }
    } with {
      briefly "Find by person"
      described as {
        |Finds reports involving a person.
      }
    }
    query FindByAddress is  {
      street: String(1,200) with {
        briefly "Street"
        described as {
          |Street address.
        }
      }
      city: String(1,100)? with {
        briefly "City"
        described as {
          |City.
        }
      }
    } with {
      briefly "Find by address"
      described as {
        |Finds reports at a location.
      }
    }
    query FindByVehicle is  {
      searchLicensePlate: String(1,20)? with {
        briefly "Plate"
        described as {
          |License plate.
        }
      }
      vin: String(17,17)? with {
        briefly "VIN"
        described as {
          |Vehicle identification number.
        }
      }
    } with {
      briefly "Find by vehicle"
      described as {
        |Finds reports involving a vehicle.
      }
    }
    query FindPendingApproval is  {
      supervisorId: OfficerId with {
        briefly "Supervisor"
        described as {
          |Supervisor identifier.
        }
      }
    } with {
      briefly "Find pending approval"
      described as {
        |Finds reports awaiting approval.
      }
    }
    handler ReportRepositoryHandler is {
      on query FindReportById is { ??? }
      on query SearchReports is { ??? }
      on query FindByPerson is { ??? }
      on query FindByAddress is { ??? }
      on query FindByVehicle is { ??? }
      on query FindPendingApproval is { ??? }
    } with {
      briefly "Handles repository queries"
      described as {
        |Processes report queries.
      }
    }
  } with {
    briefly "Report repository"
    described as {
      |Persistence for report records.
    }
  }
  // Projector for crime statistics
  projector CrimeStatistics is {
    record StatisticsData is  {
      reportsByType: TypeCount+ with {
        briefly "By type"
        described as {
          |Reports by type.
        }
      }
      reportsByOffense: OffenseCount+ with {
        briefly "By offense"
        described as {
          |Reports by offense.
        }
      }
      reportsByBeat: BeatCount+ with {
        briefly "By beat"
        described as {
          |Reports by patrol beat.
        }
      }
      arrestCount: Natural with {
        briefly "Arrests"
        described as {
          |Total arrests.
        }
      }
      clearanceRate: Decimal(5,2) with {
        briefly "Clearance"
        described as {
          |Case clearance rate.
        }
      }
      monthlyTrend: MonthlyCount+ with {
        briefly "Monthly"
        described as {
          |Monthly incident counts.
        }
      }
    } with {
      briefly "Statistics data"
      described as {
        |Crime statistics metrics.
      }
    }
    record TypeCount is  {
      reportType: ReportType with {
        briefly "Type"
        described as {
          |Report type.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Report count.
        }
      }
    } with {
      briefly "Type count"
      described as {
        |Count by report type.
      }
    }
    record OffenseCount is  {
      statute: String(1,50) with {
        briefly "Statute"
        described as {
          |Offense statute.
        }
      }
      description: String(1,200) with {
        briefly "Description"
        described as {
          |Offense description.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Offense count.
        }
      }
    } with {
      briefly "Offense count"
      described as {
        |Count by offense.
      }
    }
    record BeatCount is  {
      beat: String(1,20) with {
        briefly "Beat"
        described as {
          |Patrol beat.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Incident count.
        }
      }
    } with {
      briefly "Beat count"
      described as {
        |Count by patrol beat.
      }
    }
    record MonthlyCount is  {
      month: Date with {
        briefly "Month"
        described as {
          |Month.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Incident count.
        }
      }
    } with {
      briefly "Monthly count"
      described as {
        |Monthly incident count.
      }
    }
    handler StatisticsHandler is {
      on event Report.ReportCreated is { ??? }
      on event Report.OffenseAdded is { ??? }
      on event Report.ArrestRecorded is { ??? }
      on event Report.ReportApproved is { ??? }
    } with {
      briefly "Processes statistics events"
      described as {
        |Updates crime statistics from events.
      }
    }
  } with {
    briefly "Crime statistics"
    described as {
      |Projects crime statistics for analysis.
    }
  }
  // Projector for evidence tracking
  projector EvidenceInventory is {
    record InventoryData is  {
      totalItems: Natural with {
        briefly "Total"
        described as {
          |Total evidence items.
        }
      }
      itemsByType: EvidenceTypeCount+ with {
        briefly "By type"
        described as {
          |Items by type.
        }
      }
      pendingDisposition: Natural with {
        briefly "Pending"
        described as {
          |Awaiting disposition.
        }
      }
      recentTransfers: CustodyTransfer+ with {
        briefly "Transfers"
        described as {
          |Recent custody transfers.
        }
      }
    } with {
      briefly "Inventory data"
      described as {
        |Evidence inventory status.
      }
    }
    record EvidenceTypeCount is  {
      evidenceType: String(1,50) with {
        briefly "Type"
        described as {
          |Evidence type.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Item count.
        }
      }
    } with {
      briefly "Evidence type count"
      described as {
        |Count by evidence type.
      }
    }
    record CustodyTransfer is  {
      evidenceId: EvidenceId with {
        briefly "Evidence"
        described as {
          |Evidence ID.
        }
      }
      reportId: ReportId with {
        briefly "Report"
        described as {
          |Associated report.
        }
      }
      transferredAt: TimeStamp with {
        briefly "Transferred"
        described as {
          |Transfer time.
        }
      }
    } with {
      briefly "Custody transfer"
      described as {
        |Recent custody transfer.
      }
    }
    handler InventoryHandler is {
      on event Report.EvidenceAdded is { ??? }
      on event Report.EvidenceCustodyUpdated is { ??? }
    } with {
      briefly "Processes inventory events"
      described as {
        |Updates evidence inventory from events.
      }
    }
  } with {
    briefly "Evidence inventory"
    described as {
      |Projects evidence tracking data.
    }
  }
} with {
  briefly "Report context"
  described as {
    | The Report context manages police reports
    | and documentation.
  }
}
