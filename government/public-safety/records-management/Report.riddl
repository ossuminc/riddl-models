// Records Management - Report Entity
entity Report is {
  // Commands
  command CreateReport is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |New report identifier.
      }
    }
    reportType: ReportType with {
      briefly "Type"
      described as {
        |Report type.
      }
    }
    incidentDate: TimeStamp with {
      briefly "Date"
      described as {
        |Incident date/time.
      }
    }
    location: Address with {
      briefly "Location"
      described as {
        |Incident location.
      }
    }
    reportingOfficer: OfficerId with {
      briefly "Officer"
      described as {
        |Reporting officer.
      }
    }
  } with {
    briefly "Create report"
    described as {
      |Creates a new incident report.
    }
  }
  command UpdateReportDetails is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    updatedIncidentDate: TimeStamp? with {
      briefly "Date"
      described as {
        |Updated incident date.
      }
    }
    updatedLocation: Address? with {
      briefly "Location"
      described as {
        |Updated location.
      }
    }
  } with {
    briefly "Update report details"
    described as {
      |Updates basic report information.
    }
  }
  command AddOffense is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    offense: OffenseCode with {
      briefly "Offense"
      described as {
        |Offense to add.
      }
    }
  } with {
    briefly "Add offense"
    described as {
      |Adds an offense to the report.
    }
  }
  command RemoveOffense is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    statute: String(1,50) with {
      briefly "Statute"
      described as {
        |Statute code to remove.
      }
    }
  } with {
    briefly "Remove offense"
    described as {
      |Removes an offense from the report.
    }
  }
  command AddInvolvedParty is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    party: InvolvedParty with {
      briefly "Party"
      described as {
        |Person to add.
      }
    }
  } with {
    briefly "Add involved party"
    described as {
      |Adds a person to the report.
    }
  }
  command UpdateInvolvedParty is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    personId: PersonId with {
      briefly "Person"
      described as {
        |Person to update.
      }
    }
    party: InvolvedParty with {
      briefly "Party"
      described as {
        |Updated information.
      }
    }
  } with {
    briefly "Update involved party"
    described as {
      |Updates a person's information.
    }
  }
  command AddVehicle is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    vehicle: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle to add.
      }
    }
    involvement: String(1,100) with {
      briefly "Involvement"
      described as {
        |How vehicle is involved.
      }
    }
  } with {
    briefly "Add vehicle"
    described as {
      |Adds a vehicle to the report.
    }
  }
  command AddProperty is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    property: PropertyItem with {
      briefly "Property"
      described as {
        |Property to add.
      }
    }
  } with {
    briefly "Add property"
    described as {
      |Adds property to the report.
    }
  }
  command AddEvidence is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    evidence: EvidenceItem with {
      briefly "Evidence"
      described as {
        |Evidence to add.
      }
    }
  } with {
    briefly "Add evidence"
    described as {
      |Adds evidence to the report.
    }
  }
  command UpdateEvidenceCustody is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    evidenceId: EvidenceId with {
      briefly "Evidence"
      described as {
        |Evidence identifier.
      }
    }
    custodyEntry: CustodyEntry with {
      briefly "Custody"
      described as {
        |New custody entry.
      }
    }
  } with {
    briefly "Update evidence custody"
    described as {
      |Records custody transfer.
    }
  }
  command RecordArrest is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    personId: PersonId with {
      briefly "Person"
      described as {
        |Arrested person.
      }
    }
    arrest: ArrestInfo with {
      briefly "Arrest"
      described as {
        |Arrest details.
      }
    }
  } with {
    briefly "Record arrest"
    described as {
      |Records an arrest.
    }
  }
  command WriteNarrative is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    narrative: ReportNarrative with {
      briefly "Narrative"
      described as {
        |Officer narrative.
      }
    }
  } with {
    briefly "Write narrative"
    described as {
      |Adds officer narrative.
    }
  }
  command SubmitForReview is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    submittedBy: OfficerId with {
      briefly "Submitted by"
      described as {
        |Submitting officer.
      }
    }
  } with {
    briefly "Submit for review"
    described as {
      |Submits report for approval.
    }
  }
  command ApproveReport is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    approval: ApprovalInfo with {
      briefly "Approval"
      described as {
        |Approval details.
      }
    }
  } with {
    briefly "Approve report"
    described as {
      |Approves the report.
    }
  }
  command RejectReport is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    rejectedBy: OfficerId with {
      briefly "Rejected by"
      described as {
        |Rejecting supervisor.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject report"
    described as {
      |Rejects the report for corrections.
    }
  }
  command LinkToCase is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case to link.
      }
    }
  } with {
    briefly "Link to case"
    described as {
      |Links report to investigation case.
    }
  }
  command SealReport is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Sealing reason.
      }
    }
    sealedBy: OfficerId with {
      briefly "Sealed by"
      described as {
        |Authorizing official.
      }
    }
    sealCourtOrder: String(1,100)? with {
      briefly "Court order"
      described as {
        |Court order number.
      }
    }
  } with {
    briefly "Seal report"
    described as {
      |Seals the report from public view.
    }
  }
  command ExpungeReport is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report identifier.
      }
    }
    courtOrder: String(1,100) with {
      briefly "Court order"
      described as {
        |Court order number.
      }
    }
    expungedBy: OfficerId with {
      briefly "Expunged by"
      described as {
        |Processing official.
      }
    }
  } with {
    briefly "Expunge report"
    described as {
      |Expunges the report per court order.
    }
  }
  // Events
  event ReportCreated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    reportType: ReportType with {
      briefly "Type"
      described as {
        |Report type.
      }
    }
    incidentDate: TimeStamp with {
      briefly "Date"
      described as {
        |Incident date.
      }
    }
    location: Address with {
      briefly "Location"
      described as {
        |Incident location.
      }
    }
    reportingOfficer: OfficerId with {
      briefly "Officer"
      described as {
        |Reporting officer.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Report created"
    described as {
      |Emitted when report is created.
    }
  }
  event ReportDetailsUpdated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Report details updated"
    described as {
      |Emitted when details are updated.
    }
  }
  event OffenseAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    offense: OffenseCode with {
      briefly "Offense"
      described as {
        |Added offense.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Offense added"
    described as {
      |Emitted when offense is added.
    }
  }
  event OffenseRemoved is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    statute: String(1,50) with {
      briefly "Statute"
      described as {
        |Removed statute.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Remove time.
      }
    }
  } with {
    briefly "Offense removed"
    described as {
      |Emitted when offense is removed.
    }
  }
  event InvolvedPartyAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    party: InvolvedParty with {
      briefly "Party"
      described as {
        |Added party.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Involved party added"
    described as {
      |Emitted when party is added.
    }
  }
  event InvolvedPartyUpdated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    personId: PersonId with {
      briefly "Person"
      described as {
        |Updated person.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Involved party updated"
    described as {
      |Emitted when party is updated.
    }
  }
  event VehicleAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    vehicle: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Added vehicle.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Vehicle added"
    described as {
      |Emitted when vehicle is added.
    }
  }
  event PropertyAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    property: PropertyItem with {
      briefly "Property"
      described as {
        |Added property.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Property added"
    described as {
      |Emitted when property is added.
    }
  }
  event EvidenceAdded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    evidence: EvidenceItem with {
      briefly "Evidence"
      described as {
        |Added evidence.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Evidence added"
    described as {
      |Emitted when evidence is added.
    }
  }
  event EvidenceCustodyUpdated is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    evidenceId: EvidenceId with {
      briefly "Evidence"
      described as {
        |Evidence ID.
      }
    }
    custodyEntry: CustodyEntry with {
      briefly "Custody"
      described as {
        |Custody entry.
      }
    }
  } with {
    briefly "Evidence custody updated"
    described as {
      |Emitted when custody changes.
    }
  }
  event ArrestRecorded is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    personId: PersonId with {
      briefly "Person"
      described as {
        |Arrested person.
      }
    }
    arrest: ArrestInfo with {
      briefly "Arrest"
      described as {
        |Arrest info.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Arrest recorded"
    described as {
      |Emitted when arrest is documented.
    }
  }
  event NarrativeWritten is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    author: OfficerId with {
      briefly "Author"
      described as {
        |Writing officer.
      }
    }
    writtenAt: TimeStamp with {
      briefly "Written"
      described as {
        |Write time.
      }
    }
  } with {
    briefly "Narrative written"
    described as {
      |Emitted when narrative is added.
    }
  }
  event ReportSubmitted is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    submittedBy: OfficerId with {
      briefly "By"
      described as {
        |Submitting officer.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Report submitted"
    described as {
      |Emitted when report is submitted.
    }
  }
  event ReportApproved is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    approval: ApprovalInfo with {
      briefly "Approval"
      described as {
        |Approval details.
      }
    }
  } with {
    briefly "Report approved"
    described as {
      |Emitted when report is approved.
    }
  }
  event ReportRejected is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    rejectedBy: OfficerId with {
      briefly "By"
      described as {
        |Rejecting supervisor.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Report rejected"
    described as {
      |Emitted when report is rejected.
    }
  }
  event ReportLinkedToCase is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Linked case.
      }
    }
    linkedAt: TimeStamp with {
      briefly "Linked"
      described as {
        |Link time.
      }
    }
  } with {
    briefly "Report linked to case"
    described as {
      |Emitted when linked to case.
    }
  }
  event ReportSealed is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Sealing reason.
      }
    }
    sealedBy: OfficerId with {
      briefly "By"
      described as {
        |Sealing official.
      }
    }
    sealedAt: TimeStamp with {
      briefly "Sealed"
      described as {
        |Seal time.
      }
    }
  } with {
    briefly "Report sealed"
    described as {
      |Emitted when report is sealed.
    }
  }
  event ReportExpunged is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    courtOrder: String(1,100) with {
      briefly "Court order"
      described as {
        |Court order.
      }
    }
    expungedBy: OfficerId with {
      briefly "By"
      described as {
        |Processing official.
      }
    }
    expungedAt: TimeStamp with {
      briefly "Expunged"
      described as {
        |Expungement time.
      }
    }
  } with {
    briefly "Report expunged"
    described as {
      |Emitted when report is expunged.
    }
  }
  // State Records
  record ActiveStateData is  {
    reportId: ReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    reportType: ReportType with {
      briefly "Type"
      described as {
        |Report type.
      }
    }
    reportStatus: ReportStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    incidentDate: TimeStamp with {
      briefly "Date"
      described as {
        |Incident date.
      }
    }
    location: Address with {
      briefly "Location"
      described as {
        |Incident location.
      }
    }
    reportingOfficer: OfficerId with {
      briefly "Officer"
      described as {
        |Reporting officer.
      }
    }
    offenses: OffenseCode* with {
      briefly "Offenses"
      described as {
        |Charged offenses.
      }
    }
    involvedParties: InvolvedParty* with {
      briefly "Parties"
      described as {
        |Involved persons.
      }
    }
    vehicles: VehicleInfo* with {
      briefly "Vehicles"
      described as {
        |Involved vehicles.
      }
    }
    propertyItems: PropertyItem* with {
      briefly "Property"
      described as {
        |Involved property.
      }
    }
    evidenceItems: EvidenceItem* with {
      briefly "Evidence"
      described as {
        |Evidence items.
      }
    }
    arrests: ArrestInfo* with {
      briefly "Arrests"
      described as {
        |Arrests made.
      }
    }
    reportNarrative: ReportNarrative? with {
      briefly "Narrative"
      described as {
        |Officer narrative.
      }
    }
    linkedCases: CaseId* with {
      briefly "Cases"
      described as {
        |Linked cases.
      }
    }
    reportApproval: ApprovalInfo? with {
      briefly "Approval"
      described as {
        |Approval record.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active report.
    }
  }
  // States
  state ActiveState of type Report.ActiveStateData
  // Handler
  handler ReportHandler is {
    on command CreateReport is {
      morph entity ReportContext.Report to state ReportContext.Report.ActiveState with command CreateReport
      tell event ReportCreated to entity ReportContext.Report
    }
    on command UpdateReportDetails is {
      tell event ReportDetailsUpdated to entity ReportContext.Report
    }
    on command AddOffense is {
      tell event OffenseAdded to entity ReportContext.Report
    }
    on command RemoveOffense is {
      tell event OffenseRemoved to entity ReportContext.Report
    }
    on command AddInvolvedParty is {
      tell event InvolvedPartyAdded to entity ReportContext.Report
    }
    on command UpdateInvolvedParty is {
      tell event InvolvedPartyUpdated to entity ReportContext.Report
    }
    on command AddVehicle is {
      tell event VehicleAdded to entity ReportContext.Report
    }
    on command AddProperty is {
      tell event PropertyAdded to entity ReportContext.Report
    }
    on command AddEvidence is {
      tell event EvidenceAdded to entity ReportContext.Report
    }
    on command UpdateEvidenceCustody is {
      tell event EvidenceCustodyUpdated to entity ReportContext.Report
    }
    on command RecordArrest is {
      tell event ArrestRecorded to entity ReportContext.Report
    }
    on command WriteNarrative is {
      tell event NarrativeWritten to entity ReportContext.Report
    }
    on command SubmitForReview is {
      tell event ReportSubmitted to entity ReportContext.Report
    }
    on command ApproveReport is {
      tell event ReportApproved to entity ReportContext.Report
    }
    on command RejectReport is {
      tell event ReportRejected to entity ReportContext.Report
    }
    on command LinkToCase is {
      tell event ReportLinkedToCase to entity ReportContext.Report
    }
    on command SealReport is {
      tell event ReportSealed to entity ReportContext.Report
    }
    on command ExpungeReport is {
      tell event ReportExpunged to entity ReportContext.Report
    }
  } with {
    briefly "Processes report commands"
    described as {
      | Handles report lifecycle from creation
      | through approval and archival.
    }
  }
} with {
  briefly "Report aggregate"
  described as {
    | The Report entity manages police reports
    | and incident documentation.
  }
}
