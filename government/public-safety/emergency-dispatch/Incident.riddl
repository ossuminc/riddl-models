// Emergency Dispatch - Incident Entity
entity Incident is {
  // Commands
  command CreateIncident is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |New incident identifier.
      }
    }
    call: CallInfo with {
      briefly "Call"
      described as {
        |Emergency call information.
      }
    }
    details: IncidentDetails with {
      briefly "Details"
      described as {
        |Incident details.
      }
    }
    createdBy: DispatcherId with {
      briefly "Created by"
      described as {
        |Creating dispatcher.
      }
    }
  } with {
    briefly "Create incident"
    described as {
      |Creates a new incident from a 911 call.
    }
  }
  command UpdateIncidentDetails is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    details: IncidentDetails with {
      briefly "Details"
      described as {
        |Updated incident details.
      }
    }
  } with {
    briefly "Update incident details"
    described as {
      |Updates incident information.
    }
  }
  command DispatchUnit is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit to dispatch.
      }
    }
    dispatchedBy: DispatcherId with {
      briefly "By"
      described as {
        |Dispatching operator.
      }
    }
  } with {
    briefly "Dispatch unit"
    described as {
      |Dispatches a unit to the incident.
    }
  }
  command RecallUnit is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit to recall.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Recall reason.
      }
    }
  } with {
    briefly "Recall unit"
    described as {
      |Recalls a dispatched unit.
    }
  }
  command MarkUnitEnRoute is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit going en route.
      }
    }
  } with {
    briefly "Mark unit en route"
    described as {
      |Records unit is en route.
    }
  }
  command MarkUnitArrived is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit arriving.
      }
    }
  } with {
    briefly "Mark unit arrived"
    described as {
      |Records unit arrived on scene.
    }
  }
  command ClearUnit is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit to clear.
      }
    }
    disposition: DispositionCode with {
      briefly "Disposition"
      described as {
        |Unit disposition.
      }
    }
  } with {
    briefly "Clear unit"
    described as {
      |Clears a unit from the incident.
    }
  }
  command AddNote is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    note: IncidentNote with {
      briefly "Note"
      described as {
        |Note to add.
      }
    }
  } with {
    briefly "Add note"
    described as {
      |Adds a CAD note to the incident.
    }
  }
  command UpgradePriority is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    newPriority: IncidentPriority with {
      briefly "Priority"
      described as {
        |New priority level.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Upgrade reason.
      }
    }
  } with {
    briefly "Upgrade priority"
    described as {
      |Increases incident priority.
    }
  }
  command DowngradePriority is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    newPriority: IncidentPriority with {
      briefly "Priority"
      described as {
        |New priority level.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Downgrade reason.
      }
    }
  } with {
    briefly "Downgrade priority"
    described as {
      |Decreases incident priority.
    }
  }
  command LinkIncidents is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Primary incident.
      }
    }
    linkedIncidentId: IncidentId with {
      briefly "Linked"
      described as {
        |Incident to link.
      }
    }
    linkType: String(1,50) with {
      briefly "Type"
      described as {
        |Link relationship type.
      }
    }
  } with {
    briefly "Link incidents"
    described as {
      |Links related incidents.
    }
  }
  command CloseIncident is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    disposition: DispositionCode with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    closedBy: DispatcherId with {
      briefly "Closed by"
      described as {
        |Closing dispatcher.
      }
    }
  } with {
    briefly "Close incident"
    described as {
      |Closes the incident.
    }
  }
  command CancelIncident is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: DispatcherId with {
      briefly "Cancelled by"
      described as {
        |Cancelling dispatcher.
      }
    }
  } with {
    briefly "Cancel incident"
    described as {
      |Cancels the incident.
    }
  }
  command ReopenIncident is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
    reopenedBy: DispatcherId with {
      briefly "Reopened by"
      described as {
        |Reopening dispatcher.
      }
    }
  } with {
    briefly "Reopen incident"
    described as {
      |Reopens a closed incident.
    }
  }
  // Events
  event IncidentCreated is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    call: CallInfo with {
      briefly "Call"
      described as {
        |Call info.
      }
    }
    details: IncidentDetails with {
      briefly "Details"
      described as {
        |Incident details.
      }
    }
    createdBy: DispatcherId with {
      briefly "By"
      described as {
        |Created by.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Incident created"
    described as {
      |Emitted when incident is created.
    }
  }
  event IncidentDetailsUpdated is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    details: IncidentDetails with {
      briefly "Details"
      described as {
        |Updated details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Incident details updated"
    described as {
      |Emitted when details are updated.
    }
  }
  event UnitDispatched is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    dispatchedBy: DispatcherId with {
      briefly "By"
      described as {
        |Dispatched by.
      }
    }
    dispatchedAt: TimeStamp with {
      briefly "Dispatched"
      described as {
        |Dispatch time.
      }
    }
  } with {
    briefly "Unit dispatched"
    described as {
      |Emitted when unit is dispatched.
    }
  }
  event UnitRecalled is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Recall reason.
      }
    }
    recalledAt: TimeStamp with {
      briefly "Recalled"
      described as {
        |Recall time.
      }
    }
  } with {
    briefly "Unit recalled"
    described as {
      |Emitted when unit is recalled.
    }
  }
  event UnitEnRoute is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    enRouteAt: TimeStamp with {
      briefly "En route"
      described as {
        |En route time.
      }
    }
  } with {
    briefly "Unit en route"
    described as {
      |Emitted when unit goes en route.
    }
  }
  event UnitArrived is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Unit arrived"
    described as {
      |Emitted when unit arrives on scene.
    }
  }
  event UnitCleared is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    disposition: DispositionCode with {
      briefly "Disposition"
      described as {
        |Unit disposition.
      }
    }
    clearedAt: TimeStamp with {
      briefly "Cleared"
      described as {
        |Clear time.
      }
    }
  } with {
    briefly "Unit cleared"
    described as {
      |Emitted when unit clears scene.
    }
  }
  event NoteAdded is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    note: IncidentNote with {
      briefly "Note"
      described as {
        |Added note.
      }
    }
  } with {
    briefly "Note added"
    described as {
      |Emitted when note is added.
    }
  }
  event PriorityUpgraded is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    oldPriority: IncidentPriority with {
      briefly "Old"
      described as {
        |Previous priority.
      }
    }
    newPriority: IncidentPriority with {
      briefly "New"
      described as {
        |New priority.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Upgrade reason.
      }
    }
    upgradedAt: TimeStamp with {
      briefly "Upgraded"
      described as {
        |Upgrade time.
      }
    }
  } with {
    briefly "Priority upgraded"
    described as {
      |Emitted when priority increases.
    }
  }
  event PriorityDowngraded is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    oldPriority: IncidentPriority with {
      briefly "Old"
      described as {
        |Previous priority.
      }
    }
    newPriority: IncidentPriority with {
      briefly "New"
      described as {
        |New priority.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Downgrade reason.
      }
    }
    downgradedAt: TimeStamp with {
      briefly "Downgraded"
      described as {
        |Downgrade time.
      }
    }
  } with {
    briefly "Priority downgraded"
    described as {
      |Emitted when priority decreases.
    }
  }
  event IncidentsLinked is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Primary incident.
      }
    }
    linkedIncidentId: IncidentId with {
      briefly "Linked"
      described as {
        |Linked incident.
      }
    }
    linkType: String(1,50) with {
      briefly "Type"
      described as {
        |Link type.
      }
    }
    linkedAt: TimeStamp with {
      briefly "Linked"
      described as {
        |Link time.
      }
    }
  } with {
    briefly "Incidents linked"
    described as {
      |Emitted when incidents are linked.
    }
  }
  event IncidentClosed is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    disposition: DispositionCode with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    closedBy: DispatcherId with {
      briefly "By"
      described as {
        |Closed by.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Incident closed"
    described as {
      |Emitted when incident is closed.
    }
  }
  event IncidentCancelled is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledBy: DispatcherId with {
      briefly "By"
      described as {
        |Cancelled by.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Incident cancelled"
    described as {
      |Emitted when incident is cancelled.
    }
  }
  event IncidentReopened is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
    reopenedBy: DispatcherId with {
      briefly "By"
      described as {
        |Reopened by.
      }
    }
    reopenedAt: TimeStamp with {
      briefly "Reopened"
      described as {
        |Reopen time.
      }
    }
  } with {
    briefly "Incident reopened"
    described as {
      |Emitted when incident is reopened.
    }
  }
  // State Records
  record ActiveStateData is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    call: CallInfo with {
      briefly "Call"
      described as {
        |Call info.
      }
    }
    details: IncidentDetails with {
      briefly "Details"
      described as {
        |Incident details.
      }
    }
    incidentStatus: IncidentStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    unitDispatchRecords: DispatchRecord* with {
      briefly "Units"
      described as {
        |Dispatched units.
      }
    }
    notes: IncidentNote* with {
      briefly "Notes"
      described as {
        |CAD notes.
      }
    }
    linkedIncidents: IncidentId* with {
      briefly "Links"
      described as {
        |Linked incidents.
      }
    }
    finalDisposition: DispositionCode? with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    createdBy: DispatcherId with {
      briefly "Created by"
      described as {
        |Creating dispatcher.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
    updatedClosedAt: TimeStamp? with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active incident.
    }
  }
  // States
  state ActiveState of type Incident.ActiveStateData
  // Handler
  handler IncidentHandler is {
    on command CreateIncident is {
      morph entity IncidentContext.Incident to state IncidentContext.Incident.ActiveState with command CreateIncident
      tell event IncidentCreated to entity IncidentContext.Incident
    }
    on command UpdateIncidentDetails is {
      tell event IncidentDetailsUpdated to entity IncidentContext.Incident
    }
    on command DispatchUnit is {
      tell event UnitDispatched to entity IncidentContext.Incident
    }
    on command RecallUnit is {
      tell event UnitRecalled to entity IncidentContext.Incident
    }
    on command MarkUnitEnRoute is {
      tell event UnitEnRoute to entity IncidentContext.Incident
    }
    on command MarkUnitArrived is {
      tell event UnitArrived to entity IncidentContext.Incident
    }
    on command ClearUnit is {
      tell event UnitCleared to entity IncidentContext.Incident
    }
    on command AddNote is {
      tell event NoteAdded to entity IncidentContext.Incident
    }
    on command UpgradePriority is {
      tell event PriorityUpgraded to entity IncidentContext.Incident
    }
    on command DowngradePriority is {
      tell event PriorityDowngraded to entity IncidentContext.Incident
    }
    on command LinkIncidents is {
      tell event IncidentsLinked to entity IncidentContext.Incident
    }
    on command CloseIncident is {
      tell event IncidentClosed to entity IncidentContext.Incident
    }
    on command CancelIncident is {
      tell event IncidentCancelled to entity IncidentContext.Incident
    }
    on command ReopenIncident is {
      tell event IncidentReopened to entity IncidentContext.Incident
    }
  } with {
    briefly "Processes incident commands"
    described as {
      | Handles incident lifecycle from creation
      | through dispatch and closure.
    }
  }
} with {
  briefly "Incident aggregate"
  described as {
    | The Incident entity manages emergency incidents
    | and first responder dispatch.
  }
}
