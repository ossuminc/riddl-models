// Emergency Dispatch - Incident Entity

entity Incident is {

  // Commands
  command CreateIncident is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "New incident identifier."
    }
    call is CallInfo with {
      briefly "Call"
      described by "Emergency call information."
    }
    details is IncidentDetails with {
      briefly "Details"
      described by "Incident details."
    }
    createdBy is DispatcherId with {
      briefly "Created by"
      described by "Creating dispatcher."
    }
  } with {
    briefly "Create incident"
    described by "Creates a new incident from a 911 call."
  }

  command UpdateIncidentDetails is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    details is IncidentDetails with {
      briefly "Details"
      described by "Updated incident details."
    }
  } with {
    briefly "Update incident details"
    described by "Updates incident information."
  }

  command DispatchUnit is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    unitId is UnitId with {
      briefly "Unit"
      described by "Unit to dispatch."
    }
    dispatchedBy is DispatcherId with {
      briefly "By"
      described by "Dispatching operator."
    }
  } with {
    briefly "Dispatch unit"
    described by "Dispatches a unit to the incident."
  }

  command RecallUnit is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    unitId is UnitId with {
      briefly "Unit"
      described by "Unit to recall."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Recall reason."
    }
  } with {
    briefly "Recall unit"
    described by "Recalls a dispatched unit."
  }

  command MarkUnitEnRoute is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    unitId is UnitId with {
      briefly "Unit"
      described by "Unit going en route."
    }
  } with {
    briefly "Mark unit en route"
    described by "Records unit is en route."
  }

  command MarkUnitArrived is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    unitId is UnitId with {
      briefly "Unit"
      described by "Unit arriving."
    }
  } with {
    briefly "Mark unit arrived"
    described by "Records unit arrived on scene."
  }

  command ClearUnit is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    unitId is UnitId with {
      briefly "Unit"
      described by "Unit to clear."
    }
    disposition is DispositionCode with {
      briefly "Disposition"
      described by "Unit disposition."
    }
  } with {
    briefly "Clear unit"
    described by "Clears a unit from the incident."
  }

  command AddNote is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    note is IncidentNote with {
      briefly "Note"
      described by "Note to add."
    }
  } with {
    briefly "Add note"
    described by "Adds a CAD note to the incident."
  }

  command UpgradePriority is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    newPriority is IncidentPriority with {
      briefly "Priority"
      described by "New priority level."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Upgrade reason."
    }
  } with {
    briefly "Upgrade priority"
    described by "Increases incident priority."
  }

  command DowngradePriority is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    newPriority is IncidentPriority with {
      briefly "Priority"
      described by "New priority level."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Downgrade reason."
    }
  } with {
    briefly "Downgrade priority"
    described by "Decreases incident priority."
  }

  command LinkIncidents is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Primary incident."
    }
    linkedIncidentId is IncidentId with {
      briefly "Linked"
      described by "Incident to link."
    }
    linkType is String(1, 50) with {
      briefly "Type"
      described by "Link relationship type."
    }
  } with {
    briefly "Link incidents"
    described by "Links related incidents."
  }

  command CloseIncident is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    disposition is DispositionCode with {
      briefly "Disposition"
      described by "Final disposition."
    }
    closedBy is DispatcherId with {
      briefly "Closed by"
      described by "Closing dispatcher."
    }
  } with {
    briefly "Close incident"
    described by "Closes the incident."
  }

  command CancelIncident is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is DispatcherId with {
      briefly "Cancelled by"
      described by "Cancelling dispatcher."
    }
  } with {
    briefly "Cancel incident"
    described by "Cancels the incident."
  }

  command ReopenIncident is {
    incidentId is IncidentId with {
      briefly "Incident"
      described by "Incident identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reopen reason."
    }
    reopenedBy is DispatcherId with {
      briefly "Reopened by"
      described by "Reopening dispatcher."
    }
  } with {
    briefly "Reopen incident"
    described by "Reopens a closed incident."
  }

  // Events
  event IncidentCreated is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    call is CallInfo with { briefly "Call" described by "Call info." }
    details is IncidentDetails with { briefly "Details" described by "Incident details." }
    createdBy is DispatcherId with { briefly "By" described by "Created by." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Incident created"
    described by "Emitted when incident is created."
  }

  event IncidentDetailsUpdated is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    details is IncidentDetails with { briefly "Details" described by "Updated details." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Incident details updated"
    described by "Emitted when details are updated."
  }

  event UnitDispatched is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    unitId is UnitId with { briefly "Unit" described by "Unit ID." }
    dispatchedBy is DispatcherId with { briefly "By" described by "Dispatched by." }
    dispatchedAt is TimeStamp with { briefly "Dispatched" described by "Dispatch time." }
  } with {
    briefly "Unit dispatched"
    described by "Emitted when unit is dispatched."
  }

  event UnitRecalled is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    unitId is UnitId with { briefly "Unit" described by "Unit ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Recall reason." }
    recalledAt is TimeStamp with { briefly "Recalled" described by "Recall time." }
  } with {
    briefly "Unit recalled"
    described by "Emitted when unit is recalled."
  }

  event UnitEnRoute is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    unitId is UnitId with { briefly "Unit" described by "Unit ID." }
    enRouteAt is TimeStamp with { briefly "En route" described by "En route time." }
  } with {
    briefly "Unit en route"
    described by "Emitted when unit goes en route."
  }

  event UnitArrived is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    unitId is UnitId with { briefly "Unit" described by "Unit ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Unit arrived"
    described by "Emitted when unit arrives on scene."
  }

  event UnitCleared is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    unitId is UnitId with { briefly "Unit" described by "Unit ID." }
    disposition is DispositionCode with { briefly "Disposition" described by "Unit disposition." }
    clearedAt is TimeStamp with { briefly "Cleared" described by "Clear time." }
  } with {
    briefly "Unit cleared"
    described by "Emitted when unit clears scene."
  }

  event NoteAdded is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    note is IncidentNote with { briefly "Note" described by "Added note." }
  } with {
    briefly "Note added"
    described by "Emitted when note is added."
  }

  event PriorityUpgraded is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    oldPriority is IncidentPriority with { briefly "Old" described by "Previous priority." }
    newPriority is IncidentPriority with { briefly "New" described by "New priority." }
    reason is String(1, 200) with { briefly "Reason" described by "Upgrade reason." }
    upgradedAt is TimeStamp with { briefly "Upgraded" described by "Upgrade time." }
  } with {
    briefly "Priority upgraded"
    described by "Emitted when priority increases."
  }

  event PriorityDowngraded is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    oldPriority is IncidentPriority with { briefly "Old" described by "Previous priority." }
    newPriority is IncidentPriority with { briefly "New" described by "New priority." }
    reason is String(1, 200) with { briefly "Reason" described by "Downgrade reason." }
    downgradedAt is TimeStamp with { briefly "Downgraded" described by "Downgrade time." }
  } with {
    briefly "Priority downgraded"
    described by "Emitted when priority decreases."
  }

  event IncidentsLinked is {
    incidentId is IncidentId with { briefly "Incident" described by "Primary incident." }
    linkedIncidentId is IncidentId with { briefly "Linked" described by "Linked incident." }
    linkType is String(1, 50) with { briefly "Type" described by "Link type." }
    linkedAt is TimeStamp with { briefly "Linked" described by "Link time." }
  } with {
    briefly "Incidents linked"
    described by "Emitted when incidents are linked."
  }

  event IncidentClosed is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    disposition is DispositionCode with { briefly "Disposition" described by "Final disposition." }
    closedBy is DispatcherId with { briefly "By" described by "Closed by." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Incident closed"
    described by "Emitted when incident is closed."
  }

  event IncidentCancelled is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledBy is DispatcherId with { briefly "By" described by "Cancelled by." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Incident cancelled"
    described by "Emitted when incident is cancelled."
  }

  event IncidentReopened is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Reopen reason." }
    reopenedBy is DispatcherId with { briefly "By" described by "Reopened by." }
    reopenedAt is TimeStamp with { briefly "Reopened" described by "Reopen time." }
  } with {
    briefly "Incident reopened"
    described by "Emitted when incident is reopened."
  }

  // State Records
  record ActiveStateData is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    call is CallInfo with { briefly "Call" described by "Call info." }
    details is IncidentDetails with { briefly "Details" described by "Incident details." }
    incidentStatus is IncidentStatus with { briefly "Status" described by "Current status." }
    unitDispatchRecords is many optional DispatchRecord with { briefly "Units" described by "Dispatched units." }
    notes is many optional IncidentNote with { briefly "Notes" described by "CAD notes." }
    linkedIncidents is many optional IncidentId with { briefly "Links" described by "Linked incidents." }
    finalDisposition is optional DispositionCode with { briefly "Disposition" described by "Final disposition." }
    createdBy is DispatcherId with { briefly "Created by" described by "Creating dispatcher." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
    updatedClosedAt is optional TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Active state"
    described by "State for active incident."
  }

  // States
  state ActiveState of Incident.ActiveStateData with {
    briefly "Incident active"
    described by "Incident record is active."
  }

  // Handler
  handler IncidentHandler is {
    on command CreateIncident {
      morph entity IncidentContext.Incident to state IncidentContext.Incident.ActiveState with command CreateIncident
      tell event IncidentCreated to entity IncidentContext.Incident
    }

    on command UpdateIncidentDetails {
      tell event IncidentDetailsUpdated to entity IncidentContext.Incident
    }

    on command DispatchUnit {
      tell event UnitDispatched to entity IncidentContext.Incident
    }

    on command RecallUnit {
      tell event UnitRecalled to entity IncidentContext.Incident
    }

    on command MarkUnitEnRoute {
      tell event UnitEnRoute to entity IncidentContext.Incident
    }

    on command MarkUnitArrived {
      tell event UnitArrived to entity IncidentContext.Incident
    }

    on command ClearUnit {
      tell event UnitCleared to entity IncidentContext.Incident
    }

    on command AddNote {
      tell event NoteAdded to entity IncidentContext.Incident
    }

    on command UpgradePriority {
      tell event PriorityUpgraded to entity IncidentContext.Incident
    }

    on command DowngradePriority {
      tell event PriorityDowngraded to entity IncidentContext.Incident
    }

    on command LinkIncidents {
      tell event IncidentsLinked to entity IncidentContext.Incident
    }

    on command CloseIncident {
      tell event IncidentClosed to entity IncidentContext.Incident
    }

    on command CancelIncident {
      tell event IncidentCancelled to entity IncidentContext.Incident
    }

    on command ReopenIncident {
      tell event IncidentReopened to entity IncidentContext.Incident
    }
  } with {
    briefly "Processes incident commands"
    described by {
      | Handles incident lifecycle from creation
      | through dispatch and closure.
    }
  }

} with {
  briefly "Incident aggregate"
  described by {
    | The Incident entity manages emergency incidents
    | and first responder dispatch.
  }
}
