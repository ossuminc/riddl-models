// Emergency Dispatch - Incident Context
context IncidentContext is {
  include "types.riddl"
  include "Incident.riddl"
  // Repository
  repository IncidentRepository is {
    query FindIncidentById is  {
      incidentId: IncidentId with {
        briefly "Incident"
        described as {
          |Incident identifier.
        }
      }
    } with {
      briefly "Find incident by ID"
      described as {
        |Retrieves incident by identifier.
      }
    }
    result IncidentResult is  {
      incident: Incident.ActiveStateData with {
        briefly "Incident"
        described as {
          |Incident data.
        }
      }
    } with {
      briefly "Incident result"
      described as {
        |Returns incident data.
      }
    }
    query SearchIncidents is  {
      filterStatus: IncidentStatus? with {
        briefly "Status"
        described as {
          |Filter by status.
        }
      }
      filterPriority: IncidentPriority? with {
        briefly "Priority"
        described as {
          |Filter by priority.
        }
      }
      filterIncidentType: IncidentType? with {
        briefly "Type"
        described as {
          |Filter by type.
        }
      }
      fromDate: Date? with {
        briefly "From"
        described as {
          |Start date filter.
        }
      }
      toDate: Date? with {
        briefly "To"
        described as {
          |End date filter.
        }
      }
    } with {
      briefly "Search incidents"
      described as {
        |Searches incidents by criteria.
      }
    }
    result IncidentsResult is  {
      matchingIncidents: Incident.ActiveStateData+ with {
        briefly "Incidents"
        described as {
          |Matching incidents.
        }
      }
      totalCount: Natural with {
        briefly "Count"
        described as {
          |Total matches.
        }
      }
    } with {
      briefly "Incidents result"
      described as {
        |Returns matching incidents.
      }
    }
    query FindActiveIncidents is  {
      activePriority: IncidentPriority? with {
        briefly "Priority"
        described as {
          |Filter by priority.
        }
      }
      zone: String(1,50)? with {
        briefly "Zone"
        described as {
          |Filter by dispatch zone.
        }
      }
    } with {
      briefly "Find active incidents"
      described as {
        |Finds all active incidents.
      }
    }
    query FindIncidentsByUnit is  {
      unitId: UnitId with {
        briefly "Unit"
        described as {
          |Unit identifier.
        }
      }
      activeOnly: Boolean with {
        briefly "Active only"
        described as {
          |Only active incidents.
        }
      }
    } with {
      briefly "Find by unit"
      described as {
        |Finds incidents for a unit.
      }
    }
    query FindIncidentsByLocation is  {
      latitude: Decimal(9,6) with {
        briefly "Latitude"
        described as {
          |Center latitude.
        }
      }
      longitude: Decimal(10,6) with {
        briefly "Longitude"
        described as {
          |Center longitude.
        }
      }
      radiusMiles: Decimal(5,2) with {
        briefly "Radius"
        described as {
          |Search radius in miles.
        }
      }
    } with {
      briefly "Find by location"
      described as {
        |Finds incidents near a location.
      }
    }
    handler IncidentRepositoryHandler is {
      on query FindIncidentById is { ??? }
      on query SearchIncidents is { ??? }
      on query FindActiveIncidents is { ??? }
      on query FindIncidentsByUnit is { ??? }
      on query FindIncidentsByLocation is { ??? }
    } with {
      briefly "Handles repository queries"
      described as {
        |Processes incident queries.
      }
    }
  } with {
    briefly "Incident repository"
    described as {
      |Persistence for incident records.
    }
  }
  // Projector for dispatch board
  projector DispatchBoard is {
    record BoardData is  {
      activeIncidents: ActiveIncidentSummary+ with {
        briefly "Active"
        described as {
          |Active incidents.
        }
      }
      pendingUnits: UnitSummary+ with {
        briefly "Pending"
        described as {
          |Units waiting dispatch.
        }
      }
      boardDispatchedUnits: UnitSummary+ with {
        briefly "Dispatched"
        described as {
          |Units on calls.
        }
      }
      availableUnits: UnitSummary+ with {
        briefly "Available"
        described as {
          |Available units.
        }
      }
    } with {
      briefly "Board data"
      described as {
        |Dispatch board display data.
      }
    }
    record ActiveIncidentSummary is  {
      incidentId: IncidentId with {
        briefly "Incident"
        described as {
          |Incident ID.
        }
      }
      summaryPriority: IncidentPriority with {
        briefly "Priority"
        described as {
          |Priority level.
        }
      }
      summaryIncidentType: IncidentType with {
        briefly "Type"
        described as {
          |Incident type.
        }
      }
      summaryLocation: String(1,200) with {
        briefly "Location"
        described as {
          |Location summary.
        }
      }
      summaryStatus: IncidentStatus with {
        briefly "Status"
        described as {
          |Current status.
        }
      }
      unitsAssigned: Natural with {
        briefly "Units"
        described as {
          |Units assigned.
        }
      }
      elapsedMinutes: Natural with {
        briefly "Elapsed"
        described as {
          |Minutes since creation.
        }
      }
    } with {
      briefly "Incident summary"
      described as {
        |Summary for dispatch board.
      }
    }
    record UnitSummary is  {
      unitId: UnitId with {
        briefly "Unit"
        described as {
          |Unit ID.
        }
      }
      unitNumber: String(1,20) with {
        briefly "Number"
        described as {
          |Unit number.
        }
      }
      summaryUnitType: UnitType with {
        briefly "Type"
        described as {
          |Unit type.
        }
      }
      summaryUnitStatus: UnitStatus with {
        briefly "Status"
        described as {
          |Current status.
        }
      }
      currentCall: IncidentId? with {
        briefly "Call"
        described as {
          |Current incident.
        }
      }
    } with {
      briefly "Unit summary"
      described as {
        |Unit status summary.
      }
    }
    handler BoardHandler is {
      on event Incident.IncidentCreated is { ??? }
      on event Incident.UnitDispatched is { ??? }
      on event Incident.UnitEnRoute is { ??? }
      on event Incident.UnitArrived is { ??? }
      on event Incident.UnitCleared is { ??? }
      on event Incident.IncidentClosed is { ??? }
      on event Incident.IncidentCancelled is { ??? }
    } with {
      briefly "Processes board events"
      described as {
        |Updates dispatch board from events.
      }
    }
  } with {
    briefly "Dispatch board"
    described as {
      |Projects real-time dispatch status.
    }
  }
  // Projector for response time analytics
  projector ResponseTimeAnalytics is {
    record AnalyticsData is  {
      averageDispatchTime: Decimal(6,2) with {
        briefly "Dispatch time"
        described as {
          |Average dispatch time (seconds).
        }
      }
      averageEnRouteTime: Decimal(6,2) with {
        briefly "En route time"
        described as {
          |Average time to go en route (seconds).
        }
      }
      averageResponseTime: Decimal(6,2) with {
        briefly "Response time"
        described as {
          |Average total response time (seconds).
        }
      }
      averageOnSceneTime: Decimal(6,2) with {
        briefly "On scene time"
        described as {
          |Average time on scene (minutes).
        }
      }
      incidentsByPriority: PriorityMetrics+ with {
        briefly "By priority"
        described as {
          |Metrics by priority level.
        }
      }
      incidentsByType: TypeMetrics+ with {
        briefly "By type"
        described as {
          |Metrics by incident type.
        }
      }
    } with {
      briefly "Analytics data"
      described as {
        |Response time metrics.
      }
    }
    record PriorityMetrics is  {
      metricPriority: IncidentPriority with {
        briefly "Priority"
        described as {
          |Priority level.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Incident count.
        }
      }
      avgResponseSeconds: Decimal(6,2) with {
        briefly "Avg response"
        described as {
          |Average response time.
        }
      }
    } with {
      briefly "Priority metrics"
      described as {
        |Metrics for priority level.
      }
    }
    record TypeMetrics is  {
      metricIncidentType: IncidentType with {
        briefly "Type"
        described as {
          |Incident type.
        }
      }
      count: Natural with {
        briefly "Count"
        described as {
          |Incident count.
        }
      }
      avgResponseSeconds: Decimal(6,2) with {
        briefly "Avg response"
        described as {
          |Average response time.
        }
      }
    } with {
      briefly "Type metrics"
      described as {
        |Metrics for incident type.
      }
    }
    handler AnalyticsHandler is {
      on event Incident.IncidentCreated is { ??? }
      on event Incident.UnitDispatched is { ??? }
      on event Incident.UnitEnRoute is { ??? }
      on event Incident.UnitArrived is { ??? }
      on event Incident.IncidentClosed is { ??? }
    } with {
      briefly "Processes analytics events"
      described as {
        |Updates response time analytics.
      }
    }
  } with {
    briefly "Response time analytics"
    described as {
      |Projects response time metrics for reporting.
    }
  }
} with {
  briefly "Incident context"
  described as {
    | The Incident context manages emergency incidents
    | and dispatch operations.
  }
}
