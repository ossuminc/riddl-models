// Precision Manufacturing - PrecisionPart Entity

entity PrecisionPart is {

  // Commands
  command CreateInspectionPlan is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    inspectionPlan is InspectionPlanInfo with {
      briefly "Plan"
      described by "Inspection plan details."
    }
  } with {
    briefly "Create inspection plan"
    described by "Creates an inspection plan for a part."
  }

  command RecordMeasurement is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    measurement is Measurement with {
      briefly "Measurement"
      described by "Measurement to record."
    }
  } with {
    briefly "Record measurement"
    described by "Records a dimensional measurement."
  }

  command EvaluateTolerance is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    featureId is FeatureId with {
      briefly "Feature"
      described by "Feature to evaluate."
    }
    evaluatedBy is String(1, 200) with {
      briefly "Evaluated by"
      described by "Person performing evaluation."
    }
  } with {
    briefly "Evaluate tolerance"
    described by "Evaluates measurement against tolerance specification."
  }

  command InitiateRework is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    rework is ReworkInfo with {
      briefly "Rework"
      described by "Rework authorization."
    }
  } with {
    briefly "Initiate rework"
    described by "Initiates rework for out-of-tolerance features."
  }

  command ScrapPart is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    scrap is ScrapInfo with {
      briefly "Scrap"
      described by "Scrap authorization."
    }
  } with {
    briefly "Scrap part"
    described by "Authorizes scrapping of non-conforming part."
  }

  command CertifyPart is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    certification is CertificationInfo with {
      briefly "Certification"
      described by "Certification details."
    }
  } with {
    briefly "Certify part"
    described by "Certifies a conforming part."
  }

  command RecordCMMResult is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    cmmResult is CMMResult with {
      briefly "CMM result"
      described by "CMM inspection result."
    }
  } with {
    briefly "Record CMM result"
    described by "Records coordinate measuring machine inspection result."
  }

  command UpdateInspectionPlan is {
    partId is PartId with {
      briefly "Part ID"
      described by "Part identifier."
    }
    inspectionPlan is InspectionPlanInfo with {
      briefly "Plan"
      described by "Updated inspection plan."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for update."
    }
  } with {
    briefly "Update inspection plan"
    described by "Updates an existing inspection plan."
  }

  // Events
  event InspectionPlanCreated is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Inspection plan." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Inspection plan created"
    described by "Emitted when inspection plan is created."
  }

  event MeasurementRecorded is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    measurement is Measurement with { briefly "Measurement" described by "Recorded measurement." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Measurement recorded"
    described by "Emitted when measurement is recorded."
  }

  event ToleranceEvaluated is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    featureId is FeatureId with { briefly "Feature" described by "Feature evaluated." }
    evaluationStatus is MeasurementStatus with { briefly "Status" described by "Evaluation status." }
    deviation is Decimal(15, 6) with { briefly "Deviation" described by "Deviation from nominal." }
    evaluatedBy is String(1, 200) with { briefly "Evaluated by" described by "Person evaluating." }
    evaluatedAt is TimeStamp with { briefly "Evaluated" described by "Evaluation time." }
  } with {
    briefly "Tolerance evaluated"
    described by "Emitted when tolerance is evaluated."
  }

  event ReworkInitiated is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    rework is ReworkInfo with { briefly "Rework" described by "Rework info." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Rework initiated"
    described by "Emitted when rework is initiated."
  }

  event PartScrapped is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    scrap is ScrapInfo with { briefly "Scrap" described by "Scrap info." }
    scrappedAt is TimeStamp with { briefly "Scrapped" described by "Scrap time." }
  } with {
    briefly "Part scrapped"
    described by "Emitted when part is scrapped."
  }

  event PartCertified is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    certification is CertificationInfo with { briefly "Certification" described by "Certification info." }
    certifiedAt is TimeStamp with { briefly "Certified" described by "Certification time." }
  } with {
    briefly "Part certified"
    described by "Emitted when part is certified."
  }

  event CMMResultRecorded is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    cmmResult is CMMResult with { briefly "CMM result" described by "CMM inspection result." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "CMM result recorded"
    described by "Emitted when CMM result is recorded."
  }

  event InspectionPlanUpdated is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Updated plan." }
    reason is String(1, 500) with { briefly "Reason" described by "Update reason." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Inspection plan updated"
    described by "Emitted when inspection plan is updated."
  }

  // State Records
  record InspectionStateData is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Inspection plan." }
    recordedMeasurements is many optional Measurement with { briefly "Measurements" described by "Recorded measurements." }
    cmmResults is many optional CMMResult with { briefly "CMM results" described by "CMM inspection results." }
    certificationStatus is CertificationStatus with { briefly "Status" described by "Certification status." }
    passedFeatures is Natural with { briefly "Passed" described by "Features in tolerance." }
    failedFeatures is Natural with { briefly "Failed" described by "Features out of tolerance." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Inspection state"
    described by "State during inspection process."
  }

  record CertifiedStateData is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Inspection plan." }
    measurements is many Measurement with { briefly "Measurements" described by "Final measurements." }
    certification is CertificationInfo with { briefly "Certification" described by "Certification details." }
    certifiedAt is TimeStamp with { briefly "Certified" described by "Certification time." }
  } with {
    briefly "Certified state"
    described by "State for certified part."
  }

  record ReworkStateData is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Inspection plan." }
    measurements is many Measurement with { briefly "Measurements" described by "Measurements before rework." }
    rework is ReworkInfo with { briefly "Rework" described by "Rework details." }
    reworkedAt is TimeStamp with { briefly "Reworked" described by "Rework time." }
  } with {
    briefly "Rework state"
    described by "State during rework process."
  }

  record ScrappedStateData is {
    partId is PartId with { briefly "Part" described by "Part ID." }
    inspectionPlan is InspectionPlanInfo with { briefly "Plan" described by "Inspection plan." }
    measurements is many Measurement with { briefly "Measurements" described by "Final measurements." }
    scrap is ScrapInfo with { briefly "Scrap" described by "Scrap details." }
    scrappedAt is TimeStamp with { briefly "Scrapped" described by "Scrap time." }
  } with {
    briefly "Scrapped state"
    described by "State for scrapped part."
  }

  // States
  state InspectionState of PrecisionPart.InspectionStateData with {
    briefly "Part in inspection"
    described by "Part is undergoing dimensional inspection."
  }

  state CertifiedState of PrecisionPart.CertifiedStateData with {
    briefly "Part certified"
    described by "Part has been certified as conforming."
  }

  state ReworkState of PrecisionPart.ReworkStateData with {
    briefly "Part in rework"
    described by "Part is undergoing rework operations."
  }

  state ScrappedState of PrecisionPart.ScrappedStateData with {
    briefly "Part scrapped"
    described by "Part has been scrapped as non-conforming."
  }

  // Handler
  handler PrecisionPartHandler is {
    on command CreateInspectionPlan {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.InspectionState with command CreateInspectionPlan
      tell event InspectionPlanCreated to entity PrecisionContext.PrecisionPart
    }

    on command RecordMeasurement {
      tell event MeasurementRecorded to entity PrecisionContext.PrecisionPart
    }

    on command EvaluateTolerance {
      tell event ToleranceEvaluated to entity PrecisionContext.PrecisionPart
    }

    on command RecordCMMResult {
      tell event CMMResultRecorded to entity PrecisionContext.PrecisionPart
    }

    on command UpdateInspectionPlan {
      tell event InspectionPlanUpdated to entity PrecisionContext.PrecisionPart
    }

    on command InitiateRework {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.ReworkState with command InitiateRework
      tell event ReworkInitiated to entity PrecisionContext.PrecisionPart
    }

    on command ScrapPart {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.ScrappedState with command ScrapPart
      tell event PartScrapped to entity PrecisionContext.PrecisionPart
    }

    on command CertifyPart {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.CertifiedState with command CertifyPart
      tell event PartCertified to entity PrecisionContext.PrecisionPart
    }
  } with {
    briefly "Processes precision part commands"
    described by {
      | Handles precision part lifecycle from inspection
      | through measurement, evaluation, and certification.
    }
  }

} with {
  briefly "PrecisionPart aggregate"
  described by {
    | The PrecisionPart entity manages dimensional inspection,
    | tolerance evaluation, and certification of precision parts.
  }
}
