// Precision Manufacturing - PrecisionPart Entity
entity PrecisionPart is {
  // Commands
  command CreateInspectionPlan is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan details.
      }
    }
  } with {
    briefly "Create inspection plan"
    described as {
      |Creates an inspection plan for a part.
    }
  }
  command RecordMeasurement is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    measurement: Measurement with {
      briefly "Measurement"
      described as {
        |Measurement to record.
      }
    }
  } with {
    briefly "Record measurement"
    described as {
      |Records a dimensional measurement.
    }
  }
  command EvaluateTolerance is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    featureId: FeatureId with {
      briefly "Feature"
      described as {
        |Feature to evaluate.
      }
    }
    evaluatedBy: String(1,200) with {
      briefly "Evaluated by"
      described as {
        |Person performing evaluation.
      }
    }
  } with {
    briefly "Evaluate tolerance"
    described as {
      |Evaluates measurement against tolerance specification.
    }
  }
  command InitiateRework is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    rework: ReworkInfo with {
      briefly "Rework"
      described as {
        |Rework authorization.
      }
    }
  } with {
    briefly "Initiate rework"
    described as {
      |Initiates rework for out-of-tolerance features.
    }
  }
  command ScrapPart is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    scrap: ScrapInfo with {
      briefly "Scrap"
      described as {
        |Scrap authorization.
      }
    }
  } with {
    briefly "Scrap part"
    described as {
      |Authorizes scrapping of non-conforming part.
    }
  }
  command CertifyPart is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    certification: CertificationInfo with {
      briefly "Certification"
      described as {
        |Certification details.
      }
    }
  } with {
    briefly "Certify part"
    described as {
      |Certifies a conforming part.
    }
  }
  command RecordCMMResult is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    cmmResult: CMMResult with {
      briefly "CMM result"
      described as {
        |CMM inspection result.
      }
    }
  } with {
    briefly "Record CMM result"
    described as {
      |Records coordinate measuring machine inspection result.
    }
  }
  command UpdateInspectionPlan is  {
    partId: PartId with {
      briefly "Part ID"
      described as {
        |Part identifier.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Updated inspection plan.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for update.
      }
    }
  } with {
    briefly "Update inspection plan"
    described as {
      |Updates an existing inspection plan.
    }
  }
  // Events
  event InspectionPlanCreated is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Inspection plan created"
    described as {
      |Emitted when inspection plan is created.
    }
  }
  event MeasurementRecorded is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    measurement: Measurement with {
      briefly "Measurement"
      described as {
        |Recorded measurement.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Measurement recorded"
    described as {
      |Emitted when measurement is recorded.
    }
  }
  event ToleranceEvaluated is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    featureId: FeatureId with {
      briefly "Feature"
      described as {
        |Feature evaluated.
      }
    }
    evaluationStatus: MeasurementStatus with {
      briefly "Status"
      described as {
        |Evaluation status.
      }
    }
    deviation: Decimal(15,6) with {
      briefly "Deviation"
      described as {
        |Deviation from nominal.
      }
    }
    evaluatedBy: String(1,200) with {
      briefly "Evaluated by"
      described as {
        |Person evaluating.
      }
    }
    evaluatedAt: TimeStamp with {
      briefly "Evaluated"
      described as {
        |Evaluation time.
      }
    }
  } with {
    briefly "Tolerance evaluated"
    described as {
      |Emitted when tolerance is evaluated.
    }
  }
  event ReworkInitiated is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    rework: ReworkInfo with {
      briefly "Rework"
      described as {
        |Rework info.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Rework initiated"
    described as {
      |Emitted when rework is initiated.
    }
  }
  event PartScrapped is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    scrap: ScrapInfo with {
      briefly "Scrap"
      described as {
        |Scrap info.
      }
    }
    scrappedAt: TimeStamp with {
      briefly "Scrapped"
      described as {
        |Scrap time.
      }
    }
  } with {
    briefly "Part scrapped"
    described as {
      |Emitted when part is scrapped.
    }
  }
  event PartCertified is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    certification: CertificationInfo with {
      briefly "Certification"
      described as {
        |Certification info.
      }
    }
    certifiedAt: TimeStamp with {
      briefly "Certified"
      described as {
        |Certification time.
      }
    }
  } with {
    briefly "Part certified"
    described as {
      |Emitted when part is certified.
    }
  }
  event CMMResultRecorded is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    cmmResult: CMMResult with {
      briefly "CMM result"
      described as {
        |CMM inspection result.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "CMM result recorded"
    described as {
      |Emitted when CMM result is recorded.
    }
  }
  event InspectionPlanUpdated is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Updated plan.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Update reason.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Inspection plan updated"
    described as {
      |Emitted when inspection plan is updated.
    }
  }
  // State Records
  record InspectionStateData is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    recordedMeasurements: Measurement* with {
      briefly "Measurements"
      described as {
        |Recorded measurements.
      }
    }
    cmmResults: CMMResult* with {
      briefly "CMM results"
      described as {
        |CMM inspection results.
      }
    }
    certificationStatus: CertificationStatus with {
      briefly "Status"
      described as {
        |Certification status.
      }
    }
    passedFeatures: Natural with {
      briefly "Passed"
      described as {
        |Features in tolerance.
      }
    }
    failedFeatures: Natural with {
      briefly "Failed"
      described as {
        |Features out of tolerance.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Inspection state"
    described as {
      |State during inspection process.
    }
  }
  record CertifiedStateData is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    measurements: Measurement+ with {
      briefly "Measurements"
      described as {
        |Final measurements.
      }
    }
    certification: CertificationInfo with {
      briefly "Certification"
      described as {
        |Certification details.
      }
    }
    certifiedAt: TimeStamp with {
      briefly "Certified"
      described as {
        |Certification time.
      }
    }
  } with {
    briefly "Certified state"
    described as {
      |State for certified part.
    }
  }
  record ReworkStateData is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    measurements: Measurement+ with {
      briefly "Measurements"
      described as {
        |Measurements before rework.
      }
    }
    rework: ReworkInfo with {
      briefly "Rework"
      described as {
        |Rework details.
      }
    }
    reworkedAt: TimeStamp with {
      briefly "Reworked"
      described as {
        |Rework time.
      }
    }
  } with {
    briefly "Rework state"
    described as {
      |State during rework process.
    }
  }
  record ScrappedStateData is  {
    partId: PartId with {
      briefly "Part"
      described as {
        |Part ID.
      }
    }
    inspectionPlan: InspectionPlanInfo with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    measurements: Measurement+ with {
      briefly "Measurements"
      described as {
        |Final measurements.
      }
    }
    scrap: ScrapInfo with {
      briefly "Scrap"
      described as {
        |Scrap details.
      }
    }
    scrappedAt: TimeStamp with {
      briefly "Scrapped"
      described as {
        |Scrap time.
      }
    }
  } with {
    briefly "Scrapped state"
    described as {
      |State for scrapped part.
    }
  }
  // States
  state InspectionState of type PrecisionPart.InspectionStateData
  state CertifiedState of type PrecisionPart.CertifiedStateData
  state ReworkState of type PrecisionPart.ReworkStateData
  state ScrappedState of type PrecisionPart.ScrappedStateData
  // Handler
  handler PrecisionPartHandler is {
    on command CreateInspectionPlan is {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.InspectionState with command CreateInspectionPlan
      tell event InspectionPlanCreated to entity PrecisionContext.PrecisionPart
    }
    on command RecordMeasurement is {
      tell event MeasurementRecorded to entity PrecisionContext.PrecisionPart
    }
    on command EvaluateTolerance is {
      tell event ToleranceEvaluated to entity PrecisionContext.PrecisionPart
    }
    on command RecordCMMResult is {
      tell event CMMResultRecorded to entity PrecisionContext.PrecisionPart
    }
    on command UpdateInspectionPlan is {
      tell event InspectionPlanUpdated to entity PrecisionContext.PrecisionPart
    }
    on command InitiateRework is {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.ReworkState with command InitiateRework
      tell event ReworkInitiated to entity PrecisionContext.PrecisionPart
    }
    on command ScrapPart is {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.ScrappedState with command ScrapPart
      tell event PartScrapped to entity PrecisionContext.PrecisionPart
    }
    on command CertifyPart is {
      morph entity PrecisionContext.PrecisionPart to state PrecisionContext.PrecisionPart.CertifiedState with command CertifyPart
      tell event PartCertified to entity PrecisionContext.PrecisionPart
    }
  } with {
    briefly "Processes precision part commands"
    described as {
      | Handles precision part lifecycle from inspection
      | through measurement, evaluation, and certification.
    }
  }
} with {
  briefly "PrecisionPart aggregate"
  described as {
    | The PrecisionPart entity manages dimensional inspection,
    | tolerance evaluation, and certification of precision parts.
  }
}
