// Precision Manufacturing - Precision Context

context PrecisionContext is {

  include "types.riddl"
  include "PrecisionPart.riddl"

  // Repository for measurement and certification persistence
  repository MeasurementRepository is {
    schema MeasurementData is relational
      of measurements as PrecisionPart
      index on field PrecisionPart.partId
      index on field PrecisionPart.status
      index on field PrecisionPart.certification.certificationNumber

    handler MeasurementPersistence is {
      on command PrecisionPart.CreateInspectionPlan {
        prompt "Store new inspection plan"
      }
      on command PrecisionPart.RecordMeasurement {
        prompt "Store measurement record"
      }
      on command PrecisionPart.EvaluateTolerance {
        prompt "Update tolerance evaluation"
      }
      on command PrecisionPart.RecordCMMResult {
        prompt "Store CMM inspection result"
      }
      on command PrecisionPart.UpdateInspectionPlan {
        prompt "Update inspection plan"
      }
      on command PrecisionPart.InitiateRework {
        prompt "Update to rework status"
      }
      on command PrecisionPart.ScrapPart {
        prompt "Update to scrapped status"
      }
      on command PrecisionPart.CertifyPart {
        prompt "Store certification record"
      }
    } with {
      briefly "Persists measurement commands"
      described by "Handles command-driven persistence for measurements."
    }
  } with {
    briefly "Measurement data persistence"
    described by {
      | The MeasurementRepository provides persistent storage for
      | measurements, CMM results, and certification records.
    }
  }

  // Projector for SPC and process capability analytics
  projector SPCAnalytics is {
    updates repository MeasurementRepository

    record SPCChartData is {
      featureId is FeatureId with { briefly "Feature" described by "Feature being tracked." }
      chartType is String(1, 50) with { briefly "Chart type" described by "SPC chart type (X-bar, R, etc.)." }
      ucl is Decimal(15, 6) with { briefly "UCL" described by "Upper control limit." }
      lcl is Decimal(15, 6) with { briefly "LCL" described by "Lower control limit." }
      centerLine is Decimal(15, 6) with { briefly "Center" described by "Center line." }
      dataPoints is many Decimal(15, 6) with { briefly "Points" described by "Data points." }
      isInControl is Boolean with { briefly "In control" described by "Whether process is in control." }
      outOfControlPoints is Natural with { briefly "OOC points" described by "Count of out-of-control points." }
    } with {
      briefly "SPC chart data"
      described by "Statistical process control chart."
    }

    record CapabilityTrend is {
      featureId is FeatureId with { briefly "Feature" described by "Feature being tracked." }
      cpkHistory is many Decimal(6, 4) with { briefly "Cpk history" described by "Historical Cpk values." }
      ppkHistory is many Decimal(6, 4) with { briefly "Ppk history" described by "Historical Ppk values." }
      timestamps is many TimeStamp with { briefly "Timestamps" described by "Calculation timestamps." }
      trend is String(1, 20) with { briefly "Trend" described by "Trend direction (improving, stable, degrading)." }
      lastCalculated is TimeStamp with { briefly "Last calculated" described by "Last calculation time." }
    } with {
      briefly "Capability trend"
      described by "Process capability trend data."
    }

    record ToleranceSummary is {
      totalFeatures is Natural with { briefly "Total" described by "Total features inspected." }
      inTolerance is Natural with { briefly "In tolerance" described by "Features in tolerance." }
      outOfTolerance is Natural with { briefly "Out of tolerance" described by "Features out of tolerance." }
      firstPassYield is Decimal(5, 4) with { briefly "FPY" described by "First pass yield." }
      reworkRate is Decimal(5, 4) with { briefly "Rework rate" described by "Rework percentage." }
      scrapRate is Decimal(5, 4) with { briefly "Scrap rate" described by "Scrap percentage." }
      periodStart is Date with { briefly "Period start" described by "Analysis period start." }
      periodEnd is Date with { briefly "Period end" described by "Analysis period end." }
    } with {
      briefly "Tolerance summary"
      described by "Summary of tolerance performance."
    }

    handler SPCHandler is {
      on event PrecisionPart.MeasurementRecorded {
        prompt "Update SPC chart data points"
      }
      on event PrecisionPart.ToleranceEvaluated {
        prompt "Recalculate control limits and capability"
      }
      on event PrecisionPart.CMMResultRecorded {
        prompt "Batch update SPC from CMM data"
      }
      on event PrecisionPart.PartCertified {
        prompt "Update yield and certification metrics"
      }
      on event PrecisionPart.ReworkInitiated {
        prompt "Update rework rate metrics"
      }
      on event PrecisionPart.PartScrapped {
        prompt "Update scrap rate metrics"
      }
    } with {
      briefly "Maintains SPC analytics"
      described by "Projects events into SPC charts and capability metrics."
    }
  } with {
    briefly "SPC and capability analytics"
    described by {
      | Maintains statistical process control charts, Cpk/Ppk
      | calculations, and tolerance trend analysis.
    }
  }

  // Projector for gage tracking and calibration
  projector GageTracking is {
    updates repository MeasurementRepository

    record GageUsageStats is {
      gageId is GageId with { briefly "Gage" described by "Gage identifier." }
      measurementCount is Natural with { briefly "Count" described by "Total measurements taken." }
      lastUsed is TimeStamp with { briefly "Last used" described by "Last usage time." }
      daysUntilCalibration is Integer with { briefly "Days" described by "Days until calibration due." }
      needsCalibration is Boolean with { briefly "Needs cal" described by "Whether calibration is due soon." }
    } with {
      briefly "Gage usage statistics"
      described by "Tracking of gage usage and calibration status."
    }

    handler GageTrackingHandler is {
      on event PrecisionPart.MeasurementRecorded {
        prompt "Update gage usage count and last used"
      }
      on event PrecisionPart.CMMResultRecorded {
        prompt "Update CMM usage statistics"
      }
    } with {
      briefly "Tracks gage usage"
      described by "Projects measurement events into gage usage statistics."
    }
  } with {
    briefly "Gage tracking projections"
    described by "Tracks gage usage and calibration status."
  }

} with {
  briefly "Bounded context for precision manufacturing"
  described by {
    | The PrecisionContext is the bounded context for
    | precision measurement, SPC analysis, and certification.
  }
}
