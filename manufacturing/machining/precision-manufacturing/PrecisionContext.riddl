// Precision Manufacturing - Precision Context
context PrecisionContext is {
  include "types.riddl"
  include "PrecisionPart.riddl"
  // Repository for measurement and certification persistence
  repository MeasurementRepository is {
    schema MeasurementData is relational
      of measurements as type PrecisionPart
        index on field PrecisionPart.partId
        index on field PrecisionPart.status
        index on field PrecisionPart.certification.certificationNumber

    handler MeasurementPersistence is {
      on command PrecisionPart.CreateInspectionPlan is {
        prompt "Store new inspection plan"
      }
      on command PrecisionPart.RecordMeasurement is {
        prompt "Store measurement record"
      }
      on command PrecisionPart.EvaluateTolerance is {
        prompt "Update tolerance evaluation"
      }
      on command PrecisionPart.RecordCMMResult is {
        prompt "Store CMM inspection result"
      }
      on command PrecisionPart.UpdateInspectionPlan is {
        prompt "Update inspection plan"
      }
      on command PrecisionPart.InitiateRework is {
        prompt "Update to rework status"
      }
      on command PrecisionPart.ScrapPart is {
        prompt "Update to scrapped status"
      }
      on command PrecisionPart.CertifyPart is {
        prompt "Store certification record"
      }
    } with {
      briefly "Persists measurement commands"
      described as {
        |Handles command-driven persistence for measurements.
      }
    }
  } with {
    briefly "Measurement data persistence"
    described as {
      | The MeasurementRepository provides persistent storage for
      | measurements, CMM results, and certification records.
    }
  }
  // Projector for SPC and process capability analytics
  projector SPCAnalytics is {
    record SPCChartData is  {
      featureId: FeatureId with {
        briefly "Feature"
        described as {
          |Feature being tracked.
        }
      }
      chartType: String(1,50) with {
        briefly "Chart type"
        described as {
          |SPC chart type (X-bar, R, etc.).
        }
      }
      ucl: Decimal(15,6) with {
        briefly "UCL"
        described as {
          |Upper control limit.
        }
      }
      lcl: Decimal(15,6) with {
        briefly "LCL"
        described as {
          |Lower control limit.
        }
      }
      centerLine: Decimal(15,6) with {
        briefly "Center"
        described as {
          |Center line.
        }
      }
      dataPoints: Decimal(15,6)+ with {
        briefly "Points"
        described as {
          |Data points.
        }
      }
      isInControl: Boolean with {
        briefly "In control"
        described as {
          |Whether process is in control.
        }
      }
      outOfControlPoints: Natural with {
        briefly "OOC points"
        described as {
          |Count of out-of-control points.
        }
      }
    } with {
      briefly "SPC chart data"
      described as {
        |Statistical process control chart.
      }
    }
    record CapabilityTrend is  {
      featureId: FeatureId with {
        briefly "Feature"
        described as {
          |Feature being tracked.
        }
      }
      cpkHistory: Decimal(6,4)+ with {
        briefly "Cpk history"
        described as {
          |Historical Cpk values.
        }
      }
      ppkHistory: Decimal(6,4)+ with {
        briefly "Ppk history"
        described as {
          |Historical Ppk values.
        }
      }
      timestamps: TimeStamp+ with {
        briefly "Timestamps"
        described as {
          |Calculation timestamps.
        }
      }
      trend: String(1,20) with {
        briefly "Trend"
        described as {
          |Trend direction (improving, stable, degrading).
        }
      }
      lastCalculated: TimeStamp with {
        briefly "Last calculated"
        described as {
          |Last calculation time.
        }
      }
    } with {
      briefly "Capability trend"
      described as {
        |Process capability trend data.
      }
    }
    record ToleranceSummary is  {
      totalFeatures: Natural with {
        briefly "Total"
        described as {
          |Total features inspected.
        }
      }
      inTolerance: Natural with {
        briefly "In tolerance"
        described as {
          |Features in tolerance.
        }
      }
      outOfTolerance: Natural with {
        briefly "Out of tolerance"
        described as {
          |Features out of tolerance.
        }
      }
      firstPassYield: Decimal(5,4) with {
        briefly "FPY"
        described as {
          |First pass yield.
        }
      }
      reworkRate: Decimal(5,4) with {
        briefly "Rework rate"
        described as {
          |Rework percentage.
        }
      }
      scrapRate: Decimal(5,4) with {
        briefly "Scrap rate"
        described as {
          |Scrap percentage.
        }
      }
      periodStart: Date with {
        briefly "Period start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: Date with {
        briefly "Period end"
        described as {
          |Analysis period end.
        }
      }
    } with {
      briefly "Tolerance summary"
      described as {
        |Summary of tolerance performance.
      }
    }
    handler SPCHandler is {
      on event PrecisionPart.MeasurementRecorded is {
        prompt "Update SPC chart data points"
      }
      on event PrecisionPart.ToleranceEvaluated is {
        prompt "Recalculate control limits and capability"
      }
      on event PrecisionPart.CMMResultRecorded is {
        prompt "Batch update SPC from CMM data"
      }
      on event PrecisionPart.PartCertified is {
        prompt "Update yield and certification metrics"
      }
      on event PrecisionPart.ReworkInitiated is {
        prompt "Update rework rate metrics"
      }
      on event PrecisionPart.PartScrapped is {
        prompt "Update scrap rate metrics"
      }
    } with {
      briefly "Maintains SPC analytics"
      described as {
        |Projects events into SPC charts and capability metrics.
      }
    }
  } with {
    briefly "SPC and capability analytics"
    described as {
      | Maintains statistical process control charts, Cpk/Ppk
      | calculations, and tolerance trend analysis.
    }
  }
  // Projector for gage tracking and calibration
  projector GageTracking is {
    record GageUsageStats is  {
      gageId: GageId with {
        briefly "Gage"
        described as {
          |Gage identifier.
        }
      }
      measurementCount: Natural with {
        briefly "Count"
        described as {
          |Total measurements taken.
        }
      }
      lastUsed: TimeStamp with {
        briefly "Last used"
        described as {
          |Last usage time.
        }
      }
      daysUntilCalibration: Integer with {
        briefly "Days"
        described as {
          |Days until calibration due.
        }
      }
      needsCalibration: Boolean with {
        briefly "Needs cal"
        described as {
          |Whether calibration is due soon.
        }
      }
    } with {
      briefly "Gage usage statistics"
      described as {
        |Tracking of gage usage and calibration status.
      }
    }
    handler GageTrackingHandler is {
      on event PrecisionPart.MeasurementRecorded is {
        prompt "Update gage usage count and last used"
      }
      on event PrecisionPart.CMMResultRecorded is {
        prompt "Update CMM usage statistics"
      }
    } with {
      briefly "Tracks gage usage"
      described as {
        |Projects measurement events into gage usage statistics.
      }
    }
  } with {
    briefly "Gage tracking projections"
    described as {
      |Tracks gage usage and calibration status.
    }
  }
} with {
  briefly "Bounded context for precision manufacturing"
  described as {
    | The PrecisionContext is the bounded context for
    | precision measurement, SPC analysis, and certification.
  }
}
