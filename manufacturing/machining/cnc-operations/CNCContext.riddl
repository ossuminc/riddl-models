// CNC Operations - CNC Context

context CNCContext is {

  include "types.riddl"
  include "CNCMachine.riddl"

  // Repository for CNC data persistence
  repository CNCRepository is {
    schema CNCData is relational
      of machines as CNCMachine
      index on field CNCMachine.machineId
      index on field CNCMachine.status

    handler CNCPersistence is {
      on event CNCMachine.ProgramLoaded {
        prompt "Store loaded program"
      }
      on event CNCMachine.MachineSetup {
        prompt "Store machine setup"
      }
      on event CNCMachine.CycleStarted {
        prompt "Store cycle start"
      }
      on event CNCMachine.CyclePaused {
        prompt "Store cycle pause"
      }
      on event CNCMachine.CycleCompleted {
        prompt "Store cycle completion"
      }
      on event CNCMachine.AlarmRaised {
        prompt "Store alarm event"
      }
      on event CNCMachine.AlarmCleared {
        prompt "Store alarm resolution"
      }
      on event CNCMachine.MetricsUpdated {
        prompt "Store metrics snapshot"
      }
    } with {
      briefly "Persists CNC machine events"
      described by "Handles event-driven persistence of machine data."
    }
  } with {
    briefly "CNC data persistence"
    described by {
      | The CNCRepository provides persistent storage for
      | machine state, cycles, alarms, and metrics history.
    }
  }

  // Projector for machine utilization analytics
  projector MachineUtilization is {
    updates repository CNCRepository

    record UtilizationStats is {
      machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
      plannedRunTime is Natural with { briefly "Planned" described by "Planned run time (min)." }
      actualRunTime is Natural with { briefly "Actual" described by "Actual run time (min)." }
      idleTime is Natural with { briefly "Idle" described by "Idle time (min)." }
      setupTime is Natural with { briefly "Setup" described by "Setup time (min)." }
      downtime is Natural with { briefly "Downtime" described by "Unplanned downtime (min)." }
      utilizationPercent is Decimal(5, 2) with { briefly "Utilization" described by "Utilization percentage." }
      periodStart is TimeStamp with { briefly "Period start" described by "Analysis period start." }
      periodEnd is TimeStamp with { briefly "Period end" described by "Analysis period end." }
    } with {
      briefly "Utilization statistics"
      described by "Machine utilization metrics."
    }

    handler UtilizationHandler is {
      on event CNCMachine.CycleStarted {
        prompt "Update run time tracking"
      }
      on event CNCMachine.CycleCompleted {
        prompt "Calculate cycle utilization"
      }
      on event CNCMachine.CyclePaused {
        prompt "Track idle time"
      }
      on event CNCMachine.AlarmRaised {
        prompt "Start downtime tracking"
      }
      on event CNCMachine.AlarmCleared {
        prompt "End downtime tracking"
      }
      on event CNCMachine.MachineSetup {
        prompt "Track setup time"
      }
    } with {
      briefly "Tracks machine utilization"
      described by "Projects events into utilization metrics."
    }
  } with {
    briefly "Machine utilization projector"
    described by "Maintains machine utilization analytics and reporting."
  }

  // Projector for cycle time analytics
  projector CycleTimeAnalytics is {
    updates repository CNCRepository

    record CycleTimeStats is {
      programId is ProgramId with { briefly "Program" described by "Program identifier." }
      machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
      estimatedCycleTime is Natural with { briefly "Estimated" described by "Estimated cycle time (sec)." }
      averageActualTime is Natural with { briefly "Average" described by "Average actual time (sec)." }
      minCycleTime is Natural with { briefly "Min" described by "Minimum cycle time (sec)." }
      maxCycleTime is Natural with { briefly "Max" described by "Maximum cycle time (sec)." }
      standardDeviation is Decimal(10, 2) with { briefly "Std Dev" described by "Standard deviation (sec)." }
      cycleCount is Natural with { briefly "Count" described by "Number of cycles analyzed." }
      performanceIndex is Decimal(5, 4) with { briefly "Performance" described by "Performance vs estimated." }
    } with {
      briefly "Cycle time statistics"
      described by "Cycle time performance metrics."
    }

    handler CycleTimeHandler is {
      on event CNCMachine.CycleCompleted {
        prompt "Update cycle time statistics"
      }
      on event CNCMachine.ProgramLoaded {
        prompt "Initialize program cycle tracking"
      }
    } with {
      briefly "Tracks cycle times"
      described by "Projects events into cycle time analytics."
    }
  } with {
    briefly "Cycle time analytics projector"
    described by "Maintains cycle time performance analysis."
  }

  // Projector for OEE metrics
  projector OEEAnalytics is {
    updates repository CNCRepository

    record OEEStats is {
      machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
      shiftDate is Date with { briefly "Date" described by "Shift date." }
      shift is Natural with { briefly "Shift" described by "Shift number." }
      availability is Decimal(5, 4) with { briefly "Availability" described by "Availability (0-1)." }
      performance is Decimal(5, 4) with { briefly "Performance" described by "Performance (0-1)." }
      quality is Decimal(5, 4) with { briefly "Quality" described by "Quality (0-1)." }
      oee is Decimal(5, 4) with { briefly "OEE" described by "Overall equipment effectiveness." }
      plannedProductionTime is Natural with { briefly "Planned time" described by "Planned time (min)." }
      actualProductionTime is Natural with { briefly "Actual time" described by "Actual time (min)." }
      totalParts is Natural with { briefly "Total parts" described by "Total parts produced." }
      goodParts is Natural with { briefly "Good parts" described by "Good parts produced." }
      scrapParts is Natural with { briefly "Scrap" described by "Scrapped parts." }
    } with {
      briefly "OEE statistics"
      described by "Overall equipment effectiveness metrics."
    }

    handler OEEHandler is {
      on event CNCMachine.CycleStarted {
        prompt "Track availability - production started"
      }
      on event CNCMachine.CycleCompleted {
        prompt "Update performance and quality metrics"
      }
      on event CNCMachine.AlarmRaised {
        prompt "Track unplanned downtime for availability"
      }
      on event CNCMachine.AlarmCleared {
        prompt "End downtime period"
      }
      on event CNCMachine.MachineSetup {
        prompt "Track setup as planned downtime"
      }
    } with {
      briefly "Calculates OEE metrics"
      described by "Projects events into OEE analytics."
    }
  } with {
    briefly "OEE analytics projector"
    described by {
      | Maintains overall equipment effectiveness metrics including
      | availability, performance, and quality calculations.
    }
  }

  // Projector for alarm history and analysis
  projector AlarmAnalytics is {
    updates repository CNCRepository

    record AlarmStats is {
      machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
      alarmCode is String(1, 20) with { briefly "Code" described by "Alarm code." }
      occurrenceCount is Natural with { briefly "Count" described by "Number of occurrences." }
      totalDowntime is Natural with { briefly "Downtime" described by "Total downtime (min)." }
      averageResolutionTime is Natural with { briefly "Avg resolution" described by "Avg resolution time (min)." }
      lastOccurrence is TimeStamp with { briefly "Last" described by "Last occurrence time." }
      mostCommonResolution is optional String(1, 500) with { briefly "Resolution" described by "Most common fix." }
    } with {
      briefly "Alarm statistics"
      described by "Alarm occurrence and resolution analytics."
    }

    handler AlarmStatsHandler is {
      on event CNCMachine.AlarmRaised {
        prompt "Increment alarm occurrence count"
      }
      on event CNCMachine.AlarmCleared {
        prompt "Update resolution time and patterns"
      }
    } with {
      briefly "Tracks alarm patterns"
      described by "Projects events into alarm analytics."
    }
  } with {
    briefly "Alarm analytics projector"
    described by "Maintains alarm history and pattern analysis."
  }

} with {
  briefly "Bounded context for CNC operations"
  described by {
    | The CNCContext is the bounded context for
    | CNC machine operations, monitoring, and analytics.
  }
}
