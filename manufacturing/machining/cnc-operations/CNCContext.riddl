// CNC Operations - CNC Context
context CNCContext is {
  include "types.riddl"
  include "CNCMachine.riddl"
  // Repository for CNC data persistence
  repository CNCRepository is {
    schema CNCData is relational
      of machines as type CNCMachine
        index on field CNCMachine.machineId
        index on field CNCMachine.status

    handler CNCPersistence is {
      on command CNCMachine.LoadProgram is {
        prompt "Store loaded program"
      }
      on command CNCMachine.SetupMachine is {
        prompt "Store machine setup"
      }
      on command CNCMachine.StartCycle is {
        prompt "Store cycle start"
      }
      on command CNCMachine.PauseCycle is {
        prompt "Store cycle pause"
      }
      on command CNCMachine.CompleteCycle is {
        prompt "Store cycle completion"
      }
      on command CNCMachine.ReportAlarm is {
        prompt "Store alarm event"
      }
      on command CNCMachine.ClearAlarm is {
        prompt "Store alarm resolution"
      }
      on command CNCMachine.UpdateMetrics is {
        prompt "Store metrics snapshot"
      }
    } with {
      briefly "Persists CNC machine events"
      described as {
        |Handles command-driven persistence of machine data.
      }
    }
  } with {
    briefly "CNC data persistence"
    described as {
      | The CNCRepository provides persistent storage for
      | machine state, cycles, alarms, and metrics history.
    }
  }
  // Projector for machine utilization analytics
  projector MachineUtilization is {
    record UtilizationStats is  {
      machineId: MachineId with {
        briefly "Machine"
        described as {
          |Machine identifier.
        }
      }
      plannedRunTime: Natural with {
        briefly "Planned"
        described as {
          |Planned run time (min).
        }
      }
      actualRunTime: Natural with {
        briefly "Actual"
        described as {
          |Actual run time (min).
        }
      }
      idleTime: Natural with {
        briefly "Idle"
        described as {
          |Idle time (min).
        }
      }
      setupTime: Natural with {
        briefly "Setup"
        described as {
          |Setup time (min).
        }
      }
      downtime: Natural with {
        briefly "Downtime"
        described as {
          |Unplanned downtime (min).
        }
      }
      utilizationPercent: Decimal(5,2) with {
        briefly "Utilization"
        described as {
          |Utilization percentage.
        }
      }
      periodStart: TimeStamp with {
        briefly "Period start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: TimeStamp with {
        briefly "Period end"
        described as {
          |Analysis period end.
        }
      }
    } with {
      briefly "Utilization statistics"
      described as {
        |Machine utilization metrics.
      }
    }
    handler UtilizationHandler is {
      on event CNCMachine.CycleStarted is {
        prompt "Update run time tracking"
      }
      on event CNCMachine.CycleCompleted is {
        prompt "Calculate cycle utilization"
      }
      on event CNCMachine.CyclePaused is {
        prompt "Track idle time"
      }
      on event CNCMachine.AlarmRaised is {
        prompt "Start downtime tracking"
      }
      on event CNCMachine.AlarmCleared is {
        prompt "End downtime tracking"
      }
      on event CNCMachine.MachineSetup is {
        prompt "Track setup time"
      }
    } with {
      briefly "Tracks machine utilization"
      described as {
        |Projects events into utilization metrics.
      }
    }
  } with {
    briefly "Machine utilization projector"
    described as {
      |Maintains machine utilization analytics and reporting.
    }
  }
  // Projector for cycle time analytics
  projector CycleTimeAnalytics is {
    record CycleTimeStats is  {
      programId: ProgramId with {
        briefly "Program"
        described as {
          |Program identifier.
        }
      }
      machineId: MachineId with {
        briefly "Machine"
        described as {
          |Machine identifier.
        }
      }
      estimatedCycleTime: Natural with {
        briefly "Estimated"
        described as {
          |Estimated cycle time (sec).
        }
      }
      averageActualTime: Natural with {
        briefly "Average"
        described as {
          |Average actual time (sec).
        }
      }
      minCycleTime: Natural with {
        briefly "Min"
        described as {
          |Minimum cycle time (sec).
        }
      }
      maxCycleTime: Natural with {
        briefly "Max"
        described as {
          |Maximum cycle time (sec).
        }
      }
      standardDeviation: Decimal(10,2) with {
        briefly "Std Dev"
        described as {
          |Standard deviation (sec).
        }
      }
      cycleCount: Natural with {
        briefly "Count"
        described as {
          |Number of cycles analyzed.
        }
      }
      performanceIndex: Decimal(5,4) with {
        briefly "Performance"
        described as {
          |Performance vs estimated.
        }
      }
    } with {
      briefly "Cycle time statistics"
      described as {
        |Cycle time performance metrics.
      }
    }
    handler CycleTimeHandler is {
      on event CNCMachine.CycleCompleted is {
        prompt "Update cycle time statistics"
      }
      on event CNCMachine.ProgramLoaded is {
        prompt "Initialize program cycle tracking"
      }
    } with {
      briefly "Tracks cycle times"
      described as {
        |Projects events into cycle time analytics.
      }
    }
  } with {
    briefly "Cycle time analytics projector"
    described as {
      |Maintains cycle time performance analysis.
    }
  }
  // Projector for OEE metrics
  projector OEEAnalytics is {
    record OEEStats is  {
      machineId: MachineId with {
        briefly "Machine"
        described as {
          |Machine identifier.
        }
      }
      shiftDate: Date with {
        briefly "Date"
        described as {
          |Shift date.
        }
      }
      shift: Natural with {
        briefly "Shift"
        described as {
          |Shift number.
        }
      }
      availability: Decimal(5,4) with {
        briefly "Availability"
        described as {
          |Availability (0-1).
        }
      }
      performance: Decimal(5,4) with {
        briefly "Performance"
        described as {
          |Performance (0-1).
        }
      }
      quality: Decimal(5,4) with {
        briefly "Quality"
        described as {
          |Quality (0-1).
        }
      }
      oee: Decimal(5,4) with {
        briefly "OEE"
        described as {
          |Overall equipment effectiveness.
        }
      }
      plannedProductionTime: Natural with {
        briefly "Planned time"
        described as {
          |Planned time (min).
        }
      }
      actualProductionTime: Natural with {
        briefly "Actual time"
        described as {
          |Actual time (min).
        }
      }
      totalParts: Natural with {
        briefly "Total parts"
        described as {
          |Total parts produced.
        }
      }
      goodParts: Natural with {
        briefly "Good parts"
        described as {
          |Good parts produced.
        }
      }
      scrapParts: Natural with {
        briefly "Scrap"
        described as {
          |Scrapped parts.
        }
      }
    } with {
      briefly "OEE statistics"
      described as {
        |Overall equipment effectiveness metrics.
      }
    }
    handler OEEHandler is {
      on event CNCMachine.CycleStarted is {
        prompt "Track availability - production started"
      }
      on event CNCMachine.CycleCompleted is {
        prompt "Update performance and quality metrics"
      }
      on event CNCMachine.AlarmRaised is {
        prompt "Track unplanned downtime for availability"
      }
      on event CNCMachine.AlarmCleared is {
        prompt "End downtime period"
      }
      on event CNCMachine.MachineSetup is {
        prompt "Track setup as planned downtime"
      }
    } with {
      briefly "Calculates OEE metrics"
      described as {
        |Projects events into OEE analytics.
      }
    }
  } with {
    briefly "OEE analytics projector"
    described as {
      | Maintains overall equipment effectiveness metrics including
      | availability, performance, and quality calculations.
    }
  }
  // Projector for alarm history and analysis
  projector AlarmAnalytics is {
    record AlarmStats is  {
      machineId: MachineId with {
        briefly "Machine"
        described as {
          |Machine identifier.
        }
      }
      alarmCode: String(1,20) with {
        briefly "Code"
        described as {
          |Alarm code.
        }
      }
      occurrenceCount: Natural with {
        briefly "Count"
        described as {
          |Number of occurrences.
        }
      }
      totalDowntime: Natural with {
        briefly "Downtime"
        described as {
          |Total downtime (min).
        }
      }
      averageResolutionTime: Natural with {
        briefly "Avg resolution"
        described as {
          |Avg resolution time (min).
        }
      }
      lastOccurrence: TimeStamp with {
        briefly "Last"
        described as {
          |Last occurrence time.
        }
      }
      mostCommonResolution: String(1,500)? with {
        briefly "Resolution"
        described as {
          |Most common fix.
        }
      }
    } with {
      briefly "Alarm statistics"
      described as {
        |Alarm occurrence and resolution analytics.
      }
    }
    handler AlarmStatsHandler is {
      on event CNCMachine.AlarmRaised is {
        prompt "Increment alarm occurrence count"
      }
      on event CNCMachine.AlarmCleared is {
        prompt "Update resolution time and patterns"
      }
    } with {
      briefly "Tracks alarm patterns"
      described as {
        |Projects events into alarm analytics.
      }
    }
  } with {
    briefly "Alarm analytics projector"
    described as {
      |Maintains alarm history and pattern analysis.
    }
  }
} with {
  briefly "Bounded context for CNC operations"
  described as {
    | The CNCContext is the bounded context for
    | CNC machine operations, monitoring, and analytics.
  }
}
