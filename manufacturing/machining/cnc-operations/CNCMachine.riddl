// CNC Operations - CNCMachine Entity
entity CNCMachine is {
  // Commands
  command LoadProgram is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    program: NCProgram with {
      briefly "Program"
      described as {
        |NC program to load.
      }
    }
    loadedBy: String(1,200) with {
      briefly "Loaded by"
      described as {
        |Person loading program.
      }
    }
  } with {
    briefly "Load NC program"
    described as {
      |Loads an NC program to the machine controller.
    }
  }
  command SetupMachine is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    tools: ToolSetup+ with {
      briefly "Tools"
      described as {
        |Tool setup information.
      }
    }
    fixtures: FixtureSetup+ with {
      briefly "Fixtures"
      described as {
        |Fixture setup information.
      }
    }
    setupBy: String(1,200) with {
      briefly "Setup by"
      described as {
        |Person performing setup.
      }
    }
  } with {
    briefly "Setup machine"
    described as {
      |Configures tooling, fixtures, and work offsets.
    }
  }
  command StartCycle is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    cycleType: CycleType with {
      briefly "Cycle type"
      described as {
        |Type of cycle to start.
      }
    }
    workOrderId: WorkOrderId? with {
      briefly "Work order"
      described as {
        |Associated work order.
      }
    }
    startedBy: String(1,200) with {
      briefly "Started by"
      described as {
        |Person starting cycle.
      }
    }
  } with {
    briefly "Start machining cycle"
    described as {
      |Begins a machining cycle on the loaded program.
    }
  }
  command PauseCycle is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for pausing.
      }
    }
    pausedBy: String(1,200) with {
      briefly "Paused by"
      described as {
        |Person pausing cycle.
      }
    }
  } with {
    briefly "Pause machining cycle"
    described as {
      |Pauses the current machining cycle safely.
    }
  }
  command CompleteCycle is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    partsProduced: Natural with {
      briefly "Parts"
      described as {
        |Number of parts produced.
      }
    }
    scrappedParts: Natural with {
      briefly "Scrap"
      described as {
        |Number of scrapped parts.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Person completing cycle.
      }
    }
  } with {
    briefly "Complete machining cycle"
    described as {
      |Finalizes the current machining cycle.
    }
  }
  command ReportAlarm is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    alarm: MachineAlarm with {
      briefly "Alarm"
      described as {
        |Alarm information.
      }
    }
  } with {
    briefly "Report machine alarm"
    described as {
      |Reports a machine alarm condition.
    }
  }
  command ClearAlarm is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    alarmId: UUID with {
      briefly "Alarm ID"
      described as {
        |Alarm to clear.
      }
    }
    clearedBy: String(1,200) with {
      briefly "Cleared by"
      described as {
        |Person clearing alarm.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |How alarm was resolved.
      }
    }
  } with {
    briefly "Clear machine alarm"
    described as {
      |Clears an alarm condition after resolution.
    }
  }
  command UpdateMetrics is  {
    machineId: MachineId with {
      briefly "Machine ID"
      described as {
        |Target machine identifier.
      }
    }
    metrics: MachineMetrics with {
      briefly "Metrics"
      described as {
        |Current machine metrics.
      }
    }
  } with {
    briefly "Update machine metrics"
    described as {
      |Updates real-time machine performance metrics.
    }
  }
  // Events
  event ProgramLoaded is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    program: NCProgram with {
      briefly "Program"
      described as {
        |Loaded program.
      }
    }
    loadedBy: String(1,200) with {
      briefly "Loaded by"
      described as {
        |Person loading.
      }
    }
    loadedAt: TimeStamp with {
      briefly "Loaded"
      described as {
        |Load time.
      }
    }
  } with {
    briefly "Program loaded"
    described as {
      |Emitted when NC program is loaded to controller.
    }
  }
  event MachineSetup is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    tools: ToolSetup+ with {
      briefly "Tools"
      described as {
        |Configured tools.
      }
    }
    fixtures: FixtureSetup+ with {
      briefly "Fixtures"
      described as {
        |Configured fixtures.
      }
    }
    setupBy: String(1,200) with {
      briefly "Setup by"
      described as {
        |Person performing setup.
      }
    }
    setupAt: TimeStamp with {
      briefly "Setup"
      described as {
        |Setup completion time.
      }
    }
  } with {
    briefly "Machine setup complete"
    described as {
      |Emitted when machine setup is complete.
    }
  }
  event CycleStarted is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    cycleId: UUID with {
      briefly "Cycle"
      described as {
        |Cycle identifier.
      }
    }
    cycleType: CycleType with {
      briefly "Type"
      described as {
        |Cycle type.
      }
    }
    programId: ProgramId with {
      briefly "Program"
      described as {
        |Program being executed.
      }
    }
    workOrderId: WorkOrderId? with {
      briefly "Work order"
      described as {
        |Work order reference.
      }
    }
    startedBy: String(1,200) with {
      briefly "Started by"
      described as {
        |Person starting.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Cycle started"
    described as {
      |Emitted when machining cycle begins.
    }
  }
  event CyclePaused is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    cycleId: UUID with {
      briefly "Cycle"
      described as {
        |Cycle identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
    pausedBy: String(1,200) with {
      briefly "Paused by"
      described as {
        |Person pausing.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Cycle paused"
    described as {
      |Emitted when machining cycle is paused.
    }
  }
  event CycleCompleted is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    cycleId: UUID with {
      briefly "Cycle"
      described as {
        |Cycle identifier.
      }
    }
    actualCycleTime: Natural with {
      briefly "Cycle time"
      described as {
        |Actual cycle time (sec).
      }
    }
    partsProduced: Natural with {
      briefly "Parts"
      described as {
        |Parts produced.
      }
    }
    scrappedParts: Natural with {
      briefly "Scrap"
      described as {
        |Scrapped parts.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Person completing.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Cycle completed"
    described as {
      |Emitted when machining cycle completes.
    }
  }
  event AlarmRaised is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    alarm: MachineAlarm with {
      briefly "Alarm"
      described as {
        |Alarm details.
      }
    }
    raisedAt: TimeStamp with {
      briefly "Raised"
      described as {
        |Alarm time.
      }
    }
  } with {
    briefly "Alarm raised"
    described as {
      |Emitted when machine alarm occurs.
    }
  }
  event AlarmCleared is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    alarmId: UUID with {
      briefly "Alarm"
      described as {
        |Cleared alarm ID.
      }
    }
    clearedBy: String(1,200) with {
      briefly "Cleared by"
      described as {
        |Person clearing.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |How resolved.
      }
    }
    clearedAt: TimeStamp with {
      briefly "Cleared"
      described as {
        |Clear time.
      }
    }
  } with {
    briefly "Alarm cleared"
    described as {
      |Emitted when alarm is cleared.
    }
  }
  event MetricsUpdated is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine ID.
      }
    }
    metrics: MachineMetrics with {
      briefly "Metrics"
      described as {
        |Updated metrics.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Metrics updated"
    described as {
      |Emitted when machine metrics are updated.
    }
  }
  // State Records
  record IdleStateData is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine identifier.
      }
    }
    status: MachineStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    loadedProgram: NCProgram? with {
      briefly "Program"
      described as {
        |Currently loaded program.
      }
    }
    idleTools: ToolSetup* with {
      briefly "Tools"
      described as {
        |Current tool setup.
      }
    }
    idleFixtures: FixtureSetup* with {
      briefly "Fixtures"
      described as {
        |Current fixtures.
      }
    }
    lastCycle: MachiningCycle? with {
      briefly "Last cycle"
      described as {
        |Most recent cycle.
      }
    }
    totalPartsProduced: Natural with {
      briefly "Total parts"
      described as {
        |Total parts produced.
      }
    }
    uptimeMinutes: Natural with {
      briefly "Uptime"
      described as {
        |Total uptime in minutes.
      }
    }
  } with {
    briefly "Idle state"
    described as {
      |State when machine is idle and ready.
    }
  }
  record RunningStateData is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine identifier.
      }
    }
    status: MachineStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    currentProgram: NCProgram with {
      briefly "Program"
      described as {
        |Executing program.
      }
    }
    currentCycle: MachiningCycle with {
      briefly "Cycle"
      described as {
        |Current cycle.
      }
    }
    currentTools: ToolSetup+ with {
      briefly "Tools"
      described as {
        |Active tool setup.
      }
    }
    currentFixtures: FixtureSetup+ with {
      briefly "Fixtures"
      described as {
        |Active fixtures.
      }
    }
    runningMetrics: MachineMetrics? with {
      briefly "Metrics"
      described as {
        |Current metrics.
      }
    }
    isPaused: Boolean with {
      briefly "Paused"
      described as {
        |Whether cycle is paused.
      }
    }
  } with {
    briefly "Running state"
    described as {
      |State when machine is executing a cycle.
    }
  }
  record SetupStateData is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine identifier.
      }
    }
    status: MachineStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    programToLoad: NCProgram? with {
      briefly "Program"
      described as {
        |Program being prepared.
      }
    }
    pendingTools: ToolSetup* with {
      briefly "Tools"
      described as {
        |Tools being set up.
      }
    }
    pendingFixtures: FixtureSetup* with {
      briefly "Fixtures"
      described as {
        |Fixtures being set up.
      }
    }
    setupStartedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Setup start time.
      }
    }
    setupBy: String(1,200) with {
      briefly "Setup by"
      described as {
        |Person doing setup.
      }
    }
  } with {
    briefly "Setup state"
    described as {
      |State when machine is being configured.
    }
  }
  record AlarmStateData is  {
    machineId: MachineId with {
      briefly "Machine"
      described as {
        |Machine identifier.
      }
    }
    status: MachineStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    activeAlarms: MachineAlarm+ with {
      briefly "Alarms"
      described as {
        |Active alarm conditions.
      }
    }
    interruptedCycle: MachiningCycle? with {
      briefly "Cycle"
      described as {
        |Interrupted cycle.
      }
    }
    priorState: MachineStatus with {
      briefly "Prior state"
      described as {
        |State before alarm.
      }
    }
  } with {
    briefly "Alarm state"
    described as {
      |State when machine has active alarms.
    }
  }
  // States
  state IdleState of type CNCMachine.IdleStateData
  state RunningState of type CNCMachine.RunningStateData
  state SetupState of type CNCMachine.SetupStateData
  state AlarmState of type CNCMachine.AlarmStateData
  // Handler
  handler CNCMachineHandler is {
    on command LoadProgram is {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.SetupState with command LoadProgram
      tell event ProgramLoaded to entity CNCContext.CNCMachine
    }
    on command SetupMachine is {
      tell event MachineSetup to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command SetupMachine
    }
    on command StartCycle is {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.RunningState with command StartCycle
      tell event CycleStarted to entity CNCContext.CNCMachine
    }
    on command PauseCycle is {
      tell event CyclePaused to entity CNCContext.CNCMachine
    }
    on command CompleteCycle is {
      tell event CycleCompleted to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command CompleteCycle
    }
    on command ReportAlarm is {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.AlarmState with command ReportAlarm
      tell event AlarmRaised to entity CNCContext.CNCMachine
    }
    on command ClearAlarm is {
      tell event AlarmCleared to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command ClearAlarm
    }
    on command UpdateMetrics is {
      tell event MetricsUpdated to entity CNCContext.CNCMachine
    }
  } with {
    briefly "Processes CNC machine commands"
    described as {
      | Handles machine lifecycle from setup through cycle execution,
      | alarm handling, and metrics collection.
    }
  }
} with {
  briefly "CNCMachine aggregate"
  described as {
    | The CNCMachine entity manages computer numerical control machines
    | including program loading, cycle execution, and alarm handling.
  }
}
