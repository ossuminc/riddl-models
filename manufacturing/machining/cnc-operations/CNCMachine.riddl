// CNC Operations - CNCMachine Entity

entity CNCMachine is {

  // Commands
  command LoadProgram is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    program is NCProgram with {
      briefly "Program"
      described by "NC program to load."
    }
    loadedBy is String(1, 200) with {
      briefly "Loaded by"
      described by "Person loading program."
    }
  } with {
    briefly "Load NC program"
    described by "Loads an NC program to the machine controller."
  }

  command SetupMachine is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    tools is many ToolSetup with {
      briefly "Tools"
      described by "Tool setup information."
    }
    fixtures is many FixtureSetup with {
      briefly "Fixtures"
      described by "Fixture setup information."
    }
    setupBy is String(1, 200) with {
      briefly "Setup by"
      described by "Person performing setup."
    }
  } with {
    briefly "Setup machine"
    described by "Configures tooling, fixtures, and work offsets."
  }

  command StartCycle is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    cycleType is CycleType with {
      briefly "Cycle type"
      described by "Type of cycle to start."
    }
    workOrderId is optional WorkOrderId with {
      briefly "Work order"
      described by "Associated work order."
    }
    startedBy is String(1, 200) with {
      briefly "Started by"
      described by "Person starting cycle."
    }
  } with {
    briefly "Start machining cycle"
    described by "Begins a machining cycle on the loaded program."
  }

  command PauseCycle is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for pausing."
    }
    pausedBy is String(1, 200) with {
      briefly "Paused by"
      described by "Person pausing cycle."
    }
  } with {
    briefly "Pause machining cycle"
    described by "Pauses the current machining cycle safely."
  }

  command CompleteCycle is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    partsProduced is Natural with {
      briefly "Parts"
      described by "Number of parts produced."
    }
    scrappedParts is Natural with {
      briefly "Scrap"
      described by "Number of scrapped parts."
    }
    completedBy is String(1, 200) with {
      briefly "Completed by"
      described by "Person completing cycle."
    }
  } with {
    briefly "Complete machining cycle"
    described by "Finalizes the current machining cycle."
  }

  command ReportAlarm is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    alarm is MachineAlarm with {
      briefly "Alarm"
      described by "Alarm information."
    }
  } with {
    briefly "Report machine alarm"
    described by "Reports a machine alarm condition."
  }

  command ClearAlarm is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    alarmId is UUID with {
      briefly "Alarm ID"
      described by "Alarm to clear."
    }
    clearedBy is String(1, 200) with {
      briefly "Cleared by"
      described by "Person clearing alarm."
    }
    resolution is String(1, 1000) with {
      briefly "Resolution"
      described by "How alarm was resolved."
    }
  } with {
    briefly "Clear machine alarm"
    described by "Clears an alarm condition after resolution."
  }

  command UpdateMetrics is {
    machineId is MachineId with {
      briefly "Machine ID"
      described by "Target machine identifier."
    }
    metrics is MachineMetrics with {
      briefly "Metrics"
      described by "Current machine metrics."
    }
  } with {
    briefly "Update machine metrics"
    described by "Updates real-time machine performance metrics."
  }

  // Events
  event ProgramLoaded is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    program is NCProgram with { briefly "Program" described by "Loaded program." }
    loadedBy is String(1, 200) with { briefly "Loaded by" described by "Person loading." }
    loadedAt is TimeStamp with { briefly "Loaded" described by "Load time." }
  } with {
    briefly "Program loaded"
    described by "Emitted when NC program is loaded to controller."
  }

  event MachineSetup is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    tools is many ToolSetup with { briefly "Tools" described by "Configured tools." }
    fixtures is many FixtureSetup with { briefly "Fixtures" described by "Configured fixtures." }
    setupBy is String(1, 200) with { briefly "Setup by" described by "Person performing setup." }
    setupAt is TimeStamp with { briefly "Setup" described by "Setup completion time." }
  } with {
    briefly "Machine setup complete"
    described by "Emitted when machine setup is complete."
  }

  event CycleStarted is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    cycleId is UUID with { briefly "Cycle" described by "Cycle identifier." }
    cycleType is CycleType with { briefly "Type" described by "Cycle type." }
    programId is ProgramId with { briefly "Program" described by "Program being executed." }
    workOrderId is optional WorkOrderId with { briefly "Work order" described by "Work order reference." }
    startedBy is String(1, 200) with { briefly "Started by" described by "Person starting." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Cycle started"
    described by "Emitted when machining cycle begins."
  }

  event CyclePaused is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    cycleId is UUID with { briefly "Cycle" described by "Cycle identifier." }
    reason is String(1, 500) with { briefly "Reason" described by "Pause reason." }
    pausedBy is String(1, 200) with { briefly "Paused by" described by "Person pausing." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Cycle paused"
    described by "Emitted when machining cycle is paused."
  }

  event CycleCompleted is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    cycleId is UUID with { briefly "Cycle" described by "Cycle identifier." }
    actualCycleTime is Natural with { briefly "Cycle time" described by "Actual cycle time (sec)." }
    partsProduced is Natural with { briefly "Parts" described by "Parts produced." }
    scrappedParts is Natural with { briefly "Scrap" described by "Scrapped parts." }
    completedBy is String(1, 200) with { briefly "Completed by" described by "Person completing." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Cycle completed"
    described by "Emitted when machining cycle completes."
  }

  event AlarmRaised is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    alarm is MachineAlarm with { briefly "Alarm" described by "Alarm details." }
    raisedAt is TimeStamp with { briefly "Raised" described by "Alarm time." }
  } with {
    briefly "Alarm raised"
    described by "Emitted when machine alarm occurs."
  }

  event AlarmCleared is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    alarmId is UUID with { briefly "Alarm" described by "Cleared alarm ID." }
    clearedBy is String(1, 200) with { briefly "Cleared by" described by "Person clearing." }
    resolution is String(1, 1000) with { briefly "Resolution" described by "How resolved." }
    clearedAt is TimeStamp with { briefly "Cleared" described by "Clear time." }
  } with {
    briefly "Alarm cleared"
    described by "Emitted when alarm is cleared."
  }

  event MetricsUpdated is {
    machineId is MachineId with { briefly "Machine" described by "Machine ID." }
    metrics is MachineMetrics with { briefly "Metrics" described by "Updated metrics." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Metrics updated"
    described by "Emitted when machine metrics are updated."
  }

  // State Records
  record IdleStateData is {
    machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
    status is MachineStatus with { briefly "Status" described by "Current status." }
    loadedProgram is optional NCProgram with { briefly "Program" described by "Currently loaded program." }
    currentTools is many optional ToolSetup with { briefly "Tools" described by "Current tool setup." }
    currentFixtures is many optional FixtureSetup with { briefly "Fixtures" described by "Current fixtures." }
    lastCycle is optional MachiningCycle with { briefly "Last cycle" described by "Most recent cycle." }
    totalPartsProduced is Natural with { briefly "Total parts" described by "Total parts produced." }
    uptimeMinutes is Natural with { briefly "Uptime" described by "Total uptime in minutes." }
  } with {
    briefly "Idle state"
    described by "State when machine is idle and ready."
  }

  record RunningStateData is {
    machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
    status is MachineStatus with { briefly "Status" described by "Current status." }
    currentProgram is NCProgram with { briefly "Program" described by "Executing program." }
    currentCycle is MachiningCycle with { briefly "Cycle" described by "Current cycle." }
    currentTools is many ToolSetup with { briefly "Tools" described by "Active tool setup." }
    currentFixtures is many FixtureSetup with { briefly "Fixtures" described by "Active fixtures." }
    metrics is optional MachineMetrics with { briefly "Metrics" described by "Current metrics." }
    isPaused is Boolean with { briefly "Paused" described by "Whether cycle is paused." }
  } with {
    briefly "Running state"
    described by "State when machine is executing a cycle."
  }

  record SetupStateData is {
    machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
    status is MachineStatus with { briefly "Status" described by "Current status." }
    programToLoad is optional NCProgram with { briefly "Program" described by "Program being prepared." }
    pendingTools is many optional ToolSetup with { briefly "Tools" described by "Tools being set up." }
    pendingFixtures is many optional FixtureSetup with { briefly "Fixtures" described by "Fixtures being set up." }
    setupStartedAt is TimeStamp with { briefly "Started" described by "Setup start time." }
    setupBy is String(1, 200) with { briefly "Setup by" described by "Person doing setup." }
  } with {
    briefly "Setup state"
    described by "State when machine is being configured."
  }

  record AlarmStateData is {
    machineId is MachineId with { briefly "Machine" described by "Machine identifier." }
    status is MachineStatus with { briefly "Status" described by "Current status." }
    activeAlarms is many MachineAlarm with { briefly "Alarms" described by "Active alarm conditions." }
    interruptedCycle is optional MachiningCycle with { briefly "Cycle" described by "Interrupted cycle." }
    priorState is MachineStatus with { briefly "Prior state" described by "State before alarm." }
  } with {
    briefly "Alarm state"
    described by "State when machine has active alarms."
  }

  // States
  state IdleState of CNCMachine.IdleStateData with {
    briefly "Machine idle"
    described by "Machine is idle and ready for work."
  }

  state RunningState of CNCMachine.RunningStateData with {
    briefly "Machine running"
    described by "Machine is executing a machining cycle."
  }

  state SetupState of CNCMachine.SetupStateData with {
    briefly "Machine in setup"
    described by "Machine is being set up for production."
  }

  state AlarmState of CNCMachine.AlarmStateData with {
    briefly "Machine in alarm"
    described by "Machine has active alarm conditions."
  }

  // Handler
  handler CNCMachineHandler is {
    on command LoadProgram {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.SetupState with command LoadProgram
      tell event ProgramLoaded to entity CNCContext.CNCMachine
    }

    on command SetupMachine {
      tell event MachineSetup to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command SetupMachine
    }

    on command StartCycle {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.RunningState with command StartCycle
      tell event CycleStarted to entity CNCContext.CNCMachine
    }

    on command PauseCycle {
      tell event CyclePaused to entity CNCContext.CNCMachine
    }

    on command CompleteCycle {
      tell event CycleCompleted to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command CompleteCycle
    }

    on command ReportAlarm {
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.AlarmState with command ReportAlarm
      tell event AlarmRaised to entity CNCContext.CNCMachine
    }

    on command ClearAlarm {
      tell event AlarmCleared to entity CNCContext.CNCMachine
      morph entity CNCContext.CNCMachine to state CNCContext.CNCMachine.IdleState with command ClearAlarm
    }

    on command UpdateMetrics {
      tell event MetricsUpdated to entity CNCContext.CNCMachine
    }
  } with {
    briefly "Processes CNC machine commands"
    described by {
      | Handles machine lifecycle from setup through cycle execution,
      | alarm handling, and metrics collection.
    }
  }

} with {
  briefly "CNCMachine aggregate"
  described by {
    | The CNCMachine entity manages computer numerical control machines
    | including program loading, cycle execution, and alarm handling.
  }
}
