// Equipment Maintenance - MaintenanceOrder Entity
// The primary aggregate for maintenance order lifecycle management
entity MaintenanceOrder is {
  // Commands
  command CreateMaintenanceOrder is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The unique identifier for the new maintenance order.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment reference"
      described as {
        |Reference to the equipment requiring maintenance.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment name"
      described as {
        |Human-readable name of the equipment.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type of maintenance"
      described as {
        |Classification of maintenance work (preventive, corrective, etc.).
      }
    }
    priority: MaintenancePriority with {
      briefly "Work priority"
      described as {
        |Priority level for scheduling and response.
      }
    }
    description: String(1,2000) with {
      briefly "Work description"
      described as {
        |Detailed description of maintenance work required.
      }
    }
    scheduledDate: Date with {
      briefly "Scheduled date"
      described as {
        |The planned date for maintenance execution.
      }
    }
    estimatedDuration: Duration with {
      briefly "Estimated duration"
      described as {
        |Expected time to complete the maintenance work.
      }
    }
    tasks: MaintenanceTask+ with {
      briefly "Work tasks"
      described as {
        |Individual tasks to be performed during maintenance.
      }
    }
  } with {
    briefly "Create a new maintenance order"
    described as {
      | Creates a new maintenance order for equipment service. The order
      | starts in Pending state awaiting technician assignment.
    }
  }
  command AssignTechnician is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order to assign.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician reference"
      described as {
        |Reference to the technician being assigned.
      }
    }
    technicianName: String(1,100) with {
      briefly "Technician name"
      described as {
        |Name of the assigned technician.
      }
    }
    hourlyRate: Decimal(8,2) with {
      briefly "Labor rate"
      described as {
        |Hourly labor rate for the assigned technician.
      }
    }
  } with {
    briefly "Assign a technician to the maintenance order"
    described as {
      |Assigns a qualified technician to perform the maintenance work.
    }
  }
  command StartMaintenance is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order being started.
      }
    }
    startedAt: TimeStamp with {
      briefly "Start timestamp"
      described as {
        |When maintenance work began.
      }
    }
    downtimeStart: TimeStamp? with {
      briefly "Downtime start"
      described as {
        |When equipment downtime began, if applicable.
      }
    }
  } with {
    briefly "Start maintenance work on the order"
    described as {
      |Records the start of maintenance work and begins tracking labor time.
    }
  }
  command RecordSpareUsage is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order using spare parts.
      }
    }
    sparePartId: SparePartId with {
      briefly "Part reference"
      described as {
        |Reference to the spare part consumed.
      }
    }
    partNumber: String(1,50) with {
      briefly "Part number"
      described as {
        |Manufacturer or internal part number.
      }
    }
    partName: String(1,200) with {
      briefly "Part name"
      described as {
        |Human-readable name of the spare part.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Number of parts consumed.
      }
    }
    unitCost: Decimal(10,2) with {
      briefly "Unit cost"
      described as {
        |Cost per unit of the spare part.
      }
    }
  } with {
    briefly "Record spare parts used during maintenance"
    described as {
      |Records spare parts consumed for cost tracking and inventory updates.
    }
  }
  command CompleteMaintenance is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order being completed.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completion timestamp"
      described as {
        |When maintenance work was completed.
      }
    }
    downtimeEnd: TimeStamp? with {
      briefly "Downtime end"
      described as {
        |When equipment was returned to service.
      }
    }
    completionNotes: String(1,2000) with {
      briefly "Completion notes"
      described as {
        |Summary of work performed and any observations.
      }
    }
    equipmentStatus: String(1,50) with {
      briefly "Equipment status"
      described as {
        |Status of equipment after maintenance (e.g., operational, limited).
      }
    }
  } with {
    briefly "Complete the maintenance order"
    described as {
      |Marks maintenance as complete and records final status and notes.
    }
  }
  command CancelOrder is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order being cancelled.
      }
    }
    reason: String(1,500) with {
      briefly "Cancellation reason"
      described as {
        |Explanation for why the order is being cancelled.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Identifier of person cancelling the order.
      }
    }
  } with {
    briefly "Cancel a maintenance order"
    described as {
      |Cancels a maintenance order that is no longer needed.
    }
  }
  // Events
  event MaintenanceOrderCreated is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The unique identifier of the created order.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment reference"
      described as {
        |The equipment requiring maintenance.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment name"
      described as {
        |Name of the equipment.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Maintenance type"
      described as {
        |Classification of the maintenance work.
      }
    }
    priority: MaintenancePriority with {
      briefly "Priority"
      described as {
        |Priority level of the order.
      }
    }
    scheduledDate: Date with {
      briefly "Scheduled date"
      described as {
        |Planned execution date.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created timestamp"
      described as {
        |When the order was created.
      }
    }
  } with {
    briefly "A maintenance order was created"
    described as {
      |Emitted when a new maintenance order is successfully created.
    }
  }
  event TechnicianAssigned is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order that was assigned.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician identifier"
      described as {
        |The assigned technician.
      }
    }
    technicianName: String(1,100) with {
      briefly "Technician name"
      described as {
        |Name of the assigned technician.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assignment timestamp"
      described as {
        |When the assignment was made.
      }
    }
  } with {
    briefly "A technician was assigned to the order"
    described as {
      |Emitted when a technician is assigned to perform maintenance.
    }
  }
  event MaintenanceStarted is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The maintenance order that started.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician identifier"
      described as {
        |The technician performing the work.
      }
    }
    startedAt: TimeStamp with {
      briefly "Start timestamp"
      described as {
        |When maintenance work began.
      }
    }
    downtimeStart: TimeStamp? with {
      briefly "Downtime start"
      described as {
        |When equipment downtime began.
      }
    }
  } with {
    briefly "Maintenance work was started"
    described as {
      |Emitted when a technician begins maintenance work.
    }
  }
  event SpareUsageRecorded is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The order where parts were used.
      }
    }
    sparePartId: SparePartId with {
      briefly "Part identifier"
      described as {
        |The spare part that was consumed.
      }
    }
    partNumber: String(1,50) with {
      briefly "Part number"
      described as {
        |Part number for identification.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Number of parts used.
      }
    }
    totalCost: Decimal(10,2) with {
      briefly "Total cost"
      described as {
        |Total cost of parts consumed.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recording timestamp"
      described as {
        |When usage was recorded.
      }
    }
  } with {
    briefly "Spare part usage was recorded"
    described as {
      |Emitted when spare parts are consumed during maintenance.
    }
  }
  event MaintenanceCompleted is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The completed maintenance order.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment identifier"
      described as {
        |The equipment that was serviced.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completion timestamp"
      described as {
        |When maintenance was completed.
      }
    }
    totalLaborMinutes: Natural with {
      briefly "Total labor time"
      described as {
        |Total minutes of labor expended.
      }
    }
    totalPartsCost: Decimal(10,2) with {
      briefly "Total parts cost"
      described as {
        |Total cost of spare parts consumed.
      }
    }
    downtimeMinutes: Natural? with {
      briefly "Downtime minutes"
      described as {
        |Total equipment downtime minutes.
      }
    }
    equipmentStatus: String(1,50) with {
      briefly "Equipment status"
      described as {
        |Status of equipment after maintenance.
      }
    }
  } with {
    briefly "Maintenance was completed"
    described as {
      |Emitted when maintenance work is finished and equipment is restored.
    }
  }
  event OrderCancelled is  {
    orderId: MaintenanceOrderId with {
      briefly "Order identifier"
      described as {
        |The cancelled maintenance order.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Why the order was cancelled.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Who cancelled the order.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled timestamp"
      described as {
        |When the order was cancelled.
      }
    }
  } with {
    briefly "Maintenance order was cancelled"
    described as {
      |Emitted when a maintenance order is cancelled.
    }
  }
  // State Records
  record PendingStateData is  {
    orderId: MaintenanceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment ID"
      described as {
        |Equipment reference.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment"
      described as {
        |Equipment name.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type"
      described as {
        |Maintenance type.
      }
    }
    priority: MaintenancePriority with {
      briefly "Priority"
      described as {
        |Work priority.
      }
    }
    description: String(1,2000) with {
      briefly "Description"
      described as {
        |Work description.
      }
    }
    scheduledDate: Date with {
      briefly "Scheduled"
      described as {
        |Scheduled date.
      }
    }
    estimatedDuration: Duration with {
      briefly "Estimate"
      described as {
        |Estimated duration.
      }
    }
    tasks: MaintenanceTask+ with {
      briefly "Tasks"
      described as {
        |Work tasks.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation timestamp.
      }
    }
  } with {
    briefly "Order data awaiting technician assignment"
    described as {
      |State data for an order that has been created but not yet assigned.
    }
  }
  record AssignedStateData is  {
    orderId: MaintenanceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment ID"
      described as {
        |Equipment reference.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment"
      described as {
        |Equipment name.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type"
      described as {
        |Maintenance type.
      }
    }
    priority: MaintenancePriority with {
      briefly "Priority"
      described as {
        |Work priority.
      }
    }
    description: String(1,2000) with {
      briefly "Description"
      described as {
        |Work description.
      }
    }
    scheduledDate: Date with {
      briefly "Scheduled"
      described as {
        |Scheduled date.
      }
    }
    estimatedDuration: Duration with {
      briefly "Estimate"
      described as {
        |Estimated duration.
      }
    }
    tasks: MaintenanceTask+ with {
      briefly "Tasks"
      described as {
        |Work tasks.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician"
      described as {
        |Assigned technician.
      }
    }
    technicianName: String(1,100) with {
      briefly "Name"
      described as {
        |Technician name.
      }
    }
    hourlyRate: Decimal(8,2) with {
      briefly "Rate"
      described as {
        |Labor rate.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment timestamp.
      }
    }
  } with {
    briefly "Order data with assigned technician"
    described as {
      |State data for an order with an assigned technician awaiting start.
    }
  }
  record InProgressStateData is  {
    orderId: MaintenanceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment ID"
      described as {
        |Equipment reference.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment"
      described as {
        |Equipment name.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type"
      described as {
        |Maintenance type.
      }
    }
    priority: MaintenancePriority with {
      briefly "Priority"
      described as {
        |Work priority.
      }
    }
    description: String(1,2000) with {
      briefly "Description"
      described as {
        |Work description.
      }
    }
    tasks: MaintenanceTask+ with {
      briefly "Tasks"
      described as {
        |Work tasks.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician"
      described as {
        |Assigned technician.
      }
    }
    technicianName: String(1,100) with {
      briefly "Name"
      described as {
        |Technician name.
      }
    }
    hourlyRate: Decimal(8,2) with {
      briefly "Rate"
      described as {
        |Labor rate.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start timestamp.
      }
    }
    downtimeStart: TimeStamp? with {
      briefly "Downtime start"
      described as {
        |Equipment downtime start.
      }
    }
    partsUsed: SparePartUsage+ with {
      briefly "Parts"
      described as {
        |Spare parts used.
      }
    }
    laborRecords: LaborRecord+ with {
      briefly "Labor"
      described as {
        |Labor records.
      }
    }
  } with {
    briefly "Order data during active maintenance"
    described as {
      |State data for an order with maintenance work in progress.
    }
  }
  record CompletedStateData is  {
    orderId: MaintenanceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment ID"
      described as {
        |Equipment reference.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment"
      described as {
        |Equipment name.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type"
      described as {
        |Maintenance type.
      }
    }
    technicianId: TechnicianId with {
      briefly "Technician"
      described as {
        |Technician who completed work.
      }
    }
    technicianName: String(1,100) with {
      briefly "Name"
      described as {
        |Technician name.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start timestamp.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion timestamp.
      }
    }
    totalLaborMinutes: Natural with {
      briefly "Labor"
      described as {
        |Total labor minutes.
      }
    }
    partsUsed: SparePartUsage+ with {
      briefly "Parts"
      described as {
        |Spare parts used.
      }
    }
    totalPartsCost: Decimal(10,2) with {
      briefly "Parts cost"
      described as {
        |Total parts cost.
      }
    }
    downtimeMinutes: Natural? with {
      briefly "Downtime"
      described as {
        |Total downtime minutes.
      }
    }
    completionNotes: String(1,2000) with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
    equipmentStatus: String(1,50) with {
      briefly "Status"
      described as {
        |Equipment status after maintenance.
      }
    }
  } with {
    briefly "Order data after completion"
    described as {
      |State data for a completed maintenance order with final metrics.
    }
  }
  record CancelledStateData is  {
    orderId: MaintenanceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    equipmentId: EquipmentId with {
      briefly "Equipment ID"
      described as {
        |Equipment reference.
      }
    }
    equipmentName: String(1,200) with {
      briefly "Equipment"
      described as {
        |Equipment name.
      }
    }
    maintenanceType: MaintenanceType with {
      briefly "Type"
      described as {
        |Maintenance type.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "By"
      described as {
        |Who cancelled.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation timestamp.
      }
    }
  } with {
    briefly "Order data after cancellation"
    described as {
      |State data for a cancelled maintenance order.
    }
  }
  // States
  state PendingState of type MaintenanceOrder.PendingStateData
  state AssignedState of type MaintenanceOrder.AssignedStateData
  state InProgressState of type MaintenanceOrder.InProgressStateData
  state CompletedState of type MaintenanceOrder.CompletedStateData
  state CancelledState of type MaintenanceOrder.CancelledStateData
  // Handler
  handler MaintenanceOrderHandler is {
    on command CreateMaintenanceOrder is {
      morph entity MaintenanceOrder to state MaintenanceOrder.PendingState with command CreateMaintenanceOrder
      tell event MaintenanceOrderCreated to entity MaintenanceOrder
    }
    on command AssignTechnician is {
      morph entity MaintenanceOrder to state MaintenanceOrder.AssignedState with command AssignTechnician
      tell event TechnicianAssigned to entity MaintenanceOrder
    }
    on command StartMaintenance is {
      morph entity MaintenanceOrder to state MaintenanceOrder.InProgressState with command StartMaintenance
      tell event MaintenanceStarted to entity MaintenanceOrder
    }
    on command RecordSpareUsage is {
      tell event SpareUsageRecorded to entity MaintenanceOrder
    }
    on command CompleteMaintenance is {
      morph entity MaintenanceOrder to state MaintenanceOrder.CompletedState with command CompleteMaintenance
      tell event MaintenanceCompleted to entity MaintenanceOrder
    }
    on command CancelOrder is {
      morph entity MaintenanceOrder to state MaintenanceOrder.CancelledState with command CancelOrder
      tell event OrderCancelled to entity MaintenanceOrder
    }
  } with {
    briefly "Processes maintenance order commands"
    described as {
      | Handles all commands related to maintenance order state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }
} with {
  briefly "The maintenance order aggregate managing work lifecycle"
  described as {
    | The MaintenanceOrder entity is the primary aggregate for the Equipment
    | Maintenance bounded context. It tracks maintenance orders from creation
    | through completion or cancellation, maintaining a complete audit trail
    | of work performed, parts consumed, and labor expended.
  }
}
