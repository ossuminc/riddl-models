// Equipment Maintenance - MaintenanceOrder Entity
// The primary aggregate for maintenance order lifecycle management

entity MaintenanceOrder is {

  // Commands
  command CreateMaintenanceOrder is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The unique identifier for the new maintenance order."
    }
    equipmentId is EquipmentId with {
      briefly "Equipment reference"
      described by "Reference to the equipment requiring maintenance."
    }
    equipmentName is String(1, 200) with {
      briefly "Equipment name"
      described by "Human-readable name of the equipment."
    }
    maintenanceType is MaintenanceType with {
      briefly "Type of maintenance"
      described by "Classification of maintenance work (preventive, corrective, etc.)."
    }
    priority is MaintenancePriority with {
      briefly "Work priority"
      described by "Priority level for scheduling and response."
    }
    description is String(1, 2000) with {
      briefly "Work description"
      described by "Detailed description of maintenance work required."
    }
    scheduledDate is Date with {
      briefly "Scheduled date"
      described by "The planned date for maintenance execution."
    }
    estimatedDuration is Duration with {
      briefly "Estimated duration"
      described by "Expected time to complete the maintenance work."
    }
    tasks is many MaintenanceTask with {
      briefly "Work tasks"
      described by "Individual tasks to be performed during maintenance."
    }
  } with {
    briefly "Create a new maintenance order"
    described by {
      | Creates a new maintenance order for equipment service. The order
      | starts in Pending state awaiting technician assignment.
    }
  }

  command AssignTechnician is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order to assign."
    }
    technicianId is TechnicianId with {
      briefly "Technician reference"
      described by "Reference to the technician being assigned."
    }
    technicianName is String(1, 100) with {
      briefly "Technician name"
      described by "Name of the assigned technician."
    }
    hourlyRate is Decimal(8, 2) with {
      briefly "Labor rate"
      described by "Hourly labor rate for the assigned technician."
    }
  } with {
    briefly "Assign a technician to the maintenance order"
    described by "Assigns a qualified technician to perform the maintenance work."
  }

  command StartMaintenance is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order being started."
    }
    startedAt is TimeStamp with {
      briefly "Start timestamp"
      described by "When maintenance work began."
    }
    downtimeStart is optional TimeStamp with {
      briefly "Downtime start"
      described by "When equipment downtime began, if applicable."
    }
  } with {
    briefly "Start maintenance work on the order"
    described by "Records the start of maintenance work and begins tracking labor time."
  }

  command RecordSpareUsage is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order using spare parts."
    }
    sparePartId is SparePartId with {
      briefly "Part reference"
      described by "Reference to the spare part consumed."
    }
    partNumber is String(1, 50) with {
      briefly "Part number"
      described by "Manufacturer or internal part number."
    }
    partName is String(1, 200) with {
      briefly "Part name"
      described by "Human-readable name of the spare part."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Number of parts consumed."
    }
    unitCost is Decimal(10, 2) with {
      briefly "Unit cost"
      described by "Cost per unit of the spare part."
    }
  } with {
    briefly "Record spare parts used during maintenance"
    described by "Records spare parts consumed for cost tracking and inventory updates."
  }

  command CompleteMaintenance is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order being completed."
    }
    completedAt is TimeStamp with {
      briefly "Completion timestamp"
      described by "When maintenance work was completed."
    }
    downtimeEnd is optional TimeStamp with {
      briefly "Downtime end"
      described by "When equipment was returned to service."
    }
    completionNotes is String(1, 2000) with {
      briefly "Completion notes"
      described by "Summary of work performed and any observations."
    }
    equipmentStatus is String(1, 50) with {
      briefly "Equipment status"
      described by "Status of equipment after maintenance (e.g., operational, limited)."
    }
  } with {
    briefly "Complete the maintenance order"
    described by "Marks maintenance as complete and records final status and notes."
  }

  command CancelOrder is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order being cancelled."
    }
    reason is String(1, 500) with {
      briefly "Cancellation reason"
      described by "Explanation for why the order is being cancelled."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Identifier of person cancelling the order."
    }
  } with {
    briefly "Cancel a maintenance order"
    described by "Cancels a maintenance order that is no longer needed."
  }

  // Events
  event MaintenanceOrderCreated is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The unique identifier of the created order."
    }
    equipmentId is EquipmentId with {
      briefly "Equipment reference"
      described by "The equipment requiring maintenance."
    }
    equipmentName is String(1, 200) with {
      briefly "Equipment name"
      described by "Name of the equipment."
    }
    maintenanceType is MaintenanceType with {
      briefly "Maintenance type"
      described by "Classification of the maintenance work."
    }
    priority is MaintenancePriority with {
      briefly "Priority"
      described by "Priority level of the order."
    }
    scheduledDate is Date with {
      briefly "Scheduled date"
      described by "Planned execution date."
    }
    createdAt is TimeStamp with {
      briefly "Created timestamp"
      described by "When the order was created."
    }
  } with {
    briefly "A maintenance order was created"
    described by "Emitted when a new maintenance order is successfully created."
  }

  event TechnicianAssigned is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order that was assigned."
    }
    technicianId is TechnicianId with {
      briefly "Technician identifier"
      described by "The assigned technician."
    }
    technicianName is String(1, 100) with {
      briefly "Technician name"
      described by "Name of the assigned technician."
    }
    assignedAt is TimeStamp with {
      briefly "Assignment timestamp"
      described by "When the assignment was made."
    }
  } with {
    briefly "A technician was assigned to the order"
    described by "Emitted when a technician is assigned to perform maintenance."
  }

  event MaintenanceStarted is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The maintenance order that started."
    }
    technicianId is TechnicianId with {
      briefly "Technician identifier"
      described by "The technician performing the work."
    }
    startedAt is TimeStamp with {
      briefly "Start timestamp"
      described by "When maintenance work began."
    }
    downtimeStart is optional TimeStamp with {
      briefly "Downtime start"
      described by "When equipment downtime began."
    }
  } with {
    briefly "Maintenance work was started"
    described by "Emitted when a technician begins maintenance work."
  }

  event SpareUsageRecorded is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The order where parts were used."
    }
    sparePartId is SparePartId with {
      briefly "Part identifier"
      described by "The spare part that was consumed."
    }
    partNumber is String(1, 50) with {
      briefly "Part number"
      described by "Part number for identification."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Number of parts used."
    }
    totalCost is Decimal(10, 2) with {
      briefly "Total cost"
      described by "Total cost of parts consumed."
    }
    recordedAt is TimeStamp with {
      briefly "Recording timestamp"
      described by "When usage was recorded."
    }
  } with {
    briefly "Spare part usage was recorded"
    described by "Emitted when spare parts are consumed during maintenance."
  }

  event MaintenanceCompleted is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The completed maintenance order."
    }
    equipmentId is EquipmentId with {
      briefly "Equipment identifier"
      described by "The equipment that was serviced."
    }
    completedAt is TimeStamp with {
      briefly "Completion timestamp"
      described by "When maintenance was completed."
    }
    totalLaborMinutes is Natural with {
      briefly "Total labor time"
      described by "Total minutes of labor expended."
    }
    totalPartsCost is Decimal(10, 2) with {
      briefly "Total parts cost"
      described by "Total cost of spare parts consumed."
    }
    downtimeMinutes is optional Natural with {
      briefly "Downtime minutes"
      described by "Total equipment downtime minutes."
    }
    equipmentStatus is String(1, 50) with {
      briefly "Equipment status"
      described by "Status of equipment after maintenance."
    }
  } with {
    briefly "Maintenance was completed"
    described by "Emitted when maintenance work is finished and equipment is restored."
  }

  event OrderCancelled is {
    orderId is MaintenanceOrderId with {
      briefly "Order identifier"
      described by "The cancelled maintenance order."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Why the order was cancelled."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Who cancelled the order."
    }
    cancelledAt is TimeStamp with {
      briefly "Cancelled timestamp"
      described by "When the order was cancelled."
    }
  } with {
    briefly "Maintenance order was cancelled"
    described by "Emitted when a maintenance order is cancelled."
  }

  // State Records
  record PendingStateData is {
    orderId is MaintenanceOrderId with { briefly "Order ID" described by "Order identifier." }
    equipmentId is EquipmentId with { briefly "Equipment ID" described by "Equipment reference." }
    equipmentName is String(1, 200) with { briefly "Equipment" described by "Equipment name." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    priority is MaintenancePriority with { briefly "Priority" described by "Work priority." }
    description is String(1, 2000) with { briefly "Description" described by "Work description." }
    scheduledDate is Date with { briefly "Scheduled" described by "Scheduled date." }
    estimatedDuration is Duration with { briefly "Estimate" described by "Estimated duration." }
    tasks is many MaintenanceTask with { briefly "Tasks" described by "Work tasks." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation timestamp." }
  } with {
    briefly "Order data awaiting technician assignment"
    described by "State data for an order that has been created but not yet assigned."
  }

  record AssignedStateData is {
    orderId is MaintenanceOrderId with { briefly "Order ID" described by "Order identifier." }
    equipmentId is EquipmentId with { briefly "Equipment ID" described by "Equipment reference." }
    equipmentName is String(1, 200) with { briefly "Equipment" described by "Equipment name." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    priority is MaintenancePriority with { briefly "Priority" described by "Work priority." }
    description is String(1, 2000) with { briefly "Description" described by "Work description." }
    scheduledDate is Date with { briefly "Scheduled" described by "Scheduled date." }
    estimatedDuration is Duration with { briefly "Estimate" described by "Estimated duration." }
    tasks is many MaintenanceTask with { briefly "Tasks" described by "Work tasks." }
    technicianId is TechnicianId with { briefly "Technician" described by "Assigned technician." }
    technicianName is String(1, 100) with { briefly "Name" described by "Technician name." }
    hourlyRate is Decimal(8, 2) with { briefly "Rate" described by "Labor rate." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment timestamp." }
  } with {
    briefly "Order data with assigned technician"
    described by "State data for an order with an assigned technician awaiting start."
  }

  record InProgressStateData is {
    orderId is MaintenanceOrderId with { briefly "Order ID" described by "Order identifier." }
    equipmentId is EquipmentId with { briefly "Equipment ID" described by "Equipment reference." }
    equipmentName is String(1, 200) with { briefly "Equipment" described by "Equipment name." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    priority is MaintenancePriority with { briefly "Priority" described by "Work priority." }
    description is String(1, 2000) with { briefly "Description" described by "Work description." }
    tasks is many MaintenanceTask with { briefly "Tasks" described by "Work tasks." }
    technicianId is TechnicianId with { briefly "Technician" described by "Assigned technician." }
    technicianName is String(1, 100) with { briefly "Name" described by "Technician name." }
    hourlyRate is Decimal(8, 2) with { briefly "Rate" described by "Labor rate." }
    startedAt is TimeStamp with { briefly "Started" described by "Start timestamp." }
    downtimeStart is optional TimeStamp with { briefly "Downtime start" described by "Equipment downtime start." }
    partsUsed is many SparePartUsage with { briefly "Parts" described by "Spare parts used." }
    laborRecords is many LaborRecord with { briefly "Labor" described by "Labor records." }
  } with {
    briefly "Order data during active maintenance"
    described by "State data for an order with maintenance work in progress."
  }

  record CompletedStateData is {
    orderId is MaintenanceOrderId with { briefly "Order ID" described by "Order identifier." }
    equipmentId is EquipmentId with { briefly "Equipment ID" described by "Equipment reference." }
    equipmentName is String(1, 200) with { briefly "Equipment" described by "Equipment name." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    technicianId is TechnicianId with { briefly "Technician" described by "Technician who completed work." }
    technicianName is String(1, 100) with { briefly "Name" described by "Technician name." }
    startedAt is TimeStamp with { briefly "Started" described by "Start timestamp." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion timestamp." }
    totalLaborMinutes is Natural with { briefly "Labor" described by "Total labor minutes." }
    partsUsed is many SparePartUsage with { briefly "Parts" described by "Spare parts used." }
    totalPartsCost is Decimal(10, 2) with { briefly "Parts cost" described by "Total parts cost." }
    downtimeMinutes is optional Natural with { briefly "Downtime" described by "Total downtime minutes." }
    completionNotes is String(1, 2000) with { briefly "Notes" described by "Completion notes." }
    equipmentStatus is String(1, 50) with { briefly "Status" described by "Equipment status after maintenance." }
  } with {
    briefly "Order data after completion"
    described by "State data for a completed maintenance order with final metrics."
  }

  record CancelledStateData is {
    orderId is MaintenanceOrderId with { briefly "Order ID" described by "Order identifier." }
    equipmentId is EquipmentId with { briefly "Equipment ID" described by "Equipment reference." }
    equipmentName is String(1, 200) with { briefly "Equipment" described by "Equipment name." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is String(1, 100) with { briefly "By" described by "Who cancelled." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation timestamp." }
  } with {
    briefly "Order data after cancellation"
    described by "State data for a cancelled maintenance order."
  }

  // States
  state PendingState of MaintenanceOrder.PendingStateData with {
    briefly "Order created, awaiting assignment"
    described by "Maintenance order has been created and is waiting for technician assignment."
  }

  state AssignedState of MaintenanceOrder.AssignedStateData with {
    briefly "Technician assigned, awaiting start"
    described by "Technician has been assigned and order is ready to begin."
  }

  state InProgressState of MaintenanceOrder.InProgressStateData with {
    briefly "Maintenance work in progress"
    described by "Technician is actively performing maintenance work."
  }

  state CompletedState of MaintenanceOrder.CompletedStateData with {
    briefly "Maintenance completed"
    described by "Maintenance work has been completed and equipment restored."
  }

  state CancelledState of MaintenanceOrder.CancelledStateData with {
    briefly "Order was cancelled"
    described by "Maintenance order was cancelled before completion."
  }

  // Handler
  handler MaintenanceOrderHandler is {
    on command CreateMaintenanceOrder {
      morph entity MaintenanceOrder to state MaintenanceOrder.PendingState with command CreateMaintenanceOrder
      tell event MaintenanceOrderCreated to entity MaintenanceOrder
    }

    on command AssignTechnician {
      morph entity MaintenanceOrder to state MaintenanceOrder.AssignedState with command AssignTechnician
      tell event TechnicianAssigned to entity MaintenanceOrder
    }

    on command StartMaintenance {
      morph entity MaintenanceOrder to state MaintenanceOrder.InProgressState with command StartMaintenance
      tell event MaintenanceStarted to entity MaintenanceOrder
    }

    on command RecordSpareUsage {
      tell event SpareUsageRecorded to entity MaintenanceOrder
    }

    on command CompleteMaintenance {
      morph entity MaintenanceOrder to state MaintenanceOrder.CompletedState with command CompleteMaintenance
      tell event MaintenanceCompleted to entity MaintenanceOrder
    }

    on command CancelOrder {
      morph entity MaintenanceOrder to state MaintenanceOrder.CancelledState with command CancelOrder
      tell event OrderCancelled to entity MaintenanceOrder
    }
  } with {
    briefly "Processes maintenance order commands"
    described by {
      | Handles all commands related to maintenance order state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }

} with {
  briefly "The maintenance order aggregate managing work lifecycle"
  described by {
    | The MaintenanceOrder entity is the primary aggregate for the Equipment
    | Maintenance bounded context. It tracks maintenance orders from creation
    | through completion or cancellation, maintaining a complete audit trail
    | of work performed, parts consumed, and labor expended.
  }
}
