// Quality Control - Quality Context
context QualityContext is {
  include "types.riddl"
  include "Inspection.riddl"
  // Repository for inspection data persistence
  repository InspectionRepository is {
    schema InspectionData is relational
      of inspections as type Inspection
        index on field Inspection.inspectionId
        index on field Inspection.lot.lotId
        index on field Inspection.finalResult

    handler InspectionPersistence is {
      on command Inspection.CreateInspection is {
        prompt "Store new inspection record"
      }
      on command Inspection.CollectSample is {
        prompt "Store sample collection"
      }
      on command Inspection.RecordTestResult is {
        prompt "Store test result"
      }
      on command Inspection.EvaluateResults is {
        prompt "Update evaluation summary"
      }
      on command Inspection.ApproveInspection is {
        prompt "Update to approved status"
      }
      on command Inspection.RejectInspection is {
        prompt "Update to rejected status"
      }
      on command Inspection.InitiateNCR is {
        prompt "Store non-conformance record"
      }
    } with {
      briefly "Persists inspection commands"
      described as {
        |Handles command-driven persistence for inspections.
      }
    }
  } with {
    briefly "Inspection data persistence"
    described as {
      | The InspectionRepository provides persistent storage for
      | inspections, samples, test results, and non-conformances.
    }
  }
  // Projector for defect Pareto analysis
  projector DefectParetoAnalytics is {
    record DefectParetoData is  {
      defectCategory: String(1,100) with {
        briefly "Category"
        described as {
          |Defect category.
        }
      }
      occurrenceCount: Natural with {
        briefly "Count"
        described as {
          |Number of occurrences.
        }
      }
      cumulativePercent: Decimal(5,2) with {
        briefly "Cumulative"
        described as {
          |Cumulative percentage.
        }
      }
      affectedQuantity: Decimal(15,4) with {
        briefly "Quantity"
        described as {
          |Affected quantity.
        }
      }
      productCode: String(1,50) with {
        briefly "Product"
        described as {
          |Product code.
        }
      }
      periodStart: Date with {
        briefly "Start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: Date with {
        briefly "End"
        described as {
          |Analysis period end.
        }
      }
    } with {
      briefly "Defect Pareto data"
      described as {
        |Defect frequency analysis data.
      }
    }
    handler DefectParetoHandler is {
      on event Inspection.InspectionRejected is {
        prompt "Update defect category counts"
      }
      on event Inspection.NCRInitiated is {
        prompt "Increment defect occurrence for NCR category"
      }
      on event Inspection.TestResultRecorded is {
        prompt "Track out-of-spec results by parameter"
      }
    } with {
      briefly "Maintains defect Pareto analysis"
      described as {
        |Projects defect events into Pareto chart data.
      }
    }
  } with {
    briefly "Defect Pareto projections"
    described as {
      |Maintains defect Pareto analysis for quality improvement.
    }
  }
  // Projector for Statistical Process Control (SPC) charts
  projector SPCChartAnalytics is {
    record SPCDataPoint is  {
      parameter: String(1,100) with {
        briefly "Parameter"
        described as {
          |Measured parameter.
        }
      }
      measuredValue: Decimal(15,6) with {
        briefly "Value"
        described as {
          |Measured value.
        }
      }
      sampleId: SampleId with {
        briefly "Sample"
        described as {
          |Sample identifier.
        }
      }
      lotId: LotId with {
        briefly "Lot"
        described as {
          |Lot identifier.
        }
      }
      timestamp: TimeStamp with {
        briefly "Time"
        described as {
          |Measurement time.
        }
      }
      mean: Decimal(15,6) with {
        briefly "Mean"
        described as {
          |Running mean.
        }
      }
      standardDeviation: Decimal(15,6) with {
        briefly "StdDev"
        described as {
          |Standard deviation.
        }
      }
      upperControlLimit: Decimal(15,6) with {
        briefly "UCL"
        described as {
          |Upper control limit.
        }
      }
      lowerControlLimit: Decimal(15,6) with {
        briefly "LCL"
        described as {
          |Lower control limit.
        }
      }
      isOutOfControl: Boolean with {
        briefly "OOC"
        described as {
          |Out of control indicator.
        }
      }
    } with {
      briefly "SPC data point"
      described as {
        |Statistical process control data point.
      }
    }
    record ControlChartSummary is  {
      parameter: String(1,100) with {
        briefly "Parameter"
        described as {
          |Measured parameter.
        }
      }
      processCapabilityIndex: Decimal(5,3) with {
        briefly "Cpk"
        described as {
          |Process capability index.
        }
      }
      processPerformanceIndex: Decimal(5,3) with {
        briefly "Ppk"
        described as {
          |Process performance index.
        }
      }
      centerLine: Decimal(15,6) with {
        briefly "CL"
        described as {
          |Center line (mean).
        }
      }
      oocCount: Natural with {
        briefly "OOC count"
        described as {
          |Out of control count.
        }
      }
      totalPoints: Natural with {
        briefly "Total"
        described as {
          |Total data points.
        }
      }
    } with {
      briefly "Control chart summary"
      described as {
        |Summary statistics for control chart.
      }
    }
    handler SPCHandler is {
      on event Inspection.TestResultRecorded is {
        prompt "Add data point and recalculate control limits"
      }
    } with {
      briefly "Maintains SPC chart data"
      described as {
        |Projects test results into SPC chart data.
      }
    }
  } with {
    briefly "SPC chart projections"
    described as {
      |Maintains Statistical Process Control chart data.
    }
  }
  // Projector for yield trending
  projector YieldTrendingAnalytics is {
    record YieldTrendData is  {
      periodDate: Date with {
        briefly "Date"
        described as {
          |Period date.
        }
      }
      productCode: String(1,50) with {
        briefly "Product"
        described as {
          |Product code.
        }
      }
      inspectionCount: Natural with {
        briefly "Inspections"
        described as {
          |Number of inspections.
        }
      }
      passCount: Natural with {
        briefly "Passed"
        described as {
          |Passed inspections.
        }
      }
      failCount: Natural with {
        briefly "Failed"
        described as {
          |Failed inspections.
        }
      }
      conditionalCount: Natural with {
        briefly "Conditional"
        described as {
          |Conditional passes.
        }
      }
      firstPassYield: Decimal(5,4) with {
        briefly "FPY"
        described as {
          |First pass yield.
        }
      }
      rolledThroughputYield: Decimal(5,4) with {
        briefly "RTY"
        described as {
          |Rolled throughput yield.
        }
      }
      totalQuantityInspected: Decimal(15,4) with {
        briefly "Inspected"
        described as {
          |Total quantity inspected.
        }
      }
      totalQuantityPassed: Decimal(15,4) with {
        briefly "Passed qty"
        described as {
          |Quantity passed.
        }
      }
      totalQuantityRejected: Decimal(15,4) with {
        briefly "Rejected qty"
        described as {
          |Quantity rejected.
        }
      }
    } with {
      briefly "Yield trend data"
      described as {
        |Quality yield trending data.
      }
    }
    record YieldSummary is  {
      productCode: String(1,50) with {
        briefly "Product"
        described as {
          |Product code.
        }
      }
      periodType: String(1,20) with {
        briefly "Period"
        described as {
          |Period type (day/week/month).
        }
      }
      averageYield: Decimal(5,4) with {
        briefly "Avg yield"
        described as {
          |Average yield.
        }
      }
      yieldTrend: Decimal(6,4) with {
        briefly "Trend"
        described as {
          |Yield trend (positive=improving).
        }
      }
      targetYield: Decimal(5,4) with {
        briefly "Target"
        described as {
          |Target yield.
        }
      }
      gapToTarget: Decimal(6,4) with {
        briefly "Gap"
        described as {
          |Gap to target.
        }
      }
    } with {
      briefly "Yield summary"
      described as {
        |Yield performance summary.
      }
    }
    handler YieldHandler is {
      on event Inspection.InspectionApproved is {
        prompt "Increment pass counts and update yield"
      }
      on event Inspection.InspectionRejected is {
        prompt "Increment fail counts and update yield"
      }
      on event Inspection.ResultsEvaluated is {
        prompt "Update inspection counts for period"
      }
    } with {
      briefly "Maintains yield trending data"
      described as {
        |Projects inspection results into yield trend analytics.
      }
    }
  } with {
    briefly "Yield trending projections"
    described as {
      |Maintains yield trending analytics for quality performance.
    }
  }
} with {
  briefly "Bounded context for quality control"
  described as {
    | The QualityContext is the bounded context for
    | quality inspections, testing, and analytics.
  }
}
