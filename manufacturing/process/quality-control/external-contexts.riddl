// Quality Control - External Contexts

// Laboratory Information Management System (LIMS)
context LaboratoryInformationSystem is {

  command SubmitSampleForTesting is {
    sampleId is SampleId with { briefly "Sample" described by "Sample identifier." }
    inspectionId is InspectionId with { briefly "Inspection" described by "Related inspection." }
    testMethods is many TestMethodInfo with { briefly "Tests" described by "Required test methods." }
    priority is String(1, 20) with { briefly "Priority" described by "Testing priority." }
    requestedBy is String(1, 200) with { briefly "Requested by" described by "Requester." }
  } with {
    briefly "Submit sample"
    described by "Submits sample to LIMS for testing."
  }

  event SampleReceived is {
    sampleId is SampleId with { briefly "Sample" described by "Sample identifier." }
    labWorkOrderId is String(1, 50) with { briefly "Lab WO" described by "Lab work order ID." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Sample received"
    described by "Emitted when LIMS receives sample."
  }

  event TestingCompleted is {
    sampleId is SampleId with { briefly "Sample" described by "Sample identifier." }
    labWorkOrderId is String(1, 50) with { briefly "Lab WO" described by "Lab work order ID." }
    results is many TestResult with { briefly "Results" described by "Test results." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Testing completed"
    described by "Emitted when LIMS completes testing."
  }

  query GetTestMethodDetails is {
    testMethodId is TestMethodId with { briefly "Method" described by "Test method identifier." }
  } with {
    briefly "Get test method"
    described by "Retrieves test method details from LIMS."
  }

  result TestMethodDetails is {
    testMethodId is TestMethodId with { briefly "Method" described by "Test method ID." }
    methodName is String(1, 200) with { briefly "Name" described by "Method name." }
    standardReference is String(1, 100) with { briefly "Standard" described by "Standard reference (e.g., ASTM)." }
    estimatedDuration is Natural with { briefly "Duration" described by "Estimated duration in minutes." }
    equipmentRequired is many String(1, 100) with { briefly "Equipment" described by "Required equipment." }
    accreditationStatus is String(1, 50) with { briefly "Accreditation" described by "Lab accreditation status." }
  } with {
    briefly "Test method details"
    described by "Detailed test method information."
  }

  query GetLabCapacity is {
    testMethodId is TestMethodId with { briefly "Method" described by "Test method identifier." }
    requestedDate is Date with { briefly "Date" described by "Requested test date." }
  } with {
    briefly "Get lab capacity"
    described by "Checks lab capacity for testing."
  }

  result LabCapacity is {
    testMethodId is TestMethodId with { briefly "Method" described by "Test method ID." }
    availableSlots is Natural with { briefly "Slots" described by "Available testing slots." }
    nextAvailable is TimeStamp with { briefly "Next" described by "Next available slot." }
    backlogDays is Natural with { briefly "Backlog" described by "Current backlog in days." }
  } with {
    briefly "Lab capacity"
    described by "Lab testing capacity information."
  }

} with {
  option is external
  briefly "External LIMS"
  described by "External Laboratory Information Management System for test execution."
}

// Production Service (lot/batch linkage)
context ProductionService is {

  query GetLotDetails is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
  } with {
    briefly "Get lot details"
    described by "Retrieves production lot details."
  }

  result LotDetails is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    lotNumber is String(1, 50) with { briefly "Lot number" described by "Lot tracking number." }
    batchId is optional BatchId with { briefly "Batch" described by "Related batch identifier." }
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
    productName is String(1, 200) with { briefly "Name" described by "Product name." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Lot quantity." }
    unitOfMeasure is String(1, 30) with { briefly "UOM" described by "Unit of measure." }
    manufacturingDate is Date with { briefly "Manufactured" described by "Manufacturing date." }
    equipmentUsed is many String(1, 100) with { briefly "Equipment" described by "Equipment used in production." }
    operatorIds is many String(1, 100) with { briefly "Operators" described by "Production operators." }
    processParameters is many String(1, 500) with { briefly "Parameters" described by "Process parameters recorded." }
  } with {
    briefly "Lot details"
    described by "Detailed production lot information."
  }

  command PlaceLotOnQualityHold is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    holdType is String(1, 50) with { briefly "Type" described by "Hold type (QA, QC, etc.)." }
    placedBy is String(1, 200) with { briefly "Placed by" described by "Person placing hold." }
  } with {
    briefly "Place lot on hold"
    described by "Places production lot on quality hold."
  }

  event LotPlacedOnHold is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    holdId is UUID with { briefly "Hold" described by "Hold identifier." }
    placedAt is TimeStamp with { briefly "Placed" described by "Hold placement time." }
  } with {
    briefly "Lot placed on hold"
    described by "Emitted when lot is placed on hold."
  }

  command ReleaseLotFromHold is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    releaseQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Quantity to release." }
    releasedBy is String(1, 200) with { briefly "Released by" described by "Person releasing." }
    inspectionId is InspectionId with { briefly "Inspection" described by "Related inspection." }
  } with {
    briefly "Release lot from hold"
    described by "Releases production lot from quality hold."
  }

  event LotReleasedFromHold is {
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    releasedQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Released quantity." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
  } with {
    briefly "Lot released from hold"
    described by "Emitted when lot is released from hold."
  }

  query GetRelatedLots is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
  } with {
    briefly "Get related lots"
    described by "Retrieves all lots from same batch."
  }

  result RelatedLots is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    lots is many LotInfo with { briefly "Lots" described by "Related lot information." }
  } with {
    briefly "Related lots"
    described by "Lots related through same batch."
  }

} with {
  option is external
  briefly "External production service"
  described by "External production service for lot and batch information."
}

// Corrective and Preventive Action (CAPA) Service
context CAPAService is {

  command CreateCAPA is {
    ncrNumber is String(1, 50) with { briefly "NCR" described by "Source NCR number." }
    inspectionId is InspectionId with { briefly "Inspection" described by "Source inspection." }
    problemDescription is String(1, 2000) with { briefly "Problem" described by "Problem description." }
    rootCauseCategory is String(1, 100) with { briefly "Category" described by "Root cause category." }
    affectedProducts is many String(1, 100) with { briefly "Products" described by "Affected product codes." }
    initiatedBy is String(1, 200) with { briefly "Initiated by" described by "Initiator." }
  } with {
    briefly "Create CAPA"
    described by "Creates a CAPA from non-conformance."
  }

  event CAPACreated is {
    capaId is UUID with { briefly "CAPA" described by "CAPA identifier." }
    ncrNumber is String(1, 50) with { briefly "NCR" described by "Source NCR." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "CAPA created"
    described by "Emitted when CAPA is created."
  }

  command LinkNCRToCAPA is {
    ncrNumber is String(1, 50) with { briefly "NCR" described by "NCR number." }
    capaId is UUID with { briefly "CAPA" described by "CAPA to link." }
  } with {
    briefly "Link NCR to CAPA"
    described by "Links non-conformance to existing CAPA."
  }

  event NCRLinkedToCAPA is {
    ncrNumber is String(1, 50) with { briefly "NCR" described by "NCR number." }
    capaId is UUID with { briefly "CAPA" described by "Linked CAPA." }
    linkedAt is TimeStamp with { briefly "Linked" described by "Link time." }
  } with {
    briefly "NCR linked to CAPA"
    described by "Emitted when NCR is linked to CAPA."
  }

  query GetCAPAStatus is {
    capaId is UUID with { briefly "CAPA" described by "CAPA identifier." }
  } with {
    briefly "Get CAPA status"
    described by "Retrieves CAPA status."
  }

  result CAPAStatus is {
    capaId is UUID with { briefly "CAPA" described by "CAPA identifier." }
    status is String(1, 50) with { briefly "Status" described by "CAPA status." }
    rootCause is optional String(1, 1000) with { briefly "Root cause" described by "Identified root cause." }
    correctiveActions is many String(1, 500) with { briefly "Actions" described by "Corrective actions." }
    targetDate is Date with { briefly "Target" described by "Target completion date." }
    completionPercent is Decimal(5, 2) with { briefly "Completion" described by "Completion percentage." }
    effectivenessVerified is Boolean with { briefly "Verified" described by "Effectiveness verified." }
  } with {
    briefly "CAPA status"
    described by "Current CAPA status and progress."
  }

  event CAPAClosed is {
    capaId is UUID with { briefly "CAPA" described by "CAPA identifier." }
    effectivenessVerified is Boolean with { briefly "Verified" described by "Whether effectiveness verified." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "CAPA closed"
    described by "Emitted when CAPA is closed."
  }

  query GetOpenCAPAsForProduct is {
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
  } with {
    briefly "Get open CAPAs"
    described by "Retrieves open CAPAs for a product."
  }

  result OpenCAPAs is {
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
    capas is many CAPAStatus with { briefly "CAPAs" described by "Open CAPA list." }
    totalCount is Natural with { briefly "Count" described by "Total open CAPAs." }
  } with {
    briefly "Open CAPAs"
    described by "Open CAPAs for product."
  }

} with {
  option is external
  briefly "External CAPA service"
  described by "External Corrective and Preventive Action tracking service."
}
