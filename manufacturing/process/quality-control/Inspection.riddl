// Quality Control - Inspection Entity
entity Inspection is {
  // Commands
  command CreateInspection is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |New inspection identifier.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Lot being inspected.
      }
    }
    plan: InspectionPlan with {
      briefly "Plan"
      described as {
        |Inspection plan to follow.
      }
    }
    requestedBy: String(1,200) with {
      briefly "Requested by"
      described as {
        |Person requesting inspection.
      }
    }
  } with {
    briefly "Create inspection"
    described as {
      |Creates a new quality inspection for a lot.
    }
  }
  command CollectSample is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    sample: Sample with {
      briefly "Sample"
      described as {
        |Sample collection details.
      }
    }
  } with {
    briefly "Collect sample"
    described as {
      |Records collection of a sample for testing.
    }
  }
  command RecordTestResult is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    result: TestResult with {
      briefly "Result"
      described as {
        |Test result to record.
      }
    }
  } with {
    briefly "Record test result"
    described as {
      |Records result of a quality test.
    }
  }
  command EvaluateResults is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    evaluatedBy: String(1,200) with {
      briefly "Evaluated by"
      described as {
        |Person evaluating results.
      }
    }
    notes: String(1,2000)? with {
      briefly "Notes"
      described as {
        |Evaluation notes.
      }
    }
  } with {
    briefly "Evaluate results"
    described as {
      |Evaluates test results against specifications.
    }
  }
  command ApproveInspection is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Person approving inspection.
      }
    }
    releaseQuantity: Decimal(15,4) with {
      briefly "Release quantity"
      described as {
        |Quantity approved for release.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Approval notes.
      }
    }
  } with {
    briefly "Approve inspection"
    described as {
      |Approves inspection and releases lot.
    }
  }
  command RejectInspection is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Person rejecting inspection.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject inspection"
    described as {
      |Rejects inspection due to quality failures.
    }
  }
  command InitiateNCR is  {
    inspectionId: InspectionId with {
      briefly "Inspection ID"
      described as {
        |Inspection identifier.
      }
    }
    nonConformance: NonConformance with {
      briefly "Non-conformance"
      described as {
        |Non-conformance details.
      }
    }
    initiatedBy: String(1,200) with {
      briefly "Initiated by"
      described as {
        |Person initiating NCR.
      }
    }
  } with {
    briefly "Initiate NCR"
    described as {
      |Initiates a non-conformance report.
    }
  }
  // Events
  event InspectionCreated is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Lot information.
      }
    }
    plan: InspectionPlan with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    requestedBy: String(1,200) with {
      briefly "Requested by"
      described as {
        |Requester.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Inspection created"
    described as {
      |Emitted when inspection is created.
    }
  }
  event SampleCollected is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    sample: Sample with {
      briefly "Sample"
      described as {
        |Collected sample.
      }
    }
    collectedAt: TimeStamp with {
      briefly "Collected"
      described as {
        |Collection time.
      }
    }
  } with {
    briefly "Sample collected"
    described as {
      |Emitted when a sample is collected.
    }
  }
  event TestResultRecorded is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    result: TestResult with {
      briefly "Result"
      described as {
        |Test result.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Test result recorded"
    described as {
      |Emitted when a test result is recorded.
    }
  }
  event ResultsEvaluated is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    summary: InspectionSummary with {
      briefly "Summary"
      described as {
        |Results summary.
      }
    }
    evaluatedBy: String(1,200) with {
      briefly "Evaluated by"
      described as {
        |Evaluator.
      }
    }
    evaluatedAt: TimeStamp with {
      briefly "Evaluated"
      described as {
        |Evaluation time.
      }
    }
  } with {
    briefly "Results evaluated"
    described as {
      |Emitted when results are evaluated.
    }
  }
  event InspectionApproved is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Approved lot.
      }
    }
    releaseQuantity: Decimal(15,4) with {
      briefly "Released"
      described as {
        |Released quantity.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Inspection approved"
    described as {
      |Emitted when inspection is approved.
    }
  }
  event InspectionRejected is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Rejected lot.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Rejecter.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Inspection rejected"
    described as {
      |Emitted when inspection is rejected.
    }
  }
  event NCRInitiated is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    nonConformance: NonConformance with {
      briefly "NCR"
      described as {
        |Non-conformance report.
      }
    }
    initiatedBy: String(1,200) with {
      briefly "Initiated by"
      described as {
        |Initiator.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "NCR initiated"
    described as {
      |Emitted when NCR is initiated.
    }
  }
  // State Records
  record PendingStateData is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Lot being inspected.
      }
    }
    plan: InspectionPlan with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    requestedBy: String(1,200) with {
      briefly "Requested by"
      described as {
        |Requester.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Pending state data"
    described as {
      |Data for inspection awaiting samples.
    }
  }
  record InProgressStateData is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Lot being inspected.
      }
    }
    plan: InspectionPlan with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    samples: Sample+ with {
      briefly "Samples"
      described as {
        |Collected samples.
      }
    }
    currentTestResults: TestResult* with {
      briefly "Results"
      described as {
        |Test results.
      }
    }
    requestedBy: String(1,200) with {
      briefly "Requested by"
      described as {
        |Requester.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
    startedAt: TimeStamp? with {
      briefly "Started"
      described as {
        |When testing began.
      }
    }
  } with {
    briefly "In-progress state data"
    described as {
      |Data for inspection with active testing.
    }
  }
  record CompletedStateData is  {
    inspectionId: InspectionId with {
      briefly "Inspection"
      described as {
        |Inspection ID.
      }
    }
    lot: LotInfo with {
      briefly "Lot"
      described as {
        |Inspected lot.
      }
    }
    plan: InspectionPlan with {
      briefly "Plan"
      described as {
        |Inspection plan.
      }
    }
    samples: Sample+ with {
      briefly "Samples"
      described as {
        |Collected samples.
      }
    }
    testResults: TestResult+ with {
      briefly "Results"
      described as {
        |Test results.
      }
    }
    summary: InspectionSummary with {
      briefly "Summary"
      described as {
        |Results summary.
      }
    }
    finalResult: InspectionResult with {
      briefly "Result"
      described as {
        |Final result.
      }
    }
    nonConformances: NonConformance* with {
      briefly "NCRs"
      described as {
        |Non-conformances.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Completer.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |Data for completed inspection.
    }
  }
  // States
  state PendingState of type Inspection.PendingStateData
  state InProgressState of type Inspection.InProgressStateData
  state CompletedState of type Inspection.CompletedStateData
  // Handler
  handler InspectionHandler is {
    on command CreateInspection is {
      morph entity QualityContext.Inspection to state QualityContext.Inspection.PendingState with command CreateInspection
      tell event InspectionCreated to entity QualityContext.Inspection
    }
    on command CollectSample is {
      morph entity QualityContext.Inspection to state QualityContext.Inspection.InProgressState with command CollectSample
      tell event SampleCollected to entity QualityContext.Inspection
    }
    on command RecordTestResult is {
      tell event TestResultRecorded to entity QualityContext.Inspection
    }
    on command EvaluateResults is {
      tell event ResultsEvaluated to entity QualityContext.Inspection
    }
    on command ApproveInspection is {
      morph entity QualityContext.Inspection to state QualityContext.Inspection.CompletedState with command ApproveInspection
      tell event InspectionApproved to entity QualityContext.Inspection
    }
    on command RejectInspection is {
      morph entity QualityContext.Inspection to state QualityContext.Inspection.CompletedState with command RejectInspection
      tell event InspectionRejected to entity QualityContext.Inspection
    }
    on command InitiateNCR is {
      tell event NCRInitiated to entity QualityContext.Inspection
      // Note: In production, NCRInitiated event would be published
      // to an event bus for CAPAService subscription
    }
  } with {
    briefly "Processes inspection commands"
    described as {
      | Handles inspection lifecycle from creation through
      | sample collection, testing, evaluation, and disposition.
      | NCR events are published for external CAPA service integration.
    }
  }
} with {
  briefly "Inspection aggregate"
  described as {
    | The Inspection entity manages quality inspections including
    | sample collection, testing, and non-conformance reporting.
  }
}
