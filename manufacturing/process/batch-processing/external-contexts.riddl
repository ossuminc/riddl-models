// Batch Processing - External Contexts

// Recipe Management Service
context RecipeManagement is {

  query GetRecipe is {
    recipeId is RecipeId with { briefly "Recipe ID" described by "Recipe identifier." }
    version is optional String(1, 20) with { briefly "Version" described by "Specific version or latest." }
  } with {
    briefly "Get recipe"
    described by "Retrieves recipe by identifier."
  }

  result RecipeDetails is {
    recipe is Recipe with { briefly "Recipe" described by "Recipe header." }
    ingredients is many BatchIngredient with { briefly "Ingredients" described by "Recipe ingredients." }
    phases is many RecipePhase with { briefly "Phases" described by "Recipe phases." }
    parameters is many ProcessParameter with { briefly "Parameters" described by "Target parameters." }
  } with {
    briefly "Recipe details"
    described by "Complete recipe definition."
  }

  query GetRecipeVersions is {
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
  } with {
    briefly "Get recipe versions"
    described by "Retrieves all versions of a recipe."
  }

  result RecipeVersionList is {
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
    versions is many Recipe with { briefly "Versions" described by "Available versions." }
  } with {
    briefly "Recipe version list"
    described by "List of recipe versions."
  }

  event RecipeUpdated is {
    recipeId is RecipeId with { briefly "Recipe ID" described by "Recipe identifier." }
    newVersion is String(1, 20) with { briefly "Version" described by "New version number." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Recipe updated"
    described by "Emitted when recipe is updated."
  }

} with {
  option is external
  briefly "External recipe management"
  described by "External service managing batch recipes and formulations."
}

// Inventory Service for raw materials
context InventoryService is {

  query GetMaterialLot is {
    ingredientId is IngredientId with { briefly "Ingredient" described by "Ingredient identifier." }
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
  } with {
    briefly "Get material lot"
    described by "Retrieves raw material lot details."
  }

  result MaterialLotDetails is {
    lotId is LotId with { briefly "Lot ID" described by "Lot identifier." }
    lotNumber is String(1, 50) with { briefly "Lot number" described by "Lot number." }
    ingredientId is IngredientId with { briefly "Ingredient" described by "Ingredient ID." }
    ingredientCode is String(1, 50) with { briefly "Code" described by "Material code." }
    quantityOnHand is Decimal(15, 4) with { briefly "On hand" described by "Available quantity." }
    unitOfMeasure is String(1, 20) with { briefly "UOM" described by "Unit of measure." }
    expirationDate is optional Date with { briefly "Expiration" described by "Lot expiration date." }
    qualityStatus is String(1, 50) with { briefly "Status" described by "Quality status." }
    supplierLotNumber is optional String(1, 50) with { briefly "Supplier lot" described by "Supplier lot number." }
  } with {
    briefly "Material lot details"
    described by "Raw material lot information."
  }

  command ReserveMaterial is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Quantity to reserve." }
  } with {
    briefly "Reserve material"
    described by "Reserves raw material for batch."
  }

  event MaterialReserved is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Reserved quantity." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "Reservation time." }
  } with {
    briefly "Material reserved"
    described by "Emitted when material is reserved."
  }

  command ConsumeMaterial is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Quantity consumed." }
    consumedBy is String(1, 200) with { briefly "Consumed by" described by "Person consuming." }
  } with {
    briefly "Consume material"
    described by "Records material consumption."
  }

  event MaterialConsumed is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    lotId is LotId with { briefly "Lot" described by "Lot identifier." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Consumed quantity." }
    consumedAt is TimeStamp with { briefly "Consumed" described by "Consumption time." }
  } with {
    briefly "Material consumed"
    described by "Emitted when material is consumed."
  }

  command ReceiveFinishedBatch is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Quantity produced." }
    lotNumber is String(1, 50) with { briefly "Lot number" described by "New lot number." }
  } with {
    briefly "Receive finished batch"
    described by "Receives completed batch into inventory."
  }

  event BatchReceived is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    newLotId is LotId with { briefly "New lot" described by "New inventory lot." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Batch received"
    described by "Emitted when batch is received into inventory."
  }

} with {
  option is external
  briefly "External inventory service"
  described by "External service managing raw material lots and inventory."
}

// Laboratory Service for quality testing
context LaboratoryService is {

  command RequestSample is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    sampleType is String(1, 50) with { briefly "Type" described by "Sample type." }
    testSuite is String(1, 100) with { briefly "Tests" described by "Tests to perform." }
    requestedBy is String(1, 200) with { briefly "Requested by" described by "Person requesting." }
  } with {
    briefly "Request sample"
    described by "Requests sample collection and testing."
  }

  event SampleRequested is {
    sampleId is UUID with { briefly "Sample ID" described by "Sample identifier." }
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Sample requested"
    described by "Emitted when sample is requested."
  }

  event SampleCollected is {
    sampleId is UUID with { briefly "Sample ID" described by "Sample identifier." }
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    collectedAt is TimeStamp with { briefly "Collected" described by "Collection time." }
    collectedBy is String(1, 200) with { briefly "Collected by" described by "Person collecting." }
  } with {
    briefly "Sample collected"
    described by "Emitted when sample is collected."
  }

  event TestResultsAvailable is {
    sampleId is UUID with { briefly "Sample ID" described by "Sample identifier." }
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    testSuite is String(1, 100) with { briefly "Tests" described by "Test suite performed." }
    passed is Boolean with { briefly "Passed" described by "Whether tests passed." }
    results is many ProcessParameter with { briefly "Results" described by "Test results." }
    testedAt is TimeStamp with { briefly "Tested" described by "Test completion time." }
    testedBy is String(1, 200) with { briefly "Tested by" described by "Person testing." }
  } with {
    briefly "Test results available"
    described by "Emitted when test results are ready."
  }

  query GetCertificateOfAnalysis is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
  } with {
    briefly "Get COA"
    described by "Retrieves certificate of analysis."
  }

  result CertificateOfAnalysis is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    productCode is String(1, 50) with { briefly "Product" described by "Product code." }
    lotNumber is String(1, 50) with { briefly "Lot" described by "Lot number." }
    testResults is many ProcessParameter with { briefly "Results" described by "All test results." }
    overallStatus is String(1, 50) with { briefly "Status" described by "Overall quality status." }
    approvedBy is String(1, 200) with { briefly "Approved by" described by "Person approving." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Certificate of analysis"
    described by "Quality certificate for batch."
  }

  command ReleaseBatchQuality is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    releasedBy is String(1, 200) with { briefly "Released by" described by "Person releasing." }
    releaseNotes is optional String(1, 1000) with { briefly "Notes" described by "Release notes." }
  } with {
    briefly "Release batch quality"
    described by "Releases batch for shipment."
  }

  event BatchQualityReleased is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    releasedBy is String(1, 200) with { briefly "Released by" described by "Person releasing." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
  } with {
    briefly "Batch quality released"
    described by "Emitted when batch quality is released."
  }

  command RejectBatchQuality is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    rejectedBy is String(1, 200) with { briefly "Rejected by" described by "Person rejecting." }
    rejectionReason is String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    dispositionCode is String(1, 50) with { briefly "Disposition" described by "Disposition code." }
  } with {
    briefly "Reject batch quality"
    described by "Rejects batch due to quality failure."
  }

  event BatchQualityRejected is {
    batchId is BatchId with { briefly "Batch" described by "Batch identifier." }
    rejectedBy is String(1, 200) with { briefly "Rejected by" described by "Person rejecting." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
    dispositionCode is String(1, 50) with { briefly "Disposition" described by "Disposition code." }
  } with {
    briefly "Batch quality rejected"
    described by "Emitted when batch quality is rejected."
  }

} with {
  option is external
  briefly "External laboratory service"
  described by "External service for in-process testing and certificate of analysis."
}
