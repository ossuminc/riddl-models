// Batch Processing - External Contexts
// Recipe Management Service
context RecipeManagement is {
  query GetRecipe is  {
    recipeId: RecipeId with {
      briefly "Recipe ID"
      described as {
        |Recipe identifier.
      }
    }
    version: String(1,20)? with {
      briefly "Version"
      described as {
        |Specific version or latest.
      }
    }
  } with {
    briefly "Get recipe"
    described as {
      |Retrieves recipe by identifier.
    }
  }
  result RecipeDetails is  {
    recipe: Recipe with {
      briefly "Recipe"
      described as {
        |Recipe header.
      }
    }
    ingredients: BatchIngredient+ with {
      briefly "Ingredients"
      described as {
        |Recipe ingredients.
      }
    }
    phases: RecipePhase+ with {
      briefly "Phases"
      described as {
        |Recipe phases.
      }
    }
    parameters: ProcessParameter+ with {
      briefly "Parameters"
      described as {
        |Target parameters.
      }
    }
  } with {
    briefly "Recipe details"
    described as {
      |Complete recipe definition.
    }
  }
  query GetRecipeVersions is  {
    productCode: String(1,50) with {
      briefly "Product"
      described as {
        |Product code.
      }
    }
  } with {
    briefly "Get recipe versions"
    described as {
      |Retrieves all versions of a recipe.
    }
  }
  result RecipeVersionList is  {
    productCode: String(1,50) with {
      briefly "Product"
      described as {
        |Product code.
      }
    }
    versions: Recipe+ with {
      briefly "Versions"
      described as {
        |Available versions.
      }
    }
  } with {
    briefly "Recipe version list"
    described as {
      |List of recipe versions.
    }
  }
  event RecipeUpdated is  {
    recipeId: RecipeId with {
      briefly "Recipe ID"
      described as {
        |Recipe identifier.
      }
    }
    newVersion: String(1,20) with {
      briefly "Version"
      described as {
        |New version number.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Recipe updated"
    described as {
      |Emitted when recipe is updated.
    }
  }
} with {
  option external()
  briefly "External recipe management"
  described as {
    |External service managing batch recipes and formulations.
  }
}
// Inventory Service for raw materials
context InventoryService is {
  query GetMaterialLot is  {
    ingredientId: IngredientId with {
      briefly "Ingredient"
      described as {
        |Ingredient identifier.
      }
    }
    lotId: LotId with {
      briefly "Lot"
      described as {
        |Lot identifier.
      }
    }
  } with {
    briefly "Get material lot"
    described as {
      |Retrieves raw material lot details.
    }
  }
  result MaterialLotDetails is  {
    lotId: LotId with {
      briefly "Lot ID"
      described as {
        |Lot identifier.
      }
    }
    lotNumber: String(1,50) with {
      briefly "Lot number"
      described as {
        |Lot number.
      }
    }
    ingredientId: IngredientId with {
      briefly "Ingredient"
      described as {
        |Ingredient ID.
      }
    }
    ingredientCode: String(1,50) with {
      briefly "Code"
      described as {
        |Material code.
      }
    }
    quantityOnHand: Decimal(15,4) with {
      briefly "On hand"
      described as {
        |Available quantity.
      }
    }
    unitOfMeasure: String(1,20) with {
      briefly "UOM"
      described as {
        |Unit of measure.
      }
    }
    expirationDate: Date? with {
      briefly "Expiration"
      described as {
        |Lot expiration date.
      }
    }
    qualityStatus: String(1,50) with {
      briefly "Status"
      described as {
        |Quality status.
      }
    }
    supplierLotNumber: String(1,50)? with {
      briefly "Supplier lot"
      described as {
        |Supplier lot number.
      }
    }
  } with {
    briefly "Material lot details"
    described as {
      |Raw material lot information.
    }
  }
  command ReserveMaterial is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    lotId: LotId with {
      briefly "Lot"
      described as {
        |Lot identifier.
      }
    }
    quantity: Decimal(15,4) with {
      briefly "Quantity"
      described as {
        |Quantity to reserve.
      }
    }
  } with {
    briefly "Reserve material"
    described as {
      |Reserves raw material for batch.
    }
  }
  event MaterialReserved is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    lotId: LotId with {
      briefly "Lot"
      described as {
        |Lot identifier.
      }
    }
    quantity: Decimal(15,4) with {
      briefly "Quantity"
      described as {
        |Reserved quantity.
      }
    }
    reservedAt: TimeStamp with {
      briefly "Reserved"
      described as {
        |Reservation time.
      }
    }
  } with {
    briefly "Material reserved"
    described as {
      |Emitted when material is reserved.
    }
  }
  command ConsumeMaterial is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    lotId: LotId with {
      briefly "Lot"
      described as {
        |Lot identifier.
      }
    }
    quantity: Decimal(15,4) with {
      briefly "Quantity"
      described as {
        |Quantity consumed.
      }
    }
    consumedBy: String(1,200) with {
      briefly "Consumed by"
      described as {
        |Person consuming.
      }
    }
  } with {
    briefly "Consume material"
    described as {
      |Records material consumption.
    }
  }
  event MaterialConsumed is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    lotId: LotId with {
      briefly "Lot"
      described as {
        |Lot identifier.
      }
    }
    quantity: Decimal(15,4) with {
      briefly "Quantity"
      described as {
        |Consumed quantity.
      }
    }
    consumedAt: TimeStamp with {
      briefly "Consumed"
      described as {
        |Consumption time.
      }
    }
  } with {
    briefly "Material consumed"
    described as {
      |Emitted when material is consumed.
    }
  }
  command ReceiveFinishedBatch is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    productCode: String(1,50) with {
      briefly "Product"
      described as {
        |Product code.
      }
    }
    quantity: Decimal(15,4) with {
      briefly "Quantity"
      described as {
        |Quantity produced.
      }
    }
    lotNumber: String(1,50) with {
      briefly "Lot number"
      described as {
        |New lot number.
      }
    }
  } with {
    briefly "Receive finished batch"
    described as {
      |Receives completed batch into inventory.
    }
  }
  event BatchReceived is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    newLotId: LotId with {
      briefly "New lot"
      described as {
        |New inventory lot.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Batch received"
    described as {
      |Emitted when batch is received into inventory.
    }
  }
} with {
  option external()
  briefly "External inventory service"
  described as {
    |External service managing raw material lots and inventory.
  }
}
// Laboratory Service for quality testing
context LaboratoryService is {
  command RequestSample is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    sampleType: String(1,50) with {
      briefly "Type"
      described as {
        |Sample type.
      }
    }
    testSuite: String(1,100) with {
      briefly "Tests"
      described as {
        |Tests to perform.
      }
    }
    requestedBy: String(1,200) with {
      briefly "Requested by"
      described as {
        |Person requesting.
      }
    }
  } with {
    briefly "Request sample"
    described as {
      |Requests sample collection and testing.
    }
  }
  event SampleRequested is  {
    sampleId: UUID with {
      briefly "Sample ID"
      described as {
        |Sample identifier.
      }
    }
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Sample requested"
    described as {
      |Emitted when sample is requested.
    }
  }
  event SampleCollected is  {
    sampleId: UUID with {
      briefly "Sample ID"
      described as {
        |Sample identifier.
      }
    }
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    collectedAt: TimeStamp with {
      briefly "Collected"
      described as {
        |Collection time.
      }
    }
    collectedBy: String(1,200) with {
      briefly "Collected by"
      described as {
        |Person collecting.
      }
    }
  } with {
    briefly "Sample collected"
    described as {
      |Emitted when sample is collected.
    }
  }
  event TestResultsAvailable is  {
    sampleId: UUID with {
      briefly "Sample ID"
      described as {
        |Sample identifier.
      }
    }
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    testSuite: String(1,100) with {
      briefly "Tests"
      described as {
        |Test suite performed.
      }
    }
    passed: Boolean with {
      briefly "Passed"
      described as {
        |Whether tests passed.
      }
    }
    results: ProcessParameter+ with {
      briefly "Results"
      described as {
        |Test results.
      }
    }
    testedAt: TimeStamp with {
      briefly "Tested"
      described as {
        |Test completion time.
      }
    }
    testedBy: String(1,200) with {
      briefly "Tested by"
      described as {
        |Person testing.
      }
    }
  } with {
    briefly "Test results available"
    described as {
      |Emitted when test results are ready.
    }
  }
  query GetCertificateOfAnalysis is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
  } with {
    briefly "Get COA"
    described as {
      |Retrieves certificate of analysis.
    }
  }
  result CertificateOfAnalysis is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    productCode: String(1,50) with {
      briefly "Product"
      described as {
        |Product code.
      }
    }
    lotNumber: String(1,50) with {
      briefly "Lot"
      described as {
        |Lot number.
      }
    }
    testResults: ProcessParameter+ with {
      briefly "Results"
      described as {
        |All test results.
      }
    }
    overallStatus: String(1,50) with {
      briefly "Status"
      described as {
        |Overall quality status.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Person approving.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Certificate of analysis"
    described as {
      |Quality certificate for batch.
    }
  }
  command ReleaseBatchQuality is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    releasedBy: String(1,200) with {
      briefly "Released by"
      described as {
        |Person releasing.
      }
    }
    releaseNotes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Release notes.
      }
    }
  } with {
    briefly "Release batch quality"
    described as {
      |Releases batch for shipment.
    }
  }
  event BatchQualityReleased is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    releasedBy: String(1,200) with {
      briefly "Released by"
      described as {
        |Person releasing.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |Release time.
      }
    }
  } with {
    briefly "Batch quality released"
    described as {
      |Emitted when batch quality is released.
    }
  }
  command RejectBatchQuality is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Person rejecting.
      }
    }
    rejectionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    dispositionCode: String(1,50) with {
      briefly "Disposition"
      described as {
        |Disposition code.
      }
    }
  } with {
    briefly "Reject batch quality"
    described as {
      |Rejects batch due to quality failure.
    }
  }
  event BatchQualityRejected is  {
    batchId: BatchId with {
      briefly "Batch"
      described as {
        |Batch identifier.
      }
    }
    rejectedBy: String(1,200) with {
      briefly "Rejected by"
      described as {
        |Person rejecting.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
    dispositionCode: String(1,50) with {
      briefly "Disposition"
      described as {
        |Disposition code.
      }
    }
  } with {
    briefly "Batch quality rejected"
    described as {
      |Emitted when batch quality is rejected.
    }
  }
} with {
  option external()
  briefly "External laboratory service"
  described as {
    |External service for in-process testing and certificate of analysis.
  }
}
