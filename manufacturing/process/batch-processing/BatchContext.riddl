// Batch Processing - BatchContext

context BatchContext is {

  include "types.riddl"
  include "Batch.riddl"

  // Repository for batch persistence
  repository BatchRepository is {
    schema BatchData is relational
      of batches as Batch
      index on field Batch.batchId
      index on field Batch.recipe.recipeId
      index on field Batch.vessel.vesselId
      index on field Batch.status

    handler BatchPersistence is {
      on event Batch.BatchCreated {
        prompt "Store new batch record"
      }
      on event Batch.IngredientCharged {
        prompt "Store ingredient charge record"
      }
      on event Batch.ProcessingStarted {
        prompt "Update batch to processing"
      }
      on event Batch.ParameterRecorded {
        prompt "Store parameter reading"
      }
      on event Batch.PhaseAdvanced {
        prompt "Update phase completion"
      }
      on event Batch.BatchHeld {
        prompt "Update batch to held status"
      }
      on event Batch.BatchHoldReleased {
        prompt "Update batch from held status"
      }
      on event Batch.BatchDischarged {
        prompt "Store discharge record"
      }
      on event Batch.BatchCompleted {
        prompt "Update batch to completed"
      }
      on event Batch.BatchRejected {
        prompt "Update batch to rejected"
      }
    } with {
      briefly "Persists batch events"
      described by "Handles event-driven persistence for batches."
    }
  } with {
    briefly "Batch data persistence"
    described by {
      | The BatchRepository provides persistent storage for
      | batch records, ingredient charges, and process parameters.
    }
  }

  // Repository for batch genealogy and traceability
  repository GenealogyRepository is {
    schema GenealogyData is relational
      of genealogy as BatchGenealogy
      index on field BatchGenealogy.batchId
      index on field BatchGenealogy.rawMaterialLots

    handler GenealogyPersistence is {
      on event Batch.BatchCreated {
        prompt "Initialize genealogy record"
      }
      on event Batch.IngredientCharged {
        prompt "Link raw material lot to batch"
      }
      on event Batch.BatchCompleted {
        prompt "Finalize genealogy record"
      }
    } with {
      briefly "Persists genealogy data"
      described by "Handles batch traceability persistence."
    }
  } with {
    briefly "Genealogy persistence"
    described by {
      | The GenealogyRepository provides traceability storage
      | linking batches to raw materials and other batches.
    }
  }

  // Projector for batch yield analysis
  projector BatchYieldAnalytics is {
    updates repository BatchRepository

    record YieldMetrics is {
      recipeId is RecipeId with { briefly "Recipe" described by "Recipe identifier." }
      recipeName is String(1, 200) with { briefly "Name" described by "Recipe name." }
      batchCount is Natural with { briefly "Batches" described by "Number of batches." }
      averageYieldPercent is Decimal(5, 2) with { briefly "Avg yield" described by "Average yield percent." }
      minYieldPercent is Decimal(5, 2) with { briefly "Min yield" described by "Minimum yield percent." }
      maxYieldPercent is Decimal(5, 2) with { briefly "Max yield" described by "Maximum yield percent." }
      totalProduced is Decimal(15, 4) with { briefly "Total" described by "Total quantity produced." }
      totalWaste is Decimal(15, 4) with { briefly "Waste" described by "Total waste quantity." }
    } with {
      briefly "Yield metrics"
      described by "Batch yield statistics by recipe."
    }

    handler YieldHandler is {
      on event Batch.BatchCompleted {
        prompt "Update yield metrics for recipe"
      }
      on event Batch.BatchRejected {
        prompt "Update rejection metrics for recipe"
      }
    } with {
      briefly "Maintains yield analytics"
      described by "Projects events into yield analysis views."
    }
  } with {
    briefly "Batch yield projections"
    described by "Maintains batch yield analytics by recipe."
  }

  // Projector for cycle time analysis
  projector CycleTimeAnalytics is {
    updates repository BatchRepository

    record CycleTimeMetrics is {
      vesselId is VesselId with { briefly "Vessel" described by "Vessel identifier." }
      vesselName is String(1, 100) with { briefly "Name" described by "Vessel name." }
      batchCount is Natural with { briefly "Batches" described by "Number of batches." }
      averageCycleTime is Natural with { briefly "Avg cycle" described by "Average cycle time (min)." }
      averageChargingTime is Natural with { briefly "Avg charging" described by "Average charging time (min)." }
      averageProcessingTime is Natural with { briefly "Avg processing" described by "Average processing time (min)." }
      averageDischargeTime is Natural with { briefly "Avg discharge" described by "Average discharge time (min)." }
      totalHoldTime is Natural with { briefly "Hold time" described by "Total hold time (min)." }
    } with {
      briefly "Cycle time metrics"
      described by "Batch cycle time statistics by vessel."
    }

    handler CycleTimeHandler is {
      on event Batch.BatchCreated {
        prompt "Start cycle time tracking"
      }
      on event Batch.ProcessingStarted {
        prompt "Record charging phase duration"
      }
      on event Batch.BatchDischarged {
        prompt "Record processing phase duration"
      }
      on event Batch.BatchCompleted {
        prompt "Finalize cycle time metrics"
      }
      on event Batch.BatchHeld {
        prompt "Start hold time tracking"
      }
      on event Batch.BatchHoldReleased {
        prompt "Record hold duration"
      }
    } with {
      briefly "Maintains cycle time analytics"
      described by "Projects events into cycle time views."
    }
  } with {
    briefly "Cycle time projections"
    described by "Maintains batch cycle time analytics by vessel."
  }

  // Projector for equipment utilization
  projector EquipmentUtilization is {
    updates repository BatchRepository

    record UtilizationMetrics is {
      vesselId is VesselId with { briefly "Vessel" described by "Vessel identifier." }
      vesselName is String(1, 100) with { briefly "Name" described by "Vessel name." }
      periodStart is Date with { briefly "Period start" described by "Analysis period start." }
      periodEnd is Date with { briefly "Period end" described by "Analysis period end." }
      totalAvailableMinutes is Natural with { briefly "Available" described by "Total available minutes." }
      totalOperatingMinutes is Natural with { briefly "Operating" described by "Total operating minutes." }
      utilizationPercent is Decimal(5, 2) with { briefly "Utilization" described by "Utilization percentage." }
      batchCount is Natural with { briefly "Batches" described by "Number of batches run." }
      downtimeMinutes is Natural with { briefly "Downtime" described by "Downtime minutes." }
    } with {
      briefly "Utilization metrics"
      described by "Equipment utilization statistics."
    }

    handler UtilizationHandler is {
      on event Batch.ProcessingStarted {
        prompt "Update vessel utilization start"
      }
      on event Batch.BatchCompleted {
        prompt "Update vessel utilization end"
      }
      on event Batch.BatchRejected {
        prompt "Update vessel utilization with rejection"
      }
    } with {
      briefly "Maintains utilization analytics"
      described by "Projects events into utilization views."
    }
  } with {
    briefly "Equipment utilization projections"
    described by "Maintains vessel utilization analytics."
  }

} with {
  briefly "Bounded context for batch processing"
  described by {
    | The BatchContext is the bounded context for
    | process manufacturing batch operations including
    | recipe execution, parameter tracking, and analytics.
  }
}
