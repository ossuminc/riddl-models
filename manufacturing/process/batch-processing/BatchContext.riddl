// Batch Processing - BatchContext
context BatchContext is {
  include "types.riddl"
  include "Batch.riddl"
  // Repository for batch persistence
  repository BatchRepository is {
    schema BatchData is relational
      of batches as type Batch
        index on field Batch.batchId
        index on field Batch.recipe.recipeId
        index on field Batch.vessel.vesselId
        index on field Batch.status

    handler BatchPersistence is {
      on command Batch.CreateBatch is {
        prompt "Store new batch record"
      }
      on command Batch.ChargeIngredient is {
        prompt "Store ingredient charge record"
      }
      on command Batch.StartProcessing is {
        prompt "Update batch to processing"
      }
      on command Batch.RecordParameter is {
        prompt "Store parameter reading"
      }
      on command Batch.AdvancePhase is {
        prompt "Update phase completion"
      }
      on command Batch.HoldBatch is {
        prompt "Update batch to held status"
      }
      on command Batch.ReleaseBatchHold is {
        prompt "Update batch from held status"
      }
      on command Batch.DischargeBatch is {
        prompt "Store discharge record"
      }
      on command Batch.CompleteBatch is {
        prompt "Update batch to completed"
      }
      on command Batch.RejectBatch is {
        prompt "Update batch to rejected"
      }
    } with {
      briefly "Persists batch commands"
      described as {
        |Handles command-driven persistence for batches.
      }
    }
  } with {
    briefly "Batch data persistence"
    described as {
      | The BatchRepository provides persistent storage for
      | batch records, ingredient charges, and process parameters.
    }
  }
  // Repository for batch genealogy and traceability
  repository GenealogyRepository is {
    schema GenealogyData is relational
      of genealogy as type BatchGenealogy
        index on field BatchGenealogy.batchId
        index on field BatchGenealogy.rawMaterialLots

    handler GenealogyPersistence is {
      on command Batch.CreateBatch is {
        prompt "Initialize genealogy record"
      }
      on command Batch.ChargeIngredient is {
        prompt "Link raw material lot to batch"
      }
      on command Batch.CompleteBatch is {
        prompt "Finalize genealogy record"
      }
    } with {
      briefly "Persists genealogy data"
      described as {
        |Handles batch traceability persistence.
      }
    }
  } with {
    briefly "Genealogy persistence"
    described as {
      | The GenealogyRepository provides traceability storage
      | linking batches to raw materials and other batches.
    }
  }
  // Projector for batch yield analysis
  projector BatchYieldAnalytics is {
    record YieldMetrics is  {
      recipeId: RecipeId with {
        briefly "Recipe"
        described as {
          |Recipe identifier.
        }
      }
      recipeName: String(1,200) with {
        briefly "Name"
        described as {
          |Recipe name.
        }
      }
      batchCount: Natural with {
        briefly "Batches"
        described as {
          |Number of batches.
        }
      }
      averageYieldPercent: Decimal(5,2) with {
        briefly "Avg yield"
        described as {
          |Average yield percent.
        }
      }
      minYieldPercent: Decimal(5,2) with {
        briefly "Min yield"
        described as {
          |Minimum yield percent.
        }
      }
      maxYieldPercent: Decimal(5,2) with {
        briefly "Max yield"
        described as {
          |Maximum yield percent.
        }
      }
      totalProduced: Decimal(15,4) with {
        briefly "Total"
        described as {
          |Total quantity produced.
        }
      }
      totalWaste: Decimal(15,4) with {
        briefly "Waste"
        described as {
          |Total waste quantity.
        }
      }
    } with {
      briefly "Yield metrics"
      described as {
        |Batch yield statistics by recipe.
      }
    }
    handler YieldHandler is {
      on event Batch.BatchCompleted is {
        prompt "Update yield metrics for recipe"
      }
      on event Batch.BatchRejected is {
        prompt "Update rejection metrics for recipe"
      }
    } with {
      briefly "Maintains yield analytics"
      described as {
        |Projects events into yield analysis views.
      }
    }
  } with {
    briefly "Batch yield projections"
    described as {
      |Maintains batch yield analytics by recipe.
    }
  }
  // Projector for cycle time analysis
  projector CycleTimeAnalytics is {
    record CycleTimeMetrics is  {
      vesselId: VesselId with {
        briefly "Vessel"
        described as {
          |Vessel identifier.
        }
      }
      vesselName: String(1,100) with {
        briefly "Name"
        described as {
          |Vessel name.
        }
      }
      batchCount: Natural with {
        briefly "Batches"
        described as {
          |Number of batches.
        }
      }
      averageCycleTime: Natural with {
        briefly "Avg cycle"
        described as {
          |Average cycle time (min).
        }
      }
      averageChargingTime: Natural with {
        briefly "Avg charging"
        described as {
          |Average charging time (min).
        }
      }
      averageProcessingTime: Natural with {
        briefly "Avg processing"
        described as {
          |Average processing time (min).
        }
      }
      averageDischargeTime: Natural with {
        briefly "Avg discharge"
        described as {
          |Average discharge time (min).
        }
      }
      totalHoldTime: Natural with {
        briefly "Hold time"
        described as {
          |Total hold time (min).
        }
      }
    } with {
      briefly "Cycle time metrics"
      described as {
        |Batch cycle time statistics by vessel.
      }
    }
    handler CycleTimeHandler is {
      on event Batch.BatchCreated is {
        prompt "Start cycle time tracking"
      }
      on event Batch.ProcessingStarted is {
        prompt "Record charging phase duration"
      }
      on event Batch.BatchDischarged is {
        prompt "Record processing phase duration"
      }
      on event Batch.BatchCompleted is {
        prompt "Finalize cycle time metrics"
      }
      on event Batch.BatchHeld is {
        prompt "Start hold time tracking"
      }
      on event Batch.BatchHoldReleased is {
        prompt "Record hold duration"
      }
    } with {
      briefly "Maintains cycle time analytics"
      described as {
        |Projects events into cycle time views.
      }
    }
  } with {
    briefly "Cycle time projections"
    described as {
      |Maintains batch cycle time analytics by vessel.
    }
  }
  // Projector for equipment utilization
  projector EquipmentUtilization is {
    record UtilizationMetrics is  {
      vesselId: VesselId with {
        briefly "Vessel"
        described as {
          |Vessel identifier.
        }
      }
      vesselName: String(1,100) with {
        briefly "Name"
        described as {
          |Vessel name.
        }
      }
      periodStart: Date with {
        briefly "Period start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: Date with {
        briefly "Period end"
        described as {
          |Analysis period end.
        }
      }
      totalAvailableMinutes: Natural with {
        briefly "Available"
        described as {
          |Total available minutes.
        }
      }
      totalOperatingMinutes: Natural with {
        briefly "Operating"
        described as {
          |Total operating minutes.
        }
      }
      utilizationPercent: Decimal(5,2) with {
        briefly "Utilization"
        described as {
          |Utilization percentage.
        }
      }
      batchCount: Natural with {
        briefly "Batches"
        described as {
          |Number of batches run.
        }
      }
      downtimeMinutes: Natural with {
        briefly "Downtime"
        described as {
          |Downtime minutes.
        }
      }
    } with {
      briefly "Utilization metrics"
      described as {
        |Equipment utilization statistics.
      }
    }
    handler UtilizationHandler is {
      on event Batch.ProcessingStarted is {
        prompt "Update vessel utilization start"
      }
      on event Batch.BatchCompleted is {
        prompt "Update vessel utilization end"
      }
      on event Batch.BatchRejected is {
        prompt "Update vessel utilization with rejection"
      }
    } with {
      briefly "Maintains utilization analytics"
      described as {
        |Projects events into utilization views.
      }
    }
  } with {
    briefly "Equipment utilization projections"
    described as {
      |Maintains vessel utilization analytics.
    }
  }
} with {
  briefly "Bounded context for batch processing"
  described as {
    | The BatchContext is the bounded context for
    | process manufacturing batch operations including
    | recipe execution, parameter tracking, and analytics.
  }
}
