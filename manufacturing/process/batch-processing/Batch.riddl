// Batch Processing - Batch Entity

entity Batch is {

  // Commands
  command CreateBatch is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "New batch identifier."
    }
    recipe is Recipe with {
      briefly "Recipe"
      described by "Recipe to execute."
    }
    vessel is VesselInfo with {
      briefly "Vessel"
      described by "Processing vessel."
    }
    schedule is BatchScheduleInfo with {
      briefly "Schedule"
      described by "Batch schedule."
    }
    plannedQuantity is Decimal(15, 4) with {
      briefly "Planned quantity"
      described by "Planned batch size."
    }
    createdBy is String(1, 200) with {
      briefly "Created by"
      described by "Person creating batch."
    }
  } with {
    briefly "Create batch"
    described by "Creates a new production batch."
  }

  command ChargeIngredient is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    ingredient is BatchIngredient with {
      briefly "Ingredient"
      described by "Ingredient being charged."
    }
  } with {
    briefly "Charge ingredient"
    described by "Adds an ingredient to the batch."
  }

  command StartProcessing is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    startedBy is String(1, 200) with {
      briefly "Started by"
      described by "Person starting processing."
    }
    initialPhase is RecipePhase with {
      briefly "Initial phase"
      described by "First recipe phase to execute."
    }
  } with {
    briefly "Start processing"
    described by "Begins batch processing."
  }

  command RecordParameter is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    parameter is ProcessParameter with {
      briefly "Parameter"
      described by "Parameter reading."
    }
  } with {
    briefly "Record parameter"
    described by "Records a process parameter value."
  }

  command AdvancePhase is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    completedPhase is RecipePhase with {
      briefly "Completed phase"
      described by "Phase being completed."
    }
    nextPhase is optional RecipePhase with {
      briefly "Next phase"
      described by "Next phase to start."
    }
    advancedBy is String(1, 200) with {
      briefly "Advanced by"
      described by "Person advancing phase."
    }
  } with {
    briefly "Advance phase"
    described by "Completes current phase and starts next."
  }

  command HoldBatch is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    hold is BatchHoldInfo with {
      briefly "Hold"
      described by "Hold information."
    }
  } with {
    briefly "Hold batch"
    described by "Places batch on hold."
  }

  command ReleaseBatchHold is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    releasedBy is String(1, 200) with {
      briefly "Released by"
      described by "Person releasing hold."
    }
    releaseNotes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Release notes."
    }
  } with {
    briefly "Release batch hold"
    described by "Releases batch from hold."
  }

  command DischargeBatch is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    discharge is DischargeInfo with {
      briefly "Discharge"
      described by "Discharge details."
    }
  } with {
    briefly "Discharge batch"
    described by "Discharges product from vessel."
  }

  command CompleteBatch is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    completion is CompletionInfo with {
      briefly "Completion"
      described by "Completion details."
    }
    genealogy is BatchGenealogy with {
      briefly "Genealogy"
      described by "Batch traceability data."
    }
  } with {
    briefly "Complete batch"
    described by "Completes batch production."
  }

  command RejectBatch is {
    batchId is BatchId with {
      briefly "Batch ID"
      described by "Batch identifier."
    }
    rejection is RejectionInfo with {
      briefly "Rejection"
      described by "Rejection details."
    }
  } with {
    briefly "Reject batch"
    described by "Rejects batch due to quality failure."
  }

  // Events
  event BatchCreated is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    recipe is Recipe with { briefly "Recipe" described by "Recipe info." }
    vessel is VesselInfo with { briefly "Vessel" described by "Processing vessel." }
    schedule is BatchScheduleInfo with { briefly "Schedule" described by "Batch schedule." }
    plannedQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Planned batch size." }
    createdBy is String(1, 200) with { briefly "Created by" described by "Person creating." }
    createdAt is TimeStamp with { briefly "Created at" described by "Creation time." }
  } with {
    briefly "Batch created"
    described by "Emitted when batch is created."
  }

  event IngredientCharged is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    ingredient is BatchIngredient with { briefly "Ingredient" described by "Ingredient charged." }
    chargedAt is TimeStamp with { briefly "Charged at" described by "Charge time." }
  } with {
    briefly "Ingredient charged"
    described by "Emitted when ingredient is added."
  }

  event ProcessingStarted is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    startedBy is String(1, 200) with { briefly "Started by" described by "Person starting." }
    startedAt is TimeStamp with { briefly "Started at" described by "Start time." }
    currentPhase is RecipePhase with { briefly "Phase" described by "Current recipe phase." }
  } with {
    briefly "Processing started"
    described by "Emitted when processing begins."
  }

  event ParameterRecorded is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    parameter is ProcessParameter with { briefly "Parameter" described by "Parameter reading." }
  } with {
    briefly "Parameter recorded"
    described by "Emitted when parameter is recorded."
  }

  event PhaseAdvanced is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    completedPhase is RecipePhase with { briefly "Completed" described by "Completed phase." }
    nextPhase is optional RecipePhase with { briefly "Next" described by "Next phase." }
    advancedAt is TimeStamp with { briefly "Advanced at" described by "Advance time." }
  } with {
    briefly "Phase advanced"
    described by "Emitted when phase completes."
  }

  event BatchHeld is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    hold is BatchHoldInfo with { briefly "Hold" described by "Hold information." }
  } with {
    briefly "Batch held"
    described by "Emitted when batch is placed on hold."
  }

  event BatchHoldReleased is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    releasedBy is String(1, 200) with { briefly "Released by" described by "Person releasing." }
    releasedAt is TimeStamp with { briefly "Released at" described by "Release time." }
    releaseNotes is optional String(1, 1000) with { briefly "Notes" described by "Release notes." }
  } with {
    briefly "Batch hold released"
    described by "Emitted when hold is released."
  }

  event BatchDischarged is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    discharge is DischargeInfo with { briefly "Discharge" described by "Discharge details." }
  } with {
    briefly "Batch discharged"
    described by "Emitted when product is discharged."
  }

  event BatchCompleted is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    completion is CompletionInfo with { briefly "Completion" described by "Completion info." }
    genealogy is BatchGenealogy with { briefly "Genealogy" described by "Traceability." }
    completedAt is TimeStamp with { briefly "Completed at" described by "Completion time." }
  } with {
    briefly "Batch completed"
    described by "Emitted when batch completes successfully."
  }

  event BatchRejected is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    rejection is RejectionInfo with { briefly "Rejection" described by "Rejection details." }
    rejectedAt is TimeStamp with { briefly "Rejected at" described by "Rejection time." }
  } with {
    briefly "Batch rejected"
    described by "Emitted when batch is rejected."
  }

  // State Records
  record ScheduledStateData is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    recipe is Recipe with { briefly "Recipe" described by "Recipe to execute." }
    vessel is VesselInfo with { briefly "Vessel" described by "Processing vessel." }
    schedule is BatchScheduleInfo with { briefly "Schedule" described by "Batch schedule." }
    plannedQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Planned quantity." }
    ingredients is many BatchIngredient with { briefly "Ingredients" described by "Required ingredients." }
    chargedIngredients is many optional BatchIngredient with { briefly "Charged" described by "Charged ingredients." }
    batchStatus is BatchStatus with { briefly "Status" described by "Batch status." }
    createdAt is TimeStamp with { briefly "Created at" described by "Creation time." }
    createdBy is String(1, 200) with { briefly "Created by" described by "Creator." }
  } with {
    briefly "Scheduled state"
    described by "State for scheduled batch awaiting start."
  }

  record ProcessingStateData is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    recipe is Recipe with { briefly "Recipe" described by "Recipe being executed." }
    vessel is VesselInfo with { briefly "Vessel" described by "Processing vessel." }
    schedule is BatchScheduleInfo with { briefly "Schedule" described by "Batch schedule." }
    plannedQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Planned quantity." }
    ingredients is many BatchIngredient with { briefly "Ingredients" described by "All ingredients." }
    phases is many RecipePhase with { briefly "Phases" described by "Recipe phases." }
    currentPhase is RecipePhase with { briefly "Current phase" described by "Active phase." }
    recordedParameters is many optional ProcessParameter with { briefly "Parameters" described by "Recorded parameters." }
    currentHold is optional BatchHoldInfo with { briefly "Hold" described by "Hold info if held." }
    batchStatus is BatchStatus with { briefly "Status" described by "Batch status." }
    processingStartedAt is TimeStamp with { briefly "Started at" described by "Processing start." }
  } with {
    briefly "Processing state"
    described by "State for batch under active processing."
  }

  record CompletedStateData is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    recipe is Recipe with { briefly "Recipe" described by "Recipe executed." }
    vessel is VesselInfo with { briefly "Vessel" described by "Processing vessel." }
    completion is CompletionInfo with { briefly "Completion" described by "Completion info." }
    genealogy is BatchGenealogy with { briefly "Genealogy" described by "Traceability." }
    ingredients is many BatchIngredient with { briefly "Ingredients" described by "All ingredients." }
    parameters is many ProcessParameter with { briefly "Parameters" described by "All parameters." }
    discharges is many DischargeInfo with { briefly "Discharges" described by "Discharge records." }
    batchStatus is BatchStatus with { briefly "Status" described by "Batch status." }
    batchCompletedAt is TimeStamp with { briefly "Completed at" described by "Completion time." }
  } with {
    briefly "Completed state"
    described by "State for successfully completed batch."
  }

  record RejectedStateData is {
    batchId is BatchId with { briefly "Batch ID" described by "Batch identifier." }
    recipe is Recipe with { briefly "Recipe" described by "Recipe attempted." }
    vessel is VesselInfo with { briefly "Vessel" described by "Processing vessel." }
    rejection is RejectionInfo with { briefly "Rejection" described by "Rejection details." }
    ingredients is many BatchIngredient with { briefly "Ingredients" described by "Ingredients used." }
    parameters is many ProcessParameter with { briefly "Parameters" described by "Parameters recorded." }
    batchStatus is BatchStatus with { briefly "Status" described by "Batch status." }
    rejectedAt is TimeStamp with { briefly "Rejected at" described by "Rejection time." }
  } with {
    briefly "Rejected state"
    described by "State for rejected batch."
  }

  // States
  state ScheduledState of Batch.ScheduledStateData with {
    briefly "Batch scheduled"
    described by "Batch is scheduled and awaiting start."
  }

  state ProcessingState of Batch.ProcessingStateData with {
    briefly "Batch processing"
    described by "Batch is under active processing."
  }

  state CompletedState of Batch.CompletedStateData with {
    briefly "Batch completed"
    described by "Batch has completed successfully."
  }

  state RejectedState of Batch.RejectedStateData with {
    briefly "Batch rejected"
    described by "Batch has been rejected."
  }

  // Handler
  handler BatchHandler is {
    on command CreateBatch {
      morph entity BatchContext.Batch to state BatchContext.Batch.ScheduledState with command CreateBatch
      tell event BatchCreated to entity BatchContext.Batch
    }

    on command ChargeIngredient {
      tell event IngredientCharged to entity BatchContext.Batch
    }

    on command StartProcessing {
      morph entity BatchContext.Batch to state BatchContext.Batch.ProcessingState with command StartProcessing
      tell event ProcessingStarted to entity BatchContext.Batch
    }

    on command RecordParameter {
      tell event ParameterRecorded to entity BatchContext.Batch
    }

    on command AdvancePhase {
      tell event PhaseAdvanced to entity BatchContext.Batch
    }

    on command HoldBatch {
      tell event BatchHeld to entity BatchContext.Batch
    }

    on command ReleaseBatchHold {
      tell event BatchHoldReleased to entity BatchContext.Batch
    }

    on command DischargeBatch {
      tell event BatchDischarged to entity BatchContext.Batch
    }

    on command CompleteBatch {
      morph entity BatchContext.Batch to state BatchContext.Batch.CompletedState with command CompleteBatch
      tell event BatchCompleted to entity BatchContext.Batch
    }

    on command RejectBatch {
      morph entity BatchContext.Batch to state BatchContext.Batch.RejectedState with command RejectBatch
      tell event BatchRejected to entity BatchContext.Batch
    }
  } with {
    briefly "Processes batch commands"
    described by {
      | Handles batch lifecycle from creation through
      | ingredient charging, processing, and completion or rejection.
    }
  }

} with {
  briefly "Batch aggregate"
  described by {
    | The Batch entity manages production batch lifecycle
    | including recipe execution, ingredient charging,
    | parameter recording, and product discharge.
  }
}
