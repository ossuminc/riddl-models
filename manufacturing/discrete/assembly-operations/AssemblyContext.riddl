// Assembly Operations - Assembly Context

context AssemblyContext is {

  include "types.riddl"
  include "AssemblyOrder.riddl"

  // Repository for assembly order persistence
  repository AssemblyOrderRepository is {
    schema AssemblyOrderData is relational
      of assemblyOrders as AssemblyOrder
      index on field AssemblyOrder.assemblyOrderId
      index on field AssemblyOrder.workOrderId
      index on field AssemblyOrder.status
      index on field AssemblyOrder.workStation.workStationId

    handler AssemblyPersistence is {
      on event AssemblyOrder.AssemblyOrderCreated {
        prompt "Store new assembly order"
      }
      on event AssemblyOrder.AssemblyStarted {
        prompt "Update to in progress"
      }
      on event AssemblyOrder.StepCompleted {
        prompt "Update step completion"
      }
      on event AssemblyOrder.DefectRecorded {
        prompt "Store defect record"
      }
      on event AssemblyOrder.AssemblyCompleted {
        prompt "Update to completed"
      }
      on event AssemblyOrder.AssemblyHeld {
        prompt "Update to on hold"
      }
      on event AssemblyOrder.HoldReleased {
        prompt "Update hold release"
      }
      on event AssemblyOrder.AssemblyFailed {
        prompt "Update to failed"
      }
    } with {
      briefly "Persists assembly order events"
      described by "Handles event-driven persistence for assembly orders."
    }
  } with {
    briefly "Assembly order data persistence"
    described by {
      | The AssemblyOrderRepository provides persistent storage for
      | assembly orders, steps, quality checks, and defect records.
    }
  }

  // Projector for assembly line analytics
  projector AssemblyLineAnalytics is {
    updates repository AssemblyOrderRepository

    record ThroughputMetrics is {
      date is Date with { briefly "Date" described by "Metrics date." }
      workStationId is WorkStationId with { briefly "Station" described by "Work station." }
      unitsStarted is Natural with { briefly "Started" described by "Units started." }
      unitsCompleted is Natural with { briefly "Completed" described by "Units completed." }
      unitsFailed is Natural with { briefly "Failed" described by "Units failed." }
      unitsPerHour is Decimal(8, 2) with { briefly "UPH" described by "Units per hour." }
    } with {
      briefly "Throughput metrics"
      described by "Assembly line throughput statistics."
    }

    record FirstPassYield is {
      date is Date with { briefly "Date" described by "Metrics date." }
      workStationId is WorkStationId with { briefly "Station" described by "Work station." }
      totalUnits is Natural with { briefly "Total" described by "Total units inspected." }
      passedFirst is Natural with { briefly "Passed" described by "Passed first inspection." }
      yieldRate is Decimal(5, 4) with { briefly "FPY" described by "First pass yield rate." }
    } with {
      briefly "First pass yield"
      described by "Quality metrics for first-time pass rate."
    }

    record CycleTimeMetrics is {
      date is Date with { briefly "Date" described by "Metrics date." }
      workStationId is WorkStationId with { briefly "Station" described by "Work station." }
      productId is ProductId with { briefly "Product" described by "Product ID." }
      averageCycleTime is Natural with { briefly "Avg cycle" described by "Average cycle time (minutes)." }
      minCycleTime is Natural with { briefly "Min cycle" described by "Minimum cycle time (minutes)." }
      maxCycleTime is Natural with { briefly "Max cycle" described by "Maximum cycle time (minutes)." }
      standardDeviation is Decimal(8, 2) with { briefly "Std dev" described by "Standard deviation." }
    } with {
      briefly "Cycle time metrics"
      described by "Assembly cycle time statistics."
    }

    record DefectTrend is {
      date is Date with { briefly "Date" described by "Metrics date." }
      workStationId is WorkStationId with { briefly "Station" described by "Work station." }
      defectCode is String(1, 50) with { briefly "Code" described by "Defect code." }
      occurrences is Natural with { briefly "Count" described by "Number of occurrences." }
      percentOfTotal is Decimal(5, 4) with { briefly "Percent" described by "Percent of total defects." }
    } with {
      briefly "Defect trend"
      described by "Defect occurrence trends by code."
    }

    handler AnalyticsHandler is {
      on event AssemblyOrder.AssemblyStarted {
        prompt "Update units started count"
      }
      on event AssemblyOrder.AssemblyCompleted {
        prompt "Update throughput and yield metrics"
      }
      on event AssemblyOrder.AssemblyFailed {
        prompt "Update failure metrics"
      }
      on event AssemblyOrder.StepCompleted {
        prompt "Update cycle time metrics"
      }
      on event AssemblyOrder.DefectRecorded {
        prompt "Update defect trends"
      }
    } with {
      briefly "Maintains assembly analytics"
      described by "Projects events into analytics views for line performance."
    }
  } with {
    briefly "Assembly line analytics projections"
    described by {
      | Maintains assembly line analytics including throughput,
      | first-pass yield, cycle time, and defect trends.
    }
  }

} with {
  briefly "Bounded context for assembly operations"
  described by {
    | The AssemblyContext is the bounded context for
    | manufacturing assembly line operations, tracking
    | assembly orders, steps, quality, and performance.
  }
}
