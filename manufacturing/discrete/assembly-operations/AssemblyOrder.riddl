// Assembly Operations - AssemblyOrder Entity
entity AssemblyOrder is {
  // Commands
  command CreateAssemblyOrder is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |New assembly order identifier.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work Order ID"
      described as {
        |Parent work order reference.
      }
    }
    product: ProductInfo with {
      briefly "Product"
      described as {
        |Product to assemble.
      }
    }
    workStation: WorkStationInfo with {
      briefly "Work station"
      described as {
        |Assigned work station.
      }
    }
    steps: AssemblyStep+ with {
      briefly "Steps"
      described as {
        |Assembly steps to execute.
      }
    }
    components: ComponentInfo+ with {
      briefly "Components"
      described as {
        |Required components.
      }
    }
    dueDate: Date with {
      briefly "Due date"
      described as {
        |Assembly due date.
      }
    }
  } with {
    briefly "Create assembly order"
    described as {
      |Creates a new assembly order for a product.
    }
  }
  command StartAssembly is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    operatorId: String(1,100) with {
      briefly "Operator"
      described as {
        |Operator starting assembly.
      }
    }
    operatorName: String(1,200) with {
      briefly "Operator name"
      described as {
        |Operator full name.
      }
    }
  } with {
    briefly "Start assembly"
    described as {
      |Starts assembly work on an order.
    }
  }
  command CompleteStep is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    stepNumber: Natural with {
      briefly "Step"
      described as {
        |Step number being completed.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Operator completing step.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Operator notes.
      }
    }
  } with {
    briefly "Complete step"
    described as {
      |Marks an assembly step as completed.
    }
  }
  command RecordDefect is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    defect: DefectInfo with {
      briefly "Defect"
      described as {
        |Defect information.
      }
    }
  } with {
    briefly "Record defect"
    described as {
      |Records a defect found during assembly or inspection.
    }
  }
  command CompleteAssembly is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    completion: CompletionInfo with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
    qualityChecks: QualityCheck+ with {
      briefly "Quality checks"
      described as {
        |Final quality inspection results.
      }
    }
  } with {
    briefly "Complete assembly"
    described as {
      |Completes the assembly order after quality check.
    }
  }
  command HoldAssembly is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    hold: HoldInfo with {
      briefly "Hold"
      described as {
        |Hold information.
      }
    }
  } with {
    briefly "Hold assembly"
    described as {
      |Places assembly order on hold.
    }
  }
  command ReleaseHold is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    releasedBy: String(1,200) with {
      briefly "Released by"
      described as {
        |Person releasing hold.
      }
    }
  } with {
    briefly "Release hold"
    described as {
      |Releases assembly order from hold.
    }
  }
  command FailAssembly is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order ID"
      described as {
        |Assembly order identifier.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedBy: String(1,200) with {
      briefly "Failed by"
      described as {
        |Person marking failure.
      }
    }
  } with {
    briefly "Fail assembly"
    described as {
      |Marks assembly order as failed.
    }
  }
  // Events
  event AssemblyOrderCreated is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work Order"
      described as {
        |Parent work order ID.
      }
    }
    product: ProductInfo with {
      briefly "Product"
      described as {
        |Product info.
      }
    }
    workStation: WorkStationInfo with {
      briefly "Work station"
      described as {
        |Assigned station.
      }
    }
    stepCount: Natural with {
      briefly "Steps"
      described as {
        |Number of assembly steps.
      }
    }
    componentCount: Natural with {
      briefly "Components"
      described as {
        |Number of components.
      }
    }
    dueDate: Date with {
      briefly "Due"
      described as {
        |Due date.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Assembly order created"
    described as {
      |Emitted when assembly order is created.
    }
  }
  event AssemblyStarted is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    operatorId: String(1,100) with {
      briefly "Operator"
      described as {
        |Operator ID.
      }
    }
    operatorName: String(1,200) with {
      briefly "Operator name"
      described as {
        |Operator name.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Assembly started"
    described as {
      |Emitted when assembly work begins.
    }
  }
  event StepCompleted is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    stepNumber: Natural with {
      briefly "Step"
      described as {
        |Completed step number.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Operator name.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Operator notes.
      }
    }
  } with {
    briefly "Step completed"
    described as {
      |Emitted when an assembly step is completed.
    }
  }
  event DefectRecorded is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    defect: DefectInfo with {
      briefly "Defect"
      described as {
        |Defect details.
      }
    }
  } with {
    briefly "Defect recorded"
    described as {
      |Emitted when a defect is recorded.
    }
  }
  event AssemblyCompleted is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    completion: CompletionInfo with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
    qualityCheckCount: Natural with {
      briefly "Checks"
      described as {
        |Number of quality checks.
      }
    }
    defectCount: Natural with {
      briefly "Defects"
      described as {
        |Number of defects found.
      }
    }
  } with {
    briefly "Assembly completed"
    described as {
      |Emitted when assembly order is completed.
    }
  }
  event AssemblyHeld is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    hold: HoldInfo with {
      briefly "Hold"
      described as {
        |Hold information.
      }
    }
  } with {
    briefly "Assembly held"
    described as {
      |Emitted when assembly is placed on hold.
    }
  }
  event HoldReleased is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    releasedBy: String(1,200) with {
      briefly "Released by"
      described as {
        |Person releasing.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |Release time.
      }
    }
  } with {
    briefly "Hold released"
    described as {
      |Emitted when hold is released.
    }
  }
  event AssemblyFailed is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedBy: String(1,200) with {
      briefly "Failed by"
      described as {
        |Person marking failure.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Assembly failed"
    described as {
      |Emitted when assembly order fails.
    }
  }
  // State Records
  record ActiveStateData is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work Order"
      described as {
        |Parent work order ID.
      }
    }
    product: ProductInfo with {
      briefly "Product"
      described as {
        |Product being assembled.
      }
    }
    workStation: WorkStationInfo with {
      briefly "Work station"
      described as {
        |Assigned station.
      }
    }
    steps: AssemblyStep+ with {
      briefly "Steps"
      described as {
        |Assembly steps.
      }
    }
    components: ComponentInfo+ with {
      briefly "Components"
      described as {
        |Required components.
      }
    }
    currentQualityChecks: QualityCheck* with {
      briefly "Quality checks"
      described as {
        |Quality inspections.
      }
    }
    defects: DefectInfo* with {
      briefly "Defects"
      described as {
        |Recorded defects.
      }
    }
    assemblyStatus: AssemblyStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    currentStep: Natural with {
      briefly "Current step"
      described as {
        |Current step number.
      }
    }
    currentOperatorId: String(1,100)? with {
      briefly "Operator"
      described as {
        |Current operator ID.
      }
    }
    currentOperatorName: String(1,200)? with {
      briefly "Operator name"
      described as {
        |Current operator name.
      }
    }
    currentHold: HoldInfo? with {
      briefly "Hold"
      described as {
        |Hold info if on hold.
      }
    }
    dueDate: Date with {
      briefly "Due"
      described as {
        |Due date.
      }
    }
    assemblyStartedAt: TimeStamp? with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active assembly order.
    }
  }
  record CompletedStateData is  {
    assemblyOrderId: AssemblyOrderId with {
      briefly "Assembly Order"
      described as {
        |Assembly order ID.
      }
    }
    workOrderId: WorkOrderId with {
      briefly "Work Order"
      described as {
        |Parent work order ID.
      }
    }
    product: ProductInfo with {
      briefly "Product"
      described as {
        |Assembled product.
      }
    }
    workStation: WorkStationInfo with {
      briefly "Work station"
      described as {
        |Assembly station.
      }
    }
    completion: CompletionInfo with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
    qualityChecks: QualityCheck+ with {
      briefly "Quality checks"
      described as {
        |Final quality checks.
      }
    }
    defects: DefectInfo* with {
      briefly "Defects"
      described as {
        |Recorded defects.
      }
    }
    totalSteps: Natural with {
      briefly "Total steps"
      described as {
        |Total assembly steps.
      }
    }
    completedSteps: Natural with {
      briefly "Completed steps"
      described as {
        |Steps completed.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |State for completed assembly order.
    }
  }
  // States
  state ActiveState of type AssemblyOrder.ActiveStateData
  state CompletedState of type AssemblyOrder.CompletedStateData
  // Handler
  handler AssemblyOrderHandler is {
    on command CreateAssemblyOrder is {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.ActiveState with command CreateAssemblyOrder
      tell event AssemblyOrderCreated to entity AssemblyContext.AssemblyOrder
    }
    on command StartAssembly is {
      tell event AssemblyStarted to entity AssemblyContext.AssemblyOrder
    }
    on command CompleteStep is {
      tell event StepCompleted to entity AssemblyContext.AssemblyOrder
    }
    on command AssemblyOrder.RecordDefect is {
      tell event DefectRecorded to entity AssemblyContext.AssemblyOrder
      tell command QualityService.RecordDefect to context QualityService
    }
    on command CompleteAssembly is {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.CompletedState with command CompleteAssembly
      tell event AssemblyCompleted to entity AssemblyContext.AssemblyOrder
      tell command WorkOrderService.ReportAssemblyComplete to context WorkOrderService
    }
    on command HoldAssembly is {
      tell event AssemblyHeld to entity AssemblyContext.AssemblyOrder
    }
    on command ReleaseHold is {
      tell event HoldReleased to entity AssemblyContext.AssemblyOrder
    }
    on command FailAssembly is {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.CompletedState with command FailAssembly
      tell event AssemblyFailed to entity AssemblyContext.AssemblyOrder
      tell command QualityService.RecordFailure to context QualityService
    }
  } with {
    briefly "Processes assembly order commands"
    described as {
      | Handles assembly order lifecycle from creation
      | through step execution, quality checks, and completion.
    }
  }
} with {
  briefly "AssemblyOrder aggregate"
  described as {
    | The AssemblyOrder entity manages individual assembly orders
    | on the production line, tracking steps, components, quality,
    | and defects through the assembly process.
  }
}
