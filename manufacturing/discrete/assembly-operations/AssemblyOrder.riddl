// Assembly Operations - AssemblyOrder Entity

entity AssemblyOrder is {

  // Commands
  command CreateAssemblyOrder is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "New assembly order identifier."
    }
    workOrderId is WorkOrderId with {
      briefly "Work Order ID"
      described by "Parent work order reference."
    }
    product is ProductInfo with {
      briefly "Product"
      described by "Product to assemble."
    }
    workStation is WorkStationInfo with {
      briefly "Work station"
      described by "Assigned work station."
    }
    steps is many AssemblyStep with {
      briefly "Steps"
      described by "Assembly steps to execute."
    }
    components is many ComponentInfo with {
      briefly "Components"
      described by "Required components."
    }
    dueDate is Date with {
      briefly "Due date"
      described by "Assembly due date."
    }
  } with {
    briefly "Create assembly order"
    described by "Creates a new assembly order for a product."
  }

  command StartAssembly is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    operatorId is String(1, 100) with {
      briefly "Operator"
      described by "Operator starting assembly."
    }
    operatorName is String(1, 200) with {
      briefly "Operator name"
      described by "Operator full name."
    }
  } with {
    briefly "Start assembly"
    described by "Starts assembly work on an order."
  }

  command CompleteStep is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    stepNumber is Natural with {
      briefly "Step"
      described by "Step number being completed."
    }
    completedBy is String(1, 200) with {
      briefly "Completed by"
      described by "Operator completing step."
    }
    notes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Operator notes."
    }
  } with {
    briefly "Complete step"
    described by "Marks an assembly step as completed."
  }

  command RecordDefect is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    defect is DefectInfo with {
      briefly "Defect"
      described by "Defect information."
    }
  } with {
    briefly "Record defect"
    described by "Records a defect found during assembly or inspection."
  }

  command CompleteAssembly is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    completion is CompletionInfo with {
      briefly "Completion"
      described by "Completion details."
    }
    qualityChecks is many QualityCheck with {
      briefly "Quality checks"
      described by "Final quality inspection results."
    }
  } with {
    briefly "Complete assembly"
    described by "Completes the assembly order after quality check."
  }

  command HoldAssembly is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    hold is HoldInfo with {
      briefly "Hold"
      described by "Hold information."
    }
  } with {
    briefly "Hold assembly"
    described by "Places assembly order on hold."
  }

  command ReleaseHold is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    releasedBy is String(1, 200) with {
      briefly "Released by"
      described by "Person releasing hold."
    }
  } with {
    briefly "Release hold"
    described by "Releases assembly order from hold."
  }

  command FailAssembly is {
    assemblyOrderId is AssemblyOrderId with {
      briefly "Assembly Order ID"
      described by "Assembly order identifier."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Failure reason."
    }
    failedBy is String(1, 200) with {
      briefly "Failed by"
      described by "Person marking failure."
    }
  } with {
    briefly "Fail assembly"
    described by "Marks assembly order as failed."
  }

  // Events
  event AssemblyOrderCreated is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Parent work order ID." }
    product is ProductInfo with { briefly "Product" described by "Product info." }
    workStation is WorkStationInfo with { briefly "Work station" described by "Assigned station." }
    stepCount is Natural with { briefly "Steps" described by "Number of assembly steps." }
    componentCount is Natural with { briefly "Components" described by "Number of components." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Assembly order created"
    described by "Emitted when assembly order is created."
  }

  event AssemblyStarted is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    operatorId is String(1, 100) with { briefly "Operator" described by "Operator ID." }
    operatorName is String(1, 200) with { briefly "Operator name" described by "Operator name." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Assembly started"
    described by "Emitted when assembly work begins."
  }

  event StepCompleted is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    stepNumber is Natural with { briefly "Step" described by "Completed step number." }
    completedBy is String(1, 200) with { briefly "Completed by" described by "Operator name." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
    notes is optional String(1, 1000) with { briefly "Notes" described by "Operator notes." }
  } with {
    briefly "Step completed"
    described by "Emitted when an assembly step is completed."
  }

  event DefectRecorded is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    defect is DefectInfo with { briefly "Defect" described by "Defect details." }
  } with {
    briefly "Defect recorded"
    described by "Emitted when a defect is recorded."
  }

  event AssemblyCompleted is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    completion is CompletionInfo with { briefly "Completion" described by "Completion details." }
    qualityCheckCount is Natural with { briefly "Checks" described by "Number of quality checks." }
    defectCount is Natural with { briefly "Defects" described by "Number of defects found." }
  } with {
    briefly "Assembly completed"
    described by "Emitted when assembly order is completed."
  }

  event AssemblyHeld is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    hold is HoldInfo with { briefly "Hold" described by "Hold information." }
  } with {
    briefly "Assembly held"
    described by "Emitted when assembly is placed on hold."
  }

  event HoldReleased is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    releasedBy is String(1, 200) with { briefly "Released by" described by "Person releasing." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
  } with {
    briefly "Hold released"
    described by "Emitted when hold is released."
  }

  event AssemblyFailed is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Failure reason." }
    failedBy is String(1, 200) with { briefly "Failed by" described by "Person marking failure." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Assembly failed"
    described by "Emitted when assembly order fails."
  }

  // State Records
  record ActiveStateData is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Parent work order ID." }
    product is ProductInfo with { briefly "Product" described by "Product being assembled." }
    workStation is WorkStationInfo with { briefly "Work station" described by "Assigned station." }
    steps is many AssemblyStep with { briefly "Steps" described by "Assembly steps." }
    components is many ComponentInfo with { briefly "Components" described by "Required components." }
    currentQualityChecks is many optional QualityCheck with { briefly "Quality checks" described by "Quality inspections." }
    defects is many optional DefectInfo with { briefly "Defects" described by "Recorded defects." }
    assemblyStatus is AssemblyStatus with { briefly "Status" described by "Current status." }
    currentStep is Natural with { briefly "Current step" described by "Current step number." }
    currentOperatorId is optional String(1, 100) with { briefly "Operator" described by "Current operator ID." }
    currentOperatorName is optional String(1, 200) with { briefly "Operator name" described by "Current operator name." }
    currentHold is optional HoldInfo with { briefly "Hold" described by "Hold info if on hold." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    assemblyStartedAt is optional TimeStamp with { briefly "Started" described by "Start time." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active assembly order."
  }

  record CompletedStateData is {
    assemblyOrderId is AssemblyOrderId with { briefly "Assembly Order" described by "Assembly order ID." }
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Parent work order ID." }
    product is ProductInfo with { briefly "Product" described by "Assembled product." }
    workStation is WorkStationInfo with { briefly "Work station" described by "Assembly station." }
    completion is CompletionInfo with { briefly "Completion" described by "Completion details." }
    qualityChecks is many QualityCheck with { briefly "Quality checks" described by "Final quality checks." }
    defects is many optional DefectInfo with { briefly "Defects" described by "Recorded defects." }
    totalSteps is Natural with { briefly "Total steps" described by "Total assembly steps." }
    completedSteps is Natural with { briefly "Completed steps" described by "Steps completed." }
  } with {
    briefly "Completed state"
    described by "State for completed assembly order."
  }

  // States
  state ActiveState of AssemblyOrder.ActiveStateData with {
    briefly "Assembly order active"
    described by "Assembly order is pending or in progress."
  }

  state CompletedState of AssemblyOrder.CompletedStateData with {
    briefly "Assembly order completed"
    described by "Assembly order has been completed or failed."
  }

  // Handler
  handler AssemblyOrderHandler is {
    on command CreateAssemblyOrder {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.ActiveState with command CreateAssemblyOrder
      tell event AssemblyOrderCreated to entity AssemblyContext.AssemblyOrder
    }

    on command StartAssembly {
      tell event AssemblyStarted to entity AssemblyContext.AssemblyOrder
    }

    on command CompleteStep {
      tell event StepCompleted to entity AssemblyContext.AssemblyOrder
    }

    on command AssemblyOrder.RecordDefect {
      tell event DefectRecorded to entity AssemblyContext.AssemblyOrder
      tell command QualityService.RecordDefect to context QualityService
    }

    on command CompleteAssembly {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.CompletedState with command CompleteAssembly
      tell event AssemblyCompleted to entity AssemblyContext.AssemblyOrder
      tell command WorkOrderService.ReportAssemblyComplete to context WorkOrderService
    }

    on command HoldAssembly {
      tell event AssemblyHeld to entity AssemblyContext.AssemblyOrder
    }

    on command ReleaseHold {
      tell event HoldReleased to entity AssemblyContext.AssemblyOrder
    }

    on command FailAssembly {
      morph entity AssemblyContext.AssemblyOrder to state AssemblyContext.AssemblyOrder.CompletedState with command FailAssembly
      tell event AssemblyFailed to entity AssemblyContext.AssemblyOrder
      tell command QualityService.RecordFailure to context QualityService
    }
  } with {
    briefly "Processes assembly order commands"
    described by {
      | Handles assembly order lifecycle from creation
      | through step execution, quality checks, and completion.
    }
  }

} with {
  briefly "AssemblyOrder aggregate"
  described by {
    | The AssemblyOrder entity manages individual assembly orders
    | on the production line, tracking steps, components, quality,
    | and defects through the assembly process.
  }
}
