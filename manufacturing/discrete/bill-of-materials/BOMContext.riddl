// Bill of Materials Management - BOM Context
context BOMContext is {
  include "types.riddl"
  include "BillOfMaterials.riddl"
  // Repository for BOM persistence
  repository BOMRepository is {
    schema BOMData is relational
      of boms as type BillOfMaterials
        index on field BillOfMaterials.bomId
        index on field BillOfMaterials.header.productId
        index on field BillOfMaterials.header.revision
        index on field BillOfMaterials.header.status

    handler BOMPersistence is {
      on command BillOfMaterials.CreateBOM is {
        prompt "Store new bill of materials"
      }
      on command BillOfMaterials.AddItem is {
        prompt "Store added component item"
      }
      on command BillOfMaterials.RemoveItem is {
        prompt "Remove component item from storage"
      }
      on command BillOfMaterials.UpdateQuantity is {
        prompt "Update item quantity"
      }
      on command BillOfMaterials.UpdateItem is {
        prompt "Update item details"
      }
      on command BillOfMaterials.ReleaseBOM is {
        prompt "Update BOM status to released"
      }
      on command BillOfMaterials.ReviseBOM is {
        prompt "Store new revision with history"
      }
      on command BillOfMaterials.ObsoleteBOM is {
        prompt "Update BOM status to obsolete"
      }
      on command BillOfMaterials.CalculateCost is {
        prompt "Store cost rollup data"
      }
    } with {
      briefly "Persists BOM commands"
      described as {
        |Handles command-driven persistence for BOMs.
      }
    }
  } with {
    briefly "BOM data persistence"
    described as {
      | The BOMRepository provides persistent storage for
      | bills of materials, items, revisions, and costs.
    }
  }
  // Projector for BOM analytics
  projector BOMAnalytics is {
    record ComponentUsageStats is  {
      totalComponents: Natural with {
        briefly "Total components"
        described as {
          |Total unique components across all BOMs.
        }
      }
      averageItemsPerBOM: Decimal(10,2) with {
        briefly "Avg items"
        described as {
          |Average line items per BOM.
        }
      }
      mostUsedComponents: ComponentId+ with {
        briefly "Most used"
        described as {
          |Top 10 most frequently used components.
        }
      }
      singleSourceComponents: ComponentId+ with {
        briefly "Single source"
        described as {
          |Components with only one supplier.
        }
      }
    } with {
      briefly "Component usage statistics"
      described as {
        |Analytics on component usage patterns.
      }
    }
    record CostAnalytics is  {
      averageMaterialCost: Decimal(15,4) with {
        briefly "Avg material"
        described as {
          |Average material cost across BOMs.
        }
      }
      averageLaborCost: Decimal(15,4) with {
        briefly "Avg labor"
        described as {
          |Average labor cost across BOMs.
        }
      }
      costVariancePercent: Decimal(5,2) with {
        briefly "Variance"
        described as {
          |Cost variance from standard.
        }
      }
      highCostItems: ItemId+ with {
        briefly "High cost items"
        described as {
          |Items exceeding cost threshold.
        }
      }
    } with {
      briefly "Cost analytics"
      described as {
        |Cost analysis metrics.
      }
    }
    record RevisionMetrics is  {
      averageRevisionsPerBOM: Decimal(5,2) with {
        briefly "Avg revisions"
        described as {
          |Average revisions per BOM.
        }
      }
      revisionsThisMonth: Natural with {
        briefly "Monthly revisions"
        described as {
          |Number of revisions this month.
        }
      }
      topChangedBOMs: BOMId+ with {
        briefly "Most changed"
        described as {
          |BOMs with most revisions.
        }
      }
    } with {
      briefly "Revision metrics"
      described as {
        |BOM revision analytics.
      }
    }
    handler AnalyticsHandler is {
      on event BillOfMaterials.BOMCreated is {
        prompt "Update BOM counts and statistics"
      }
      on event BillOfMaterials.ItemAdded is {
        prompt "Update component usage counts"
      }
      on event BillOfMaterials.ItemRemoved is {
        prompt "Update component usage counts"
      }
      on event BillOfMaterials.CostCalculated is {
        prompt "Update cost analytics"
      }
      on event BillOfMaterials.BOMRevised is {
        prompt "Update revision metrics"
      }
      on event BillOfMaterials.BOMObsoleted is {
        prompt "Update active BOM counts"
      }
    } with {
      briefly "Maintains BOM analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "BOM analytics projections"
    described as {
      |Maintains component usage, cost, and revision analytics.
    }
  }
  // Projector for where-used analysis
  projector WhereUsedProjector is {
    record WhereUsedIndex is  {
      componentId: ComponentId with {
        briefly "Component"
        described as {
          |Component identifier.
        }
      }
      parentBOMs: BOMId+ with {
        briefly "Parent BOMs"
        described as {
          |BOMs that use this component.
        }
      }
      totalUsageCount: Natural with {
        briefly "Usage count"
        described as {
          |Total number of usages across all BOMs.
        }
      }
      lastUpdated: TimeStamp with {
        briefly "Last updated"
        described as {
          |When the index was last updated.
        }
      }
    } with {
      briefly "Where-used index entry"
      described as {
        |Index entry tracking component to parent relationships.
      }
    }
    handler WhereUsedHandler is {
      on event BillOfMaterials.ItemAdded is {
        prompt "Add parent reference to component where-used index"
      }
      on event BillOfMaterials.ItemRemoved is {
        prompt "Remove parent reference from component where-used index"
      }
      on event BillOfMaterials.BOMObsoleted is {
        prompt "Update where-used index for all components"
      }
    } with {
      briefly "Maintains where-used index"
      described as {
        |Tracks which BOMs use each component.
      }
    }
  } with {
    briefly "Where-used projections"
    described as {
      |Maintains reverse index for component to parent lookup.
    }
  }
} with {
  briefly "Bounded context for bill of materials management"
  described as {
    | The BOMContext is the bounded context for
    | product structure, components, and cost analysis.
  }
}
