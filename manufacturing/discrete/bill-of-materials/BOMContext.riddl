// Bill of Materials Management - BOM Context

context BOMContext is {

  include "types.riddl"
  include "BillOfMaterials.riddl"

  // Repository for BOM persistence
  repository BOMRepository is {
    schema BOMData is relational
      of boms as BillOfMaterials
      index on field BillOfMaterials.bomId
      index on field BillOfMaterials.header.productId
      index on field BillOfMaterials.header.revision
      index on field BillOfMaterials.header.status

    handler BOMPersistence is {
      on command BillOfMaterials.CreateBOM {
        prompt "Store new bill of materials"
      }
      on command BillOfMaterials.AddItem {
        prompt "Store added component item"
      }
      on command BillOfMaterials.RemoveItem {
        prompt "Remove component item from storage"
      }
      on command BillOfMaterials.UpdateQuantity {
        prompt "Update item quantity"
      }
      on command BillOfMaterials.UpdateItem {
        prompt "Update item details"
      }
      on command BillOfMaterials.ReleaseBOM {
        prompt "Update BOM status to released"
      }
      on command BillOfMaterials.ReviseBOM {
        prompt "Store new revision with history"
      }
      on command BillOfMaterials.ObsoleteBOM {
        prompt "Update BOM status to obsolete"
      }
      on command BillOfMaterials.CalculateCost {
        prompt "Store cost rollup data"
      }
    } with {
      briefly "Persists BOM commands"
      described by "Handles command-driven persistence for BOMs."
    }
  } with {
    briefly "BOM data persistence"
    described by {
      | The BOMRepository provides persistent storage for
      | bills of materials, items, revisions, and costs.
    }
  }

  // Projector for BOM analytics
  projector BOMAnalytics is {
    updates repository BOMRepository

    record ComponentUsageStats is {
      totalComponents is Natural with {
        briefly "Total components"
        described by "Total unique components across all BOMs."
      }
      averageItemsPerBOM is Decimal(10, 2) with {
        briefly "Avg items"
        described by "Average line items per BOM."
      }
      mostUsedComponents is many ComponentId with {
        briefly "Most used"
        described by "Top 10 most frequently used components."
      }
      singleSourceComponents is many ComponentId with {
        briefly "Single source"
        described by "Components with only one supplier."
      }
    } with {
      briefly "Component usage statistics"
      described by "Analytics on component usage patterns."
    }

    record CostAnalytics is {
      averageMaterialCost is Decimal(15, 4) with {
        briefly "Avg material"
        described by "Average material cost across BOMs."
      }
      averageLaborCost is Decimal(15, 4) with {
        briefly "Avg labor"
        described by "Average labor cost across BOMs."
      }
      costVariancePercent is Decimal(5, 2) with {
        briefly "Variance"
        described by "Cost variance from standard."
      }
      highCostItems is many ItemId with {
        briefly "High cost items"
        described by "Items exceeding cost threshold."
      }
    } with {
      briefly "Cost analytics"
      described by "Cost analysis metrics."
    }

    record RevisionMetrics is {
      averageRevisionsPerBOM is Decimal(5, 2) with {
        briefly "Avg revisions"
        described by "Average revisions per BOM."
      }
      revisionsThisMonth is Natural with {
        briefly "Monthly revisions"
        described by "Number of revisions this month."
      }
      topChangedBOMs is many BOMId with {
        briefly "Most changed"
        described by "BOMs with most revisions."
      }
    } with {
      briefly "Revision metrics"
      described by "BOM revision analytics."
    }

    handler AnalyticsHandler is {
      on event BillOfMaterials.BOMCreated {
        prompt "Update BOM counts and statistics"
      }
      on event BillOfMaterials.ItemAdded {
        prompt "Update component usage counts"
      }
      on event BillOfMaterials.ItemRemoved {
        prompt "Update component usage counts"
      }
      on event BillOfMaterials.CostCalculated {
        prompt "Update cost analytics"
      }
      on event BillOfMaterials.BOMRevised {
        prompt "Update revision metrics"
      }
      on event BillOfMaterials.BOMObsoleted {
        prompt "Update active BOM counts"
      }
    } with {
      briefly "Maintains BOM analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "BOM analytics projections"
    described by "Maintains component usage, cost, and revision analytics."
  }

  // Projector for where-used analysis
  projector WhereUsedProjector is {
    updates repository BOMRepository

    record WhereUsedIndex is {
      componentId is ComponentId with {
        briefly "Component"
        described by "Component identifier."
      }
      parentBOMs is many BOMId with {
        briefly "Parent BOMs"
        described by "BOMs that use this component."
      }
      totalUsageCount is Natural with {
        briefly "Usage count"
        described by "Total number of usages across all BOMs."
      }
      lastUpdated is TimeStamp with {
        briefly "Last updated"
        described by "When the index was last updated."
      }
    } with {
      briefly "Where-used index entry"
      described by "Index entry tracking component to parent relationships."
    }

    handler WhereUsedHandler is {
      on event BillOfMaterials.ItemAdded {
        prompt "Add parent reference to component where-used index"
      }
      on event BillOfMaterials.ItemRemoved {
        prompt "Remove parent reference from component where-used index"
      }
      on event BillOfMaterials.BOMObsoleted {
        prompt "Update where-used index for all components"
      }
    } with {
      briefly "Maintains where-used index"
      described by "Tracks which BOMs use each component."
    }
  } with {
    briefly "Where-used projections"
    described by "Maintains reverse index for component to parent lookup."
  }

} with {
  briefly "Bounded context for bill of materials management"
  described by {
    | The BOMContext is the bounded context for
    | product structure, components, and cost analysis.
  }
}
