// Bill of Materials Management - BillOfMaterials Entity
entity BillOfMaterials is {
  // Commands
  command CreateBOM is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |New bill of materials identifier.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Parent product identifier.
      }
    }
    partNumber: String(1,50) with {
      briefly "Part number"
      described as {
        |Parent part number.
      }
    }
    description: String(1,200) with {
      briefly "Description"
      described as {
        |Product description.
      }
    }
    revision: String(1,20) with {
      briefly "Revision"
      described as {
        |Initial revision level.
      }
    }
    bomType: String(1,50) with {
      briefly "BOM type"
      described as {
        |Type (Manufacturing, Engineering, Planning).
      }
    }
    createdBy: String(1,200) with {
      briefly "Created by"
      described as {
        |Person creating the BOM.
      }
    }
  } with {
    briefly "Create BOM"
    described as {
      |Creates a new bill of materials in draft status.
    }
  }
  command AddItem is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    item: BOMItem with {
      briefly "Item"
      described as {
        |Component item to add.
      }
    }
  } with {
    briefly "Add item"
    described as {
      |Adds a component item to the BOM.
    }
  }
  command RemoveItem is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item ID"
      described as {
        |Line item to remove.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for removal.
      }
    }
  } with {
    briefly "Remove item"
    described as {
      |Removes a component item from the BOM.
    }
  }
  command UpdateQuantity is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item ID"
      described as {
        |Line item to update.
      }
    }
    newQuantity: Decimal(15,6) with {
      briefly "New quantity"
      described as {
        |Updated quantity per parent.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for quantity change.
      }
    }
  } with {
    briefly "Update quantity"
    described as {
      |Updates the quantity for a BOM line item.
    }
  }
  command UpdateItem is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item ID"
      described as {
        |Line item to update.
      }
    }
    updatedItem: BOMItem with {
      briefly "Updated item"
      described as {
        |Updated item details.
      }
    }
  } with {
    briefly "Update item"
    described as {
      |Updates a BOM line item details.
    }
  }
  command ReleaseBOM is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Date BOM becomes effective.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Person approving release.
      }
    }
  } with {
    briefly "Release BOM"
    described as {
      |Releases the BOM for manufacturing use.
    }
  }
  command ReviseBOM is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    newRevision: String(1,20) with {
      briefly "New revision"
      described as {
        |New revision level.
      }
    }
    changeNumber: String(1,50)? with {
      briefly "Change number"
      described as {
        |Engineering change number.
      }
    }
    changeDescription: String(1,1000) with {
      briefly "Change description"
      described as {
        |Description of changes.
      }
    }
    revisedBy: String(1,200) with {
      briefly "Revised by"
      described as {
        |Person creating revision.
      }
    }
  } with {
    briefly "Revise BOM"
    described as {
      |Creates a new revision of the BOM.
    }
  }
  command ObsoleteBOM is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for obsolescence.
      }
    }
    obsoletedBy: String(1,200) with {
      briefly "Obsoleted by"
      described as {
        |Person marking as obsolete.
      }
    }
    replacementBOMId: BOMId? with {
      briefly "Replacement"
      described as {
        |Replacement BOM if applicable.
      }
    }
  } with {
    briefly "Obsolete BOM"
    described as {
      |Marks the BOM as obsolete.
    }
  }
  command CalculateCost is  {
    bomId: BOMId with {
      briefly "BOM ID"
      described as {
        |Bill of materials identifier.
      }
    }
    costDate: Date with {
      briefly "Cost date"
      described as {
        |Date for cost calculation.
      }
    }
    includeSubassemblies: Boolean with {
      briefly "Include subassemblies"
      described as {
        |Whether to explode subassembly costs.
      }
    }
  } with {
    briefly "Calculate cost"
    described as {
      |Calculates rolled up cost for the BOM.
    }
  }
  // Events
  event BOMCreated is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Product identifier.
      }
    }
    partNumber: String(1,50) with {
      briefly "Part number"
      described as {
        |Part number.
      }
    }
    description: String(1,200) with {
      briefly "Description"
      described as {
        |Description.
      }
    }
    revision: String(1,20) with {
      briefly "Revision"
      described as {
        |Revision level.
      }
    }
    bomType: String(1,50) with {
      briefly "Type"
      described as {
        |BOM type.
      }
    }
    createdBy: String(1,200) with {
      briefly "Created by"
      described as {
        |Creator.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created at"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "BOM created"
    described as {
      |Emitted when a new BOM is created.
    }
  }
  event ItemAdded is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    item: BOMItem with {
      briefly "Item"
      described as {
        |Added item.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added at"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Item added"
    described as {
      |Emitted when a component is added to BOM.
    }
  }
  event ItemRemoved is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item"
      described as {
        |Removed item ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Removal reason.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed at"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Item removed"
    described as {
      |Emitted when a component is removed from BOM.
    }
  }
  event QuantityUpdated is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item"
      described as {
        |Updated item ID.
      }
    }
    previousQuantity: Decimal(15,6) with {
      briefly "Previous"
      described as {
        |Previous quantity.
      }
    }
    newQuantity: Decimal(15,6) with {
      briefly "New"
      described as {
        |New quantity.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Change reason.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated at"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Quantity updated"
    described as {
      |Emitted when item quantity is changed.
    }
  }
  event ItemUpdated is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item"
      described as {
        |Updated item ID.
      }
    }
    updatedItem: BOMItem with {
      briefly "Updated item"
      described as {
        |Updated item details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated at"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Item updated"
    described as {
      |Emitted when item details are changed.
    }
  }
  event BOMReleased is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released at"
      described as {
        |Release time.
      }
    }
  } with {
    briefly "BOM released"
    described as {
      |Emitted when BOM is released for use.
    }
  }
  event BOMRevised is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    replacedRevision: String(1,20) with {
      briefly "Previous"
      described as {
        |Previous revision.
      }
    }
    newRevision: String(1,20) with {
      briefly "New"
      described as {
        |New revision.
      }
    }
    changeNumber: String(1,50)? with {
      briefly "Change number"
      described as {
        |ECN/ECO number.
      }
    }
    changeDescription: String(1,1000) with {
      briefly "Description"
      described as {
        |Change description.
      }
    }
    revisedBy: String(1,200) with {
      briefly "Revised by"
      described as {
        |Revisor.
      }
    }
    revisedAt: TimeStamp with {
      briefly "Revised at"
      described as {
        |Revision time.
      }
    }
  } with {
    briefly "BOM revised"
    described as {
      |Emitted when a new revision is created.
    }
  }
  event BOMObsoleted is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Obsolescence reason.
      }
    }
    obsoletedBy: String(1,200) with {
      briefly "Obsoleted by"
      described as {
        |Person obsoleting.
      }
    }
    replacementBOMId: BOMId? with {
      briefly "Replacement"
      described as {
        |Replacement BOM.
      }
    }
    obsoletedAt: TimeStamp with {
      briefly "Obsoleted at"
      described as {
        |Obsolescence time.
      }
    }
  } with {
    briefly "BOM obsoleted"
    described as {
      |Emitted when BOM is marked obsolete.
    }
  }
  event CostCalculated is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    costRollup: CostRollup with {
      briefly "Cost rollup"
      described as {
        |Calculated costs.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated at"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Cost calculated"
    described as {
      |Emitted when BOM cost is calculated.
    }
  }
  // State Records
  record DraftStateData is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    header: BOMHeader with {
      briefly "Header"
      described as {
        |BOM header info.
      }
    }
    draftItems: BOMItem* with {
      briefly "Items"
      described as {
        |BOM line items.
      }
    }
    draftRevisionHistory: RevisionInfo* with {
      briefly "Revisions"
      described as {
        |Revision history.
      }
    }
    lastCostRollup: CostRollup? with {
      briefly "Last cost"
      described as {
        |Most recent cost rollup.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
    modifiedAt: TimeStamp with {
      briefly "Modified"
      described as {
        |Last modification time.
      }
    }
  } with {
    briefly "Draft state"
    described as {
      |State for BOM in draft status.
    }
  }
  record ReleasedStateData is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    header: BOMHeader with {
      briefly "Header"
      described as {
        |BOM header info.
      }
    }
    items: BOMItem+ with {
      briefly "Items"
      described as {
        |BOM line items.
      }
    }
    revisionHistory: RevisionInfo+ with {
      briefly "Revisions"
      described as {
        |Revision history.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
    approvedBy: String(1,200) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |Release time.
      }
    }
    lastCostRollup: CostRollup? with {
      briefly "Last cost"
      described as {
        |Most recent cost rollup.
      }
    }
  } with {
    briefly "Released state"
    described as {
      |State for BOM in released status.
    }
  }
  record ObsoleteStateData is  {
    bomId: BOMId with {
      briefly "BOM"
      described as {
        |BOM identifier.
      }
    }
    header: BOMHeader with {
      briefly "Header"
      described as {
        |BOM header info.
      }
    }
    items: BOMItem+ with {
      briefly "Items"
      described as {
        |BOM line items.
      }
    }
    revisionHistory: RevisionInfo+ with {
      briefly "Revisions"
      described as {
        |Revision history.
      }
    }
    obsoleteReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Obsolescence reason.
      }
    }
    obsoletedBy: String(1,200) with {
      briefly "Obsoleted by"
      described as {
        |Person obsoleting.
      }
    }
    obsoletedAt: TimeStamp with {
      briefly "Obsoleted"
      described as {
        |Obsolescence time.
      }
    }
    replacementBOMId: BOMId? with {
      briefly "Replacement"
      described as {
        |Replacement BOM.
      }
    }
    lastCostRollup: CostRollup? with {
      briefly "Last cost"
      described as {
        |Final cost rollup.
      }
    }
  } with {
    briefly "Obsolete state"
    described as {
      |State for obsoleted BOM.
    }
  }
  // States
  state DraftState of type BillOfMaterials.DraftStateData
  state ReleasedState of type BillOfMaterials.ReleasedStateData
  state ObsoleteState of type BillOfMaterials.ObsoleteStateData
  // Handler
  handler BOMHandler is {
    on command CreateBOM is {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.DraftState with command CreateBOM
      tell event BOMCreated to entity BOMContext.BillOfMaterials
    }
    on command AddItem is {
      tell event ItemAdded to entity BOMContext.BillOfMaterials
    }
    on command RemoveItem is {
      tell event ItemRemoved to entity BOMContext.BillOfMaterials
    }
    on command UpdateQuantity is {
      tell event QuantityUpdated to entity BOMContext.BillOfMaterials
    }
    on command UpdateItem is {
      tell event ItemUpdated to entity BOMContext.BillOfMaterials
    }
    on command ReleaseBOM is {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.ReleasedState with command ReleaseBOM
      tell event BOMReleased to entity BOMContext.BillOfMaterials
    }
    on command ReviseBOM is {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.DraftState with command ReviseBOM
      tell event BOMRevised to entity BOMContext.BillOfMaterials
    }
    on command ObsoleteBOM is {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.ObsoleteState with command ObsoleteBOM
      tell event BOMObsoleted to entity BOMContext.BillOfMaterials
    }
    on command CalculateCost is {
      tell event CostCalculated to entity BOMContext.BillOfMaterials
    }
  } with {
    briefly "Processes BOM commands"
    described as {
      | Handles BOM lifecycle from creation through
      | revision, release, and obsolescence.
    }
  }
} with {
  briefly "BillOfMaterials aggregate"
  described as {
    | The BillOfMaterials entity manages product structure,
    | component relationships, revisions, and cost rollups.
  }
}
