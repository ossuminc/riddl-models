// Bill of Materials Management - BillOfMaterials Entity

entity BillOfMaterials is {

  // Commands
  command CreateBOM is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "New bill of materials identifier."
    }
    productId is ProductId with {
      briefly "Product"
      described by "Parent product identifier."
    }
    partNumber is String(1, 50) with {
      briefly "Part number"
      described by "Parent part number."
    }
    description is String(1, 200) with {
      briefly "Description"
      described by "Product description."
    }
    revision is String(1, 20) with {
      briefly "Revision"
      described by "Initial revision level."
    }
    bomType is String(1, 50) with {
      briefly "BOM type"
      described by "Type (Manufacturing, Engineering, Planning)."
    }
    createdBy is String(1, 200) with {
      briefly "Created by"
      described by "Person creating the BOM."
    }
  } with {
    briefly "Create BOM"
    described by "Creates a new bill of materials in draft status."
  }

  command AddItem is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    item is BOMItem with {
      briefly "Item"
      described by "Component item to add."
    }
  } with {
    briefly "Add item"
    described by "Adds a component item to the BOM."
  }

  command RemoveItem is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    itemId is ItemId with {
      briefly "Item ID"
      described by "Line item to remove."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for removal."
    }
  } with {
    briefly "Remove item"
    described by "Removes a component item from the BOM."
  }

  command UpdateQuantity is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    itemId is ItemId with {
      briefly "Item ID"
      described by "Line item to update."
    }
    newQuantity is Decimal(15, 6) with {
      briefly "New quantity"
      described by "Updated quantity per parent."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for quantity change."
    }
  } with {
    briefly "Update quantity"
    described by "Updates the quantity for a BOM line item."
  }

  command UpdateItem is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    itemId is ItemId with {
      briefly "Item ID"
      described by "Line item to update."
    }
    updatedItem is BOMItem with {
      briefly "Updated item"
      described by "Updated item details."
    }
  } with {
    briefly "Update item"
    described by "Updates a BOM line item details."
  }

  command ReleaseBOM is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    effectiveDate is Date with {
      briefly "Effective date"
      described by "Date BOM becomes effective."
    }
    approvedBy is String(1, 200) with {
      briefly "Approved by"
      described by "Person approving release."
    }
  } with {
    briefly "Release BOM"
    described by "Releases the BOM for manufacturing use."
  }

  command ReviseBOM is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    newRevision is String(1, 20) with {
      briefly "New revision"
      described by "New revision level."
    }
    changeNumber is optional String(1, 50) with {
      briefly "Change number"
      described by "Engineering change number."
    }
    changeDescription is String(1, 1000) with {
      briefly "Change description"
      described by "Description of changes."
    }
    revisedBy is String(1, 200) with {
      briefly "Revised by"
      described by "Person creating revision."
    }
  } with {
    briefly "Revise BOM"
    described by "Creates a new revision of the BOM."
  }

  command ObsoleteBOM is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for obsolescence."
    }
    obsoletedBy is String(1, 200) with {
      briefly "Obsoleted by"
      described by "Person marking as obsolete."
    }
    replacementBOMId is optional BOMId with {
      briefly "Replacement"
      described by "Replacement BOM if applicable."
    }
  } with {
    briefly "Obsolete BOM"
    described by "Marks the BOM as obsolete."
  }

  command CalculateCost is {
    bomId is BOMId with {
      briefly "BOM ID"
      described by "Bill of materials identifier."
    }
    costDate is Date with {
      briefly "Cost date"
      described by "Date for cost calculation."
    }
    includeSubassemblies is Boolean with {
      briefly "Include subassemblies"
      described by "Whether to explode subassembly costs."
    }
  } with {
    briefly "Calculate cost"
    described by "Calculates rolled up cost for the BOM."
  }

  // Events
  event BOMCreated is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    productId is ProductId with { briefly "Product" described by "Product identifier." }
    partNumber is String(1, 50) with { briefly "Part number" described by "Part number." }
    description is String(1, 200) with { briefly "Description" described by "Description." }
    revision is String(1, 20) with { briefly "Revision" described by "Revision level." }
    bomType is String(1, 50) with { briefly "Type" described by "BOM type." }
    createdBy is String(1, 200) with { briefly "Created by" described by "Creator." }
    createdAt is TimeStamp with { briefly "Created at" described by "Creation time." }
  } with {
    briefly "BOM created"
    described by "Emitted when a new BOM is created."
  }

  event ItemAdded is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    item is BOMItem with { briefly "Item" described by "Added item." }
    addedAt is TimeStamp with { briefly "Added at" described by "Addition time." }
  } with {
    briefly "Item added"
    described by "Emitted when a component is added to BOM."
  }

  event ItemRemoved is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    itemId is ItemId with { briefly "Item" described by "Removed item ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Removal reason." }
    removedAt is TimeStamp with { briefly "Removed at" described by "Removal time." }
  } with {
    briefly "Item removed"
    described by "Emitted when a component is removed from BOM."
  }

  event QuantityUpdated is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    itemId is ItemId with { briefly "Item" described by "Updated item ID." }
    previousQuantity is Decimal(15, 6) with { briefly "Previous" described by "Previous quantity." }
    newQuantity is Decimal(15, 6) with { briefly "New" described by "New quantity." }
    reason is String(1, 500) with { briefly "Reason" described by "Change reason." }
    updatedAt is TimeStamp with { briefly "Updated at" described by "Update time." }
  } with {
    briefly "Quantity updated"
    described by "Emitted when item quantity is changed."
  }

  event ItemUpdated is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    itemId is ItemId with { briefly "Item" described by "Updated item ID." }
    updatedItem is BOMItem with { briefly "Updated item" described by "Updated item details." }
    updatedAt is TimeStamp with { briefly "Updated at" described by "Update time." }
  } with {
    briefly "Item updated"
    described by "Emitted when item details are changed."
  }

  event BOMReleased is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
    approvedBy is String(1, 200) with { briefly "Approved by" described by "Approver." }
    releasedAt is TimeStamp with { briefly "Released at" described by "Release time." }
  } with {
    briefly "BOM released"
    described by "Emitted when BOM is released for use."
  }

  event BOMRevised is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    replacedRevision is String(1, 20) with { briefly "Previous" described by "Previous revision." }
    newRevision is String(1, 20) with { briefly "New" described by "New revision." }
    changeNumber is optional String(1, 50) with { briefly "Change number" described by "ECN/ECO number." }
    changeDescription is String(1, 1000) with { briefly "Description" described by "Change description." }
    revisedBy is String(1, 200) with { briefly "Revised by" described by "Revisor." }
    revisedAt is TimeStamp with { briefly "Revised at" described by "Revision time." }
  } with {
    briefly "BOM revised"
    described by "Emitted when a new revision is created."
  }

  event BOMObsoleted is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    reason is String(1, 500) with { briefly "Reason" described by "Obsolescence reason." }
    obsoletedBy is String(1, 200) with { briefly "Obsoleted by" described by "Person obsoleting." }
    replacementBOMId is optional BOMId with { briefly "Replacement" described by "Replacement BOM." }
    obsoletedAt is TimeStamp with { briefly "Obsoleted at" described by "Obsolescence time." }
  } with {
    briefly "BOM obsoleted"
    described by "Emitted when BOM is marked obsolete."
  }

  event CostCalculated is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    costRollup is CostRollup with { briefly "Cost rollup" described by "Calculated costs." }
    calculatedAt is TimeStamp with { briefly "Calculated at" described by "Calculation time." }
  } with {
    briefly "Cost calculated"
    described by "Emitted when BOM cost is calculated."
  }

  // State Records
  record DraftStateData is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    header is BOMHeader with { briefly "Header" described by "BOM header info." }
    draftItems is many optional BOMItem with { briefly "Items" described by "BOM line items." }
    draftRevisionHistory is many optional RevisionInfo with { briefly "Revisions" described by "Revision history." }
    lastCostRollup is optional CostRollup with { briefly "Last cost" described by "Most recent cost rollup." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
    modifiedAt is TimeStamp with { briefly "Modified" described by "Last modification time." }
  } with {
    briefly "Draft state"
    described by "State for BOM in draft status."
  }

  record ReleasedStateData is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    header is BOMHeader with { briefly "Header" described by "BOM header info." }
    items is many BOMItem with { briefly "Items" described by "BOM line items." }
    revisionHistory is many RevisionInfo with { briefly "Revisions" described by "Revision history." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
    approvedBy is String(1, 200) with { briefly "Approved by" described by "Approver." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
    lastCostRollup is optional CostRollup with { briefly "Last cost" described by "Most recent cost rollup." }
  } with {
    briefly "Released state"
    described by "State for BOM in released status."
  }

  record ObsoleteStateData is {
    bomId is BOMId with { briefly "BOM" described by "BOM identifier." }
    header is BOMHeader with { briefly "Header" described by "BOM header info." }
    items is many BOMItem with { briefly "Items" described by "BOM line items." }
    revisionHistory is many RevisionInfo with { briefly "Revisions" described by "Revision history." }
    obsoleteReason is String(1, 500) with { briefly "Reason" described by "Obsolescence reason." }
    obsoletedBy is String(1, 200) with { briefly "Obsoleted by" described by "Person obsoleting." }
    obsoletedAt is TimeStamp with { briefly "Obsoleted" described by "Obsolescence time." }
    replacementBOMId is optional BOMId with { briefly "Replacement" described by "Replacement BOM." }
    lastCostRollup is optional CostRollup with { briefly "Last cost" described by "Final cost rollup." }
  } with {
    briefly "Obsolete state"
    described by "State for obsoleted BOM."
  }

  // States
  state DraftState of BillOfMaterials.DraftStateData with {
    briefly "BOM in draft"
    described by "BOM is being created or edited."
  }

  state ReleasedState of BillOfMaterials.ReleasedStateData with {
    briefly "BOM released"
    described by "BOM is released for manufacturing use."
  }

  state ObsoleteState of BillOfMaterials.ObsoleteStateData with {
    briefly "BOM obsolete"
    described by "BOM has been marked as obsolete."
  }

  // Handler
  handler BOMHandler is {
    on command CreateBOM {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.DraftState with command CreateBOM
      tell event BOMCreated to entity BOMContext.BillOfMaterials
    }

    on command AddItem {
      tell event ItemAdded to entity BOMContext.BillOfMaterials
    }

    on command RemoveItem {
      tell event ItemRemoved to entity BOMContext.BillOfMaterials
    }

    on command UpdateQuantity {
      tell event QuantityUpdated to entity BOMContext.BillOfMaterials
    }

    on command UpdateItem {
      tell event ItemUpdated to entity BOMContext.BillOfMaterials
    }

    on command ReleaseBOM {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.ReleasedState with command ReleaseBOM
      tell event BOMReleased to entity BOMContext.BillOfMaterials
    }

    on command ReviseBOM {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.DraftState with command ReviseBOM
      tell event BOMRevised to entity BOMContext.BillOfMaterials
    }

    on command ObsoleteBOM {
      morph entity BOMContext.BillOfMaterials to state BOMContext.BillOfMaterials.ObsoleteState with command ObsoleteBOM
      tell event BOMObsoleted to entity BOMContext.BillOfMaterials
    }

    on command CalculateCost {
      tell event CostCalculated to entity BOMContext.BillOfMaterials
    }
  } with {
    briefly "Processes BOM commands"
    described by {
      | Handles BOM lifecycle from creation through
      | revision, release, and obsolescence.
    }
  }

} with {
  briefly "BillOfMaterials aggregate"
  described by {
    | The BillOfMaterials entity manages product structure,
    | component relationships, revisions, and cost rollups.
  }
}
