// Work Order Management - WorkOrder Context

context WorkOrderContext is {

  include "types.riddl"
  include "WorkOrder.riddl"

  // Repository for work order persistence
  repository WorkOrderRepository is {
    schema WorkOrderData is relational
      of workOrders as WorkOrder
      index on field WorkOrder.workOrderId
      index on field WorkOrder.product.productId
      index on field WorkOrder.status

    handler WorkOrderPersistence is {
      on command WorkOrder.CreateWorkOrder {
        prompt "Store new work order"
      }
      on command WorkOrder.ReleaseWorkOrder {
        prompt "Update to released"
      }
      on command WorkOrder.IssueMaterials {
        prompt "Store material issues"
      }
      on command WorkOrder.StartWorkOrder {
        prompt "Update to in progress"
      }
      on command WorkOrder.StartOperation {
        prompt "Update operation status"
      }
      on command WorkOrder.CompleteOperation {
        prompt "Update operation completion"
      }
      on command WorkOrder.RecordLabor {
        prompt "Store labor entry"
      }
      on command WorkOrder.RecordQuality {
        prompt "Store quality result"
      }
      on command WorkOrder.PlaceOnHold {
        prompt "Update to on hold"
      }
      on command WorkOrder.ReleaseHold {
        prompt "Update hold release"
      }
      on command WorkOrder.CompleteWorkOrder {
        prompt "Update to completed"
      }
      on command WorkOrder.CancelWorkOrder {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists work order events"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Work order data persistence"
    described by {
      | The WorkOrderRepository provides persistent storage for
      | work orders, operations, and production data.
    }
  }

  // Projector for production analytics
  projector ProductionAnalytics is {
    updates repository WorkOrderRepository

    record ProductionStats is {
      activeWorkOrders is Natural with { briefly "Active" described by "Active work orders." }
      completedToday is Natural with { briefly "Completed" described by "Completed today." }
      onTimeDelivery is Decimal(5, 4) with { briefly "OTD" described by "On-time delivery rate." }
      firstPassYield is Decimal(5, 4) with { briefly "FPY" described by "First pass yield." }
      oee is Decimal(5, 4) with { briefly "OEE" described by "Overall equipment effectiveness." }
      averageCycleTime is Natural with { briefly "Cycle time" described by "Average cycle time (min)." }
    } with {
      briefly "Production statistics"
      described by "Manufacturing metrics."
    }

    handler AnalyticsHandler is {
      on event WorkOrder.WorkOrderStarted {
        prompt "Update active counts"
      }
      on event WorkOrder.WorkOrderCompleted {
        prompt "Update completion metrics"
      }
      on event WorkOrder.QualityRecorded {
        prompt "Update quality metrics"
      }
      on event WorkOrder.OperationCompleted {
        prompt "Update cycle time metrics"
      }
    } with {
      briefly "Maintains production analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Production analytics projections"
    described by "Maintains manufacturing analytics data."
  }

} with {
  briefly "Bounded context for work order management"
  described by {
    | The WorkOrderContext is the bounded context for
    | manufacturing work orders and production control.
  }
}
