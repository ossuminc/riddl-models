// Work Order Management - External Contexts

// Bill of Materials Service
context BillOfMaterialsService is {

  query GetBOM is {
    productId is ProductId with { briefly "Product" described by "Product ID." }
    revision is String(1, 20) with { briefly "Revision" described by "BOM revision." }
  } with {
    briefly "Get BOM"
    described by "Retrieves bill of materials."
  }

  result BillOfMaterials is {
    productId is ProductId with { briefly "Product" described by "Product ID." }
    revision is String(1, 20) with { briefly "Revision" described by "BOM revision." }
    materials is many MaterialRequirement with { briefly "Materials" described by "Material requirements." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
  } with {
    briefly "Bill of materials"
    described by "Product bill of materials."
  }

} with {
  option is external
  briefly "External BOM service"
  described by "External bill of materials service."
}

// Routing Service
context RoutingService is {

  query GetRouting is {
    productId is ProductId with { briefly "Product" described by "Product ID." }
    revision is String(1, 20) with { briefly "Revision" described by "Routing revision." }
  } with {
    briefly "Get routing"
    described by "Retrieves manufacturing routing."
  }

  result ManufacturingRouting is {
    routingId is RoutingId with { briefly "Routing" described by "Routing ID." }
    productId is ProductId with { briefly "Product" described by "Product ID." }
    operations is many OperationInfo with { briefly "Operations" described by "Routing operations." }
    totalSetupTime is Natural with { briefly "Setup" described by "Total setup time." }
    totalRunTime is Natural with { briefly "Run" described by "Total run time." }
  } with {
    briefly "Manufacturing routing"
    described by "Product manufacturing routing."
  }

} with {
  option is external
  briefly "External routing service"
  described by "External manufacturing routing service."
}

// Inventory Service
context InventoryService is {

  command ReserveMaterials is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    materials is many MaterialRequirement with { briefly "Materials" described by "Materials to reserve." }
  } with {
    briefly "Reserve materials"
    described by "Reserves materials for work order."
  }

  event MaterialsReserved is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "Reservation time." }
  } with {
    briefly "Materials reserved"
    described by "Emitted when materials are reserved."
  }

  event MaterialShortage is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    shortMaterials is many MaterialId with { briefly "Short" described by "Short materials." }
    detectedAt is TimeStamp with { briefly "Detected" described by "Detection time." }
  } with {
    briefly "Material shortage"
    described by "Emitted when shortage detected."
  }

  command IssueMaterialsToWorkOrder is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    materials is many MaterialRequirement with { briefly "Materials" described by "Materials to issue." }
    issuedBy is String(1, 200) with { briefly "Issued by" described by "Person issuing." }
  } with {
    briefly "Issue materials"
    described by "Issues materials from inventory."
  }

  event MaterialsIssuedFromInventory is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    issuedAt is TimeStamp with { briefly "Issued" described by "Issue time." }
  } with {
    briefly "Materials issued"
    described by "Emitted when materials are issued."
  }

  command ReceiveFinishedGoods is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    productId is ProductId with { briefly "Product" described by "Product ID." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Completed quantity." }
  } with {
    briefly "Receive finished goods"
    described by "Receives completed products."
  }

  event FinishedGoodsReceived is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    productId is ProductId with { briefly "Product" described by "Product ID." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Received quantity." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Finished goods received"
    described by "Emitted when finished goods received."
  }

} with {
  option is external
  briefly "External inventory"
  described by "External inventory service."
}

// Scheduling Service
context SchedulingService is {

  command ScheduleWorkOrder is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    operations is many OperationInfo with { briefly "Operations" described by "Operations to schedule." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    priority is OrderPriority with { briefly "Priority" described by "Order priority." }
  } with {
    briefly "Schedule work order"
    described by "Schedules work order operations."
  }

  result WorkOrderSchedule is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    schedule is ScheduleInfo with { briefly "Schedule" described by "Planned schedule." }
    operationSchedules is many String(1, 500) with { briefly "Operations" described by "Operation schedules." }
    feasible is Boolean with { briefly "Feasible" described by "Whether schedule is feasible." }
  } with {
    briefly "Work order schedule"
    described by "Scheduled work order."
  }

  query GetWorkCenterLoad is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
    startDate is Date with { briefly "Start" described by "Period start." }
    endDate is Date with { briefly "End" described by "Period end." }
  } with {
    briefly "Get work center load"
    described by "Retrieves work center capacity load."
  }

  result WorkCenterLoad is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
    totalCapacity is Natural with { briefly "Capacity" described by "Total capacity (hours)." }
    loadedCapacity is Natural with { briefly "Loaded" described by "Loaded capacity (hours)." }
    availableCapacity is Natural with { briefly "Available" described by "Available capacity (hours)." }
    utilizationPercent is Decimal(5, 2) with { briefly "Utilization" described by "Utilization percent." }
  } with {
    briefly "Work center load"
    described by "Work center capacity information."
  }

} with {
  option is external
  briefly "External scheduling"
  described by "External production scheduling service."
}

// Quality Management Service
context QualityManagementService is {

  query GetInspectionPlan is {
    productId is ProductId with { briefly "Product" described by "Product ID." }
    operationId is OperationId with { briefly "Operation" described by "Operation ID." }
  } with {
    briefly "Get inspection plan"
    described by "Retrieves quality inspection plan."
  }

  result InspectionPlan is {
    productId is ProductId with { briefly "Product" described by "Product ID." }
    operationId is OperationId with { briefly "Operation" described by "Operation ID." }
    inspectionType is String(1, 100) with { briefly "Type" described by "Inspection type." }
    checkpoints is many String(1, 500) with { briefly "Checkpoints" described by "Inspection checkpoints." }
    sampleSize is Natural with { briefly "Sample" described by "Sample size." }
  } with {
    briefly "Inspection plan"
    described by "Quality inspection plan."
  }

  command RecordNonConformance is {
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    operationId is OperationId with { briefly "Operation" described by "Operation ID." }
    defectCode is String(1, 50) with { briefly "Defect" described by "Defect code." }
    quantity is Decimal(15, 4) with { briefly "Quantity" described by "Defective quantity." }
    description is String(1, 1000) with { briefly "Description" described by "Defect description." }
  } with {
    briefly "Record non-conformance"
    described by "Records quality non-conformance."
  }

  event NonConformanceRecorded is {
    ncId is UUID with { briefly "NC" described by "Non-conformance ID." }
    workOrderId is WorkOrderId with { briefly "Work Order" described by "Work order ID." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Non-conformance recorded"
    described by "Emitted when NC is recorded."
  }

} with {
  option is external
  briefly "External quality management"
  described by "External quality management service."
}

// Equipment Service
context EquipmentService is {

  query GetEquipmentStatus is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
  } with {
    briefly "Get equipment status"
    described by "Retrieves equipment availability."
  }

  result EquipmentStatus is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
    equipmentStatus is String(1, 50) with { briefly "Status" described by "Equipment status." }
    currentWorkOrder is optional WorkOrderId with { briefly "Current WO" described by "Current work order." }
    availableAt is optional TimeStamp with { briefly "Available" described by "When available." }
  } with {
    briefly "Equipment status"
    described by "Equipment status information."
  }

  command ReportEquipmentDowntime is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Downtime reason." }
    expectedDuration is Natural with { briefly "Duration" described by "Expected duration (min)." }
  } with {
    briefly "Report downtime"
    described by "Reports equipment downtime."
  }

  event DowntimeReported is {
    workCenterId is WorkCenterId with { briefly "Work Center" described by "Work center ID." }
    downtimeId is UUID with { briefly "Downtime" described by "Downtime ID." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Downtime reported"
    described by "Emitted when downtime is reported."
  }

} with {
  option is external
  briefly "External equipment service"
  described by "External equipment and maintenance service."
}
