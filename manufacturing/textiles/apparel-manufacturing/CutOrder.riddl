// Apparel Manufacturing - CutOrder Entity

entity CutOrder is {

  // Commands
  command CreateCutOrder is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "New cut order identifier."
    }
    styleSpec is GarmentSpec with {
      briefly "Style spec"
      described by "Garment style specification."
    }
    marker is CutMarker with {
      briefly "Marker"
      described by "Cutting marker layout."
    }
    orderQuantity is Natural with {
      briefly "Order quantity"
      described by "Total garments to produce."
    }
    priority is OrderPriority with {
      briefly "Priority"
      described by "Order priority level."
    }
    dueDate is Date with {
      briefly "Due date"
      described by "Production due date."
    }
    salesOrderRef is String(1, 50) with {
      briefly "Sales order"
      described by "Reference to sales order."
    }
  } with {
    briefly "Create cut order"
    described by "Creates a new cut order for garment production."
  }

  command GenerateMarker is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    marker is CutMarker with {
      briefly "Marker"
      described by "Generated marker layout."
    }
    generatedBy is OperatorId with {
      briefly "Generated by"
      described by "Person generating marker."
    }
  } with {
    briefly "Generate marker"
    described by "Generates or updates the cutting marker."
  }

  command CutFabric is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    cutBy is OperatorId with {
      briefly "Cut by"
      described by "Cutting operator."
    }
    layersSpread is Natural with {
      briefly "Layers"
      described by "Number of layers spread."
    }
    fabricRollIds is many String(1, 50) with {
      briefly "Fabric rolls"
      described by "Fabric rolls consumed."
    }
    wastePercent is Decimal(5, 2) with {
      briefly "Waste"
      described by "Fabric waste percentage."
    }
  } with {
    briefly "Cut fabric"
    described by "Records fabric cutting completion."
  }

  command CreateBundles is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    bundles is many Bundle with {
      briefly "Bundles"
      described by "Bundles created from cut pieces."
    }
    bundledBy is OperatorId with {
      briefly "Bundled by"
      described by "Person creating bundles."
    }
  } with {
    briefly "Create bundles"
    described by "Creates production bundles from cut pieces."
  }

  command AssignBundle is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    bundleId is BundleId with {
      briefly "Bundle ID"
      described by "Bundle to assign."
    }
    operatorId is OperatorId with {
      briefly "Operator"
      described by "Sewing operator to assign."
    }
    assignedBy is OperatorId with {
      briefly "Assigned by"
      described by "Supervisor assigning bundle."
    }
  } with {
    briefly "Assign bundle"
    described by "Assigns a bundle to a sewing operator."
  }

  command CompleteSewing is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    bundleId is BundleId with {
      briefly "Bundle ID"
      described by "Bundle completed."
    }
    operatorId is OperatorId with {
      briefly "Operator"
      described by "Sewing operator."
    }
    completedCount is Natural with {
      briefly "Completed"
      described by "Pieces completed."
    }
    defectCount is Natural with {
      briefly "Defects"
      described by "Pieces with defects."
    }
    actualMinutes is Decimal(8, 2) with {
      briefly "Actual minutes"
      described by "Actual time spent."
    }
  } with {
    briefly "Complete sewing"
    described by "Records sewing completion for a bundle."
  }

  command CompleteTrimming is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    bundleId is BundleId with {
      briefly "Bundle ID"
      described by "Bundle completed."
    }
    operatorId is OperatorId with {
      briefly "Operator"
      described by "Trim operator."
    }
    trimsApplied is many TrimOperation with {
      briefly "Trims applied"
      described by "Trim operations completed."
    }
    actualMinutes is Decimal(8, 2) with {
      briefly "Actual minutes"
      described by "Actual time spent."
    }
  } with {
    briefly "Complete trimming"
    described by "Records trimming completion for a bundle."
  }

  command RecordQualityCheck is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    inspection is QualityInspection with {
      briefly "Inspection"
      described by "Quality inspection result."
    }
  } with {
    briefly "Record quality check"
    described by "Records quality inspection for a bundle."
  }

  command PackGarments is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order identifier."
    }
    packingInfo is PackingInfo with {
      briefly "Packing info"
      described by "Carton packing details."
    }
    bundleIds is many BundleId with {
      briefly "Bundle IDs"
      described by "Bundles included in packing."
    }
  } with {
    briefly "Pack garments"
    described by "Packs finished garments into cartons."
  }

  command CancelCutOrder is {
    cutOrderId is CutOrderId with {
      briefly "Cut order ID"
      described by "Cut order to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is OperatorId with {
      briefly "Cancelled by"
      described by "Person cancelling order."
    }
  } with {
    briefly "Cancel cut order"
    described by "Cancels a cut order."
  }

  // Events
  event CutOrderCreated is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    styleSpec is GarmentSpec with { briefly "Style" described by "Style specification." }
    marker is CutMarker with { briefly "Marker" described by "Cutting marker." }
    orderQuantity is Natural with { briefly "Quantity" described by "Order quantity." }
    priority is OrderPriority with { briefly "Priority" described by "Order priority." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    salesOrderRef is String(1, 50) with { briefly "Sales order" described by "Sales order reference." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation timestamp." }
  } with {
    briefly "Cut order created"
    described by "Emitted when a cut order is created."
  }

  event MarkerGenerated is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    marker is CutMarker with { briefly "Marker" described by "Generated marker." }
    generatedBy is OperatorId with { briefly "Generated by" described by "Generator." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Marker generated"
    described by "Emitted when cutting marker is generated."
  }

  event FabricCut is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    cutBy is OperatorId with { briefly "Cut by" described by "Cutting operator." }
    layersSpread is Natural with { briefly "Layers" described by "Layers spread." }
    fabricRollIds is many String(1, 50) with { briefly "Rolls" described by "Fabric rolls used." }
    wastePercent is Decimal(5, 2) with { briefly "Waste" described by "Waste percentage." }
    cutAt is TimeStamp with { briefly "Cut at" described by "Cutting timestamp." }
  } with {
    briefly "Fabric cut"
    described by "Emitted when fabric cutting is completed."
  }

  event BundlesCreated is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    bundles is many Bundle with { briefly "Bundles" described by "Created bundles." }
    bundledBy is OperatorId with { briefly "Bundled by" described by "Bundler." }
    bundledAt is TimeStamp with { briefly "Bundled" described by "Bundle creation time." }
  } with {
    briefly "Bundles created"
    described by "Emitted when bundles are created."
  }

  event BundleAssigned is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    bundleId is BundleId with { briefly "Bundle" described by "Assigned bundle." }
    operatorId is OperatorId with { briefly "Operator" described by "Assigned operator." }
    assignedBy is OperatorId with { briefly "Assigned by" described by "Supervisor." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Bundle assigned"
    described by "Emitted when a bundle is assigned to an operator."
  }

  event SewingCompleted is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    bundleId is BundleId with { briefly "Bundle" described by "Completed bundle." }
    operatorId is OperatorId with { briefly "Operator" described by "Sewing operator." }
    completedCount is Natural with { briefly "Completed" described by "Pieces completed." }
    defectCount is Natural with { briefly "Defects" described by "Defect count." }
    actualMinutes is Decimal(8, 2) with { briefly "Minutes" described by "Time spent." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Sewing completed"
    described by "Emitted when sewing is completed for a bundle."
  }

  event TrimmingCompleted is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    bundleId is BundleId with { briefly "Bundle" described by "Completed bundle." }
    operatorId is OperatorId with { briefly "Operator" described by "Trim operator." }
    trimsApplied is many TrimOperation with { briefly "Trims" described by "Trims applied." }
    actualMinutes is Decimal(8, 2) with { briefly "Minutes" described by "Time spent." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Trimming completed"
    described by "Emitted when trimming is completed for a bundle."
  }

  event QualityCheckRecorded is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    inspection is QualityInspection with { briefly "Inspection" described by "Inspection result." }
  } with {
    briefly "Quality check recorded"
    described by "Emitted when quality inspection is recorded."
  }

  event GarmentsPacked is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    packingInfo is PackingInfo with { briefly "Packing" described by "Packing details." }
    bundleIds is many BundleId with { briefly "Bundles" described by "Packed bundles." }
  } with {
    briefly "Garments packed"
    described by "Emitted when garments are packed."
  }

  event CutOrderCancelled is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is OperatorId with { briefly "Cancelled by" described by "Canceller." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Cut order cancelled"
    described by "Emitted when cut order is cancelled."
  }

  // State Records
  record CuttingStateData is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    styleSpec is GarmentSpec with { briefly "Style" described by "Style specification." }
    marker is CutMarker with { briefly "Marker" described by "Cutting marker." }
    orderQuantity is Natural with { briefly "Quantity" described by "Order quantity." }
    priority is OrderPriority with { briefly "Priority" described by "Order priority." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    salesOrderRef is String(1, 50) with { briefly "Sales order" described by "Sales order ref." }
    productionStatus is ProductionStatus with { briefly "Status" described by "Production status." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Cutting state"
    described by "State during cutting phase."
  }

  record SewingStateData is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    styleSpec is GarmentSpec with { briefly "Style" described by "Style specification." }
    marker is CutMarker with { briefly "Marker" described by "Cutting marker." }
    orderQuantity is Natural with { briefly "Quantity" described by "Order quantity." }
    priority is OrderPriority with { briefly "Priority" described by "Order priority." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    salesOrderRef is String(1, 50) with { briefly "Sales order" described by "Sales order ref." }
    bundles is many Bundle with { briefly "Bundles" described by "Production bundles." }
    productionStatus is ProductionStatus with { briefly "Status" described by "Production status." }
    fabricRollsUsed is many String(1, 50) with { briefly "Rolls" described by "Fabric rolls used." }
    cutAt is TimeStamp with { briefly "Cut" described by "Cutting completion time." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Sewing state"
    described by "State during sewing phase."
  }

  record FinishingStateData is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    styleSpec is GarmentSpec with { briefly "Style" described by "Style specification." }
    orderQuantity is Natural with { briefly "Quantity" described by "Order quantity." }
    priority is OrderPriority with { briefly "Priority" described by "Order priority." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    salesOrderRef is String(1, 50) with { briefly "Sales order" described by "Sales order ref." }
    bundles is many Bundle with { briefly "Bundles" described by "Production bundles." }
    completedCount is Natural with { briefly "Completed" described by "Completed count." }
    defectCount is Natural with { briefly "Defects" described by "Defect count." }
    inspections is many optional QualityInspection with { briefly "Inspections" described by "Quality inspections." }
    productionStatus is ProductionStatus with { briefly "Status" described by "Production status." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Finishing state"
    described by "State during finishing and packing phase."
  }

  record CompletedStateData is {
    cutOrderId is CutOrderId with { briefly "Cut order" described by "Cut order ID." }
    styleSpec is GarmentSpec with { briefly "Style" described by "Style specification." }
    orderQuantity is Natural with { briefly "Quantity" described by "Order quantity." }
    totalProduced is Natural with { briefly "Produced" described by "Total produced." }
    totalPacked is Natural with { briefly "Packed" described by "Total packed." }
    totalDefects is Natural with { briefly "Defects" described by "Total defects." }
    packingRecords is many PackingInfo with { briefly "Packing" described by "Packing records." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Completed state"
    described by "State for completed cut order."
  }

  // States
  state CuttingState of CutOrder.CuttingStateData with {
    briefly "Cutting phase"
    described by "Cut order is in fabric cutting phase."
  }

  state SewingState of CutOrder.SewingStateData with {
    briefly "Sewing phase"
    described by "Cut order is in sewing phase."
  }

  state FinishingState of CutOrder.FinishingStateData with {
    briefly "Finishing phase"
    described by "Cut order is in trimming, QC, and packing phase."
  }

  state CompletedState of CutOrder.CompletedStateData with {
    briefly "Completed"
    described by "Cut order production is complete."
  }

  // Handler
  handler CutOrderHandler is {
    on command CreateCutOrder {
      morph entity ApparelContext.CutOrder to state ApparelContext.CutOrder.CuttingState with command CreateCutOrder
      tell event CutOrderCreated to entity ApparelContext.CutOrder
    }

    on command GenerateMarker {
      tell event MarkerGenerated to entity ApparelContext.CutOrder
    }

    on command CutFabric {
      tell event FabricCut to entity ApparelContext.CutOrder
    }

    on command CreateBundles {
      morph entity ApparelContext.CutOrder to state ApparelContext.CutOrder.SewingState with command CreateBundles
      tell event BundlesCreated to entity ApparelContext.CutOrder
    }

    on command AssignBundle {
      tell event BundleAssigned to entity ApparelContext.CutOrder
    }

    on command CompleteSewing {
      tell event SewingCompleted to entity ApparelContext.CutOrder
    }

    on command CompleteTrimming {
      morph entity ApparelContext.CutOrder to state ApparelContext.CutOrder.FinishingState with command CompleteTrimming
      tell event TrimmingCompleted to entity ApparelContext.CutOrder
    }

    on command RecordQualityCheck {
      tell event QualityCheckRecorded to entity ApparelContext.CutOrder
    }

    on command PackGarments {
      morph entity ApparelContext.CutOrder to state ApparelContext.CutOrder.CompletedState with command PackGarments
      tell event GarmentsPacked to entity ApparelContext.CutOrder
    }

    on command CancelCutOrder {
      tell event CutOrderCancelled to entity ApparelContext.CutOrder
    }
  } with {
    briefly "Processes cut order commands"
    described by {
      | Handles cut order lifecycle from creation through
      | cutting, bundling, sewing, trimming, and packing.
    }
  }

} with {
  briefly "CutOrder aggregate"
  described by {
    | The CutOrder entity manages apparel production through
    | the cut-sew-trim process from fabric cutting to packing.
  }
}
