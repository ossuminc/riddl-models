// Apparel Manufacturing - Apparel Context

context ApparelContext is {

  include "types.riddl"
  include "CutOrder.riddl"

  // Repository for cut order persistence
  repository CutOrderRepository is {
    schema CutOrderData is relational
      of cutOrders as CutOrder
      index on field CutOrder.cutOrderId
      index on field CutOrder.styleSpec.styleId
      index on field CutOrder.status

    handler CutOrderPersistence is {
      on event CutOrder.CutOrderCreated {
        prompt "Store new cut order"
      }
      on event CutOrder.MarkerGenerated {
        prompt "Update marker data"
      }
      on event CutOrder.FabricCut {
        prompt "Update cutting completion"
      }
      on event CutOrder.BundlesCreated {
        prompt "Store bundle records"
      }
      on event CutOrder.BundleAssigned {
        prompt "Update bundle assignment"
      }
      on event CutOrder.SewingCompleted {
        prompt "Update sewing completion"
      }
      on event CutOrder.TrimmingCompleted {
        prompt "Update trimming completion"
      }
      on event CutOrder.QualityCheckRecorded {
        prompt "Store quality inspection"
      }
      on event CutOrder.GarmentsPacked {
        prompt "Store packing record"
      }
      on event CutOrder.CutOrderCancelled {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists cut order events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Cut order data persistence"
    described by {
      | The CutOrderRepository provides persistent storage for
      | cut orders, bundles, and production tracking data.
    }
  }

  // Projector for SAM efficiency tracking
  projector SAMEfficiencyProjector is {
    updates repository CutOrderRepository

    record SAMEfficiencyStats is {
      periodStart is Date with { briefly "Period start" described by "Start of measurement period." }
      periodEnd is Date with { briefly "Period end" described by "End of measurement period." }
      totalEarnedMinutes is Decimal(12, 2) with { briefly "Earned" described by "Total earned SAM." }
      totalAttendedMinutes is Decimal(12, 2) with { briefly "Attended" described by "Total attended minutes." }
      overallEfficiency is Decimal(5, 2) with { briefly "Efficiency" described by "Overall efficiency percent." }
      operatorCount is Natural with { briefly "Operators" described by "Number of operators." }
      topPerformers is many ProductionEfficiency with { briefly "Top performers" described by "Top performing operators." }
    } with {
      briefly "SAM efficiency statistics"
      described by "Standard Allowed Minutes efficiency metrics."
    }

    handler SAMEfficiencyHandler is {
      on event CutOrder.SewingCompleted {
        prompt "Update operator earned minutes and efficiency"
      }
      on event CutOrder.TrimmingCompleted {
        prompt "Update trim operation efficiency"
      }
    } with {
      briefly "Maintains SAM efficiency metrics"
      described by "Projects sewing events into efficiency analytics."
    }
  } with {
    briefly "SAM efficiency projections"
    described by "Maintains operator efficiency based on SAM standards."
  }

  // Projector for bundle throughput tracking
  projector BundleThroughputProjector is {
    updates repository CutOrderRepository

    record BundleThroughputStats is {
      periodStart is Date with { briefly "Period start" described by "Start of period." }
      periodEnd is Date with { briefly "Period end" described by "End of period." }
      bundlesCreated is Natural with { briefly "Created" described by "Bundles created." }
      bundlesAssigned is Natural with { briefly "Assigned" described by "Bundles assigned." }
      bundlesCompleted is Natural with { briefly "Completed" described by "Bundles completed." }
      bundlesPacked is Natural with { briefly "Packed" described by "Bundles packed." }
      averageCycleTime is Decimal(8, 2) with { briefly "Cycle time" described by "Average bundle cycle time (hours)." }
      wipBundles is Natural with { briefly "WIP" described by "Work-in-progress bundles." }
    } with {
      briefly "Bundle throughput statistics"
      described by "Bundle flow and cycle time metrics."
    }

    handler BundleThroughputHandler is {
      on event CutOrder.BundlesCreated {
        prompt "Increment bundles created counter"
      }
      on event CutOrder.BundleAssigned {
        prompt "Increment bundles assigned counter"
      }
      on event CutOrder.SewingCompleted {
        prompt "Update bundle completion metrics"
      }
      on event CutOrder.GarmentsPacked {
        prompt "Update packed bundles and cycle time"
      }
    } with {
      briefly "Maintains bundle throughput metrics"
      described by "Projects bundle events into throughput analytics."
    }
  } with {
    briefly "Bundle throughput projections"
    described by "Maintains bundle flow and WIP tracking data."
  }

  // Projector for operator performance tracking
  projector OperatorPerformanceProjector is {
    updates repository CutOrderRepository

    record OperatorPerformanceStats is {
      operatorId is OperatorId with { briefly "Operator" described by "Operator identifier." }
      operatorName is String(1, 200) with { briefly "Name" described by "Operator name." }
      bundlesCompleted is Natural with { briefly "Bundles" described by "Bundles completed." }
      piecesProduced is Natural with { briefly "Pieces" described by "Pieces produced." }
      defectsProduced is Natural with { briefly "Defects" described by "Defects produced." }
      qualityRate is Decimal(5, 2) with { briefly "Quality rate" described by "Quality rate percent." }
      earnedMinutes is Decimal(10, 2) with { briefly "Earned" described by "Earned SAM." }
      attendedMinutes is Decimal(10, 2) with { briefly "Attended" described by "Attended minutes." }
      efficiency is Decimal(5, 2) with { briefly "Efficiency" described by "Efficiency percent." }
      avgBundleTime is Decimal(8, 2) with { briefly "Avg bundle time" described by "Average minutes per bundle." }
    } with {
      briefly "Operator performance statistics"
      described by "Individual operator performance metrics."
    }

    handler OperatorPerformanceHandler is {
      on event CutOrder.BundleAssigned {
        prompt "Track bundle assignment to operator"
      }
      on event CutOrder.SewingCompleted {
        prompt "Update operator production metrics"
      }
      on event CutOrder.TrimmingCompleted {
        prompt "Update operator trim metrics"
      }
      on event CutOrder.QualityCheckRecorded {
        prompt "Update operator quality metrics"
      }
    } with {
      briefly "Maintains operator performance metrics"
      described by "Projects production events into operator analytics."
    }
  } with {
    briefly "Operator performance projections"
    described by "Maintains individual operator performance data."
  }

  // Projector for quality metrics
  projector QualityMetricsProjector is {
    updates repository CutOrderRepository

    record QualityMetricsStats is {
      periodStart is Date with { briefly "Period start" described by "Start of period." }
      periodEnd is Date with { briefly "Period end" described by "End of period." }
      totalInspected is Natural with { briefly "Inspected" described by "Total garments inspected." }
      totalPassed is Natural with { briefly "Passed" described by "Total garments passed." }
      totalFailed is Natural with { briefly "Failed" described by "Total garments failed." }
      firstPassYield is Decimal(5, 2) with { briefly "FPY" described by "First pass yield percent." }
      defectsByType is many DefectSummary with { briefly "Defects" described by "Defects by type." }
      topDefectOperations is many String(1, 200) with { briefly "Problem ops" described by "Operations with most defects." }
    } with {
      briefly "Quality metrics statistics"
      described by "Quality inspection and defect metrics."
    }

    record DefectSummary is {
      defectType is DefectType with { briefly "Type" described by "Defect type." }
      count is Natural with { briefly "Count" described by "Defect count." }
      percentage is Decimal(5, 2) with { briefly "Percentage" described by "Percentage of total defects." }
    } with {
      briefly "Defect summary"
      described by "Summary of defects by type."
    }

    handler QualityMetricsHandler is {
      on event CutOrder.QualityCheckRecorded {
        prompt "Update quality metrics and defect tracking"
      }
      on event CutOrder.SewingCompleted {
        prompt "Update defect counts from sewing"
      }
    } with {
      briefly "Maintains quality metrics"
      described by "Projects quality events into analytics."
    }
  } with {
    briefly "Quality metrics projections"
    described by "Maintains quality and defect tracking data."
  }

} with {
  briefly "Bounded context for apparel manufacturing"
  described by {
    | The ApparelContext is the bounded context for
    | cut-sew-trim apparel production and tracking.
  }
}
