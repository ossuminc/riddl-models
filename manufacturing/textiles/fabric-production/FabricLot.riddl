// Fabric Production - FabricLot Entity
entity FabricLot is {
  // Commands
  command CreateFabricLot is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |New fabric lot identifier.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style number"
      described as {
        |Fabric style or design number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Customer order"
      described as {
        |Customer order reference.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Weaving spec"
      described as {
        |Weaving specifications.
      }
    }
    targetYards: Decimal(12,2) with {
      briefly "Target yards"
      described as {
        |Target production yardage.
      }
    }
  } with {
    briefly "Create fabric lot"
    described as {
      |Creates a new fabric production lot.
    }
  }
  command StartWarping is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    beamId: BeamId with {
      briefly "Beam ID"
      described as {
        |Warp beam identifier.
      }
    }
    yarnLots: YarnLotId+ with {
      briefly "Yarn lots"
      described as {
        |Yarn lots used for warp.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Warping operator.
      }
    }
  } with {
    briefly "Start warping"
    described as {
      |Begins warp preparation for weaving.
    }
  }
  command StartWeaving is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    loomId: LoomId with {
      briefly "Loom ID"
      described as {
        |Loom identifier.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Weaving operator.
      }
    }
  } with {
    briefly "Start weaving"
    described as {
      |Begins weaving on loom.
    }
  }
  command RecordWeavingDefect is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    defect: DefectRecord with {
      briefly "Defect"
      described as {
        |Defect information.
      }
    }
  } with {
    briefly "Record weaving defect"
    described as {
      |Records a defect found during weaving.
    }
  }
  command CompleteWeaving is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    actualYards: Decimal(12,2) with {
      briefly "Actual yards"
      described as {
        |Actual yardage woven.
      }
    }
    dimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Fabric dimensions.
      }
    }
  } with {
    briefly "Complete weaving"
    described as {
      |Completes weaving operation.
    }
  }
  command StartDyeing is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    dyeFormula: DyeFormula with {
      briefly "Dye formula"
      described as {
        |Dyeing formula and parameters.
      }
    }
    technicianId: String(1,200) with {
      briefly "Technician"
      described as {
        |Dyeing technician.
      }
    }
  } with {
    briefly "Start dyeing"
    described as {
      |Begins fabric dyeing process.
    }
  }
  command CompleteDyeing is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    colorMatchPassed: Boolean with {
      briefly "Color match"
      described as {
        |Whether color matches specification.
      }
    }
    colorfastnessRating: Natural with {
      briefly "Colorfastness"
      described as {
        |Colorfastness rating (1-5).
      }
    }
    technicianId: String(1,200) with {
      briefly "Technician"
      described as {
        |Dyeing technician.
      }
    }
  } with {
    briefly "Complete dyeing"
    described as {
      |Completes fabric dyeing process.
    }
  }
  command ApplyFinishing is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    finishingProcess: FinishingProcess with {
      briefly "Finishing process"
      described as {
        |Finishing process specification.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Finishing operator.
      }
    }
  } with {
    briefly "Apply finishing"
    described as {
      |Applies finishing treatments to fabric.
    }
  }
  command CompleteFinishing is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    finalDimensions: FabricDimensions with {
      briefly "Final dimensions"
      described as {
        |Final fabric dimensions.
      }
    }
    shrinkagePercent: Decimal(5,2) with {
      briefly "Shrinkage"
      described as {
        |Shrinkage percentage.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Finishing operator.
      }
    }
  } with {
    briefly "Complete finishing"
    described as {
      |Completes fabric finishing.
    }
  }
  command GradeFabric is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    grade: FabricGrade with {
      briefly "Grade"
      described as {
        |Quality grade result.
      }
    }
  } with {
    briefly "Grade fabric"
    described as {
      |Assigns quality grade to fabric lot.
    }
  }
  command ShipFabric is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot ID"
      described as {
        |Fabric lot identifier.
      }
    }
    shippingInfo: ShippingInfo with {
      briefly "Shipping info"
      described as {
        |Shipment details.
      }
    }
  } with {
    briefly "Ship fabric"
    described as {
      |Releases fabric lot for shipment.
    }
  }
  // Events
  event FabricLotCreated is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style"
      described as {
        |Style number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Order"
      described as {
        |Customer order.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Spec"
      described as {
        |Weaving specification.
      }
    }
    targetYards: Decimal(12,2) with {
      briefly "Target"
      described as {
        |Target yardage.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Fabric lot created"
    described as {
      |Emitted when a new fabric lot is created.
    }
  }
  event WarpingStarted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    beamId: BeamId with {
      briefly "Beam"
      described as {
        |Warp beam ID.
      }
    }
    yarnLots: YarnLotId+ with {
      briefly "Yarn lots"
      described as {
        |Yarn lots used.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Warping operator.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Warping started"
    described as {
      |Emitted when warping begins.
    }
  }
  event WeavingStarted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    loomId: LoomId with {
      briefly "Loom"
      described as {
        |Loom ID.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Weaving operator.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Weaving started"
    described as {
      |Emitted when weaving begins.
    }
  }
  event WeavingDefectRecorded is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    defect: DefectRecord with {
      briefly "Defect"
      described as {
        |Defect information.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Weaving defect recorded"
    described as {
      |Emitted when a weaving defect is recorded.
    }
  }
  event WeavingCompleted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    actualYards: Decimal(12,2) with {
      briefly "Yards"
      described as {
        |Actual yardage.
      }
    }
    dimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Fabric dimensions.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Weaving completed"
    described as {
      |Emitted when weaving is completed.
    }
  }
  event DyeingStarted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    dyeFormula: DyeFormula with {
      briefly "Formula"
      described as {
        |Dye formula.
      }
    }
    technicianId: String(1,200) with {
      briefly "Technician"
      described as {
        |Dyeing technician.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Dyeing started"
    described as {
      |Emitted when dyeing begins.
    }
  }
  event DyeingCompleted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    colorMatchPassed: Boolean with {
      briefly "Color match"
      described as {
        |Color match result.
      }
    }
    colorfastnessRating: Natural with {
      briefly "Colorfastness"
      described as {
        |Rating 1-5.
      }
    }
    technicianId: String(1,200) with {
      briefly "Technician"
      described as {
        |Dyeing technician.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Dyeing completed"
    described as {
      |Emitted when dyeing is completed.
    }
  }
  event FinishingApplied is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    finishingProcess: FinishingProcess with {
      briefly "Process"
      described as {
        |Finishing process.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Finishing operator.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Finishing applied"
    described as {
      |Emitted when finishing treatment is applied.
    }
  }
  event FinishingCompleted is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    finalDimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Final dimensions.
      }
    }
    shrinkagePercent: Decimal(5,2) with {
      briefly "Shrinkage"
      described as {
        |Shrinkage percent.
      }
    }
    operatorId: String(1,200) with {
      briefly "Operator"
      described as {
        |Finishing operator.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Finishing completed"
    described as {
      |Emitted when finishing is completed.
    }
  }
  event FabricGraded is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    grade: FabricGrade with {
      briefly "Grade"
      described as {
        |Quality grade.
      }
    }
    gradedAt: TimeStamp with {
      briefly "Graded"
      described as {
        |Grading time.
      }
    }
  } with {
    briefly "Fabric graded"
    described as {
      |Emitted when fabric is graded.
    }
  }
  event FabricShipped is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    shippingInfo: ShippingInfo with {
      briefly "Shipping"
      described as {
        |Shipment details.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Shipment time.
      }
    }
  } with {
    briefly "Fabric shipped"
    described as {
      |Emitted when fabric is shipped.
    }
  }
  // State Records
  record WeavingStateData is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style"
      described as {
        |Style number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Order"
      described as {
        |Customer order.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Spec"
      described as {
        |Weaving specification.
      }
    }
    targetYards: Decimal(12,2) with {
      briefly "Target"
      described as {
        |Target yardage.
      }
    }
    currentBeamId: BeamId? with {
      briefly "Beam"
      described as {
        |Warp beam ID.
      }
    }
    currentLoomId: LoomId? with {
      briefly "Loom"
      described as {
        |Loom ID.
      }
    }
    warpYarnLots: YarnLotId* with {
      briefly "Yarn lots"
      described as {
        |Yarn lots used.
      }
    }
    defects: DefectRecord* with {
      briefly "Defects"
      described as {
        |Defects recorded.
      }
    }
    fabricStatus: FabricStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Weaving state"
    described as {
      |State data during warping and weaving.
    }
  }
  record DyeingStateData is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style"
      described as {
        |Style number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Order"
      described as {
        |Customer order.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Spec"
      described as {
        |Weaving specification.
      }
    }
    actualYards: Decimal(12,2) with {
      briefly "Yards"
      described as {
        |Actual yardage.
      }
    }
    dimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Fabric dimensions.
      }
    }
    defects: DefectRecord* with {
      briefly "Defects"
      described as {
        |Defects recorded.
      }
    }
    dyeFormula: DyeFormula with {
      briefly "Formula"
      described as {
        |Dye formula.
      }
    }
    fabricStatus: FabricStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
  } with {
    briefly "Dyeing state"
    described as {
      |State data during dyeing process.
    }
  }
  record FinishingStateData is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style"
      described as {
        |Style number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Order"
      described as {
        |Customer order.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Spec"
      described as {
        |Weaving specification.
      }
    }
    actualYards: Decimal(12,2) with {
      briefly "Yards"
      described as {
        |Actual yardage.
      }
    }
    dimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Fabric dimensions.
      }
    }
    defects: DefectRecord* with {
      briefly "Defects"
      described as {
        |Defects recorded.
      }
    }
    dyeFormula: DyeFormula with {
      briefly "Formula"
      described as {
        |Dye formula.
      }
    }
    colorMatchPassed: Boolean with {
      briefly "Color match"
      described as {
        |Color match result.
      }
    }
    colorfastnessRating: Natural with {
      briefly "Colorfastness"
      described as {
        |Rating 1-5.
      }
    }
    finishingProcess: FinishingProcess with {
      briefly "Process"
      described as {
        |Finishing process.
      }
    }
    fabricStatus: FabricStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
  } with {
    briefly "Finishing state"
    described as {
      |State data during finishing process.
    }
  }
  record GradedStateData is  {
    fabricLotId: FabricLotId with {
      briefly "Fabric Lot"
      described as {
        |Fabric lot ID.
      }
    }
    styleNumber: String(1,50) with {
      briefly "Style"
      described as {
        |Style number.
      }
    }
    customerOrder: String(1,100)? with {
      briefly "Order"
      described as {
        |Customer order.
      }
    }
    weavingSpec: WeavingSpec with {
      briefly "Spec"
      described as {
        |Weaving specification.
      }
    }
    finalDimensions: FabricDimensions with {
      briefly "Dimensions"
      described as {
        |Final dimensions.
      }
    }
    defects: DefectRecord* with {
      briefly "Defects"
      described as {
        |Defects recorded.
      }
    }
    dyeFormula: DyeFormula with {
      briefly "Formula"
      described as {
        |Dye formula.
      }
    }
    colorMatchPassed: Boolean with {
      briefly "Color match"
      described as {
        |Color match result.
      }
    }
    finishingProcess: FinishingProcess with {
      briefly "Process"
      described as {
        |Finishing process.
      }
    }
    shrinkagePercent: Decimal(5,2) with {
      briefly "Shrinkage"
      described as {
        |Shrinkage percent.
      }
    }
    grade: FabricGrade with {
      briefly "Grade"
      described as {
        |Quality grade.
      }
    }
    fabricStatus: FabricStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
  } with {
    briefly "Graded state"
    described as {
      |State data for graded fabric ready to ship.
    }
  }
  // States
  state WeavingState of type FabricLot.WeavingStateData
  state DyeingState of type FabricLot.DyeingStateData
  state FinishingState of type FabricLot.FinishingStateData
  state GradedState of type FabricLot.GradedStateData
  // Handler
  handler FabricLotHandler is {
    on command CreateFabricLot is {
      morph entity FabricContext.FabricLot to state FabricContext.FabricLot.WeavingState with command CreateFabricLot
      tell event FabricLotCreated to entity FabricContext.FabricLot
    }
    on command StartWarping is {
      tell event WarpingStarted to entity FabricContext.FabricLot
    }
    on command StartWeaving is {
      tell event WeavingStarted to entity FabricContext.FabricLot
    }
    on command RecordWeavingDefect is {
      tell event WeavingDefectRecorded to entity FabricContext.FabricLot
    }
    on command CompleteWeaving is {
      tell event WeavingCompleted to entity FabricContext.FabricLot
    }
    on command StartDyeing is {
      morph entity FabricContext.FabricLot to state FabricContext.FabricLot.DyeingState with command StartDyeing
      tell event DyeingStarted to entity FabricContext.FabricLot
    }
    on command CompleteDyeing is {
      tell event DyeingCompleted to entity FabricContext.FabricLot
    }
    on command ApplyFinishing is {
      morph entity FabricContext.FabricLot to state FabricContext.FabricLot.FinishingState with command ApplyFinishing
      tell event FinishingApplied to entity FabricContext.FabricLot
    }
    on command CompleteFinishing is {
      tell event FinishingCompleted to entity FabricContext.FabricLot
    }
    on command GradeFabric is {
      morph entity FabricContext.FabricLot to state FabricContext.FabricLot.GradedState with command GradeFabric
      tell event FabricGraded to entity FabricContext.FabricLot
    }
    on command ShipFabric is {
      tell event FabricShipped to entity FabricContext.FabricLot
    }
  } with {
    briefly "Processes fabric lot commands"
    described as {
      | Handles fabric lot lifecycle from creation through
      | weaving, dyeing, finishing, grading, and shipment.
    }
  }
} with {
  briefly "FabricLot aggregate"
  described as {
    | The FabricLot entity manages the production lifecycle
    | of a fabric lot through weaving, dyeing, finishing,
    | quality grading, and shipment.
  }
}
