// Fabric Production - Fabric Context

context FabricContext is {

  include "types.riddl"
  include "FabricLot.riddl"

  // Repository for fabric lot persistence
  repository FabricLotRepository is {
    schema FabricLotData is relational
      of fabricLots as FabricLot
      index on field FabricLot.fabricLotId
      index on field FabricLot.styleNumber
      index on field FabricLot.status

    handler FabricLotPersistence is {
      on event FabricLot.FabricLotCreated {
        prompt "Store new fabric lot"
      }
      on event FabricLot.WarpingStarted {
        prompt "Update with warping info"
      }
      on event FabricLot.WeavingStarted {
        prompt "Update with loom assignment"
      }
      on event FabricLot.WeavingDefectRecorded {
        prompt "Store weaving defect"
      }
      on event FabricLot.WeavingCompleted {
        prompt "Update weaving completion"
      }
      on event FabricLot.DyeingStarted {
        prompt "Update to dyeing status"
      }
      on event FabricLot.DyeingCompleted {
        prompt "Update dyeing completion"
      }
      on event FabricLot.FinishingApplied {
        prompt "Update to finishing status"
      }
      on event FabricLot.FinishingCompleted {
        prompt "Update finishing completion"
      }
      on event FabricLot.FabricGraded {
        prompt "Store fabric grade"
      }
      on event FabricLot.FabricShipped {
        prompt "Update to shipped status"
      }
    } with {
      briefly "Persists fabric lot events"
      described by "Handles event-driven persistence for fabric lots."
    }
  } with {
    briefly "Fabric lot data persistence"
    described by {
      | The FabricLotRepository provides persistent storage for
      | fabric lots, production data, and quality records.
    }
  }

  // Projector for loom efficiency analytics
  projector LoomEfficiencyAnalytics is {
    updates repository FabricLotRepository

    record LoomMetrics is {
      loomId is LoomId with { briefly "Loom" described by "Loom identifier." }
      totalRunHours is Decimal(10, 2) with { briefly "Run hours" described by "Total run hours." }
      totalDowntimeHours is Decimal(10, 2) with { briefly "Downtime" described by "Total downtime hours." }
      yardsProduced is Decimal(14, 2) with { briefly "Yards" described by "Total yards produced." }
      defectsPerThousandYards is Decimal(8, 4) with { briefly "DPKY" described by "Defects per 1000 yards." }
      efficiency is Decimal(5, 4) with { briefly "Efficiency" described by "Loom efficiency ratio." }
      avgPicksPerMinute is Natural with { briefly "Avg PPM" described by "Average picks per minute." }
    } with {
      briefly "Loom metrics"
      described by "Loom performance metrics."
    }

    handler LoomEfficiencyHandler is {
      on event FabricLot.WeavingStarted {
        prompt "Record loom start time"
      }
      on event FabricLot.WeavingCompleted {
        prompt "Calculate loom efficiency"
      }
      on event FabricLot.WeavingDefectRecorded {
        prompt "Update defect rate"
      }
    } with {
      briefly "Calculates loom efficiency"
      described by "Projects events into loom efficiency metrics."
    }
  } with {
    briefly "Loom efficiency projections"
    described by "Maintains loom performance analytics."
  }

  // Projector for dye lot consistency tracking
  projector DyeLotConsistencyAnalytics is {
    updates repository FabricLotRepository

    record DyeLotMetrics is {
      dyeLotId is DyeLotId with { briefly "Dye lot" described by "Dye lot identifier." }
      colorCode is String(1, 50) with { briefly "Color" described by "Color code." }
      fabricLotsProcessed is Natural with { briefly "Lots" described by "Fabric lots processed." }
      colorMatchPassRate is Decimal(5, 4) with { briefly "Pass rate" described by "Color match pass rate." }
      avgColorfastness is Decimal(3, 2) with { briefly "Avg colorfastness" described by "Average colorfastness rating." }
      totalYardsDyed is Decimal(14, 2) with { briefly "Yards" described by "Total yards dyed." }
      redyeRate is Decimal(5, 4) with { briefly "Redye rate" described by "Redye percentage." }
    } with {
      briefly "Dye lot metrics"
      described by "Dye lot consistency metrics."
    }

    handler DyeLotConsistencyHandler is {
      on event FabricLot.DyeingStarted {
        prompt "Track dye lot usage"
      }
      on event FabricLot.DyeingCompleted {
        prompt "Update color match statistics"
      }
    } with {
      briefly "Tracks dye consistency"
      described by "Projects events into dye lot consistency metrics."
    }
  } with {
    briefly "Dye lot consistency projections"
    described by "Maintains dye batch consistency analytics."
  }

  // Projector for grading yield analysis
  projector GradingYieldAnalytics is {
    updates repository FabricLotRepository

    record GradingMetrics is {
      periodStart is Date with { briefly "Period start" described by "Analysis period start." }
      periodEnd is Date with { briefly "Period end" described by "Analysis period end." }
      totalLotsGraded is Natural with { briefly "Lots" described by "Total lots graded." }
      premiumPercent is Decimal(5, 4) with { briefly "Premium" described by "Premium grade percentage." }
      firstQualityPercent is Decimal(5, 4) with { briefly "First" described by "First quality percentage." }
      secondQualityPercent is Decimal(5, 4) with { briefly "Second" described by "Second quality percentage." }
      utilityPercent is Decimal(5, 4) with { briefly "Utility" described by "Utility grade percentage." }
      rejectPercent is Decimal(5, 4) with { briefly "Reject" described by "Reject percentage." }
      avgPointsPerHundredYards is Decimal(8, 2) with { briefly "Avg points" described by "Average defect points." }
      totalUsableYards is Decimal(16, 2) with { briefly "Usable" described by "Total usable yards." }
      totalWasteYards is Decimal(14, 2) with { briefly "Waste" described by "Total waste yards." }
    } with {
      briefly "Grading metrics"
      described by "Fabric grading yield metrics."
    }

    handler GradingYieldHandler is {
      on event FabricLot.FabricGraded {
        prompt "Update grading statistics"
      }
      on event FabricLot.FabricShipped {
        prompt "Update shipment statistics"
      }
    } with {
      briefly "Calculates grading yields"
      described by "Projects events into grading yield analytics."
    }
  } with {
    briefly "Grading yield projections"
    described by "Maintains fabric grading and yield analytics."
  }

} with {
  briefly "Bounded context for fabric production"
  described by {
    | The FabricContext is the bounded context for textile
    | fabric production including weaving, dyeing, finishing,
    | and quality control operations.
  }
}
