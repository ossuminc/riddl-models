// Fabric Production - Fabric Context
context FabricContext is {
  include "types.riddl"
  include "FabricLot.riddl"
  // Repository for fabric lot persistence
  repository FabricLotRepository is {
    schema FabricLotData is relational
      of fabricLots as type FabricLot
        index on field FabricLot.fabricLotId
        index on field FabricLot.styleNumber
        index on field FabricLot.status

    handler FabricLotPersistence is {
      on command FabricLot.CreateFabricLot is {
        prompt "Store new fabric lot"
      }
      on command FabricLot.StartWarping is {
        prompt "Update with warping info"
      }
      on command FabricLot.StartWeaving is {
        prompt "Update with loom assignment"
      }
      on command FabricLot.RecordWeavingDefect is {
        prompt "Store weaving defect"
      }
      on command FabricLot.CompleteWeaving is {
        prompt "Update weaving completion"
      }
      on command FabricLot.StartDyeing is {
        prompt "Update to dyeing status"
      }
      on command FabricLot.CompleteDyeing is {
        prompt "Update dyeing completion"
      }
      on command FabricLot.ApplyFinishing is {
        prompt "Update to finishing status"
      }
      on command FabricLot.CompleteFinishing is {
        prompt "Update finishing completion"
      }
      on command FabricLot.GradeFabric is {
        prompt "Store fabric grade"
      }
      on command FabricLot.ShipFabric is {
        prompt "Update to shipped status"
      }
    } with {
      briefly "Persists fabric lot events"
      described as {
        |Handles command-driven persistence for fabric lots.
      }
    }
  } with {
    briefly "Fabric lot data persistence"
    described as {
      | The FabricLotRepository provides persistent storage for
      | fabric lots, production data, and quality records.
    }
  }
  // Projector for loom efficiency analytics
  projector LoomEfficiencyAnalytics is {
    record LoomMetrics is  {
      loomId: LoomId with {
        briefly "Loom"
        described as {
          |Loom identifier.
        }
      }
      totalRunHours: Decimal(10,2) with {
        briefly "Run hours"
        described as {
          |Total run hours.
        }
      }
      totalDowntimeHours: Decimal(10,2) with {
        briefly "Downtime"
        described as {
          |Total downtime hours.
        }
      }
      yardsProduced: Decimal(14,2) with {
        briefly "Yards"
        described as {
          |Total yards produced.
        }
      }
      defectsPerThousandYards: Decimal(8,4) with {
        briefly "DPKY"
        described as {
          |Defects per 1000 yards.
        }
      }
      efficiency: Decimal(5,4) with {
        briefly "Efficiency"
        described as {
          |Loom efficiency ratio.
        }
      }
      avgPicksPerMinute: Natural with {
        briefly "Avg PPM"
        described as {
          |Average picks per minute.
        }
      }
    } with {
      briefly "Loom metrics"
      described as {
        |Loom performance metrics.
      }
    }
    handler LoomEfficiencyHandler is {
      on event FabricLot.WeavingStarted is {
        prompt "Record loom start time"
      }
      on event FabricLot.WeavingCompleted is {
        prompt "Calculate loom efficiency"
      }
      on event FabricLot.WeavingDefectRecorded is {
        prompt "Update defect rate"
      }
    } with {
      briefly "Calculates loom efficiency"
      described as {
        |Projects events into loom efficiency metrics.
      }
    }
  } with {
    briefly "Loom efficiency projections"
    described as {
      |Maintains loom performance analytics.
    }
  }
  // Projector for dye lot consistency tracking
  projector DyeLotConsistencyAnalytics is {
    record DyeLotMetrics is  {
      dyeLotId: DyeLotId with {
        briefly "Dye lot"
        described as {
          |Dye lot identifier.
        }
      }
      colorCode: String(1,50) with {
        briefly "Color"
        described as {
          |Color code.
        }
      }
      fabricLotsProcessed: Natural with {
        briefly "Lots"
        described as {
          |Fabric lots processed.
        }
      }
      colorMatchPassRate: Decimal(5,4) with {
        briefly "Pass rate"
        described as {
          |Color match pass rate.
        }
      }
      avgColorfastness: Decimal(3,2) with {
        briefly "Avg colorfastness"
        described as {
          |Average colorfastness rating.
        }
      }
      totalYardsDyed: Decimal(14,2) with {
        briefly "Yards"
        described as {
          |Total yards dyed.
        }
      }
      redyeRate: Decimal(5,4) with {
        briefly "Redye rate"
        described as {
          |Redye percentage.
        }
      }
    } with {
      briefly "Dye lot metrics"
      described as {
        |Dye lot consistency metrics.
      }
    }
    handler DyeLotConsistencyHandler is {
      on event FabricLot.DyeingStarted is {
        prompt "Track dye lot usage"
      }
      on event FabricLot.DyeingCompleted is {
        prompt "Update color match statistics"
      }
    } with {
      briefly "Tracks dye consistency"
      described as {
        |Projects events into dye lot consistency metrics.
      }
    }
  } with {
    briefly "Dye lot consistency projections"
    described as {
      |Maintains dye batch consistency analytics.
    }
  }
  // Projector for grading yield analysis
  projector GradingYieldAnalytics is {
    record GradingMetrics is  {
      periodStart: Date with {
        briefly "Period start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: Date with {
        briefly "Period end"
        described as {
          |Analysis period end.
        }
      }
      totalLotsGraded: Natural with {
        briefly "Lots"
        described as {
          |Total lots graded.
        }
      }
      premiumPercent: Decimal(5,4) with {
        briefly "Premium"
        described as {
          |Premium grade percentage.
        }
      }
      firstQualityPercent: Decimal(5,4) with {
        briefly "First"
        described as {
          |First quality percentage.
        }
      }
      secondQualityPercent: Decimal(5,4) with {
        briefly "Second"
        described as {
          |Second quality percentage.
        }
      }
      utilityPercent: Decimal(5,4) with {
        briefly "Utility"
        described as {
          |Utility grade percentage.
        }
      }
      rejectPercent: Decimal(5,4) with {
        briefly "Reject"
        described as {
          |Reject percentage.
        }
      }
      avgPointsPerHundredYards: Decimal(8,2) with {
        briefly "Avg points"
        described as {
          |Average defect points.
        }
      }
      totalUsableYards: Decimal(16,2) with {
        briefly "Usable"
        described as {
          |Total usable yards.
        }
      }
      totalWasteYards: Decimal(14,2) with {
        briefly "Waste"
        described as {
          |Total waste yards.
        }
      }
    } with {
      briefly "Grading metrics"
      described as {
        |Fabric grading yield metrics.
      }
    }
    handler GradingYieldHandler is {
      on event FabricLot.FabricGraded is {
        prompt "Update grading statistics"
      }
      on event FabricLot.FabricShipped is {
        prompt "Update shipment statistics"
      }
    } with {
      briefly "Calculates grading yields"
      described as {
        |Projects events into grading yield analytics.
      }
    }
  } with {
    briefly "Grading yield projections"
    described as {
      |Maintains fabric grading and yield analytics.
    }
  }
} with {
  briefly "Bounded context for fabric production"
  described as {
    | The FabricContext is the bounded context for textile
    | fabric production including weaving, dyeing, finishing,
    | and quality control operations.
  }
}
