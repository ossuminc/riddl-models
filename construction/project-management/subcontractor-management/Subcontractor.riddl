// Subcontractor Management - Subcontractor Entity

entity Subcontractor is {

  // Commands
  command RegisterSubcontractor is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "New subcontractor identifier."
    }
    info is SubcontractorInfo with {
      briefly "Info"
      described by "Subcontractor information."
    }
    insurance is many Insurance with {
      briefly "Insurance"
      described by "Insurance policies."
    }
  } with {
    briefly "Register subcontractor"
    described by "Registers a new subcontractor."
  }

  command ApproveSubcontractor is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor to approve."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved."
    }
  } with {
    briefly "Approve subcontractor"
    described by "Approves subcontractor for work."
  }

  command UpdateInfo is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    info is SubcontractorInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update info"
    described by "Updates subcontractor information."
  }

  command UpdateInsurance is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    insurance is many Insurance with {
      briefly "Insurance"
      described by "Updated insurance."
    }
  } with {
    briefly "Update insurance"
    described by "Updates insurance policies."
  }

  command AwardSubcontract is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    subcontract is Subcontract with {
      briefly "Subcontract"
      described by "Subcontract details."
    }
  } with {
    briefly "Award subcontract"
    described by "Awards a subcontract."
  }

  command SubmitPayApplication is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    application is PayApplication with {
      briefly "Application"
      described by "Pay application."
    }
  } with {
    briefly "Submit pay application"
    described by "Submits payment request."
  }

  command ApprovePayApplication is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    applicationId is UUID with {
      briefly "Application ID"
      described by "Application to approve."
    }
    amountApproved is Money with {
      briefly "Amount"
      described by "Approved amount."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved."
    }
  } with {
    briefly "Approve pay application"
    described by "Approves payment request."
  }

  command RatePerformance is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    rating is PerformanceRating with {
      briefly "Rating"
      described by "Performance rating."
    }
  } with {
    briefly "Rate performance"
    described by "Records performance rating."
  }

  command PutOnHold is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Put on hold"
    described by "Puts subcontractor on hold."
  }

  command ReactivateSubcontractor is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
  } with {
    briefly "Reactivate"
    described by "Reactivates subcontractor."
  }

  command TerminateSubcontractor is {
    subcontractorId is SubcontractorId with {
      briefly "Subcontractor ID"
      described by "Subcontractor ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Termination reason."
    }
    terminatedBy is String(1, 100) with {
      briefly "Terminated by"
      described by "Who terminated."
    }
  } with {
    briefly "Terminate"
    described by "Terminates subcontractor relationship."
  }

  // Events
  event SubcontractorRegistered is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Subcontractor was registered"
    described by "Emitted when subcontractor registers."
  }

  event SubcontractorApproved is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Subcontractor was approved"
    described by "Emitted when subcontractor is approved."
  }

  event InfoUpdated is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Info was updated"
    described by "Emitted when information is updated."
  }

  event InsuranceUpdated is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Insurance was updated"
    described by "Emitted when insurance is updated."
  }

  event SubcontractAwarded is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    subcontract is Subcontract with { briefly "Subcontract" described by "Awarded subcontract." }
    awardedAt is TimeStamp with { briefly "Awarded" described by "Award time." }
  } with {
    briefly "Subcontract was awarded"
    described by "Emitted when subcontract is awarded."
  }

  event PayApplicationSubmitted is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    application is PayApplication with { briefly "Application" described by "Pay application." }
  } with {
    briefly "Pay application was submitted"
    described by "Emitted when pay app is submitted."
  }

  event PayApplicationApproved is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    applicationId is UUID with { briefly "Application" described by "Application ID." }
    amountApproved is Money with { briefly "Amount" described by "Approved amount." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Pay application was approved"
    described by "Emitted when pay app is approved."
  }

  event PerformanceRated is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    rating is PerformanceRating with { briefly "Rating" described by "Performance rating." }
  } with {
    briefly "Performance was rated"
    described by "Emitted when rating is recorded."
  }

  event SubcontractorPutOnHold is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Subcontractor was put on hold"
    described by "Emitted when subcontractor is held."
  }

  event SubcontractorReactivated is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Subcontractor was reactivated"
    described by "Emitted when subcontractor is reactivated."
  }

  event SubcontractorTerminated is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Subcontractor was terminated"
    described by "Emitted when relationship ends."
  }

  // State Records
  record PendingSubcontractorData is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    insurance is many Insurance with { briefly "Insurance" described by "Insurance policies." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Pending subcontractor data"
    described by "State data for pending subcontractor."
  }

  record ApprovedSubcontractorData is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    insurance is many Insurance with { briefly "Insurance" described by "Insurance policies." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Approved subcontractor data"
    described by "State data for approved subcontractor."
  }

  record ActiveSubcontractorData is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    insurance is many Insurance with { briefly "Insurance" described by "Insurance policies." }
    subcontracts is many Subcontract with { briefly "Subcontracts" described by "Active subcontracts." }
    payApplications is many PayApplication with { briefly "Pay apps" described by "Pay applications." }
    ratings is many PerformanceRating with { briefly "Ratings" described by "Performance ratings." }
  } with {
    briefly "Active subcontractor data"
    described by "State data for active subcontractor."
  }

  record OnHoldSubcontractorData is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "On hold subcontractor data"
    described by "State data for held subcontractor."
  }

  record TerminatedSubcontractorData is {
    subcontractorId is SubcontractorId with { briefly "Subcontractor" described by "Subcontractor ID." }
    info is SubcontractorInfo with { briefly "Info" described by "Subcontractor info." }
    reason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Terminated subcontractor data"
    described by "State data for terminated subcontractor."
  }

  // States
  state PendingState of Subcontractor.PendingSubcontractorData with {
    briefly "Subcontractor is pending"
    described by "Subcontractor awaiting approval."
  }

  state ApprovedState of Subcontractor.ApprovedSubcontractorData with {
    briefly "Subcontractor is approved"
    described by "Subcontractor approved for work."
  }

  state ActiveState of Subcontractor.ActiveSubcontractorData with {
    briefly "Subcontractor is active"
    described by "Subcontractor has active contracts."
  }

  state OnHoldState of Subcontractor.OnHoldSubcontractorData with {
    briefly "Subcontractor is on hold"
    described by "Subcontractor temporarily inactive."
  }

  state TerminatedState of Subcontractor.TerminatedSubcontractorData with {
    briefly "Subcontractor is terminated"
    described by "Subcontractor relationship ended."
  }

  // Handler
  handler SubcontractorHandler is {
    on command RegisterSubcontractor {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.PendingState with command RegisterSubcontractor
      tell event SubcontractorRegistered to entity SubcontractorContext.Subcontractor
    }

    on command ApproveSubcontractor {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.ApprovedState with command ApproveSubcontractor
      tell event SubcontractorApproved to entity SubcontractorContext.Subcontractor
    }

    on command UpdateInfo {
      tell event InfoUpdated to entity SubcontractorContext.Subcontractor
    }

    on command UpdateInsurance {
      tell event InsuranceUpdated to entity SubcontractorContext.Subcontractor
    }

    on command AwardSubcontract {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.ActiveState with command AwardSubcontract
      tell event SubcontractAwarded to entity SubcontractorContext.Subcontractor
    }

    on command SubmitPayApplication {
      tell event PayApplicationSubmitted to entity SubcontractorContext.Subcontractor
    }

    on command ApprovePayApplication {
      tell event PayApplicationApproved to entity SubcontractorContext.Subcontractor
    }

    on command RatePerformance {
      tell event PerformanceRated to entity SubcontractorContext.Subcontractor
    }

    on command PutOnHold {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.OnHoldState with command PutOnHold
      tell event SubcontractorPutOnHold to entity SubcontractorContext.Subcontractor
    }

    on command ReactivateSubcontractor {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.ActiveState with command ReactivateSubcontractor
      tell event SubcontractorReactivated to entity SubcontractorContext.Subcontractor
    }

    on command TerminateSubcontractor {
      morph entity SubcontractorContext.Subcontractor to state SubcontractorContext.Subcontractor.TerminatedState with command TerminateSubcontractor
      tell event SubcontractorTerminated to entity SubcontractorContext.Subcontractor
    }
  } with {
    briefly "Processes subcontractor commands"
    described by {
      | Handles subcontractor lifecycle including registration,
      | contracts, payments, and performance.
    }
  }

} with {
  briefly "Subcontractor aggregate"
  described by {
    | The Subcontractor entity manages subcontractor
    | relationships from registration through contracts and payments.
  }
}
