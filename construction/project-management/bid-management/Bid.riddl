// Bid Management - Bid Entity
entity Bid is {
  // Commands
  command CreateBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |New bid identifier.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP being responded to.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Bidding contractor.
      }
    }
  } with {
    briefly "Create bid"
    described as {
      |Creates a new bid draft.
    }
  }
  command SubmitProposal is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid identifier.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Bid proposal details.
      }
    }
  } with {
    briefly "Submit proposal"
    described as {
      |Submits bid proposal.
    }
  }
  command ReviseProposal is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid identifier.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Revised proposal.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Revision reason.
      }
    }
  } with {
    briefly "Revise proposal"
    described as {
      |Revises submitted proposal.
    }
  }
  command WithdrawBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to withdraw.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
  } with {
    briefly "Withdraw bid"
    described as {
      |Withdraws bid from consideration.
    }
  }
  command BeginReview is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to review.
      }
    }
    reviewer: String(1,100) with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
  } with {
    briefly "Begin review"
    described as {
      |Starts bid review process.
    }
  }
  command ScoreBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to score.
      }
    }
    score: BidScore with {
      briefly "Score"
      described as {
        |Evaluation score.
      }
    }
  } with {
    briefly "Score bid"
    described as {
      |Records bid evaluation score.
    }
  }
  command ShortlistBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to shortlist.
      }
    }
    shortlistedBy: String(1,100) with {
      briefly "By"
      described as {
        |Who shortlisted.
      }
    }
  } with {
    briefly "Shortlist bid"
    described as {
      |Adds bid to shortlist.
    }
  }
  command AwardBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to award.
      }
    }
    awardedBy: String(1,100) with {
      briefly "By"
      described as {
        |Who awarded.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Award notes.
      }
    }
  } with {
    briefly "Award bid"
    described as {
      |Awards contract to bidder.
    }
  }
  command RejectBid is  {
    bidId: BidId with {
      briefly "Bid ID"
      described as {
        |Bid to reject.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: String(1,100) with {
      briefly "By"
      described as {
        |Who rejected.
      }
    }
  } with {
    briefly "Reject bid"
    described as {
      |Rejects bid from consideration.
    }
  }
  // Events
  event BidCreated is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Bid was created"
    described as {
      |Emitted when bid draft is created.
    }
  }
  event ProposalSubmitted is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Submitted proposal.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Proposal was submitted"
    described as {
      |Emitted when proposal is submitted.
    }
  }
  event ProposalRevised is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Revised proposal.
      }
    }
    revisedAt: TimeStamp with {
      briefly "Revised"
      described as {
        |Revision time.
      }
    }
  } with {
    briefly "Proposal was revised"
    described as {
      |Emitted when proposal is revised.
    }
  }
  event BidWithdrawn is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Bid was withdrawn"
    described as {
      |Emitted when bid is withdrawn.
    }
  }
  event ReviewBegan is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    reviewer: String(1,100) with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
    beganAt: TimeStamp with {
      briefly "Began"
      described as {
        |Review start time.
      }
    }
  } with {
    briefly "Review began"
    described as {
      |Emitted when bid review starts.
    }
  }
  event BidScored is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    score: BidScore with {
      briefly "Score"
      described as {
        |Evaluation score.
      }
    }
  } with {
    briefly "Bid was scored"
    described as {
      |Emitted when bid is scored.
    }
  }
  event BidShortlisted is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    shortlistedAt: TimeStamp with {
      briefly "Shortlisted"
      described as {
        |Shortlist time.
      }
    }
  } with {
    briefly "Bid was shortlisted"
    described as {
      |Emitted when bid is shortlisted.
    }
  }
  event BidAwarded is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    awardedAt: TimeStamp with {
      briefly "Awarded"
      described as {
        |Award time.
      }
    }
  } with {
    briefly "Bid was awarded"
    described as {
      |Emitted when bid is awarded.
    }
  }
  event BidRejected is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Bid was rejected"
    described as {
      |Emitted when bid is rejected.
    }
  }
  // State Records
  record DraftBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Draft bid data"
    described as {
      |State data for draft bid.
    }
  }
  record SubmittedBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Submitted proposal.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Submitted bid data"
    described as {
      |State data for submitted bid.
    }
  }
  record UnderReviewBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Proposal.
      }
    }
    reviewer: String(1,100) with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
    updatedScore: BidScore? with {
      briefly "Score"
      described as {
        |Evaluation score.
      }
    }
    reviewBeganAt: TimeStamp with {
      briefly "Began"
      described as {
        |Review start.
      }
    }
  } with {
    briefly "Under review bid data"
    described as {
      |State data for bid under review.
    }
  }
  record ShortlistedBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Proposal.
      }
    }
    score: BidScore with {
      briefly "Score"
      described as {
        |Evaluation score.
      }
    }
    shortlistedAt: TimeStamp with {
      briefly "Shortlisted"
      described as {
        |Shortlist time.
      }
    }
  } with {
    briefly "Shortlisted bid data"
    described as {
      |State data for shortlisted bid.
    }
  }
  record AwardedBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    proposal: BidProposal with {
      briefly "Proposal"
      described as {
        |Winning proposal.
      }
    }
    awardedAt: TimeStamp with {
      briefly "Awarded"
      described as {
        |Award time.
      }
    }
  } with {
    briefly "Awarded bid data"
    described as {
      |State data for awarded bid.
    }
  }
  record RejectedBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Rejected bid data"
    described as {
      |State data for rejected bid.
    }
  }
  record WithdrawnBidData is  {
    bidId: BidId with {
      briefly "Bid"
      described as {
        |Bid ID.
      }
    }
    rfpId: UUID with {
      briefly "RFP"
      described as {
        |RFP ID.
      }
    }
    contractorId: ContractorId with {
      briefly "Contractor"
      described as {
        |Contractor ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Withdrawn bid data"
    described as {
      |State data for withdrawn bid.
    }
  }
  // States
  state DraftState of type Bid.DraftBidData
  state SubmittedState of type Bid.SubmittedBidData
  state UnderReviewState of type Bid.UnderReviewBidData
  state ShortlistedState of type Bid.ShortlistedBidData
  state AwardedState of type Bid.AwardedBidData
  state RejectedState of type Bid.RejectedBidData
  state WithdrawnState of type Bid.WithdrawnBidData
  // Handler
  handler BidHandler is {
    on command CreateBid is {
      morph entity BidContext.Bid to state BidContext.Bid.DraftState with command CreateBid
      tell event BidCreated to entity BidContext.Bid
    }
    on command SubmitProposal is {
      morph entity BidContext.Bid to state BidContext.Bid.SubmittedState with command SubmitProposal
      tell event ProposalSubmitted to entity BidContext.Bid
    }
    on command ReviseProposal is {
      tell event ProposalRevised to entity BidContext.Bid
    }
    on command WithdrawBid is {
      morph entity BidContext.Bid to state BidContext.Bid.WithdrawnState with command WithdrawBid
      tell event BidWithdrawn to entity BidContext.Bid
    }
    on command BeginReview is {
      morph entity BidContext.Bid to state BidContext.Bid.UnderReviewState with command BeginReview
      tell event ReviewBegan to entity BidContext.Bid
    }
    on command ScoreBid is {
      tell event BidScored to entity BidContext.Bid
    }
    on command ShortlistBid is {
      morph entity BidContext.Bid to state BidContext.Bid.ShortlistedState with command ShortlistBid
      tell event BidShortlisted to entity BidContext.Bid
    }
    on command AwardBid is {
      morph entity BidContext.Bid to state BidContext.Bid.AwardedState with command AwardBid
      tell event BidAwarded to entity BidContext.Bid
    }
    on command RejectBid is {
      morph entity BidContext.Bid to state BidContext.Bid.RejectedState with command RejectBid
      tell event BidRejected to entity BidContext.Bid
    }
  } with {
    briefly "Processes bid commands"
    described as {
      | Handles bid lifecycle including creation,
      | submission, evaluation, and award.
    }
  }
} with {
  briefly "Bid aggregate"
  described as {
    | The Bid entity manages construction bids
    | from creation through evaluation and award.
  }
}
