// Bid Management - Bid Entity

entity Bid is {

  // Commands
  command CreateBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "New bid identifier."
    }
    rfpId is UUID with {
      briefly "RFP"
      described by "RFP being responded to."
    }
    contractorId is ContractorId with {
      briefly "Contractor"
      described by "Bidding contractor."
    }
  } with {
    briefly "Create bid"
    described by "Creates a new bid draft."
  }

  command SubmitProposal is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid identifier."
    }
    proposal is BidProposal with {
      briefly "Proposal"
      described by "Bid proposal details."
    }
  } with {
    briefly "Submit proposal"
    described by "Submits bid proposal."
  }

  command ReviseProposal is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid identifier."
    }
    proposal is BidProposal with {
      briefly "Proposal"
      described by "Revised proposal."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Revision reason."
    }
  } with {
    briefly "Revise proposal"
    described by "Revises submitted proposal."
  }

  command WithdrawBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to withdraw."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Withdrawal reason."
    }
  } with {
    briefly "Withdraw bid"
    described by "Withdraws bid from consideration."
  }

  command BeginReview is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to review."
    }
    reviewer is String(1, 100) with {
      briefly "Reviewer"
      described by "Assigned reviewer."
    }
  } with {
    briefly "Begin review"
    described by "Starts bid review process."
  }

  command ScoreBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to score."
    }
    score is BidScore with {
      briefly "Score"
      described by "Evaluation score."
    }
  } with {
    briefly "Score bid"
    described by "Records bid evaluation score."
  }

  command ShortlistBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to shortlist."
    }
    shortlistedBy is String(1, 100) with {
      briefly "By"
      described by "Who shortlisted."
    }
  } with {
    briefly "Shortlist bid"
    described by "Adds bid to shortlist."
  }

  command AwardBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to award."
    }
    awardedBy is String(1, 100) with {
      briefly "By"
      described by "Who awarded."
    }
    notes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Award notes."
    }
  } with {
    briefly "Award bid"
    described by "Awards contract to bidder."
  }

  command RejectBid is {
    bidId is BidId with {
      briefly "Bid ID"
      described by "Bid to reject."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
    rejectedBy is String(1, 100) with {
      briefly "By"
      described by "Who rejected."
    }
  } with {
    briefly "Reject bid"
    described by "Rejects bid from consideration."
  }

  // Events
  event BidCreated is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Bid was created"
    described by "Emitted when bid draft is created."
  }

  event ProposalSubmitted is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Submitted proposal." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Proposal was submitted"
    described by "Emitted when proposal is submitted."
  }

  event ProposalRevised is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Revised proposal." }
    revisedAt is TimeStamp with { briefly "Revised" described by "Revision time." }
  } with {
    briefly "Proposal was revised"
    described by "Emitted when proposal is revised."
  }

  event BidWithdrawn is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Bid was withdrawn"
    described by "Emitted when bid is withdrawn."
  }

  event ReviewBegan is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    reviewer is String(1, 100) with { briefly "Reviewer" described by "Assigned reviewer." }
    beganAt is TimeStamp with { briefly "Began" described by "Review start time." }
  } with {
    briefly "Review began"
    described by "Emitted when bid review starts."
  }

  event BidScored is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    score is BidScore with { briefly "Score" described by "Evaluation score." }
  } with {
    briefly "Bid was scored"
    described by "Emitted when bid is scored."
  }

  event BidShortlisted is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    shortlistedAt is TimeStamp with { briefly "Shortlisted" described by "Shortlist time." }
  } with {
    briefly "Bid was shortlisted"
    described by "Emitted when bid is shortlisted."
  }

  event BidAwarded is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    awardedAt is TimeStamp with { briefly "Awarded" described by "Award time." }
  } with {
    briefly "Bid was awarded"
    described by "Emitted when bid is awarded."
  }

  event BidRejected is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Bid was rejected"
    described by "Emitted when bid is rejected."
  }

  // State Records
  record DraftBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft bid data"
    described by "State data for draft bid."
  }

  record SubmittedBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Submitted proposal." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Submitted bid data"
    described by "State data for submitted bid."
  }

  record UnderReviewBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Proposal." }
    reviewer is String(1, 100) with { briefly "Reviewer" described by "Assigned reviewer." }
    updatedScore is optional BidScore with { briefly "Score" described by "Evaluation score." }
    reviewBeganAt is TimeStamp with { briefly "Began" described by "Review start." }
  } with {
    briefly "Under review bid data"
    described by "State data for bid under review."
  }

  record ShortlistedBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Proposal." }
    score is BidScore with { briefly "Score" described by "Evaluation score." }
    shortlistedAt is TimeStamp with { briefly "Shortlisted" described by "Shortlist time." }
  } with {
    briefly "Shortlisted bid data"
    described by "State data for shortlisted bid."
  }

  record AwardedBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    proposal is BidProposal with { briefly "Proposal" described by "Winning proposal." }
    awardedAt is TimeStamp with { briefly "Awarded" described by "Award time." }
  } with {
    briefly "Awarded bid data"
    described by "State data for awarded bid."
  }

  record RejectedBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Rejected bid data"
    described by "State data for rejected bid."
  }

  record WithdrawnBidData is {
    bidId is BidId with { briefly "Bid" described by "Bid ID." }
    rfpId is UUID with { briefly "RFP" described by "RFP ID." }
    contractorId is ContractorId with { briefly "Contractor" described by "Contractor ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Withdrawn bid data"
    described by "State data for withdrawn bid."
  }

  // States
  state DraftState of Bid.DraftBidData with {
    briefly "Bid is draft"
    described by "Bid is being prepared."
  }

  state SubmittedState of Bid.SubmittedBidData with {
    briefly "Bid is submitted"
    described by "Bid has been submitted."
  }

  state UnderReviewState of Bid.UnderReviewBidData with {
    briefly "Bid is under review"
    described by "Bid is being evaluated."
  }

  state ShortlistedState of Bid.ShortlistedBidData with {
    briefly "Bid is shortlisted"
    described by "Bid is on shortlist."
  }

  state AwardedState of Bid.AwardedBidData with {
    briefly "Bid is awarded"
    described by "Bid has been awarded."
  }

  state RejectedState of Bid.RejectedBidData with {
    briefly "Bid is rejected"
    described by "Bid has been rejected."
  }

  state WithdrawnState of Bid.WithdrawnBidData with {
    briefly "Bid is withdrawn"
    described by "Bid has been withdrawn."
  }

  // Handler
  handler BidHandler is {
    on command CreateBid {
      morph entity BidContext.Bid to state BidContext.Bid.DraftState with command CreateBid
      tell event BidCreated to entity BidContext.Bid
    }

    on command SubmitProposal {
      morph entity BidContext.Bid to state BidContext.Bid.SubmittedState with command SubmitProposal
      tell event ProposalSubmitted to entity BidContext.Bid
    }

    on command ReviseProposal {
      tell event ProposalRevised to entity BidContext.Bid
    }

    on command WithdrawBid {
      morph entity BidContext.Bid to state BidContext.Bid.WithdrawnState with command WithdrawBid
      tell event BidWithdrawn to entity BidContext.Bid
    }

    on command BeginReview {
      morph entity BidContext.Bid to state BidContext.Bid.UnderReviewState with command BeginReview
      tell event ReviewBegan to entity BidContext.Bid
    }

    on command ScoreBid {
      tell event BidScored to entity BidContext.Bid
    }

    on command ShortlistBid {
      morph entity BidContext.Bid to state BidContext.Bid.ShortlistedState with command ShortlistBid
      tell event BidShortlisted to entity BidContext.Bid
    }

    on command AwardBid {
      morph entity BidContext.Bid to state BidContext.Bid.AwardedState with command AwardBid
      tell event BidAwarded to entity BidContext.Bid
    }

    on command RejectBid {
      morph entity BidContext.Bid to state BidContext.Bid.RejectedState with command RejectBid
      tell event BidRejected to entity BidContext.Bid
    }
  } with {
    briefly "Processes bid commands"
    described by {
      | Handles bid lifecycle including creation,
      | submission, evaluation, and award.
    }
  }

} with {
  briefly "Bid aggregate"
  described by {
    | The Bid entity manages construction bids
    | from creation through evaluation and award.
  }
}
