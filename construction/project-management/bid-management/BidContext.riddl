// Bid Management - Bid Context

context BidContext is {

  include "types.riddl"
  include "Bid.riddl"

  // Adaptor for contractor service integration
  adaptor ContractorAdapter from context ContractorService is {
    handler ContractorEvents is {
      on event ContractorService.ContractorRegistered {
        prompt "Store contractor information for bidding"
      }
    } with {
      briefly "Handles contractor events"
      described by "Processes contractor registrations."
    }
  } with {
    briefly "Contractor service integration"
    described by "Receives contractor data."
  }

  // Adaptor for project service integration
  adaptor ProjectAdapter from context ProjectService is {
    handler ProjectEvents is {
      on event ProjectService.RFPPublished {
        prompt "Create bid opportunities for contractors"
      }
    } with {
      briefly "Handles project events"
      described by "Processes RFP publications."
    }
  } with {
    briefly "Project service integration"
    described by "Receives project and RFP data."
  }

  // Repository for bid persistence
  repository BidRepository is {
    schema BidData is relational
      of bids as Bid
      index on field Bid.bidId
      index on field Bid.rfpId
      index on field Bid.contractorId

    handler BidPersistence is {
      on command Bid.CreateBid {
        prompt "Store new bid record"
      }
      on command Bid.SubmitProposal {
        prompt "Update bid with proposal"
      }
      on command Bid.ScoreBid {
        prompt "Store evaluation scores"
      }
      on command Bid.AwardBid {
        prompt "Update bid as awarded"
      }
      on command Bid.RejectBid {
        prompt "Update bid as rejected"
      }
    } with {
      briefly "Persists bid commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Bid data persistence"
    described by {
      | The BidRepository provides persistent storage for
      | bids, proposals, and evaluation scores.
    }
  }

  // Projector for bid analytics
  projector BidAnalytics is {
    updates repository BidRepository

    record RFPSummary is {
      rfpId is UUID with { briefly "RFP" described by "RFP ID." }
      bidCount is Natural with { briefly "Bids" described by "Number of bids." }
      averagePrice is Money with { briefly "Avg price" described by "Average bid price." }
      lowestPrice is Money with { briefly "Low price" described by "Lowest bid price." }
      highestPrice is Money with { briefly "High price" described by "Highest bid price." }
    } with {
      briefly "RFP summary"
      described by "Bid summary for an RFP."
    }

    handler AnalyticsHandler is {
      on event Bid.ProposalSubmitted {
        prompt "Update RFP bid statistics"
      }
      on event Bid.BidWithdrawn {
        prompt "Update RFP bid count"
      }
      on event Bid.BidAwarded {
        prompt "Mark RFP as awarded"
      }
    } with {
      briefly "Maintains bid analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Bid analytics projections"
    described by "Maintains bid analytics data."
  }

} with {
  briefly "Bounded context for bid management"
  described by {
    | The BidContext is the bounded context for construction
    | bid management including proposals and evaluations.
  }
}
