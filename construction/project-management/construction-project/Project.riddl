// Construction Project - Project Entity

entity Project is {

  // Commands
  command CreateProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "New project identifier."
    }
    info is ProjectInfo with {
      briefly "Info"
      described by "Project information."
    }
    budget is ProjectBudget with {
      briefly "Budget"
      described by "Project budget."
    }
    schedule is ProjectSchedule with {
      briefly "Schedule"
      described by "Project schedule."
    }
  } with {
    briefly "Create project"
    described by "Creates a new construction project."
  }

  command ApproveProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to approve."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved."
    }
  } with {
    briefly "Approve project"
    described by "Approves project to proceed."
  }

  command StartProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to start."
    }
    actualStart is Date with {
      briefly "Start date"
      described by "Actual start date."
    }
  } with {
    briefly "Start project"
    described by "Marks project as started."
  }

  command AddTask is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    task is ProjectTask with {
      briefly "Task"
      described by "Task to add."
    }
  } with {
    briefly "Add task"
    described by "Adds a task to the project."
  }

  command UpdateTaskProgress is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    taskId is TaskId with {
      briefly "Task ID"
      described by "Task to update."
    }
    percentComplete is Natural with {
      briefly "Complete"
      described by "New completion percentage."
    }
  } with {
    briefly "Update task progress"
    described by "Updates task completion."
  }

  command CompleteMilestone is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    milestoneId is UUID with {
      briefly "Milestone ID"
      described by "Milestone to complete."
    }
    completedDate is Date with {
      briefly "Completed"
      described by "Completion date."
    }
  } with {
    briefly "Complete milestone"
    described by "Marks milestone as complete."
  }

  command SubmitChangeOrder is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    changeOrder is ChangeOrder with {
      briefly "Change order"
      described by "Change order details."
    }
  } with {
    briefly "Submit change order"
    described by "Submits a change order."
  }

  command ApproveChangeOrder is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    changeOrderId is UUID with {
      briefly "CO ID"
      described by "Change order to approve."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved."
    }
  } with {
    briefly "Approve change order"
    described by "Approves a change order."
  }

  command UpdateBudget is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project ID."
    }
    budget is ProjectBudget with {
      briefly "Budget"
      described by "Updated budget."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Update reason."
    }
  } with {
    briefly "Update budget"
    described by "Updates project budget."
  }

  command PutOnHold is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to hold."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Put on hold"
    described by "Puts project on hold."
  }

  command ResumeProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to resume."
    }
  } with {
    briefly "Resume project"
    described by "Resumes held project."
  }

  command CompleteProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to complete."
    }
    actualEnd is Date with {
      briefly "End date"
      described by "Actual end date."
    }
    completedBy is String(1, 100) with {
      briefly "Completed by"
      described by "Who completed."
    }
  } with {
    briefly "Complete project"
    described by "Marks project as complete."
  }

  command CancelProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Who cancelled."
    }
  } with {
    briefly "Cancel project"
    described by "Cancels the project."
  }

  // Events
  event ProjectCreated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Project was created"
    described by "Emitted when project is created."
  }

  event ProjectApproved is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Project was approved"
    described by "Emitted when project is approved."
  }

  event ProjectStarted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    actualStart is Date with { briefly "Start" described by "Start date." }
    startedAt is TimeStamp with { briefly "Started" described by "Started time." }
  } with {
    briefly "Project was started"
    described by "Emitted when project starts."
  }

  event TaskAdded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    task is ProjectTask with { briefly "Task" described by "Added task." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Task was added"
    described by "Emitted when task is added."
  }

  event TaskProgressUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    taskId is TaskId with { briefly "Task" described by "Task ID." }
    percentComplete is Natural with { briefly "Complete" described by "Completion %." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Task progress was updated"
    described by "Emitted when task progress changes."
  }

  event MilestoneCompleted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    milestoneId is UUID with { briefly "Milestone" described by "Milestone ID." }
    completedDate is Date with { briefly "Completed" described by "Completion date." }
  } with {
    briefly "Milestone was completed"
    described by "Emitted when milestone completes."
  }

  event ChangeOrderSubmitted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    changeOrder is ChangeOrder with { briefly "CO" described by "Change order." }
  } with {
    briefly "Change order was submitted"
    described by "Emitted when change order is submitted."
  }

  event ChangeOrderApproved is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    changeOrderId is UUID with { briefly "CO ID" described by "Change order ID." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Change order was approved"
    described by "Emitted when change order is approved."
  }

  event BudgetUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    budget is ProjectBudget with { briefly "Budget" described by "Updated budget." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Budget was updated"
    described by "Emitted when budget changes."
  }

  event ProjectPutOnHold is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Project was put on hold"
    described by "Emitted when project is held."
  }

  event ProjectResumed is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Project was resumed"
    described by "Emitted when project resumes."
  }

  event ProjectCompleted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    actualEnd is Date with { briefly "End" described by "End date." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Project was completed"
    described by "Emitted when project completes."
  }

  event ProjectCancelled is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Project was cancelled"
    described by "Emitted when project is cancelled."
  }

  // State Records
  record PlanningProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    budget is ProjectBudget with { briefly "Budget" described by "Budget." }
    schedule is ProjectSchedule with { briefly "Schedule" described by "Schedule." }
    tasks is many ProjectTask with { briefly "Tasks" described by "Project tasks." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Planning project data"
    described by "State data for project in planning."
  }

  record ApprovedProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    budget is ProjectBudget with { briefly "Budget" described by "Budget." }
    schedule is ProjectSchedule with { briefly "Schedule" described by "Schedule." }
    tasks is many ProjectTask with { briefly "Tasks" described by "Project tasks." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Approved project data"
    described by "State data for approved project."
  }

  record InProgressProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    budget is ProjectBudget with { briefly "Budget" described by "Budget." }
    schedule is ProjectSchedule with { briefly "Schedule" described by "Schedule." }
    tasks is many ProjectTask with { briefly "Tasks" described by "Project tasks." }
    changeOrders is many ChangeOrder with { briefly "COs" described by "Change orders." }
    currentPhase is ProjectPhase with { briefly "Phase" described by "Current phase." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "In progress project data"
    described by "State data for active project."
  }

  record OnHoldProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "On hold project data"
    described by "State data for held project."
  }

  record CompletedProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    finalBudget is ProjectBudget with { briefly "Budget" described by "Final budget." }
    actualEnd is Date with { briefly "End" described by "End date." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed project data"
    described by "State data for completed project."
  }

  record CancelledProjectData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Cancelled project data"
    described by "State data for cancelled project."
  }

  // States
  state PlanningState of Project.PlanningProjectData with {
    briefly "Project in planning"
    described by "Project is being planned."
  }

  state ApprovedState of Project.ApprovedProjectData with {
    briefly "Project is approved"
    described by "Project is approved to proceed."
  }

  state InProgressState of Project.InProgressProjectData with {
    briefly "Project in progress"
    described by "Project is under construction."
  }

  state OnHoldState of Project.OnHoldProjectData with {
    briefly "Project on hold"
    described by "Project is temporarily held."
  }

  state CompletedState of Project.CompletedProjectData with {
    briefly "Project is completed"
    described by "Project is finished."
  }

  state CancelledState of Project.CancelledProjectData with {
    briefly "Project is cancelled"
    described by "Project has been cancelled."
  }

  // Handler
  handler ProjectHandler is {
    on command CreateProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.PlanningState with command CreateProject
      tell event ProjectCreated to entity ProjectContext.Project
    }

    on command ApproveProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.ApprovedState with command ApproveProject
      tell event ProjectApproved to entity ProjectContext.Project
    }

    on command StartProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.InProgressState with command StartProject
      tell event ProjectStarted to entity ProjectContext.Project
    }

    on command AddTask {
      tell event TaskAdded to entity ProjectContext.Project
    }

    on command UpdateTaskProgress {
      tell event TaskProgressUpdated to entity ProjectContext.Project
    }

    on command CompleteMilestone {
      tell event MilestoneCompleted to entity ProjectContext.Project
    }

    on command SubmitChangeOrder {
      tell event ChangeOrderSubmitted to entity ProjectContext.Project
    }

    on command ApproveChangeOrder {
      tell event ChangeOrderApproved to entity ProjectContext.Project
    }

    on command UpdateBudget {
      tell event BudgetUpdated to entity ProjectContext.Project
    }

    on command PutOnHold {
      morph entity ProjectContext.Project to state ProjectContext.Project.OnHoldState with command PutOnHold
      tell event ProjectPutOnHold to entity ProjectContext.Project
    }

    on command ResumeProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.InProgressState with command ResumeProject
      tell event ProjectResumed to entity ProjectContext.Project
    }

    on command CompleteProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.CompletedState with command CompleteProject
      tell event ProjectCompleted to entity ProjectContext.Project
    }

    on command CancelProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.CancelledState with command CancelProject
      tell event ProjectCancelled to entity ProjectContext.Project
    }
  } with {
    briefly "Processes project commands"
    described by {
      | Handles project lifecycle including planning,
      | execution, changes, and completion.
    }
  }

} with {
  briefly "Construction project aggregate"
  described by {
    | The Project entity manages construction project
    | lifecycle from planning through completion.
  }
}
