// Construction Project - Project Entity
entity Project is {
  // Commands
  command CreateProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |New project identifier.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project information.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Project budget.
      }
    }
    schedule: ProjectSchedule with {
      briefly "Schedule"
      described as {
        |Project schedule.
      }
    }
  } with {
    briefly "Create project"
    described as {
      |Creates a new construction project.
    }
  }
  command ApproveProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to approve.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Who approved.
      }
    }
  } with {
    briefly "Approve project"
    described as {
      |Approves project to proceed.
    }
  }
  command StartProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to start.
      }
    }
    actualStart: Date with {
      briefly "Start date"
      described as {
        |Actual start date.
      }
    }
  } with {
    briefly "Start project"
    described as {
      |Marks project as started.
    }
  }
  command AddTask is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    task: ProjectTask with {
      briefly "Task"
      described as {
        |Task to add.
      }
    }
  } with {
    briefly "Add task"
    described as {
      |Adds a task to the project.
    }
  }
  command UpdateTaskProgress is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    taskId: TaskId with {
      briefly "Task ID"
      described as {
        |Task to update.
      }
    }
    percentComplete: Natural with {
      briefly "Complete"
      described as {
        |New completion percentage.
      }
    }
  } with {
    briefly "Update task progress"
    described as {
      |Updates task completion.
    }
  }
  command CompleteMilestone is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    milestoneId: UUID with {
      briefly "Milestone ID"
      described as {
        |Milestone to complete.
      }
    }
    completedDate: Date with {
      briefly "Completed"
      described as {
        |Completion date.
      }
    }
  } with {
    briefly "Complete milestone"
    described as {
      |Marks milestone as complete.
    }
  }
  command SubmitChangeOrder is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    changeOrder: ChangeOrder with {
      briefly "Change order"
      described as {
        |Change order details.
      }
    }
  } with {
    briefly "Submit change order"
    described as {
      |Submits a change order.
    }
  }
  command ApproveChangeOrder is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    changeOrderId: UUID with {
      briefly "CO ID"
      described as {
        |Change order to approve.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Who approved.
      }
    }
  } with {
    briefly "Approve change order"
    described as {
      |Approves a change order.
    }
  }
  command UpdateBudget is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project ID.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Updated budget.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Update reason.
      }
    }
  } with {
    briefly "Update budget"
    described as {
      |Updates project budget.
    }
  }
  command PutOnHold is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to hold.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
  } with {
    briefly "Put on hold"
    described as {
      |Puts project on hold.
    }
  }
  command ResumeProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to resume.
      }
    }
  } with {
    briefly "Resume project"
    described as {
      |Resumes held project.
    }
  }
  command CompleteProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to complete.
      }
    }
    actualEnd: Date with {
      briefly "End date"
      described as {
        |Actual end date.
      }
    }
    completedBy: String(1,100) with {
      briefly "Completed by"
      described as {
        |Who completed.
      }
    }
  } with {
    briefly "Complete project"
    described as {
      |Marks project as complete.
    }
  }
  command CancelProject is  {
    projectId: ProjectId with {
      briefly "Project ID"
      described as {
        |Project to cancel.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Who cancelled.
      }
    }
  } with {
    briefly "Cancel project"
    described as {
      |Cancels the project.
    }
  }
  // Events
  event ProjectCreated is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Project was created"
    described as {
      |Emitted when project is created.
    }
  }
  event ProjectApproved is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Project was approved"
    described as {
      |Emitted when project is approved.
    }
  }
  event ProjectStarted is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    actualStart: Date with {
      briefly "Start"
      described as {
        |Start date.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Started time.
      }
    }
  } with {
    briefly "Project was started"
    described as {
      |Emitted when project starts.
    }
  }
  event TaskAdded is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    task: ProjectTask with {
      briefly "Task"
      described as {
        |Added task.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Task was added"
    described as {
      |Emitted when task is added.
    }
  }
  event TaskProgressUpdated is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    taskId: TaskId with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    percentComplete: Natural with {
      briefly "Complete"
      described as {
        |Completion %.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Task progress was updated"
    described as {
      |Emitted when task progress changes.
    }
  }
  event MilestoneCompleted is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    milestoneId: UUID with {
      briefly "Milestone"
      described as {
        |Milestone ID.
      }
    }
    completedDate: Date with {
      briefly "Completed"
      described as {
        |Completion date.
      }
    }
  } with {
    briefly "Milestone was completed"
    described as {
      |Emitted when milestone completes.
    }
  }
  event ChangeOrderSubmitted is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    changeOrder: ChangeOrder with {
      briefly "CO"
      described as {
        |Change order.
      }
    }
  } with {
    briefly "Change order was submitted"
    described as {
      |Emitted when change order is submitted.
    }
  }
  event ChangeOrderApproved is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    changeOrderId: UUID with {
      briefly "CO ID"
      described as {
        |Change order ID.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Change order was approved"
    described as {
      |Emitted when change order is approved.
    }
  }
  event BudgetUpdated is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Updated budget.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Budget was updated"
    described as {
      |Emitted when budget changes.
    }
  }
  event ProjectPutOnHold is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "Project was put on hold"
    described as {
      |Emitted when project is held.
    }
  }
  event ProjectResumed is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Project was resumed"
    described as {
      |Emitted when project resumes.
    }
  }
  event ProjectCompleted is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    actualEnd: Date with {
      briefly "End"
      described as {
        |End date.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Project was completed"
    described as {
      |Emitted when project completes.
    }
  }
  event ProjectCancelled is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Project was cancelled"
    described as {
      |Emitted when project is cancelled.
    }
  }
  // State Records
  record PlanningProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Budget.
      }
    }
    schedule: ProjectSchedule with {
      briefly "Schedule"
      described as {
        |Schedule.
      }
    }
    tasks: ProjectTask+ with {
      briefly "Tasks"
      described as {
        |Project tasks.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Planning project data"
    described as {
      |State data for project in planning.
    }
  }
  record ApprovedProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Budget.
      }
    }
    schedule: ProjectSchedule with {
      briefly "Schedule"
      described as {
        |Schedule.
      }
    }
    tasks: ProjectTask+ with {
      briefly "Tasks"
      described as {
        |Project tasks.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Approved project data"
    described as {
      |State data for approved project.
    }
  }
  record InProgressProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    budget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Budget.
      }
    }
    schedule: ProjectSchedule with {
      briefly "Schedule"
      described as {
        |Schedule.
      }
    }
    tasks: ProjectTask+ with {
      briefly "Tasks"
      described as {
        |Project tasks.
      }
    }
    changeOrders: ChangeOrder+ with {
      briefly "COs"
      described as {
        |Change orders.
      }
    }
    currentPhase: ProjectPhase with {
      briefly "Phase"
      described as {
        |Current phase.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "In progress project data"
    described as {
      |State data for active project.
    }
  }
  record OnHoldProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "On hold project data"
    described as {
      |State data for held project.
    }
  }
  record CompletedProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    finalBudget: ProjectBudget with {
      briefly "Budget"
      described as {
        |Final budget.
      }
    }
    actualEnd: Date with {
      briefly "End"
      described as {
        |End date.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed project data"
    described as {
      |State data for completed project.
    }
  }
  record CancelledProjectData is  {
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    info: ProjectInfo with {
      briefly "Info"
      described as {
        |Project info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Cancelled project data"
    described as {
      |State data for cancelled project.
    }
  }
  // States
  state PlanningState of type Project.PlanningProjectData
  state ApprovedState of type Project.ApprovedProjectData
  state InProgressState of type Project.InProgressProjectData
  state OnHoldState of type Project.OnHoldProjectData
  state CompletedState of type Project.CompletedProjectData
  state CancelledState of type Project.CancelledProjectData
  // Handler
  handler ProjectHandler is {
    on command CreateProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.PlanningState with command CreateProject
      tell event ProjectCreated to entity ProjectContext.Project
    }
    on command ApproveProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.ApprovedState with command ApproveProject
      tell event ProjectApproved to entity ProjectContext.Project
    }
    on command StartProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.InProgressState with command StartProject
      tell event ProjectStarted to entity ProjectContext.Project
    }
    on command AddTask is {
      tell event TaskAdded to entity ProjectContext.Project
    }
    on command UpdateTaskProgress is {
      tell event TaskProgressUpdated to entity ProjectContext.Project
    }
    on command CompleteMilestone is {
      tell event MilestoneCompleted to entity ProjectContext.Project
    }
    on command SubmitChangeOrder is {
      tell event ChangeOrderSubmitted to entity ProjectContext.Project
    }
    on command ApproveChangeOrder is {
      tell event ChangeOrderApproved to entity ProjectContext.Project
    }
    on command UpdateBudget is {
      tell event BudgetUpdated to entity ProjectContext.Project
    }
    on command PutOnHold is {
      morph entity ProjectContext.Project to state ProjectContext.Project.OnHoldState with command PutOnHold
      tell event ProjectPutOnHold to entity ProjectContext.Project
    }
    on command ResumeProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.InProgressState with command ResumeProject
      tell event ProjectResumed to entity ProjectContext.Project
    }
    on command CompleteProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.CompletedState with command CompleteProject
      tell event ProjectCompleted to entity ProjectContext.Project
    }
    on command CancelProject is {
      morph entity ProjectContext.Project to state ProjectContext.Project.CancelledState with command CancelProject
      tell event ProjectCancelled to entity ProjectContext.Project
    }
  } with {
    briefly "Processes project commands"
    described as {
      | Handles project lifecycle including planning,
      | execution, changes, and completion.
    }
  }
} with {
  briefly "Construction project aggregate"
  described as {
    | The Project entity manages construction project
    | lifecycle from planning through completion.
  }
}
