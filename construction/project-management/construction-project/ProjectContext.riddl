// Construction Project - Project Context

context ProjectContext is {

  include "types.riddl"
  include "Project.riddl"

  // Repository for project persistence
  repository ProjectRepository is {
    schema ProjectData is relational
      of projects as Project
      index on field Project.projectId

    handler ProjectPersistence is {
      on command Project.CreateProject {
        prompt "Store new project record"
      }
      on command Project.StartProject {
        prompt "Update project as in progress"
      }
      on command Project.UpdateTaskProgress {
        prompt "Update task progress"
      }
      on command Project.UpdateBudget {
        prompt "Update budget record"
      }
      on command Project.CompleteProject {
        prompt "Update project as completed"
      }
    } with {
      briefly "Persists project commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Project data persistence"
    described by {
      | The ProjectRepository provides persistent storage for
      | construction projects and their tasks.
    }
  }

  // Projector for project analytics
  projector ProjectAnalytics is {
    updates repository ProjectRepository

    record ProjectSummary is {
      projectId is ProjectId with { briefly "Project" described by "Project ID." }
      percentComplete is Natural with { briefly "Complete" described by "Overall completion %." }
      budgetVariance is Money with { briefly "Budget variance" described by "Budget over/under." }
      scheduleVariance is Integer with { briefly "Schedule variance" described by "Days ahead/behind." }
      openChangeOrders is Natural with { briefly "Open COs" described by "Pending change orders." }
    } with {
      briefly "Project summary"
      described by "Project metrics summary."
    }

    handler AnalyticsHandler is {
      on event Project.TaskProgressUpdated {
        prompt "Recalculate project completion percentage"
      }
      on event Project.BudgetUpdated {
        prompt "Update budget variance"
      }
      on event Project.ChangeOrderApproved {
        prompt "Update change order metrics"
      }
    } with {
      briefly "Maintains project analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Project analytics projections"
    described by "Maintains project analytics data."
  }

} with {
  briefly "Bounded context for construction projects"
  described by {
    | The ProjectContext is the bounded context for construction
    | project management including planning and tracking.
  }
}
