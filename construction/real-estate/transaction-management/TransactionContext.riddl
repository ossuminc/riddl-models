// Transaction Management - Transaction Context

context TransactionContext is {

  include "types.riddl"
  include "Transaction.riddl"

  // Repository for transaction persistence
  repository TransactionRepository is {
    schema TransactionData is relational
      of transactions as Transaction
      index on field Transaction.transactionId
      index on field Transaction.property.propertyId

    handler TransactionPersistence is {
      on command Transaction.InitiateTransaction {
        prompt "Store new transaction record"
      }
      on command Transaction.SubmitOffer {
        prompt "Store offer record"
      }
      on command Transaction.ExecuteContract {
        prompt "Store contract record"
      }
      on command Transaction.CompleteClosing {
        prompt "Update transaction as closed"
      }
      on command Transaction.CancelTransaction {
        prompt "Update transaction as cancelled"
      }
    } with {
      briefly "Persists transaction commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Transaction data persistence"
    described by {
      | The TransactionRepository provides persistent storage for
      | real estate transactions and related documents.
    }
  }

  // Projector for transaction analytics
  projector TransactionAnalytics is {
    updates repository TransactionRepository

    record TransactionSummary is {
      periodStart is Date with { briefly "Start" described by "Period start." }
      periodEnd is Date with { briefly "End" described by "Period end." }
      totalTransactions is Natural with { briefly "Total" described by "Total transactions." }
      totalVolume is Money with { briefly "Volume" described by "Total dollar volume." }
      averagePrice is Money with { briefly "Average" described by "Average sale price." }
      averageDaysToClose is Natural with { briefly "Days" described by "Average days to close." }
    } with {
      briefly "Transaction summary"
      described by "Transaction metrics summary."
    }

    handler AnalyticsHandler is {
      on event Transaction.ClosingCompleted {
        prompt "Update transaction volume and averages"
      }
      on event Transaction.TransactionCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains transaction analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Transaction analytics projections"
    described by "Maintains transaction analytics data."
  }

} with {
  briefly "Bounded context for transaction management"
  described by {
    | The TransactionContext is the bounded context for real estate
    | transactions including offers, contracts, and closings.
  }
}
