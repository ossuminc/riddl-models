// Transaction Management - Transaction Entity

entity Transaction is {

  // Commands
  command InitiateTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "New transaction identifier."
    }
    transactionType is TransactionType with {
      briefly "Type"
      described by "Transaction type."
    }
    property is PropertyDetails with {
      briefly "Property"
      described by "Property details."
    }
    seller is Party with {
      briefly "Seller"
      described by "Selling party."
    }
  } with {
    briefly "Initiate transaction"
    described by "Starts a new transaction."
  }

  command SubmitOffer is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    buyer is Party with {
      briefly "Buyer"
      described by "Buying party."
    }
    offer is Offer with {
      briefly "Offer"
      described by "Purchase offer."
    }
  } with {
    briefly "Submit offer"
    described by "Submits a purchase offer."
  }

  command CounterOffer is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    counteredBy is PartyType with {
      briefly "By"
      described by "Who countered."
    }
    offer is Offer with {
      briefly "Offer"
      described by "Counter offer."
    }
  } with {
    briefly "Counter offer"
    described by "Submits a counter offer."
  }

  command AcceptOffer is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    offerId is UUID with {
      briefly "Offer ID"
      described by "Offer to accept."
    }
    acceptedBy is PartyType with {
      briefly "By"
      described by "Who accepted."
    }
  } with {
    briefly "Accept offer"
    described by "Accepts an offer."
  }

  command ExecuteContract is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    contract is Contract with {
      briefly "Contract"
      described by "Purchase contract."
    }
  } with {
    briefly "Execute contract"
    described by "Executes the purchase contract."
  }

  command SatisfyContingency is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    contingencyType is ContingencyType with {
      briefly "Type"
      described by "Contingency type."
    }
    notes is optional String(1, 500) with {
      briefly "Notes"
      described by "Satisfaction notes."
    }
  } with {
    briefly "Satisfy contingency"
    described by "Marks contingency as satisfied."
  }

  command WaiveContingency is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    contingencyType is ContingencyType with {
      briefly "Type"
      described by "Contingency to waive."
    }
    waivedBy is PartyType with {
      briefly "By"
      described by "Who waived."
    }
  } with {
    briefly "Waive contingency"
    described by "Waives a contingency."
  }

  command EnterEscrow is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    escrowAgent is Party with {
      briefly "Escrow agent"
      described by "Escrow agent."
    }
    escrowAccountNumber is String(1, 50) with {
      briefly "Account"
      described by "Escrow account number."
    }
  } with {
    briefly "Enter escrow"
    described by "Transaction enters escrow."
  }

  command ScheduleClosing is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    closingDate is Date with {
      briefly "Date"
      described by "Closing date."
    }
    closingLocation is String(1, 500) with {
      briefly "Location"
      described by "Closing location."
    }
  } with {
    briefly "Schedule closing"
    described by "Schedules the closing."
  }

  command CompleteClosing is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    finalClosingCosts is ClosingCosts with {
      briefly "Costs"
      described by "Final closing costs."
    }
    documents is many ClosingDocument with {
      briefly "Documents"
      described by "Closing documents."
    }
  } with {
    briefly "Complete closing"
    described by "Completes the transaction closing."
  }

  command CancelTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is PartyType with {
      briefly "By"
      described by "Who cancelled."
    }
  } with {
    briefly "Cancel transaction"
    described by "Cancels the transaction."
  }

  // Events
  event TransactionInitiated is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transactionType is TransactionType with { briefly "Type" described by "Transaction type." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Transaction was initiated"
    described by "Emitted when transaction starts."
  }

  event OfferSubmitted is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    offer is Offer with { briefly "Offer" described by "Submitted offer." }
    buyer is Party with { briefly "Buyer" described by "Buying party." }
  } with {
    briefly "Offer was submitted"
    described by "Emitted when offer is submitted."
  }

  event OfferCountered is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    offer is Offer with { briefly "Offer" described by "Counter offer." }
    counteredBy is PartyType with { briefly "By" described by "Who countered." }
  } with {
    briefly "Offer was countered"
    described by "Emitted when offer is countered."
  }

  event OfferAccepted is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    offerId is UUID with { briefly "Offer" described by "Accepted offer ID." }
    acceptedAt is TimeStamp with { briefly "Accepted" described by "Acceptance time." }
  } with {
    briefly "Offer was accepted"
    described by "Emitted when offer is accepted."
  }

  event ContractExecuted is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    contract is Contract with { briefly "Contract" described by "Executed contract." }
  } with {
    briefly "Contract was executed"
    described by "Emitted when contract is signed."
  }

  event ContingencySatisfied is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    contingencyType is ContingencyType with { briefly "Type" described by "Contingency type." }
    satisfiedAt is TimeStamp with { briefly "Satisfied" described by "Satisfaction time." }
  } with {
    briefly "Contingency was satisfied"
    described by "Emitted when contingency is met."
  }

  event ContingencyWaived is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    contingencyType is ContingencyType with { briefly "Type" described by "Contingency type." }
    waivedAt is TimeStamp with { briefly "Waived" described by "Waiver time." }
  } with {
    briefly "Contingency was waived"
    described by "Emitted when contingency is waived."
  }

  event EscrowEntered is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    escrowAccountNumber is String(1, 50) with { briefly "Account" described by "Escrow account." }
    enteredAt is TimeStamp with { briefly "Entered" described by "Entry time." }
  } with {
    briefly "Escrow was entered"
    described by "Emitted when transaction enters escrow."
  }

  event ClosingScheduled is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    closingDate is Date with { briefly "Date" described by "Closing date." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Closing was scheduled"
    described by "Emitted when closing is scheduled."
  }

  event ClosingCompleted is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    finalClosingCosts is ClosingCosts with { briefly "Costs" described by "Final costs." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Closing was completed"
    described by "Emitted when transaction closes."
  }

  event TransactionCancelled is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Transaction was cancelled"
    described by "Emitted when transaction is cancelled."
  }

  // State Records
  record PendingTransactionData is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transactionType is TransactionType with { briefly "Type" described by "Transaction type." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    seller is Party with { briefly "Seller" described by "Selling party." }
    offers is many Offer with { briefly "Offers" described by "Submitted offers." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Pending transaction data"
    described by "State data for pending transaction."
  }

  record UnderContractData is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transactionType is TransactionType with { briefly "Type" described by "Transaction type." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    seller is Party with { briefly "Seller" described by "Selling party." }
    buyer is Party with { briefly "Buyer" described by "Buying party." }
    contract is Contract with { briefly "Contract" described by "Purchase contract." }
    contingencies is many Contingency with { briefly "Contingencies" described by "Contract contingencies." }
  } with {
    briefly "Under contract data"
    described by "State data for contract execution."
  }

  record InEscrowData is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transactionType is TransactionType with { briefly "Type" described by "Transaction type." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    seller is Party with { briefly "Seller" described by "Selling party." }
    buyer is Party with { briefly "Buyer" described by "Buying party." }
    contract is Contract with { briefly "Contract" described by "Purchase contract." }
    escrowAccountNumber is String(1, 50) with { briefly "Escrow" described by "Escrow account." }
    updatedClosingDate is optional Date with { briefly "Closing" described by "Scheduled closing." }
  } with {
    briefly "In escrow data"
    described by "State data for escrow period."
  }

  record ClosedTransactionData is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transactionType is TransactionType with { briefly "Type" described by "Transaction type." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    seller is Party with { briefly "Seller" described by "Selling party." }
    buyer is Party with { briefly "Buyer" described by "Buying party." }
    finalClosingCosts is ClosingCosts with { briefly "Costs" described by "Final costs." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Closed transaction data"
    described by "State data for closed transaction."
  }

  record CancelledTransactionData is {
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    property is PropertyDetails with { briefly "Property" described by "Property details." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Cancelled transaction data"
    described by "State data for cancelled transaction."
  }

  // States
  state PendingState of Transaction.PendingTransactionData with {
    briefly "Transaction is pending"
    described by "Transaction awaiting accepted offer."
  }

  state UnderContractState of Transaction.UnderContractData with {
    briefly "Transaction under contract"
    described by "Contract has been executed."
  }

  state InEscrowState of Transaction.InEscrowData with {
    briefly "Transaction in escrow"
    described by "Transaction is in escrow."
  }

  state ClosedState of Transaction.ClosedTransactionData with {
    briefly "Transaction is closed"
    described by "Transaction has closed."
  }

  state CancelledState of Transaction.CancelledTransactionData with {
    briefly "Transaction is cancelled"
    described by "Transaction was cancelled."
  }

  // Handler
  handler TransactionHandler is {
    on command InitiateTransaction {
      morph entity TransactionContext.Transaction to state TransactionContext.Transaction.PendingState with command InitiateTransaction
      tell event TransactionInitiated to entity TransactionContext.Transaction
    }

    on command SubmitOffer {
      tell event OfferSubmitted to entity TransactionContext.Transaction
    }

    on command CounterOffer {
      tell event OfferCountered to entity TransactionContext.Transaction
    }

    on command AcceptOffer {
      tell event OfferAccepted to entity TransactionContext.Transaction
    }

    on command ExecuteContract {
      morph entity TransactionContext.Transaction to state TransactionContext.Transaction.UnderContractState with command ExecuteContract
      tell event ContractExecuted to entity TransactionContext.Transaction
    }

    on command SatisfyContingency {
      tell event ContingencySatisfied to entity TransactionContext.Transaction
    }

    on command WaiveContingency {
      tell event ContingencyWaived to entity TransactionContext.Transaction
    }

    on command EnterEscrow {
      morph entity TransactionContext.Transaction to state TransactionContext.Transaction.InEscrowState with command EnterEscrow
      tell event EscrowEntered to entity TransactionContext.Transaction
    }

    on command ScheduleClosing {
      tell event ClosingScheduled to entity TransactionContext.Transaction
    }

    on command CompleteClosing {
      morph entity TransactionContext.Transaction to state TransactionContext.Transaction.ClosedState with command CompleteClosing
      tell event ClosingCompleted to entity TransactionContext.Transaction
    }

    on command CancelTransaction {
      morph entity TransactionContext.Transaction to state TransactionContext.Transaction.CancelledState with command CancelTransaction
      tell event TransactionCancelled to entity TransactionContext.Transaction
    }
  } with {
    briefly "Processes transaction commands"
    described by {
      | Handles transaction lifecycle from initiation
      | through offers, contract, escrow, and closing.
    }
  }

} with {
  briefly "Transaction aggregate"
  described by {
    | The Transaction entity manages real estate transactions
    | from initial listing through closing.
  }
}
