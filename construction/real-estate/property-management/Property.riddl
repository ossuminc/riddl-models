// Property Management - Property Entity

entity Property is {

  // Commands
  command AddProperty is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "New property identifier."
    }
    info is PropertyInfo with {
      briefly "Info"
      described by "Property information."
    }
    units is many Unit with {
      briefly "Units"
      described by "Property units."
    }
  } with {
    briefly "Add property"
    described by "Adds a new property to portfolio."
  }

  command AddUnit is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    unit is Unit with {
      briefly "Unit"
      described by "Unit to add."
    }
  } with {
    briefly "Add unit"
    described by "Adds a unit to property."
  }

  command UpdateUnit is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    unit is Unit with {
      briefly "Unit"
      described by "Updated unit."
    }
  } with {
    briefly "Update unit"
    described by "Updates unit details."
  }

  command ApproveLease is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    lease is Lease with {
      briefly "Lease"
      described by "Lease to approve."
    }
    tenant is TenantInfo with {
      briefly "Tenant"
      described by "Tenant information."
    }
  } with {
    briefly "Approve lease"
    described by "Approves a lease application."
  }

  command RenewLease is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    leaseId is LeaseId with {
      briefly "Lease ID"
      described by "Lease to renew."
    }
    newEndDate is Date with {
      briefly "End date"
      described by "New lease end date."
    }
    newRent is Money with {
      briefly "New rent"
      described by "New monthly rent."
    }
  } with {
    briefly "Renew lease"
    described by "Renews an existing lease."
  }

  command TerminateLease is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    leaseId is LeaseId with {
      briefly "Lease ID"
      described by "Lease to terminate."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Termination reason."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Termination date."
    }
  } with {
    briefly "Terminate lease"
    described by "Terminates a lease early."
  }

  command RecordPayment is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    payment is RentPayment with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Record payment"
    described by "Records a rent payment."
  }

  command SubmitMaintenanceRequest is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    request is MaintenanceRequest with {
      briefly "Request"
      described by "Maintenance request."
    }
  } with {
    briefly "Submit maintenance request"
    described by "Submits a maintenance request."
  }

  command CompleteMaintenanceRequest is {
    propertyId is PropertyId with {
      briefly "Property ID"
      described by "Property ID."
    }
    requestId is UUID with {
      briefly "Request ID"
      described by "Request to complete."
    }
    completionNotes is String(1, 1000) with {
      briefly "Notes"
      described by "Completion notes."
    }
    cost is Money with {
      briefly "Cost"
      described by "Maintenance cost."
    }
  } with {
    briefly "Complete maintenance"
    described by "Marks maintenance as complete."
  }

  // Events
  event PropertyAdded is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    info is PropertyInfo with { briefly "Info" described by "Property info." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Property was added"
    described by "Emitted when property is added."
  }

  event UnitAdded is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    unit is Unit with { briefly "Unit" described by "Added unit." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Unit was added"
    described by "Emitted when unit is added."
  }

  event UnitUpdated is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    unit is Unit with { briefly "Unit" described by "Updated unit." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Unit was updated"
    described by "Emitted when unit is updated."
  }

  event LeaseApproved is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    lease is Lease with { briefly "Lease" described by "Approved lease." }
    tenant is TenantInfo with { briefly "Tenant" described by "Tenant info." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Lease was approved"
    described by "Emitted when lease is approved."
  }

  event LeaseRenewed is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    leaseId is LeaseId with { briefly "Lease" described by "Lease ID." }
    newEndDate is Date with { briefly "End" described by "New end date." }
    renewedAt is TimeStamp with { briefly "Renewed" described by "Renewal time." }
  } with {
    briefly "Lease was renewed"
    described by "Emitted when lease is renewed."
  }

  event LeaseTerminated is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    leaseId is LeaseId with { briefly "Lease" described by "Lease ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Lease was terminated"
    described by "Emitted when lease ends early."
  }

  event PaymentRecorded is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    payment is RentPayment with { briefly "Payment" described by "Payment details." }
  } with {
    briefly "Payment was recorded"
    described by "Emitted when payment is recorded."
  }

  event MaintenanceRequestSubmitted is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    request is MaintenanceRequest with { briefly "Request" described by "Maintenance request." }
  } with {
    briefly "Maintenance request was submitted"
    described by "Emitted when request is submitted."
  }

  event MaintenanceRequestCompleted is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    requestId is UUID with { briefly "Request" described by "Request ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Maintenance was completed"
    described by "Emitted when request is done."
  }

  // State Records
  record ActivePropertyData is {
    propertyId is PropertyId with { briefly "Property" described by "Property ID." }
    info is PropertyInfo with { briefly "Info" described by "Property info." }
    units is many Unit with { briefly "Units" described by "Property units." }
    leases is many Lease with { briefly "Leases" described by "Active leases." }
    tenants is many TenantInfo with { briefly "Tenants" described by "Current tenants." }
    maintenanceRequests is many MaintenanceRequest with { briefly "Requests" described by "Maintenance requests." }
    payments is many RentPayment with { briefly "Payments" described by "Rent payments." }
  } with {
    briefly "Active property data"
    described by "State data for active property."
  }

  // States
  state ActiveState of Property.ActivePropertyData with {
    briefly "Property is active"
    described by "Property is actively managed."
  }

  // Handler
  handler PropertyHandler is {
    on command AddProperty {
      morph entity PropertyContext.Property to state PropertyContext.Property.ActiveState with command AddProperty
      tell event PropertyAdded to entity PropertyContext.Property
    }

    on command AddUnit {
      tell event UnitAdded to entity PropertyContext.Property
    }

    on command UpdateUnit {
      tell event UnitUpdated to entity PropertyContext.Property
    }

    on command ApproveLease {
      tell event LeaseApproved to entity PropertyContext.Property
    }

    on command RenewLease {
      tell event LeaseRenewed to entity PropertyContext.Property
    }

    on command TerminateLease {
      tell event LeaseTerminated to entity PropertyContext.Property
    }

    on command RecordPayment {
      tell event PaymentRecorded to entity PropertyContext.Property
    }

    on command SubmitMaintenanceRequest {
      tell event MaintenanceRequestSubmitted to entity PropertyContext.Property
    }

    on command CompleteMaintenanceRequest {
      tell event MaintenanceRequestCompleted to entity PropertyContext.Property
    }
  } with {
    briefly "Processes property commands"
    described by {
      | Handles property operations including units,
      | leases, payments, and maintenance.
    }
  }

} with {
  briefly "Property aggregate"
  described by {
    | The Property entity manages real estate properties
    | including units, leases, and maintenance.
  }
}
