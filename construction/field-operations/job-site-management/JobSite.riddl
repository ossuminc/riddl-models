// Job Site Management - JobSite Entity
entity JobSite is {
  // Commands
  command EstablishSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |New site identifier.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Associated project.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    location: Location with {
      briefly "Location"
      described as {
        |Site location.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Planned start date.
      }
    }
  } with {
    briefly "Establish site"
    described as {
      |Creates a new job site.
    }
  }
  command ActivateSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site to activate.
      }
    }
    activatedBy: String(1,100) with {
      briefly "Activated by"
      described as {
        |Who activated.
      }
    }
  } with {
    briefly "Activate site"
    described as {
      |Activates site for construction.
    }
  }
  command AssignCrew is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    crew: Crew with {
      briefly "Crew"
      described as {
        |Crew to assign.
      }
    }
    assignedDate: Date with {
      briefly "Date"
      described as {
        |Assignment date.
      }
    }
  } with {
    briefly "Assign crew"
    described as {
      |Assigns a crew to the site.
    }
  }
  command RemoveCrew is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    crewId: CrewId with {
      briefly "Crew"
      described as {
        |Crew to remove.
      }
    }
  } with {
    briefly "Remove crew"
    described as {
      |Removes a crew from the site.
    }
  }
  command SubmitDailyReport is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    report: DailyReport with {
      briefly "Report"
      described as {
        |Daily report data.
      }
    }
  } with {
    briefly "Submit daily report"
    described as {
      |Submits daily progress report.
    }
  }
  command RecordSafetyInspection is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    inspection: SafetyInspection with {
      briefly "Inspection"
      described as {
        |Inspection data.
      }
    }
  } with {
    briefly "Record safety inspection"
    described as {
      |Records a safety inspection.
    }
  }
  command ReportIssue is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    issue: SiteIssue with {
      briefly "Issue"
      described as {
        |Issue to report.
      }
    }
  } with {
    briefly "Report issue"
    described as {
      |Reports a site issue.
    }
  }
  command ResolveIssue is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site ID.
      }
    }
    issueId: UUID with {
      briefly "Issue ID"
      described as {
        |Issue to resolve.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |How resolved.
      }
    }
    resolvedBy: String(1,100) with {
      briefly "Resolved by"
      described as {
        |Who resolved.
      }
    }
  } with {
    briefly "Resolve issue"
    described as {
      |Resolves a reported issue.
    }
  }
  command SuspendSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site to suspend.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedBy: String(1,100) with {
      briefly "Suspended by"
      described as {
        |Who suspended.
      }
    }
  } with {
    briefly "Suspend site"
    described as {
      |Suspends site operations.
    }
  }
  command ResumeSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site to resume.
      }
    }
    resumedBy: String(1,100) with {
      briefly "Resumed by"
      described as {
        |Who resumed.
      }
    }
  } with {
    briefly "Resume site"
    described as {
      |Resumes site operations.
    }
  }
  command CompleteSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site to complete.
      }
    }
    completedBy: String(1,100) with {
      briefly "Completed by"
      described as {
        |Who marked complete.
      }
    }
  } with {
    briefly "Complete site"
    described as {
      |Marks site as construction complete.
    }
  }
  command CloseSite is  {
    jobSiteId: JobSiteId with {
      briefly "Site ID"
      described as {
        |Site to close.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Who closed.
      }
    }
  } with {
    briefly "Close site"
    described as {
      |Closes site permanently.
    }
  }
  // Events
  event SiteEstablished is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    establishedAt: TimeStamp with {
      briefly "Established"
      described as {
        |Establishment time.
      }
    }
  } with {
    briefly "Site was established"
    described as {
      |Emitted when job site is created.
    }
  }
  event SiteActivated is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Site was activated"
    described as {
      |Emitted when site becomes active.
    }
  }
  event CrewAssigned is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    crew: Crew with {
      briefly "Crew"
      described as {
        |Assigned crew.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Crew was assigned"
    described as {
      |Emitted when crew is assigned.
    }
  }
  event CrewRemoved is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    crewId: CrewId with {
      briefly "Crew"
      described as {
        |Removed crew.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Crew was removed"
    described as {
      |Emitted when crew is removed.
    }
  }
  event DailyReportSubmitted is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    report: DailyReport with {
      briefly "Report"
      described as {
        |Submitted report.
      }
    }
  } with {
    briefly "Daily report was submitted"
    described as {
      |Emitted when report is submitted.
    }
  }
  event SafetyInspectionRecorded is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    inspection: SafetyInspection with {
      briefly "Inspection"
      described as {
        |Inspection data.
      }
    }
  } with {
    briefly "Safety inspection was recorded"
    described as {
      |Emitted when inspection is recorded.
    }
  }
  event IssueReported is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    issue: SiteIssue with {
      briefly "Issue"
      described as {
        |Reported issue.
      }
    }
  } with {
    briefly "Issue was reported"
    described as {
      |Emitted when issue is reported.
    }
  }
  event IssueResolved is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    issueId: UUID with {
      briefly "Issue"
      described as {
        |Issue ID.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Issue was resolved"
    described as {
      |Emitted when issue is resolved.
    }
  }
  event SiteSuspended is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Site was suspended"
    described as {
      |Emitted when site is suspended.
    }
  }
  event SiteResumed is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Site was resumed"
    described as {
      |Emitted when site resumes.
    }
  }
  event SiteCompleted is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Site was completed"
    described as {
      |Emitted when construction completes.
    }
  }
  event SiteClosed is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Site was closed"
    described as {
      |Emitted when site is closed.
    }
  }
  // State Records
  record PreConstructionSiteData is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    location: Location with {
      briefly "Location"
      described as {
        |Site location.
      }
    }
    plannedStart: Date with {
      briefly "Start"
      described as {
        |Planned start.
      }
    }
    establishedAt: TimeStamp with {
      briefly "Established"
      described as {
        |Established time.
      }
    }
  } with {
    briefly "Pre-construction site data"
    described as {
      |State data for site before construction.
    }
  }
  record ActiveSiteData is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    location: Location with {
      briefly "Location"
      described as {
        |Site location.
      }
    }
    crews: Crew+ with {
      briefly "Crews"
      described as {
        |Assigned crews.
      }
    }
    dailyReports: DailyReport+ with {
      briefly "Reports"
      described as {
        |Daily reports.
      }
    }
    inspections: SafetyInspection+ with {
      briefly "Inspections"
      described as {
        |Safety inspections.
      }
    }
    openIssues: SiteIssue+ with {
      briefly "Issues"
      described as {
        |Open issues.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Active site data"
    described as {
      |State data for active construction site.
    }
  }
  record SuspendedSiteData is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Suspended site data"
    described as {
      |State data for suspended site.
    }
  }
  record CompletedSiteData is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    totalReports: Natural with {
      briefly "Reports"
      described as {
        |Total daily reports.
      }
    }
    totalInspections: Natural with {
      briefly "Inspections"
      described as {
        |Total inspections.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed site data"
    described as {
      |State data for completed site.
    }
  }
  record ClosedSiteData is  {
    jobSiteId: JobSiteId with {
      briefly "Site"
      described as {
        |Site ID.
      }
    }
    projectId: ProjectId with {
      briefly "Project"
      described as {
        |Project ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Site name.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Closed site data"
    described as {
      |State data for closed site.
    }
  }
  // States
  state PreConstructionState of type JobSite.PreConstructionSiteData
  state ActiveState of type JobSite.ActiveSiteData
  state SuspendedState of type JobSite.SuspendedSiteData
  state CompletedState of type JobSite.CompletedSiteData
  state ClosedState of type JobSite.ClosedSiteData
  // Handler
  handler JobSiteHandler is {
    on command EstablishSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.PreConstructionState with command EstablishSite
      tell event SiteEstablished to entity JobSiteContext.JobSite
    }
    on command ActivateSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.ActiveState with command ActivateSite
      tell event SiteActivated to entity JobSiteContext.JobSite
    }
    on command AssignCrew is {
      tell event CrewAssigned to entity JobSiteContext.JobSite
    }
    on command RemoveCrew is {
      tell event CrewRemoved to entity JobSiteContext.JobSite
    }
    on command SubmitDailyReport is {
      tell event DailyReportSubmitted to entity JobSiteContext.JobSite
    }
    on command RecordSafetyInspection is {
      tell event SafetyInspectionRecorded to entity JobSiteContext.JobSite
    }
    on command ReportIssue is {
      tell event IssueReported to entity JobSiteContext.JobSite
    }
    on command ResolveIssue is {
      tell event IssueResolved to entity JobSiteContext.JobSite
    }
    on command SuspendSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.SuspendedState with command SuspendSite
      tell event SiteSuspended to entity JobSiteContext.JobSite
    }
    on command ResumeSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.ActiveState with command ResumeSite
      tell event SiteResumed to entity JobSiteContext.JobSite
    }
    on command CompleteSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.CompletedState with command CompleteSite
      tell event SiteCompleted to entity JobSiteContext.JobSite
    }
    on command CloseSite is {
      morph entity JobSiteContext.JobSite to state JobSiteContext.JobSite.ClosedState with command CloseSite
      tell event SiteClosed to entity JobSiteContext.JobSite
    }
  } with {
    briefly "Processes job site commands"
    described as {
      | Handles job site lifecycle including establishment,
      | daily operations, safety, and closure.
    }
  }
} with {
  briefly "Job site aggregate"
  described as {
    | The JobSite entity manages construction job site
    | lifecycle, daily reporting, and safety compliance.
  }
}
