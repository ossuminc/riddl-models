// Equipment Tracking - Equipment Entity

entity Equipment is {

  // Commands
  command RegisterEquipment is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "New equipment identifier."
    }
    equipmentType is EquipmentType with {
      briefly "Type"
      described by "Equipment category."
    }
    name is String(1, 200) with {
      briefly "Name"
      described by "Equipment name."
    }
    make is String(1, 100) with {
      briefly "Make"
      described by "Manufacturer."
    }
    model is String(1, 100) with {
      briefly "Model"
      described by "Model name."
    }
    serialNumber is String(1, 50) with {
      briefly "Serial"
      described by "Serial number."
    }
    purchaseDate is Date with {
      briefly "Purchased"
      described by "Purchase date."
    }
    purchaseCost is Money with {
      briefly "Cost"
      described by "Purchase cost."
    }
  } with {
    briefly "Register equipment"
    described by "Adds new equipment to the fleet."
  }

  command AssignToSite is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment to assign."
    }
    assignment is Assignment with {
      briefly "Assignment"
      described by "Assignment details."
    }
  } with {
    briefly "Assign to site"
    described by "Assigns equipment to a job site."
  }

  command ReturnFromSite is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment returning."
    }
    returnedAt is TimeStamp with {
      briefly "Returned"
      described by "Return timestamp."
    }
    condition is String(1, 500) with {
      briefly "Condition"
      described by "Condition on return."
    }
  } with {
    briefly "Return from site"
    described by "Returns equipment from job site."
  }

  command UpdateLocation is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment to update."
    }
    location is Location with {
      briefly "Location"
      described by "New location."
    }
  } with {
    briefly "Update location"
    described by "Updates equipment GPS location."
  }

  command RecordMeterReading is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
    reading is MeterReading with {
      briefly "Reading"
      described by "Meter reading."
    }
  } with {
    briefly "Record meter reading"
    described by "Records operating hours/mileage."
  }

  command ScheduleMaintenance is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
    maintenanceType is MaintenanceType with {
      briefly "Type"
      described by "Maintenance type."
    }
    scheduledDate is Date with {
      briefly "Scheduled"
      described by "Scheduled date."
    }
    description is String(1, 1000) with {
      briefly "Description"
      described by "Work to perform."
    }
  } with {
    briefly "Schedule maintenance"
    described by "Schedules maintenance work."
  }

  command CompleteMaintenance is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
    record is MaintenanceRecord with {
      briefly "Record"
      described by "Maintenance record."
    }
  } with {
    briefly "Complete maintenance"
    described by "Records completed maintenance."
  }

  command MarkOutOfService is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Out of service reason."
    }
  } with {
    briefly "Mark out of service"
    described by "Marks equipment as non-operational."
  }

  command ReturnToService is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
  } with {
    briefly "Return to service"
    described by "Returns equipment to operational status."
  }

  command DisposeEquipment is {
    equipmentId is EquipmentId with {
      briefly "Equipment ID"
      described by "Equipment ID."
    }
    disposalType is String(1, 50) with {
      briefly "Type"
      described by "Sold, scrapped, etc."
    }
    disposalValue is optional Money with {
      briefly "Value"
      described by "Sale proceeds."
    }
    disposedBy is String(1, 100) with {
      briefly "Disposed by"
      described by "Who disposed."
    }
  } with {
    briefly "Dispose equipment"
    described by "Removes equipment from fleet."
  }

  // Events
  event EquipmentRegistered is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    equipmentType is EquipmentType with { briefly "Type" described by "Equipment type." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Equipment was registered"
    described by "Emitted when equipment is added to fleet."
  }

  event EquipmentAssigned is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    assignment is Assignment with { briefly "Assignment" described by "Assignment details." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Equipment was assigned"
    described by "Emitted when equipment is assigned to site."
  }

  event EquipmentReturned is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    fromSiteId is JobSiteId with { briefly "From site" described by "Site returned from." }
    returnedAt is TimeStamp with { briefly "Returned" described by "Return time." }
  } with {
    briefly "Equipment was returned"
    described by "Emitted when equipment returns from site."
  }

  event LocationUpdated is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    location is Location with { briefly "Location" described by "New location." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Location was updated"
    described by "Emitted when GPS location changes."
  }

  event MeterReadingRecorded is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    reading is MeterReading with { briefly "Reading" described by "Meter reading." }
  } with {
    briefly "Meter reading was recorded"
    described by "Emitted when usage metrics recorded."
  }

  event MaintenanceScheduled is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    maintenanceType is MaintenanceType with { briefly "Type" described by "Maintenance type." }
    scheduledDate is Date with { briefly "Scheduled" described by "Scheduled date." }
  } with {
    briefly "Maintenance was scheduled"
    described by "Emitted when maintenance is scheduled."
  }

  event MaintenanceCompleted is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    record is MaintenanceRecord with { briefly "Record" described by "Maintenance record." }
  } with {
    briefly "Maintenance was completed"
    described by "Emitted when maintenance is done."
  }

  event MarkedOutOfService is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Reason." }
    markedAt is TimeStamp with { briefly "Marked" described by "When marked." }
  } with {
    briefly "Equipment marked out of service"
    described by "Emitted when equipment becomes non-operational."
  }

  event ReturnedToService is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    returnedAt is TimeStamp with { briefly "Returned" described by "When returned." }
  } with {
    briefly "Equipment returned to service"
    described by "Emitted when equipment becomes operational."
  }

  event EquipmentDisposed is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    disposalType is String(1, 50) with { briefly "Type" described by "Disposal type." }
    disposedAt is TimeStamp with { briefly "Disposed" described by "Disposal time." }
  } with {
    briefly "Equipment was disposed"
    described by "Emitted when equipment is removed from fleet."
  }

  // State Records
  record AvailableEquipmentData is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    equipmentType is EquipmentType with { briefly "Type" described by "Equipment type." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    make is String(1, 100) with { briefly "Make" described by "Manufacturer." }
    model is String(1, 100) with { briefly "Model" described by "Model." }
    serialNumber is String(1, 50) with { briefly "Serial" described by "Serial number." }
    location is Location with { briefly "Location" described by "Current location." }
    lastReading is optional MeterReading with { briefly "Reading" described by "Last meter reading." }
    maintenanceHistory is many MaintenanceRecord with { briefly "History" described by "Maintenance records." }
  } with {
    briefly "Available equipment data"
    described by "State data for available equipment."
  }

  record AssignedEquipmentData is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    equipmentType is EquipmentType with { briefly "Type" described by "Equipment type." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    make is String(1, 100) with { briefly "Make" described by "Manufacturer." }
    model is String(1, 100) with { briefly "Model" described by "Model." }
    serialNumber is String(1, 50) with { briefly "Serial" described by "Serial number." }
    currentAssignment is Assignment with { briefly "Assignment" described by "Current assignment." }
    location is Location with { briefly "Location" described by "Current location." }
    lastReading is optional MeterReading with { briefly "Reading" described by "Last meter reading." }
    maintenanceHistory is many MaintenanceRecord with { briefly "History" described by "Maintenance records." }
  } with {
    briefly "Assigned equipment data"
    described by "State data for assigned equipment."
  }

  record MaintenanceEquipmentData is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    equipmentType is EquipmentType with { briefly "Type" described by "Equipment type." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    scheduledWork is String(1, 1000) with { briefly "Work" described by "Scheduled work." }
    scheduledDate is Date with { briefly "Scheduled" described by "Scheduled date." }
    maintenanceHistory is many MaintenanceRecord with { briefly "History" described by "Maintenance records." }
  } with {
    briefly "Maintenance equipment data"
    described by "State data for equipment in maintenance."
  }

  record OutOfServiceEquipmentData is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    equipmentType is EquipmentType with { briefly "Type" described by "Equipment type." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    reason is String(1, 500) with { briefly "Reason" described by "Out of service reason." }
    outOfServiceSince is TimeStamp with { briefly "Since" described by "When went out of service." }
  } with {
    briefly "Out of service equipment data"
    described by "State data for non-operational equipment."
  }

  record DisposedEquipmentData is {
    equipmentId is EquipmentId with { briefly "Equipment" described by "Equipment ID." }
    name is String(1, 200) with { briefly "Name" described by "Equipment name." }
    disposalType is String(1, 50) with { briefly "Type" described by "Disposal type." }
    disposedAt is TimeStamp with { briefly "Disposed" described by "Disposal time." }
  } with {
    briefly "Disposed equipment data"
    described by "State data for disposed equipment."
  }

  // States
  state AvailableState of Equipment.AvailableEquipmentData with {
    briefly "Equipment is available"
    described by "Equipment is ready for assignment."
  }

  state AssignedState of Equipment.AssignedEquipmentData with {
    briefly "Equipment is assigned"
    described by "Equipment is at a job site."
  }

  state MaintenanceState of Equipment.MaintenanceEquipmentData with {
    briefly "Equipment in maintenance"
    described by "Equipment is under maintenance."
  }

  state OutOfServiceState of Equipment.OutOfServiceEquipmentData with {
    briefly "Equipment out of service"
    described by "Equipment is non-operational."
  }

  state DisposedState of Equipment.DisposedEquipmentData with {
    briefly "Equipment is disposed"
    described by "Equipment removed from fleet."
  }

  // Handler
  handler EquipmentHandler is {
    on command RegisterEquipment {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.AvailableState with command RegisterEquipment
      tell event EquipmentRegistered to entity EquipmentContext.Equipment
    }

    on command AssignToSite {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.AssignedState with command AssignToSite
      tell event EquipmentAssigned to entity EquipmentContext.Equipment
    }

    on command ReturnFromSite {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.AvailableState with command ReturnFromSite
      tell event EquipmentReturned to entity EquipmentContext.Equipment
    }

    on command UpdateLocation {
      tell event LocationUpdated to entity EquipmentContext.Equipment
    }

    on command RecordMeterReading {
      tell event MeterReadingRecorded to entity EquipmentContext.Equipment
    }

    on command ScheduleMaintenance {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.MaintenanceState with command ScheduleMaintenance
      tell event MaintenanceScheduled to entity EquipmentContext.Equipment
    }

    on command CompleteMaintenance {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.AvailableState with command CompleteMaintenance
      tell event MaintenanceCompleted to entity EquipmentContext.Equipment
    }

    on command MarkOutOfService {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.OutOfServiceState with command MarkOutOfService
      tell event MarkedOutOfService to entity EquipmentContext.Equipment
    }

    on command ReturnToService {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.AvailableState with command ReturnToService
      tell event ReturnedToService to entity EquipmentContext.Equipment
    }

    on command DisposeEquipment {
      morph entity EquipmentContext.Equipment to state EquipmentContext.Equipment.DisposedState with command DisposeEquipment
      tell event EquipmentDisposed to entity EquipmentContext.Equipment
    }
  } with {
    briefly "Processes equipment commands"
    described by {
      | Handles equipment lifecycle including registration,
      | assignment, maintenance, and disposal.
    }
  }

} with {
  briefly "Equipment aggregate"
  described by {
    | The Equipment entity manages construction equipment
    | lifecycle, location tracking, and maintenance history.
  }
}
