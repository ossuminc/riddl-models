// Billing Settlement - BillingAccount Entity
entity BillingAccount is {
  command CreateAccount is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |New billing account identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer identifier.
      }
    }
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Associated meter identifier.
      }
    }
    rateSchedule: RateSchedule with {
      briefly "Rate"
      described as {
        |Applicable rate schedule.
      }
    }
    serviceAddress: String(3,300) with {
      briefly "Address"
      described as {
        |Service address.
      }
    }
  } with {
    briefly "Create account"
    described as {
      |Creates a new billing account.
    }
  }
  command SubmitMeterReading is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    reading: MeterReading with {
      briefly "Reading"
      described as {
        |Meter reading data.
      }
    }
  } with {
    briefly "Submit meter reading"
    described as {
      |Submits a meter reading for validation.
    }
  }
  command CalculateUsage is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    periodStart: Date with {
      briefly "Start"
      described as {
        |Billing period start.
      }
    }
    periodEnd: Date with {
      briefly "End"
      described as {
        |Billing period end.
      }
    }
  } with {
    briefly "Calculate usage"
    described as {
      |Calculates usage for a billing period.
    }
  }
  command GenerateBill is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    usage: UsageCalculation with {
      briefly "Usage"
      described as {
        |Calculated usage data.
      }
    }
    rateSchedule: RateSchedule with {
      briefly "Rate"
      described as {
        |Rate schedule to apply.
      }
    }
  } with {
    briefly "Generate bill"
    described as {
      |Generates a bill from usage and rates.
    }
  }
  command RecordPayment is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    payment: PaymentRecord with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
  } with {
    briefly "Record payment"
    described as {
      |Records a payment against an invoice.
    }
  }
  command InitiateSettlement is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    settlement: SupplierSettlement with {
      briefly "Settlement"
      described as {
        |Supplier settlement details.
      }
    }
  } with {
    briefly "Initiate settlement"
    described as {
      |Initiates settlement with energy supplier.
    }
  }
  command DisputeBill is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Disputed invoice identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Dispute reason.
      }
    }
  } with {
    briefly "Dispute bill"
    described as {
      |Records a billing dispute.
    }
  }
  command CloseAccount is  {
    accountId: BillingAccountId with {
      briefly "Account ID"
      described as {
        |Billing account identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    finalReadingDate: Date with {
      briefly "Final reading"
      described as {
        |Date of final meter reading.
      }
    }
  } with {
    briefly "Close account"
    described as {
      |Closes a billing account.
    }
  }
  // Events
  event AccountCreated is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Account created"
    described as {
      |Emitted when billing account is created.
    }
  }
  event MeterReadingSubmitted is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reading: MeterReading with {
      briefly "Reading"
      described as {
        |Meter reading.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Meter reading submitted"
    described as {
      |Emitted when meter reading is submitted.
    }
  }
  event UsageCalculated is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    usage: UsageCalculation with {
      briefly "Usage"
      described as {
        |Usage data.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Usage calculated"
    described as {
      |Emitted when usage is calculated.
    }
  }
  event BillGenerated is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    invoice: InvoiceSummary with {
      briefly "Invoice"
      described as {
        |Invoice summary.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Bill generated"
    described as {
      |Emitted when a bill is generated.
    }
  }
  event PaymentRecorded is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    payment: PaymentRecord with {
      briefly "Payment"
      described as {
        |Payment record.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Payment recorded"
    described as {
      |Emitted when payment is recorded.
    }
  }
  event SettlementInitiated is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    settlement: SupplierSettlement with {
      briefly "Settlement"
      described as {
        |Settlement data.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Settlement initiated"
    described as {
      |Emitted when supplier settlement is initiated.
    }
  }
  event BillDisputed is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Dispute reason.
      }
    }
    disputedAt: TimeStamp with {
      briefly "Disputed"
      described as {
        |Dispute time.
      }
    }
  } with {
    briefly "Bill disputed"
    described as {
      |Emitted when a bill is disputed.
    }
  }
  event AccountClosed is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Account closed"
    described as {
      |Emitted when billing account is closed.
    }
  }
  // States
  record ActiveStateData is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    rateSchedule: RateSchedule with {
      briefly "Rate"
      described as {
        |Rate schedule.
      }
    }
    serviceAddress: String(3,300) with {
      briefly "Address"
      described as {
        |Service address.
      }
    }
    status: AccountStatus with {
      briefly "Status"
      described as {
        |Account status.
      }
    }
    meterReadings: MeterReading* with {
      briefly "Readings"
      described as {
        |Meter readings.
      }
    }
    invoices: InvoiceSummary* with {
      briefly "Invoices"
      described as {
        |Generated invoices.
      }
    }
    payments: PaymentRecord* with {
      briefly "Payments"
      described as {
        |Payment records.
      }
    }
    settlements: SupplierSettlement* with {
      briefly "Settlements"
      described as {
        |Supplier settlements.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active account state"
    described as {
      |State for an active billing account.
    }
  }
  record ClosedStateData is  {
    accountId: BillingAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
    finalBalance: Decimal(10,2) with {
      briefly "Balance"
      described as {
        |Final balance.
      }
    }
  } with {
    briefly "Closed account state"
    described as {
      |State for a closed billing account.
    }
  }
  state ActiveState of type BillingAccount.ActiveStateData
  state ClosedState of type BillingAccount.ClosedStateData
  handler BillingAccountHandler is {
    on command CreateAccount is {
      morph entity BillingSettlementContext.BillingAccount to state BillingSettlementContext.BillingAccount.ActiveState with command CreateAccount
      tell event AccountCreated to entity BillingSettlementContext.BillingAccount
    }
    on command SubmitMeterReading is {
      tell event MeterReadingSubmitted to entity BillingSettlementContext.BillingAccount
    }
    on command CalculateUsage is {
      tell event UsageCalculated to entity BillingSettlementContext.BillingAccount
    }
    on command GenerateBill is {
      tell event BillGenerated to entity BillingSettlementContext.BillingAccount
    }
    on command RecordPayment is {
      tell event PaymentRecorded to entity BillingSettlementContext.BillingAccount
    }
    on command InitiateSettlement is {
      tell event SettlementInitiated to entity BillingSettlementContext.BillingAccount
    }
    on command DisputeBill is {
      tell event BillDisputed to entity BillingSettlementContext.BillingAccount
    }
    on command CloseAccount is {
      morph entity BillingSettlementContext.BillingAccount to state BillingSettlementContext.BillingAccount.ClosedState with command CloseAccount
      tell event AccountClosed to entity BillingSettlementContext.BillingAccount
    }
  } with {
    briefly "Processes billing account commands"
    described as {
      |Handles billing account lifecycle.
    }
  }
} with {
  briefly "BillingAccount aggregate"
  described as {
    |Manages utility billing accounts.
  }
}
