// Billing Settlement - BillingAccount Entity

entity BillingAccount is {

  command CreateAccount is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "New billing account identifier."
    }
    customerId is CustomerId with {
      briefly "Customer"
      described by "Customer identifier."
    }
    meterId is MeterId with {
      briefly "Meter"
      described by "Associated meter identifier."
    }
    rateSchedule is RateSchedule with {
      briefly "Rate"
      described by "Applicable rate schedule."
    }
    serviceAddress is String(3, 300) with {
      briefly "Address"
      described by "Service address."
    }
  } with {
    briefly "Create account"
    described by "Creates a new billing account."
  }

  command SubmitMeterReading is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    reading is MeterReading with {
      briefly "Reading"
      described by "Meter reading data."
    }
  } with {
    briefly "Submit meter reading"
    described by "Submits a meter reading for validation."
  }

  command CalculateUsage is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    periodStart is Date with {
      briefly "Start"
      described by "Billing period start."
    }
    periodEnd is Date with {
      briefly "End"
      described by "Billing period end."
    }
  } with {
    briefly "Calculate usage"
    described by "Calculates usage for a billing period."
  }

  command GenerateBill is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    usage is UsageCalculation with {
      briefly "Usage"
      described by "Calculated usage data."
    }
    rateSchedule is RateSchedule with {
      briefly "Rate"
      described by "Rate schedule to apply."
    }
  } with {
    briefly "Generate bill"
    described by "Generates a bill from usage and rates."
  }

  command RecordPayment is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    payment is PaymentRecord with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Record payment"
    described by "Records a payment against an invoice."
  }

  command InitiateSettlement is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    settlement is SupplierSettlement with {
      briefly "Settlement"
      described by "Supplier settlement details."
    }
  } with {
    briefly "Initiate settlement"
    described by "Initiates settlement with energy supplier."
  }

  command DisputeBill is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    invoiceId is InvoiceId with {
      briefly "Invoice"
      described by "Disputed invoice identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Dispute reason."
    }
  } with {
    briefly "Dispute bill"
    described by "Records a billing dispute."
  }

  command CloseAccount is {
    accountId is BillingAccountId with {
      briefly "Account ID"
      described by "Billing account identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Closure reason."
    }
    finalReadingDate is Date with {
      briefly "Final reading"
      described by "Date of final meter reading."
    }
  } with {
    briefly "Close account"
    described by "Closes a billing account."
  }

  // Events
  event AccountCreated is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Account created"
    described by "Emitted when billing account is created."
  }

  event MeterReadingSubmitted is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    reading is MeterReading with { briefly "Reading" described by "Meter reading." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Meter reading submitted"
    described by "Emitted when meter reading is submitted."
  }

  event UsageCalculated is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    usage is UsageCalculation with { briefly "Usage" described by "Usage data." }
    calculatedAt is TimeStamp with { briefly "Calculated" described by "Calculation time." }
  } with {
    briefly "Usage calculated"
    described by "Emitted when usage is calculated."
  }

  event BillGenerated is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    invoice is InvoiceSummary with { briefly "Invoice" described by "Invoice summary." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Bill generated"
    described by "Emitted when a bill is generated."
  }

  event PaymentRecorded is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    payment is PaymentRecord with { briefly "Payment" described by "Payment record." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Payment recorded"
    described by "Emitted when payment is recorded."
  }

  event SettlementInitiated is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    settlement is SupplierSettlement with { briefly "Settlement" described by "Settlement data." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Settlement initiated"
    described by "Emitted when supplier settlement is initiated."
  }

  event BillDisputed is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    invoiceId is InvoiceId with { briefly "Invoice" described by "Invoice ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Dispute reason." }
    disputedAt is TimeStamp with { briefly "Disputed" described by "Dispute time." }
  } with {
    briefly "Bill disputed"
    described by "Emitted when a bill is disputed."
  }

  event AccountClosed is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Account closed"
    described by "Emitted when billing account is closed."
  }

  // States
  record ActiveStateData is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    rateSchedule is RateSchedule with { briefly "Rate" described by "Rate schedule." }
    serviceAddress is String(3, 300) with { briefly "Address" described by "Service address." }
    status is AccountStatus with { briefly "Status" described by "Account status." }
    readings is many optional MeterReading with { briefly "Readings" described by "Meter readings." }
    invoices is many optional InvoiceSummary with { briefly "Invoices" described by "Generated invoices." }
    payments is many optional PaymentRecord with { briefly "Payments" described by "Payment records." }
    settlements is many optional SupplierSettlement with { briefly "Settlements" described by "Supplier settlements." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active account state"
    described by "State for an active billing account."
  }

  record ClosedStateData is {
    accountId is BillingAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
    finalBalance is Decimal(10, 2) with { briefly "Balance" described by "Final balance." }
  } with {
    briefly "Closed account state"
    described by "State for a closed billing account."
  }

  state ActiveState of BillingAccount.ActiveStateData with {
    briefly "Account active"
    described by "Billing account is active and processing."
  }

  state ClosedState of BillingAccount.ClosedStateData with {
    briefly "Account closed"
    described by "Billing account has been closed."
  }

  handler BillingAccountHandler is {
    on command CreateAccount {
      morph entity BillingSettlementContext.BillingAccount to state BillingSettlementContext.BillingAccount.ActiveState with command CreateAccount
      tell event AccountCreated to entity BillingSettlementContext.BillingAccount
    }
    on command SubmitMeterReading {
      tell event MeterReadingSubmitted to entity BillingSettlementContext.BillingAccount
    }
    on command CalculateUsage {
      tell event UsageCalculated to entity BillingSettlementContext.BillingAccount
    }
    on command GenerateBill {
      tell event BillGenerated to entity BillingSettlementContext.BillingAccount
    }
    on command RecordPayment {
      tell event PaymentRecorded to entity BillingSettlementContext.BillingAccount
    }
    on command InitiateSettlement {
      tell event SettlementInitiated to entity BillingSettlementContext.BillingAccount
    }
    on command DisputeBill {
      tell event BillDisputed to entity BillingSettlementContext.BillingAccount
    }
    on command CloseAccount {
      morph entity BillingSettlementContext.BillingAccount to state BillingSettlementContext.BillingAccount.ClosedState with command CloseAccount
      tell event AccountClosed to entity BillingSettlementContext.BillingAccount
    }
  } with {
    briefly "Processes billing account commands"
    described by "Handles billing account lifecycle."
  }

} with {
  briefly "BillingAccount aggregate"
  described by "Manages utility billing accounts."
}
