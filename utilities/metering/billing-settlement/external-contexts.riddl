// Billing Settlement - External Contexts
context MeterDataSystem is {
  query GetMeterReadings is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    fromDate: Date with {
      briefly "From"
      described as {
        |Start date.
      }
    }
    toDate: Date with {
      briefly "To"
      described as {
        |End date.
      }
    }
  } with {
    briefly "Get meter readings"
    described as {
      |Retrieves meter readings for a period.
    }
  }
  result MeterReadings is  {
    readings: MeterReading+ with {
      briefly "Readings"
      described as {
        |Meter readings.
      }
    }
    hasGaps: Boolean with {
      briefly "Gaps"
      described as {
        |Whether data has gaps.
      }
    }
  } with {
    briefly "Meter readings result"
    described as {
      |Returned meter reading data.
    }
  }
  command ValidateMeterData is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    reading: MeterReading with {
      briefly "Reading"
      described as {
        |Reading to validate.
      }
    }
  } with {
    briefly "Validate meter data"
    described as {
      |Validates meter reading data.
    }
  }
  event MeterDataValidated is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    valid: Boolean with {
      briefly "Valid"
      described as {
        |Validation result.
      }
    }
    validatedAt: TimeStamp with {
      briefly "Validated"
      described as {
        |Validation time.
      }
    }
  } with {
    briefly "Meter data validated"
    described as {
      |Emitted when meter data is validated.
    }
  }
} with {
  option external()
  briefly "External meter data system"
  described as {
    |Meter data collection and validation system.
  }
}
context PaymentProcessor is {
  command ProcessPayment is  {
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice identifier.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    method: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
  } with {
    briefly "Process payment"
    described as {
      |Processes a customer payment.
    }
  }
  event PaymentProcessed is  {
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice identifier.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Payment success.
      }
    }
    transactionId: String(3,100) with {
      briefly "Transaction"
      described as {
        |Transaction reference.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Processing time.
      }
    }
  } with {
    briefly "Payment processed"
    described as {
      |Emitted when payment is processed.
    }
  }
  command IssueRefund is  {
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice identifier.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Refund amount.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Refund reason.
      }
    }
  } with {
    briefly "Issue refund"
    described as {
      |Issues a refund for overpayment or dispute.
    }
  }
  event RefundIssued is  {
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice identifier.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Refund amount.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Refund time.
      }
    }
  } with {
    briefly "Refund issued"
    described as {
      |Emitted when refund is issued.
    }
  }
} with {
  option external()
  briefly "External payment processor"
  described as {
    |Payment processing and refund system.
  }
}
context EnergySupplierGateway is {
  command SubmitSettlement is  {
    supplierId: SupplierId with {
      briefly "Supplier"
      described as {
        |Supplier identifier.
      }
    }
    settlement: SupplierSettlement with {
      briefly "Settlement"
      described as {
        |Settlement data.
      }
    }
  } with {
    briefly "Submit settlement"
    described as {
      |Submits settlement to energy supplier.
    }
  }
  event SettlementConfirmed is  {
    supplierId: SupplierId with {
      briefly "Supplier"
      described as {
        |Supplier identifier.
      }
    }
    settlementId: UUID with {
      briefly "Settlement"
      described as {
        |Settlement identifier.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Settlement confirmed"
    described as {
      |Emitted when supplier confirms settlement.
    }
  }
  query GetSupplierRates is  {
    supplierId: SupplierId with {
      briefly "Supplier"
      described as {
        |Supplier identifier.
      }
    }
    effectiveDate: Date with {
      briefly "Date"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Get supplier rates"
    described as {
      |Retrieves current supplier rates.
    }
  }
  result SupplierRates is  {
    supplierId: SupplierId with {
      briefly "Supplier"
      described as {
        |Supplier identifier.
      }
    }
    wholesaleRate: Decimal(8,4) with {
      briefly "Rate"
      described as {
        |Wholesale rate per kWh.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Rate effective date.
      }
    }
  } with {
    briefly "Supplier rates"
    described as {
      |Current energy supplier rates.
    }
  }
} with {
  option external()
  briefly "External energy supplier gateway"
  described as {
    |Integration gateway for energy suppliers.
  }
}
