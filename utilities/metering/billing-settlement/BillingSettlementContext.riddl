// Billing Settlement - Billing Settlement Context
context BillingSettlementContext is {
  include "types.riddl"
  include "BillingAccount.riddl"
  repository BillingRepository is {
    schema BillingData is relational
      of billingAccounts as type BillingAccount
        index on field BillingAccount.accountId
        index on field BillingAccount.customerId
        index on field BillingAccount.status

    handler BillingPersistence is {
      on command BillingAccount.CreateAccount is {
        prompt "Store new billing account"
      }
      on command BillingAccount.SubmitMeterReading is {
        prompt "Store validated meter reading"
      }
      on command BillingAccount.CalculateUsage is {
        prompt "Store usage calculation"
      }
      on command BillingAccount.GenerateBill is {
        prompt "Store generated invoice"
      }
      on command BillingAccount.RecordPayment is {
        prompt "Store payment record"
      }
      on command BillingAccount.InitiateSettlement is {
        prompt "Store supplier settlement"
      }
    } with {
      briefly "Persists billing commands"
      described as {
        |Handles event-driven billing persistence.
      }
    }
  } with {
    briefly "Billing data persistence"
    described as {
      |Persistent storage for billing accounts.
    }
  }
  projector BillingMetrics is {
    record RevenueMetrics is  {
      totalBillsGenerated: Natural with {
        briefly "Bills"
        described as {
          |Total bills generated.
        }
      }
      totalRevenue: Decimal(14,2) with {
        briefly "Revenue"
        described as {
          |Total revenue billed.
        }
      }
      totalPaymentsReceived: Decimal(14,2) with {
        briefly "Payments"
        described as {
          |Total payments received.
        }
      }
      outstandingBalance: Decimal(14,2) with {
        briefly "Outstanding"
        described as {
          |Outstanding balance.
        }
      }
      settlementsCompleted: Natural with {
        briefly "Settlements"
        described as {
          |Settlements completed.
        }
      }
    } with {
      briefly "Revenue metrics"
      described as {
        |Billing revenue metrics.
      }
    }
    handler MetricsHandler is {
      on event BillingAccount.BillGenerated is {
        prompt "Increment bills generated and add to total revenue"
      }
      on event BillingAccount.PaymentRecorded is {
        prompt "Add to payments received and reduce outstanding balance"
      }
      on event BillingAccount.SettlementInitiated is {
        prompt "Increment settlements completed"
      }
    } with {
      briefly "Maintains billing metrics"
      described as {
        |Projects billing events into revenue metrics.
      }
    }
  } with {
    briefly "Billing metrics"
    described as {
      |Billing and revenue analytics.
    }
  }
} with {
  briefly "Bounded context for billing settlement"
  described as {
    |Utility billing settlement context.
  }
}
