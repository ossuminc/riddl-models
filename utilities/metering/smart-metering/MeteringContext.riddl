// Smart Metering - Metering Context

context MeteringContext is {

  include "types.riddl"
  include "Meter.riddl"

  repository MeteringRepository is {
    schema MeteringData is relational
      of meters as Meter
      index on field Meter.meterId
      index on field Meter.accountId
      index on field Meter.status
      index on field Meter.meterInfo.serialNumber

    handler MeteringPersistence is {
      on command Meter.InstallMeter {
        prompt "Store new meter record"
      }
      on command Meter.RecordReading {
        prompt "Store meter reading"
      }
      on command Meter.RecordIntervalData {
        prompt "Store interval data"
      }
      on command Meter.RaiseAlert {
        prompt "Store meter alert"
      }
      on command Meter.DecommissionMeter {
        prompt "Update meter to decommissioned"
      }
    } with {
      briefly "Persists metering commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Metering data persistence"
    described by "Persistent storage for meters."
  }

  projector MeteringAnalytics is {
    updates repository MeteringRepository

    record NetworkHealth is {
      totalMeters is Natural with { briefly "Total" described by "Total meters." }
      activeMeters is Natural with { briefly "Active" described by "Active meters." }
      communicatingMeters is Natural with { briefly "Communicating" described by "Meters online." }
      alertCount is Natural with { briefly "Alerts" described by "Active alerts." }
      avgSignalStrength is Decimal(5, 2) with { briefly "Signal" described by "Avg signal strength." }
    } with {
      briefly "Network health"
      described by "AMI network health metrics."
    }

    handler AnalyticsHandler is {
      on event Meter.MeterInstalled {
        prompt "Update meter counts"
      }
      on event Meter.CommunicationUpdated {
        prompt "Update communication statistics"
      }
      on event Meter.AlertRaised {
        prompt "Increment alert count"
      }
      on event Meter.AlertResolved {
        prompt "Decrement alert count"
      }
    } with {
      briefly "Maintains metering analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Metering analytics"
    described by "AMI network monitoring."
  }

} with {
  briefly "Bounded context for smart metering"
  described by "Advanced metering infrastructure context."
}
