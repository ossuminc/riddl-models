// Smart Metering - Metering Context
context MeteringContext is {
  include "types.riddl"
  include "Meter.riddl"
  repository MeteringRepository is {
    schema MeteringData is relational
      of meters as type Meter
        index on field Meter.meterId
        index on field Meter.accountId
        index on field Meter.status
        index on field Meter.meterInfo.serialNumber

    handler MeteringPersistence is {
      on command Meter.InstallMeter is {
        prompt "Store new meter record"
      }
      on command Meter.RecordReading is {
        prompt "Store meter reading"
      }
      on command Meter.RecordIntervalData is {
        prompt "Store interval data"
      }
      on command Meter.RaiseAlert is {
        prompt "Store meter alert"
      }
      on command Meter.DecommissionMeter is {
        prompt "Update meter to decommissioned"
      }
    } with {
      briefly "Persists metering commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Metering data persistence"
    described as {
      |Persistent storage for meters.
    }
  }
  projector MeteringAnalytics is {
    record NetworkHealth is  {
      totalMeters: Natural with {
        briefly "Total"
        described as {
          |Total meters.
        }
      }
      activeMeters: Natural with {
        briefly "Active"
        described as {
          |Active meters.
        }
      }
      communicatingMeters: Natural with {
        briefly "Communicating"
        described as {
          |Meters online.
        }
      }
      alertCount: Natural with {
        briefly "Alerts"
        described as {
          |Active alerts.
        }
      }
      avgSignalStrength: Decimal(5,2) with {
        briefly "Signal"
        described as {
          |Avg signal strength.
        }
      }
    } with {
      briefly "Network health"
      described as {
        |AMI network health metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Meter.MeterInstalled is {
        prompt "Update meter counts"
      }
      on event Meter.CommunicationUpdated is {
        prompt "Update communication statistics"
      }
      on event Meter.AlertRaised is {
        prompt "Increment alert count"
      }
      on event Meter.AlertResolved is {
        prompt "Decrement alert count"
      }
    } with {
      briefly "Maintains metering analytics"
      described as {
        |Projects events into analytics.
      }
    }
  } with {
    briefly "Metering analytics"
    described as {
      |AMI network monitoring.
    }
  }
} with {
  briefly "Bounded context for smart metering"
  described as {
    |Advanced metering infrastructure context.
  }
}
