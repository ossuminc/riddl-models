// Smart Metering - External Contexts
context HeadEndSystem is {
  command PollMeter is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    readingType: ReadingType with {
      briefly "Type"
      described as {
        |Reading type.
      }
    }
  } with {
    briefly "Poll meter"
    described as {
      |Requests reading from meter.
    }
  }
  event MeterResponseReceived is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    reading: MeterReading with {
      briefly "Reading"
      described as {
        |Meter reading.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receive time.
      }
    }
  } with {
    briefly "Meter response received"
    described as {
      |Emitted when meter responds.
    }
  }
  command SendDisconnectCommand is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
  } with {
    briefly "Send disconnect command"
    described as {
      |Commands meter to disconnect.
    }
  }
  command SendReconnectCommand is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
  } with {
    briefly "Send reconnect command"
    described as {
      |Commands meter to reconnect.
    }
  }
  query GetMeterStatus is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
  } with {
    briefly "Get meter status"
    described as {
      |Gets meter operational status.
    }
  }
  result MeterStatusResult is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    online: Boolean with {
      briefly "Online"
      described as {
        |Is online.
      }
    }
    lastContact: TimeStamp with {
      briefly "Contact"
      described as {
        |Last contact.
      }
    }
    signalStrength: Decimal(5,2) with {
      briefly "Signal"
      described as {
        |Signal strength.
      }
    }
  } with {
    briefly "Meter status result"
    described as {
      |Meter status response.
    }
  }
} with {
  option external()
  briefly "External head end system"
  described as {
    |AMI head end controller.
  }
}
context BillingSystem is {
  command SubmitValidatedUsage is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    billingPeriod: String(1,20) with {
      briefly "Period"
      described as {
        |Billing period.
      }
    }
    totalUsage: Decimal(15,3) with {
      briefly "Usage"
      described as {
        |Total usage.
      }
    }
    readingStart: MeterReading with {
      briefly "Start"
      described as {
        |Period start reading.
      }
    }
    readingEnd: MeterReading with {
      briefly "End"
      described as {
        |Period end reading.
      }
    }
  } with {
    briefly "Submit validated usage"
    described as {
      |Submits usage for billing.
    }
  }
  event UsageAccepted is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    billingPeriod: String(1,20) with {
      briefly "Period"
      described as {
        |Billing period.
      }
    }
    acceptedAt: TimeStamp with {
      briefly "Accepted"
      described as {
        |Acceptance time.
      }
    }
  } with {
    briefly "Usage accepted"
    described as {
      |Emitted when usage accepted.
    }
  }
} with {
  option external()
  briefly "External billing system"
  described as {
    |Customer billing system.
  }
}
context MeterDataManagement is {
  command ValidateReading is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    reading: MeterReading with {
      briefly "Reading"
      described as {
        |Reading to validate.
      }
    }
  } with {
    briefly "Validate reading"
    described as {
      |Validates reading against rules.
    }
  }
  result ValidationResult is  {
    readingId: ReadingId with {
      briefly "Reading"
      described as {
        |Reading ID.
      }
    }
    valid: Boolean with {
      briefly "Valid"
      described as {
        |Is valid.
      }
    }
    estimatedValue: Decimal(15,3)? with {
      briefly "Estimated"
      described as {
        |Estimated value.
      }
    }
    flags: String(1,50)+ with {
      briefly "Flags"
      described as {
        |Validation flags.
      }
    }
  } with {
    briefly "Validation result"
    described as {
      |Reading validation result.
    }
  }
  command EstimateMissing is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    missingPeriodStart: TimeStamp with {
      briefly "Start"
      described as {
        |Missing period start.
      }
    }
    missingPeriodEnd: TimeStamp with {
      briefly "End"
      described as {
        |Missing period end.
      }
    }
  } with {
    briefly "Estimate missing"
    described as {
      |Estimates missing readings.
    }
  }
} with {
  option external()
  briefly "External MDM system"
  described as {
    |Meter data management system.
  }
}
context OutageManagement is {
  command ReportMeterOutage is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    outageType: String(1,50) with {
      briefly "Type"
      described as {
        |Outage type.
      }
    }
    detectedAt: TimeStamp with {
      briefly "Detected"
      described as {
        |Detection time.
      }
    }
  } with {
    briefly "Report meter outage"
    described as {
      |Reports power outage at meter.
    }
  }
  event OutageConfirmed is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    outageId: UUID with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Outage confirmed"
    described as {
      |Emitted when outage confirmed.
    }
  }
  command ReportRestoration is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Restoration time.
      }
    }
  } with {
    briefly "Report restoration"
    described as {
      |Reports power restored.
    }
  }
} with {
  option external()
  briefly "External outage management"
  described as {
    |Utility outage management system.
  }
}
