// Outage Management - Outage Context
context OutageContext is {
  include "types.riddl"
  include "OutageEvent.riddl"
  repository OutageRepository is {
    schema OutageData is relational
      of outageEvents as type OutageEvent
        index on field OutageEvent.outageId
        index on field OutageEvent.outageInfo.feederId
        index on field OutageEvent.status

    handler OutagePersistence is {
      on command OutageEvent.ReportOutage is {
        prompt "Store new outage event"
      }
      on command OutageEvent.ConfirmOutage is {
        prompt "Update outage to confirmed"
      }
      on command OutageEvent.DispatchCrew is {
        prompt "Store crew dispatch record"
      }
      on command OutageEvent.RestorePower is {
        prompt "Update outage to restored"
      }
      on command OutageEvent.CloseOutage is {
        prompt "Update outage to closed with analysis"
      }
    } with {
      briefly "Persists outage commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Outage data persistence"
    described as {
      |Persistent storage for outage events.
    }
  }
  projector OutageMetrics is {
    record OutageMetricsData is  {
      outagesReported: Natural with {
        briefly "Reported"
        described as {
          |Outages reported.
        }
      }
      outagesRestored: Natural with {
        briefly "Restored"
        described as {
          |Outages restored.
        }
      }
      outagesCancelled: Natural with {
        briefly "Cancelled"
        described as {
          |Outages cancelled.
        }
      }
      averageRestorationTime: Decimal(8,2) with {
        briefly "Avg time"
        described as {
          |Average restoration time in minutes.
        }
      }
    } with {
      briefly "Outage metrics"
      described as {
        |Outage processing metrics.
      }
    }
    handler MetricsHandler is {
      on event OutageEvent.OutageReported is {
        prompt "Increment outages reported"
      }
      on event OutageEvent.PowerRestored is {
        prompt "Increment outages restored and calculate restoration time"
      }
      on event OutageEvent.OutageCancelled is {
        prompt "Increment outages cancelled"
      }
    } with {
      briefly "Maintains outage metrics"
      described as {
        |Projects events into outage metrics.
      }
    }
  } with {
    briefly "Outage metrics"
    described as {
      |Outage management analytics.
    }
  }
} with {
  briefly "Bounded context for outage management"
  described as {
    |Electric utility outage management context.
  }
}
