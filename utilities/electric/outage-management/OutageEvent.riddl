// Outage Management - OutageEvent Entity

entity OutageEvent is {

  command ReportOutage is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "New outage event identifier."
    }
    outageInfo is OutageInfo with {
      briefly "Outage info"
      described by "Outage event details."
    }
    affectedDevices is many AffectedDevice with {
      briefly "Devices"
      described by "Affected grid devices."
    }
  } with {
    briefly "Report outage"
    described by "Reports a new outage event."
  }

  command ConfirmOutage is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    confirmedBy is String(1, 100) with {
      briefly "Confirmed by"
      described by "Person or system confirming the outage."
    }
    cause is OutageCause with {
      briefly "Cause"
      described by "Initial cause assessment."
    }
  } with {
    briefly "Confirm outage"
    described by "Confirms a detected outage event."
  }

  command DispatchCrew is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    assignment is CrewAssignment with {
      briefly "Assignment"
      described by "Crew assignment details."
    }
  } with {
    briefly "Dispatch crew"
    described by "Dispatches a crew to the outage location."
  }

  command RecordCrewArrival is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    crewId is CrewId with {
      briefly "Crew ID"
      described by "Arriving crew identifier."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
  } with {
    briefly "Record crew arrival"
    described by "Records that a crew has arrived on site."
  }

  command BeginRestoration is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    steps is many RestorationStep with {
      briefly "Steps"
      described by "Planned restoration steps."
    }
  } with {
    briefly "Begin restoration"
    described by "Begins the power restoration process."
  }

  command CompleteRestorationStep is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    stepId is UUID with {
      briefly "Step ID"
      described by "Restoration step identifier."
    }
    success is Boolean with {
      briefly "Success"
      described by "Whether step succeeded."
    }
  } with {
    briefly "Complete restoration step"
    described by "Records completion of a restoration step."
  }

  command RestorePower is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    restoredAt is TimeStamp with {
      briefly "Restored"
      described by "Power restoration time."
    }
  } with {
    briefly "Restore power"
    described by "Marks power as restored for the outage area."
  }

  command NotifyCustomers is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    customerNotifications is many CustomerNotification with {
      briefly "Notifications"
      described by "Customer notifications to send."
    }
  } with {
    briefly "Notify customers"
    described by "Sends notifications to affected customers."
  }

  command CloseOutage is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    analysis is PostOutageAnalysis with {
      briefly "Analysis"
      described by "Post-outage analysis."
    }
  } with {
    briefly "Close outage"
    described by "Closes the outage event with analysis."
  }

  command CancelOutage is {
    outageId is OutageEventId with {
      briefly "Outage ID"
      described by "Outage event identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel outage"
    described by "Cancels a false or duplicate outage report."
  }

  // Events
  event OutageReported is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    outageInfo is OutageInfo with { briefly "Info" described by "Outage info." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Outage reported"
    described by "Emitted when an outage is reported."
  }

  event OutageConfirmed is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    cause is OutageCause with { briefly "Cause" described by "Outage cause." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Outage confirmed"
    described by "Emitted when an outage is confirmed."
  }

  event CrewDispatched is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    crewId is CrewId with { briefly "Crew" described by "Crew ID." }
    dispatchedAt is TimeStamp with { briefly "Dispatched" described by "Dispatch time." }
  } with {
    briefly "Crew dispatched"
    described by "Emitted when a crew is dispatched."
  }

  event CrewArrived is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    crewId is CrewId with { briefly "Crew" described by "Crew ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Crew arrived"
    described by "Emitted when a crew arrives on site."
  }

  event RestorationStarted is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    stepCount is Natural with { briefly "Steps" described by "Number of steps." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Restoration started"
    described by "Emitted when restoration begins."
  }

  event RestorationStepCompleted is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    stepId is UUID with { briefly "Step" described by "Step ID." }
    success is Boolean with { briefly "Success" described by "Step success." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Restoration step completed"
    described by "Emitted when a restoration step completes."
  }

  event PowerRestored is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    restoredAt is TimeStamp with { briefly "Restored" described by "Restoration time." }
  } with {
    briefly "Power restored"
    described by "Emitted when power is restored."
  }

  event CustomersNotified is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    notificationCount is Natural with { briefly "Count" described by "Notifications sent." }
    notifiedAt is TimeStamp with { briefly "Notified" described by "Notification time." }
  } with {
    briefly "Customers notified"
    described by "Emitted when customer notifications are sent."
  }

  event OutageClosed is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    analysis is PostOutageAnalysis with { briefly "Analysis" described by "Post-outage analysis." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Outage closed"
    described by "Emitted when the outage event is closed."
  }

  event OutageCancelled is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Outage cancelled"
    described by "Emitted when an outage report is cancelled."
  }

  // States
  record ActiveStateData is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    outageInfo is OutageInfo with { briefly "Info" described by "Outage info." }
    status is OutageStatus with { briefly "Status" described by "Outage status." }
    determinedCause is optional OutageCause with { briefly "Cause" described by "Outage cause." }
    currentAffectedDevices is many optional AffectedDevice with { briefly "Devices" described by "Affected devices." }
    crewAssignments is many optional CrewAssignment with { briefly "Crews" described by "Assigned crews." }
    restorationSteps is many optional RestorationStep with { briefly "Steps" described by "Restoration steps." }
    notifications is many optional CustomerNotification with { briefly "Notifications" described by "Sent notifications." }
    detectedAt is TimeStamp with { briefly "Detected" described by "Detection time." }
  } with {
    briefly "Active outage state"
    described by "State for an active outage event."
  }

  record ClosedStateData is {
    outageId is OutageEventId with { briefly "Outage" described by "Outage ID." }
    restoredAt is TimeStamp with { briefly "Restored" described by "Restoration time." }
    analysis is PostOutageAnalysis with { briefly "Analysis" described by "Post-outage analysis." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Closed outage state"
    described by "State for a closed outage event."
  }

  state ActiveState of OutageEvent.ActiveStateData with {
    briefly "Outage active"
    described by "Outage event is being managed."
  }

  state ClosedState of OutageEvent.ClosedStateData with {
    briefly "Outage closed"
    described by "Outage event has been resolved and closed."
  }

  handler OutageEventHandler is {
    on command ReportOutage {
      morph entity OutageContext.OutageEvent to state OutageContext.OutageEvent.ActiveState with command ReportOutage
      tell event OutageReported to entity OutageContext.OutageEvent
    }
    on command ConfirmOutage {
      tell event OutageConfirmed to entity OutageContext.OutageEvent
    }
    on command DispatchCrew {
      tell event CrewDispatched to entity OutageContext.OutageEvent
    }
    on command RecordCrewArrival {
      tell event CrewArrived to entity OutageContext.OutageEvent
    }
    on command BeginRestoration {
      tell event RestorationStarted to entity OutageContext.OutageEvent
    }
    on command CompleteRestorationStep {
      tell event RestorationStepCompleted to entity OutageContext.OutageEvent
    }
    on command RestorePower {
      tell event PowerRestored to entity OutageContext.OutageEvent
    }
    on command NotifyCustomers {
      tell event CustomersNotified to entity OutageContext.OutageEvent
    }
    on command CloseOutage {
      morph entity OutageContext.OutageEvent to state OutageContext.OutageEvent.ClosedState with command CloseOutage
      tell event OutageClosed to entity OutageContext.OutageEvent
    }
    on command CancelOutage {
      tell event OutageCancelled to entity OutageContext.OutageEvent
    }
  } with {
    briefly "Processes outage event commands"
    described by "Handles outage event lifecycle."
  }

} with {
  briefly "OutageEvent aggregate"
  described by "Manages electric utility outage events."
}
