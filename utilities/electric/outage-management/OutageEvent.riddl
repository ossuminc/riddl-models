// Outage Management - OutageEvent Entity
entity OutageEvent is {
  command ReportOutage is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |New outage event identifier.
      }
    }
    outageInfo: OutageInfo with {
      briefly "Outage info"
      described as {
        |Outage event details.
      }
    }
    affectedDevices: AffectedDevice+ with {
      briefly "Devices"
      described as {
        |Affected grid devices.
      }
    }
  } with {
    briefly "Report outage"
    described as {
      |Reports a new outage event.
    }
  }
  command ConfirmOutage is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    confirmedBy: String(1,100) with {
      briefly "Confirmed by"
      described as {
        |Person or system confirming the outage.
      }
    }
    cause: OutageCause with {
      briefly "Cause"
      described as {
        |Initial cause assessment.
      }
    }
  } with {
    briefly "Confirm outage"
    described as {
      |Confirms a detected outage event.
    }
  }
  command DispatchCrew is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    assignment: CrewAssignment with {
      briefly "Assignment"
      described as {
        |Crew assignment details.
      }
    }
  } with {
    briefly "Dispatch crew"
    described as {
      |Dispatches a crew to the outage location.
    }
  }
  command RecordCrewArrival is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    crewId: CrewId with {
      briefly "Crew ID"
      described as {
        |Arriving crew identifier.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Record crew arrival"
    described as {
      |Records that a crew has arrived on site.
    }
  }
  command BeginRestoration is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    steps: RestorationStep+ with {
      briefly "Steps"
      described as {
        |Planned restoration steps.
      }
    }
  } with {
    briefly "Begin restoration"
    described as {
      |Begins the power restoration process.
    }
  }
  command CompleteRestorationStep is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    stepId: UUID with {
      briefly "Step ID"
      described as {
        |Restoration step identifier.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Whether step succeeded.
      }
    }
  } with {
    briefly "Complete restoration step"
    described as {
      |Records completion of a restoration step.
    }
  }
  command RestorePower is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Power restoration time.
      }
    }
  } with {
    briefly "Restore power"
    described as {
      |Marks power as restored for the outage area.
    }
  }
  command NotifyCustomers is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    customerNotifications: CustomerNotification+ with {
      briefly "Notifications"
      described as {
        |Customer notifications to send.
      }
    }
  } with {
    briefly "Notify customers"
    described as {
      |Sends notifications to affected customers.
    }
  }
  command CloseOutage is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    analysis: PostOutageAnalysis with {
      briefly "Analysis"
      described as {
        |Post-outage analysis.
      }
    }
  } with {
    briefly "Close outage"
    described as {
      |Closes the outage event with analysis.
    }
  }
  command CancelOutage is  {
    outageId: OutageEventId with {
      briefly "Outage ID"
      described as {
        |Outage event identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel outage"
    described as {
      |Cancels a false or duplicate outage report.
    }
  }
  // Events
  event OutageReported is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    outageInfo: OutageInfo with {
      briefly "Info"
      described as {
        |Outage info.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported"
      described as {
        |Report time.
      }
    }
  } with {
    briefly "Outage reported"
    described as {
      |Emitted when an outage is reported.
    }
  }
  event OutageConfirmed is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    cause: OutageCause with {
      briefly "Cause"
      described as {
        |Outage cause.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Outage confirmed"
    described as {
      |Emitted when an outage is confirmed.
    }
  }
  event CrewDispatched is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    crewId: CrewId with {
      briefly "Crew"
      described as {
        |Crew ID.
      }
    }
    dispatchedAt: TimeStamp with {
      briefly "Dispatched"
      described as {
        |Dispatch time.
      }
    }
  } with {
    briefly "Crew dispatched"
    described as {
      |Emitted when a crew is dispatched.
    }
  }
  event CrewArrived is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    crewId: CrewId with {
      briefly "Crew"
      described as {
        |Crew ID.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Crew arrived"
    described as {
      |Emitted when a crew arrives on site.
    }
  }
  event RestorationStarted is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    stepCount: Natural with {
      briefly "Steps"
      described as {
        |Number of steps.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Restoration started"
    described as {
      |Emitted when restoration begins.
    }
  }
  event RestorationStepCompleted is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    stepId: UUID with {
      briefly "Step"
      described as {
        |Step ID.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Step success.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Restoration step completed"
    described as {
      |Emitted when a restoration step completes.
    }
  }
  event PowerRestored is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Restoration time.
      }
    }
  } with {
    briefly "Power restored"
    described as {
      |Emitted when power is restored.
    }
  }
  event CustomersNotified is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    notificationCount: Natural with {
      briefly "Count"
      described as {
        |Notifications sent.
      }
    }
    notifiedAt: TimeStamp with {
      briefly "Notified"
      described as {
        |Notification time.
      }
    }
  } with {
    briefly "Customers notified"
    described as {
      |Emitted when customer notifications are sent.
    }
  }
  event OutageClosed is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    analysis: PostOutageAnalysis with {
      briefly "Analysis"
      described as {
        |Post-outage analysis.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Outage closed"
    described as {
      |Emitted when the outage event is closed.
    }
  }
  event OutageCancelled is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Outage cancelled"
    described as {
      |Emitted when an outage report is cancelled.
    }
  }
  // States
  record ActiveStateData is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    outageInfo: OutageInfo with {
      briefly "Info"
      described as {
        |Outage info.
      }
    }
    status: OutageStatus with {
      briefly "Status"
      described as {
        |Outage status.
      }
    }
    determinedCause: OutageCause? with {
      briefly "Cause"
      described as {
        |Outage cause.
      }
    }
    currentAffectedDevices: AffectedDevice* with {
      briefly "Devices"
      described as {
        |Affected devices.
      }
    }
    crewAssignments: CrewAssignment* with {
      briefly "Crews"
      described as {
        |Assigned crews.
      }
    }
    restorationSteps: RestorationStep* with {
      briefly "Steps"
      described as {
        |Restoration steps.
      }
    }
    notifications: CustomerNotification* with {
      briefly "Notifications"
      described as {
        |Sent notifications.
      }
    }
    detectedAt: TimeStamp with {
      briefly "Detected"
      described as {
        |Detection time.
      }
    }
  } with {
    briefly "Active outage state"
    described as {
      |State for an active outage event.
    }
  }
  record ClosedStateData is  {
    outageId: OutageEventId with {
      briefly "Outage"
      described as {
        |Outage ID.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Restoration time.
      }
    }
    analysis: PostOutageAnalysis with {
      briefly "Analysis"
      described as {
        |Post-outage analysis.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Closed outage state"
    described as {
      |State for a closed outage event.
    }
  }
  state ActiveState of type OutageEvent.ActiveStateData
  state ClosedState of type OutageEvent.ClosedStateData
  handler OutageEventHandler is {
    on command ReportOutage is {
      morph entity OutageContext.OutageEvent to state OutageContext.OutageEvent.ActiveState with command ReportOutage
      tell event OutageReported to entity OutageContext.OutageEvent
    }
    on command ConfirmOutage is {
      tell event OutageConfirmed to entity OutageContext.OutageEvent
    }
    on command DispatchCrew is {
      tell event CrewDispatched to entity OutageContext.OutageEvent
    }
    on command RecordCrewArrival is {
      tell event CrewArrived to entity OutageContext.OutageEvent
    }
    on command BeginRestoration is {
      tell event RestorationStarted to entity OutageContext.OutageEvent
    }
    on command CompleteRestorationStep is {
      tell event RestorationStepCompleted to entity OutageContext.OutageEvent
    }
    on command RestorePower is {
      tell event PowerRestored to entity OutageContext.OutageEvent
    }
    on command NotifyCustomers is {
      tell event CustomersNotified to entity OutageContext.OutageEvent
    }
    on command CloseOutage is {
      morph entity OutageContext.OutageEvent to state OutageContext.OutageEvent.ClosedState with command CloseOutage
      tell event OutageClosed to entity OutageContext.OutageEvent
    }
    on command CancelOutage is {
      tell event OutageCancelled to entity OutageContext.OutageEvent
    }
  } with {
    briefly "Processes outage event commands"
    described as {
      |Handles outage event lifecycle.
    }
  }
} with {
  briefly "OutageEvent aggregate"
  described as {
    |Manages electric utility outage events.
  }
}
