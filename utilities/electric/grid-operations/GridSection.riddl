// Grid Operations - GridSection Entity

entity GridSection is {

  command CreateSection is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "New section identifier."
    }
    substationId is SubstationId with {
      briefly "Substation"
      described by "Parent substation."
    }
    name is String(1, 100) with {
      briefly "Name"
      described by "Section name."
    }
    voltageLevel is Decimal(6, 2) with {
      briefly "Voltage"
      described by "Voltage level in kV."
    }
  } with {
    briefly "Create grid section"
    described by "Creates a new grid section."
  }

  command RecordLoad is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    load is LoadInfo with {
      briefly "Load"
      described by "Load reading."
    }
  } with {
    briefly "Record load"
    described by "Records load reading."
  }

  command ReportOutage is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    outage is OutageInfo with {
      briefly "Outage"
      described by "Outage information."
    }
  } with {
    briefly "Report outage"
    described by "Reports outage event."
  }

  command DispatchCrew is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    outageId is OutageId with {
      briefly "Outage"
      described by "Outage identifier."
    }
    crew is CrewAssignment with {
      briefly "Crew"
      described by "Crew assignment."
    }
  } with {
    briefly "Dispatch crew"
    described by "Dispatches repair crew."
  }

  command UpdateOutageStatus is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    outageId is OutageId with {
      briefly "Outage"
      described by "Outage identifier."
    }
    status is OutageStatus with {
      briefly "Status"
      described by "New status."
    }
    notes is optional String(1, 500) with {
      briefly "Notes"
      described by "Status notes."
    }
  } with {
    briefly "Update outage status"
    described by "Updates outage status."
  }

  command RestoreService is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    outageId is OutageId with {
      briefly "Outage"
      described by "Outage identifier."
    }
    restoredAt is TimeStamp with {
      briefly "Restored"
      described by "Restoration time."
    }
  } with {
    briefly "Restore service"
    described by "Marks service restored."
  }

  command ExecuteSwitching is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    order is SwitchingOrder with {
      briefly "Order"
      described by "Switching order."
    }
  } with {
    briefly "Execute switching"
    described by "Executes switching order."
  }

  command SetMaintenanceMode is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Maintenance reason."
    }
    plannedEnd is TimeStamp with {
      briefly "Planned end"
      described by "Planned end time."
    }
  } with {
    briefly "Set maintenance mode"
    described by "Puts section in maintenance."
  }

  command ReturnToService is {
    sectionId is GridSectionId with {
      briefly "Section ID"
      described by "Section identifier."
    }
  } with {
    briefly "Return to service"
    described by "Returns section to normal operation."
  }

  // Events
  event SectionCreated is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    name is String(1, 100) with { briefly "Name" described by "Section name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Section created"
    described by "Emitted when section is created."
  }

  event LoadRecorded is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    load is LoadInfo with { briefly "Load" described by "Load data." }
  } with {
    briefly "Load recorded"
    described by "Emitted when load is recorded."
  }

  event OutageReported is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    outage is OutageInfo with { briefly "Outage" described by "Outage info." }
  } with {
    briefly "Outage reported"
    described by "Emitted when outage is reported."
  }

  event CrewDispatched is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    outageId is OutageId with { briefly "Outage" described by "Outage ID." }
    crew is CrewAssignment with { briefly "Crew" described by "Crew info." }
  } with {
    briefly "Crew dispatched"
    described by "Emitted when crew is dispatched."
  }

  event OutageStatusUpdated is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    outageId is OutageId with { briefly "Outage" described by "Outage ID." }
    status is OutageStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Outage status updated"
    described by "Emitted when outage status changes."
  }

  event ServiceRestored is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    outageId is OutageId with { briefly "Outage" described by "Outage ID." }
    restoredAt is TimeStamp with { briefly "Restored" described by "Restoration time." }
    durationMinutes is Natural with { briefly "Duration" described by "Outage duration." }
  } with {
    briefly "Service restored"
    described by "Emitted when service is restored."
  }

  event SwitchingExecuted is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    order is SwitchingOrder with { briefly "Order" described by "Switching order." }
  } with {
    briefly "Switching executed"
    described by "Emitted when switching completes."
  }

  event MaintenanceModeSet is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Maintenance reason." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Maintenance mode set"
    described by "Emitted when maintenance starts."
  }

  event ReturnedToService is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    returnedAt is TimeStamp with { briefly "Returned" described by "Return time." }
  } with {
    briefly "Returned to service"
    described by "Emitted when section returns to service."
  }

  // States
  record ActiveStateData is {
    sectionId is GridSectionId with { briefly "Section" described by "Section ID." }
    substationId is SubstationId with { briefly "Substation" described by "Substation ID." }
    name is String(1, 100) with { briefly "Name" described by "Section name." }
    voltageLevel is Decimal(6, 2) with { briefly "Voltage" described by "Voltage level." }
    gridStatus is GridStatus with { briefly "Status" described by "Grid status." }
    currentLoad is optional LoadInfo with { briefly "Load" described by "Current load." }
    activeOutages is many optional OutageInfo with { briefly "Outages" described by "Active outages." }
    crewAssignments is many optional CrewAssignment with { briefly "Crews" described by "Assigned crews." }
  } with {
    briefly "Active section state"
    described by "State for active grid section."
  }

  state ActiveState of GridSection.ActiveStateData with {
    briefly "Section active"
    described by "Grid section is operational."
  }

  handler GridSectionHandler is {
    on command CreateSection {
      morph entity GridContext.GridSection to state GridContext.GridSection.ActiveState with command CreateSection
      tell event SectionCreated to entity GridContext.GridSection
    }
    on command RecordLoad {
      tell event LoadRecorded to entity GridContext.GridSection
    }
    on command ReportOutage {
      tell event OutageReported to entity GridContext.GridSection
    }
    on command DispatchCrew {
      tell event CrewDispatched to entity GridContext.GridSection
    }
    on command UpdateOutageStatus {
      tell event OutageStatusUpdated to entity GridContext.GridSection
    }
    on command RestoreService {
      tell event ServiceRestored to entity GridContext.GridSection
    }
    on command ExecuteSwitching {
      tell event SwitchingExecuted to entity GridContext.GridSection
    }
    on command SetMaintenanceMode {
      tell event MaintenanceModeSet to entity GridContext.GridSection
    }
    on command ReturnToService {
      tell event ReturnedToService to entity GridContext.GridSection
    }
  } with {
    briefly "Processes grid section commands"
    described by "Handles grid section operations."
  }

} with {
  briefly "GridSection aggregate"
  described by "Manages electric grid sections."
}
