// Grid Operations - Grid Context

context GridContext is {

  include "types.riddl"
  include "GridSection.riddl"

  repository GridRepository is {
    schema GridData is relational
      of gridSections as GridSection
      index on field GridSection.sectionId
      index on field GridSection.substationId
      index on field GridSection.status

    handler GridPersistence is {
      on event GridSection.SectionCreated {
        prompt "Store new grid section"
      }
      on event GridSection.LoadRecorded {
        prompt "Store load reading"
      }
      on event GridSection.OutageReported {
        prompt "Store outage event"
      }
      on event GridSection.ServiceRestored {
        prompt "Update outage as restored"
      }
      on event GridSection.SwitchingExecuted {
        prompt "Store switching order"
      }
    } with {
      briefly "Persists grid events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Grid data persistence"
    described by "Persistent storage for grid operations."
  }

  projector GridAnalytics is {
    updates repository GridRepository

    record ReliabilityMetrics is {
      saidi is Decimal(8, 2) with { briefly "SAIDI" described by "System average interruption duration index." }
      saifi is Decimal(6, 4) with { briefly "SAIFI" described by "System average interruption frequency index." }
      caidi is Decimal(8, 2) with { briefly "CAIDI" described by "Customer average interruption duration." }
      asai is Decimal(7, 5) with { briefly "ASAI" described by "Average service availability index." }
    } with {
      briefly "Reliability metrics"
      described by "Grid reliability indices."
    }

    record LoadProfile is {
      peakLoadMW is Decimal(10, 2) with { briefly "Peak" described by "Peak load MW." }
      averageLoadMW is Decimal(10, 2) with { briefly "Average" described by "Average load MW." }
      loadFactor is Decimal(5, 4) with { briefly "Load factor" described by "Load factor." }
    } with {
      briefly "Load profile"
      described by "Load profile metrics."
    }

    handler AnalyticsHandler is {
      on event GridSection.LoadRecorded {
        prompt "Update load analytics"
      }
      on event GridSection.ServiceRestored {
        prompt "Calculate reliability metrics"
      }
    } with {
      briefly "Maintains grid analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Grid analytics"
    described by "Grid performance analytics."
  }

} with {
  briefly "Bounded context for grid operations"
  described by "Electric grid management context."
}
