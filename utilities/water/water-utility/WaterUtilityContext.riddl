// Water Utility - Water Utility Context

context WaterUtilityContext is {

  include "types.riddl"
  include "WaterSystem.riddl"

  repository WaterUtilityRepository is {
    schema WaterUtilityData is relational
      of waterSystems as WaterSystem
      index on field WaterSystem.systemId
      index on field WaterSystem.status
      index on field WaterSystem.systemName

    handler WaterUtilityPersistence is {
      on event WaterSystem.SystemRegistered {
        prompt "Store new water system"
      }
      on event WaterSystem.TreatmentStatusUpdated {
        prompt "Update treatment plant status"
      }
      on event WaterSystem.QualityTestRecorded {
        prompt "Store quality test result"
      }
      on event WaterSystem.LeakReported {
        prompt "Store leak report"
      }
      on event WaterSystem.LeakResolved {
        prompt "Update leak report as resolved"
      }
      on event WaterSystem.ComplianceReportSubmitted {
        prompt "Store compliance report"
      }
    } with {
      briefly "Persists water utility events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Water utility data persistence"
    described by "Persistent storage for water utility data."
  }

  projector WaterUtilityMetrics is {
    updates repository WaterUtilityRepository

    record SystemMetrics is {
      totalSystems is Natural with { briefly "Systems" described by "Total registered systems." }
      qualityTestsRun is Natural with { briefly "Tests" described by "Quality tests performed." }
      qualityTestsFailed is Natural with { briefly "Failed" described by "Quality tests failed." }
      activeLeaks is Natural with { briefly "Leaks" described by "Active leak count." }
      leaksResolved is Natural with { briefly "Resolved" described by "Leaks resolved." }
      alertsRaised is Natural with { briefly "Alerts" described by "Alerts raised." }
      complianceReportsSubmitted is Natural with { briefly "Reports" described by "Compliance reports submitted." }
    } with {
      briefly "System metrics"
      described by "Water utility operational metrics."
    }

    handler MetricsHandler is {
      on event WaterSystem.SystemRegistered {
        prompt "Increment total systems"
      }
      on event WaterSystem.QualityTestRecorded {
        prompt "Increment quality tests and check failures"
      }
      on event WaterSystem.LeakReported {
        prompt "Increment active leaks"
      }
      on event WaterSystem.LeakResolved {
        prompt "Decrement active leaks increment resolved"
      }
      on event WaterSystem.AlertRaised {
        prompt "Increment alerts raised"
      }
      on event WaterSystem.ComplianceReportSubmitted {
        prompt "Increment compliance reports submitted"
      }
    } with {
      briefly "Maintains water utility metrics"
      described by "Projects events into operational metrics."
    }
  } with {
    briefly "Water utility metrics"
    described by "Water utility operational analytics."
  }

} with {
  briefly "Bounded context for water utility management"
  described by "Water utility treatment, distribution, and compliance context."
}
