// Water Utility - WaterSystem Entity

entity WaterSystem is {

  command RegisterSystem is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "New water system identifier."
    }
    systemName is String(3, 200) with {
      briefly "Name"
      described by "Water system name."
    }
    plants is many TreatmentPlantInfo with {
      briefly "Plants"
      described by "Treatment plants in system."
    }
    zones is many DistributionZoneInfo with {
      briefly "Zones"
      described by "Distribution zones in system."
    }
  } with {
    briefly "Register system"
    described by "Registers a new water system."
  }

  command UpdateTreatmentStatus is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    plantId is TreatmentPlantId with {
      briefly "Plant ID"
      described by "Treatment plant identifier."
    }
    currentOutput is Decimal(12, 2) with {
      briefly "Output"
      described by "Current output in gallons per day."
    }
    activeStages is many TreatmentStage with {
      briefly "Stages"
      described by "Active treatment stages."
    }
  } with {
    briefly "Update treatment status"
    described by "Updates treatment plant operational status."
  }

  command RecordQualityTest is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    testResult is QualityTestResult with {
      briefly "Result"
      described by "Quality test result."
    }
  } with {
    briefly "Record quality test"
    described by "Records a water quality test result."
  }

  command UpdatePressure is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    reading is PressureReading with {
      briefly "Reading"
      described by "Pressure reading."
    }
  } with {
    briefly "Update pressure"
    described by "Updates distribution pressure reading."
  }

  command ReportLeak is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    leak is LeakReport with {
      briefly "Leak"
      described by "Leak report details."
    }
  } with {
    briefly "Report leak"
    described by "Reports a detected leak in the distribution network."
  }

  command ResolveLeak is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    reportId is UUID with {
      briefly "Report ID"
      described by "Leak report identifier."
    }
    repairedAt is TimeStamp with {
      briefly "Repaired"
      described by "Repair completion time."
    }
  } with {
    briefly "Resolve leak"
    described by "Marks a detected leak as repaired."
  }

  command RaiseAlert is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    severity is AlertSeverity with {
      briefly "Severity"
      described by "Alert severity level."
    }
    message is String(3, 1000) with {
      briefly "Message"
      described by "Alert message."
    }
  } with {
    briefly "Raise alert"
    described by "Raises a system alert."
  }

  command SubmitComplianceReport is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    report is ComplianceReport with {
      briefly "Report"
      described by "Compliance report."
    }
  } with {
    briefly "Submit compliance report"
    described by "Submits a regulatory compliance report."
  }

  command ShutdownSystem is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Shutdown reason."
    }
  } with {
    briefly "Shutdown system"
    described by "Shuts down the water system."
  }

  command RestoreSystem is {
    systemId is WaterSystemId with {
      briefly "System ID"
      described by "Water system identifier."
    }
    restoredAt is TimeStamp with {
      briefly "Restored"
      described by "Restoration time."
    }
  } with {
    briefly "Restore system"
    described by "Restores a shut down water system to operation."
  }

  // Events
  event SystemRegistered is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    systemName is String(3, 200) with { briefly "Name" described by "System name." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "System registered"
    described by "Emitted when a water system is registered."
  }

  event TreatmentStatusUpdated is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    plantId is TreatmentPlantId with { briefly "Plant" described by "Plant ID." }
    currentOutput is Decimal(12, 2) with { briefly "Output" described by "Current output." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Treatment status updated"
    described by "Emitted when treatment plant status changes."
  }

  event QualityTestRecorded is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    testResult is QualityTestResult with { briefly "Result" described by "Test result." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Quality test recorded"
    described by "Emitted when a quality test result is recorded."
  }

  event PressureUpdated is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    reading is PressureReading with { briefly "Reading" described by "Pressure reading." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Pressure updated"
    described by "Emitted when a pressure reading is recorded."
  }

  event LeakReported is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    leak is LeakReport with { briefly "Leak" described by "Leak report." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Leak reported"
    described by "Emitted when a leak is detected and reported."
  }

  event LeakResolved is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    reportId is UUID with { briefly "Report" described by "Leak report ID." }
    repairedAt is TimeStamp with { briefly "Repaired" described by "Repair time." }
  } with {
    briefly "Leak resolved"
    described by "Emitted when a leak is repaired."
  }

  event AlertRaised is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    severity is AlertSeverity with { briefly "Severity" described by "Alert severity." }
    message is String(3, 1000) with { briefly "Message" described by "Alert message." }
    raisedAt is TimeStamp with { briefly "Raised" described by "Alert time." }
  } with {
    briefly "Alert raised"
    described by "Emitted when a system alert is raised."
  }

  event ComplianceReportSubmitted is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    report is ComplianceReport with { briefly "Report" described by "Compliance report." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Compliance report submitted"
    described by "Emitted when a compliance report is submitted."
  }

  event SystemShutdown is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Shutdown reason." }
    shutdownAt is TimeStamp with { briefly "Shutdown" described by "Shutdown time." }
  } with {
    briefly "System shut down"
    described by "Emitted when the water system is shut down."
  }

  event SystemRestored is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    restoredAt is TimeStamp with { briefly "Restored" described by "Restoration time." }
  } with {
    briefly "System restored"
    described by "Emitted when the water system is restored."
  }

  // States
  record OperationalStateData is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    systemName is String(3, 200) with { briefly "Name" described by "System name." }
    status is SystemStatus with { briefly "Status" described by "System status." }
    plants is many TreatmentPlantInfo with { briefly "Plants" described by "Treatment plants." }
    zones is many DistributionZoneInfo with { briefly "Zones" described by "Distribution zones." }
    qualityResults is many optional QualityTestResult with { briefly "Quality" described by "Recent quality results." }
    activeLeaks is many optional LeakReport with { briefly "Leaks" described by "Active leak reports." }
    complianceReports is many optional ComplianceReport with { briefly "Compliance" described by "Compliance reports." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Operational state data"
    described by "State data for an operational water system."
  }

  record ShutdownStateData is {
    systemId is WaterSystemId with { briefly "System" described by "System ID." }
    systemName is String(3, 200) with { briefly "Name" described by "System name." }
    reason is String(3, 500) with { briefly "Reason" described by "Shutdown reason." }
    shutdownAt is TimeStamp with { briefly "Shutdown" described by "Shutdown time." }
  } with {
    briefly "Shutdown state data"
    described by "State data for a shut down water system."
  }

  state OperationalState of WaterSystem.OperationalStateData with {
    briefly "System operational"
    described by "Water system is operational and processing."
  }

  state ShutdownState of WaterSystem.ShutdownStateData with {
    briefly "System shut down"
    described by "Water system is shut down."
  }

  handler WaterSystemHandler is {
    on command RegisterSystem {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.OperationalState with command RegisterSystem
      tell event SystemRegistered to entity WaterUtilityContext.WaterSystem
    }
    on command UpdateTreatmentStatus {
      tell event TreatmentStatusUpdated to entity WaterUtilityContext.WaterSystem
    }
    on command RecordQualityTest {
      tell event QualityTestRecorded to entity WaterUtilityContext.WaterSystem
    }
    on command UpdatePressure {
      tell event PressureUpdated to entity WaterUtilityContext.WaterSystem
    }
    on command ReportLeak {
      tell event LeakReported to entity WaterUtilityContext.WaterSystem
    }
    on command ResolveLeak {
      tell event LeakResolved to entity WaterUtilityContext.WaterSystem
    }
    on command RaiseAlert {
      tell event AlertRaised to entity WaterUtilityContext.WaterSystem
    }
    on command SubmitComplianceReport {
      tell event ComplianceReportSubmitted to entity WaterUtilityContext.WaterSystem
    }
    on command ShutdownSystem {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.ShutdownState with command ShutdownSystem
      tell event SystemShutdown to entity WaterUtilityContext.WaterSystem
    }
    on command RestoreSystem {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.OperationalState with command RestoreSystem
      tell event SystemRestored to entity WaterUtilityContext.WaterSystem
    }
  } with {
    briefly "Processes water system commands"
    described by "Handles water system lifecycle."
  }

} with {
  briefly "WaterSystem aggregate"
  described by "Manages water utility system operations."
}
