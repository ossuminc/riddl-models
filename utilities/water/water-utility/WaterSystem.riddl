// Water Utility - WaterSystem Entity
entity WaterSystem is {
  command RegisterSystem is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |New water system identifier.
      }
    }
    systemName: String(3,200) with {
      briefly "Name"
      described as {
        |Water system name.
      }
    }
    plants: TreatmentPlantInfo+ with {
      briefly "Plants"
      described as {
        |Treatment plants in system.
      }
    }
    zones: DistributionZoneInfo+ with {
      briefly "Zones"
      described as {
        |Distribution zones in system.
      }
    }
  } with {
    briefly "Register system"
    described as {
      |Registers a new water system.
    }
  }
  command UpdateTreatmentStatus is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    plantId: TreatmentPlantId with {
      briefly "Plant ID"
      described as {
        |Treatment plant identifier.
      }
    }
    currentOutput: Decimal(12,2) with {
      briefly "Output"
      described as {
        |Current output in gallons per day.
      }
    }
    activeStages: TreatmentStage+ with {
      briefly "Stages"
      described as {
        |Active treatment stages.
      }
    }
  } with {
    briefly "Update treatment status"
    described as {
      |Updates treatment plant operational status.
    }
  }
  command RecordQualityTest is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    testResult: QualityTestResult with {
      briefly "Result"
      described as {
        |Quality test result.
      }
    }
  } with {
    briefly "Record quality test"
    described as {
      |Records a water quality test result.
    }
  }
  command UpdatePressure is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    reading: PressureReading with {
      briefly "Reading"
      described as {
        |Pressure reading.
      }
    }
  } with {
    briefly "Update pressure"
    described as {
      |Updates distribution pressure reading.
    }
  }
  command ReportLeak is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    leak: LeakReport with {
      briefly "Leak"
      described as {
        |Leak report details.
      }
    }
  } with {
    briefly "Report leak"
    described as {
      |Reports a detected leak in the distribution network.
    }
  }
  command ResolveLeak is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    reportId: UUID with {
      briefly "Report ID"
      described as {
        |Leak report identifier.
      }
    }
    repairedAt: TimeStamp with {
      briefly "Repaired"
      described as {
        |Repair completion time.
      }
    }
  } with {
    briefly "Resolve leak"
    described as {
      |Marks a detected leak as repaired.
    }
  }
  command RaiseAlert is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    severity: AlertSeverity with {
      briefly "Severity"
      described as {
        |Alert severity level.
      }
    }
    message: String(3,1000) with {
      briefly "Message"
      described as {
        |Alert message.
      }
    }
  } with {
    briefly "Raise alert"
    described as {
      |Raises a system alert.
    }
  }
  command SubmitComplianceReport is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    report: ComplianceReport with {
      briefly "Report"
      described as {
        |Compliance report.
      }
    }
  } with {
    briefly "Submit compliance report"
    described as {
      |Submits a regulatory compliance report.
    }
  }
  command ShutdownSystem is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Shutdown reason.
      }
    }
  } with {
    briefly "Shutdown system"
    described as {
      |Shuts down the water system.
    }
  }
  command RestoreSystem is  {
    systemId: WaterSystemId with {
      briefly "System ID"
      described as {
        |Water system identifier.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Restoration time.
      }
    }
  } with {
    briefly "Restore system"
    described as {
      |Restores a shut down water system to operation.
    }
  }
  // Events
  event SystemRegistered is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    systemName: String(3,200) with {
      briefly "Name"
      described as {
        |System name.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "System registered"
    described as {
      |Emitted when a water system is registered.
    }
  }
  event TreatmentStatusUpdated is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    plantId: TreatmentPlantId with {
      briefly "Plant"
      described as {
        |Plant ID.
      }
    }
    currentOutput: Decimal(12,2) with {
      briefly "Output"
      described as {
        |Current output.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Treatment status updated"
    described as {
      |Emitted when treatment plant status changes.
    }
  }
  event QualityTestRecorded is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    testResult: QualityTestResult with {
      briefly "Result"
      described as {
        |Test result.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Quality test recorded"
    described as {
      |Emitted when a quality test result is recorded.
    }
  }
  event PressureUpdated is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    reading: PressureReading with {
      briefly "Reading"
      described as {
        |Pressure reading.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Pressure updated"
    described as {
      |Emitted when a pressure reading is recorded.
    }
  }
  event LeakReported is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    leak: LeakReport with {
      briefly "Leak"
      described as {
        |Leak report.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported"
      described as {
        |Report time.
      }
    }
  } with {
    briefly "Leak reported"
    described as {
      |Emitted when a leak is detected and reported.
    }
  }
  event LeakResolved is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    reportId: UUID with {
      briefly "Report"
      described as {
        |Leak report ID.
      }
    }
    repairedAt: TimeStamp with {
      briefly "Repaired"
      described as {
        |Repair time.
      }
    }
  } with {
    briefly "Leak resolved"
    described as {
      |Emitted when a leak is repaired.
    }
  }
  event AlertRaised is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    severity: AlertSeverity with {
      briefly "Severity"
      described as {
        |Alert severity.
      }
    }
    message: String(3,1000) with {
      briefly "Message"
      described as {
        |Alert message.
      }
    }
    raisedAt: TimeStamp with {
      briefly "Raised"
      described as {
        |Alert time.
      }
    }
  } with {
    briefly "Alert raised"
    described as {
      |Emitted when a system alert is raised.
    }
  }
  event ComplianceReportSubmitted is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    report: ComplianceReport with {
      briefly "Report"
      described as {
        |Compliance report.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Compliance report submitted"
    described as {
      |Emitted when a compliance report is submitted.
    }
  }
  event SystemShutdown is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Shutdown reason.
      }
    }
    shutdownAt: TimeStamp with {
      briefly "Shutdown"
      described as {
        |Shutdown time.
      }
    }
  } with {
    briefly "System shut down"
    described as {
      |Emitted when the water system is shut down.
    }
  }
  event SystemRestored is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    restoredAt: TimeStamp with {
      briefly "Restored"
      described as {
        |Restoration time.
      }
    }
  } with {
    briefly "System restored"
    described as {
      |Emitted when the water system is restored.
    }
  }
  // States
  record OperationalStateData is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    systemName: String(3,200) with {
      briefly "Name"
      described as {
        |System name.
      }
    }
    status: SystemStatus with {
      briefly "Status"
      described as {
        |System status.
      }
    }
    plants: TreatmentPlantInfo+ with {
      briefly "Plants"
      described as {
        |Treatment plants.
      }
    }
    zones: DistributionZoneInfo+ with {
      briefly "Zones"
      described as {
        |Distribution zones.
      }
    }
    qualityResults: QualityTestResult* with {
      briefly "Quality"
      described as {
        |Recent quality results.
      }
    }
    activeLeaks: LeakReport* with {
      briefly "Leaks"
      described as {
        |Active leak reports.
      }
    }
    complianceReports: ComplianceReport* with {
      briefly "Compliance"
      described as {
        |Compliance reports.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Operational state data"
    described as {
      |State data for an operational water system.
    }
  }
  record ShutdownStateData is  {
    systemId: WaterSystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    systemName: String(3,200) with {
      briefly "Name"
      described as {
        |System name.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Shutdown reason.
      }
    }
    shutdownAt: TimeStamp with {
      briefly "Shutdown"
      described as {
        |Shutdown time.
      }
    }
  } with {
    briefly "Shutdown state data"
    described as {
      |State data for a shut down water system.
    }
  }
  state OperationalState of type WaterSystem.OperationalStateData
  state ShutdownState of type WaterSystem.ShutdownStateData
  handler WaterSystemHandler is {
    on command RegisterSystem is {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.OperationalState with command RegisterSystem
      tell event SystemRegistered to entity WaterUtilityContext.WaterSystem
    }
    on command UpdateTreatmentStatus is {
      tell event TreatmentStatusUpdated to entity WaterUtilityContext.WaterSystem
    }
    on command RecordQualityTest is {
      tell event QualityTestRecorded to entity WaterUtilityContext.WaterSystem
    }
    on command UpdatePressure is {
      tell event PressureUpdated to entity WaterUtilityContext.WaterSystem
    }
    on command ReportLeak is {
      tell event LeakReported to entity WaterUtilityContext.WaterSystem
    }
    on command ResolveLeak is {
      tell event LeakResolved to entity WaterUtilityContext.WaterSystem
    }
    on command RaiseAlert is {
      tell event AlertRaised to entity WaterUtilityContext.WaterSystem
    }
    on command SubmitComplianceReport is {
      tell event ComplianceReportSubmitted to entity WaterUtilityContext.WaterSystem
    }
    on command ShutdownSystem is {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.ShutdownState with command ShutdownSystem
      tell event SystemShutdown to entity WaterUtilityContext.WaterSystem
    }
    on command RestoreSystem is {
      morph entity WaterUtilityContext.WaterSystem to state WaterUtilityContext.WaterSystem.OperationalState with command RestoreSystem
      tell event SystemRestored to entity WaterUtilityContext.WaterSystem
    }
  } with {
    briefly "Processes water system commands"
    described as {
      |Handles water system lifecycle.
    }
  }
} with {
  briefly "WaterSystem aggregate"
  described as {
    |Manages water utility system operations.
  }
}
