// Water Distribution - DistributionZone Entity

entity DistributionZone is {

  command CreateZone is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "New zone identifier."
    }
    name is String(1, 100) with {
      briefly "Name"
      described by "Zone name."
    }
    serviceArea is String(1, 200) with {
      briefly "Service area"
      described by "Geographic service area."
    }
    customerCount is Natural with {
      briefly "Customers"
      described by "Customer count."
    }
  } with {
    briefly "Create zone"
    described by "Creates a distribution zone."
  }

  command RecordPressure is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    reading is PressureReading with {
      briefly "Reading"
      described by "Pressure reading."
    }
  } with {
    briefly "Record pressure"
    described by "Records pressure reading."
  }

  command SubmitQualitySample is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    sample is WaterQualitySample with {
      briefly "Sample"
      described by "Quality sample."
    }
  } with {
    briefly "Submit quality sample"
    described by "Submits water quality sample."
  }

  command ReportLeak is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    leak is LeakReport with {
      briefly "Leak"
      described by "Leak report."
    }
  } with {
    briefly "Report leak"
    described by "Reports water main leak."
  }

  command ScheduleMaintenance is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    work is MaintenanceWork with {
      briefly "Work"
      described by "Maintenance work."
    }
  } with {
    briefly "Schedule maintenance"
    described by "Schedules maintenance work."
  }

  command IssueBoilWaterAdvisory is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Advisory reason."
    }
    affectedArea is String(1, 200) with {
      briefly "Area"
      described by "Affected area."
    }
  } with {
    briefly "Issue boil water advisory"
    described by "Issues boil water advisory."
  }

  command LiftBoilWaterAdvisory is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    liftedAt is TimeStamp with {
      briefly "Lifted"
      described by "Lift time."
    }
  } with {
    briefly "Lift boil water advisory"
    described by "Lifts boil water advisory."
  }

  command UpdateReservoirLevel is {
    zoneId is DistributionZoneId with {
      briefly "Zone ID"
      described by "Zone identifier."
    }
    level is ReservoirLevel with {
      briefly "Level"
      described by "Reservoir level."
    }
  } with {
    briefly "Update reservoir level"
    described by "Updates reservoir level."
  }

  // Events
  event ZoneCreated is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    name is String(1, 100) with { briefly "Name" described by "Zone name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Zone created"
    described by "Emitted when zone is created."
  }

  event PressureRecorded is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    reading is PressureReading with { briefly "Reading" described by "Pressure data." }
  } with {
    briefly "Pressure recorded"
    described by "Emitted when pressure is recorded."
  }

  event QualitySampleSubmitted is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    sample is WaterQualitySample with { briefly "Sample" described by "Sample data." }
    status is WaterQualityStatus with { briefly "Status" described by "Quality status." }
  } with {
    briefly "Quality sample submitted"
    described by "Emitted when sample is submitted."
  }

  event LeakReported is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    leak is LeakReport with { briefly "Leak" described by "Leak data." }
  } with {
    briefly "Leak reported"
    described by "Emitted when leak is reported."
  }

  event MaintenanceScheduled is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    work is MaintenanceWork with { briefly "Work" described by "Maintenance work." }
  } with {
    briefly "Maintenance scheduled"
    described by "Emitted when maintenance is scheduled."
  }

  event BoilWaterAdvisoryIssued is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Advisory reason." }
    issuedAt is TimeStamp with { briefly "Issued" described by "Issue time." }
  } with {
    briefly "Boil water advisory issued"
    described by "Emitted when advisory is issued."
  }

  event BoilWaterAdvisoryLifted is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    liftedAt is TimeStamp with { briefly "Lifted" described by "Lift time." }
  } with {
    briefly "Boil water advisory lifted"
    described by "Emitted when advisory is lifted."
  }

  event ReservoirLevelUpdated is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    level is ReservoirLevel with { briefly "Level" described by "Level data." }
  } with {
    briefly "Reservoir level updated"
    described by "Emitted when level is updated."
  }

  // States
  record ActiveStateData is {
    zoneId is DistributionZoneId with { briefly "Zone" described by "Zone ID." }
    name is String(1, 100) with { briefly "Name" described by "Zone name." }
    serviceArea is String(1, 200) with { briefly "Area" described by "Service area." }
    customerCount is Natural with { briefly "Customers" described by "Customer count." }
    status is ZoneStatus with { briefly "Status" described by "Zone status." }
    currentPressure is optional PressureReading with { briefly "Pressure" described by "Current pressure." }
    latestQualitySample is optional WaterQualitySample with { briefly "Quality" described by "Latest sample." }
    activeLeaks is many optional LeakReport with { briefly "Leaks" described by "Active leaks." }
    scheduledMaintenance is many optional MaintenanceWork with { briefly "Maintenance" described by "Scheduled work." }
    qualityStatus is WaterQualityStatus with { briefly "Quality status" described by "Quality compliance." }
  } with {
    briefly "Active zone state"
    described by "State for active distribution zone."
  }

  state ActiveState of DistributionZone.ActiveStateData with {
    briefly "Zone active"
    described by "Distribution zone is operational."
  }

  handler DistributionZoneHandler is {
    on command CreateZone {
      morph entity WaterContext.DistributionZone to state WaterContext.DistributionZone.ActiveState with command CreateZone
      tell event ZoneCreated to entity WaterContext.DistributionZone
    }
    on command RecordPressure {
      tell event PressureRecorded to entity WaterContext.DistributionZone
    }
    on command SubmitQualitySample {
      tell event QualitySampleSubmitted to entity WaterContext.DistributionZone
    }
    on command ReportLeak {
      tell event LeakReported to entity WaterContext.DistributionZone
    }
    on command ScheduleMaintenance {
      tell event MaintenanceScheduled to entity WaterContext.DistributionZone
    }
    on command IssueBoilWaterAdvisory {
      tell event BoilWaterAdvisoryIssued to entity WaterContext.DistributionZone
    }
    on command LiftBoilWaterAdvisory {
      tell event BoilWaterAdvisoryLifted to entity WaterContext.DistributionZone
    }
    on command UpdateReservoirLevel {
      tell event ReservoirLevelUpdated to entity WaterContext.DistributionZone
    }
  } with {
    briefly "Processes distribution zone commands"
    described by "Handles distribution zone operations."
  }

} with {
  briefly "DistributionZone aggregate"
  described by "Manages water distribution zones."
}
