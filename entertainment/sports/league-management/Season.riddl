// League Management - Season Entity

entity Season is {

  command CreateSeason is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "New season identifier."
    }
    seasonName is String(3, 200) with {
      briefly "Name"
      described by "Season name."
    }
    startDate is Date with {
      briefly "Start"
      described by "Season start date."
    }
    endDate is Date with {
      briefly "End"
      described by "Season end date."
    }
  } with {
    briefly "Create season"
    described by "Creates a new league season."
  }

  command RegisterTeam is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    team is TeamInfo with {
      briefly "Team"
      described by "Team registration details."
    }
  } with {
    briefly "Register team"
    described by "Registers a team for the season."
  }

  command ScheduleMatch is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    matchInfo is MatchInfo with {
      briefly "Match"
      described by "Match scheduling details."
    }
  } with {
    briefly "Schedule match"
    described by "Schedules a match in the season."
  }

  command RecordResult is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    result is MatchResult with {
      briefly "Result"
      described by "Match result details."
    }
  } with {
    briefly "Record result"
    described by "Records the result of a match."
  }

  command AssignReferee is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    assignment is RefereeAssignment with {
      briefly "Assignment"
      described by "Referee assignment details."
    }
  } with {
    briefly "Assign referee"
    described by "Assigns a referee to a match."
  }

  command ReportViolation is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    violation is RuleViolation with {
      briefly "Violation"
      described by "Rule violation details."
    }
  } with {
    briefly "Report violation"
    described by "Reports a rule violation."
  }

  command StartPlayoffs is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    bracket is PlayoffBracket with {
      briefly "Bracket"
      described by "Playoff bracket configuration."
    }
  } with {
    briefly "Start playoffs"
    described by "Initiates the playoff bracket."
  }

  command AdvanceBracket is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    bracketId is BracketId with {
      briefly "Bracket ID"
      described by "Bracket identifier."
    }
    result is MatchResult with {
      briefly "Result"
      described by "Playoff match result."
    }
  } with {
    briefly "Advance bracket"
    described by "Advances the playoff bracket after a result."
  }

  command CompleteSeason is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    championTeamId is TeamId with {
      briefly "Champion"
      described by "Champion team identifier."
    }
  } with {
    briefly "Complete season"
    described by "Completes the season with a champion."
  }

  command CancelSeason is {
    seasonId is SeasonId with {
      briefly "Season ID"
      described by "Season identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel season"
    described by "Cancels a league season."
  }

  // Events
  event SeasonCreated is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    seasonName is String(3, 200) with { briefly "Name" described by "Season name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Season created"
    described by "Emitted when a season is created."
  }

  event TeamRegistered is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    teamId is TeamId with { briefly "Team" described by "Team ID." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Team registered"
    described by "Emitted when a team registers."
  }

  event MatchScheduled is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Scheduling time." }
  } with {
    briefly "Match scheduled"
    described by "Emitted when a match is scheduled."
  }

  event ResultRecorded is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    homeScore is Natural with { briefly "Home" described by "Home score." }
    awayScore is Natural with { briefly "Away" described by "Away score." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Result recorded"
    described by "Emitted when a match result is recorded."
  }

  event RefereeAssigned is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    refereeId is RefereeId with { briefly "Referee" described by "Referee ID." }
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Referee assigned"
    described by "Emitted when a referee is assigned."
  }

  event ViolationReported is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    teamId is TeamId with { briefly "Team" described by "Team ID." }
    violationType is RuleViolationType with { briefly "Type" described by "Violation type." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Violation reported"
    described by "Emitted when a rule violation is reported."
  }

  event PlayoffsStarted is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    bracketId is BracketId with { briefly "Bracket" described by "Bracket ID." }
    teamCount is Natural with { briefly "Teams" described by "Number of teams." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Playoffs started"
    described by "Emitted when playoffs begin."
  }

  event BracketAdvanced is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    bracketId is BracketId with { briefly "Bracket" described by "Bracket ID." }
    newRound is Natural with { briefly "Round" described by "New round number." }
    advancedAt is TimeStamp with { briefly "Advanced" described by "Advance time." }
  } with {
    briefly "Bracket advanced"
    described by "Emitted when playoff bracket advances."
  }

  event SeasonCompleted is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    championTeamId is TeamId with { briefly "Champion" described by "Champion team." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Season completed"
    described by "Emitted when a season concludes."
  }

  event SeasonCancelled is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Season cancelled"
    described by "Emitted when a season is cancelled."
  }

  // States
  record ActiveSeasonData is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    seasonName is String(3, 200) with { briefly "Name" described by "Season name." }
    seasonStatus is SeasonStatus with { briefly "Status" described by "Season status." }
    startDate is Date with { briefly "Start" described by "Start date." }
    endDate is Date with { briefly "End" described by "End date." }
    teams is many optional TeamInfo with { briefly "Teams" described by "Registered teams." }
    scheduledMatches is many optional MatchInfo with { briefly "Matches" described by "Scheduled matches." }
    results is many optional MatchResult with { briefly "Results" described by "Match results." }
    standings is many optional TeamStanding with { briefly "Standings" described by "League standings." }
    refereeAssignments is many optional RefereeAssignment with { briefly "Referees" described by "Referee assignments." }
    violations is many optional RuleViolation with { briefly "Violations" described by "Rule violations." }
    playoff is optional PlayoffBracket with { briefly "Playoff" described by "Playoff bracket." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active season state"
    described by "State for an active league season."
  }

  record CompletedSeasonData is {
    seasonId is SeasonId with { briefly "Season" described by "Season ID." }
    seasonName is String(3, 200) with { briefly "Name" described by "Season name." }
    championTeamId is TeamId with { briefly "Champion" described by "Champion team." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed season state"
    described by "State for a completed season."
  }

  state ActiveSeason of Season.ActiveSeasonData with {
    briefly "Season active"
    described by "Season is in progress."
  }

  state CompletedSeason of Season.CompletedSeasonData with {
    briefly "Season completed"
    described by "Season has concluded."
  }

  handler SeasonHandler is {
    on command CreateSeason {
      morph entity LeagueContext.Season to state LeagueContext.Season.ActiveSeason with command CreateSeason
      tell event SeasonCreated to entity LeagueContext.Season
    }
    on command RegisterTeam {
      tell event TeamRegistered to entity LeagueContext.Season
    }
    on command ScheduleMatch {
      tell event MatchScheduled to entity LeagueContext.Season
    }
    on command RecordResult {
      tell event ResultRecorded to entity LeagueContext.Season
    }
    on command AssignReferee {
      tell event RefereeAssigned to entity LeagueContext.Season
    }
    on command ReportViolation {
      tell event ViolationReported to entity LeagueContext.Season
    }
    on command StartPlayoffs {
      tell event PlayoffsStarted to entity LeagueContext.Season
    }
    on command AdvanceBracket {
      tell event BracketAdvanced to entity LeagueContext.Season
    }
    on command CompleteSeason {
      morph entity LeagueContext.Season to state LeagueContext.Season.CompletedSeason with command CompleteSeason
      tell event SeasonCompleted to entity LeagueContext.Season
    }
    on command CancelSeason {
      tell event SeasonCancelled to entity LeagueContext.Season
    }
  } with {
    briefly "Processes season commands"
    described by "Handles season lifecycle."
  }

} with {
  briefly "Season aggregate"
  described by "Manages league seasons and competitions."
}
