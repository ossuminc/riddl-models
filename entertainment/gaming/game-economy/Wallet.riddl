// Game Economy - Wallet Entity
entity Wallet is {
  // Commands
  command CreateWallet is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |New wallet identifier.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Wallet owner.
      }
    }
  } with {
    briefly "Create wallet"
    described as {
      |Creates a new player wallet.
    }
  }
  command AddCurrency is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Amount to add.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Addition reason.
      }
    }
  } with {
    briefly "Add currency"
    described as {
      |Adds currency to wallet.
    }
  }
  command SpendCurrency is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Amount to spend.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Spending reason.
      }
    }
  } with {
    briefly "Spend currency"
    described as {
      |Spends currency from wallet.
    }
  }
  command TransferCurrency is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Source wallet.
      }
    }
    targetWalletId: WalletId with {
      briefly "Target"
      described as {
        |Target wallet.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Transfer amount.
      }
    }
  } with {
    briefly "Transfer currency"
    described as {
      |Transfers currency to another wallet.
    }
  }
  command AddItem is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    item: GameItem with {
      briefly "Item"
      described as {
        |Item to add.
      }
    }
  } with {
    briefly "Add item"
    described as {
      |Adds item to inventory.
    }
  }
  command RemoveItem is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    itemId: ItemId with {
      briefly "Item ID"
      described as {
        |Item to remove.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity to remove.
      }
    }
  } with {
    briefly "Remove item"
    described as {
      |Removes item from inventory.
    }
  }
  command PurchaseItem is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    storeItem: StoreItem with {
      briefly "Item"
      described as {
        |Store item.
      }
    }
    price: PriceTag with {
      briefly "Price"
      described as {
        |Purchase price.
      }
    }
  } with {
    briefly "Purchase item"
    described as {
      |Purchases item from store.
    }
  }
  command InitiateTrade is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    offer: TradeOffer with {
      briefly "Offer"
      described as {
        |Trade offer.
      }
    }
  } with {
    briefly "Initiate trade"
    described as {
      |Initiates a trade offer.
    }
  }
  command CompleteTrade is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    tradeId: UUID with {
      briefly "Trade ID"
      described as {
        |Trade to complete.
      }
    }
  } with {
    briefly "Complete trade"
    described as {
      |Completes a trade.
    }
  }
  // Events
  event WalletCreated is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Wallet owner.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Wallet was created"
    described as {
      |Emitted when wallet is created.
    }
  }
  event CurrencyAdded is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Amount added.
      }
    }
    newBalance: Decimal(15,4) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Addition reason.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Currency was added"
    described as {
      |Emitted when currency is added.
    }
  }
  event CurrencySpent is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Amount spent.
      }
    }
    newBalance: Decimal(15,4) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Spending reason.
      }
    }
    spentAt: TimeStamp with {
      briefly "Spent"
      described as {
        |Spending time.
      }
    }
  } with {
    briefly "Currency was spent"
    described as {
      |Emitted when currency is spent.
    }
  }
  event CurrencyTransferred is  {
    walletId: WalletId with {
      briefly "Source"
      described as {
        |Source wallet.
      }
    }
    targetWalletId: WalletId with {
      briefly "Target"
      described as {
        |Target wallet.
      }
    }
    currencyType: CurrencyType with {
      briefly "Currency"
      described as {
        |Currency type.
      }
    }
    amount: Decimal(15,4) with {
      briefly "Amount"
      described as {
        |Transfer amount.
      }
    }
    transferredAt: TimeStamp with {
      briefly "Transferred"
      described as {
        |Transfer time.
      }
    }
  } with {
    briefly "Currency was transferred"
    described as {
      |Emitted when currency is transferred.
    }
  }
  event ItemAdded is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    item: GameItem with {
      briefly "Item"
      described as {
        |Added item.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Item was added"
    described as {
      |Emitted when item is added.
    }
  }
  event ItemRemoved is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    itemId: ItemId with {
      briefly "Item"
      described as {
        |Removed item.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity removed.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Item was removed"
    described as {
      |Emitted when item is removed.
    }
  }
  event ItemPurchased is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    item: GameItem with {
      briefly "Item"
      described as {
        |Purchased item.
      }
    }
    price: PriceTag with {
      briefly "Price"
      described as {
        |Purchase price.
      }
    }
    purchasedAt: TimeStamp with {
      briefly "Purchased"
      described as {
        |Purchase time.
      }
    }
  } with {
    briefly "Item was purchased"
    described as {
      |Emitted when item is purchased.
    }
  }
  event TradeInitiated is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    offer: TradeOffer with {
      briefly "Offer"
      described as {
        |Trade offer.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Trade was initiated"
    described as {
      |Emitted when trade is offered.
    }
  }
  event TradeCompleted is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    tradeId: UUID with {
      briefly "Trade"
      described as {
        |Completed trade.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Trade was completed"
    described as {
      |Emitted when trade finishes.
    }
  }
  // State Records
  record ActiveStateData is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Wallet owner.
      }
    }
    balances: CurrencyBalance+ with {
      briefly "Balances"
      described as {
        |Currency balances.
      }
    }
    inventory: GameItem+ with {
      briefly "Inventory"
      described as {
        |Player items.
      }
    }
    pendingTrades: TradeOffer+ with {
      briefly "Trades"
      described as {
        |Pending trades.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active wallet.
    }
  }
  // States
  state ActiveState of type Wallet.ActiveStateData
  // Handler
  handler WalletHandler is {
    on command CreateWallet is {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command CreateWallet
      tell event WalletCreated to entity WalletContext.Wallet
    }
    on command AddCurrency is {
      tell event CurrencyAdded to entity WalletContext.Wallet
    }
    on command SpendCurrency is {
      tell event CurrencySpent to entity WalletContext.Wallet
    }
    on command TransferCurrency is {
      tell event CurrencyTransferred to entity WalletContext.Wallet
    }
    on command AddItem is {
      tell event ItemAdded to entity WalletContext.Wallet
    }
    on command RemoveItem is {
      tell event ItemRemoved to entity WalletContext.Wallet
    }
    on command PurchaseItem is {
      tell event ItemPurchased to entity WalletContext.Wallet
    }
    on command InitiateTrade is {
      tell event TradeInitiated to entity WalletContext.Wallet
    }
    on command CompleteTrade is {
      tell event TradeCompleted to entity WalletContext.Wallet
    }
  } with {
    briefly "Processes wallet commands"
    described as {
      | Handles wallet operations including currency,
      | inventory, purchases, and trading.
    }
  }
} with {
  briefly "Wallet aggregate"
  described as {
    | The Wallet entity manages player currencies,
    | inventory items, and trading operations.
  }
}
