// Game Economy - Wallet Entity

entity Wallet is {

  // Commands
  command CreateWallet is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "New wallet identifier."
    }
    playerId is PlayerId with {
      briefly "Player"
      described by "Wallet owner."
    }
  } with {
    briefly "Create wallet"
    described by "Creates a new player wallet."
  }

  command AddCurrency is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    currencyType is CurrencyType with {
      briefly "Currency"
      described by "Currency type."
    }
    amount is Decimal(15, 4) with {
      briefly "Amount"
      described by "Amount to add."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Addition reason."
    }
  } with {
    briefly "Add currency"
    described by "Adds currency to wallet."
  }

  command SpendCurrency is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    currencyType is CurrencyType with {
      briefly "Currency"
      described by "Currency type."
    }
    amount is Decimal(15, 4) with {
      briefly "Amount"
      described by "Amount to spend."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Spending reason."
    }
  } with {
    briefly "Spend currency"
    described by "Spends currency from wallet."
  }

  command TransferCurrency is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Source wallet."
    }
    targetWalletId is WalletId with {
      briefly "Target"
      described by "Target wallet."
    }
    currencyType is CurrencyType with {
      briefly "Currency"
      described by "Currency type."
    }
    amount is Decimal(15, 4) with {
      briefly "Amount"
      described by "Transfer amount."
    }
  } with {
    briefly "Transfer currency"
    described by "Transfers currency to another wallet."
  }

  command AddItem is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    item is GameItem with {
      briefly "Item"
      described by "Item to add."
    }
  } with {
    briefly "Add item"
    described by "Adds item to inventory."
  }

  command RemoveItem is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    itemId is ItemId with {
      briefly "Item ID"
      described by "Item to remove."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Quantity to remove."
    }
  } with {
    briefly "Remove item"
    described by "Removes item from inventory."
  }

  command PurchaseItem is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    storeItem is StoreItem with {
      briefly "Item"
      described by "Store item."
    }
    price is PriceTag with {
      briefly "Price"
      described by "Purchase price."
    }
  } with {
    briefly "Purchase item"
    described by "Purchases item from store."
  }

  command InitiateTrade is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    offer is TradeOffer with {
      briefly "Offer"
      described by "Trade offer."
    }
  } with {
    briefly "Initiate trade"
    described by "Initiates a trade offer."
  }

  command CompleteTrade is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    tradeId is UUID with {
      briefly "Trade ID"
      described by "Trade to complete."
    }
  } with {
    briefly "Complete trade"
    described by "Completes a trade."
  }

  // Events
  event WalletCreated is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    playerId is PlayerId with { briefly "Player" described by "Wallet owner." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Wallet was created"
    described by "Emitted when wallet is created."
  }

  event CurrencyAdded is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    currencyType is CurrencyType with { briefly "Currency" described by "Currency type." }
    amount is Decimal(15, 4) with { briefly "Amount" described by "Amount added." }
    newBalance is Decimal(15, 4) with { briefly "Balance" described by "New balance." }
    reason is String(1, 200) with { briefly "Reason" described by "Addition reason." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Currency was added"
    described by "Emitted when currency is added."
  }

  event CurrencySpent is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    currencyType is CurrencyType with { briefly "Currency" described by "Currency type." }
    amount is Decimal(15, 4) with { briefly "Amount" described by "Amount spent." }
    newBalance is Decimal(15, 4) with { briefly "Balance" described by "New balance." }
    reason is String(1, 200) with { briefly "Reason" described by "Spending reason." }
    spentAt is TimeStamp with { briefly "Spent" described by "Spending time." }
  } with {
    briefly "Currency was spent"
    described by "Emitted when currency is spent."
  }

  event CurrencyTransferred is {
    walletId is WalletId with { briefly "Source" described by "Source wallet." }
    targetWalletId is WalletId with { briefly "Target" described by "Target wallet." }
    currencyType is CurrencyType with { briefly "Currency" described by "Currency type." }
    amount is Decimal(15, 4) with { briefly "Amount" described by "Transfer amount." }
    transferredAt is TimeStamp with { briefly "Transferred" described by "Transfer time." }
  } with {
    briefly "Currency was transferred"
    described by "Emitted when currency is transferred."
  }

  event ItemAdded is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    item is GameItem with { briefly "Item" described by "Added item." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Item was added"
    described by "Emitted when item is added."
  }

  event ItemRemoved is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    itemId is ItemId with { briefly "Item" described by "Removed item." }
    quantity is Natural with { briefly "Quantity" described by "Quantity removed." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Item was removed"
    described by "Emitted when item is removed."
  }

  event ItemPurchased is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    item is GameItem with { briefly "Item" described by "Purchased item." }
    price is PriceTag with { briefly "Price" described by "Purchase price." }
    purchasedAt is TimeStamp with { briefly "Purchased" described by "Purchase time." }
  } with {
    briefly "Item was purchased"
    described by "Emitted when item is purchased."
  }

  event TradeInitiated is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    offer is TradeOffer with { briefly "Offer" described by "Trade offer." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Trade was initiated"
    described by "Emitted when trade is offered."
  }

  event TradeCompleted is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    tradeId is UUID with { briefly "Trade" described by "Completed trade." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Trade was completed"
    described by "Emitted when trade finishes."
  }

  // State Records
  record ActiveStateData is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    playerId is PlayerId with { briefly "Player" described by "Wallet owner." }
    balances is many CurrencyBalance with { briefly "Balances" described by "Currency balances." }
    inventory is many GameItem with { briefly "Inventory" described by "Player items." }
    pendingTrades is many TradeOffer with { briefly "Trades" described by "Pending trades." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state data"
    described by "State data for active wallet."
  }

  // States
  state ActiveState of Wallet.ActiveStateData with {
    briefly "Wallet is active"
    described by "Wallet is in use."
  }

  // Handler
  handler WalletHandler is {
    on command CreateWallet {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command CreateWallet
      tell event WalletCreated to entity WalletContext.Wallet
    }

    on command AddCurrency {
      tell event CurrencyAdded to entity WalletContext.Wallet
    }

    on command SpendCurrency {
      tell event CurrencySpent to entity WalletContext.Wallet
    }

    on command TransferCurrency {
      tell event CurrencyTransferred to entity WalletContext.Wallet
    }

    on command AddItem {
      tell event ItemAdded to entity WalletContext.Wallet
    }

    on command RemoveItem {
      tell event ItemRemoved to entity WalletContext.Wallet
    }

    on command PurchaseItem {
      tell event ItemPurchased to entity WalletContext.Wallet
    }

    on command InitiateTrade {
      tell event TradeInitiated to entity WalletContext.Wallet
    }

    on command CompleteTrade {
      tell event TradeCompleted to entity WalletContext.Wallet
    }
  } with {
    briefly "Processes wallet commands"
    described by {
      | Handles wallet operations including currency,
      | inventory, purchases, and trading.
    }
  }

} with {
  briefly "Wallet aggregate"
  described by {
    | The Wallet entity manages player currencies,
    | inventory items, and trading operations.
  }
}
