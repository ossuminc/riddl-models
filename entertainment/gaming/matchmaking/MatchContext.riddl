// Matchmaking - Match Context

context MatchContext is {

  include "types.riddl"
  include "Match.riddl"

  // Repository for match persistence
  repository MatchRepository is {
    schema MatchData is relational
      of matches as Match
      index on field Match.matchId
      index on field Match.gameMode

    handler MatchPersistence is {
      on command Match.CreateMatch {
        prompt "Store match record"
      }
      on command Match.AssignServer {
        prompt "Update match with server"
      }
      on command Match.ConfirmPlayer {
        prompt "Update confirmed players"
      }
      on command Match.StartMatch {
        prompt "Update match to active"
      }
      on command Match.UpdateScore {
        prompt "Update player score"
      }
      on command Match.EndMatch {
        prompt "Update match to completed"
      }
      on command Match.CancelMatch {
        prompt "Update match to cancelled"
      }
      on command Match.RemovePlayer {
        prompt "Remove player from match"
      }
    } with {
      briefly "Persists match commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Match data persistence"
    described by {
      | The MatchRepository provides persistent storage for
      | matches and matchmaking data.
    }
  }

  // Projector for matchmaking analytics
  projector MatchAnalytics is {
    updates repository MatchRepository

    record MatchStats is {
      gameMode is GameMode with { briefly "Mode" described by "Game mode." }
      totalMatches is Natural with { briefly "Matches" described by "Total matches." }
      averageQueueTime is Duration with { briefly "Queue time" described by "Avg queue time." }
      averageMatchDuration is Duration with { briefly "Duration" described by "Avg match duration." }
      completionRate is Decimal(5, 4) with { briefly "Completion" described by "Completion rate." }
      activePlayers is Natural with { briefly "Players" described by "Active players." }
    } with {
      briefly "Match statistics"
      described by "Matchmaking metrics."
    }

    handler AnalyticsHandler is {
      on event Match.MatchCreated {
        prompt "Update match counts"
      }
      on event Match.MatchStarted {
        prompt "Update queue time metrics"
      }
      on event Match.MatchEnded {
        prompt "Update completion metrics"
      }
    } with {
      briefly "Maintains match analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Match analytics projections"
    described by "Maintains matchmaking analytics data."
  }

} with {
  briefly "Bounded context for matchmaking"
  described by {
    | The MatchContext is the bounded context for player
    | matching, game sessions, and match results.
  }
}
