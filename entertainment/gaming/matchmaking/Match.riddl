// Matchmaking - Match Entity

entity Match is {

  // Commands
  command CreateMatch is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "New match identifier."
    }
    gameMode is GameMode with {
      briefly "Mode"
      described by "Game mode."
    }
    matchType is MatchType with {
      briefly "Type"
      described by "Match type."
    }
    teams is many MatchTeam with {
      briefly "Teams"
      described by "Match teams."
    }
  } with {
    briefly "Create match"
    described by "Creates a new match."
  }

  command AssignServer is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match identifier."
    }
    server is ServerAssignment with {
      briefly "Server"
      described by "Assigned server."
    }
  } with {
    briefly "Assign server"
    described by "Assigns game server to match."
  }

  command ConfirmPlayer is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match identifier."
    }
    playerId is PlayerId with {
      briefly "Player"
      described by "Confirming player."
    }
  } with {
    briefly "Confirm player"
    described by "Records player ready confirmation."
  }

  command StartMatch is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match to start."
    }
  } with {
    briefly "Start match"
    described by "Starts the match."
  }

  command UpdateScore is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match identifier."
    }
    playerId is PlayerId with {
      briefly "Player"
      described by "Scoring player."
    }
    score is Natural with {
      briefly "Score"
      described by "New score."
    }
  } with {
    briefly "Update score"
    described by "Updates player score."
  }

  command EndMatch is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match to end."
    }
    result is MatchResult with {
      briefly "Result"
      described by "Match result."
    }
  } with {
    briefly "End match"
    described by "Ends the match."
  }

  command CancelMatch is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match to cancel."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel match"
    described by "Cancels the match."
  }

  command RemovePlayer is {
    matchId is MatchId with {
      briefly "Match ID"
      described by "Match identifier."
    }
    playerId is PlayerId with {
      briefly "Player"
      described by "Player to remove."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Removal reason."
    }
  } with {
    briefly "Remove player"
    described by "Removes player from match."
  }

  // Events
  event MatchCreated is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    gameMode is GameMode with { briefly "Mode" described by "Game mode." }
    matchType is MatchType with { briefly "Type" described by "Match type." }
    teams is many MatchTeam with { briefly "Teams" described by "Match teams." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Match was created"
    described by "Emitted when match is formed."
  }

  event ServerAssigned is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    server is ServerAssignment with { briefly "Server" described by "Assigned server." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Server was assigned"
    described by "Emitted when server is allocated."
  }

  event PlayerConfirmed is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    playerId is PlayerId with { briefly "Player" described by "Confirmed player." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Player was confirmed"
    described by "Emitted when player confirms ready."
  }

  event MatchStarted is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Match was started"
    described by "Emitted when match begins."
  }

  event ScoreUpdated is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    playerId is PlayerId with { briefly "Player" described by "Player ID." }
    score is Natural with { briefly "Score" described by "New score." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Score was updated"
    described by "Emitted when score changes."
  }

  event MatchEnded is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    result is MatchResult with { briefly "Result" described by "Match result." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Match was ended"
    described by "Emitted when match completes."
  }

  event MatchCancelled is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Match was cancelled"
    described by "Emitted when match is cancelled."
  }

  event PlayerRemoved is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    playerId is PlayerId with { briefly "Player" described by "Removed player." }
    reason is String(1, 200) with { briefly "Reason" described by "Removal reason." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Player was removed"
    described by "Emitted when player leaves."
  }

  // State Records
  record FormingStateData is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    gameMode is GameMode with { briefly "Mode" described by "Game mode." }
    matchType is MatchType with { briefly "Type" described by "Match type." }
    teams is many MatchTeam with { briefly "Teams" described by "Match teams." }
    confirmedPlayers is many PlayerId with { briefly "Confirmed" described by "Confirmed players." }
    pendingServer is optional ServerAssignment with { briefly "Server" described by "Assigned server." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Forming state data"
    described by "State data for forming match."
  }

  record ActiveStateData is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    gameMode is GameMode with { briefly "Mode" described by "Game mode." }
    matchType is MatchType with { briefly "Type" described by "Match type." }
    teams is many MatchTeam with { briefly "Teams" described by "Match teams." }
    server is ServerAssignment with { briefly "Server" described by "Game server." }
    scores is many PlayerStats with { briefly "Scores" described by "Player scores." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Active state data"
    described by "State data for active match."
  }

  record CompletedStateData is {
    matchId is MatchId with { briefly "Match" described by "Match ID." }
    gameMode is GameMode with { briefly "Mode" described by "Game mode." }
    matchType is MatchType with { briefly "Type" described by "Match type." }
    result is MatchResult with { briefly "Result" described by "Match result." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Completed state data"
    described by "State data for completed match."
  }

  // States
  state FormingState of Match.FormingStateData with {
    briefly "Match is forming"
    described by "Match is gathering players."
  }

  state ActiveState of Match.ActiveStateData with {
    briefly "Match is active"
    described by "Match is in progress."
  }

  state CompletedState of Match.CompletedStateData with {
    briefly "Match is completed"
    described by "Match has finished."
  }

  // Handler
  handler MatchHandler is {
    on command CreateMatch {
      morph entity MatchContext.Match to state MatchContext.Match.FormingState with command CreateMatch
      tell event MatchCreated to entity MatchContext.Match
    }

    on command AssignServer {
      tell event ServerAssigned to entity MatchContext.Match
    }

    on command ConfirmPlayer {
      tell event PlayerConfirmed to entity MatchContext.Match
    }

    on command StartMatch {
      morph entity MatchContext.Match to state MatchContext.Match.ActiveState with command StartMatch
      tell event MatchStarted to entity MatchContext.Match
    }

    on command UpdateScore {
      tell event ScoreUpdated to entity MatchContext.Match
    }

    on command EndMatch {
      morph entity MatchContext.Match to state MatchContext.Match.CompletedState with command EndMatch
      tell event MatchEnded to entity MatchContext.Match
    }

    on command CancelMatch {
      tell event MatchCancelled to entity MatchContext.Match
    }

    on command RemovePlayer {
      tell event PlayerRemoved to entity MatchContext.Match
    }
  } with {
    briefly "Processes match commands"
    described by {
      | Handles match lifecycle including formation,
      | gameplay, and completion.
    }
  }

} with {
  briefly "Match aggregate"
  described by {
    | The Match entity manages game matches including
    | team formation, server assignment, and results.
  }
}
