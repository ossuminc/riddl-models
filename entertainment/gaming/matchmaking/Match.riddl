// Matchmaking - Match Entity
entity Match is {
  // Commands
  command CreateMatch is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |New match identifier.
      }
    }
    gameMode: GameMode with {
      briefly "Mode"
      described as {
        |Game mode.
      }
    }
    matchType: MatchType with {
      briefly "Type"
      described as {
        |Match type.
      }
    }
    teams: MatchTeam+ with {
      briefly "Teams"
      described as {
        |Match teams.
      }
    }
  } with {
    briefly "Create match"
    described as {
      |Creates a new match.
    }
  }
  command AssignServer is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match identifier.
      }
    }
    server: ServerAssignment with {
      briefly "Server"
      described as {
        |Assigned server.
      }
    }
  } with {
    briefly "Assign server"
    described as {
      |Assigns game server to match.
    }
  }
  command ConfirmPlayer is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match identifier.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Confirming player.
      }
    }
  } with {
    briefly "Confirm player"
    described as {
      |Records player ready confirmation.
    }
  }
  command StartMatch is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match to start.
      }
    }
  } with {
    briefly "Start match"
    described as {
      |Starts the match.
    }
  }
  command UpdateScore is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match identifier.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Scoring player.
      }
    }
    score: Natural with {
      briefly "Score"
      described as {
        |New score.
      }
    }
  } with {
    briefly "Update score"
    described as {
      |Updates player score.
    }
  }
  command EndMatch is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match to end.
      }
    }
    result: MatchResult with {
      briefly "Result"
      described as {
        |Match result.
      }
    }
  } with {
    briefly "End match"
    described as {
      |Ends the match.
    }
  }
  command CancelMatch is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match to cancel.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel match"
    described as {
      |Cancels the match.
    }
  }
  command RemovePlayer is  {
    matchId: MatchId with {
      briefly "Match ID"
      described as {
        |Match identifier.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Player to remove.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Removal reason.
      }
    }
  } with {
    briefly "Remove player"
    described as {
      |Removes player from match.
    }
  }
  // Events
  event MatchCreated is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    gameMode: GameMode with {
      briefly "Mode"
      described as {
        |Game mode.
      }
    }
    matchType: MatchType with {
      briefly "Type"
      described as {
        |Match type.
      }
    }
    teams: MatchTeam+ with {
      briefly "Teams"
      described as {
        |Match teams.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Match was created"
    described as {
      |Emitted when match is formed.
    }
  }
  event ServerAssigned is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    server: ServerAssignment with {
      briefly "Server"
      described as {
        |Assigned server.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Server was assigned"
    described as {
      |Emitted when server is allocated.
    }
  }
  event PlayerConfirmed is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Confirmed player.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Player was confirmed"
    described as {
      |Emitted when player confirms ready.
    }
  }
  event MatchStarted is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Match was started"
    described as {
      |Emitted when match begins.
    }
  }
  event ScoreUpdated is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Player ID.
      }
    }
    score: Natural with {
      briefly "Score"
      described as {
        |New score.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Score was updated"
    described as {
      |Emitted when score changes.
    }
  }
  event MatchEnded is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    result: MatchResult with {
      briefly "Result"
      described as {
        |Match result.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
  } with {
    briefly "Match was ended"
    described as {
      |Emitted when match completes.
    }
  }
  event MatchCancelled is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Match was cancelled"
    described as {
      |Emitted when match is cancelled.
    }
  }
  event PlayerRemoved is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    playerId: PlayerId with {
      briefly "Player"
      described as {
        |Removed player.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Removal reason.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Player was removed"
    described as {
      |Emitted when player leaves.
    }
  }
  // State Records
  record FormingStateData is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    gameMode: GameMode with {
      briefly "Mode"
      described as {
        |Game mode.
      }
    }
    matchType: MatchType with {
      briefly "Type"
      described as {
        |Match type.
      }
    }
    teams: MatchTeam+ with {
      briefly "Teams"
      described as {
        |Match teams.
      }
    }
    confirmedPlayers: PlayerId+ with {
      briefly "Confirmed"
      described as {
        |Confirmed players.
      }
    }
    pendingServer: ServerAssignment? with {
      briefly "Server"
      described as {
        |Assigned server.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Forming state data"
    described as {
      |State data for forming match.
    }
  }
  record ActiveStateData is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    gameMode: GameMode with {
      briefly "Mode"
      described as {
        |Game mode.
      }
    }
    matchType: MatchType with {
      briefly "Type"
      described as {
        |Match type.
      }
    }
    teams: MatchTeam+ with {
      briefly "Teams"
      described as {
        |Match teams.
      }
    }
    server: ServerAssignment with {
      briefly "Server"
      described as {
        |Game server.
      }
    }
    scores: PlayerStats+ with {
      briefly "Scores"
      described as {
        |Player scores.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active match.
    }
  }
  record CompletedStateData is  {
    matchId: MatchId with {
      briefly "Match"
      described as {
        |Match ID.
      }
    }
    gameMode: GameMode with {
      briefly "Mode"
      described as {
        |Game mode.
      }
    }
    matchType: MatchType with {
      briefly "Type"
      described as {
        |Match type.
      }
    }
    result: MatchResult with {
      briefly "Result"
      described as {
        |Match result.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |State data for completed match.
    }
  }
  // States
  state FormingState of type Match.FormingStateData
  state ActiveState of type Match.ActiveStateData
  state CompletedState of type Match.CompletedStateData
  // Handler
  handler MatchHandler is {
    on command CreateMatch is {
      morph entity MatchContext.Match to state MatchContext.Match.FormingState with command CreateMatch
      tell event MatchCreated to entity MatchContext.Match
    }
    on command AssignServer is {
      tell event ServerAssigned to entity MatchContext.Match
    }
    on command ConfirmPlayer is {
      tell event PlayerConfirmed to entity MatchContext.Match
    }
    on command StartMatch is {
      morph entity MatchContext.Match to state MatchContext.Match.ActiveState with command StartMatch
      tell event MatchStarted to entity MatchContext.Match
    }
    on command UpdateScore is {
      tell event ScoreUpdated to entity MatchContext.Match
    }
    on command EndMatch is {
      morph entity MatchContext.Match to state MatchContext.Match.CompletedState with command EndMatch
      tell event MatchEnded to entity MatchContext.Match
    }
    on command CancelMatch is {
      tell event MatchCancelled to entity MatchContext.Match
    }
    on command RemovePlayer is {
      tell event PlayerRemoved to entity MatchContext.Match
    }
  } with {
    briefly "Processes match commands"
    described as {
      | Handles match lifecycle including formation,
      | gameplay, and completion.
    }
  }
} with {
  briefly "Match aggregate"
  described as {
    | The Match entity manages game matches including
    | team formation, server assignment, and results.
  }
}
