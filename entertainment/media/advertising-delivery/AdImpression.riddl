// Advertising Delivery - AdImpression Entity
entity AdImpression is {
  // Commands
  command RecordImpression is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |New impression identifier.
      }
    }
    adUnit: AdUnit with {
      briefly "Ad unit"
      described as {
        |Served advertisement.
      }
    }
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
  } with {
    briefly "Record impression"
    described as {
      |Records an ad impression.
    }
  }
  command RecordStart is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
  } with {
    briefly "Record start"
    described as {
      |Records ad playback start.
    }
  }
  command RecordQuartile is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
    quartile: Natural with {
      briefly "Quartile"
      described as {
        |Quartile reached (1-4).
      }
    }
  } with {
    briefly "Record quartile"
    described as {
      |Records quartile progress.
    }
  }
  command RecordComplete is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
    metrics: ImpressionMetrics with {
      briefly "Metrics"
      described as {
        |Final metrics.
      }
    }
  } with {
    briefly "Record complete"
    described as {
      |Records ad completion.
    }
  }
  command RecordSkip is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
    skipTime: Duration with {
      briefly "Skip time"
      described as {
        |Time when skipped.
      }
    }
  } with {
    briefly "Record skip"
    described as {
      |Records ad skip event.
    }
  }
  command RecordClick is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
    clickTime: Duration with {
      briefly "Click time"
      described as {
        |Time of click.
      }
    }
  } with {
    briefly "Record click"
    described as {
      |Records ad click event.
    }
  }
  command RecordError is  {
    impressionId: ImpressionId with {
      briefly "Impression ID"
      described as {
        |Impression identifier.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error code"
      described as {
        |Error identifier.
      }
    }
    errorMessage: String(1,500) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
  } with {
    briefly "Record error"
    described as {
      |Records ad delivery error.
    }
  }
  // Events
  event ImpressionRecorded is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    adUnit: AdUnit with {
      briefly "Ad unit"
      described as {
        |Served ad.
      }
    }
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Impression was recorded"
    described as {
      |Emitted when ad is served.
    }
  }
  event AdStarted is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Ad was started"
    described as {
      |Emitted when ad begins playing.
    }
  }
  event QuartileReached is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    quartile: Natural with {
      briefly "Quartile"
      described as {
        |Quartile number.
      }
    }
    reachedAt: TimeStamp with {
      briefly "Reached"
      described as {
        |Reach time.
      }
    }
  } with {
    briefly "Quartile was reached"
    described as {
      |Emitted at each quartile.
    }
  }
  event AdCompleted is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    metrics: ImpressionMetrics with {
      briefly "Metrics"
      described as {
        |View metrics.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Ad was completed"
    described as {
      |Emitted when ad finishes.
    }
  }
  event AdSkipped is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    skipTime: Duration with {
      briefly "Skip time"
      described as {
        |Skip position.
      }
    }
    skippedAt: TimeStamp with {
      briefly "Skipped"
      described as {
        |Skip time.
      }
    }
  } with {
    briefly "Ad was skipped"
    described as {
      |Emitted when viewer skips.
    }
  }
  event AdClicked is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    clickTime: Duration with {
      briefly "Click time"
      described as {
        |Click position.
      }
    }
    clickedAt: TimeStamp with {
      briefly "Clicked"
      described as {
        |Click time.
      }
    }
  } with {
    briefly "Ad was clicked"
    described as {
      |Emitted when viewer clicks.
    }
  }
  event AdErrorOccurred is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error code"
      described as {
        |Error code.
      }
    }
    errorMessage: String(1,500) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
    occurredAt: TimeStamp with {
      briefly "Occurred"
      described as {
        |Error time.
      }
    }
  } with {
    briefly "Ad error occurred"
    described as {
      |Emitted when error happens.
    }
  }
  // State Records
  record ServedStateData is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    adUnit: AdUnit with {
      briefly "Ad unit"
      described as {
        |Served ad.
      }
    }
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
    status: AdStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    servedAt: TimeStamp with {
      briefly "Served"
      described as {
        |Serve time.
      }
    }
  } with {
    briefly "Served state data"
    described as {
      |State data for served impression.
    }
  }
  record ActiveStateData is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    adUnit: AdUnit with {
      briefly "Ad unit"
      described as {
        |Served ad.
      }
    }
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
    status: AdStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    currentQuartile: Natural with {
      briefly "Quartile"
      described as {
        |Current quartile.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for playing ad.
    }
  }
  record CompletedStateData is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    adUnit: AdUnit with {
      briefly "Ad unit"
      described as {
        |Served ad.
      }
    }
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    status: AdStatus with {
      briefly "Status"
      described as {
        |Final status.
      }
    }
    metrics: ImpressionMetrics with {
      briefly "Metrics"
      described as {
        |View metrics.
      }
    }
    clicked: Boolean with {
      briefly "Clicked"
      described as {
        |Was clicked.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |State data for finished impression.
    }
  }
  // States
  state ServedState of type AdImpression.ServedStateData
  state ActiveState of type AdImpression.ActiveStateData
  state CompletedState of type AdImpression.CompletedStateData
  // Handler
  handler AdImpressionHandler is {
    on command RecordImpression is {
      morph entity AdContext.AdImpression to state AdContext.AdImpression.ServedState with command RecordImpression
      tell event ImpressionRecorded to entity AdContext.AdImpression
    }
    on command RecordStart is {
      morph entity AdContext.AdImpression to state AdContext.AdImpression.ActiveState with command RecordStart
      tell event AdStarted to entity AdContext.AdImpression
    }
    on command RecordQuartile is {
      tell event QuartileReached to entity AdContext.AdImpression
    }
    on command RecordComplete is {
      morph entity AdContext.AdImpression to state AdContext.AdImpression.CompletedState with command RecordComplete
      tell event AdCompleted to entity AdContext.AdImpression
    }
    on command RecordSkip is {
      morph entity AdContext.AdImpression to state AdContext.AdImpression.CompletedState with command RecordSkip
      tell event AdSkipped to entity AdContext.AdImpression
    }
    on command RecordClick is {
      tell event AdClicked to entity AdContext.AdImpression
    }
    on command RecordError is {
      tell event AdErrorOccurred to entity AdContext.AdImpression
    }
  } with {
    briefly "Processes impression commands"
    described as {
      | Handles ad impression lifecycle including
      | serving, viewing, and engagement tracking.
    }
  }
} with {
  briefly "Ad impression aggregate"
  described as {
    | The AdImpression entity manages ad delivery tracking
    | including impressions, views, and engagement.
  }
}
