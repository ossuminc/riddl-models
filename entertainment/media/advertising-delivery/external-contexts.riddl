// Advertising Delivery - External Contexts
// Ad Decision Service
context AdDecisionService is {
  query RequestAd is  {
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
  } with {
    briefly "Request ad"
    described as {
      |Requests ad decision.
    }
  }
  result AdDecision is  {
    selectedAdUnit: AdUnit? with {
      briefly "Ad unit"
      described as {
        |Selected ad.
      }
    }
    noFill: Boolean with {
      briefly "No fill"
      described as {
        |No ad available.
      }
    }
  } with {
    briefly "Ad decision"
    described as {
      |Ad selection result.
    }
  }
} with {
  option external()
  briefly "External ad decision service"
  described as {
    |External ad selection engine.
  }
}
// RTB Exchange
context RTBExchange is {
  command SendBidRequest is  {
    placement: AdPlacement with {
      briefly "Placement"
      described as {
        |Ad placement.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
    timeout: Duration with {
      briefly "Timeout"
      described as {
        |Bid timeout.
      }
    }
  } with {
    briefly "Send bid request"
    described as {
      |Sends RTB bid request.
    }
  }
  event BidResponseReceived is  {
    bids: BidResponse+ with {
      briefly "Bids"
      described as {
        |Bid responses.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Bid response received"
    described as {
      |Emitted when bids arrive.
    }
  }
} with {
  option external()
  briefly "External RTB exchange"
  described as {
    |Real-time bidding exchange.
  }
}
// Campaign Management Service
context CampaignService is {
  query GetCampaign is  {
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
  } with {
    briefly "Get campaign"
    described as {
      |Retrieves campaign details.
    }
  }
  event CampaignUpdated is  {
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Campaign was updated"
    described as {
      |Emitted when campaign changes.
    }
  }
} with {
  option external()
  briefly "External campaign service"
  described as {
    |External campaign management.
  }
}
// Targeting Service
context TargetingService is {
  query EvaluateTargeting is  {
    criteria: TargetingCriteria+ with {
      briefly "Criteria"
      described as {
        |Targeting rules.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
  } with {
    briefly "Evaluate targeting"
    described as {
      |Checks if viewer matches targeting.
    }
  }
  result TargetingResult is  {
    matches: Boolean with {
      briefly "Matches"
      described as {
        |Targeting matched.
      }
    }
    score: Decimal(5,4) with {
      briefly "Score"
      described as {
        |Match score.
      }
    }
  } with {
    briefly "Targeting result"
    described as {
      |Targeting evaluation result.
    }
  }
} with {
  option external()
  briefly "External targeting service"
  described as {
    |External audience targeting.
  }
}
// Billing Service
context BillingService is {
  command RecordBillableEvent is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    eventType: String(1,50) with {
      briefly "Event"
      described as {
        |Billable event type.
      }
    }
    amount: Decimal(10,6) with {
      briefly "Amount"
      described as {
        |Billing amount.
      }
    }
  } with {
    briefly "Record billable event"
    described as {
      |Records billing event.
    }
  }
  event BillableEventRecorded is  {
    eventId: UUID with {
      briefly "Event"
      described as {
        |Event ID.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Billable event recorded"
    described as {
      |Emitted when billing is recorded.
    }
  }
} with {
  option external()
  briefly "External billing service"
  described as {
    |External ad billing system.
  }
}
// Fraud Detection Service
context FraudDetectionService is {
  command CheckImpression is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    viewer: ViewerContext with {
      briefly "Viewer"
      described as {
        |Viewer context.
      }
    }
  } with {
    briefly "Check impression"
    described as {
      |Validates impression authenticity.
    }
  }
  event ImpressionValidated is  {
    impressionId: ImpressionId with {
      briefly "Impression"
      described as {
        |Impression ID.
      }
    }
    valid: Boolean with {
      briefly "Valid"
      described as {
        |Is valid.
      }
    }
    riskScore: Decimal(5,4) with {
      briefly "Risk"
      described as {
        |Risk score.
      }
    }
  } with {
    briefly "Impression was validated"
    described as {
      |Emitted when validation completes.
    }
  }
} with {
  option external()
  briefly "External fraud detection"
  described as {
    |External ad fraud prevention.
  }
}
