// Streaming Platform - Stream Entity
entity Stream is {
  // Commands
  command StartStream is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |New stream identifier.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Viewing subscriber.
      }
    }
    profileId: ProfileId with {
      briefly "Profile"
      described as {
        |Viewer profile.
      }
    }
    content: StreamingContent with {
      briefly "Content"
      described as {
        |Content to stream.
      }
    }
    device: PlaybackDevice with {
      briefly "Device"
      described as {
        |Playback device.
      }
    }
    quality: StreamQuality with {
      briefly "Quality"
      described as {
        |Requested quality.
      }
    }
  } with {
    briefly "Start stream"
    described as {
      |Initiates a streaming session.
    }
  }
  command PauseStream is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream to pause.
      }
    }
    position: Duration with {
      briefly "Position"
      described as {
        |Current position.
      }
    }
  } with {
    briefly "Pause stream"
    described as {
      |Pauses playback.
    }
  }
  command ResumeStream is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream to resume.
      }
    }
  } with {
    briefly "Resume stream"
    described as {
      |Resumes playback.
    }
  }
  command SeekPosition is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream identifier.
      }
    }
    position: Duration with {
      briefly "Position"
      described as {
        |Target position.
      }
    }
  } with {
    briefly "Seek position"
    described as {
      |Jumps to position.
    }
  }
  command ChangeQuality is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream identifier.
      }
    }
    quality: StreamQuality with {
      briefly "Quality"
      described as {
        |New quality level.
      }
    }
  } with {
    briefly "Change quality"
    described as {
      |Adjusts stream quality.
    }
  }
  command ReportMetrics is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream identifier.
      }
    }
    metrics: StreamMetrics with {
      briefly "Metrics"
      described as {
        |Playback metrics.
      }
    }
  } with {
    briefly "Report metrics"
    described as {
      |Reports playback quality.
    }
  }
  command EndStream is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream to end.
      }
    }
    finalPosition: Duration with {
      briefly "Position"
      described as {
        |Final position.
      }
    }
    reason: String(1,100) with {
      briefly "Reason"
      described as {
        |End reason.
      }
    }
  } with {
    briefly "End stream"
    described as {
      |Ends streaming session.
    }
  }
  command ReportError is  {
    streamId: StreamId with {
      briefly "Stream ID"
      described as {
        |Stream identifier.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error code"
      described as {
        |Error identifier.
      }
    }
    errorMessage: String(1,500) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
  } with {
    briefly "Report error"
    described as {
      |Reports playback error.
    }
  }
  // Events
  event StreamStarted is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    content: StreamingContent with {
      briefly "Content"
      described as {
        |Stream content.
      }
    }
    device: PlaybackDevice with {
      briefly "Device"
      described as {
        |Playback device.
      }
    }
    quality: StreamQuality with {
      briefly "Quality"
      described as {
        |Stream quality.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Stream was started"
    described as {
      |Emitted when streaming begins.
    }
  }
  event StreamPaused is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    position: Duration with {
      briefly "Position"
      described as {
        |Pause position.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Stream was paused"
    described as {
      |Emitted when playback pauses.
    }
  }
  event StreamResumed is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Stream was resumed"
    described as {
      |Emitted when playback resumes.
    }
  }
  event PositionSeeked is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    fromPosition: Duration with {
      briefly "From"
      described as {
        |Previous position.
      }
    }
    toPosition: Duration with {
      briefly "To"
      described as {
        |New position.
      }
    }
    seekedAt: TimeStamp with {
      briefly "Seeked"
      described as {
        |Seek time.
      }
    }
  } with {
    briefly "Position was seeked"
    described as {
      |Emitted when seeking occurs.
    }
  }
  event QualityChanged is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    fromQuality: StreamQuality with {
      briefly "From"
      described as {
        |Previous quality.
      }
    }
    toQuality: StreamQuality with {
      briefly "To"
      described as {
        |New quality.
      }
    }
    changedAt: TimeStamp with {
      briefly "Changed"
      described as {
        |Change time.
      }
    }
  } with {
    briefly "Quality was changed"
    described as {
      |Emitted when quality changes.
    }
  }
  event MetricsReported is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    metrics: StreamMetrics with {
      briefly "Metrics"
      described as {
        |Playback metrics.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported"
      described as {
        |Report time.
      }
    }
  } with {
    briefly "Metrics were reported"
    described as {
      |Emitted when metrics are logged.
    }
  }
  event StreamEnded is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    finalPosition: Duration with {
      briefly "Position"
      described as {
        |Final position.
      }
    }
    watchTime: Duration with {
      briefly "Watch time"
      described as {
        |Total watch time.
      }
    }
    reason: String(1,100) with {
      briefly "Reason"
      described as {
        |End reason.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
  } with {
    briefly "Stream was ended"
    described as {
      |Emitted when streaming ends.
    }
  }
  event StreamErrorOccurred is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error code"
      described as {
        |Error code.
      }
    }
    errorMessage: String(1,500) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
    occurredAt: TimeStamp with {
      briefly "Occurred"
      described as {
        |Error time.
      }
    }
  } with {
    briefly "Stream error occurred"
    described as {
      |Emitted when error happens.
    }
  }
  // State Records
  record ActiveStateData is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    profileId: ProfileId with {
      briefly "Profile"
      described as {
        |Profile ID.
      }
    }
    content: StreamingContent with {
      briefly "Content"
      described as {
        |Stream content.
      }
    }
    device: PlaybackDevice with {
      briefly "Device"
      described as {
        |Playback device.
      }
    }
    status: StreamStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    quality: StreamQuality with {
      briefly "Quality"
      described as {
        |Current quality.
      }
    }
    position: Duration with {
      briefly "Position"
      described as {
        |Current position.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    lastActivityAt: TimeStamp with {
      briefly "Activity"
      described as {
        |Last activity.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active stream.
    }
  }
  record EndedStateData is  {
    streamId: StreamId with {
      briefly "Stream"
      described as {
        |Stream ID.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    content: StreamingContent with {
      briefly "Content"
      described as {
        |Stream content.
      }
    }
    finalPosition: Duration with {
      briefly "Position"
      described as {
        |Final position.
      }
    }
    watchTime: Duration with {
      briefly "Watch time"
      described as {
        |Total watch time.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
  } with {
    briefly "Ended state data"
    described as {
      |State data for ended stream.
    }
  }
  // States
  state ActiveState of type Stream.ActiveStateData
  state EndedState of type Stream.EndedStateData
  // Handler
  handler StreamHandler is {
    on command StartStream is {
      morph entity StreamContext.Stream to state StreamContext.Stream.ActiveState with command StartStream
      tell event StreamStarted to entity StreamContext.Stream
    }
    on command PauseStream is {
      tell event StreamPaused to entity StreamContext.Stream
    }
    on command ResumeStream is {
      tell event StreamResumed to entity StreamContext.Stream
    }
    on command SeekPosition is {
      tell event PositionSeeked to entity StreamContext.Stream
    }
    on command ChangeQuality is {
      tell event QualityChanged to entity StreamContext.Stream
    }
    on command ReportMetrics is {
      tell event MetricsReported to entity StreamContext.Stream
    }
    on command EndStream is {
      morph entity StreamContext.Stream to state StreamContext.Stream.EndedState with command EndStream
      tell event StreamEnded to entity StreamContext.Stream
    }
    on command ReportError is {
      tell event StreamErrorOccurred to entity StreamContext.Stream
    }
  } with {
    briefly "Processes stream commands"
    described as {
      | Handles streaming session lifecycle including
      | playback control, quality, and metrics.
    }
  }
} with {
  briefly "Stream aggregate"
  described as {
    | The Stream entity manages video/audio streaming sessions
    | including playback control and quality adaptation.
  }
}
