// Streaming Platform - Stream Entity

entity Stream is {

  // Commands
  command StartStream is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "New stream identifier."
    }
    subscriberId is SubscriberId with {
      briefly "Subscriber"
      described by "Viewing subscriber."
    }
    profileId is ProfileId with {
      briefly "Profile"
      described by "Viewer profile."
    }
    content is StreamingContent with {
      briefly "Content"
      described by "Content to stream."
    }
    device is PlaybackDevice with {
      briefly "Device"
      described by "Playback device."
    }
    quality is StreamQuality with {
      briefly "Quality"
      described by "Requested quality."
    }
  } with {
    briefly "Start stream"
    described by "Initiates a streaming session."
  }

  command PauseStream is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream to pause."
    }
    position is Duration with {
      briefly "Position"
      described by "Current position."
    }
  } with {
    briefly "Pause stream"
    described by "Pauses playback."
  }

  command ResumeStream is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream to resume."
    }
  } with {
    briefly "Resume stream"
    described by "Resumes playback."
  }

  command SeekPosition is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream identifier."
    }
    position is Duration with {
      briefly "Position"
      described by "Target position."
    }
  } with {
    briefly "Seek position"
    described by "Jumps to position."
  }

  command ChangeQuality is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream identifier."
    }
    quality is StreamQuality with {
      briefly "Quality"
      described by "New quality level."
    }
  } with {
    briefly "Change quality"
    described by "Adjusts stream quality."
  }

  command ReportMetrics is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream identifier."
    }
    metrics is StreamMetrics with {
      briefly "Metrics"
      described by "Playback metrics."
    }
  } with {
    briefly "Report metrics"
    described by "Reports playback quality."
  }

  command EndStream is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream to end."
    }
    finalPosition is Duration with {
      briefly "Position"
      described by "Final position."
    }
    reason is String(1, 100) with {
      briefly "Reason"
      described by "End reason."
    }
  } with {
    briefly "End stream"
    described by "Ends streaming session."
  }

  command ReportError is {
    streamId is StreamId with {
      briefly "Stream ID"
      described by "Stream identifier."
    }
    errorCode is String(1, 50) with {
      briefly "Error code"
      described by "Error identifier."
    }
    errorMessage is String(1, 500) with {
      briefly "Message"
      described by "Error message."
    }
  } with {
    briefly "Report error"
    described by "Reports playback error."
  }

  // Events
  event StreamStarted is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    content is StreamingContent with { briefly "Content" described by "Stream content." }
    device is PlaybackDevice with { briefly "Device" described by "Playback device." }
    quality is StreamQuality with { briefly "Quality" described by "Stream quality." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Stream was started"
    described by "Emitted when streaming begins."
  }

  event StreamPaused is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    position is Duration with { briefly "Position" described by "Pause position." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Stream was paused"
    described by "Emitted when playback pauses."
  }

  event StreamResumed is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Stream was resumed"
    described by "Emitted when playback resumes."
  }

  event PositionSeeked is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    fromPosition is Duration with { briefly "From" described by "Previous position." }
    toPosition is Duration with { briefly "To" described by "New position." }
    seekedAt is TimeStamp with { briefly "Seeked" described by "Seek time." }
  } with {
    briefly "Position was seeked"
    described by "Emitted when seeking occurs."
  }

  event QualityChanged is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    fromQuality is StreamQuality with { briefly "From" described by "Previous quality." }
    toQuality is StreamQuality with { briefly "To" described by "New quality." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Quality was changed"
    described by "Emitted when quality changes."
  }

  event MetricsReported is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    metrics is StreamMetrics with { briefly "Metrics" described by "Playback metrics." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Metrics were reported"
    described by "Emitted when metrics are logged."
  }

  event StreamEnded is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    finalPosition is Duration with { briefly "Position" described by "Final position." }
    watchTime is Duration with { briefly "Watch time" described by "Total watch time." }
    reason is String(1, 100) with { briefly "Reason" described by "End reason." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Stream was ended"
    described by "Emitted when streaming ends."
  }

  event StreamErrorOccurred is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    errorCode is String(1, 50) with { briefly "Error code" described by "Error code." }
    errorMessage is String(1, 500) with { briefly "Message" described by "Error message." }
    occurredAt is TimeStamp with { briefly "Occurred" described by "Error time." }
  } with {
    briefly "Stream error occurred"
    described by "Emitted when error happens."
  }

  // State Records
  record ActiveStateData is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    profileId is ProfileId with { briefly "Profile" described by "Profile ID." }
    content is StreamingContent with { briefly "Content" described by "Stream content." }
    device is PlaybackDevice with { briefly "Device" described by "Playback device." }
    status is StreamStatus with { briefly "Status" described by "Current status." }
    quality is StreamQuality with { briefly "Quality" described by "Current quality." }
    position is Duration with { briefly "Position" described by "Current position." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    lastActivityAt is TimeStamp with { briefly "Activity" described by "Last activity." }
  } with {
    briefly "Active state data"
    described by "State data for active stream."
  }

  record EndedStateData is {
    streamId is StreamId with { briefly "Stream" described by "Stream ID." }
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    content is StreamingContent with { briefly "Content" described by "Stream content." }
    finalPosition is Duration with { briefly "Position" described by "Final position." }
    watchTime is Duration with { briefly "Watch time" described by "Total watch time." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Ended state data"
    described by "State data for ended stream."
  }

  // States
  state ActiveState of Stream.ActiveStateData with {
    briefly "Stream is active"
    described by "Stream is in progress."
  }

  state EndedState of Stream.EndedStateData with {
    briefly "Stream is ended"
    described by "Stream has completed."
  }

  // Handler
  handler StreamHandler is {
    on command StartStream {
      morph entity StreamContext.Stream to state StreamContext.Stream.ActiveState with command StartStream
      tell event StreamStarted to entity StreamContext.Stream
    }

    on command PauseStream {
      tell event StreamPaused to entity StreamContext.Stream
    }

    on command ResumeStream {
      tell event StreamResumed to entity StreamContext.Stream
    }

    on command SeekPosition {
      tell event PositionSeeked to entity StreamContext.Stream
    }

    on command ChangeQuality {
      tell event QualityChanged to entity StreamContext.Stream
    }

    on command ReportMetrics {
      tell event MetricsReported to entity StreamContext.Stream
    }

    on command EndStream {
      morph entity StreamContext.Stream to state StreamContext.Stream.EndedState with command EndStream
      tell event StreamEnded to entity StreamContext.Stream
    }

    on command ReportError {
      tell event StreamErrorOccurred to entity StreamContext.Stream
    }
  } with {
    briefly "Processes stream commands"
    described by {
      | Handles streaming session lifecycle including
      | playback control, quality, and metrics.
    }
  }

} with {
  briefly "Stream aggregate"
  described by {
    | The Stream entity manages video/audio streaming sessions
    | including playback control and quality adaptation.
  }
}
