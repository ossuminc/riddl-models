// Production Management - Production Entity

entity Production is {

  command CreateProduction is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "New production identifier."
    }
    productionInfo is ProductionInfo with {
      briefly "Production info"
      described by "Production details."
    }
    stageSetup is StageSetup with {
      briefly "Stage setup"
      described by "Stage configuration."
    }
  } with {
    briefly "Create production"
    described by "Creates a new production."
  }

  command AssignCrew is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    assignment is CrewAssignment with {
      briefly "Assignment"
      described by "Crew assignment details."
    }
  } with {
    briefly "Assign crew"
    described by "Assigns a crew member to the production."
  }

  command AllocateEquipment is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    allocation is EquipmentAllocation with {
      briefly "Allocation"
      described by "Equipment allocation details."
    }
  } with {
    briefly "Allocate equipment"
    described by "Allocates technical equipment to the production."
  }

  command ScheduleRehearsal is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    rehearsal is RehearsalSchedule with {
      briefly "Rehearsal"
      described by "Rehearsal schedule details."
    }
  } with {
    briefly "Schedule rehearsal"
    described by "Schedules a rehearsal session."
  }

  command CompleteRehearsal is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    rehearsalId is RehearsalId with {
      briefly "Rehearsal ID"
      described by "Rehearsal identifier."
    }
    notes is optional String(3, 1000) with {
      briefly "Notes"
      described by "Post-rehearsal notes."
    }
  } with {
    briefly "Complete rehearsal"
    described by "Marks a rehearsal as completed."
  }

  command BeginLoadIn is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    loadInTime is TimeStamp with {
      briefly "Load-in time"
      described by "Actual load-in start time."
    }
  } with {
    briefly "Begin load-in"
    described by "Begins equipment load-in at the venue."
  }

  command AddCueSheet is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    cues is many CueEntry with {
      briefly "Cues"
      described by "Show cue entries."
    }
  } with {
    briefly "Add cue sheet"
    described by "Adds the show cue sheet."
  }

  command StartShow is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started"
      described by "Show start time."
    }
  } with {
    briefly "Start show"
    described by "Starts the live show."
  }

  command CompleteShow is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Show completion time."
    }
    actualAttendance is Natural with {
      briefly "Attendance"
      described by "Actual audience attendance."
    }
  } with {
    briefly "Complete show"
    described by "Marks the show as completed."
  }

  command CancelProduction is {
    productionId is ProductionId with {
      briefly "Production ID"
      described by "Production identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel production"
    described by "Cancels the production."
  }

  // Events
  event ProductionCreated is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    productionInfo is ProductionInfo with { briefly "Info" described by "Production info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Production created"
    described by "Emitted when a production is created."
  }

  event CrewAssigned is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    assignment is CrewAssignment with { briefly "Assignment" described by "Crew assignment." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Crew assigned"
    described by "Emitted when crew is assigned."
  }

  event EquipmentAllocated is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    allocation is EquipmentAllocation with { briefly "Allocation" described by "Equipment allocation." }
    allocatedAt is TimeStamp with { briefly "Allocated" described by "Allocation time." }
  } with {
    briefly "Equipment allocated"
    described by "Emitted when equipment is allocated."
  }

  event RehearsalScheduled is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    rehearsal is RehearsalSchedule with { briefly "Rehearsal" described by "Rehearsal details." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Scheduling time." }
  } with {
    briefly "Rehearsal scheduled"
    described by "Emitted when a rehearsal is scheduled."
  }

  event RehearsalCompleted is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    rehearsalId is RehearsalId with { briefly "Rehearsal" described by "Rehearsal ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Rehearsal completed"
    described by "Emitted when a rehearsal is completed."
  }

  event LoadInStarted is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Load-in start time." }
  } with {
    briefly "Load-in started"
    described by "Emitted when load-in begins."
  }

  event CueSheetAdded is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    cueCount is Natural with { briefly "Cue count" described by "Number of cues." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Cue sheet added"
    described by "Emitted when cue sheet is added."
  }

  event ShowStarted is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Show start time." }
  } with {
    briefly "Show started"
    described by "Emitted when the show starts."
  }

  event ShowCompleted is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    actualAttendance is Natural with { briefly "Attendance" described by "Actual attendance." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Show completed"
    described by "Emitted when the show is completed."
  }

  event ProductionCancelled is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Production cancelled"
    described by "Emitted when production is cancelled."
  }

  // States
  record ActiveStateData is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    productionInfo is ProductionInfo with { briefly "Info" described by "Production info." }
    stageSetup is StageSetup with { briefly "Stage" described by "Stage setup." }
    status is ProductionStatus with { briefly "Status" described by "Production status." }
    crewAssignments is many optional CrewAssignment with { briefly "Crew" described by "Crew assignments." }
    equipmentAllocations is many optional EquipmentAllocation with { briefly "Equipment" described by "Equipment allocations." }
    rehearsals is many optional RehearsalSchedule with { briefly "Rehearsals" described by "Rehearsal schedules." }
    cueSheet is many optional CueEntry with { briefly "Cues" described by "Show cue sheet." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active production state"
    described by "State for an active production."
  }

  record CompletedStateData is {
    productionId is ProductionId with { briefly "Production" described by "Production ID." }
    productionInfo is ProductionInfo with { briefly "Info" described by "Production info." }
    actualAttendance is Natural with { briefly "Attendance" described by "Actual attendance." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed production state"
    described by "State for a completed production."
  }

  state ActiveState of Production.ActiveStateData with {
    briefly "Production active"
    described by "Production is being planned or executed."
  }

  state CompletedState of Production.CompletedStateData with {
    briefly "Production completed"
    described by "Production has been completed."
  }

  handler ProductionHandler is {
    on command CreateProduction {
      morph entity ProductionContext.Production to state ProductionContext.Production.ActiveState with command CreateProduction
      tell event ProductionCreated to entity ProductionContext.Production
    }
    on command AssignCrew {
      tell event CrewAssigned to entity ProductionContext.Production
    }
    on command AllocateEquipment {
      tell event EquipmentAllocated to entity ProductionContext.Production
    }
    on command ScheduleRehearsal {
      tell event RehearsalScheduled to entity ProductionContext.Production
    }
    on command CompleteRehearsal {
      tell event RehearsalCompleted to entity ProductionContext.Production
    }
    on command BeginLoadIn {
      tell event LoadInStarted to entity ProductionContext.Production
    }
    on command AddCueSheet {
      tell event CueSheetAdded to entity ProductionContext.Production
    }
    on command StartShow {
      tell event ShowStarted to entity ProductionContext.Production
    }
    on command CompleteShow {
      morph entity ProductionContext.Production to state ProductionContext.Production.CompletedState with command CompleteShow
      tell event ShowCompleted to entity ProductionContext.Production
    }
    on command CancelProduction {
      tell event ProductionCancelled to entity ProductionContext.Production
    }
  } with {
    briefly "Processes production commands"
    described by "Handles production lifecycle."
  }

} with {
  briefly "Production aggregate"
  described by "Manages live event productions."
}
