// Event Ticketing - Ticket Entity
entity Ticket is {
  command CreateTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |New ticket identifier.
      }
    }
    eventInfo: EventInfo with {
      briefly "Event info"
      described as {
        |Event details.
      }
    }
    seatInfo: SeatInfo with {
      briefly "Seat info"
      described as {
        |Seat assignment.
      }
    }
    pricingInfo: PricingInfo with {
      briefly "Pricing"
      described as {
        |Ticket pricing.
      }
    }
  } with {
    briefly "Create ticket"
    described as {
      |Creates a new ticket for an event.
    }
  }
  command ReserveTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    buyerInfo: BuyerInfo with {
      briefly "Buyer"
      described as {
        |Buyer information.
      }
    }
    reservedUntil: TimeStamp with {
      briefly "Reserved until"
      described as {
        |Reservation expiration time.
      }
    }
  } with {
    briefly "Reserve ticket"
    described as {
      |Reserves a ticket for a buyer temporarily.
    }
  }
  command PurchaseTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    buyerInfo: BuyerInfo with {
      briefly "Buyer"
      described as {
        |Buyer information.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Payment transaction ID.
      }
    }
    deliveryMethod: DeliveryMethod with {
      briefly "Delivery"
      described as {
        |Chosen delivery method.
      }
    }
  } with {
    briefly "Purchase ticket"
    described as {
      |Completes ticket purchase with payment.
    }
  }
  command DeliverTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    digitalTicket: DigitalTicketInfo with {
      briefly "Digital ticket"
      described as {
        |Digital ticket delivery info.
      }
    }
  } with {
    briefly "Deliver ticket"
    described as {
      |Delivers digital ticket to buyer.
    }
  }
  command ValidateTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    validation: ValidationRecord with {
      briefly "Validation"
      described as {
        |Validation details.
      }
    }
  } with {
    briefly "Validate ticket"
    described as {
      |Validates ticket at event entry.
    }
  }
  command RefundTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Refund details.
      }
    }
  } with {
    briefly "Refund ticket"
    described as {
      |Processes a ticket refund.
    }
  }
  command CancelTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    cancellationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel ticket"
    described as {
      |Cancels a ticket.
    }
  }
  command ExpireReservation is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
  } with {
    briefly "Expire reservation"
    described as {
      |Expires an unpurchased ticket reservation.
    }
  }
  // Events
  event TicketCreated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    eventInfo: EventInfo with {
      briefly "Event"
      described as {
        |Event info.
      }
    }
    seatInfo: SeatInfo with {
      briefly "Seat"
      described as {
        |Seat info.
      }
    }
    pricingInfo: PricingInfo with {
      briefly "Pricing"
      described as {
        |Pricing info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Ticket created"
    described as {
      |Emitted when a new ticket is created.
    }
  }
  event TicketReserved is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    buyerInfo: BuyerInfo with {
      briefly "Buyer"
      described as {
        |Buyer info.
      }
    }
    reservedUntil: TimeStamp with {
      briefly "Until"
      described as {
        |Reservation expiry.
      }
    }
    reservedAt: TimeStamp with {
      briefly "Reserved"
      described as {
        |Reservation time.
      }
    }
  } with {
    briefly "Ticket reserved"
    described as {
      |Emitted when a ticket is reserved.
    }
  }
  event TicketPurchased is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    buyerInfo: BuyerInfo with {
      briefly "Buyer"
      described as {
        |Buyer info.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    purchasedAt: TimeStamp with {
      briefly "Purchased"
      described as {
        |Purchase time.
      }
    }
  } with {
    briefly "Ticket purchased"
    described as {
      |Emitted when a ticket is purchased.
    }
  }
  event TicketDelivered is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    digitalTicket: DigitalTicketInfo with {
      briefly "Ticket"
      described as {
        |Digital ticket.
      }
    }
    ticketDeliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Ticket delivered"
    described as {
      |Emitted when digital ticket is delivered.
    }
  }
  event TicketValidated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    validation: ValidationRecord with {
      briefly "Validation"
      described as {
        |Validation record.
      }
    }
  } with {
    briefly "Ticket validated"
    described as {
      |Emitted when ticket is validated at entry.
    }
  }
  event TicketRefunded is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Refund details.
      }
    }
    refundedAt: TimeStamp with {
      briefly "Refunded"
      described as {
        |Refund time.
      }
    }
  } with {
    briefly "Ticket refunded"
    described as {
      |Emitted when ticket is refunded.
    }
  }
  event TicketCancelled is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    cancellationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Ticket cancelled"
    described as {
      |Emitted when ticket is cancelled.
    }
  }
  event ReservationExpired is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    expiredAt: TimeStamp with {
      briefly "Expired"
      described as {
        |Expiry time.
      }
    }
  } with {
    briefly "Reservation expired"
    described as {
      |Emitted when a reservation expires.
    }
  }
  // States
  record ActiveStateData is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    eventInfo: EventInfo with {
      briefly "Event"
      described as {
        |Event info.
      }
    }
    seatInfo: SeatInfo with {
      briefly "Seat"
      described as {
        |Seat info.
      }
    }
    pricingInfo: PricingInfo with {
      briefly "Pricing"
      described as {
        |Pricing info.
      }
    }
    status: TicketStatus with {
      briefly "Status"
      described as {
        |Ticket status.
      }
    }
    currentBuyerInfo: BuyerInfo? with {
      briefly "Buyer"
      described as {
        |Buyer info if assigned.
      }
    }
    paymentTransactionId: TransactionId? with {
      briefly "Transaction"
      described as {
        |Payment transaction.
      }
    }
    currentDigitalTicket: DigitalTicketInfo? with {
      briefly "Digital ticket"
      described as {
        |Digital ticket info.
      }
    }
    currentReservedUntil: TimeStamp? with {
      briefly "Reserved until"
      described as {
        |Reservation expiry.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active ticket state"
    described as {
      |State for an active ticket in the system.
    }
  }
  record CompletedStateData is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    validation: ValidationRecord with {
      briefly "Validation"
      described as {
        |Entry validation.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed ticket state"
    described as {
      |State for a ticket that has been used for entry.
    }
  }
  record RefundedStateData is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Refund details.
      }
    }
    refundedAt: TimeStamp with {
      briefly "Refunded"
      described as {
        |Refund time.
      }
    }
  } with {
    briefly "Refunded ticket state"
    described as {
      |State for a refunded ticket.
    }
  }
  state ActiveState of type Ticket.ActiveStateData
  state CompletedState of type Ticket.CompletedStateData
  state RefundedState of type Ticket.RefundedStateData
  handler TicketHandler is {
    on command CreateTicket is {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.ActiveState with command CreateTicket
      tell event TicketCreated to entity TicketingContext.Ticket
    }
    on command ReserveTicket is {
      tell event TicketReserved to entity TicketingContext.Ticket
    }
    on command PurchaseTicket is {
      tell event TicketPurchased to entity TicketingContext.Ticket
    }
    on command DeliverTicket is {
      tell event TicketDelivered to entity TicketingContext.Ticket
    }
    on command ValidateTicket is {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.CompletedState with command ValidateTicket
      tell event TicketValidated to entity TicketingContext.Ticket
    }
    on command RefundTicket is {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.RefundedState with command RefundTicket
      tell event TicketRefunded to entity TicketingContext.Ticket
    }
    on command CancelTicket is {
      tell event TicketCancelled to entity TicketingContext.Ticket
    }
    on command ExpireReservation is {
      tell event ReservationExpired to entity TicketingContext.Ticket
    }
  } with {
    briefly "Processes ticket commands"
    described as {
      |Handles ticket lifecycle commands.
    }
  }
} with {
  briefly "Ticket aggregate"
  described as {
    |Manages event ticket lifecycle.
  }
}
