// Event Ticketing - Ticket Entity

entity Ticket is {

  command CreateTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "New ticket identifier."
    }
    eventInfo is EventInfo with {
      briefly "Event info"
      described by "Event details."
    }
    seatInfo is SeatInfo with {
      briefly "Seat info"
      described by "Seat assignment."
    }
    pricingInfo is PricingInfo with {
      briefly "Pricing"
      described by "Ticket pricing."
    }
  } with {
    briefly "Create ticket"
    described by "Creates a new ticket for an event."
  }

  command ReserveTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    buyerInfo is BuyerInfo with {
      briefly "Buyer"
      described by "Buyer information."
    }
    reservedUntil is TimeStamp with {
      briefly "Reserved until"
      described by "Reservation expiration time."
    }
  } with {
    briefly "Reserve ticket"
    described by "Reserves a ticket for a buyer temporarily."
  }

  command PurchaseTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    buyerInfo is BuyerInfo with {
      briefly "Buyer"
      described by "Buyer information."
    }
    transactionId is TransactionId with {
      briefly "Transaction"
      described by "Payment transaction ID."
    }
    deliveryMethod is DeliveryMethod with {
      briefly "Delivery"
      described by "Chosen delivery method."
    }
  } with {
    briefly "Purchase ticket"
    described by "Completes ticket purchase with payment."
  }

  command DeliverTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    digitalTicket is DigitalTicketInfo with {
      briefly "Digital ticket"
      described by "Digital ticket delivery info."
    }
  } with {
    briefly "Deliver ticket"
    described by "Delivers digital ticket to buyer."
  }

  command ValidateTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    validation is ValidationRecord with {
      briefly "Validation"
      described by "Validation details."
    }
  } with {
    briefly "Validate ticket"
    described by "Validates ticket at event entry."
  }

  command RefundTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    refundInfo is RefundInfo with {
      briefly "Refund"
      described by "Refund details."
    }
  } with {
    briefly "Refund ticket"
    described by "Processes a ticket refund."
  }

  command CancelTicket is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel ticket"
    described by "Cancels a ticket."
  }

  command ExpireReservation is {
    ticketId is TicketId with {
      briefly "Ticket ID"
      described by "Ticket identifier."
    }
  } with {
    briefly "Expire reservation"
    described by "Expires an unpurchased ticket reservation."
  }

  // Events

  event TicketCreated is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    eventInfo is EventInfo with { briefly "Event" described by "Event info." }
    seatInfo is SeatInfo with { briefly "Seat" described by "Seat info." }
    pricingInfo is PricingInfo with { briefly "Pricing" described by "Pricing info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Ticket created"
    described by "Emitted when a new ticket is created."
  }

  event TicketReserved is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    buyerInfo is BuyerInfo with { briefly "Buyer" described by "Buyer info." }
    reservedUntil is TimeStamp with { briefly "Until" described by "Reservation expiry." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "Reservation time." }
  } with {
    briefly "Ticket reserved"
    described by "Emitted when a ticket is reserved."
  }

  event TicketPurchased is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    buyerInfo is BuyerInfo with { briefly "Buyer" described by "Buyer info." }
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    purchasedAt is TimeStamp with { briefly "Purchased" described by "Purchase time." }
  } with {
    briefly "Ticket purchased"
    described by "Emitted when a ticket is purchased."
  }

  event TicketDelivered is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    digitalTicket is DigitalTicketInfo with { briefly "Ticket" described by "Digital ticket." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Ticket delivered"
    described by "Emitted when digital ticket is delivered."
  }

  event TicketValidated is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    validation is ValidationRecord with { briefly "Validation" described by "Validation record." }
  } with {
    briefly "Ticket validated"
    described by "Emitted when ticket is validated at entry."
  }

  event TicketRefunded is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    refundInfo is RefundInfo with { briefly "Refund" described by "Refund details." }
    refundedAt is TimeStamp with { briefly "Refunded" described by "Refund time." }
  } with {
    briefly "Ticket refunded"
    described by "Emitted when ticket is refunded."
  }

  event TicketCancelled is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Ticket cancelled"
    described by "Emitted when ticket is cancelled."
  }

  event ReservationExpired is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    expiredAt is TimeStamp with { briefly "Expired" described by "Expiry time." }
  } with {
    briefly "Reservation expired"
    described by "Emitted when a reservation expires."
  }

  // States

  record ActiveStateData is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    eventInfo is EventInfo with { briefly "Event" described by "Event info." }
    seatInfo is SeatInfo with { briefly "Seat" described by "Seat info." }
    pricingInfo is PricingInfo with { briefly "Pricing" described by "Pricing info." }
    status is TicketStatus with { briefly "Status" described by "Ticket status." }
    buyerInfo is optional BuyerInfo with { briefly "Buyer" described by "Buyer info if assigned." }
    transactionId is optional TransactionId with { briefly "Transaction" described by "Payment transaction." }
    digitalTicket is optional DigitalTicketInfo with { briefly "Digital ticket" described by "Digital ticket info." }
    reservedUntil is optional TimeStamp with { briefly "Reserved until" described by "Reservation expiry." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active ticket state"
    described by "State for an active ticket in the system."
  }

  record CompletedStateData is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    validation is ValidationRecord with { briefly "Validation" described by "Entry validation." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed ticket state"
    described by "State for a ticket that has been used for entry."
  }

  record RefundedStateData is {
    ticketId is TicketId with { briefly "Ticket" described by "Ticket ID." }
    refundInfo is RefundInfo with { briefly "Refund" described by "Refund details." }
    refundedAt is TimeStamp with { briefly "Refunded" described by "Refund time." }
  } with {
    briefly "Refunded ticket state"
    described by "State for a refunded ticket."
  }

  state ActiveState of Ticket.ActiveStateData with {
    briefly "Ticket active"
    described by "Ticket is active in the system."
  }

  state CompletedState of Ticket.CompletedStateData with {
    briefly "Ticket completed"
    described by "Ticket has been validated and used."
  }

  state RefundedState of Ticket.RefundedStateData with {
    briefly "Ticket refunded"
    described by "Ticket has been refunded."
  }

  handler TicketHandler is {
    on command CreateTicket {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.ActiveState with command CreateTicket
      tell event TicketCreated to entity TicketingContext.Ticket
    }
    on command ReserveTicket {
      tell event TicketReserved to entity TicketingContext.Ticket
    }
    on command PurchaseTicket {
      tell event TicketPurchased to entity TicketingContext.Ticket
    }
    on command DeliverTicket {
      tell event TicketDelivered to entity TicketingContext.Ticket
    }
    on command ValidateTicket {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.CompletedState with command ValidateTicket
      tell event TicketValidated to entity TicketingContext.Ticket
    }
    on command RefundTicket {
      morph entity TicketingContext.Ticket to state TicketingContext.Ticket.RefundedState with command RefundTicket
      tell event TicketRefunded to entity TicketingContext.Ticket
    }
    on command CancelTicket {
      tell event TicketCancelled to entity TicketingContext.Ticket
    }
    on command ExpireReservation {
      tell event ReservationExpired to entity TicketingContext.Ticket
    }
  } with {
    briefly "Processes ticket commands"
    described by "Handles ticket lifecycle commands."
  }

} with {
  briefly "Ticket aggregate"
  described by "Manages event ticket lifecycle."
}
