// Event Ticketing - Ticketing Context
context TicketingContext is {
  include "types.riddl"
  include "Ticket.riddl"
  repository TicketingRepository is {
    schema TicketingData is relational
      of tickets as type Ticket
        index on field Ticket.ticketId
        index on field Ticket.eventInfo.eventId
        index on field Ticket.status

    handler TicketingPersistence is {
      on command Ticket.CreateTicket is {
        prompt "Store new ticket"
      }
      on command Ticket.ReserveTicket is {
        prompt "Update ticket to reserved"
      }
      on command Ticket.PurchaseTicket is {
        prompt "Update ticket to purchased"
      }
      on command Ticket.DeliverTicket is {
        prompt "Update ticket delivery info"
      }
      on command Ticket.ValidateTicket is {
        prompt "Update ticket to validated"
      }
      on command Ticket.RefundTicket is {
        prompt "Update ticket to refunded"
      }
    } with {
      briefly "Persists ticketing commands"
      described as {
        |Handles event-driven ticket persistence.
      }
    }
  } with {
    briefly "Ticketing data persistence"
    described as {
      |Persistent storage for tickets.
    }
  }
  projector TicketingMetrics is {
    record SalesMetrics is  {
      ticketsCreated: Natural with {
        briefly "Created"
        described as {
          |Tickets created.
        }
      }
      ticketsSold: Natural with {
        briefly "Sold"
        described as {
          |Tickets sold.
        }
      }
      ticketsRefunded: Natural with {
        briefly "Refunded"
        described as {
          |Tickets refunded.
        }
      }
      totalRevenue: Decimal(12,2) with {
        briefly "Revenue"
        described as {
          |Total ticket revenue.
        }
      }
      averageTicketPrice: Decimal(10,2) with {
        briefly "Avg price"
        described as {
          |Average ticket price.
        }
      }
    } with {
      briefly "Sales metrics"
      described as {
        |Ticket sales metrics.
      }
    }
    handler MetricsHandler is {
      on event Ticket.TicketCreated is {
        prompt "Increment tickets created"
      }
      on event Ticket.TicketPurchased is {
        prompt "Increment tickets sold and update revenue"
      }
      on event Ticket.TicketRefunded is {
        prompt "Increment tickets refunded and adjust revenue"
      }
      on event Ticket.TicketValidated is {
        prompt "Track entry validation count"
      }
    } with {
      briefly "Maintains ticketing metrics"
      described as {
        |Projects events into sales metrics.
      }
    }
  } with {
    briefly "Ticketing metrics"
    described as {
      |Ticket sales and entry analytics.
    }
  }
} with {
  briefly "Bounded context for event ticketing"
  described as {
    |Event ticketing bounded context.
  }
}
