// Ticket Sales - Ticket Entity
// The primary aggregate for ticket lifecycle management

entity Ticket is {

  // Commands
  command CreateEvent is {
    eventId is EventId with {
      briefly "Event identifier"
      described by "The unique identifier for the new event."
    }
    name is String(1, 200) with {
      briefly "Event name"
      described by "The official name or title of the event."
    }
    description is String(1, 2000) with {
      briefly "Event description"
      described by "Detailed description of the event."
    }
    venueId is VenueId with {
      briefly "Venue reference"
      described by "Reference to the venue where the event will be held."
    }
    venueName is String(1, 200) with {
      briefly "Venue name"
      described by "Human-readable name of the venue."
    }
    eventDate is DateTime with {
      briefly "Event date"
      described by "When the event will take place."
    }
    doorsOpen is DateTime with {
      briefly "Doors open"
      described by "When venue doors open for entry."
    }
    category is String(1, 100) with {
      briefly "Category"
      described by "Event category for classification."
    }
    ageRestriction is optional String(1, 50) with {
      briefly "Age restriction"
      described by "Minimum age requirement if any."
    }
    refundPolicy is String(1, 500) with {
      briefly "Refund policy"
      described by "Policy for ticket refunds."
    }
    pricingTiers is many PricingTier with {
      briefly "Pricing tiers"
      described by "Available pricing tiers for the event."
    }
  } with {
    briefly "Create a new event with ticket inventory"
    described by {
      | Creates a new event with venue, timing, and pricing information.
      | Ticket inventory is prepared but not yet released for sale.
    }
  }

  command ReleaseTickets is {
    eventId is EventId with {
      briefly "Event identifier"
      described by "The event for which tickets are being released."
    }
    tierName is String(1, 50) with {
      briefly "Pricing tier"
      described by "Which pricing tier to release tickets for."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Number of tickets to release for sale."
    }
    releaseTime is optional DateTime with {
      briefly "Release time"
      described by "Scheduled time to make tickets available, or now if null."
    }
  } with {
    briefly "Release tickets for sale to the public"
    described by "Makes specified tickets available for purchase in the given tier."
  }

  command PurchaseTicket is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket being purchased."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "The person purchasing the ticket."
    }
    paymentTransactionId is String(1, 100) with {
      briefly "Payment transaction"
      described by "Transaction ID from payment processor."
    }
    amountPaid is Money with {
      briefly "Amount paid"
      described by "Total amount paid including fees."
    }
  } with {
    briefly "Complete ticket purchase after payment"
    described by "Finalizes ticket purchase and assigns ownership to buyer."
  }

  command ReserveTicket is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket to reserve temporarily."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "The buyer requesting the reservation."
    }
    expiresAt is TimeStamp with {
      briefly "Expiration"
      described by "When the reservation expires if not purchased."
    }
  } with {
    briefly "Temporarily hold a ticket during checkout"
    described by "Reserves a ticket for a buyer while they complete checkout."
  }

  command TransferTicket is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket being transferred."
    }
    fromBuyerId is BuyerId with {
      briefly "Current owner"
      described by "The buyer currently holding the ticket."
    }
    toBuyerId is BuyerId with {
      briefly "New owner"
      described by "The buyer receiving the ticket."
    }
    recipientEmail is String(1, 200) with {
      briefly "Recipient email"
      described by "Email address to notify the recipient."
    }
  } with {
    briefly "Transfer ticket ownership to another buyer"
    described by "Changes ticket ownership from current holder to a new buyer."
  }

  command RefundTicket is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket being refunded."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "The buyer requesting the refund."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for requesting the refund."
    }
  } with {
    briefly "Process a refund for a purchased ticket"
    described by "Refunds the ticket and returns it to available inventory."
  }

  command CancelReservation is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The reserved ticket to release."
    }
  } with {
    briefly "Cancel an expired or abandoned reservation"
    described by "Returns a reserved ticket to available inventory."
  }

  command ScanTicket is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket being scanned for entry."
    }
    scannedAt is TimeStamp with {
      briefly "Scan time"
      described by "When the ticket was scanned."
    }
    gateId is String(1, 50) with {
      briefly "Gate"
      described by "Which gate or entrance scanned the ticket."
    }
  } with {
    briefly "Scan ticket for venue entry"
    described by "Marks ticket as used when scanned at venue entrance."
  }

  // Events
  event EventCreated is {
    eventId is EventId with {
      briefly "Event identifier"
      described by "The unique identifier of the created event."
    }
    name is String(1, 200) with {
      briefly "Event name"
      described by "Name of the event."
    }
    venueId is VenueId with {
      briefly "Venue"
      described by "Where the event will be held."
    }
    venueName is String(1, 200) with {
      briefly "Venue name"
      described by "Name of the venue."
    }
    eventDate is DateTime with {
      briefly "Event date"
      described by "When the event occurs."
    }
    totalCapacity is Natural with {
      briefly "Capacity"
      described by "Total ticket capacity for the event."
    }
    createdAt is TimeStamp with {
      briefly "Created"
      described by "When the event was created."
    }
  } with {
    briefly "A new event was created"
    described by "Emitted when an event promoter creates a new event."
  }

  event TicketsReleased is {
    eventId is EventId with {
      briefly "Event identifier"
      described by "The event for which tickets were released."
    }
    tierName is String(1, 50) with {
      briefly "Tier"
      described by "Pricing tier that was released."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Number of tickets released."
    }
    releasedAt is TimeStamp with {
      briefly "Released"
      described by "When tickets were released."
    }
  } with {
    briefly "Tickets were released for sale"
    described by "Emitted when tickets become available for purchase."
  }

  event TicketPurchased is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The purchased ticket."
    }
    eventId is EventId with {
      briefly "Event"
      described by "The event the ticket is for."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "Who purchased the ticket."
    }
    seatId is SeatId with {
      briefly "Seat"
      described by "The assigned seat."
    }
    section is String(1, 50) with {
      briefly "Section"
      described by "Venue section."
    }
    pricingTier is String(1, 50) with {
      briefly "Tier"
      described by "Pricing tier."
    }
    amountPaid is Money with {
      briefly "Amount"
      described by "Total amount paid."
    }
    purchasedAt is TimeStamp with {
      briefly "Purchased"
      described by "When purchased."
    }
  } with {
    briefly "A ticket was purchased"
    described by "Emitted when a buyer successfully purchases a ticket."
  }

  event TicketReserved is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The reserved ticket."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "Who reserved the ticket."
    }
    expiresAt is TimeStamp with {
      briefly "Expires"
      described by "When the reservation expires."
    }
    reservedAt is TimeStamp with {
      briefly "Reserved"
      described by "When reserved."
    }
  } with {
    briefly "A ticket was temporarily reserved"
    described by "Emitted when a ticket is held for checkout."
  }

  event TicketTransferred is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The transferred ticket."
    }
    eventId is EventId with {
      briefly "Event"
      described by "The event the ticket is for."
    }
    fromBuyerId is BuyerId with {
      briefly "From"
      described by "Previous owner."
    }
    toBuyerId is BuyerId with {
      briefly "To"
      described by "New owner."
    }
    transferredAt is TimeStamp with {
      briefly "Transferred"
      described by "When transferred."
    }
  } with {
    briefly "A ticket was transferred to a new owner"
    described by "Emitted when ticket ownership changes."
  }

  event TicketRefunded is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The refunded ticket."
    }
    eventId is EventId with {
      briefly "Event"
      described by "The event the ticket was for."
    }
    buyerId is BuyerId with {
      briefly "Buyer"
      described by "Who received the refund."
    }
    refundAmount is Money with {
      briefly "Amount"
      described by "Amount refunded."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Refund reason."
    }
    refundedAt is TimeStamp with {
      briefly "Refunded"
      described by "When refunded."
    }
  } with {
    briefly "A ticket was refunded"
    described by "Emitted when a ticket purchase is refunded."
  }

  event ReservationCancelled is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The ticket whose reservation was cancelled."
    }
    cancelledAt is TimeStamp with {
      briefly "Cancelled"
      described by "When the reservation was cancelled."
    }
  } with {
    briefly "A ticket reservation was cancelled"
    described by "Emitted when a reservation expires or is abandoned."
  }

  event TicketScanned is {
    ticketId is TicketId with {
      briefly "Ticket identifier"
      described by "The scanned ticket."
    }
    eventId is EventId with {
      briefly "Event"
      described by "The event."
    }
    buyerId is BuyerId with {
      briefly "Holder"
      described by "The ticket holder."
    }
    gateId is String(1, 50) with {
      briefly "Gate"
      described by "Entry gate."
    }
    scannedAt is TimeStamp with {
      briefly "Scanned"
      described by "When scanned."
    }
  } with {
    briefly "A ticket was scanned for entry"
    described by "Emitted when a ticket is used for venue admission."
  }

  // State Records
  record AvailableTicketData is {
    ticketId is TicketId with { briefly "Ticket ID" described by "Ticket identifier." }
    eventId is EventId with { briefly "Event ID" described by "Event reference." }
    seatId is SeatId with { briefly "Seat ID" described by "Seat assignment." }
    section is String(1, 50) with { briefly "Section" described by "Venue section." }
    row is optional String(1, 20) with { briefly "Row" described by "Row designation." }
    seatNumber is optional String(1, 20) with { briefly "Seat" described by "Seat number." }
    pricingTier is String(1, 50) with { briefly "Tier" described by "Pricing tier." }
    faceValue is Money with { briefly "Price" described by "Face value price." }
    createdAt is TimeStamp with { briefly "Created" described by "When created." }
  } with {
    briefly "Ticket data when available for sale"
    described by "State data for a ticket that is available for purchase."
  }

  record ReservedTicketData is {
    ticketId is TicketId with { briefly "Ticket ID" described by "Ticket identifier." }
    eventId is EventId with { briefly "Event ID" described by "Event reference." }
    seatId is SeatId with { briefly "Seat ID" described by "Seat assignment." }
    section is String(1, 50) with { briefly "Section" described by "Venue section." }
    row is optional String(1, 20) with { briefly "Row" described by "Row designation." }
    seatNumber is optional String(1, 20) with { briefly "Seat" described by "Seat number." }
    pricingTier is String(1, 50) with { briefly "Tier" described by "Pricing tier." }
    faceValue is Money with { briefly "Price" described by "Face value price." }
    buyerId is BuyerId with { briefly "Buyer" described by "Buyer holding reservation." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "When reserved." }
    expiresAt is TimeStamp with { briefly "Expires" described by "Reservation expiration." }
  } with {
    briefly "Ticket data when temporarily reserved"
    described by "State data for a ticket held during checkout."
  }

  record SoldTicketData is {
    ticketId is TicketId with { briefly "Ticket ID" described by "Ticket identifier." }
    eventId is EventId with { briefly "Event ID" described by "Event reference." }
    seatId is SeatId with { briefly "Seat ID" described by "Seat assignment." }
    section is String(1, 50) with { briefly "Section" described by "Venue section." }
    row is optional String(1, 20) with { briefly "Row" described by "Row designation." }
    seatNumber is optional String(1, 20) with { briefly "Seat" described by "Seat number." }
    pricingTier is String(1, 50) with { briefly "Tier" described by "Pricing tier." }
    faceValue is Money with { briefly "Price" described by "Face value price." }
    buyerId is BuyerId with { briefly "Owner" described by "Current ticket owner." }
    amountPaid is Money with { briefly "Paid" described by "Amount paid for ticket." }
    paymentTransactionId is String(1, 100) with { briefly "Transaction" described by "Payment transaction ID." }
    purchasedAt is TimeStamp with { briefly "Purchased" described by "When purchased." }
    transferHistory is many TransferRecord with { briefly "Transfers" described by "Transfer history." }
  } with {
    briefly "Ticket data when sold to a buyer"
    described by "State data for a ticket that has been purchased."
  }

  record RefundedTicketData is {
    ticketId is TicketId with { briefly "Ticket ID" described by "Ticket identifier." }
    eventId is EventId with { briefly "Event ID" described by "Event reference." }
    seatId is SeatId with { briefly "Seat ID" described by "Seat assignment." }
    section is String(1, 50) with { briefly "Section" described by "Venue section." }
    pricingTier is String(1, 50) with { briefly "Tier" described by "Pricing tier." }
    faceValue is Money with { briefly "Price" described by "Face value price." }
    originalBuyerId is BuyerId with { briefly "Original buyer" described by "Who was refunded." }
    refundAmount is Money with { briefly "Refund" described by "Amount refunded." }
    refundReason is String(1, 500) with { briefly "Reason" described by "Refund reason." }
    refundedAt is TimeStamp with { briefly "Refunded" described by "When refunded." }
  } with {
    briefly "Ticket data after refund"
    described by "State data for a ticket that was refunded."
  }

  record UsedTicketData is {
    ticketId is TicketId with { briefly "Ticket ID" described by "Ticket identifier." }
    eventId is EventId with { briefly "Event ID" described by "Event reference." }
    seatId is SeatId with { briefly "Seat ID" described by "Seat assignment." }
    section is String(1, 50) with { briefly "Section" described by "Venue section." }
    row is optional String(1, 20) with { briefly "Row" described by "Row designation." }
    seatNumber is optional String(1, 20) with { briefly "Seat" described by "Seat number." }
    buyerId is BuyerId with { briefly "Holder" described by "Who used the ticket." }
    gateId is String(1, 50) with { briefly "Gate" described by "Entry gate used." }
    scannedAt is TimeStamp with { briefly "Scanned" described by "When scanned for entry." }
  } with {
    briefly "Ticket data after use for entry"
    described by "State data for a ticket used for venue admission."
  }

  // States
  state AvailableState of Ticket.AvailableTicketData with {
    briefly "Ticket is available for purchase"
    described by "Ticket is in inventory and can be purchased by any buyer."
  }

  state ReservedState of Ticket.ReservedTicketData with {
    briefly "Ticket is temporarily reserved"
    described by "Ticket is held for a buyer during checkout."
  }

  state SoldState of Ticket.SoldTicketData with {
    briefly "Ticket has been sold"
    described by "Ticket has been purchased and assigned to a buyer."
  }

  state RefundedState of Ticket.RefundedTicketData with {
    briefly "Ticket was refunded"
    described by "Ticket has been refunded and returned to inventory."
  }

  state UsedState of Ticket.UsedTicketData with {
    briefly "Ticket was used for entry"
    described by "Ticket has been scanned at venue for admission."
  }

  // Handler
  handler TicketHandler is {
    on command ReserveTicket {
      morph entity Ticket to state Ticket.ReservedState with command ReserveTicket
      tell event TicketReserved to entity Ticket
    }

    on command PurchaseTicket {
      morph entity Ticket to state Ticket.SoldState with command PurchaseTicket
      tell event TicketPurchased to entity Ticket
    }

    on command TransferTicket {
      prompt "Update ownership in SoldState and add to transfer history"
      tell event TicketTransferred to entity Ticket
    }

    on command RefundTicket {
      morph entity Ticket to state Ticket.RefundedState with command RefundTicket
      tell event TicketRefunded to entity Ticket
    }

    on command CancelReservation {
      morph entity Ticket to state Ticket.AvailableState with command CancelReservation
      tell event ReservationCancelled to entity Ticket
    }

    on command ScanTicket {
      morph entity Ticket to state Ticket.UsedState with command ScanTicket
      tell event TicketScanned to entity Ticket
    }
  } with {
    briefly "Processes ticket lifecycle commands"
    described by {
      | Handles all commands related to ticket state transitions including
      | reservations, purchases, transfers, refunds, and venue entry.
    }
  }

} with {
  briefly "The ticket aggregate managing ticket lifecycle"
  described by {
    | The Ticket entity is the primary aggregate for the Ticket Sales
    | bounded context. It tracks tickets from inventory release through
    | sale, transfer, or refund, and finally venue admission. Events
    | maintain a complete audit trail of all ticket transactions.
  }
}
