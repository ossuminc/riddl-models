// Ticket Sales - Ticket Entity
// The primary aggregate for ticket lifecycle management
entity Ticket is {
  // Commands
  command CreateEvent is  {
    eventId: EventId with {
      briefly "Event identifier"
      described as {
        |The unique identifier for the new event.
      }
    }
    name: String(1,200) with {
      briefly "Event name"
      described as {
        |The official name or title of the event.
      }
    }
    description: String(1,2000) with {
      briefly "Event description"
      described as {
        |Detailed description of the event.
      }
    }
    venueId: VenueId with {
      briefly "Venue reference"
      described as {
        |Reference to the venue where the event will be held.
      }
    }
    venueName: String(1,200) with {
      briefly "Venue name"
      described as {
        |Human-readable name of the venue.
      }
    }
    eventDate: DateTime with {
      briefly "Event date"
      described as {
        |When the event will take place.
      }
    }
    doorsOpen: DateTime with {
      briefly "Doors open"
      described as {
        |When venue doors open for entry.
      }
    }
    category: String(1,100) with {
      briefly "Category"
      described as {
        |Event category for classification.
      }
    }
    ageRestriction: String(1,50)? with {
      briefly "Age restriction"
      described as {
        |Minimum age requirement if any.
      }
    }
    refundPolicy: String(1,500) with {
      briefly "Refund policy"
      described as {
        |Policy for ticket refunds.
      }
    }
    pricingTiers: PricingTier+ with {
      briefly "Pricing tiers"
      described as {
        |Available pricing tiers for the event.
      }
    }
  } with {
    briefly "Create a new event with ticket inventory"
    described as {
      | Creates a new event with venue, timing, and pricing information.
      | Ticket inventory is prepared but not yet released for sale.
    }
  }
  command ReleaseTickets is  {
    eventId: EventId with {
      briefly "Event identifier"
      described as {
        |The event for which tickets are being released.
      }
    }
    tierName: String(1,50) with {
      briefly "Pricing tier"
      described as {
        |Which pricing tier to release tickets for.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Number of tickets to release for sale.
      }
    }
    releaseTime: DateTime? with {
      briefly "Release time"
      described as {
        |Scheduled time to make tickets available, or now if null.
      }
    }
  } with {
    briefly "Release tickets for sale to the public"
    described as {
      |Makes specified tickets available for purchase in the given tier.
    }
  }
  command PurchaseTicket is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket being purchased.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |The person purchasing the ticket.
      }
    }
    paymentTransactionId: String(1,100) with {
      briefly "Payment transaction"
      described as {
        |Transaction ID from payment processor.
      }
    }
    amountPaid: Money with {
      briefly "Amount paid"
      described as {
        |Total amount paid including fees.
      }
    }
  } with {
    briefly "Complete ticket purchase after payment"
    described as {
      |Finalizes ticket purchase and assigns ownership to buyer.
    }
  }
  command ReserveTicket is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket to reserve temporarily.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |The buyer requesting the reservation.
      }
    }
    expiresAt: TimeStamp with {
      briefly "Expiration"
      described as {
        |When the reservation expires if not purchased.
      }
    }
  } with {
    briefly "Temporarily hold a ticket during checkout"
    described as {
      |Reserves a ticket for a buyer while they complete checkout.
    }
  }
  command TransferTicket is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket being transferred.
      }
    }
    fromBuyerId: BuyerId with {
      briefly "Current owner"
      described as {
        |The buyer currently holding the ticket.
      }
    }
    toBuyerId: BuyerId with {
      briefly "New owner"
      described as {
        |The buyer receiving the ticket.
      }
    }
    recipientEmail: String(1,200) with {
      briefly "Recipient email"
      described as {
        |Email address to notify the recipient.
      }
    }
  } with {
    briefly "Transfer ticket ownership to another buyer"
    described as {
      |Changes ticket ownership from current holder to a new buyer.
    }
  }
  command RefundTicket is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket being refunded.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |The buyer requesting the refund.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for requesting the refund.
      }
    }
  } with {
    briefly "Process a refund for a purchased ticket"
    described as {
      |Refunds the ticket and returns it to available inventory.
    }
  }
  command CancelReservation is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The reserved ticket to release.
      }
    }
  } with {
    briefly "Cancel an expired or abandoned reservation"
    described as {
      |Returns a reserved ticket to available inventory.
    }
  }
  command ScanTicket is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket being scanned for entry.
      }
    }
    scannedAt: TimeStamp with {
      briefly "Scan time"
      described as {
        |When the ticket was scanned.
      }
    }
    gateId: String(1,50) with {
      briefly "Gate"
      described as {
        |Which gate or entrance scanned the ticket.
      }
    }
  } with {
    briefly "Scan ticket for venue entry"
    described as {
      |Marks ticket as used when scanned at venue entrance.
    }
  }
  // Events
  event EventCreated is  {
    eventId: EventId with {
      briefly "Event identifier"
      described as {
        |The unique identifier of the created event.
      }
    }
    name: String(1,200) with {
      briefly "Event name"
      described as {
        |Name of the event.
      }
    }
    venueId: VenueId with {
      briefly "Venue"
      described as {
        |Where the event will be held.
      }
    }
    venueName: String(1,200) with {
      briefly "Venue name"
      described as {
        |Name of the venue.
      }
    }
    eventDate: DateTime with {
      briefly "Event date"
      described as {
        |When the event occurs.
      }
    }
    totalCapacity: Natural with {
      briefly "Capacity"
      described as {
        |Total ticket capacity for the event.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |When the event was created.
      }
    }
  } with {
    briefly "A new event was created"
    described as {
      |Emitted when an event promoter creates a new event.
    }
  }
  event TicketsReleased is  {
    eventId: EventId with {
      briefly "Event identifier"
      described as {
        |The event for which tickets were released.
      }
    }
    tierName: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier that was released.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Number of tickets released.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |When tickets were released.
      }
    }
  } with {
    briefly "Tickets were released for sale"
    described as {
      |Emitted when tickets become available for purchase.
    }
  }
  event TicketPurchased is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The purchased ticket.
      }
    }
    eventId: EventId with {
      briefly "Event"
      described as {
        |The event the ticket is for.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |Who purchased the ticket.
      }
    }
    seatId: SeatId with {
      briefly "Seat"
      described as {
        |The assigned seat.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    pricingTier: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier.
      }
    }
    amountPaid: Money with {
      briefly "Amount"
      described as {
        |Total amount paid.
      }
    }
    purchasedAt: TimeStamp with {
      briefly "Purchased"
      described as {
        |When purchased.
      }
    }
  } with {
    briefly "A ticket was purchased"
    described as {
      |Emitted when a buyer successfully purchases a ticket.
    }
  }
  event TicketReserved is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The reserved ticket.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |Who reserved the ticket.
      }
    }
    expiresAt: TimeStamp with {
      briefly "Expires"
      described as {
        |When the reservation expires.
      }
    }
    reservedAt: TimeStamp with {
      briefly "Reserved"
      described as {
        |When reserved.
      }
    }
  } with {
    briefly "A ticket was temporarily reserved"
    described as {
      |Emitted when a ticket is held for checkout.
    }
  }
  event TicketTransferred is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The transferred ticket.
      }
    }
    eventId: EventId with {
      briefly "Event"
      described as {
        |The event the ticket is for.
      }
    }
    fromBuyerId: BuyerId with {
      briefly "From"
      described as {
        |Previous owner.
      }
    }
    toBuyerId: BuyerId with {
      briefly "To"
      described as {
        |New owner.
      }
    }
    transferredAt: TimeStamp with {
      briefly "Transferred"
      described as {
        |When transferred.
      }
    }
  } with {
    briefly "A ticket was transferred to a new owner"
    described as {
      |Emitted when ticket ownership changes.
    }
  }
  event TicketRefunded is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The refunded ticket.
      }
    }
    eventId: EventId with {
      briefly "Event"
      described as {
        |The event the ticket was for.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |Who received the refund.
      }
    }
    refundAmount: Money with {
      briefly "Amount"
      described as {
        |Amount refunded.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Refund reason.
      }
    }
    refundedAt: TimeStamp with {
      briefly "Refunded"
      described as {
        |When refunded.
      }
    }
  } with {
    briefly "A ticket was refunded"
    described as {
      |Emitted when a ticket purchase is refunded.
    }
  }
  event ReservationCancelled is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The ticket whose reservation was cancelled.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |When the reservation was cancelled.
      }
    }
  } with {
    briefly "A ticket reservation was cancelled"
    described as {
      |Emitted when a reservation expires or is abandoned.
    }
  }
  event TicketScanned is  {
    ticketId: TicketId with {
      briefly "Ticket identifier"
      described as {
        |The scanned ticket.
      }
    }
    eventId: EventId with {
      briefly "Event"
      described as {
        |The event.
      }
    }
    buyerId: BuyerId with {
      briefly "Holder"
      described as {
        |The ticket holder.
      }
    }
    gateId: String(1,50) with {
      briefly "Gate"
      described as {
        |Entry gate.
      }
    }
    scannedAt: TimeStamp with {
      briefly "Scanned"
      described as {
        |When scanned.
      }
    }
  } with {
    briefly "A ticket was scanned for entry"
    described as {
      |Emitted when a ticket is used for venue admission.
    }
  }
  // State Records
  record AvailableTicketData is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    eventId: EventId with {
      briefly "Event ID"
      described as {
        |Event reference.
      }
    }
    seatId: SeatId with {
      briefly "Seat ID"
      described as {
        |Seat assignment.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    row: String(1,20)? with {
      briefly "Row"
      described as {
        |Row designation.
      }
    }
    seatNumber: String(1,20)? with {
      briefly "Seat"
      described as {
        |Seat number.
      }
    }
    pricingTier: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier.
      }
    }
    faceValue: Money with {
      briefly "Price"
      described as {
        |Face value price.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |When created.
      }
    }
  } with {
    briefly "Ticket data when available for sale"
    described as {
      |State data for a ticket that is available for purchase.
    }
  }
  record ReservedTicketData is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    eventId: EventId with {
      briefly "Event ID"
      described as {
        |Event reference.
      }
    }
    seatId: SeatId with {
      briefly "Seat ID"
      described as {
        |Seat assignment.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    row: String(1,20)? with {
      briefly "Row"
      described as {
        |Row designation.
      }
    }
    seatNumber: String(1,20)? with {
      briefly "Seat"
      described as {
        |Seat number.
      }
    }
    pricingTier: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier.
      }
    }
    faceValue: Money with {
      briefly "Price"
      described as {
        |Face value price.
      }
    }
    buyerId: BuyerId with {
      briefly "Buyer"
      described as {
        |Buyer holding reservation.
      }
    }
    reservedAt: TimeStamp with {
      briefly "Reserved"
      described as {
        |When reserved.
      }
    }
    expiresAt: TimeStamp with {
      briefly "Expires"
      described as {
        |Reservation expiration.
      }
    }
  } with {
    briefly "Ticket data when temporarily reserved"
    described as {
      |State data for a ticket held during checkout.
    }
  }
  record SoldTicketData is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    eventId: EventId with {
      briefly "Event ID"
      described as {
        |Event reference.
      }
    }
    seatId: SeatId with {
      briefly "Seat ID"
      described as {
        |Seat assignment.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    row: String(1,20)? with {
      briefly "Row"
      described as {
        |Row designation.
      }
    }
    seatNumber: String(1,20)? with {
      briefly "Seat"
      described as {
        |Seat number.
      }
    }
    pricingTier: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier.
      }
    }
    faceValue: Money with {
      briefly "Price"
      described as {
        |Face value price.
      }
    }
    buyerId: BuyerId with {
      briefly "Owner"
      described as {
        |Current ticket owner.
      }
    }
    amountPaid: Money with {
      briefly "Paid"
      described as {
        |Amount paid for ticket.
      }
    }
    paymentTransactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Payment transaction ID.
      }
    }
    purchasedAt: TimeStamp with {
      briefly "Purchased"
      described as {
        |When purchased.
      }
    }
    transferHistory: TransferRecord+ with {
      briefly "Transfers"
      described as {
        |Transfer history.
      }
    }
  } with {
    briefly "Ticket data when sold to a buyer"
    described as {
      |State data for a ticket that has been purchased.
    }
  }
  record RefundedTicketData is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    eventId: EventId with {
      briefly "Event ID"
      described as {
        |Event reference.
      }
    }
    seatId: SeatId with {
      briefly "Seat ID"
      described as {
        |Seat assignment.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    pricingTier: String(1,50) with {
      briefly "Tier"
      described as {
        |Pricing tier.
      }
    }
    faceValue: Money with {
      briefly "Price"
      described as {
        |Face value price.
      }
    }
    originalBuyerId: BuyerId with {
      briefly "Original buyer"
      described as {
        |Who was refunded.
      }
    }
    refundAmount: Money with {
      briefly "Refund"
      described as {
        |Amount refunded.
      }
    }
    refundReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Refund reason.
      }
    }
    refundedAt: TimeStamp with {
      briefly "Refunded"
      described as {
        |When refunded.
      }
    }
  } with {
    briefly "Ticket data after refund"
    described as {
      |State data for a ticket that was refunded.
    }
  }
  record UsedTicketData is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    eventId: EventId with {
      briefly "Event ID"
      described as {
        |Event reference.
      }
    }
    seatId: SeatId with {
      briefly "Seat ID"
      described as {
        |Seat assignment.
      }
    }
    section: String(1,50) with {
      briefly "Section"
      described as {
        |Venue section.
      }
    }
    row: String(1,20)? with {
      briefly "Row"
      described as {
        |Row designation.
      }
    }
    seatNumber: String(1,20)? with {
      briefly "Seat"
      described as {
        |Seat number.
      }
    }
    buyerId: BuyerId with {
      briefly "Holder"
      described as {
        |Who used the ticket.
      }
    }
    gateId: String(1,50) with {
      briefly "Gate"
      described as {
        |Entry gate used.
      }
    }
    scannedAt: TimeStamp with {
      briefly "Scanned"
      described as {
        |When scanned for entry.
      }
    }
  } with {
    briefly "Ticket data after use for entry"
    described as {
      |State data for a ticket used for venue admission.
    }
  }
  // States
  state AvailableState of type Ticket.AvailableTicketData
  state ReservedState of type Ticket.ReservedTicketData
  state SoldState of type Ticket.SoldTicketData
  state RefundedState of type Ticket.RefundedTicketData
  state UsedState of type Ticket.UsedTicketData
  // Handler
  handler TicketHandler is {
    on command ReserveTicket is {
      morph entity Ticket to state Ticket.ReservedState with command ReserveTicket
      tell event TicketReserved to entity Ticket
    }
    on command PurchaseTicket is {
      morph entity Ticket to state Ticket.SoldState with command PurchaseTicket
      tell event TicketPurchased to entity Ticket
    }
    on command TransferTicket is {
      prompt "Update ownership in SoldState and add to transfer history"
      tell event TicketTransferred to entity Ticket
    }
    on command RefundTicket is {
      morph entity Ticket to state Ticket.RefundedState with command RefundTicket
      tell event TicketRefunded to entity Ticket
    }
    on command CancelReservation is {
      morph entity Ticket to state Ticket.AvailableState with command CancelReservation
      tell event ReservationCancelled to entity Ticket
    }
    on command ScanTicket is {
      morph entity Ticket to state Ticket.UsedState with command ScanTicket
      tell event TicketScanned to entity Ticket
    }
  } with {
    briefly "Processes ticket lifecycle commands"
    described as {
      | Handles all commands related to ticket state transitions including
      | reservations, purchases, transfers, refunds, and venue entry.
    }
  }
} with {
  briefly "The ticket aggregate managing ticket lifecycle"
  described as {
    | The Ticket entity is the primary aggregate for the Ticket Sales
    | bounded context. It tracks tickets from inventory release through
    | sale, transfer, or refund, and finally venue admission. Events
    | maintain a complete audit trail of all ticket transactions.
  }
}
