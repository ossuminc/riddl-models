// Ticket Sales - Ticket Context
// The primary bounded context for ticket sales management
context TicketContext is {
  include "types.riddl"
  include "Ticket.riddl"
  // Adaptors for external system integration
  adaptor PaymentAdapter from context PaymentGateway is { 
    handler InboundPayments is {
      on event PaymentGateway.PaymentSucceeded is {
        tell command PurchaseTicket to entity Ticket
      }
      on event PaymentGateway.PaymentFailed is {
        prompt "Log payment failure and release reservation"
        tell command CancelReservation to entity Ticket
        error "Payment failed for ticket reservation"
      }
      on event PaymentGateway.RefundCompleted is {
        prompt "Update ticket status with refund confirmation"
      }
    } with {
      briefly "Handles payment events from gateway"
      described as {
        |Processes inbound payment status events and routes to Ticket entity.
      }
    }
  } with {
    briefly "Translates payment gateway events"
    described as {
      | Receives payment status events from the external PaymentGateway
      | and translates them into commands for the Ticket entity.
    }
  }
  adaptor VenueAdapter from context VenueManagement is { 
    handler InboundVenue is {
      on event VenueManagement.SeatingChartUpdated is {
        prompt "Sync seat inventory with updated venue layout"
      }
      on event VenueManagement.VenueCapacityChanged is {
        prompt "Adjust available ticket inventory based on capacity change"
      }
    } with {
      briefly "Handles venue management events"
      described as {
        |Processes venue updates that affect ticket inventory.
      }
    }
  } with {
    briefly "Translates venue management events"
    described as {
      | Receives venue updates from the VenueManagement context
      | and adjusts ticket inventory accordingly.
    }
  }
  adaptor MarketingAdapter to context MarketingService is { 
    handler OutboundMarketing is {
      on command MarketingService.AnnounceEvent is {
        tell command MarketingService.AnnounceEvent to context MarketingService
      }
      on command MarketingService.NotifySubscribers is {
        tell command MarketingService.NotifySubscribers to context MarketingService
      }
      on command MarketingService.SendConfirmation is {
        tell command MarketingService.SendConfirmation to context MarketingService
      }
      on command MarketingService.NotifyTransfer is {
        tell command MarketingService.NotifyTransfer to context MarketingService
      }
    } with {
      briefly "Sends events to marketing service"
      described as {
        |Routes ticket events to marketing for notifications and campaigns.
      }
    }
  } with {
    briefly "Translates events for marketing"
    described as {
      | Sends relevant ticket events to the MarketingService context
      | for email notifications, announcements, and campaigns.
    }
  }
  // Repository for ticket persistence
  repository TicketRepository is {
    schema TicketData is relational
      of tickets as type Ticket
        index on field Ticket.eventId
        index on field Ticket.buyerId
        index on field Ticket.seatId

    handler TicketPersistence is {
      on command Ticket.CreateEvent is {
        prompt "Persist new event and initialize ticket inventory"
      }
      on command Ticket.ReleaseTickets is {
        prompt "Update ticket availability status for released inventory"
      }
      on command Ticket.ReserveTicket is {
        prompt "Mark ticket as reserved with expiration"
      }
      on command Ticket.PurchaseTicket is {
        prompt "Update ticket with purchase details and buyer"
      }
      on command Ticket.TransferTicket is {
        prompt "Update ticket ownership and add transfer record"
      }
      on command Ticket.RefundTicket is {
        prompt "Mark ticket as refunded and return to inventory"
      }
      on command Ticket.CancelReservation is {
        prompt "Return ticket to available inventory"
      }
      on command Ticket.ScanTicket is {
        prompt "Mark ticket as used for entry"
      }
    } with {
      briefly "Persists ticket events to storage"
      described as {
        |Handles all event-driven persistence operations for tickets.
      }
    }
  } with {
    briefly "Persistent storage for ticket data"
    described as {
      | The TicketRepository provides persistent storage for tickets
      | with indexes optimized for common query patterns by event,
      | buyer, and seat.
    }
  }
  // Projector for sales metrics
  projector SalesMetrics is {
    record EventSalesMetrics is  {
      eventId: EventId with {
        briefly "Event identifier"
        described as {
          |The event these metrics are for.
        }
      }
      totalCapacity: Natural with {
        briefly "Total capacity"
        described as {
          |Total tickets available for the event.
        }
      }
      ticketsSold: Natural with {
        briefly "Tickets sold"
        described as {
          |Number of tickets sold.
        }
      }
      ticketsReserved: Natural with {
        briefly "Tickets reserved"
        described as {
          |Currently reserved tickets.
        }
      }
      ticketsAvailable: Natural with {
        briefly "Tickets available"
        described as {
          |Remaining available tickets.
        }
      }
      ticketsRefunded: Natural with {
        briefly "Tickets refunded"
        described as {
          |Number of refunded tickets.
        }
      }
      grossRevenue: Money with {
        briefly "Gross revenue"
        described as {
          |Total revenue from ticket sales.
        }
      }
      netRevenue: Money with {
        briefly "Net revenue"
        described as {
          |Revenue minus refunds.
        }
      }
      averageTicketPrice: Money with {
        briefly "Average price"
        described as {
          |Average price per ticket sold.
        }
      }
      salesByTier: {
        tierName: String(1,50) with {
          briefly "Tier"
          described as {
            |Pricing tier name.
          }
        }
        sold: Natural with {
          briefly "Sold"
          described as {
            |Tickets sold in this tier.
          }
        }
        revenue: Money with {
          briefly "Revenue"
          described as {
            |Revenue from this tier.
          }
        }
      }
+ with {
        briefly "Sales by tier"
        described as {
          |Breakdown of sales by pricing tier.
        }
      }
      lastUpdated: TimeStamp with {
        briefly "Updated"
        described as {
          |When metrics were last calculated.
        }
      }
    } with {
      briefly "Aggregated sales metrics for an event"
      described as {
        |Real-time sales statistics for a single event.
      }
    }
    record DailySalesMetrics is  {
      date: Date with {
        briefly "Date"
        described as {
          |The date for these metrics.
        }
      }
      totalTicketsSold: Natural with {
        briefly "Tickets sold"
        described as {
          |Total tickets sold this day.
        }
      }
      totalRevenue: Money with {
        briefly "Revenue"
        described as {
          |Total revenue for the day.
        }
      }
      ticketsByEvent: {
        eventId: EventId with {
          briefly "Event"
          described as {
            |Event identifier.
          }
        }
        eventName: String(1,200) with {
          briefly "Name"
          described as {
            |Event name.
          }
        }
        ticketsSold: Natural with {
          briefly "Sold"
          described as {
            |Tickets sold for this event.
          }
        }
        revenue: Money with {
          briefly "Revenue"
          described as {
            |Revenue for this event.
          }
        }
      }
+ with {
        briefly "Daily sales by event"
        described as {
          |Breakdown of daily sales by event.
        }
      }
      refundsProcessed: Natural with {
        briefly "Refunds"
        described as {
          |Number of refunds processed.
        }
      }
      refundTotal: Money with {
        briefly "Refund total"
        described as {
          |Total amount refunded.
        }
      }
      transfersCompleted: Natural with {
        briefly "Transfers"
        described as {
          |Number of ticket transfers.
        }
      }
    } with {
      briefly "Daily aggregated sales metrics"
      described as {
        |Aggregated sales statistics for a single day.
      }
    }
    handler SalesMetricsHandler is {
      on event Ticket.TicketPurchased is {
        prompt "Update event sales counts and revenue totals"
        prompt "Update daily sales aggregates"
        prompt "Recalculate average ticket price"
      }
      on event Ticket.TicketRefunded is {
        prompt "Decrement sales counts and adjust revenue"
        prompt "Increment refund metrics"
      }
      on event Ticket.TicketTransferred is {
        prompt "Increment transfer count for daily metrics"
      }
      on event Ticket.EventCreated is {
        prompt "Initialize event sales metrics with zero values"
      }
      on event Ticket.TicketsReleased is {
        prompt "Update available ticket count for event"
      }
    } with {
      briefly "Projects ticket events for sales analytics"
      described as {
        |Maintains real-time sales metrics from ticket events.
      }
    }
  } with {
    briefly "Projects ticket events for sales reporting"
    described as {
      | Maintains aggregated views of sales data for dashboards,
      | promoter reporting, and business intelligence. Tracks
      | sales velocity, revenue, and inventory levels in real-time.
    }
  }
} with {
  briefly "Bounded context for ticket sales"
  described as {
    | The TicketContext is the primary bounded context for the Ticket
    | Sales domain. It contains the Ticket entity, repository for
    | persistence, projector for analytics, and adaptors for
    | integration with payment, venue, and marketing systems.
  }
}
