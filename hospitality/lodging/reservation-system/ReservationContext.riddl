// Reservation System - Reservation Context

context ReservationContext is {

  include "types.riddl"
  include "Reservation.riddl"

  // Repository for reservation persistence
  repository ReservationRepository is {
    schema ReservationData is relational
      of reservations as Reservation
      index on field Reservation.reservationId
      index on field Reservation.guest.guestId
      index on field Reservation.stay.checkInDate
      index on field Reservation.stay.checkOutDate
      index on field Reservation.status

    handler ReservationPersistence is {
      on command Reservation.CreateReservation {
        prompt "Store new reservation"
      }
      on command Reservation.ModifyReservation {
        prompt "Update reservation details"
      }
      on command Reservation.ConfirmReservation {
        prompt "Update confirmation status"
      }
      on command Reservation.AssignRoom {
        prompt "Store room assignment"
      }
      on command Reservation.CheckIn {
        prompt "Update to checked in"
      }
      on command Reservation.AddCharge {
        prompt "Store charge"
      }
      on command Reservation.RecordPayment {
        prompt "Store payment"
      }
      on command Reservation.CheckOut {
        prompt "Update to checked out"
      }
      on command Reservation.CancelReservation {
        prompt "Update to cancelled"
      }
      on command Reservation.MarkNoShow {
        prompt "Update to no show"
      }
    } with {
      briefly "Persists reservation commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Reservation data persistence"
    described by {
      | The ReservationRepository provides persistent storage
      | for reservations and related data.
    }
  }

  // Projector for reservation analytics
  projector ReservationAnalytics is {
    updates repository ReservationRepository

    record OccupancyStats is {
      date is Date with { briefly "Date" described by "Statistics date." }
      totalRooms is Natural with { briefly "Total" described by "Total rooms." }
      occupiedRooms is Natural with { briefly "Occupied" described by "Occupied rooms." }
      occupancyRate is Decimal(5, 2) with { briefly "Rate" described by "Occupancy rate." }
      revenuePerRoom is Decimal(10, 2) with { briefly "RevPAR" described by "Revenue per available room." }
      averageDailyRate is Decimal(10, 2) with { briefly "ADR" described by "Average daily rate." }
    } with {
      briefly "Occupancy statistics"
      described by "Daily occupancy metrics."
    }

    handler AnalyticsHandler is {
      on event Reservation.ReservationCreated {
        prompt "Update booking metrics"
      }
      on event Reservation.GuestCheckedIn {
        prompt "Update occupancy"
      }
      on event Reservation.GuestCheckedOut {
        prompt "Update revenue metrics"
      }
      on event Reservation.ReservationCancelled {
        prompt "Update cancellation metrics"
      }
      on event Reservation.GuestMarkedNoShow {
        prompt "Update no-show metrics"
      }
    } with {
      briefly "Maintains reservation analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Reservation analytics projections"
    described by "Maintains occupancy and revenue analytics."
  }

} with {
  briefly "Bounded context for reservations"
  described by {
    | The ReservationContext is the bounded context for
    | hotel reservation management.
  }
}
