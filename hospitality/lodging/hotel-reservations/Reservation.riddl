// Hotel Reservations - Reservation Entity
entity Reservation is {
  // Commands
  command CreateReservation is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |New reservation identifier.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest information.
      }
    }
    room: RoomInfo with {
      briefly "Room"
      described as {
        |Room information.
      }
    }
    dates: StayDates with {
      briefly "Dates"
      described as {
        |Stay dates.
      }
    }
    ratePlan: RatePlan with {
      briefly "Rate"
      described as {
        |Selected rate plan.
      }
    }
  } with {
    briefly "Create reservation"
    described as {
      |Creates a new reservation.
    }
  }
  command ConfirmReservation is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment information.
      }
    }
  } with {
    briefly "Confirm reservation"
    described as {
      |Confirms with payment.
    }
  }
  command ModifyReservation is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    newDates: StayDates? with {
      briefly "New dates"
      described as {
        |Updated dates.
      }
    }
    newRoomType: RoomType? with {
      briefly "New room type"
      described as {
        |Updated room type.
      }
    }
  } with {
    briefly "Modify reservation"
    described as {
      |Modifies reservation details.
    }
  }
  command AddSpecialRequest is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    request: SpecialRequest with {
      briefly "Request"
      described as {
        |Special request.
      }
    }
  } with {
    briefly "Add special request"
    described as {
      |Adds a special request.
    }
  }
  command CheckIn is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    assignedRoom: RoomInfo with {
      briefly "Assigned room"
      described as {
        |Assigned room.
      }
    }
    keyCount: Natural with {
      briefly "Key count"
      described as {
        |Number of keys issued.
      }
    }
  } with {
    briefly "Check in"
    described as {
      |Checks guest into room.
    }
  }
  command PostCharge is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    charge: FolioItem with {
      briefly "Charge"
      described as {
        |Charge to post.
      }
    }
  } with {
    briefly "Post charge"
    described as {
      |Posts charge to folio.
    }
  }
  command CheckOut is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    finalPayment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Final payment.
      }
    }
  } with {
    briefly "Check out"
    described as {
      |Checks guest out.
    }
  }
  command CancelReservation is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation details.
      }
    }
  } with {
    briefly "Cancel reservation"
    described as {
      |Cancels reservation.
    }
  }
  command MarkNoShow is  {
    reservationId: ReservationId with {
      briefly "Reservation ID"
      described as {
        |Reservation identifier.
      }
    }
    chargeAmount: Decimal(10,2) with {
      briefly "Charge"
      described as {
        |No-show charge.
      }
    }
  } with {
    briefly "Mark no show"
    described as {
      |Marks guest as no-show.
    }
  }
  // Events
  event ReservationCreated is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest info.
      }
    }
    room: RoomInfo with {
      briefly "Room"
      described as {
        |Room info.
      }
    }
    dates: StayDates with {
      briefly "Dates"
      described as {
        |Stay dates.
      }
    }
    ratePlan: RatePlan with {
      briefly "Rate"
      described as {
        |Rate plan.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Reservation created"
    described as {
      |Emitted when reservation is created.
    }
  }
  event ReservationConfirmed is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment info.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Reservation confirmed"
    described as {
      |Emitted when reservation is confirmed.
    }
  }
  event ReservationModified is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    newDates: StayDates? with {
      briefly "Dates"
      described as {
        |New dates.
      }
    }
    newRoomType: RoomType? with {
      briefly "Room type"
      described as {
        |New room type.
      }
    }
    modifiedAt: TimeStamp with {
      briefly "Modified"
      described as {
        |Modification time.
      }
    }
  } with {
    briefly "Reservation modified"
    described as {
      |Emitted when reservation is modified.
    }
  }
  event SpecialRequestAdded is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    request: SpecialRequest with {
      briefly "Request"
      described as {
        |Special request.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Special request added"
    described as {
      |Emitted when request is added.
    }
  }
  event GuestCheckedIn is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    assignedRoom: RoomInfo with {
      briefly "Room"
      described as {
        |Assigned room.
      }
    }
    keyCount: Natural with {
      briefly "Keys"
      described as {
        |Keys issued.
      }
    }
    checkedInAt: TimeStamp with {
      briefly "Checked in"
      described as {
        |Check-in time.
      }
    }
  } with {
    briefly "Guest checked in"
    described as {
      |Emitted when guest checks in.
    }
  }
  event ChargePosted is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    charge: FolioItem with {
      briefly "Charge"
      described as {
        |Posted charge.
      }
    }
    postedAt: TimeStamp with {
      briefly "Posted"
      described as {
        |Post time.
      }
    }
  } with {
    briefly "Charge posted"
    described as {
      |Emitted when charge is posted.
    }
  }
  event GuestCheckedOut is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    finalCharges: BookingCharges with {
      briefly "Charges"
      described as {
        |Final charges.
      }
    }
    finalPayment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Final payment.
      }
    }
    checkedOutAt: TimeStamp with {
      briefly "Checked out"
      described as {
        |Check-out time.
      }
    }
  } with {
    briefly "Guest checked out"
    described as {
      |Emitted when guest checks out.
    }
  }
  event ReservationCancelled is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation info.
      }
    }
  } with {
    briefly "Reservation cancelled"
    described as {
      |Emitted when reservation is cancelled.
    }
  }
  event NoShowRecorded is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    chargeAmount: Decimal(10,2) with {
      briefly "Charge"
      described as {
        |No-show charge.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "No show recorded"
    described as {
      |Emitted when no-show is recorded.
    }
  }
  // State Records
  record ActiveStateData is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest info.
      }
    }
    room: RoomInfo with {
      briefly "Room"
      described as {
        |Room info.
      }
    }
    currentAssignedRoom: RoomInfo? with {
      briefly "Assigned"
      described as {
        |Assigned room.
      }
    }
    dates: StayDates with {
      briefly "Dates"
      described as {
        |Stay dates.
      }
    }
    ratePlan: RatePlan with {
      briefly "Rate"
      described as {
        |Rate plan.
      }
    }
    reservationStatus: ReservationStatus with {
      briefly "Status"
      described as {
        |Reservation status.
      }
    }
    confirmedPayment: PaymentInfo? with {
      briefly "Payment"
      described as {
        |Payment info.
      }
    }
    specialRequests: SpecialRequest* with {
      briefly "Requests"
      described as {
        |Special requests.
      }
    }
    folioItems: FolioItem* with {
      briefly "Folio"
      described as {
        |Folio items.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active reservation.
    }
  }
  record CompletedStateData is  {
    reservationId: ReservationId with {
      briefly "Reservation"
      described as {
        |Reservation ID.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest info.
      }
    }
    room: RoomInfo with {
      briefly "Room"
      described as {
        |Room stayed.
      }
    }
    dates: StayDates with {
      briefly "Dates"
      described as {
        |Stay dates.
      }
    }
    finalCharges: BookingCharges with {
      briefly "Charges"
      described as {
        |Final charges.
      }
    }
    checkedOutAt: TimeStamp with {
      briefly "Checked out"
      described as {
        |Check-out time.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |State for completed stay.
    }
  }
  // States
  state ActiveState of type Reservation.ActiveStateData
  state CompletedState of type Reservation.CompletedStateData
  // Handler
  handler ReservationHandler is {
    on command CreateReservation is {
      morph entity ReservationContext.Reservation to state ReservationContext.Reservation.ActiveState with command CreateReservation
      tell event ReservationCreated to entity ReservationContext.Reservation
    }
    on command ConfirmReservation is {
      tell event ReservationConfirmed to entity ReservationContext.Reservation
    }
    on command ModifyReservation is {
      tell event ReservationModified to entity ReservationContext.Reservation
    }
    on command AddSpecialRequest is {
      tell event SpecialRequestAdded to entity ReservationContext.Reservation
    }
    on command CheckIn is {
      tell event GuestCheckedIn to entity ReservationContext.Reservation
    }
    on command PostCharge is {
      tell event ChargePosted to entity ReservationContext.Reservation
    }
    on command CheckOut is {
      morph entity ReservationContext.Reservation to state ReservationContext.Reservation.CompletedState with command CheckOut
      tell event GuestCheckedOut to entity ReservationContext.Reservation
    }
    on command CancelReservation is {
      tell event ReservationCancelled to entity ReservationContext.Reservation
    }
    on command MarkNoShow is {
      tell event NoShowRecorded to entity ReservationContext.Reservation
    }
  } with {
    briefly "Processes reservation commands"
    described as {
      | Handles reservation lifecycle from booking
      | through check-in, stay, and check-out.
    }
  }
} with {
  briefly "Reservation aggregate"
  described as {
    | The Reservation entity manages hotel reservations
    | and guest stays from booking to checkout.
  }
}
