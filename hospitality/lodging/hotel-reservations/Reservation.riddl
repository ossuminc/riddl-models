// Hotel Reservations - Reservation Entity

entity Reservation is {

  // Commands
  command CreateReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "New reservation identifier."
    }
    guest is GuestInfo with {
      briefly "Guest"
      described by "Guest information."
    }
    room is RoomInfo with {
      briefly "Room"
      described by "Room information."
    }
    dates is StayDates with {
      briefly "Dates"
      described by "Stay dates."
    }
    ratePlan is RatePlan with {
      briefly "Rate"
      described by "Selected rate plan."
    }
  } with {
    briefly "Create reservation"
    described by "Creates a new reservation."
  }

  command ConfirmReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    payment is PaymentInfo with {
      briefly "Payment"
      described by "Payment information."
    }
  } with {
    briefly "Confirm reservation"
    described by "Confirms with payment."
  }

  command ModifyReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    newDates is optional StayDates with {
      briefly "New dates"
      described by "Updated dates."
    }
    newRoomType is optional RoomType with {
      briefly "New room type"
      described by "Updated room type."
    }
  } with {
    briefly "Modify reservation"
    described by "Modifies reservation details."
  }

  command AddSpecialRequest is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    request is SpecialRequest with {
      briefly "Request"
      described by "Special request."
    }
  } with {
    briefly "Add special request"
    described by "Adds a special request."
  }

  command CheckIn is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    assignedRoom is RoomInfo with {
      briefly "Assigned room"
      described by "Assigned room."
    }
    keyCount is Natural with {
      briefly "Key count"
      described by "Number of keys issued."
    }
  } with {
    briefly "Check in"
    described by "Checks guest into room."
  }

  command PostCharge is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    charge is FolioItem with {
      briefly "Charge"
      described by "Charge to post."
    }
  } with {
    briefly "Post charge"
    described by "Posts charge to folio."
  }

  command CheckOut is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    finalPayment is PaymentInfo with {
      briefly "Payment"
      described by "Final payment."
    }
  } with {
    briefly "Check out"
    described by "Checks guest out."
  }

  command CancelReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    cancellation is CancellationInfo with {
      briefly "Cancellation"
      described by "Cancellation details."
    }
  } with {
    briefly "Cancel reservation"
    described by "Cancels reservation."
  }

  command MarkNoShow is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    chargeAmount is Decimal(10, 2) with {
      briefly "Charge"
      described by "No-show charge."
    }
  } with {
    briefly "Mark no show"
    described by "Marks guest as no-show."
  }

  // Events
  event ReservationCreated is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    guest is GuestInfo with { briefly "Guest" described by "Guest info." }
    room is RoomInfo with { briefly "Room" described by "Room info." }
    dates is StayDates with { briefly "Dates" described by "Stay dates." }
    ratePlan is RatePlan with { briefly "Rate" described by "Rate plan." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Reservation created"
    described by "Emitted when reservation is created."
  }

  event ReservationConfirmed is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment info." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Reservation confirmed"
    described by "Emitted when reservation is confirmed."
  }

  event ReservationModified is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    newDates is optional StayDates with { briefly "Dates" described by "New dates." }
    newRoomType is optional RoomType with { briefly "Room type" described by "New room type." }
    modifiedAt is TimeStamp with { briefly "Modified" described by "Modification time." }
  } with {
    briefly "Reservation modified"
    described by "Emitted when reservation is modified."
  }

  event SpecialRequestAdded is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    request is SpecialRequest with { briefly "Request" described by "Special request." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Special request added"
    described by "Emitted when request is added."
  }

  event GuestCheckedIn is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    assignedRoom is RoomInfo with { briefly "Room" described by "Assigned room." }
    keyCount is Natural with { briefly "Keys" described by "Keys issued." }
    checkedInAt is TimeStamp with { briefly "Checked in" described by "Check-in time." }
  } with {
    briefly "Guest checked in"
    described by "Emitted when guest checks in."
  }

  event ChargePosted is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    charge is FolioItem with { briefly "Charge" described by "Posted charge." }
    postedAt is TimeStamp with { briefly "Posted" described by "Post time." }
  } with {
    briefly "Charge posted"
    described by "Emitted when charge is posted."
  }

  event GuestCheckedOut is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    finalCharges is BookingCharges with { briefly "Charges" described by "Final charges." }
    finalPayment is PaymentInfo with { briefly "Payment" described by "Final payment." }
    checkedOutAt is TimeStamp with { briefly "Checked out" described by "Check-out time." }
  } with {
    briefly "Guest checked out"
    described by "Emitted when guest checks out."
  }

  event ReservationCancelled is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    cancellation is CancellationInfo with { briefly "Cancellation" described by "Cancellation info." }
  } with {
    briefly "Reservation cancelled"
    described by "Emitted when reservation is cancelled."
  }

  event NoShowRecorded is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    chargeAmount is Decimal(10, 2) with { briefly "Charge" described by "No-show charge." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "No show recorded"
    described by "Emitted when no-show is recorded."
  }

  // State Records
  record ActiveStateData is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    guest is GuestInfo with { briefly "Guest" described by "Guest info." }
    room is RoomInfo with { briefly "Room" described by "Room info." }
    assignedRoom is optional RoomInfo with { briefly "Assigned" described by "Assigned room." }
    dates is StayDates with { briefly "Dates" described by "Stay dates." }
    ratePlan is RatePlan with { briefly "Rate" described by "Rate plan." }
    status is ReservationStatus with { briefly "Status" described by "Reservation status." }
    payment is optional PaymentInfo with { briefly "Payment" described by "Payment info." }
    specialRequests is many optional SpecialRequest with { briefly "Requests" described by "Special requests." }
    folioItems is many optional FolioItem with { briefly "Folio" described by "Folio items." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active reservation."
  }

  record CompletedStateData is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    guest is GuestInfo with { briefly "Guest" described by "Guest info." }
    room is RoomInfo with { briefly "Room" described by "Room stayed." }
    dates is StayDates with { briefly "Dates" described by "Stay dates." }
    finalCharges is BookingCharges with { briefly "Charges" described by "Final charges." }
    checkedOutAt is TimeStamp with { briefly "Checked out" described by "Check-out time." }
  } with {
    briefly "Completed state"
    described by "State for completed stay."
  }

  // States
  state ActiveState of Reservation.ActiveStateData with {
    briefly "Reservation active"
    described by "Reservation is active."
  }

  state CompletedState of Reservation.CompletedStateData with {
    briefly "Reservation completed"
    described by "Stay has been completed."
  }

  // Handler
  handler ReservationHandler is {
    on command CreateReservation {
      morph entity ReservationContext.Reservation to state ReservationContext.Reservation.ActiveState with command CreateReservation
      tell event ReservationCreated to entity ReservationContext.Reservation
    }

    on command ConfirmReservation {
      tell event ReservationConfirmed to entity ReservationContext.Reservation
    }

    on command ModifyReservation {
      tell event ReservationModified to entity ReservationContext.Reservation
    }

    on command AddSpecialRequest {
      tell event SpecialRequestAdded to entity ReservationContext.Reservation
    }

    on command CheckIn {
      tell event GuestCheckedIn to entity ReservationContext.Reservation
    }

    on command PostCharge {
      tell event ChargePosted to entity ReservationContext.Reservation
    }

    on command CheckOut {
      morph entity ReservationContext.Reservation to state ReservationContext.Reservation.CompletedState with command CheckOut
      tell event GuestCheckedOut to entity ReservationContext.Reservation
    }

    on command CancelReservation {
      tell event ReservationCancelled to entity ReservationContext.Reservation
    }

    on command MarkNoShow {
      tell event NoShowRecorded to entity ReservationContext.Reservation
    }
  } with {
    briefly "Processes reservation commands"
    described by {
      | Handles reservation lifecycle from booking
      | through check-in, stay, and check-out.
    }
  }

} with {
  briefly "Reservation aggregate"
  described by {
    | The Reservation entity manages hotel reservations
    | and guest stays from booking to checkout.
  }
}
