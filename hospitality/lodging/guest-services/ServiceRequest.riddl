// Guest Services - Service Request Entity
entity ServiceRequest is {
  // Commands
  command CreateServiceRequest is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |New request identifier.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest information.
      }
    }
    request: ServiceRequestDetails with {
      briefly "Request"
      described as {
        |Request details.
      }
    }
  } with {
    briefly "Create service request"
    described as {
      |Creates a new service request.
    }
  }
  command UpdateRequestDetails is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    newDetails: ServiceRequestDetails with {
      briefly "Details"
      described as {
        |Updated details.
      }
    }
  } with {
    briefly "Update request"
    described as {
      |Updates request details.
    }
  }
  command AssignStaff is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    assignment: StaffAssignment with {
      briefly "Assignment"
      described as {
        |Staff assignment.
      }
    }
  } with {
    briefly "Assign staff"
    described as {
      |Assigns staff to request.
    }
  }
  command StartService is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    staffId: StaffId with {
      briefly "Staff"
      described as {
        |Staff starting service.
      }
    }
  } with {
    briefly "Start service"
    described as {
      |Starts working on request.
    }
  }
  command CompleteService is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    completion: ServiceCompletion with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
  } with {
    briefly "Complete service"
    described as {
      |Marks service as complete.
    }
  }
  command CancelRequest is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,200) with {
      briefly "By"
      described as {
        |Who cancelled.
      }
    }
  } with {
    briefly "Cancel request"
    described as {
      |Cancels the service request.
    }
  }
  command EscalateRequest is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Escalation reason.
      }
    }
    newPriority: RequestPriority with {
      briefly "Priority"
      described as {
        |New priority level.
      }
    }
  } with {
    briefly "Escalate request"
    described as {
      |Escalates request priority.
    }
  }
  command RecordFeedback is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    feedback: GuestFeedback with {
      briefly "Feedback"
      described as {
        |Guest feedback.
      }
    }
  } with {
    briefly "Record feedback"
    described as {
      |Records guest feedback.
    }
  }
  command AddRoomServiceOrder is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    roomServiceOrder: RoomServiceOrder with {
      briefly "Order"
      described as {
        |Room service order.
      }
    }
  } with {
    briefly "Add room service order"
    described as {
      |Attaches room service order.
    }
  }
  command AddLaundryOrder is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    laundryOrder: LaundryOrder with {
      briefly "Order"
      described as {
        |Laundry order.
      }
    }
  } with {
    briefly "Add laundry order"
    described as {
      |Attaches laundry order.
    }
  }
  command ScheduleWakeupCall is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request identifier.
      }
    }
    wakeupCall: WakeupCallRequest with {
      briefly "Wakeup"
      described as {
        |Wakeup call details.
      }
    }
  } with {
    briefly "Schedule wakeup call"
    described as {
      |Schedules a wakeup call.
    }
  }
  // Events
  event ServiceRequestCreated is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest info.
      }
    }
    request: ServiceRequestDetails with {
      briefly "Request"
      described as {
        |Request details.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Service request created"
    described as {
      |Emitted when request is created.
    }
  }
  event RequestDetailsUpdated is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    newDetails: ServiceRequestDetails with {
      briefly "Details"
      described as {
        |New details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Request updated"
    described as {
      |Emitted when request is updated.
    }
  }
  event StaffAssigned is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    assignment: StaffAssignment with {
      briefly "Assignment"
      described as {
        |Staff assignment.
      }
    }
  } with {
    briefly "Staff assigned"
    described as {
      |Emitted when staff is assigned.
    }
  }
  event ServiceStarted is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    staffId: StaffId with {
      briefly "Staff"
      described as {
        |Staff ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Service started"
    described as {
      |Emitted when service starts.
    }
  }
  event ServiceCompleted is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    completion: ServiceCompletion with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
  } with {
    briefly "Service completed"
    described as {
      |Emitted when service completes.
    }
  }
  event RequestCancelled is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Request cancelled"
    described as {
      |Emitted when request is cancelled.
    }
  }
  event RequestEscalated is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Escalation reason.
      }
    }
    newPriority: RequestPriority with {
      briefly "Priority"
      described as {
        |New priority.
      }
    }
    escalatedAt: TimeStamp with {
      briefly "Escalated"
      described as {
        |Escalation time.
      }
    }
  } with {
    briefly "Request escalated"
    described as {
      |Emitted when request is escalated.
    }
  }
  event FeedbackRecorded is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    feedback: GuestFeedback with {
      briefly "Feedback"
      described as {
        |Guest feedback.
      }
    }
  } with {
    briefly "Feedback recorded"
    described as {
      |Emitted when feedback is recorded.
    }
  }
  event RoomServiceOrderAdded is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    roomServiceOrder: RoomServiceOrder with {
      briefly "Order"
      described as {
        |Room service order.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Room service order added"
    described as {
      |Emitted when room service is ordered.
    }
  }
  event LaundryOrderAdded is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    laundryOrder: LaundryOrder with {
      briefly "Order"
      described as {
        |Laundry order.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Laundry order added"
    described as {
      |Emitted when laundry is ordered.
    }
  }
  event WakeupCallScheduled is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    wakeupCall: WakeupCallRequest with {
      briefly "Wakeup"
      described as {
        |Wakeup call.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Schedule time.
      }
    }
  } with {
    briefly "Wakeup call scheduled"
    described as {
      |Emitted when wakeup call is scheduled.
    }
  }
  // State Records
  record ActiveStateData is  {
    requestId: ServiceRequestId with {
      briefly "Request"
      described as {
        |Request ID.
      }
    }
    guest: GuestInfo with {
      briefly "Guest"
      described as {
        |Guest information.
      }
    }
    request: ServiceRequestDetails with {
      briefly "Request"
      described as {
        |Request details.
      }
    }
    currentAssignment: StaffAssignment? with {
      briefly "Assignment"
      described as {
        |Staff assignment.
      }
    }
    status: RequestStatus with {
      briefly "Status"
      described as {
        |Request status.
      }
    }
    completionRecord: ServiceCompletion? with {
      briefly "Completion"
      described as {
        |Completion details.
      }
    }
    guestFeedback: GuestFeedback? with {
      briefly "Feedback"
      described as {
        |Guest feedback.
      }
    }
    currentRoomServiceOrder: RoomServiceOrder? with {
      briefly "Room service"
      described as {
        |Room service order.
      }
    }
    currentLaundryOrder: LaundryOrder? with {
      briefly "Laundry"
      described as {
        |Laundry order.
      }
    }
    scheduledWakeupCall: WakeupCallRequest? with {
      briefly "Wakeup"
      described as {
        |Wakeup call.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active service request.
    }
  }
  // States
  state ActiveState of type ServiceRequest.ActiveStateData
  // Handler
  handler ServiceRequestHandler is {
    on command CreateServiceRequest is {
      morph entity ServiceRequestContext.ServiceRequest to state ServiceRequestContext.ServiceRequest.ActiveState with command CreateServiceRequest
      tell event ServiceRequestCreated to entity ServiceRequestContext.ServiceRequest
    }
    on command UpdateRequestDetails is {
      tell event RequestDetailsUpdated to entity ServiceRequestContext.ServiceRequest
    }
    on command AssignStaff is {
      tell event StaffAssigned to entity ServiceRequestContext.ServiceRequest
    }
    on command StartService is {
      tell event ServiceStarted to entity ServiceRequestContext.ServiceRequest
    }
    on command CompleteService is {
      tell event ServiceCompleted to entity ServiceRequestContext.ServiceRequest
    }
    on command CancelRequest is {
      tell event RequestCancelled to entity ServiceRequestContext.ServiceRequest
    }
    on command EscalateRequest is {
      tell event RequestEscalated to entity ServiceRequestContext.ServiceRequest
    }
    on command RecordFeedback is {
      tell event FeedbackRecorded to entity ServiceRequestContext.ServiceRequest
    }
    on command AddRoomServiceOrder is {
      tell event RoomServiceOrderAdded to entity ServiceRequestContext.ServiceRequest
    }
    on command AddLaundryOrder is {
      tell event LaundryOrderAdded to entity ServiceRequestContext.ServiceRequest
    }
    on command ScheduleWakeupCall is {
      tell event WakeupCallScheduled to entity ServiceRequestContext.ServiceRequest
    }
  } with {
    briefly "Processes service request commands"
    described as {
      | Handles service request lifecycle from creation
      | through completion and feedback.
    }
  }
} with {
  briefly "Service request aggregate"
  described as {
    | The ServiceRequest entity manages guest service
    | requests and their fulfillment.
  }
}
