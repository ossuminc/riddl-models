// Guest Services - Service Request Entity

entity ServiceRequest is {

  // Commands
  command CreateServiceRequest is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "New request identifier."
    }
    guest is GuestInfo with {
      briefly "Guest"
      described by "Guest information."
    }
    request is ServiceRequestDetails with {
      briefly "Request"
      described by "Request details."
    }
  } with {
    briefly "Create service request"
    described by "Creates a new service request."
  }

  command UpdateRequestDetails is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    newDetails is ServiceRequestDetails with {
      briefly "Details"
      described by "Updated details."
    }
  } with {
    briefly "Update request"
    described by "Updates request details."
  }

  command AssignStaff is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    assignment is StaffAssignment with {
      briefly "Assignment"
      described by "Staff assignment."
    }
  } with {
    briefly "Assign staff"
    described by "Assigns staff to request."
  }

  command StartService is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started"
      described by "Start time."
    }
    staffId is StaffId with {
      briefly "Staff"
      described by "Staff starting service."
    }
  } with {
    briefly "Start service"
    described by "Starts working on request."
  }

  command CompleteService is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    completion is ServiceCompletion with {
      briefly "Completion"
      described by "Completion details."
    }
  } with {
    briefly "Complete service"
    described by "Marks service as complete."
  }

  command CancelRequest is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 200) with {
      briefly "By"
      described by "Who cancelled."
    }
  } with {
    briefly "Cancel request"
    described by "Cancels the service request."
  }

  command EscalateRequest is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Escalation reason."
    }
    newPriority is RequestPriority with {
      briefly "Priority"
      described by "New priority level."
    }
  } with {
    briefly "Escalate request"
    described by "Escalates request priority."
  }

  command RecordFeedback is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    feedback is GuestFeedback with {
      briefly "Feedback"
      described by "Guest feedback."
    }
  } with {
    briefly "Record feedback"
    described by "Records guest feedback."
  }

  command AddRoomServiceOrder is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    order is RoomServiceOrder with {
      briefly "Order"
      described by "Room service order."
    }
  } with {
    briefly "Add room service order"
    described by "Attaches room service order."
  }

  command AddLaundryOrder is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    order is LaundryOrder with {
      briefly "Order"
      described by "Laundry order."
    }
  } with {
    briefly "Add laundry order"
    described by "Attaches laundry order."
  }

  command ScheduleWakeupCall is {
    requestId is ServiceRequestId with {
      briefly "Request"
      described by "Request identifier."
    }
    wakeupCall is WakeupCallRequest with {
      briefly "Wakeup"
      described by "Wakeup call details."
    }
  } with {
    briefly "Schedule wakeup call"
    described by "Schedules a wakeup call."
  }

  // Events
  event ServiceRequestCreated is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    guest is GuestInfo with { briefly "Guest" described by "Guest info." }
    request is ServiceRequestDetails with { briefly "Request" described by "Request details." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Service request created"
    described by "Emitted when request is created."
  }

  event RequestDetailsUpdated is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    newDetails is ServiceRequestDetails with { briefly "Details" described by "New details." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Request updated"
    described by "Emitted when request is updated."
  }

  event StaffAssigned is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    assignment is StaffAssignment with { briefly "Assignment" described by "Staff assignment." }
  } with {
    briefly "Staff assigned"
    described by "Emitted when staff is assigned."
  }

  event ServiceStarted is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    staffId is StaffId with { briefly "Staff" described by "Staff ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Service started"
    described by "Emitted when service starts."
  }

  event ServiceCompleted is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    completion is ServiceCompletion with { briefly "Completion" described by "Completion details." }
  } with {
    briefly "Service completed"
    described by "Emitted when service completes."
  }

  event RequestCancelled is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Request cancelled"
    described by "Emitted when request is cancelled."
  }

  event RequestEscalated is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Escalation reason." }
    newPriority is RequestPriority with { briefly "Priority" described by "New priority." }
    escalatedAt is TimeStamp with { briefly "Escalated" described by "Escalation time." }
  } with {
    briefly "Request escalated"
    described by "Emitted when request is escalated."
  }

  event FeedbackRecorded is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    feedback is GuestFeedback with { briefly "Feedback" described by "Guest feedback." }
  } with {
    briefly "Feedback recorded"
    described by "Emitted when feedback is recorded."
  }

  event RoomServiceOrderAdded is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    order is RoomServiceOrder with { briefly "Order" described by "Room service order." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Room service order added"
    described by "Emitted when room service is ordered."
  }

  event LaundryOrderAdded is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    order is LaundryOrder with { briefly "Order" described by "Laundry order." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Laundry order added"
    described by "Emitted when laundry is ordered."
  }

  event WakeupCallScheduled is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    wakeupCall is WakeupCallRequest with { briefly "Wakeup" described by "Wakeup call." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Wakeup call scheduled"
    described by "Emitted when wakeup call is scheduled."
  }

  // State Records
  record ActiveStateData is {
    requestId is ServiceRequestId with { briefly "Request" described by "Request ID." }
    guest is GuestInfo with { briefly "Guest" described by "Guest information." }
    request is ServiceRequestDetails with { briefly "Request" described by "Request details." }
    assignment is optional StaffAssignment with { briefly "Assignment" described by "Staff assignment." }
    status is RequestStatus with { briefly "Status" described by "Request status." }
    completion is optional ServiceCompletion with { briefly "Completion" described by "Completion details." }
    feedback is optional GuestFeedback with { briefly "Feedback" described by "Guest feedback." }
    roomServiceOrder is optional RoomServiceOrder with { briefly "Room service" described by "Room service order." }
    laundryOrder is optional LaundryOrder with { briefly "Laundry" described by "Laundry order." }
    wakeupCall is optional WakeupCallRequest with { briefly "Wakeup" described by "Wakeup call." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active service request."
  }

  // States
  state ActiveState of ServiceRequest.ActiveStateData with {
    briefly "Service request active"
    described by "Service request is active."
  }

  // Handler
  handler ServiceRequestHandler is {
    on command CreateServiceRequest {
      morph entity ServiceRequestContext.ServiceRequest to state ServiceRequestContext.ServiceRequest.ActiveState with command CreateServiceRequest
      tell event ServiceRequestCreated to entity ServiceRequestContext.ServiceRequest
    }

    on command UpdateRequestDetails {
      tell event RequestDetailsUpdated to entity ServiceRequestContext.ServiceRequest
    }

    on command AssignStaff {
      tell event StaffAssigned to entity ServiceRequestContext.ServiceRequest
    }

    on command StartService {
      tell event ServiceStarted to entity ServiceRequestContext.ServiceRequest
    }

    on command CompleteService {
      tell event ServiceCompleted to entity ServiceRequestContext.ServiceRequest
    }

    on command CancelRequest {
      tell event RequestCancelled to entity ServiceRequestContext.ServiceRequest
    }

    on command EscalateRequest {
      tell event RequestEscalated to entity ServiceRequestContext.ServiceRequest
    }

    on command RecordFeedback {
      tell event FeedbackRecorded to entity ServiceRequestContext.ServiceRequest
    }

    on command AddRoomServiceOrder {
      tell event RoomServiceOrderAdded to entity ServiceRequestContext.ServiceRequest
    }

    on command AddLaundryOrder {
      tell event LaundryOrderAdded to entity ServiceRequestContext.ServiceRequest
    }

    on command ScheduleWakeupCall {
      tell event WakeupCallScheduled to entity ServiceRequestContext.ServiceRequest
    }
  } with {
    briefly "Processes service request commands"
    described by {
      | Handles service request lifecycle from creation
      | through completion and feedback.
    }
  }

} with {
  briefly "Service request aggregate"
  described by {
    | The ServiceRequest entity manages guest service
    | requests and their fulfillment.
  }
}
