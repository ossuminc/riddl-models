// Airline Reservations - Reservation Entity

entity Reservation is {

  // Commands
  command CreateReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "New reservation identifier."
    }
    passenger is PassengerInfo with {
      briefly "Passenger"
      described by "Passenger information."
    }
    tripType is TripType with {
      briefly "Trip type"
      described by "Type of trip."
    }
    segments is many FlightSegment with {
      briefly "Segments"
      described by "Flight segments."
    }
  } with {
    briefly "Create reservation"
    described by "Creates a new flight reservation."
  }

  command SelectSeat is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment number."
    }
    seat is SeatInfo with {
      briefly "Seat"
      described by "Selected seat."
    }
  } with {
    briefly "Select seat"
    described by "Selects seat for segment."
  }

  command AddExtraBaggage is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    baggage is ExtraBaggage with {
      briefly "Baggage"
      described by "Extra baggage."
    }
  } with {
    briefly "Add extra baggage"
    described by "Adds extra baggage."
  }

  command SetMealPreference is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment number."
    }
    meal is MealPreference with {
      briefly "Meal"
      described by "Meal preference."
    }
  } with {
    briefly "Set meal preference"
    described by "Sets meal preference."
  }

  command RequestSpecialService is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    service is SpecialService with {
      briefly "Service"
      described by "Special service."
    }
  } with {
    briefly "Request special service"
    described by "Requests special assistance."
  }

  command ProcessPayment is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    paymentToken is String(1, 200) with {
      briefly "Token"
      described by "Payment token."
    }
  } with {
    briefly "Process payment"
    described by "Processes reservation payment."
  }

  command ConfirmReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    confirmationCode is String(6, 6) with {
      briefly "Confirmation"
      described by "Confirmation code."
    }
  } with {
    briefly "Confirm reservation"
    described by "Confirms the reservation."
  }

  command CheckIn is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment number."
    }
    checkedInBy is String(1, 200) with {
      briefly "Checked in by"
      described by "Who performed check-in."
    }
  } with {
    briefly "Check in"
    described by "Checks in for flight."
  }

  command IssueBoardingPass is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment number."
    }
    boardingPass is BoardingPass with {
      briefly "Boarding pass"
      described by "Boarding pass details."
    }
  } with {
    briefly "Issue boarding pass"
    described by "Issues boarding pass."
  }

  command BoardFlight is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment number."
    }
    boardedAt is TimeStamp with {
      briefly "Boarded"
      described by "Boarding time."
    }
  } with {
    briefly "Board flight"
    described by "Records boarding."
  }

  command ChangeFlightSegment is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    segmentNumber is Natural with {
      briefly "Segment"
      described by "Segment to change."
    }
    newFlight is FlightInfo with {
      briefly "New flight"
      described by "New flight info."
    }
  } with {
    briefly "Change flight"
    described by "Changes flight segment."
  }

  command CancelReservation is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    requestRefund is Boolean with {
      briefly "Refund"
      described by "Whether to request refund."
    }
  } with {
    briefly "Cancel reservation"
    described by "Cancels the reservation."
  }

  command ProcessRefund is {
    reservationId is ReservationId with {
      briefly "Reservation ID"
      described by "Reservation identifier."
    }
    refundAmount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Refund amount."
    }
  } with {
    briefly "Process refund"
    described by "Processes refund."
  }

  // Events
  event ReservationCreated is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    passenger is PassengerInfo with { briefly "Passenger" described by "Passenger info." }
    tripType is TripType with { briefly "Trip" described by "Trip type." }
    segments is many FlightSegment with { briefly "Segments" described by "Flight segments." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Reservation created"
    described by "Emitted when reservation is created."
  }

  event SeatSelected is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    seat is SeatInfo with { briefly "Seat" described by "Selected seat." }
    selectedAt is TimeStamp with { briefly "Selected" described by "Selection time." }
  } with {
    briefly "Seat selected"
    described by "Emitted when seat is selected."
  }

  event ExtraBaggageAdded is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    baggage is ExtraBaggage with { briefly "Baggage" described by "Extra baggage." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Extra baggage added"
    described by "Emitted when baggage is added."
  }

  event MealPreferenceSet is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    meal is MealPreference with { briefly "Meal" described by "Meal preference." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Meal preference set"
    described by "Emitted when meal is set."
  }

  event SpecialServiceRequested is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    service is SpecialService with { briefly "Service" described by "Special service." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Special service requested"
    described by "Emitted when service is requested."
  }

  event PaymentProcessed is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event ReservationConfirmed is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    confirmationCode is String(6, 6) with { briefly "Confirmation" described by "Confirmation code." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Reservation confirmed"
    described by "Emitted when reservation is confirmed."
  }

  event PassengerCheckedIn is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    checkedInAt is TimeStamp with { briefly "Checked in" described by "Check-in time." }
  } with {
    briefly "Passenger checked in"
    described by "Emitted when passenger checks in."
  }

  event BoardingPassIssued is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    boardingPass is BoardingPass with { briefly "Pass" described by "Boarding pass." }
  } with {
    briefly "Boarding pass issued"
    described by "Emitted when pass is issued."
  }

  event PassengerBoarded is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    boardedAt is TimeStamp with { briefly "Boarded" described by "Boarding time." }
  } with {
    briefly "Passenger boarded"
    described by "Emitted when passenger boards."
  }

  event FlightSegmentChanged is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    segmentNumber is Natural with { briefly "Segment" described by "Segment number." }
    previousFlight is FlightInfo with { briefly "Previous" described by "Previous flight." }
    newFlight is FlightInfo with { briefly "New" described by "New flight." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Flight segment changed"
    described by "Emitted when flight is changed."
  }

  event ReservationCancelled is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Reservation cancelled"
    described by "Emitted when reservation is cancelled."
  }

  event RefundProcessed is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    refundAmount is Decimal(10, 2) with { briefly "Amount" described by "Refund amount." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Refund processed"
    described by "Emitted when refund is processed."
  }

  // State Records
  record ActiveStateData is {
    reservationId is ReservationId with { briefly "Reservation" described by "Reservation ID." }
    passenger is PassengerInfo with { briefly "Passenger" described by "Passenger info." }
    tripType is TripType with { briefly "Trip" described by "Trip type." }
    segments is many FlightSegment with { briefly "Segments" described by "Flight segments." }
    confirmationCode is optional String(6, 6) with { briefly "Confirmation" described by "Confirmation code." }
    extraBaggage is optional ExtraBaggage with { briefly "Baggage" described by "Extra baggage." }
    mealPreferences is many optional MealPreference with { briefly "Meals" described by "Meal preferences." }
    specialServices is many optional SpecialService with { briefly "Services" described by "Special services." }
    pricing is ReservationPricing with { briefly "Pricing" described by "Pricing info." }
    boardingPasses is many optional BoardingPass with { briefly "Passes" described by "Boarding passes." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active reservation."
  }

  // States
  state ActiveState of Reservation.ActiveStateData with {
    briefly "Reservation active"
    described by "Reservation is active."
  }

  // Handler
  handler ReservationHandler is {
    on command CreateReservation {
      morph entity ReservationContext.Reservation to state ReservationContext.Reservation.ActiveState with command CreateReservation
      tell event ReservationCreated to entity ReservationContext.Reservation
    }

    on command SelectSeat {
      tell event SeatSelected to entity ReservationContext.Reservation
    }

    on command AddExtraBaggage {
      tell event ExtraBaggageAdded to entity ReservationContext.Reservation
    }

    on command SetMealPreference {
      tell event MealPreferenceSet to entity ReservationContext.Reservation
    }

    on command RequestSpecialService {
      tell event SpecialServiceRequested to entity ReservationContext.Reservation
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity ReservationContext.Reservation
    }

    on command ConfirmReservation {
      tell event ReservationConfirmed to entity ReservationContext.Reservation
    }

    on command CheckIn {
      tell event PassengerCheckedIn to entity ReservationContext.Reservation
    }

    on command IssueBoardingPass {
      tell event BoardingPassIssued to entity ReservationContext.Reservation
    }

    on command BoardFlight {
      tell event PassengerBoarded to entity ReservationContext.Reservation
    }

    on command ChangeFlightSegment {
      tell event FlightSegmentChanged to entity ReservationContext.Reservation
    }

    on command CancelReservation {
      tell event ReservationCancelled to entity ReservationContext.Reservation
    }

    on command ProcessRefund {
      tell event RefundProcessed to entity ReservationContext.Reservation
    }
  } with {
    briefly "Processes reservation commands"
    described by {
      | Handles reservation lifecycle from booking
      | through check-in and boarding.
    }
  }

} with {
  briefly "Reservation aggregate"
  described by {
    | The Reservation entity manages flight reservations
    | and their lifecycle through travel completion.
  }
}
