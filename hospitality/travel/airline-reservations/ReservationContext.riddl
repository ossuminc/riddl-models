// Airline Reservations - Reservation Context

context ReservationContext is {

  include "types.riddl"
  include "Reservation.riddl"

  // Repository for reservation persistence
  repository ReservationRepository is {
    schema ReservationData is relational
      of reservations as Reservation
      index on field Reservation.reservationId
      index on field Reservation.passenger.passengerId
      index on field Reservation.confirmationCode

    handler ReservationPersistence is {
      on command Reservation.CreateReservation {
        prompt "Store new reservation"
      }
      on command Reservation.SelectSeat {
        prompt "Update seat assignment"
      }
      on command Reservation.AddExtraBaggage {
        prompt "Store extra baggage"
      }
      on command Reservation.SetMealPreference {
        prompt "Store meal preference"
      }
      on command Reservation.RequestSpecialService {
        prompt "Store special service"
      }
      on command Reservation.ProcessPayment {
        prompt "Store payment"
      }
      on command Reservation.ConfirmReservation {
        prompt "Update to confirmed"
      }
      on command Reservation.CheckIn {
        prompt "Update to checked in"
      }
      on command Reservation.IssueBoardingPass {
        prompt "Store boarding pass"
      }
      on command Reservation.BoardFlight {
        prompt "Update to boarded"
      }
      on command Reservation.ChangeFlightSegment {
        prompt "Update flight segment"
      }
      on command Reservation.CancelReservation {
        prompt "Update to cancelled"
      }
      on command Reservation.ProcessRefund {
        prompt "Store refund"
      }
    } with {
      briefly "Persists reservation commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Reservation data persistence"
    described by {
      | The ReservationRepository provides persistent storage for
      | reservations and related data.
    }
  }

  // Projector for airline analytics
  projector AirlineAnalytics is {
    updates repository ReservationRepository

    record AirlineStats is {
      totalReservations is Natural with { briefly "Total" described by "Total reservations." }
      confirmedReservations is Natural with { briefly "Confirmed" described by "Confirmed reservations." }
      checkedInCount is Natural with { briefly "Checked in" described by "Checked in count." }
      cancelledReservations is Natural with { briefly "Cancelled" described by "Cancelled reservations." }
      totalRevenue is Decimal(12, 2) with { briefly "Revenue" described by "Total revenue." }
      loadFactor is Decimal(5, 2) with { briefly "Load factor" described by "Seat occupancy rate." }
    } with {
      briefly "Airline statistics"
      described by "Airline booking metrics."
    }

    handler AnalyticsHandler is {
      on event Reservation.ReservationCreated {
        prompt "Update reservation counts"
      }
      on event Reservation.ReservationConfirmed {
        prompt "Update confirmed counts"
      }
      on event Reservation.PaymentProcessed {
        prompt "Update revenue metrics"
      }
      on event Reservation.PassengerCheckedIn {
        prompt "Update check-in metrics"
      }
      on event Reservation.ReservationCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains airline analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Airline analytics projections"
    described by "Maintains airline booking analytics data."
  }

} with {
  briefly "Bounded context for airline reservations"
  described by {
    | The ReservationContext is the bounded context for
    | flight reservations and passenger management.
  }
}
