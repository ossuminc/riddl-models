// Airline Reservations - Reservation Context

context ReservationContext is {

  include "types.riddl"
  include "Reservation.riddl"

  // Repository for reservation persistence
  repository ReservationRepository is {
    schema ReservationData is relational
      of reservations as Reservation
      index on field Reservation.reservationId
      index on field Reservation.passenger.passengerId
      index on field Reservation.confirmationCode

    handler ReservationPersistence is {
      on event Reservation.ReservationCreated {
        prompt "Store new reservation"
      }
      on event Reservation.SeatSelected {
        prompt "Update seat assignment"
      }
      on event Reservation.ExtraBaggageAdded {
        prompt "Store extra baggage"
      }
      on event Reservation.MealPreferenceSet {
        prompt "Store meal preference"
      }
      on event Reservation.SpecialServiceRequested {
        prompt "Store special service"
      }
      on event Reservation.PaymentProcessed {
        prompt "Store payment"
      }
      on event Reservation.ReservationConfirmed {
        prompt "Update to confirmed"
      }
      on event Reservation.PassengerCheckedIn {
        prompt "Update to checked in"
      }
      on event Reservation.BoardingPassIssued {
        prompt "Store boarding pass"
      }
      on event Reservation.PassengerBoarded {
        prompt "Update to boarded"
      }
      on event Reservation.FlightSegmentChanged {
        prompt "Update flight segment"
      }
      on event Reservation.ReservationCancelled {
        prompt "Update to cancelled"
      }
      on event Reservation.RefundProcessed {
        prompt "Store refund"
      }
    } with {
      briefly "Persists reservation events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Reservation data persistence"
    described by {
      | The ReservationRepository provides persistent storage for
      | reservations and related data.
    }
  }

  // Projector for airline analytics
  projector AirlineAnalytics is {
    updates repository ReservationRepository

    record AirlineStats is {
      totalReservations is Natural with { briefly "Total" described by "Total reservations." }
      confirmedReservations is Natural with { briefly "Confirmed" described by "Confirmed reservations." }
      checkedInCount is Natural with { briefly "Checked in" described by "Checked in count." }
      cancelledReservations is Natural with { briefly "Cancelled" described by "Cancelled reservations." }
      totalRevenue is Decimal(12, 2) with { briefly "Revenue" described by "Total revenue." }
      loadFactor is Decimal(5, 2) with { briefly "Load factor" described by "Seat occupancy rate." }
    } with {
      briefly "Airline statistics"
      described by "Airline booking metrics."
    }

    handler AnalyticsHandler is {
      on event Reservation.ReservationCreated {
        prompt "Update reservation counts"
      }
      on event Reservation.ReservationConfirmed {
        prompt "Update confirmed counts"
      }
      on event Reservation.PaymentProcessed {
        prompt "Update revenue metrics"
      }
      on event Reservation.PassengerCheckedIn {
        prompt "Update check-in metrics"
      }
      on event Reservation.ReservationCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains airline analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Airline analytics projections"
    described by "Maintains airline booking analytics data."
  }

} with {
  briefly "Bounded context for airline reservations"
  described by {
    | The ReservationContext is the bounded context for
    | flight reservations and passenger management.
  }
}
