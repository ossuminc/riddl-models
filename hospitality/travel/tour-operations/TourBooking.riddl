// Tour Operations - TourBooking Entity

entity TourBooking is {

  // Commands
  command CreateBooking is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "New booking identifier."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    tour is TourInfo with {
      briefly "Tour"
      described by "Tour information."
    }
    departure is TourDeparture with {
      briefly "Departure"
      described by "Selected departure."
    }
    participants is many ParticipantInfo with {
      briefly "Participants"
      described by "Tour participants."
    }
  } with {
    briefly "Create booking"
    described by "Creates a new tour booking."
  }

  command AddParticipant is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    participant is ParticipantInfo with {
      briefly "Participant"
      described by "Participant to add."
    }
  } with {
    briefly "Add participant"
    described by "Adds participant to booking."
  }

  command RemoveParticipant is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    participantName is String(1, 200) with {
      briefly "Name"
      described by "Participant name."
    }
  } with {
    briefly "Remove participant"
    described by "Removes participant."
  }

  command AddAddOn is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    addOn is TourAddOn with {
      briefly "Add-on"
      described by "Add-on to include."
    }
  } with {
    briefly "Add add-on"
    described by "Adds optional add-on."
  }

  command ProcessDeposit is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Deposit amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    paymentToken is String(1, 200) with {
      briefly "Token"
      described by "Payment token."
    }
  } with {
    briefly "Process deposit"
    described by "Processes deposit payment."
  }

  command ConfirmBooking is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    confirmationCode is String(1, 20) with {
      briefly "Confirmation"
      described by "Confirmation code."
    }
  } with {
    briefly "Confirm booking"
    described by "Confirms the booking."
  }

  command ProcessFinalPayment is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Payment amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    paymentToken is String(1, 200) with {
      briefly "Token"
      described by "Payment token."
    }
  } with {
    briefly "Process final payment"
    described by "Processes final payment."
  }

  command CheckIn is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    checkIn is TourCheckIn with {
      briefly "Check-in"
      described by "Check-in details."
    }
  } with {
    briefly "Check in"
    described by "Checks in for tour."
  }

  command StartTour is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started"
      described by "Tour start time."
    }
  } with {
    briefly "Start tour"
    described by "Marks tour as started."
  }

  command CompleteTour is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
  } with {
    briefly "Complete tour"
    described by "Marks tour as completed."
  }

  command SubmitReview is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    rating is Natural with {
      briefly "Rating"
      described by "Star rating (1-5)."
    }
    review is optional String(1, 2000) with {
      briefly "Review"
      described by "Written review."
    }
  } with {
    briefly "Submit review"
    described by "Submits tour review."
  }

  command CancelBooking is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    requestRefund is Boolean with {
      briefly "Refund"
      described by "Whether to request refund."
    }
  } with {
    briefly "Cancel booking"
    described by "Cancels the booking."
  }

  command ProcessRefund is {
    bookingId is TourBookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    refundAmount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Refund amount."
    }
  } with {
    briefly "Process refund"
    described by "Processes refund."
  }

  // Events
  event BookingCreated is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    tour is TourInfo with { briefly "Tour" described by "Tour info." }
    departure is TourDeparture with { briefly "Departure" described by "Departure info." }
    participants is many ParticipantInfo with { briefly "Participants" described by "Participants." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Booking created"
    described by "Emitted when booking is created."
  }

  event ParticipantAdded is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    participant is ParticipantInfo with { briefly "Participant" described by "Added participant." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Participant added"
    described by "Emitted when participant is added."
  }

  event ParticipantRemoved is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    participantName is String(1, 200) with { briefly "Name" described by "Removed participant." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Participant removed"
    described by "Emitted when participant is removed."
  }

  event AddOnAdded is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    addOn is TourAddOn with { briefly "Add-on" described by "Added add-on." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Add-on added"
    described by "Emitted when add-on is added."
  }

  event DepositProcessed is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Deposit amount." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Deposit processed"
    described by "Emitted when deposit is processed."
  }

  event BookingConfirmed is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    confirmationCode is String(1, 20) with { briefly "Confirmation" described by "Confirmation code." }
    pricing is BookingPricing with { briefly "Pricing" described by "Pricing details." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Booking confirmed"
    described by "Emitted when booking is confirmed."
  }

  event FinalPaymentProcessed is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Final payment processed"
    described by "Emitted when final payment is processed."
  }

  event GuestCheckedIn is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    checkIn is TourCheckIn with { briefly "Check-in" described by "Check-in details." }
  } with {
    briefly "Guest checked in"
    described by "Emitted when guest checks in."
  }

  event TourStarted is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Tour started"
    described by "Emitted when tour starts."
  }

  event TourCompleted is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Tour completed"
    described by "Emitted when tour completes."
  }

  event ReviewSubmitted is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    rating is Natural with { briefly "Rating" described by "Star rating." }
    review is optional String(1, 2000) with { briefly "Review" described by "Written review." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submit time." }
  } with {
    briefly "Review submitted"
    described by "Emitted when review is submitted."
  }

  event BookingCancelled is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Booking cancelled"
    described by "Emitted when booking is cancelled."
  }

  event RefundProcessed is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    refundAmount is Decimal(10, 2) with { briefly "Amount" described by "Refund amount." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Refund processed"
    described by "Emitted when refund is processed."
  }

  // State Records
  record ActiveStateData is {
    bookingId is TourBookingId with { briefly "Booking" described by "Booking ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    tour is TourInfo with { briefly "Tour" described by "Tour info." }
    departure is TourDeparture with { briefly "Departure" described by "Departure info." }
    participants is many ParticipantInfo with { briefly "Participants" described by "Participants." }
    addOns is many optional TourAddOn with { briefly "Add-ons" described by "Add-ons." }
    status is BookingStatus with { briefly "Status" described by "Booking status." }
    confirmationCode is optional String(1, 20) with { briefly "Confirmation" described by "Confirmation code." }
    pricing is optional BookingPricing with { briefly "Pricing" described by "Pricing info." }
    checkIn is optional TourCheckIn with { briefly "Check-in" described by "Check-in record." }
    review is optional String(1, 2000) with { briefly "Review" described by "Customer review." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active booking."
  }

  // States
  state ActiveState of TourBooking.ActiveStateData with {
    briefly "Booking active"
    described by "Booking is active."
  }

  // Handler
  handler TourBookingHandler is {
    on command CreateBooking {
      morph entity TourContext.TourBooking to state TourContext.TourBooking.ActiveState with command CreateBooking
      tell event BookingCreated to entity TourContext.TourBooking
    }

    on command AddParticipant {
      tell event ParticipantAdded to entity TourContext.TourBooking
    }

    on command RemoveParticipant {
      tell event ParticipantRemoved to entity TourContext.TourBooking
    }

    on command AddAddOn {
      tell event AddOnAdded to entity TourContext.TourBooking
    }

    on command ProcessDeposit {
      tell event DepositProcessed to entity TourContext.TourBooking
    }

    on command ConfirmBooking {
      tell event BookingConfirmed to entity TourContext.TourBooking
    }

    on command ProcessFinalPayment {
      tell event FinalPaymentProcessed to entity TourContext.TourBooking
    }

    on command CheckIn {
      tell event GuestCheckedIn to entity TourContext.TourBooking
    }

    on command StartTour {
      tell event TourStarted to entity TourContext.TourBooking
    }

    on command CompleteTour {
      tell event TourCompleted to entity TourContext.TourBooking
    }

    on command SubmitReview {
      tell event ReviewSubmitted to entity TourContext.TourBooking
    }

    on command CancelBooking {
      tell event BookingCancelled to entity TourContext.TourBooking
    }

    on command ProcessRefund {
      tell event RefundProcessed to entity TourContext.TourBooking
    }
  } with {
    briefly "Processes booking commands"
    described by {
      | Handles tour booking lifecycle from reservation
      | through completion and review.
    }
  }

} with {
  briefly "Tour booking aggregate"
  described by {
    | The TourBooking entity manages tour bookings
    | and their lifecycle through completion.
  }
}
