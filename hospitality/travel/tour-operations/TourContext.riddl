// Tour Operations - Tour Context

context TourContext is {

  include "types.riddl"
  include "TourBooking.riddl"

  // Repository for booking persistence
  repository BookingRepository is {
    schema BookingData is relational
      of bookings as TourBooking
      index on field TourBooking.bookingId
      index on field TourBooking.customer.customerId
      index on field TourBooking.tour.tourId
      index on field TourBooking.departure.departureId

    handler BookingPersistence is {
      on command TourBooking.CreateBooking {
        prompt "Store new booking"
      }
      on command TourBooking.AddParticipant {
        prompt "Add participant to booking"
      }
      on command TourBooking.RemoveParticipant {
        prompt "Remove participant from booking"
      }
      on command TourBooking.AddAddOn {
        prompt "Add add-on to booking"
      }
      on command TourBooking.ProcessDeposit {
        prompt "Store deposit payment"
      }
      on command TourBooking.ConfirmBooking {
        prompt "Update to confirmed"
      }
      on command TourBooking.ProcessFinalPayment {
        prompt "Store final payment"
      }
      on command TourBooking.CheckIn {
        prompt "Update to checked in"
      }
      on command TourBooking.StartTour {
        prompt "Update to in progress"
      }
      on command TourBooking.CompleteTour {
        prompt "Update to completed"
      }
      on command TourBooking.SubmitReview {
        prompt "Store review"
      }
      on command TourBooking.CancelBooking {
        prompt "Update to cancelled"
      }
      on command TourBooking.ProcessRefund {
        prompt "Store refund"
      }
    } with {
      briefly "Persists booking commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Booking data persistence"
    described by {
      | The BookingRepository provides persistent storage for
      | tour bookings and related data.
    }
  }

  // Projector for tour analytics
  projector TourAnalytics is {
    updates repository BookingRepository

    record TourStats is {
      totalBookings is Natural with { briefly "Total" described by "Total bookings." }
      confirmedBookings is Natural with { briefly "Confirmed" described by "Confirmed bookings." }
      completedTours is Natural with { briefly "Completed" described by "Completed tours." }
      cancelledBookings is Natural with { briefly "Cancelled" described by "Cancelled bookings." }
      totalRevenue is Decimal(12, 2) with { briefly "Revenue" described by "Total revenue." }
      averageRating is Decimal(3, 2) with { briefly "Rating" described by "Average rating." }
      totalParticipants is Natural with { briefly "Participants" described by "Total participants." }
    } with {
      briefly "Tour statistics"
      described by "Tour booking metrics."
    }

    handler AnalyticsHandler is {
      on event TourBooking.BookingCreated {
        prompt "Update booking counts"
      }
      on event TourBooking.BookingConfirmed {
        prompt "Update confirmed counts"
      }
      on event TourBooking.FinalPaymentProcessed {
        prompt "Update revenue metrics"
      }
      on event TourBooking.TourCompleted {
        prompt "Update completion metrics"
      }
      on event TourBooking.ReviewSubmitted {
        prompt "Update rating metrics"
      }
      on event TourBooking.BookingCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains tour analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Tour analytics projections"
    described by "Maintains tour booking analytics data."
  }

} with {
  briefly "Bounded context for tour operations"
  described by {
    | The TourContext is the bounded context for
    | tour bookings and excursion management.
  }
}
