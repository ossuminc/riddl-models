// Car Rental - Rental Entity
entity Rental is {
  // Commands
  command CreateRental is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |New rental identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer information.
      }
    }
    vehicle: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle information.
      }
    }
    period: RentalPeriod with {
      briefly "Period"
      described as {
        |Rental period.
      }
    }
  } with {
    briefly "Create rental"
    described as {
      |Creates a new rental reservation.
    }
  }
  command AddAddOn is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    addOn: AddOn with {
      briefly "Add-on"
      described as {
        |Add-on to include.
      }
    }
  } with {
    briefly "Add add-on"
    described as {
      |Adds rental add-on.
    }
  }
  command SelectInsurance is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    insurance: InsuranceOption with {
      briefly "Insurance"
      described as {
        |Insurance selection.
      }
    }
  } with {
    briefly "Select insurance"
    described as {
      |Selects insurance coverage.
    }
  }
  command AuthorizePayment is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    paymentMethod: String(1,50) with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    paymentToken: String(1,200) with {
      briefly "Token"
      described as {
        |Payment token.
      }
    }
  } with {
    briefly "Authorize payment"
    described as {
      |Authorizes payment for rental.
    }
  }
  command CheckOutVehicle is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    condition: VehicleCondition with {
      briefly "Condition"
      described as {
        |Vehicle condition at checkout.
      }
    }
    checkedOutBy: String(1,200) with {
      briefly "Checked out by"
      described as {
        |Agent processing checkout.
      }
    }
  } with {
    briefly "Check out vehicle"
    described as {
      |Checks out vehicle to customer.
    }
  }
  command ExtendRental is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    newReturnDateTime: TimeStamp with {
      briefly "New return"
      described as {
        |New return date and time.
      }
    }
  } with {
    briefly "Extend rental"
    described as {
      |Extends rental period.
    }
  }
  command ModifyReturnLocation is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    newReturnLocation: LocationInfo with {
      briefly "New location"
      described as {
        |New return location.
      }
    }
  } with {
    briefly "Modify return location"
    described as {
      |Changes return location.
    }
  }
  command CheckInVehicle is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    condition: VehicleCondition with {
      briefly "Condition"
      described as {
        |Vehicle condition at return.
      }
    }
    checkedInBy: String(1,200) with {
      briefly "Checked in by"
      described as {
        |Agent processing check-in.
      }
    }
  } with {
    briefly "Check in vehicle"
    described as {
      |Checks in returned vehicle.
    }
  }
  command AssessDamages is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    damages: String(1,200)+ with {
      briefly "Damages"
      described as {
        |Damage descriptions.
      }
    }
    estimatedCost: Decimal(10,2) with {
      briefly "Cost"
      described as {
        |Estimated repair cost.
      }
    }
  } with {
    briefly "Assess damages"
    described as {
      |Records vehicle damages.
    }
  }
  command ProcessFinalCharges is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    charges: RentalCharges with {
      briefly "Charges"
      described as {
        |Final charges.
      }
    }
  } with {
    briefly "Process final charges"
    described as {
      |Processes final rental charges.
    }
  }
  command CompleteRental is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Agent completing rental.
      }
    }
  } with {
    briefly "Complete rental"
    described as {
      |Completes the rental.
    }
  }
  command CancelRental is  {
    rentalId: RentalId with {
      briefly "Rental ID"
      described as {
        |Rental identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,200) with {
      briefly "Cancelled by"
      described as {
        |Person cancelling.
      }
    }
  } with {
    briefly "Cancel rental"
    described as {
      |Cancels the rental.
    }
  }
  // Events
  event RentalCreated is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    vehicle: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle info.
      }
    }
    period: RentalPeriod with {
      briefly "Period"
      described as {
        |Rental period.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Rental created"
    described as {
      |Emitted when rental is created.
    }
  }
  event AddOnAdded is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    addOn: AddOn with {
      briefly "Add-on"
      described as {
        |Added add-on.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Add-on added"
    described as {
      |Emitted when add-on is added.
    }
  }
  event InsuranceSelected is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    insurance: InsuranceOption with {
      briefly "Insurance"
      described as {
        |Selected insurance.
      }
    }
    selectedAt: TimeStamp with {
      briefly "Selected"
      described as {
        |Selection time.
      }
    }
  } with {
    briefly "Insurance selected"
    described as {
      |Emitted when insurance is selected.
    }
  }
  event PaymentAuthorized is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    authorizationId: String(1,100) with {
      briefly "Authorization"
      described as {
        |Authorization ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Authorized amount.
      }
    }
    authorizedAt: TimeStamp with {
      briefly "Authorized"
      described as {
        |Authorization time.
      }
    }
  } with {
    briefly "Payment authorized"
    described as {
      |Emitted when payment is authorized.
    }
  }
  event VehicleCheckedOut is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    condition: VehicleCondition with {
      briefly "Condition"
      described as {
        |Vehicle condition.
      }
    }
    checkedOutAt: TimeStamp with {
      briefly "Checked out"
      described as {
        |Checkout time.
      }
    }
  } with {
    briefly "Vehicle checked out"
    described as {
      |Emitted when vehicle is checked out.
    }
  }
  event RentalExtended is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    previousReturnDateTime: TimeStamp with {
      briefly "Previous"
      described as {
        |Previous return.
      }
    }
    newReturnDateTime: TimeStamp with {
      briefly "New"
      described as {
        |New return.
      }
    }
    extendedAt: TimeStamp with {
      briefly "Extended"
      described as {
        |Extension time.
      }
    }
  } with {
    briefly "Rental extended"
    described as {
      |Emitted when rental is extended.
    }
  }
  event ReturnLocationModified is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    previousLocation: LocationInfo with {
      briefly "Previous"
      described as {
        |Previous location.
      }
    }
    newLocation: LocationInfo with {
      briefly "New"
      described as {
        |New location.
      }
    }
    modifiedAt: TimeStamp with {
      briefly "Modified"
      described as {
        |Modification time.
      }
    }
  } with {
    briefly "Return location modified"
    described as {
      |Emitted when return location changes.
    }
  }
  event VehicleCheckedIn is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    condition: VehicleCondition with {
      briefly "Condition"
      described as {
        |Vehicle condition.
      }
    }
    checkedInAt: TimeStamp with {
      briefly "Checked in"
      described as {
        |Check-in time.
      }
    }
  } with {
    briefly "Vehicle checked in"
    described as {
      |Emitted when vehicle is checked in.
    }
  }
  event DamagesAssessed is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    damages: String(1,200)+ with {
      briefly "Damages"
      described as {
        |Damage list.
      }
    }
    estimatedCost: Decimal(10,2) with {
      briefly "Cost"
      described as {
        |Estimated cost.
      }
    }
    assessedAt: TimeStamp with {
      briefly "Assessed"
      described as {
        |Assessment time.
      }
    }
  } with {
    briefly "Damages assessed"
    described as {
      |Emitted when damages are assessed.
    }
  }
  event FinalChargesProcessed is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    charges: RentalCharges with {
      briefly "Charges"
      described as {
        |Final charges.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Final charges processed"
    described as {
      |Emitted when charges are processed.
    }
  }
  event RentalCompleted is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    completedBy: String(1,200) with {
      briefly "Completed by"
      described as {
        |Agent.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Rental completed"
    described as {
      |Emitted when rental is completed.
    }
  }
  event RentalCancelled is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,200) with {
      briefly "Cancelled by"
      described as {
        |Canceller.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Rental cancelled"
    described as {
      |Emitted when rental is cancelled.
    }
  }
  // State Records
  record ActiveStateData is  {
    rentalId: RentalId with {
      briefly "Rental"
      described as {
        |Rental ID.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    vehicle: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle info.
      }
    }
    period: RentalPeriod with {
      briefly "Period"
      described as {
        |Rental period.
      }
    }
    addOns: AddOn* with {
      briefly "Add-ons"
      described as {
        |Rental add-ons.
      }
    }
    selectedInsurance: InsuranceOption? with {
      briefly "Insurance"
      described as {
        |Insurance.
      }
    }
    status: RentalStatus with {
      briefly "Status"
      described as {
        |Rental status.
      }
    }
    checkoutCondition: VehicleCondition? with {
      briefly "Checkout"
      described as {
        |Checkout condition.
      }
    }
    checkinCondition: VehicleCondition? with {
      briefly "Checkin"
      described as {
        |Check-in condition.
      }
    }
    finalCharges: RentalCharges? with {
      briefly "Charges"
      described as {
        |Rental charges.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active rental.
    }
  }
  // States
  state ActiveState of type Rental.ActiveStateData
  // Handler
  handler RentalHandler is {
    on command CreateRental is {
      morph entity RentalContext.Rental to state RentalContext.Rental.ActiveState with command CreateRental
      tell event RentalCreated to entity RentalContext.Rental
    }
    on command AddAddOn is {
      tell event AddOnAdded to entity RentalContext.Rental
    }
    on command SelectInsurance is {
      tell event InsuranceSelected to entity RentalContext.Rental
    }
    on command AuthorizePayment is {
      tell event PaymentAuthorized to entity RentalContext.Rental
    }
    on command CheckOutVehicle is {
      tell event VehicleCheckedOut to entity RentalContext.Rental
    }
    on command ExtendRental is {
      tell event RentalExtended to entity RentalContext.Rental
    }
    on command ModifyReturnLocation is {
      tell event ReturnLocationModified to entity RentalContext.Rental
    }
    on command CheckInVehicle is {
      tell event VehicleCheckedIn to entity RentalContext.Rental
    }
    on command AssessDamages is {
      tell event DamagesAssessed to entity RentalContext.Rental
    }
    on command ProcessFinalCharges is {
      tell event FinalChargesProcessed to entity RentalContext.Rental
    }
    on command CompleteRental is {
      tell event RentalCompleted to entity RentalContext.Rental
    }
    on command CancelRental is {
      tell event RentalCancelled to entity RentalContext.Rental
    }
  } with {
    briefly "Processes rental commands"
    described as {
      | Handles rental lifecycle from reservation
      | through checkout, return, and completion.
    }
  }
} with {
  briefly "Rental aggregate"
  described as {
    | The Rental entity manages vehicle rentals
    | and their lifecycle through completion.
  }
}
