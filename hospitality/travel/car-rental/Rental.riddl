// Car Rental - Rental Entity

entity Rental is {

  // Commands
  command CreateRental is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "New rental identifier."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    vehicle is VehicleInfo with {
      briefly "Vehicle"
      described by "Vehicle information."
    }
    period is RentalPeriod with {
      briefly "Period"
      described by "Rental period."
    }
  } with {
    briefly "Create rental"
    described by "Creates a new rental reservation."
  }

  command AddAddOn is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    addOn is AddOn with {
      briefly "Add-on"
      described by "Add-on to include."
    }
  } with {
    briefly "Add add-on"
    described by "Adds rental add-on."
  }

  command SelectInsurance is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    insurance is InsuranceOption with {
      briefly "Insurance"
      described by "Insurance selection."
    }
  } with {
    briefly "Select insurance"
    described by "Selects insurance coverage."
  }

  command AuthorizePayment is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    paymentToken is String(1, 200) with {
      briefly "Token"
      described by "Payment token."
    }
  } with {
    briefly "Authorize payment"
    described by "Authorizes payment for rental."
  }

  command CheckOutVehicle is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    condition is VehicleCondition with {
      briefly "Condition"
      described by "Vehicle condition at checkout."
    }
    checkedOutBy is String(1, 200) with {
      briefly "Checked out by"
      described by "Agent processing checkout."
    }
  } with {
    briefly "Check out vehicle"
    described by "Checks out vehicle to customer."
  }

  command ExtendRental is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    newReturnDateTime is TimeStamp with {
      briefly "New return"
      described by "New return date and time."
    }
  } with {
    briefly "Extend rental"
    described by "Extends rental period."
  }

  command ModifyReturnLocation is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    newReturnLocation is LocationInfo with {
      briefly "New location"
      described by "New return location."
    }
  } with {
    briefly "Modify return location"
    described by "Changes return location."
  }

  command CheckInVehicle is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    condition is VehicleCondition with {
      briefly "Condition"
      described by "Vehicle condition at return."
    }
    checkedInBy is String(1, 200) with {
      briefly "Checked in by"
      described by "Agent processing check-in."
    }
  } with {
    briefly "Check in vehicle"
    described by "Checks in returned vehicle."
  }

  command AssessDamages is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    damages is many String(1, 200) with {
      briefly "Damages"
      described by "Damage descriptions."
    }
    estimatedCost is Decimal(10, 2) with {
      briefly "Cost"
      described by "Estimated repair cost."
    }
  } with {
    briefly "Assess damages"
    described by "Records vehicle damages."
  }

  command ProcessFinalCharges is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    charges is RentalCharges with {
      briefly "Charges"
      described by "Final charges."
    }
  } with {
    briefly "Process final charges"
    described by "Processes final rental charges."
  }

  command CompleteRental is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    completedBy is String(1, 200) with {
      briefly "Completed by"
      described by "Agent completing rental."
    }
  } with {
    briefly "Complete rental"
    described by "Completes the rental."
  }

  command CancelRental is {
    rentalId is RentalId with {
      briefly "Rental ID"
      described by "Rental identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 200) with {
      briefly "Cancelled by"
      described by "Person cancelling."
    }
  } with {
    briefly "Cancel rental"
    described by "Cancels the rental."
  }

  // Events
  event RentalCreated is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    vehicle is VehicleInfo with { briefly "Vehicle" described by "Vehicle info." }
    period is RentalPeriod with { briefly "Period" described by "Rental period." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Rental created"
    described by "Emitted when rental is created."
  }

  event AddOnAdded is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    addOn is AddOn with { briefly "Add-on" described by "Added add-on." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Add-on added"
    described by "Emitted when add-on is added."
  }

  event InsuranceSelected is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    insurance is InsuranceOption with { briefly "Insurance" described by "Selected insurance." }
    selectedAt is TimeStamp with { briefly "Selected" described by "Selection time." }
  } with {
    briefly "Insurance selected"
    described by "Emitted when insurance is selected."
  }

  event PaymentAuthorized is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    authorizationId is String(1, 100) with { briefly "Authorization" described by "Authorization ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Authorized amount." }
    authorizedAt is TimeStamp with { briefly "Authorized" described by "Authorization time." }
  } with {
    briefly "Payment authorized"
    described by "Emitted when payment is authorized."
  }

  event VehicleCheckedOut is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    condition is VehicleCondition with { briefly "Condition" described by "Vehicle condition." }
    checkedOutAt is TimeStamp with { briefly "Checked out" described by "Checkout time." }
  } with {
    briefly "Vehicle checked out"
    described by "Emitted when vehicle is checked out."
  }

  event RentalExtended is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    previousReturnDateTime is TimeStamp with { briefly "Previous" described by "Previous return." }
    newReturnDateTime is TimeStamp with { briefly "New" described by "New return." }
    extendedAt is TimeStamp with { briefly "Extended" described by "Extension time." }
  } with {
    briefly "Rental extended"
    described by "Emitted when rental is extended."
  }

  event ReturnLocationModified is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    previousLocation is LocationInfo with { briefly "Previous" described by "Previous location." }
    newLocation is LocationInfo with { briefly "New" described by "New location." }
    modifiedAt is TimeStamp with { briefly "Modified" described by "Modification time." }
  } with {
    briefly "Return location modified"
    described by "Emitted when return location changes."
  }

  event VehicleCheckedIn is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    condition is VehicleCondition with { briefly "Condition" described by "Vehicle condition." }
    checkedInAt is TimeStamp with { briefly "Checked in" described by "Check-in time." }
  } with {
    briefly "Vehicle checked in"
    described by "Emitted when vehicle is checked in."
  }

  event DamagesAssessed is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    damages is many String(1, 200) with { briefly "Damages" described by "Damage list." }
    estimatedCost is Decimal(10, 2) with { briefly "Cost" described by "Estimated cost." }
    assessedAt is TimeStamp with { briefly "Assessed" described by "Assessment time." }
  } with {
    briefly "Damages assessed"
    described by "Emitted when damages are assessed."
  }

  event FinalChargesProcessed is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    charges is RentalCharges with { briefly "Charges" described by "Final charges." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Final charges processed"
    described by "Emitted when charges are processed."
  }

  event RentalCompleted is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    completedBy is String(1, 200) with { briefly "Completed by" described by "Agent." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Rental completed"
    described by "Emitted when rental is completed."
  }

  event RentalCancelled is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is String(1, 200) with { briefly "Cancelled by" described by "Canceller." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Rental cancelled"
    described by "Emitted when rental is cancelled."
  }

  // State Records
  record ActiveStateData is {
    rentalId is RentalId with { briefly "Rental" described by "Rental ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    vehicle is VehicleInfo with { briefly "Vehicle" described by "Vehicle info." }
    period is RentalPeriod with { briefly "Period" described by "Rental period." }
    addOns is many optional AddOn with { briefly "Add-ons" described by "Rental add-ons." }
    selectedInsurance is optional InsuranceOption with { briefly "Insurance" described by "Insurance." }
    status is RentalStatus with { briefly "Status" described by "Rental status." }
    checkoutCondition is optional VehicleCondition with { briefly "Checkout" described by "Checkout condition." }
    checkinCondition is optional VehicleCondition with { briefly "Checkin" described by "Check-in condition." }
    finalCharges is optional RentalCharges with { briefly "Charges" described by "Rental charges." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active rental."
  }

  // States
  state ActiveState of Rental.ActiveStateData with {
    briefly "Rental active"
    described by "Rental is active."
  }

  // Handler
  handler RentalHandler is {
    on command CreateRental {
      morph entity RentalContext.Rental to state RentalContext.Rental.ActiveState with command CreateRental
      tell event RentalCreated to entity RentalContext.Rental
    }

    on command AddAddOn {
      tell event AddOnAdded to entity RentalContext.Rental
    }

    on command SelectInsurance {
      tell event InsuranceSelected to entity RentalContext.Rental
    }

    on command AuthorizePayment {
      tell event PaymentAuthorized to entity RentalContext.Rental
    }

    on command CheckOutVehicle {
      tell event VehicleCheckedOut to entity RentalContext.Rental
    }

    on command ExtendRental {
      tell event RentalExtended to entity RentalContext.Rental
    }

    on command ModifyReturnLocation {
      tell event ReturnLocationModified to entity RentalContext.Rental
    }

    on command CheckInVehicle {
      tell event VehicleCheckedIn to entity RentalContext.Rental
    }

    on command AssessDamages {
      tell event DamagesAssessed to entity RentalContext.Rental
    }

    on command ProcessFinalCharges {
      tell event FinalChargesProcessed to entity RentalContext.Rental
    }

    on command CompleteRental {
      tell event RentalCompleted to entity RentalContext.Rental
    }

    on command CancelRental {
      tell event RentalCancelled to entity RentalContext.Rental
    }
  } with {
    briefly "Processes rental commands"
    described by {
      | Handles rental lifecycle from reservation
      | through checkout, return, and completion.
    }
  }

} with {
  briefly "Rental aggregate"
  described by {
    | The Rental entity manages vehicle rentals
    | and their lifecycle through completion.
  }
}
