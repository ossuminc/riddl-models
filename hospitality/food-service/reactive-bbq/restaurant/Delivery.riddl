// DeliveryOrder entity for the Delivery context
entity DeliveryOrder is {
  // ---- Commands ----
  command CreateDelivery is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Identifier for the new delivery.
      }
    }
    sourceOnlineOrderId: String(1,50) with {
      briefly "Online order ID"
      described as {
        |Originating online order.
      }
    }
    deliveryCustomerName: String(1,100) with {
      briefly "Customer name"
      described as {
        |Name of the customer.
      }
    }
    deliveryCustomerPhone: String(7,20) with {
      briefly "Customer phone"
      described as {
        |Customer contact phone.
      }
    }
    deliveryDestination: DeliveryAddress with {
      briefly "Destination"
      described as {
        |Delivery destination address.
      }
    }
    requestedDeliveryTime: TimeStamp? with {
      briefly "Requested time"
      described as {
        |Customer-requested delivery time.
      }
    }
  } with {
    briefly "Create delivery"
    described as {
      |Create a new delivery from an online order.
    }
  }
  command AssignDriver is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery to assign driver to.
      }
    }
    driverId: DriverId with {
      briefly "Driver ID"
      described as {
        |Driver being assigned.
      }
    }
    driverName: String(1,100) with {
      briefly "Driver name"
      described as {
        |Name of the assigned driver.
      }
    }
  } with {
    briefly "Assign driver"
    described as {
      |Assign a delivery driver.
    }
  }
  command DispatchDriver is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery to dispatch.
      }
    }
    dispatchedAt: TimeStamp with {
      briefly "Dispatched at"
      described as {
        |When the driver was dispatched.
      }
    }
  } with {
    briefly "Dispatch driver"
    described as {
      |Dispatch the assigned driver for delivery.
    }
  }
  command RecordDeliveryLocation is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery to record location for.
      }
    }
    driverLocation: GeoLocation with {
      briefly "Location"
      described as {
        |Current driver GPS location.
      }
    }
  } with {
    briefly "Record delivery location"
    described as {
      |Record the driver's current GPS location.
    }
  }
  command ConfirmDelivery is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery to confirm.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed at"
      described as {
        |When the delivery was confirmed.
      }
    }
    deliverySignature: String(1,200)? with {
      briefly "Signature"
      described as {
        |Customer signature or confirmation.
      }
    }
  } with {
    briefly "Confirm delivery"
    described as {
      |Confirm the delivery was completed.
    }
  }
  command RecordDeliveryPayment is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery to record payment for.
      }
    }
    deliveryTip: Decimal(8,2)? with {
      briefly "Tip"
      described as {
        |Driver tip amount.
      }
    }
    deliveryPaidAt: TimeStamp with {
      briefly "Paid at"
      described as {
        |When payment was recorded.
      }
    }
  } with {
    briefly "Record delivery payment"
    described as {
      |Record cash tip or additional payment at delivery.
    }
  }
  command ReportDeliveryIssue is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery with the issue.
      }
    }
    issueType: DeliveryIssueType with {
      briefly "Issue type"
      described as {
        |Type of issue.
      }
    }
    issueDescription: String(1,1000) with {
      briefly "Description"
      described as {
        |Detailed description of the issue.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported at"
      described as {
        |When the issue was reported.
      }
    }
  } with {
    briefly "Report delivery issue"
    described as {
      |Report an issue during delivery.
    }
  }
  // ---- Events ----
  event DeliveryCreated is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    sourceOnlineOrderId: String(1,50) with {
      briefly "Online order ID"
      described as {
        |Originating order.
      }
    }
    deliveryDestination: DeliveryAddress with {
      briefly "Destination"
      described as {
        |Delivery address.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
  } with {
    briefly "Delivery created"
    described as {
      |Emitted when a new delivery is created.
    }
  }
  event DriverAssigned is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    driverId: DriverId with {
      briefly "Driver ID"
      described as {
        |Assigned driver.
      }
    }
    driverName: String(1,100) with {
      briefly "Driver name"
      described as {
        |Driver name.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned at"
      described as {
        |When assigned.
      }
    }
  } with {
    briefly "Driver assigned"
    described as {
      |Emitted when a driver is assigned to a delivery.
    }
  }
  event DriverDispatched is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    dispatchedAt: TimeStamp with {
      briefly "Dispatched at"
      described as {
        |When dispatched.
      }
    }
  } with {
    briefly "Driver dispatched"
    described as {
      |Emitted when the driver is dispatched.
    }
  }
  event DeliveryLocationRecorded is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    driverLocation: GeoLocation with {
      briefly "Location"
      described as {
        |GPS location.
      }
    }
  } with {
    briefly "Delivery location recorded"
    described as {
      |Emitted when a driver location update is recorded.
    }
  }
  event DeliveryConfirmed is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed at"
      described as {
        |When confirmed.
      }
    }
  } with {
    briefly "Delivery confirmed"
    described as {
      |Emitted when delivery is confirmed complete.
    }
  }
  event DeliveryPaymentRecorded is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    deliveryTip: Decimal(8,2)? with {
      briefly "Tip"
      described as {
        |Tip amount.
      }
    }
    deliveryPaidAt: TimeStamp with {
      briefly "Paid at"
      described as {
        |When recorded.
      }
    }
  } with {
    briefly "Delivery payment recorded"
    described as {
      |Emitted when delivery payment or tip is recorded.
    }
  }
  event DeliveryIssueReported is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    issueType: DeliveryIssueType with {
      briefly "Issue type"
      described as {
        |Type of issue.
      }
    }
    issueDescription: String(1,1000) with {
      briefly "Description"
      described as {
        |Issue details.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported at"
      described as {
        |When reported.
      }
    }
  } with {
    briefly "Delivery issue reported"
    described as {
      |Emitted when a delivery issue is reported.
    }
  }
  // ---- State ----
  record DeliveryStateData is  {
    deliveryId: DeliveryId with {
      briefly "ID"
      described as {
        |Delivery identifier.
      }
    }
    sourceOnlineOrderId: String(1,50) with {
      briefly "Online order ID"
      described as {
        |Originating order.
      }
    }
    deliveryCustomerName: String(1,100) with {
      briefly "Customer name"
      described as {
        |Customer.
      }
    }
    deliveryCustomerPhone: String(7,20) with {
      briefly "Customer phone"
      described as {
        |Contact phone.
      }
    }
    deliveryDestination: DeliveryAddress with {
      briefly "Destination"
      described as {
        |Delivery address.
      }
    }
    deliveryStatus: DeliveryStatus with {
      briefly "Status"
      described as {
        |Current delivery status.
      }
    }
    assignedDriverId: DriverId? with {
      briefly "Driver ID"
      described as {
        |Assigned driver.
      }
    }
    assignedDriverName: String(1,100)? with {
      briefly "Driver name"
      described as {
        |Driver name.
      }
    }
    lastKnownLocation: GeoLocation? with {
      briefly "Last location"
      described as {
        |Last recorded GPS location.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
    actualDispatchedAt: TimeStamp? with {
      briefly "Dispatched at"
      described as {
        |When dispatched.
      }
    }
    actualConfirmedAt: TimeStamp? with {
      briefly "Confirmed at"
      described as {
        |When delivery confirmed.
      }
    }
  } with {
    briefly "Delivery state data"
    described as {
      |Full state of a delivery.
    }
  }
  state ActiveDelivery of type DeliveryOrder.DeliveryStateData
  handler DeliveryHandler is {
    on command CreateDelivery is {
      morph entity Restaurant.Delivery.DeliveryOrder to state Restaurant.Delivery.DeliveryOrder.ActiveDelivery with command CreateDelivery
      tell event DeliveryCreated to entity Restaurant.Delivery.DeliveryOrder
    }
    on command AssignDriver is {
      tell event DriverAssigned to entity Restaurant.Delivery.DeliveryOrder
    }
    on command DispatchDriver is {
      tell event DriverDispatched to entity Restaurant.Delivery.DeliveryOrder
    }
    on command RecordDeliveryLocation is {
      tell event DeliveryLocationRecorded to entity Restaurant.Delivery.DeliveryOrder
    }
    on command ConfirmDelivery is {
      tell event DeliveryConfirmed to entity Restaurant.Delivery.DeliveryOrder
    }
    on command RecordDeliveryPayment is {
      tell event DeliveryPaymentRecorded to entity Restaurant.Delivery.DeliveryOrder
    }
    on command ReportDeliveryIssue is {
      tell event DeliveryIssueReported to entity Restaurant.Delivery.DeliveryOrder
    }
  } with {
    briefly "Delivery command handler"
    described as {
      |Processes delivery lifecycle commands.
    }
  }
} with {
  briefly "Delivery entity"
  described as {
    | Manages the lifecycle of a delivery from creation
    | through driver assignment, dispatch, GPS tracking,
    | confirmation, and issue reporting. Designed for
    | offline resilience so drivers can cache details
    | and report issues when connectivity resumes.
  }
}
