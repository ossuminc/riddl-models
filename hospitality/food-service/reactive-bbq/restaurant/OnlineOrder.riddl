// OnlineOrder entity for the OnlineOrdering context
entity OnlineOrder is {
  // ---- Commands ----
  command BrowseMenu is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Session/order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer browsing the menu.
      }
    }
    browsedAt: TimeStamp with {
      briefly "Browsed at"
      described as {
        |When the menu was browsed.
      }
    }
  } with {
    briefly "Browse menu"
    described as {
      |Customer begins browsing the online menu.
    }
  }
  command AddToCart is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order to add item to.
      }
    }
    cartItem: CartItem with {
      briefly "Item"
      described as {
        |Item to add to cart.
      }
    }
  } with {
    briefly "Add to cart"
    described as {
      |Add an item to the online shopping cart.
    }
  }
  command RemoveFromCart is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order to remove item from.
      }
    }
    removedCartItemId: String(1,50) with {
      briefly "Menu item ID"
      described as {
        |Item to remove from cart.
      }
    }
  } with {
    briefly "Remove from cart"
    described as {
      |Remove an item from the online shopping cart.
    }
  }
  command SelectFulfillment is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order to set fulfillment for.
      }
    }
    fulfillmentType: FulfillmentType with {
      briefly "Fulfillment"
      described as {
        |Pickup or delivery.
      }
    }
    deliveryAddress: DeliveryAddress? with {
      briefly "Address"
      described as {
        |Delivery address if delivery fulfillment.
      }
    }
    requestedTime: TimeStamp? with {
      briefly "Requested time"
      described as {
        |Requested pickup or delivery time.
      }
    }
  } with {
    briefly "Select fulfillment"
    described as {
      |Choose pickup or delivery fulfillment.
    }
  }
  command SubmitOnlineOrder is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order to submit.
      }
    }
    onlineSubmittedAt: TimeStamp with {
      briefly "Submitted at"
      described as {
        |When the order was submitted.
      }
    }
  } with {
    briefly "Submit online order"
    described as {
      |Submit the online order for processing.
    }
  }
  command ProcessOnlinePayment is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order to pay for.
      }
    }
    onlinePayment: OnlinePaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
  } with {
    briefly "Process online payment"
    described as {
      |Process payment for the online order.
    }
  }
  // ---- Events ----
  event MenuBrowsed is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    browsedAt: TimeStamp with {
      briefly "Browsed at"
      described as {
        |When browsed.
      }
    }
  } with {
    briefly "Menu browsed"
    described as {
      |Emitted when a customer begins browsing.
    }
  }
  event ItemAddedToCart is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    cartItem: CartItem with {
      briefly "Item"
      described as {
        |Added item.
      }
    }
  } with {
    briefly "Item added to cart"
    described as {
      |Emitted when an item is added to the cart.
    }
  }
  event ItemRemovedFromCart is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    removedCartItemId: String(1,50) with {
      briefly "Menu item ID"
      described as {
        |Removed item.
      }
    }
  } with {
    briefly "Item removed from cart"
    described as {
      |Emitted when an item is removed from the cart.
    }
  }
  event FulfillmentSelected is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    fulfillmentType: FulfillmentType with {
      briefly "Fulfillment"
      described as {
        |Chosen fulfillment type.
      }
    }
    deliveryAddress: DeliveryAddress? with {
      briefly "Address"
      described as {
        |Delivery address if applicable.
      }
    }
    requestedTime: TimeStamp? with {
      briefly "Requested time"
      described as {
        |Requested time.
      }
    }
  } with {
    briefly "Fulfillment selected"
    described as {
      |Emitted when customer selects pickup or delivery.
    }
  }
  event OnlineOrderSubmitted is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    orderCartItems: CartItem+ with {
      briefly "Items"
      described as {
        |All items in the order.
      }
    }
    fulfillmentType: FulfillmentType with {
      briefly "Fulfillment"
      described as {
        |Fulfillment type.
      }
    }
    deliveryAddress: DeliveryAddress? with {
      briefly "Address"
      described as {
        |Delivery address if applicable.
      }
    }
    onlineSubmittedAt: TimeStamp with {
      briefly "Submitted at"
      described as {
        |When submitted.
      }
    }
  } with {
    briefly "Online order submitted"
    described as {
      |Emitted when the online order is submitted.
    }
  }
  event OnlinePaymentProcessed is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    onlinePayment: OnlinePaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    onlinePaidAt: TimeStamp with {
      briefly "Paid at"
      described as {
        |When payment was processed.
      }
    }
  } with {
    briefly "Online payment processed"
    described as {
      |Emitted when online payment is processed.
    }
  }
  // ---- State ----
  record OnlineOrderStateData is  {
    onlineOrderId: OnlineOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    orderCartItems: CartItem+ with {
      briefly "Items"
      described as {
        |Items in the cart.
      }
    }
    selectedFulfillment: FulfillmentType? with {
      briefly "Fulfillment"
      described as {
        |Chosen fulfillment type.
      }
    }
    selectedDeliveryAddress: DeliveryAddress? with {
      briefly "Address"
      described as {
        |Delivery address if applicable.
      }
    }
    onlineOrderStatus: OnlineOrderStatus with {
      briefly "Status"
      described as {
        |Current order status.
      }
    }
    processedOnlinePayment: OnlinePaymentInfo? with {
      briefly "Payment"
      described as {
        |Payment info when processed.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When the session started.
      }
    }
    actualOnlineSubmittedAt: TimeStamp? with {
      briefly "Submitted at"
      described as {
        |When submitted.
      }
    }
  } with {
    briefly "Online order state data"
    described as {
      |Full state of an online order.
    }
  }
  state ActiveOnlineOrder of type OnlineOrder.OnlineOrderStateData
  handler OnlineOrderHandler is {
    on command BrowseMenu is {
      morph entity OnlineOrdering.OnlineOrder to state OnlineOrdering.OnlineOrder.ActiveOnlineOrder with command BrowseMenu
      tell event MenuBrowsed to entity OnlineOrdering.OnlineOrder
    }
    on command AddToCart is {
      tell event ItemAddedToCart to entity OnlineOrdering.OnlineOrder
    }
    on command RemoveFromCart is {
      tell event ItemRemovedFromCart to entity OnlineOrdering.OnlineOrder
    }
    on command SelectFulfillment is {
      tell event FulfillmentSelected to entity OnlineOrdering.OnlineOrder
    }
    on command SubmitOnlineOrder is {
      tell event OnlineOrderSubmitted to entity OnlineOrdering.OnlineOrder
    }
    on command ProcessOnlinePayment is {
      tell event OnlinePaymentProcessed to entity OnlineOrdering.OnlineOrder
    }
  } with {
    briefly "Online order command handler"
    described as {
      |Processes online order lifecycle commands.
    }
  }
} with {
  briefly "Online order entity"
  described as {
    | Manages the lifecycle of an online order from menu
    | browsing through cart management, fulfillment selection,
    | submission, and payment. Decoupled from delivery to
    | enable electronic menus independently.
  }
}
