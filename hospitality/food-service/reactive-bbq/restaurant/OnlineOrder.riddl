// OnlineOrder entity for the OnlineOrdering context

entity OnlineOrder is {

  // ---- Commands ----

  command BrowseMenu is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Session/order identifier."
    }
    customerId is CustomerId with {
      briefly "Customer ID"
      described by "Customer browsing the menu."
    }
    browsedAt is TimeStamp with {
      briefly "Browsed at"
      described by "When the menu was browsed."
    }
  } with {
    briefly "Browse menu"
    described by "Customer begins browsing the online menu."
  }

  command AddToCart is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order to add item to."
    }
    cartItem is CartItem with {
      briefly "Item"
      described by "Item to add to cart."
    }
  } with {
    briefly "Add to cart"
    described by "Add an item to the online shopping cart."
  }

  command RemoveFromCart is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order to remove item from."
    }
    removedCartItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "Item to remove from cart."
    }
  } with {
    briefly "Remove from cart"
    described by "Remove an item from the online shopping cart."
  }

  command SelectFulfillment is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order to set fulfillment for."
    }
    fulfillmentType is FulfillmentType with {
      briefly "Fulfillment"
      described by "Pickup or delivery."
    }
    deliveryAddress is optional DeliveryAddress with {
      briefly "Address"
      described by "Delivery address if delivery fulfillment."
    }
    requestedTime is optional TimeStamp with {
      briefly "Requested time"
      described by "Requested pickup or delivery time."
    }
  } with {
    briefly "Select fulfillment"
    described by "Choose pickup or delivery fulfillment."
  }

  command SubmitOnlineOrder is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order to submit."
    }
    onlineSubmittedAt is TimeStamp with {
      briefly "Submitted at"
      described by "When the order was submitted."
    }
  } with {
    briefly "Submit online order"
    described by "Submit the online order for processing."
  }

  command ProcessOnlinePayment is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order to pay for."
    }
    onlinePayment is OnlinePaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Process online payment"
    described by "Process payment for the online order."
  }

  // ---- Events ----

  event MenuBrowsed is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    customerId is CustomerId with {
      briefly "Customer ID"
      described by "Customer."
    }
    browsedAt is TimeStamp with {
      briefly "Browsed at"
      described by "When browsed."
    }
  } with {
    briefly "Menu browsed"
    described by "Emitted when a customer begins browsing."
  }

  event ItemAddedToCart is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    cartItem is CartItem with {
      briefly "Item"
      described by "Added item."
    }
  } with {
    briefly "Item added to cart"
    described by "Emitted when an item is added to the cart."
  }

  event ItemRemovedFromCart is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    removedCartItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "Removed item."
    }
  } with {
    briefly "Item removed from cart"
    described by "Emitted when an item is removed from the cart."
  }

  event FulfillmentSelected is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    fulfillmentType is FulfillmentType with {
      briefly "Fulfillment"
      described by "Chosen fulfillment type."
    }
    deliveryAddress is optional DeliveryAddress with {
      briefly "Address"
      described by "Delivery address if applicable."
    }
    requestedTime is optional TimeStamp with {
      briefly "Requested time"
      described by "Requested time."
    }
  } with {
    briefly "Fulfillment selected"
    described by "Emitted when customer selects pickup or delivery."
  }

  event OnlineOrderSubmitted is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    customerId is CustomerId with {
      briefly "Customer ID"
      described by "Customer."
    }
    orderCartItems is many CartItem with {
      briefly "Items"
      described by "All items in the order."
    }
    fulfillmentType is FulfillmentType with {
      briefly "Fulfillment"
      described by "Fulfillment type."
    }
    deliveryAddress is optional DeliveryAddress with {
      briefly "Address"
      described by "Delivery address if applicable."
    }
    onlineSubmittedAt is TimeStamp with {
      briefly "Submitted at"
      described by "When submitted."
    }
  } with {
    briefly "Online order submitted"
    described by "Emitted when the online order is submitted."
  }

  event OnlinePaymentProcessed is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    onlinePayment is OnlinePaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
    onlinePaidAt is TimeStamp with {
      briefly "Paid at"
      described by "When payment was processed."
    }
  } with {
    briefly "Online payment processed"
    described by "Emitted when online payment is processed."
  }

  // ---- State ----

  record OnlineOrderStateData is {
    onlineOrderId is OnlineOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    customerId is CustomerId with {
      briefly "Customer ID"
      described by "Customer."
    }
    orderCartItems is many CartItem with {
      briefly "Items"
      described by "Items in the cart."
    }
    selectedFulfillment is optional FulfillmentType with {
      briefly "Fulfillment"
      described by "Chosen fulfillment type."
    }
    selectedDeliveryAddress is optional DeliveryAddress with {
      briefly "Address"
      described by "Delivery address if applicable."
    }
    onlineOrderStatus is OnlineOrderStatus with {
      briefly "Status"
      described by "Current order status."
    }
    processedOnlinePayment is optional OnlinePaymentInfo with {
      briefly "Payment"
      described by "Payment info when processed."
    }
    createdAt is TimeStamp with {
      briefly "Created at"
      described by "When the session started."
    }
    actualOnlineSubmittedAt is optional TimeStamp with {
      briefly "Submitted at"
      described by "When submitted."
    }
  } with {
    briefly "Online order state data"
    described by "Full state of an online order."
  }

  state ActiveOnlineOrder of OnlineOrder.OnlineOrderStateData with {
    briefly "Active online order"
    described by "An online order in progress."
  }

  handler OnlineOrderHandler is {
    on command BrowseMenu {
      morph entity OnlineOrdering.OnlineOrder to state
        OnlineOrdering.OnlineOrder.ActiveOnlineOrder
        with command BrowseMenu
      tell event MenuBrowsed to
        entity OnlineOrdering.OnlineOrder
    }
    on command AddToCart {
      tell event ItemAddedToCart to
        entity OnlineOrdering.OnlineOrder
    }
    on command RemoveFromCart {
      tell event ItemRemovedFromCart to
        entity OnlineOrdering.OnlineOrder
    }
    on command SelectFulfillment {
      tell event FulfillmentSelected to
        entity OnlineOrdering.OnlineOrder
    }
    on command SubmitOnlineOrder {
      tell event OnlineOrderSubmitted to
        entity OnlineOrdering.OnlineOrder
    }
    on command ProcessOnlinePayment {
      tell event OnlinePaymentProcessed to
        entity OnlineOrdering.OnlineOrder
    }
  } with {
    briefly "Online order command handler"
    described by "Processes online order lifecycle commands."
  }

} with {
  briefly "Online order entity"
  described by {
    | Manages the lifecycle of an online order from menu
    | browsing through cart management, fulfillment selection,
    | submission, and payment. Decoupled from delivery to
    | enable electronic menus independently.
  }
}
