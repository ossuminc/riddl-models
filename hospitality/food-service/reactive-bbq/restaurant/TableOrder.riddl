// TableOrder entity for the Front of House context

entity TableOrder is {

  // ---- Commands ----

  command CreateOrder is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Identifier for the new order."
    }
    tableNumber is TableNumber with {
      briefly "Table"
      described by "Table this order belongs to."
    }
    serverId is String(1, 50) with {
      briefly "Server ID"
      described by "Identifier of the assigned server."
    }
  } with {
    briefly "Create order"
    described by "Create a new table order."
  }

  command AddItem is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to add item to."
    }
    addedItem is OrderLine with {
      briefly "Item"
      described by "Line item to add."
    }
  } with {
    briefly "Add item"
    described by "Add a menu item to the order."
  }

  command RemoveItem is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to remove item from."
    }
    removedMenuItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "Identifier of the menu item to remove."
    }
  } with {
    briefly "Remove item"
    described by "Remove a menu item from the order."
  }

  command SubmitOrder is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to submit."
    }
    submittedAt is TimeStamp with {
      briefly "Submitted at"
      described by "When the order was submitted."
    }
  } with {
    briefly "Submit order"
    described by "Submit the order to kitchen and bar."
  }

  command PresentBill is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to present bill for."
    }
    billTotal is Decimal(10, 2) with {
      briefly "Total"
      described by "Calculated bill total."
    }
  } with {
    briefly "Present bill"
    described by "Present the bill to the table."
  }

  command ProcessPayment is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to process payment for."
    }
    orderPayment is PaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Process payment"
    described by "Process payment for the order."
  }

  command CloseOrder is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order to close."
    }
    closedAt is TimeStamp with {
      briefly "Closed at"
      described by "When the order was closed."
    }
  } with {
    briefly "Close order"
    described by "Close the order after payment."
  }

  // ---- Events ----

  event OrderCreated is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    tableNumber is TableNumber with {
      briefly "Table"
      described by "Table number."
    }
    serverId is String(1, 50) with {
      briefly "Server ID"
      described by "Assigned server."
    }
    createdAt is TimeStamp with {
      briefly "Created at"
      described by "When the order was created."
    }
  } with {
    briefly "Order created"
    described by "Emitted when a new table order is created."
  }

  event ItemAdded is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    addedItem is OrderLine with {
      briefly "Item"
      described by "Item that was added."
    }
  } with {
    briefly "Item added"
    described by "Emitted when an item is added to the order."
  }

  event ItemRemoved is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    removedMenuItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "Identifier of the removed item."
    }
  } with {
    briefly "Item removed"
    described by "Emitted when an item is removed from the order."
  }

  event OrderSubmitted is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    orderItems is many OrderLine with {
      briefly "Items"
      described by "All items in the submitted order."
    }
    tableNumber is TableNumber with {
      briefly "Table"
      described by "Table number."
    }
    submittedAt is TimeStamp with {
      briefly "Submitted at"
      described by "When the order was submitted."
    }
  } with {
    briefly "Order submitted"
    described by "Emitted when the order is submitted to kitchen and bar."
  }

  event BillPresented is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    billTotal is Decimal(10, 2) with {
      briefly "Total"
      described by "Bill total amount."
    }
    presentedAt is TimeStamp with {
      briefly "Presented at"
      described by "When the bill was presented."
    }
  } with {
    briefly "Bill presented"
    described by "Emitted when the bill is presented to the table."
  }

  event PaymentProcessed is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    orderPayment is PaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
    processedAt is TimeStamp with {
      briefly "Processed at"
      described by "When payment was processed."
    }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is successfully processed."
  }

  event OrderClosed is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    closedAt is TimeStamp with {
      briefly "Closed at"
      described by "When the order was closed."
    }
  } with {
    briefly "Order closed"
    described by "Emitted when the order is closed after payment."
  }

  // ---- State ----

  record TableOrderStateData is {
    tableOrderId is TableOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    tableNumber is TableNumber with {
      briefly "Table"
      described by "Table number."
    }
    serverId is String(1, 50) with {
      briefly "Server ID"
      described by "Assigned server."
    }
    orderItems is many OrderLine with {
      briefly "Items"
      described by "Items in the order."
    }
    orderStatus is OrderStatus with {
      briefly "Status"
      described by "Current order status."
    }
    presentedBillTotal is optional Decimal(10, 2) with {
      briefly "Total"
      described by "Bill total when presented."
    }
    processedPayment is optional PaymentInfo with {
      briefly "Payment"
      described by "Payment info when processed."
    }
    createdAt is TimeStamp with {
      briefly "Created at"
      described by "When the order was created."
    }
    actualSubmittedAt is optional TimeStamp with {
      briefly "Submitted at"
      described by "When the order was submitted."
    }
    actualClosedAt is optional TimeStamp with {
      briefly "Closed at"
      described by "When the order was closed."
    }
  } with {
    briefly "Table order state data"
    described by "Full state of a table order."
  }

  state ActiveOrder of TableOrder.TableOrderStateData with {
    briefly "Active table order"
    described by "A table order in progress."
  }

  handler TableOrderHandler is {
    on command CreateOrder {
      morph entity FrontOfHouse.TableOrder to state
        FrontOfHouse.TableOrder.ActiveOrder
        with command CreateOrder
      tell event OrderCreated to
        entity FrontOfHouse.TableOrder
    }
    on command AddItem {
      tell event ItemAdded to
        entity FrontOfHouse.TableOrder
    }
    on command RemoveItem {
      tell event ItemRemoved to
        entity FrontOfHouse.TableOrder
    }
    on command SubmitOrder {
      tell event OrderSubmitted to
        entity FrontOfHouse.TableOrder
    }
    on command PresentBill {
      tell event BillPresented to
        entity FrontOfHouse.TableOrder
    }
    on command ProcessPayment {
      tell event PaymentProcessed to
        entity FrontOfHouse.TableOrder
    }
    on command CloseOrder {
      tell event OrderClosed to
        entity FrontOfHouse.TableOrder
    }
  } with {
    briefly "Table order command handler"
    described by "Processes table order lifecycle commands."
  }

} with {
  briefly "Table order entity"
  described by {
    | Manages the full lifecycle of a dine-in table order
    | from creation through item management, submission
    | to kitchen and bar, billing, payment, and closing.
  }
}
