// KitchenTicket entity for the Kitchen context

entity KitchenTicket is {

  // ---- Commands ----

  command ReceiveTicket is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Identifier for the new ticket."
    }
    sourceOrderId is String(1, 50) with {
      briefly "Source order ID"
      described by "Identifier of the originating order."
    }
    ticketSource is TicketSource with {
      briefly "Source"
      described by "Whether from dine-in or online."
    }
    ticketItems is many TicketItem with {
      briefly "Items"
      described by "Food items to prepare."
    }
    receivedAt is TimeStamp with {
      briefly "Received at"
      described by "When the ticket was received."
    }
  } with {
    briefly "Receive ticket"
    described by "Receive a new kitchen ticket from an order."
  }

  command AssignStation is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket to assign."
    }
    assignedStation is StationName with {
      briefly "Station"
      described by "Station to assign this ticket to."
    }
  } with {
    briefly "Assign station"
    described by "Assign the ticket to a kitchen station."
  }

  command StartPreparation is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket to start preparing."
    }
    startedAt is TimeStamp with {
      briefly "Started at"
      described by "When preparation began."
    }
  } with {
    briefly "Start preparation"
    described by "Mark the ticket as being prepared."
  }

  command MarkItemReady is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket containing the item."
    }
    readyMenuItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "The item that is ready."
    }
    markedReadyAt is TimeStamp with {
      briefly "Marked at"
      described by "When the item was marked ready."
    }
  } with {
    briefly "Mark item ready"
    described by "Mark an individual item on the ticket as ready."
  }

  command ApproveTicket is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket to approve."
    }
    approvedAt is TimeStamp with {
      briefly "Approved at"
      described by "When the ticket was approved."
    }
  } with {
    briefly "Approve ticket"
    described by "Chef approves the completed ticket for serving."
  }

  command NotifyServer is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket that is ready."
    }
    notifiedAt is TimeStamp with {
      briefly "Notified at"
      described by "When the server was notified."
    }
  } with {
    briefly "Notify server"
    described by "Notify the server that the order is ready."
  }

  // ---- Events ----

  event TicketReceived is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    sourceOrderId is String(1, 50) with {
      briefly "Source order ID"
      described by "Originating order."
    }
    ticketSource is TicketSource with {
      briefly "Source"
      described by "Dine-in or online."
    }
    ticketItems is many TicketItem with {
      briefly "Items"
      described by "Items to prepare."
    }
    receivedAt is TimeStamp with {
      briefly "Received at"
      described by "When received."
    }
  } with {
    briefly "Ticket received"
    described by "Emitted when a new kitchen ticket arrives."
  }

  event StationAssigned is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    assignedStation is StationName with {
      briefly "Station"
      described by "Assigned station."
    }
    assignedAt is TimeStamp with {
      briefly "Assigned at"
      described by "When the station was assigned."
    }
  } with {
    briefly "Station assigned"
    described by "Emitted when a ticket is assigned to a station."
  }

  event PreparationStarted is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started at"
      described by "When preparation began."
    }
  } with {
    briefly "Preparation started"
    described by "Emitted when preparation begins on a ticket."
  }

  event ItemMarkedReady is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    readyMenuItemId is String(1, 50) with {
      briefly "Menu item ID"
      described by "The ready item."
    }
    markedReadyAt is TimeStamp with {
      briefly "Marked at"
      described by "When marked ready."
    }
  } with {
    briefly "Item marked ready"
    described by "Emitted when an item on a ticket is ready."
  }

  event TicketApproved is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    approvedAt is TimeStamp with {
      briefly "Approved at"
      described by "When approved."
    }
  } with {
    briefly "Ticket approved"
    described by "Emitted when the chef approves a completed ticket."
  }

  event ServerNotified is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    notifiedAt is TimeStamp with {
      briefly "Notified at"
      described by "When server was notified."
    }
  } with {
    briefly "Server notified"
    described by "Emitted when the server is notified food is ready."
  }

  // ---- State ----

  record KitchenTicketStateData is {
    kitchenTicketId is KitchenTicketId with {
      briefly "ID"
      described by "Ticket identifier."
    }
    sourceOrderId is String(1, 50) with {
      briefly "Source order ID"
      described by "Originating order."
    }
    ticketSource is TicketSource with {
      briefly "Source"
      described by "Dine-in or online."
    }
    ticketItems is many TicketItem with {
      briefly "Items"
      described by "Items on the ticket."
    }
    ticketStatus is TicketStatus with {
      briefly "Status"
      described by "Current ticket status."
    }
    currentStation is optional StationName with {
      briefly "Station"
      described by "Assigned station."
    }
    receivedAt is TimeStamp with {
      briefly "Received at"
      described by "When the ticket was received."
    }
    actualPreparationStartedAt is optional TimeStamp with {
      briefly "Started at"
      described by "When preparation began."
    }
    ticketApprovedAt is optional TimeStamp with {
      briefly "Approved at"
      described by "When the ticket was approved."
    }
  } with {
    briefly "Kitchen ticket state data"
    described by "Full state of a kitchen ticket."
  }

  state ActiveTicket of KitchenTicket.KitchenTicketStateData with {
    briefly "Active kitchen ticket"
    described by "A kitchen ticket being processed."
  }

  handler KitchenTicketHandler is {
    on command ReceiveTicket {
      morph entity Kitchen.KitchenTicket to state
        Kitchen.KitchenTicket.ActiveTicket
        with command ReceiveTicket
      tell event TicketReceived to
        entity Kitchen.KitchenTicket
    }
    on command AssignStation {
      tell event StationAssigned to
        entity Kitchen.KitchenTicket
    }
    on command StartPreparation {
      tell event PreparationStarted to
        entity Kitchen.KitchenTicket
    }
    on command MarkItemReady {
      tell event ItemMarkedReady to
        entity Kitchen.KitchenTicket
    }
    on command ApproveTicket {
      tell event TicketApproved to
        entity Kitchen.KitchenTicket
    }
    on command NotifyServer {
      tell event ServerNotified to
        entity Kitchen.KitchenTicket
    }
  } with {
    briefly "Kitchen ticket command handler"
    described by "Processes kitchen ticket lifecycle commands."
  }

} with {
  briefly "Kitchen ticket entity"
  described by {
    | Manages the lifecycle of a kitchen ticket from
    | receipt through station assignment, preparation,
    | quality approval, and server notification. Event
    | sourcing ensures tickets survive system crashes.
  }
}
