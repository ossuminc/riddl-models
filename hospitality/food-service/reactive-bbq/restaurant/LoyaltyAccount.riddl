// LoyaltyAccount entity for the Loyalty context
entity LoyaltyAccount is {
  // ---- Commands ----
  command EnrollCustomer is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Identifier for the new account.
      }
    }
    loyaltyCustomerId: LoyaltyCustomerId with {
      briefly "Customer ID"
      described as {
        |Customer to enroll.
      }
    }
    customerDisplayName: String(1,100) with {
      briefly "Name"
      described as {
        |Customer display name.
      }
    }
    customerEmail: String(5,254) with {
      briefly "Email"
      described as {
        |Customer email address.
      }
    }
  } with {
    briefly "Enroll customer"
    described as {
      |Enroll a new customer in the loyalty program.
    }
  }
  command AccruePoints is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account to accrue points to.
      }
    }
    accrualPoints: Natural with {
      briefly "Points"
      described as {
        |Number of points to accrue.
      }
    }
    accrualReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Reason for accrual such as purchase.
      }
    }
    accrualOrderRef: String(1,50)? with {
      briefly "Order reference"
      described as {
        |Reference to the originating order.
      }
    }
  } with {
    briefly "Accrue points"
    described as {
      |Add loyalty points to the account.
    }
  }
  command RedeemPoints is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account to redeem points from.
      }
    }
    redemptionPoints: Natural with {
      briefly "Points"
      described as {
        |Number of points to redeem.
      }
    }
    redemptionReason: String(1,200) with {
      briefly "Reason"
      described as {
        |What the points are being redeemed for.
      }
    }
  } with {
    briefly "Redeem points"
    described as {
      |Redeem loyalty points from the account.
    }
  }
  command SuspendAccount is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account to suspend.
      }
    }
    suspensionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for suspension.
      }
    }
  } with {
    briefly "Suspend account"
    described as {
      |Suspend a loyalty account.
    }
  }
  command ReactivateAccount is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account to reactivate.
      }
    }
  } with {
    briefly "Reactivate account"
    described as {
      |Reactivate a suspended loyalty account.
    }
  }
  // ---- Events ----
  event CustomerEnrolled is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    loyaltyCustomerId: LoyaltyCustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    customerDisplayName: String(1,100) with {
      briefly "Name"
      described as {
        |Customer name.
      }
    }
    customerEmail: String(5,254) with {
      briefly "Email"
      described as {
        |Customer email.
      }
    }
    enrolledAt: TimeStamp with {
      briefly "Enrolled at"
      described as {
        |When enrolled.
      }
    }
  } with {
    briefly "Customer enrolled"
    described as {
      |Emitted when a customer enrolls in loyalty.
    }
  }
  event PointsAccrued is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    accrualPoints: Natural with {
      briefly "Points"
      described as {
        |Points accrued.
      }
    }
    accrualReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Accrual reason.
      }
    }
    newBalance: Natural with {
      briefly "Balance"
      described as {
        |New point balance after accrual.
      }
    }
    accruedAt: TimeStamp with {
      briefly "Accrued at"
      described as {
        |When accrued.
      }
    }
  } with {
    briefly "Points accrued"
    described as {
      |Emitted when points are added to an account.
    }
  }
  event PointsRedeemed is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    redemptionPoints: Natural with {
      briefly "Points"
      described as {
        |Points redeemed.
      }
    }
    redemptionReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Redemption reason.
      }
    }
    remainingBalance: Natural with {
      briefly "Balance"
      described as {
        |Remaining point balance after redemption.
      }
    }
    redeemedAt: TimeStamp with {
      briefly "Redeemed at"
      described as {
        |When redeemed.
      }
    }
  } with {
    briefly "Points redeemed"
    described as {
      |Emitted when points are redeemed from an account.
    }
  }
  event AccountSuspended is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    suspensionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended at"
      described as {
        |When suspended.
      }
    }
  } with {
    briefly "Account suspended"
    described as {
      |Emitted when a loyalty account is suspended.
    }
  }
  event AccountReactivated is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated at"
      described as {
        |When reactivated.
      }
    }
  } with {
    briefly "Account reactivated"
    described as {
      |Emitted when a suspended account is reactivated.
    }
  }
  // ---- State ----
  record LoyaltyAccountStateData is  {
    loyaltyAccountId: LoyaltyAccountId with {
      briefly "ID"
      described as {
        |Account identifier.
      }
    }
    loyaltyCustomerId: LoyaltyCustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    customerDisplayName: String(1,100) with {
      briefly "Name"
      described as {
        |Customer name.
      }
    }
    customerEmail: String(5,254) with {
      briefly "Email"
      described as {
        |Customer email.
      }
    }
    loyaltyAccountStatus: LoyaltyAccountStatus with {
      briefly "Status"
      described as {
        |Current account status.
      }
    }
    pointBalance: Natural with {
      briefly "Balance"
      described as {
        |Current point balance.
      }
    }
    lifetimePoints: Natural with {
      briefly "Lifetime points"
      described as {
        |Total points earned since enrollment.
      }
    }
    recentTransactions: PointTransaction+ with {
      briefly "Transactions"
      described as {
        |Recent point transactions.
      }
    }
    enrolledAt: TimeStamp with {
      briefly "Enrolled at"
      described as {
        |When enrolled.
      }
    }
  } with {
    briefly "Loyalty account state data"
    described as {
      |Full state of a loyalty account.
    }
  }
  state ActiveAccount of type LoyaltyAccount.LoyaltyAccountStateData
  handler LoyaltyAccountHandler is {
    on command EnrollCustomer is {
      morph entity Loyalty.LoyaltyAccount to state Loyalty.LoyaltyAccount.ActiveAccount with command EnrollCustomer
      tell event CustomerEnrolled to entity Loyalty.LoyaltyAccount
    }
    on command AccruePoints is {
      tell event PointsAccrued to entity Loyalty.LoyaltyAccount
    }
    on command RedeemPoints is {
      tell event PointsRedeemed to entity Loyalty.LoyaltyAccount
    }
    on command SuspendAccount is {
      tell event AccountSuspended to entity Loyalty.LoyaltyAccount
    }
    on command ReactivateAccount is {
      tell event AccountReactivated to entity Loyalty.LoyaltyAccount
    }
  } with {
    briefly "Loyalty account command handler"
    described as {
      |Processes loyalty account lifecycle commands.
    }
  }
} with {
  briefly "Loyalty account entity"
  described as {
    | Manages the lifecycle of a loyalty account from
    | enrollment through point accrual, redemption,
    | suspension, and reactivation. Isolated context
    | enables incremental rollout without affecting
    | other systems.
  }
}
