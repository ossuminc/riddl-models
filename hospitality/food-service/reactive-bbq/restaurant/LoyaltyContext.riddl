// Loyalty bounded context
context Loyalty is {
  include "loyalty-types.riddl"
  include "LoyaltyAccount.riddl"
  repository LoyaltyAccountRepository is {
    schema LoyaltyAccountData is relational
      of accounts as type LoyaltyAccount
        index on field LoyaltyAccount.loyaltyAccountId
        index on field LoyaltyAccount.loyaltyCustomerId
        index on field LoyaltyAccount.customerEmail

    handler LoyaltyAccountPersistence is {
      on command LoyaltyAccount.EnrollCustomer is {
        prompt "Store new loyalty account"
      }
      on command LoyaltyAccount.AccruePoints is {
        prompt "Record point accrual"
      }
      on command LoyaltyAccount.RedeemPoints is {
        prompt "Record point redemption"
      }
      on command LoyaltyAccount.SuspendAccount is {
        prompt "Mark account as suspended"
      }
      on command LoyaltyAccount.ReactivateAccount is {
        prompt "Mark account as reactivated"
      }
    } with {
      briefly "Loyalty account persistence"
      described as {
        |Persists loyalty account commands.
      }
    }
  } with {
    briefly "Loyalty account repository"
    described as {
      |Stores and retrieves loyalty account data.
    }
  }
  adaptor FromPayment from context Restaurant.FrontOfHouse is { 
    handler DineInLoyaltyIntake is {
      on event Restaurant.FrontOfHouse.TableOrder.PaymentProcessed is {
        prompt "Accrue loyalty points from dine-in payment"
      }
    } with {
      briefly "Dine-in loyalty intake"
      described as {
        |Accrues points from dine-in payments.
      }
    }
  } with {
    briefly "Front of house payment adaptor"
    described as {
      |Receives dine-in payment events for loyalty accrual.
    }
  }
  adaptor FromOnlinePayment from context Restaurant.OnlineOrdering is { 
    handler OnlineLoyaltyIntake is {
      on event Restaurant.OnlineOrdering.OnlineOrder.OnlinePaymentProcessed is {
        prompt "Accrue loyalty points from online payment"
      }
    } with {
      briefly "Online loyalty intake"
      described as {
        |Accrues points from online payments.
      }
    }
  } with {
    briefly "Online payment adaptor"
    described as {
      |Receives online payment events for loyalty accrual.
    }
  }
} with {
  briefly "Loyalty context"
  described as {
    | Manages loyalty program enrollment, point accrual from
    | both dine-in and online purchases, and point redemption.
    | Isolated as its own bounded context so the loyalty
    | program can be developed and rolled out independently
    | without touching any other context.
  }
}
