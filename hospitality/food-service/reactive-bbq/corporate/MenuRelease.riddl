// MenuRelease entity for the MenuManagement context
entity MenuRelease is {
  // ---- Commands ----
  command CreateMenuRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Identifier for the new release.
      }
    }
    releaseName: String(1,200) with {
      briefly "Name"
      described as {
        |Name of this menu release.
      }
    }
    releaseDescription: String(1,1000) with {
      briefly "Description"
      described as {
        |Description of changes in this release.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |When the release should take effect.
      }
    }
  } with {
    briefly "Create menu release"
    described as {
      |Create a new menu release for atomic distribution.
    }
  }
  command AddItemToRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release to add item to.
      }
    }
    releaseMenuItemId: MenuItemId with {
      briefly "Menu item ID"
      described as {
        |Menu item to include in the release.
      }
    }
    releaseAction: String(1,50) with {
      briefly "Action"
      described as {
        |Action: add, update, remove, or price-change.
      }
    }
  } with {
    briefly "Add item to release"
    described as {
      |Add a menu item to the release.
    }
  }
  command FinalizeRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release to finalize.
      }
    }
    finalizedAt: TimeStamp with {
      briefly "Finalized at"
      described as {
        |When the release was finalized.
      }
    }
  } with {
    briefly "Finalize release"
    described as {
      |Lock the release for review before publishing.
    }
  }
  command PublishRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release to publish.
      }
    }
    publishedAt: TimeStamp with {
      briefly "Published at"
      described as {
        |When the release was published.
      }
    }
  } with {
    briefly "Publish release"
    described as {
      |Publish the release to all restaurant locations atomically.
    }
  }
  command RollbackRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release to roll back.
      }
    }
    rollbackReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for rollback.
      }
    }
    rolledBackAt: TimeStamp with {
      briefly "Rolled back at"
      described as {
        |When the release was rolled back.
      }
    }
  } with {
    briefly "Rollback release"
    described as {
      |Roll back a published release.
    }
  }
  // ---- Events ----
  event MenuReleaseCreated is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    releaseName: String(1,200) with {
      briefly "Name"
      described as {
        |Release name.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |When effective.
      }
    }
    releaseCreatedAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
  } with {
    briefly "Menu release created"
    described as {
      |Emitted when a new menu release is created.
    }
  }
  event ItemAddedToRelease is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    releaseMenuItemId: MenuItemId with {
      briefly "Menu item ID"
      described as {
        |Added item.
      }
    }
    releaseAction: String(1,50) with {
      briefly "Action"
      described as {
        |Action for this item.
      }
    }
  } with {
    briefly "Item added to release"
    described as {
      |Emitted when an item is added to a release.
    }
  }
  event ReleaseFinalized is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    itemCount: Natural with {
      briefly "Item count"
      described as {
        |Number of items in the release.
      }
    }
    finalizedAt: TimeStamp with {
      briefly "Finalized at"
      described as {
        |When finalized.
      }
    }
  } with {
    briefly "Release finalized"
    described as {
      |Emitted when a release is finalized for review.
    }
  }
  event ReleasePublished is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    releaseName: String(1,200) with {
      briefly "Name"
      described as {
        |Release name.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |When effective.
      }
    }
    publishedAt: TimeStamp with {
      briefly "Published at"
      described as {
        |When published.
      }
    }
  } with {
    briefly "Release published"
    described as {
      | Emitted when a menu release is published to all
      | locations. This is the atomic distribution event
      | that updates menus chain-wide simultaneously.
    }
  }
  event ReleaseRolledBack is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    rollbackReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rollback reason.
      }
    }
    rolledBackAt: TimeStamp with {
      briefly "Rolled back at"
      described as {
        |When rolled back.
      }
    }
  } with {
    briefly "Release rolled back"
    described as {
      |Emitted when a published release is rolled back.
    }
  }
  // ---- State ----
  record MenuReleaseStateData is  {
    menuReleaseId: MenuReleaseId with {
      briefly "ID"
      described as {
        |Release identifier.
      }
    }
    releaseName: String(1,200) with {
      briefly "Name"
      described as {
        |Release name.
      }
    }
    releaseDescription: String(1,1000) with {
      briefly "Description"
      described as {
        |Release description.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |When effective.
      }
    }
    menuReleaseStatus: MenuReleaseStatus with {
      briefly "Status"
      described as {
        |Current release status.
      }
    }
    releaseItems: MenuItemId+ with {
      briefly "Items"
      described as {
        |Menu items in this release.
      }
    }
    releaseCreatedAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
    actualPublishedAt: TimeStamp? with {
      briefly "Published at"
      described as {
        |When published.
      }
    }
  } with {
    briefly "Menu release state data"
    described as {
      |Full state of a menu release.
    }
  }
  state ActiveRelease of type MenuRelease.MenuReleaseStateData
  handler MenuReleaseHandler is {
    on command CreateMenuRelease is {
      morph entity MenuManagement.MenuRelease to state MenuManagement.MenuRelease.ActiveRelease with command CreateMenuRelease
      tell event MenuReleaseCreated to entity MenuManagement.MenuRelease
    }
    on command AddItemToRelease is {
      tell event ItemAddedToRelease to entity MenuManagement.MenuRelease
    }
    on command FinalizeRelease is {
      tell event ReleaseFinalized to entity MenuManagement.MenuRelease
    }
    on command PublishRelease is {
      tell event ReleasePublished to entity MenuManagement.MenuRelease
    }
    on command RollbackRelease is {
      tell event ReleaseRolledBack to entity MenuManagement.MenuRelease
    }
  } with {
    briefly "Menu release command handler"
    described as {
      |Processes menu release lifecycle commands.
    }
  }
} with {
  briefly "Menu release entity"
  described as {
    | Manages the lifecycle of a menu release from creation
    | through item addition, finalization, publishing, and
    | optional rollback. Publishing distributes menu updates
    | atomically to all 500+ restaurant locations, solving
    | the Head Chef's monthly coordination bottleneck.
  }
}
