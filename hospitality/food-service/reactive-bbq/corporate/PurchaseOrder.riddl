// PurchaseOrder entity for the SupplyChain context

entity PurchaseOrder is {

  // ---- Commands ----

  command CreateBulkOrder is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Identifier for the new order."
    }
    vendorId is VendorId with {
      briefly "Vendor ID"
      described by "Vendor to order from."
    }
    vendorName is String(1, 200) with {
      briefly "Vendor name"
      described by "Name of the vendor."
    }
    poLineItems is many OrderLineItem with {
      briefly "Line items"
      described by "Items being ordered."
    }
    requestedDeliveryDate is Date with {
      briefly "Delivery date"
      described by "Requested delivery date."
    }
  } with {
    briefly "Create bulk order"
    described by "Create a new bulk purchase order."
  }

  command ApproveOrder is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order to approve."
    }
    approverId is String(1, 50) with {
      briefly "Approver"
      described by "Identifier of the approver."
    }
    poApprovedAt is TimeStamp with {
      briefly "Approved at"
      described by "When approved."
    }
  } with {
    briefly "Approve order"
    described by "Approve a purchase order for fulfillment."
  }

  command ShipOrder is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order that shipped."
    }
    trackingNumber is optional String(1, 100) with {
      briefly "Tracking number"
      described by "Shipment tracking number."
    }
    estimatedArrival is Date with {
      briefly "ETA"
      described by "Estimated arrival date."
    }
  } with {
    briefly "Ship order"
    described by "Record that the order has shipped."
  }

  command ReceiveShipment is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order received."
    }
    shipmentReceivedAt is TimeStamp with {
      briefly "Received at"
      described by "When the shipment was received."
    }
    receivedInFull is Boolean with {
      briefly "In full"
      described by "Whether the full order was received."
    }
    shipmentNotes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Notes about the shipment condition."
    }
  } with {
    briefly "Receive shipment"
    described by "Record receipt of the shipment."
  }

  command ReportIssue is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order with the issue."
    }
    poIssueDescription is String(1, 1000) with {
      briefly "Issue"
      described by "Description of the issue."
    }
    poReportedAt is TimeStamp with {
      briefly "Reported at"
      described by "When the issue was reported."
    }
  } with {
    briefly "Report issue"
    described by "Report a problem with the order."
  }

  // ---- Events ----

  event BulkOrderCreated is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    vendorId is VendorId with {
      briefly "Vendor ID"
      described by "Vendor."
    }
    vendorName is String(1, 200) with {
      briefly "Vendor name"
      described by "Vendor name."
    }
    poLineItems is many OrderLineItem with {
      briefly "Line items"
      described by "Ordered items."
    }
    poCreatedAt is TimeStamp with {
      briefly "Created at"
      described by "When created."
    }
  } with {
    briefly "Bulk order created"
    described by "Emitted when a bulk purchase order is created."
  }

  event OrderApproved is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    approverId is String(1, 50) with {
      briefly "Approver"
      described by "Approver."
    }
    poApprovedAt is TimeStamp with {
      briefly "Approved at"
      described by "When approved."
    }
  } with {
    briefly "Order approved"
    described by "Emitted when a purchase order is approved."
  }

  event OrderShipped is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    trackingNumber is optional String(1, 100) with {
      briefly "Tracking number"
      described by "Tracking number."
    }
    estimatedArrival is Date with {
      briefly "ETA"
      described by "Estimated arrival."
    }
    poShippedAt is TimeStamp with {
      briefly "Shipped at"
      described by "When shipped."
    }
  } with {
    briefly "Order shipped"
    described by "Emitted when a purchase order ships."
  }

  event ShipmentReceived is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    receivedInFull is Boolean with {
      briefly "In full"
      described by "Whether received in full."
    }
    shipmentReceivedAt is TimeStamp with {
      briefly "Received at"
      described by "When received."
    }
  } with {
    briefly "Shipment received"
    described by "Emitted when a shipment is received."
  }

  event IssueReported is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    poIssueDescription is String(1, 1000) with {
      briefly "Issue"
      described by "Issue description."
    }
    poReportedAt is TimeStamp with {
      briefly "Reported at"
      described by "When reported."
    }
  } with {
    briefly "Issue reported"
    described by "Emitted when an issue is reported with an order."
  }

  // ---- State ----

  record PurchaseOrderStateData is {
    purchaseOrderId is PurchaseOrderId with {
      briefly "ID"
      described by "Order identifier."
    }
    vendorId is VendorId with {
      briefly "Vendor ID"
      described by "Vendor."
    }
    vendorName is String(1, 200) with {
      briefly "Vendor name"
      described by "Vendor name."
    }
    poLineItems is many OrderLineItem with {
      briefly "Line items"
      described by "Ordered items."
    }
    purchaseOrderStatus is PurchaseOrderStatus with {
      briefly "Status"
      described by "Current order status."
    }
    requestedDeliveryDate is Date with {
      briefly "Delivery date"
      described by "Requested delivery date."
    }
    trackingNumber is optional String(1, 100) with {
      briefly "Tracking number"
      described by "Shipment tracking."
    }
    poCreatedAt is TimeStamp with {
      briefly "Created at"
      described by "When created."
    }
    actualPoApprovedAt is optional TimeStamp with {
      briefly "Approved at"
      described by "When approved."
    }
    actualShipmentReceivedAt is optional TimeStamp with {
      briefly "Received at"
      described by "When received."
    }
  } with {
    briefly "Purchase order state data"
    described by "Full state of a purchase order."
  }

  state ActivePurchaseOrder of
    PurchaseOrder.PurchaseOrderStateData with {
    briefly "Active purchase order"
    described by "A purchase order in the system."
  }

  handler PurchaseOrderHandler is {
    on command CreateBulkOrder {
      morph entity SupplyChain.PurchaseOrder to state
        SupplyChain.PurchaseOrder.ActivePurchaseOrder
        with command CreateBulkOrder
      tell event BulkOrderCreated to
        entity SupplyChain.PurchaseOrder
    }
    on command ApproveOrder {
      tell event OrderApproved to
        entity SupplyChain.PurchaseOrder
    }
    on command ShipOrder {
      tell event OrderShipped to
        entity SupplyChain.PurchaseOrder
    }
    on command ReceiveShipment {
      tell event ShipmentReceived to
        entity SupplyChain.PurchaseOrder
    }
    on command ReportIssue {
      tell event IssueReported to
        entity SupplyChain.PurchaseOrder
    }
  } with {
    briefly "Purchase order command handler"
    described by "Processes purchase order lifecycle commands."
  }

} with {
  briefly "Purchase order entity"
  described by {
    | Manages the lifecycle of a bulk purchase order from
    | creation through approval, shipping, receipt, and
    | issue reporting.
  }
}
