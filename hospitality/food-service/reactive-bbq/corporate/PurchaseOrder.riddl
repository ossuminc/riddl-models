// PurchaseOrder entity for the SupplyChain context
entity PurchaseOrder is {
  // ---- Commands ----
  command CreateBulkOrder is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Identifier for the new order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor ID"
      described as {
        |Vendor to order from.
      }
    }
    vendorName: String(1,200) with {
      briefly "Vendor name"
      described as {
        |Name of the vendor.
      }
    }
    poLineItems: OrderLineItem+ with {
      briefly "Line items"
      described as {
        |Items being ordered.
      }
    }
    requestedDeliveryDate: Date with {
      briefly "Delivery date"
      described as {
        |Requested delivery date.
      }
    }
  } with {
    briefly "Create bulk order"
    described as {
      |Create a new bulk purchase order.
    }
  }
  command ApproveOrder is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order to approve.
      }
    }
    approverId: String(1,50) with {
      briefly "Approver"
      described as {
        |Identifier of the approver.
      }
    }
    poApprovedAt: TimeStamp with {
      briefly "Approved at"
      described as {
        |When approved.
      }
    }
  } with {
    briefly "Approve order"
    described as {
      |Approve a purchase order for fulfillment.
    }
  }
  command ShipOrder is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order that shipped.
      }
    }
    trackingNumber: String(1,100)? with {
      briefly "Tracking number"
      described as {
        |Shipment tracking number.
      }
    }
    estimatedArrival: Date with {
      briefly "ETA"
      described as {
        |Estimated arrival date.
      }
    }
  } with {
    briefly "Ship order"
    described as {
      |Record that the order has shipped.
    }
  }
  command ReceiveShipment is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order received.
      }
    }
    shipmentReceivedAt: TimeStamp with {
      briefly "Received at"
      described as {
        |When the shipment was received.
      }
    }
    receivedInFull: Boolean with {
      briefly "In full"
      described as {
        |Whether the full order was received.
      }
    }
    shipmentNotes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Notes about the shipment condition.
      }
    }
  } with {
    briefly "Receive shipment"
    described as {
      |Record receipt of the shipment.
    }
  }
  command ReportIssue is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order with the issue.
      }
    }
    poIssueDescription: String(1,1000) with {
      briefly "Issue"
      described as {
        |Description of the issue.
      }
    }
    poReportedAt: TimeStamp with {
      briefly "Reported at"
      described as {
        |When the issue was reported.
      }
    }
  } with {
    briefly "Report issue"
    described as {
      |Report a problem with the order.
    }
  }
  // ---- Events ----
  event BulkOrderCreated is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor ID"
      described as {
        |Vendor.
      }
    }
    vendorName: String(1,200) with {
      briefly "Vendor name"
      described as {
        |Vendor name.
      }
    }
    poLineItems: OrderLineItem+ with {
      briefly "Line items"
      described as {
        |Ordered items.
      }
    }
    poCreatedAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
  } with {
    briefly "Bulk order created"
    described as {
      |Emitted when a bulk purchase order is created.
    }
  }
  event OrderApproved is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    approverId: String(1,50) with {
      briefly "Approver"
      described as {
        |Approver.
      }
    }
    poApprovedAt: TimeStamp with {
      briefly "Approved at"
      described as {
        |When approved.
      }
    }
  } with {
    briefly "Order approved"
    described as {
      |Emitted when a purchase order is approved.
    }
  }
  event OrderShipped is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    trackingNumber: String(1,100)? with {
      briefly "Tracking number"
      described as {
        |Tracking number.
      }
    }
    estimatedArrival: Date with {
      briefly "ETA"
      described as {
        |Estimated arrival.
      }
    }
    poShippedAt: TimeStamp with {
      briefly "Shipped at"
      described as {
        |When shipped.
      }
    }
  } with {
    briefly "Order shipped"
    described as {
      |Emitted when a purchase order ships.
    }
  }
  event ShipmentReceived is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    receivedInFull: Boolean with {
      briefly "In full"
      described as {
        |Whether received in full.
      }
    }
    shipmentReceivedAt: TimeStamp with {
      briefly "Received at"
      described as {
        |When received.
      }
    }
  } with {
    briefly "Shipment received"
    described as {
      |Emitted when a shipment is received.
    }
  }
  event IssueReported is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    poIssueDescription: String(1,1000) with {
      briefly "Issue"
      described as {
        |Issue description.
      }
    }
    poReportedAt: TimeStamp with {
      briefly "Reported at"
      described as {
        |When reported.
      }
    }
  } with {
    briefly "Issue reported"
    described as {
      |Emitted when an issue is reported with an order.
    }
  }
  // ---- State ----
  record PurchaseOrderStateData is  {
    purchaseOrderId: PurchaseOrderId with {
      briefly "ID"
      described as {
        |Order identifier.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor ID"
      described as {
        |Vendor.
      }
    }
    vendorName: String(1,200) with {
      briefly "Vendor name"
      described as {
        |Vendor name.
      }
    }
    poLineItems: OrderLineItem+ with {
      briefly "Line items"
      described as {
        |Ordered items.
      }
    }
    purchaseOrderStatus: PurchaseOrderStatus with {
      briefly "Status"
      described as {
        |Current order status.
      }
    }
    requestedDeliveryDate: Date with {
      briefly "Delivery date"
      described as {
        |Requested delivery date.
      }
    }
    trackingNumber: String(1,100)? with {
      briefly "Tracking number"
      described as {
        |Shipment tracking.
      }
    }
    poCreatedAt: TimeStamp with {
      briefly "Created at"
      described as {
        |When created.
      }
    }
    actualPoApprovedAt: TimeStamp? with {
      briefly "Approved at"
      described as {
        |When approved.
      }
    }
    actualShipmentReceivedAt: TimeStamp? with {
      briefly "Received at"
      described as {
        |When received.
      }
    }
  } with {
    briefly "Purchase order state data"
    described as {
      |Full state of a purchase order.
    }
  }
  state ActivePurchaseOrder of type PurchaseOrder.PurchaseOrderStateData
  handler PurchaseOrderHandler is {
    on command CreateBulkOrder is {
      morph entity SupplyChain.PurchaseOrder to state SupplyChain.PurchaseOrder.ActivePurchaseOrder with command CreateBulkOrder
      tell event BulkOrderCreated to entity SupplyChain.PurchaseOrder
    }
    on command ApproveOrder is {
      tell event OrderApproved to entity SupplyChain.PurchaseOrder
    }
    on command ShipOrder is {
      tell event OrderShipped to entity SupplyChain.PurchaseOrder
    }
    on command ReceiveShipment is {
      tell event ShipmentReceived to entity SupplyChain.PurchaseOrder
    }
    on command ReportIssue is {
      tell event IssueReported to entity SupplyChain.PurchaseOrder
    }
  } with {
    briefly "Purchase order command handler"
    described as {
      |Processes purchase order lifecycle commands.
    }
  }
} with {
  briefly "Purchase order entity"
  described as {
    | Manages the lifecycle of a bulk purchase order from
    | creation through approval, shipping, receipt, and
    | issue reporting.
  }
}
