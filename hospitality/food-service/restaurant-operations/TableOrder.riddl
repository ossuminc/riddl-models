// Restaurant Operations - TableOrder Entity

entity TableOrder is {

  // Commands
  command CreateOrder is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "New order identifier."
    }
    table is TableInfo with {
      briefly "Table"
      described by "Table information."
    }
    server is ServerId with {
      briefly "Server"
      described by "Assigned server."
    }
    guests is GuestInfo with {
      briefly "Guests"
      described by "Guest information."
    }
    orderType is OrderType with {
      briefly "Type"
      described by "Order type."
    }
  } with {
    briefly "Create order"
    described by "Creates a new table order."
  }

  command AddItem is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    menuItem is MenuItem with {
      briefly "Item"
      described by "Menu item to add."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Item quantity."
    }
    modifications is many optional String(1, 200) with {
      briefly "Mods"
      described by "Item modifications."
    }
    seatNumber is optional Natural with {
      briefly "Seat"
      described by "Seat number."
    }
  } with {
    briefly "Add item"
    described by "Adds item to order."
  }

  command ModifyItem is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    lineNumber is Natural with {
      briefly "Line"
      described by "Line number."
    }
    updatedModifications is many String(1, 200) with {
      briefly "Mods"
      described by "New modifications."
    }
  } with {
    briefly "Modify item"
    described by "Modifies order item."
  }

  command VoidItem is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    lineNumber is Natural with {
      briefly "Line"
      described by "Line to void."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Void reason."
    }
    authorizedBy is ServerId with {
      briefly "Authorized by"
      described by "Manager authorizing."
    }
  } with {
    briefly "Void item"
    described by "Voids order item."
  }

  command SubmitOrder is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    submittedBy is ServerId with {
      briefly "Submitted by"
      described by "Server submitting."
    }
  } with {
    briefly "Submit order"
    described by "Submits order to kitchen."
  }

  command MarkItemPreparing is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    lineNumber is Natural with {
      briefly "Line"
      described by "Line number."
    }
    station is KitchenStationId with {
      briefly "Station"
      described by "Kitchen station."
    }
  } with {
    briefly "Mark preparing"
    described by "Marks item as being prepared."
  }

  command MarkItemReady is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    lineNumber is Natural with {
      briefly "Line"
      described by "Line number."
    }
    readyAt is TimeStamp with {
      briefly "Ready at"
      described by "Time ready."
    }
  } with {
    briefly "Mark ready"
    described by "Marks item ready for service."
  }

  command ServeItem is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    lineNumber is Natural with {
      briefly "Line"
      described by "Line number."
    }
    servedBy is ServerId with {
      briefly "Served by"
      described by "Server delivering."
    }
  } with {
    briefly "Serve item"
    described by "Records item served."
  }

  command RequestBill is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    requestedBy is ServerId with {
      briefly "Requested by"
      described by "Server requesting."
    }
  } with {
    briefly "Request bill"
    described by "Requests bill for table."
  }

  command ApplyDiscount is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    discountAmount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Discount amount."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Discount reason."
    }
    authorizedBy is ServerId with {
      briefly "Authorized by"
      described by "Manager authorizing."
    }
  } with {
    briefly "Apply discount"
    described by "Applies discount to order."
  }

  command ProcessPayment is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Payment amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    tipAmount is optional Decimal(10, 2) with {
      briefly "Tip"
      described by "Tip amount."
    }
  } with {
    briefly "Process payment"
    described by "Processes payment for order."
  }

  command SplitBill is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    splitType is String(1, 50) with {
      briefly "Split type"
      described by "How to split (equal, by seat, custom)."
    }
    numberOfWays is optional Natural with {
      briefly "Ways"
      described by "Number of ways to split."
    }
  } with {
    briefly "Split bill"
    described by "Splits bill for payment."
  }

  command CloseOrder is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    closedBy is ServerId with {
      briefly "Closed by"
      described by "Server closing."
    }
  } with {
    briefly "Close order"
    described by "Closes completed order."
  }

  command CancelOrder is {
    orderId is TableOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is ServerId with {
      briefly "Cancelled by"
      described by "Person cancelling."
    }
  } with {
    briefly "Cancel order"
    described by "Cancels the order."
  }

  // Events
  event OrderCreated is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    table is TableInfo with { briefly "Table" described by "Table info." }
    server is ServerId with { briefly "Server" described by "Assigned server." }
    guests is GuestInfo with { briefly "Guests" described by "Guest info." }
    orderType is OrderType with { briefly "Type" described by "Order type." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Order created"
    described by "Emitted when order is created."
  }

  event ItemAdded is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineItem is OrderLineItem with { briefly "Item" described by "Added item." }
  } with {
    briefly "Item added"
    described by "Emitted when item is added."
  }

  event ItemModified is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineNumber is Natural with { briefly "Line" described by "Line number." }
    updatedModifications is many String(1, 200) with { briefly "Mods" described by "Modifications." }
    modifiedAt is TimeStamp with { briefly "Modified" described by "Modification time." }
  } with {
    briefly "Item modified"
    described by "Emitted when item is modified."
  }

  event ItemVoided is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineNumber is Natural with { briefly "Line" described by "Line number." }
    reason is String(1, 200) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "Void time." }
  } with {
    briefly "Item voided"
    described by "Emitted when item is voided."
  }

  event OrderSubmitted is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    submittedBy is ServerId with { briefly "Submitted by" described by "Server." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submit time." }
    tickets is many KitchenTicket with { briefly "Tickets" described by "Kitchen tickets." }
  } with {
    briefly "Order submitted"
    described by "Emitted when order goes to kitchen."
  }

  event ItemPreparing is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineNumber is Natural with { briefly "Line" described by "Line number." }
    station is KitchenStationId with { briefly "Station" described by "Kitchen station." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Item preparing"
    described by "Emitted when prep starts."
  }

  event ItemReady is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineNumber is Natural with { briefly "Line" described by "Line number." }
    readyAt is TimeStamp with { briefly "Ready" described by "Ready time." }
  } with {
    briefly "Item ready"
    described by "Emitted when item is ready."
  }

  event ItemServed is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    lineNumber is Natural with { briefly "Line" described by "Line number." }
    servedBy is ServerId with { briefly "Served by" described by "Server." }
    servedAt is TimeStamp with { briefly "Served" described by "Serve time." }
  } with {
    briefly "Item served"
    described by "Emitted when item is served."
  }

  event BillRequested is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment info." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Bill requested"
    described by "Emitted when bill is requested."
  }

  event DiscountApplied is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    discountAmount is Decimal(10, 2) with { briefly "Amount" described by "Discount." }
    reason is String(1, 200) with { briefly "Reason" described by "Discount reason." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Apply time." }
  } with {
    briefly "Discount applied"
    described by "Emitted when discount is applied."
  }

  event PaymentProcessed is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    paymentMethod is String(1, 50) with { briefly "Method" described by "Payment method." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event BillSplit is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    splitType is String(1, 50) with { briefly "Split type" described by "Split type." }
    splits is many SplitPayment with { briefly "Splits" described by "Payment splits." }
    splitAt is TimeStamp with { briefly "Split" described by "Split time." }
  } with {
    briefly "Bill split"
    described by "Emitted when bill is split."
  }

  event OrderClosed is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    closedBy is ServerId with { briefly "Closed by" described by "Server." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
    finalTotal is Decimal(10, 2) with { briefly "Total" described by "Final total." }
  } with {
    briefly "Order closed"
    described by "Emitted when order is closed."
  }

  event OrderCancelled is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledBy is ServerId with { briefly "Cancelled by" described by "Canceller." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Order cancelled"
    described by "Emitted when order is cancelled."
  }

  // State Records
  record ActiveStateData is {
    orderId is TableOrderId with { briefly "Order" described by "Order ID." }
    table is TableInfo with { briefly "Table" described by "Table info." }
    server is ServerId with { briefly "Server" described by "Assigned server." }
    guests is GuestInfo with { briefly "Guests" described by "Guest info." }
    orderType is OrderType with { briefly "Type" described by "Order type." }
    lineItems is many optional OrderLineItem with { briefly "Items" described by "Order items." }
    orderStatus is OrderStatus with { briefly "Status" described by "Order status." }
    currentPayment is optional PaymentInfo with { briefly "Payment" described by "Payment info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active order."
  }

  // States
  state ActiveState of TableOrder.ActiveStateData with {
    briefly "Order active"
    described by "Order is being processed."
  }

  // Handler
  handler TableOrderHandler is {
    on command CreateOrder {
      morph entity OrderContext.TableOrder to state OrderContext.TableOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity OrderContext.TableOrder
    }

    on command AddItem {
      tell event ItemAdded to entity OrderContext.TableOrder
    }

    on command ModifyItem {
      tell event ItemModified to entity OrderContext.TableOrder
    }

    on command VoidItem {
      tell event ItemVoided to entity OrderContext.TableOrder
    }

    on command SubmitOrder {
      tell event OrderSubmitted to entity OrderContext.TableOrder
    }

    on command MarkItemPreparing {
      tell event ItemPreparing to entity OrderContext.TableOrder
    }

    on command MarkItemReady {
      tell event ItemReady to entity OrderContext.TableOrder
    }

    on command ServeItem {
      tell event ItemServed to entity OrderContext.TableOrder
    }

    on command RequestBill {
      tell event BillRequested to entity OrderContext.TableOrder
    }

    on command ApplyDiscount {
      tell event DiscountApplied to entity OrderContext.TableOrder
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity OrderContext.TableOrder
    }

    on command SplitBill {
      tell event BillSplit to entity OrderContext.TableOrder
    }

    on command CloseOrder {
      tell event OrderClosed to entity OrderContext.TableOrder
    }

    on command CancelOrder {
      tell event OrderCancelled to entity OrderContext.TableOrder
    }
  } with {
    briefly "Processes order commands"
    described by {
      | Handles table order lifecycle from creation
      | through service, payment, and close.
    }
  }

} with {
  briefly "Table order aggregate"
  described by {
    | The TableOrder entity manages restaurant orders
    | and their lifecycle through service and payment.
  }
}
