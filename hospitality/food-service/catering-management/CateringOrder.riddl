// Catering Management - CateringOrder Entity

entity CateringOrder is {

  // Commands
  command CreateOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "New order identifier."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    event is EventDetails with {
      briefly "Event"
      described by "Event details."
    }
    serviceType is ServiceType with {
      briefly "Service"
      described by "Type of service."
    }
  } with {
    briefly "Create order"
    described by "Creates a new catering order."
  }

  command AddMenuItem is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    item is MenuItem with {
      briefly "Item"
      described by "Menu item to add."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Number of servings."
    }
    specialRequests is optional String(1, 500) with {
      briefly "Requests"
      described by "Special requests."
    }
  } with {
    briefly "Add menu item"
    described by "Adds item to order."
  }

  command RemoveMenuItem is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    itemId is MenuItemId with {
      briefly "Item"
      described by "Item to remove."
    }
  } with {
    briefly "Remove menu item"
    described by "Removes item from order."
  }

  command ConfirmOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    confirmedBy is String(1, 200) with {
      briefly "Confirmed by"
      described by "Person confirming."
    }
  } with {
    briefly "Confirm order"
    described by "Confirms the catering order."
  }

  command SetDeliveryInfo is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    delivery is DeliveryInfo with {
      briefly "Delivery"
      described by "Delivery details."
    }
  } with {
    briefly "Set delivery info"
    described by "Sets delivery information."
  }

  command AssignStaff is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    staffId is StaffId with {
      briefly "Staff"
      described by "Staff member."
    }
    role is String(1, 50) with {
      briefly "Role"
      described by "Assignment role."
    }
  } with {
    briefly "Assign staff"
    described by "Assigns staff to order."
  }

  command StartPreparation is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    startedBy is StaffId with {
      briefly "Started by"
      described by "Chef starting prep."
    }
  } with {
    briefly "Start preparation"
    described by "Begins food preparation."
  }

  command MarkReady is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    readyAt is TimeStamp with {
      briefly "Ready at"
      described by "Time marked ready."
    }
  } with {
    briefly "Mark ready"
    described by "Marks order ready for delivery."
  }

  command DispatchDelivery is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    dispatchedAt is TimeStamp with {
      briefly "Dispatched"
      described by "Dispatch time."
    }
    driver is String(1, 200) with {
      briefly "Driver"
      described by "Delivery driver."
    }
  } with {
    briefly "Dispatch delivery"
    described by "Dispatches order for delivery."
  }

  command ConfirmDelivery is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery time."
    }
    receivedBy is String(1, 200) with {
      briefly "Received by"
      described by "Person receiving delivery."
    }
  } with {
    briefly "Confirm delivery"
    described by "Confirms delivery completed."
  }

  command RecordPayment is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Payment amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    reference is String(1, 100) with {
      briefly "Reference"
      described by "Payment reference."
    }
  } with {
    briefly "Record payment"
    described by "Records payment received."
  }

  command CompleteOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
  } with {
    briefly "Complete order"
    described by "Marks order as completed."
  }

  command CancelOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 200) with {
      briefly "Cancelled by"
      described by "Person cancelling."
    }
  } with {
    briefly "Cancel order"
    described by "Cancels the catering order."
  }

  // Events
  event OrderCreated is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    event is EventDetails with { briefly "Event" described by "Event details." }
    serviceType is ServiceType with { briefly "Service" described by "Service type." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Order created"
    described by "Emitted when order is created."
  }

  event MenuItemAdded is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    lineItem is OrderLineItem with { briefly "Item" described by "Added line item." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Menu item added"
    described by "Emitted when item is added."
  }

  event MenuItemRemoved is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    itemId is MenuItemId with { briefly "Item" described by "Removed item ID." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Menu item removed"
    described by "Emitted when item is removed."
  }

  event OrderConfirmed is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    confirmedBy is String(1, 200) with { briefly "Confirmed by" described by "Confirmer." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment details." }
  } with {
    briefly "Order confirmed"
    described by "Emitted when order is confirmed."
  }

  event DeliveryInfoSet is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    delivery is DeliveryInfo with { briefly "Delivery" described by "Delivery details." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Delivery info set"
    described by "Emitted when delivery info is set."
  }

  event StaffAssigned is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    assignment is StaffAssignment with { briefly "Assignment" described by "Staff assignment." }
  } with {
    briefly "Staff assigned"
    described by "Emitted when staff is assigned."
  }

  event PreparationStarted is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    startedBy is StaffId with { briefly "Started by" described by "Chef." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Preparation started"
    described by "Emitted when prep begins."
  }

  event OrderReady is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    readyAt is TimeStamp with { briefly "Ready" described by "Ready time." }
  } with {
    briefly "Order ready"
    described by "Emitted when order is ready."
  }

  event DeliveryDispatched is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    dispatchedAt is TimeStamp with { briefly "Dispatched" described by "Dispatch time." }
    driver is String(1, 200) with { briefly "Driver" described by "Delivery driver." }
  } with {
    briefly "Delivery dispatched"
    described by "Emitted when order is dispatched."
  }

  event DeliveryConfirmed is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    receivedBy is String(1, 200) with { briefly "Received by" described by "Receiver." }
  } with {
    briefly "Delivery confirmed"
    described by "Emitted when delivery is confirmed."
  }

  event PaymentRecorded is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    paymentMethod is String(1, 50) with { briefly "Method" described by "Payment method." }
    reference is String(1, 100) with { briefly "Reference" described by "Reference." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Payment recorded"
    described by "Emitted when payment is recorded."
  }

  event OrderCompleted is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Order completed"
    described by "Emitted when order is completed."
  }

  event OrderCancelled is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is String(1, 200) with { briefly "Cancelled by" described by "Canceller." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Order cancelled"
    described by "Emitted when order is cancelled."
  }

  // State Records
  record ActiveStateData is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    event is EventDetails with { briefly "Event" described by "Event details." }
    serviceType is ServiceType with { briefly "Service" described by "Service type." }
    lineItems is many optional OrderLineItem with { briefly "Items" described by "Order items." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    delivery is optional DeliveryInfo with { briefly "Delivery" described by "Delivery info." }
    staffAssignments is many optional StaffAssignment with { briefly "Staff" described by "Assigned staff." }
    payment is optional PaymentInfo with { briefly "Payment" described by "Payment info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active order."
  }

  // States
  state ActiveState of CateringOrder.ActiveStateData with {
    briefly "Order active"
    described by "Order is being processed."
  }

  // Handler
  handler CateringOrderHandler is {
    on command CreateOrder {
      morph entity CateringContext.CateringOrder to state CateringContext.CateringOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity CateringContext.CateringOrder
    }

    on command AddMenuItem {
      tell event MenuItemAdded to entity CateringContext.CateringOrder
    }

    on command RemoveMenuItem {
      tell event MenuItemRemoved to entity CateringContext.CateringOrder
    }

    on command ConfirmOrder {
      tell event OrderConfirmed to entity CateringContext.CateringOrder
    }

    on command SetDeliveryInfo {
      tell event DeliveryInfoSet to entity CateringContext.CateringOrder
    }

    on command AssignStaff {
      tell event StaffAssigned to entity CateringContext.CateringOrder
    }

    on command StartPreparation {
      tell event PreparationStarted to entity CateringContext.CateringOrder
    }

    on command MarkReady {
      tell event OrderReady to entity CateringContext.CateringOrder
    }

    on command DispatchDelivery {
      tell event DeliveryDispatched to entity CateringContext.CateringOrder
    }

    on command ConfirmDelivery {
      tell event DeliveryConfirmed to entity CateringContext.CateringOrder
    }

    on command RecordPayment {
      tell event PaymentRecorded to entity CateringContext.CateringOrder
    }

    on command CompleteOrder {
      tell event OrderCompleted to entity CateringContext.CateringOrder
    }

    on command CancelOrder {
      tell event OrderCancelled to entity CateringContext.CateringOrder
    }
  } with {
    briefly "Processes order commands"
    described by {
      | Handles catering order lifecycle from creation
      | through preparation, delivery, and completion.
    }
  }

} with {
  briefly "Catering order aggregate"
  described by {
    | The CateringOrder entity manages catering orders
    | and their lifecycle through service delivery.
  }
}
