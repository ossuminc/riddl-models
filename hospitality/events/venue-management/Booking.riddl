// Venue Management - Booking Entity

entity Booking is {

  // Commands
  command CreateBooking is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "New booking identifier."
    }
    venue is VenueInfo with {
      briefly "Venue"
      described by "Venue information."
    }
    space is SpaceInfo with {
      briefly "Space"
      described by "Space information."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    period is BookingPeriod with {
      briefly "Period"
      described by "Booking period."
    }
    eventDetails is EventDetails with {
      briefly "Event"
      described by "Event details."
    }
  } with {
    briefly "Create booking"
    described by "Creates a new venue booking."
  }

  command AddResource is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    resource is ResourceItem with {
      briefly "Resource"
      described by "Resource to add."
    }
  } with {
    briefly "Add resource"
    described by "Adds resource to booking."
  }

  command RemoveResource is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    resourceId is ResourceId with {
      briefly "Resource"
      described by "Resource to remove."
    }
  } with {
    briefly "Remove resource"
    described by "Removes resource from booking."
  }

  command SetCatering is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    catering is CateringSelection with {
      briefly "Catering"
      described by "Catering selection."
    }
  } with {
    briefly "Set catering"
    described by "Sets catering for booking."
  }

  command UpdateEventDetails is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    eventDetails is EventDetails with {
      briefly "Event"
      described by "Updated event details."
    }
  } with {
    briefly "Update event"
    described by "Updates event details."
  }

  command ChangeBookingPeriod is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    newPeriod is BookingPeriod with {
      briefly "Period"
      described by "New booking period."
    }
  } with {
    briefly "Change period"
    described by "Changes booking time period."
  }

  command ConfirmBooking is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    confirmedBy is String(1, 200) with {
      briefly "Confirmed by"
      described by "Person confirming."
    }
  } with {
    briefly "Confirm booking"
    described by "Confirms the booking."
  }

  command RecordDeposit is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Deposit amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    transactionId is String(1, 100) with {
      briefly "Transaction"
      described by "Transaction ID."
    }
  } with {
    briefly "Record deposit"
    described by "Records deposit payment."
  }

  command ProcessFinalPayment is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    amount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Payment amount."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    transactionId is String(1, 100) with {
      briefly "Transaction"
      described by "Transaction ID."
    }
  } with {
    briefly "Process final payment"
    described by "Processes final payment."
  }

  command StartEvent is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started"
      described by "Event start time."
    }
  } with {
    briefly "Start event"
    described by "Marks event as started."
  }

  command CompleteEvent is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
    notes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Completion notes."
    }
  } with {
    briefly "Complete event"
    described by "Marks event as completed."
  }

  command CancelBooking is {
    bookingId is BookingId with {
      briefly "Booking ID"
      described by "Booking identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 200) with {
      briefly "Cancelled by"
      described by "Person cancelling."
    }
  } with {
    briefly "Cancel booking"
    described by "Cancels the booking."
  }

  // Events
  event BookingCreated is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    venue is VenueInfo with { briefly "Venue" described by "Venue info." }
    space is SpaceInfo with { briefly "Space" described by "Space info." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    period is BookingPeriod with { briefly "Period" described by "Booking period." }
    eventDetails is EventDetails with { briefly "Event" described by "Event details." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Booking created"
    described by "Emitted when booking is created."
  }

  event ResourceAdded is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    resource is ResourceItem with { briefly "Resource" described by "Added resource." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Resource added"
    described by "Emitted when resource is added."
  }

  event ResourceRemoved is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    resourceId is ResourceId with { briefly "Resource" described by "Removed resource." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Resource removed"
    described by "Emitted when resource is removed."
  }

  event CateringSet is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    catering is CateringSelection with { briefly "Catering" described by "Catering selection." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Catering set"
    described by "Emitted when catering is set."
  }

  event EventDetailsUpdated is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    eventDetails is EventDetails with { briefly "Event" described by "Updated details." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Event details updated"
    described by "Emitted when event details change."
  }

  event BookingPeriodChanged is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    previousPeriod is BookingPeriod with { briefly "Previous" described by "Previous period." }
    newPeriod is BookingPeriod with { briefly "New" described by "New period." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Booking period changed"
    described by "Emitted when period changes."
  }

  event BookingConfirmed is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    confirmedBy is String(1, 200) with { briefly "Confirmed by" described by "Confirmer." }
    pricing is BookingPricing with { briefly "Pricing" described by "Pricing details." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Booking confirmed"
    described by "Emitted when booking is confirmed."
  }

  event DepositRecorded is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Deposit amount." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Deposit recorded"
    described by "Emitted when deposit is recorded."
  }

  event FinalPaymentProcessed is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Final payment processed"
    described by "Emitted when final payment is processed."
  }

  event EventStarted is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Event started"
    described by "Emitted when event starts."
  }

  event EventCompleted is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
    notes is optional String(1, 1000) with { briefly "Notes" described by "Completion notes." }
  } with {
    briefly "Event completed"
    described by "Emitted when event completes."
  }

  event BookingCancelled is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is String(1, 200) with { briefly "Cancelled by" described by "Canceller." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Booking cancelled"
    described by "Emitted when booking is cancelled."
  }

  // State Records
  record ActiveStateData is {
    bookingId is BookingId with { briefly "Booking" described by "Booking ID." }
    venue is VenueInfo with { briefly "Venue" described by "Venue info." }
    space is SpaceInfo with { briefly "Space" described by "Space info." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    period is BookingPeriod with { briefly "Period" described by "Booking period." }
    eventDetails is EventDetails with { briefly "Event" described by "Event details." }
    resources is many optional ResourceItem with { briefly "Resources" described by "Resources." }
    catering is optional CateringSelection with { briefly "Catering" described by "Catering." }
    status is BookingStatus with { briefly "Status" described by "Booking status." }
    pricing is optional BookingPricing with { briefly "Pricing" described by "Pricing info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active booking."
  }

  // States
  state ActiveState of Booking.ActiveStateData with {
    briefly "Booking active"
    described by "Booking is active."
  }

  // Handler
  handler BookingHandler is {
    on command CreateBooking {
      morph entity VenueContext.Booking to state VenueContext.Booking.ActiveState with command CreateBooking
      tell event BookingCreated to entity VenueContext.Booking
    }

    on command AddResource {
      tell event ResourceAdded to entity VenueContext.Booking
    }

    on command RemoveResource {
      tell event ResourceRemoved to entity VenueContext.Booking
    }

    on command SetCatering {
      tell event CateringSet to entity VenueContext.Booking
    }

    on command UpdateEventDetails {
      tell event EventDetailsUpdated to entity VenueContext.Booking
    }

    on command ChangeBookingPeriod {
      tell event BookingPeriodChanged to entity VenueContext.Booking
    }

    on command ConfirmBooking {
      tell event BookingConfirmed to entity VenueContext.Booking
    }

    on command RecordDeposit {
      tell event DepositRecorded to entity VenueContext.Booking
    }

    on command ProcessFinalPayment {
      tell event FinalPaymentProcessed to entity VenueContext.Booking
    }

    on command StartEvent {
      tell event EventStarted to entity VenueContext.Booking
    }

    on command CompleteEvent {
      tell event EventCompleted to entity VenueContext.Booking
    }

    on command CancelBooking {
      tell event BookingCancelled to entity VenueContext.Booking
    }
  } with {
    briefly "Processes booking commands"
    described by {
      | Handles venue booking lifecycle from creation
      | through event completion.
    }
  }

} with {
  briefly "Booking aggregate"
  described by {
    | The Booking entity manages venue bookings
    | and their lifecycle through event completion.
  }
}
