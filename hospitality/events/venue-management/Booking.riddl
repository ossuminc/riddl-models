// Venue Management - Booking Entity
entity Booking is {
  // Commands
  command CreateBooking is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |New booking identifier.
      }
    }
    venue: VenueInfo with {
      briefly "Venue"
      described as {
        |Venue information.
      }
    }
    space: SpaceInfo with {
      briefly "Space"
      described as {
        |Space information.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer information.
      }
    }
    period: BookingPeriod with {
      briefly "Period"
      described as {
        |Booking period.
      }
    }
    eventDetails: EventDetails with {
      briefly "Event"
      described as {
        |Event details.
      }
    }
  } with {
    briefly "Create booking"
    described as {
      |Creates a new venue booking.
    }
  }
  command AddResource is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    resource: ResourceItem with {
      briefly "Resource"
      described as {
        |Resource to add.
      }
    }
  } with {
    briefly "Add resource"
    described as {
      |Adds resource to booking.
    }
  }
  command RemoveResource is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    resourceId: ResourceId with {
      briefly "Resource"
      described as {
        |Resource to remove.
      }
    }
  } with {
    briefly "Remove resource"
    described as {
      |Removes resource from booking.
    }
  }
  command SetCatering is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    catering: CateringSelection with {
      briefly "Catering"
      described as {
        |Catering selection.
      }
    }
  } with {
    briefly "Set catering"
    described as {
      |Sets catering for booking.
    }
  }
  command UpdateEventDetails is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    eventDetails: EventDetails with {
      briefly "Event"
      described as {
        |Updated event details.
      }
    }
  } with {
    briefly "Update event"
    described as {
      |Updates event details.
    }
  }
  command ChangeBookingPeriod is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    newPeriod: BookingPeriod with {
      briefly "Period"
      described as {
        |New booking period.
      }
    }
  } with {
    briefly "Change period"
    described as {
      |Changes booking time period.
    }
  }
  command ConfirmBooking is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    confirmedBy: String(1,200) with {
      briefly "Confirmed by"
      described as {
        |Person confirming.
      }
    }
  } with {
    briefly "Confirm booking"
    described as {
      |Confirms the booking.
    }
  }
  command RecordDeposit is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Deposit amount.
      }
    }
    paymentMethod: String(1,50) with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
  } with {
    briefly "Record deposit"
    described as {
      |Records deposit payment.
    }
  }
  command ProcessFinalPayment is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    paymentMethod: String(1,50) with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
  } with {
    briefly "Process final payment"
    described as {
      |Processes final payment.
    }
  }
  command StartEvent is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Event start time.
      }
    }
  } with {
    briefly "Start event"
    described as {
      |Marks event as started.
    }
  }
  command CompleteEvent is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
  } with {
    briefly "Complete event"
    described as {
      |Marks event as completed.
    }
  }
  command CancelBooking is  {
    bookingId: BookingId with {
      briefly "Booking ID"
      described as {
        |Booking identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,200) with {
      briefly "Cancelled by"
      described as {
        |Person cancelling.
      }
    }
  } with {
    briefly "Cancel booking"
    described as {
      |Cancels the booking.
    }
  }
  // Events
  event BookingCreated is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    venue: VenueInfo with {
      briefly "Venue"
      described as {
        |Venue info.
      }
    }
    space: SpaceInfo with {
      briefly "Space"
      described as {
        |Space info.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    period: BookingPeriod with {
      briefly "Period"
      described as {
        |Booking period.
      }
    }
    eventDetails: EventDetails with {
      briefly "Event"
      described as {
        |Event details.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Booking created"
    described as {
      |Emitted when booking is created.
    }
  }
  event ResourceAdded is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    resource: ResourceItem with {
      briefly "Resource"
      described as {
        |Added resource.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Resource added"
    described as {
      |Emitted when resource is added.
    }
  }
  event ResourceRemoved is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    resourceId: ResourceId with {
      briefly "Resource"
      described as {
        |Removed resource.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Resource removed"
    described as {
      |Emitted when resource is removed.
    }
  }
  event CateringSet is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    catering: CateringSelection with {
      briefly "Catering"
      described as {
        |Catering selection.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Catering set"
    described as {
      |Emitted when catering is set.
    }
  }
  event EventDetailsUpdated is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    eventDetails: EventDetails with {
      briefly "Event"
      described as {
        |Updated details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Event details updated"
    described as {
      |Emitted when event details change.
    }
  }
  event BookingPeriodChanged is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    previousPeriod: BookingPeriod with {
      briefly "Previous"
      described as {
        |Previous period.
      }
    }
    newPeriod: BookingPeriod with {
      briefly "New"
      described as {
        |New period.
      }
    }
    changedAt: TimeStamp with {
      briefly "Changed"
      described as {
        |Change time.
      }
    }
  } with {
    briefly "Booking period changed"
    described as {
      |Emitted when period changes.
    }
  }
  event BookingConfirmed is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    confirmedBy: String(1,200) with {
      briefly "Confirmed by"
      described as {
        |Confirmer.
      }
    }
    pricing: BookingPricing with {
      briefly "Pricing"
      described as {
        |Pricing details.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Booking confirmed"
    described as {
      |Emitted when booking is confirmed.
    }
  }
  event DepositRecorded is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Deposit amount.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Deposit recorded"
    described as {
      |Emitted when deposit is recorded.
    }
  }
  event FinalPaymentProcessed is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Final payment processed"
    described as {
      |Emitted when final payment is processed.
    }
  }
  event EventStarted is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Event started"
    described as {
      |Emitted when event starts.
    }
  }
  event EventCompleted is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
  } with {
    briefly "Event completed"
    described as {
      |Emitted when event completes.
    }
  }
  event BookingCancelled is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,200) with {
      briefly "Cancelled by"
      described as {
        |Canceller.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Booking cancelled"
    described as {
      |Emitted when booking is cancelled.
    }
  }
  // State Records
  record ActiveStateData is  {
    bookingId: BookingId with {
      briefly "Booking"
      described as {
        |Booking ID.
      }
    }
    venue: VenueInfo with {
      briefly "Venue"
      described as {
        |Venue info.
      }
    }
    space: SpaceInfo with {
      briefly "Space"
      described as {
        |Space info.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    period: BookingPeriod with {
      briefly "Period"
      described as {
        |Booking period.
      }
    }
    eventDetails: EventDetails with {
      briefly "Event"
      described as {
        |Event details.
      }
    }
    bookedResources: ResourceItem* with {
      briefly "Resources"
      described as {
        |Resources.
      }
    }
    selectedCatering: CateringSelection? with {
      briefly "Catering"
      described as {
        |Catering.
      }
    }
    status: BookingStatus with {
      briefly "Status"
      described as {
        |Booking status.
      }
    }
    calculatedPricing: BookingPricing? with {
      briefly "Pricing"
      described as {
        |Pricing info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active booking.
    }
  }
  // States
  state ActiveState of type Booking.ActiveStateData
  // Handler
  handler BookingHandler is {
    on command CreateBooking is {
      morph entity VenueContext.Booking to state VenueContext.Booking.ActiveState with command CreateBooking
      tell event BookingCreated to entity VenueContext.Booking
    }
    on command AddResource is {
      tell event ResourceAdded to entity VenueContext.Booking
    }
    on command RemoveResource is {
      tell event ResourceRemoved to entity VenueContext.Booking
    }
    on command SetCatering is {
      tell event CateringSet to entity VenueContext.Booking
    }
    on command UpdateEventDetails is {
      tell event EventDetailsUpdated to entity VenueContext.Booking
    }
    on command ChangeBookingPeriod is {
      tell event BookingPeriodChanged to entity VenueContext.Booking
    }
    on command ConfirmBooking is {
      tell event BookingConfirmed to entity VenueContext.Booking
    }
    on command RecordDeposit is {
      tell event DepositRecorded to entity VenueContext.Booking
    }
    on command ProcessFinalPayment is {
      tell event FinalPaymentProcessed to entity VenueContext.Booking
    }
    on command StartEvent is {
      tell event EventStarted to entity VenueContext.Booking
    }
    on command CompleteEvent is {
      tell event EventCompleted to entity VenueContext.Booking
    }
    on command CancelBooking is {
      tell event BookingCancelled to entity VenueContext.Booking
    }
  } with {
    briefly "Processes booking commands"
    described as {
      | Handles venue booking lifecycle from creation
      | through event completion.
    }
  }
} with {
  briefly "Booking aggregate"
  described as {
    | The Booking entity manages venue bookings
    | and their lifecycle through event completion.
  }
}
