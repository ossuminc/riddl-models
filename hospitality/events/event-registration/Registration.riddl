// Event Registration - Registration Entity

entity Registration is {

  // Commands
  command CreateRegistration is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "New registration identifier."
    }
    attendee is AttendeeInfo with {
      briefly "Attendee"
      described by "Attendee information."
    }
    event is EventInfo with {
      briefly "Event"
      described by "Event information."
    }
    ticket is TicketInfo with {
      briefly "Ticket"
      described by "Ticket information."
    }
  } with {
    briefly "Create registration"
    described by "Creates a new event registration."
  }

  command ApplyDiscountCode is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    discountCode is String(1, 50) with {
      briefly "Code"
      described by "Discount code."
    }
  } with {
    briefly "Apply discount"
    described by "Applies discount code to registration."
  }

  command ProcessPayment is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    paymentMethod is String(1, 50) with {
      briefly "Method"
      described by "Payment method."
    }
    paymentToken is String(1, 200) with {
      briefly "Token"
      described by "Payment token."
    }
  } with {
    briefly "Process payment"
    described by "Processes registration payment."
  }

  command ConfirmRegistration is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    confirmationNumber is String(1, 50) with {
      briefly "Confirmation"
      described by "Confirmation number."
    }
  } with {
    briefly "Confirm registration"
    described by "Confirms the registration."
  }

  command AddToWaitlist is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    position is Natural with {
      briefly "Position"
      described by "Waitlist position."
    }
  } with {
    briefly "Add to waitlist"
    described by "Adds to event waitlist."
  }

  command RegisterForSession is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    sessionId is SessionId with {
      briefly "Session"
      described by "Session to register for."
    }
  } with {
    briefly "Register for session"
    described by "Registers for a session."
  }

  command UnregisterFromSession is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    sessionId is SessionId with {
      briefly "Session"
      described by "Session to unregister from."
    }
  } with {
    briefly "Unregister from session"
    described by "Removes session registration."
  }

  command CheckIn is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    method is CheckInMethod with {
      briefly "Method"
      described by "Check-in method."
    }
    checkedInBy is optional String(1, 200) with {
      briefly "Checked in by"
      described by "Staff member."
    }
  } with {
    briefly "Check in"
    described by "Checks attendee in."
  }

  command AssignBadge is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    badgeNumber is String(1, 50) with {
      briefly "Badge"
      described by "Badge number."
    }
  } with {
    briefly "Assign badge"
    described by "Assigns badge to attendee."
  }

  command RecordSessionAttendance is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    sessionId is SessionId with {
      briefly "Session"
      described by "Session attended."
    }
  } with {
    briefly "Record attendance"
    described by "Records session attendance."
  }

  command UpdateAttendeeInfo is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    attendee is AttendeeInfo with {
      briefly "Attendee"
      described by "Updated attendee info."
    }
  } with {
    briefly "Update attendee"
    described by "Updates attendee information."
  }

  command TransferRegistration is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    newAttendee is AttendeeInfo with {
      briefly "New attendee"
      described by "New attendee information."
    }
  } with {
    briefly "Transfer registration"
    described by "Transfers to new attendee."
  }

  command CancelRegistration is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    requestRefund is Boolean with {
      briefly "Refund"
      described by "Whether to request refund."
    }
  } with {
    briefly "Cancel registration"
    described by "Cancels the registration."
  }

  command ProcessRefund is {
    registrationId is RegistrationId with {
      briefly "Registration ID"
      described by "Registration identifier."
    }
    refundAmount is Decimal(10, 2) with {
      briefly "Amount"
      described by "Refund amount."
    }
  } with {
    briefly "Process refund"
    described by "Processes refund."
  }

  // Events
  event RegistrationCreated is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    attendee is AttendeeInfo with { briefly "Attendee" described by "Attendee info." }
    event is EventInfo with { briefly "Event" described by "Event info." }
    ticket is TicketInfo with { briefly "Ticket" described by "Ticket info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Registration created"
    described by "Emitted when registration is created."
  }

  event DiscountApplied is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    discountCode is String(1, 50) with { briefly "Code" described by "Discount code." }
    discountAmount is Decimal(10, 2) with { briefly "Amount" described by "Discount amount." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Apply time." }
  } with {
    briefly "Discount applied"
    described by "Emitted when discount is applied."
  }

  event PaymentProcessed is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event RegistrationConfirmed is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    confirmationNumber is String(1, 50) with { briefly "Confirmation" described by "Confirmation number." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Registration confirmed"
    described by "Emitted when registration is confirmed."
  }

  event AddedToWaitlist is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    position is Natural with { briefly "Position" described by "Waitlist position." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Added to waitlist"
    described by "Emitted when added to waitlist."
  }

  event SessionRegistered is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    sessionId is SessionId with { briefly "Session" described by "Session ID." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Session registered"
    described by "Emitted when registered for session."
  }

  event SessionUnregistered is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    sessionId is SessionId with { briefly "Session" described by "Session ID." }
    unregisteredAt is TimeStamp with { briefly "Unregistered" described by "Unregistration time." }
  } with {
    briefly "Session unregistered"
    described by "Emitted when unregistered from session."
  }

  event AttendeeCheckedIn is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    checkIn is CheckInRecord with { briefly "Check-in" described by "Check-in record." }
  } with {
    briefly "Attendee checked in"
    described by "Emitted when attendee checks in."
  }

  event BadgeAssigned is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    badgeNumber is String(1, 50) with { briefly "Badge" described by "Badge number." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Badge assigned"
    described by "Emitted when badge is assigned."
  }

  event SessionAttendanceRecorded is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    sessionId is SessionId with { briefly "Session" described by "Session ID." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Session attendance recorded"
    described by "Emitted when attendance is recorded."
  }

  event AttendeeInfoUpdated is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    attendee is AttendeeInfo with { briefly "Attendee" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Attendee info updated"
    described by "Emitted when info is updated."
  }

  event RegistrationTransferred is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    previousAttendee is AttendeeInfo with { briefly "Previous" described by "Previous attendee." }
    newAttendee is AttendeeInfo with { briefly "New" described by "New attendee." }
    transferredAt is TimeStamp with { briefly "Transferred" described by "Transfer time." }
  } with {
    briefly "Registration transferred"
    described by "Emitted when registration is transferred."
  }

  event RegistrationCancelled is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Registration cancelled"
    described by "Emitted when registration is cancelled."
  }

  event RefundProcessed is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    refundAmount is Decimal(10, 2) with { briefly "Amount" described by "Refund amount." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Refund processed"
    described by "Emitted when refund is processed."
  }

  // State Records
  record ActiveStateData is {
    registrationId is RegistrationId with { briefly "Registration" described by "Registration ID." }
    attendee is AttendeeInfo with { briefly "Attendee" described by "Attendee info." }
    event is EventInfo with { briefly "Event" described by "Event info." }
    ticket is TicketInfo with { briefly "Ticket" described by "Ticket info." }
    status is RegistrationStatus with { briefly "Status" described by "Registration status." }
    payment is RegistrationPayment with { briefly "Payment" described by "Payment info." }
    confirmationNumber is optional String(1, 50) with { briefly "Confirmation" described by "Confirmation number." }
    checkIn is optional CheckInRecord with { briefly "Check-in" described by "Check-in record." }
    sessionRegistrations is many optional SessionRegistration with { briefly "Sessions" described by "Session registrations." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active registration."
  }

  // States
  state ActiveState of Registration.ActiveStateData with {
    briefly "Registration active"
    described by "Registration is active."
  }

  // Handler
  handler RegistrationHandler is {
    on command CreateRegistration {
      morph entity RegistrationContext.Registration to state RegistrationContext.Registration.ActiveState with command CreateRegistration
      tell event RegistrationCreated to entity RegistrationContext.Registration
    }

    on command ApplyDiscountCode {
      tell event DiscountApplied to entity RegistrationContext.Registration
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity RegistrationContext.Registration
    }

    on command ConfirmRegistration {
      tell event RegistrationConfirmed to entity RegistrationContext.Registration
    }

    on command AddToWaitlist {
      tell event AddedToWaitlist to entity RegistrationContext.Registration
    }

    on command RegisterForSession {
      tell event SessionRegistered to entity RegistrationContext.Registration
    }

    on command UnregisterFromSession {
      tell event SessionUnregistered to entity RegistrationContext.Registration
    }

    on command CheckIn {
      tell event AttendeeCheckedIn to entity RegistrationContext.Registration
    }

    on command AssignBadge {
      tell event BadgeAssigned to entity RegistrationContext.Registration
    }

    on command RecordSessionAttendance {
      tell event SessionAttendanceRecorded to entity RegistrationContext.Registration
    }

    on command UpdateAttendeeInfo {
      tell event AttendeeInfoUpdated to entity RegistrationContext.Registration
    }

    on command TransferRegistration {
      tell event RegistrationTransferred to entity RegistrationContext.Registration
    }

    on command CancelRegistration {
      tell event RegistrationCancelled to entity RegistrationContext.Registration
    }

    on command ProcessRefund {
      tell event RefundProcessed to entity RegistrationContext.Registration
    }
  } with {
    briefly "Processes registration commands"
    described by {
      | Handles registration lifecycle from creation
      | through check-in and completion.
    }
  }

} with {
  briefly "Registration aggregate"
  described by {
    | The Registration entity manages event registrations
    | and their lifecycle through attendance.
  }
}
