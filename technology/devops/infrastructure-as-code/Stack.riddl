// Infrastructure as Code - Stack Entity
entity Stack is {
  // Commands
  command CreateStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |New stack identifier.
      }
    }
    workspace: WorkspaceInfo with {
      briefly "Workspace"
      described as {
        |Workspace configuration.
      }
    }
    config: StackConfiguration with {
      briefly "Configuration"
      described as {
        |Stack configuration.
      }
    }
  } with {
    briefly "Create stack"
    described as {
      |Creates a new infrastructure stack.
    }
  }
  command PlanStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    runId: RunId with {
      briefly "Run ID"
      described as {
        |New run identifier.
      }
    }
  } with {
    briefly "Plan stack"
    described as {
      |Generates execution plan.
    }
  }
  command ApplyStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    runId: RunId with {
      briefly "Run ID"
      described as {
        |Run identifier.
      }
    }
    autoApprove: Boolean with {
      briefly "Auto approve"
      described as {
        |Skip manual approval.
      }
    }
  } with {
    briefly "Apply stack"
    described as {
      |Applies infrastructure changes.
    }
  }
  command DetectDrift is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
  } with {
    briefly "Detect drift"
    described as {
      |Checks for configuration drift.
    }
  }
  command ReconcileDrift is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    runId: RunId with {
      briefly "Run ID"
      described as {
        |New run identifier.
      }
    }
  } with {
    briefly "Reconcile drift"
    described as {
      |Applies changes to fix drift.
    }
  }
  command UpdateVariables is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    updatedVariables: String(1,1000)+ with {
      briefly "Variables"
      described as {
        |Updated variables.
      }
    }
  } with {
    briefly "Update variables"
    described as {
      |Updates stack variables.
    }
  }
  command DestroyStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    runId: RunId with {
      briefly "Run ID"
      described as {
        |Destruction run identifier.
      }
    }
    force: Boolean with {
      briefly "Force"
      described as {
        |Force destruction.
      }
    }
  } with {
    briefly "Destroy stack"
    described as {
      |Destroys all stack resources.
    }
  }
  command LockStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Lock reason.
      }
    }
    lockedBy: String(1,200) with {
      briefly "Locked by"
      described as {
        |Person locking.
      }
    }
  } with {
    briefly "Lock stack"
    described as {
      |Locks stack from changes.
    }
  }
  command UnlockStack is  {
    stackId: StackId with {
      briefly "Stack ID"
      described as {
        |Stack identifier.
      }
    }
    unlockedBy: String(1,200) with {
      briefly "Unlocked by"
      described as {
        |Person unlocking.
      }
    }
  } with {
    briefly "Unlock stack"
    described as {
      |Unlocks stack for changes.
    }
  }
  // Events
  event StackCreated is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    workspace: WorkspaceInfo with {
      briefly "Workspace"
      described as {
        |Workspace config.
      }
    }
    config: StackConfiguration with {
      briefly "Config"
      described as {
        |Stack configuration.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Stack created"
    described as {
      |Emitted when stack is created.
    }
  }
  event PlanGenerated is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    plan: ExecutionPlan with {
      briefly "Plan"
      described as {
        |Execution plan.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Plan generated"
    described as {
      |Emitted when plan is generated.
    }
  }
  event StackApplyStarted is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    runId: RunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Apply started"
    described as {
      |Emitted when apply begins.
    }
  }
  event StackApplyCompleted is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    result: ApplyResult with {
      briefly "Result"
      described as {
        |Apply result.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Apply completed"
    described as {
      |Emitted when apply finishes.
    }
  }
  event DriftDetected is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    report: DriftReport with {
      briefly "Report"
      described as {
        |Drift report.
      }
    }
    detectedAt: TimeStamp with {
      briefly "Detected"
      described as {
        |Detection time.
      }
    }
  } with {
    briefly "Drift detected"
    described as {
      |Emitted when drift is found.
    }
  }
  event DriftReconciled is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    reconciledResources: Natural with {
      briefly "Reconciled"
      described as {
        |Resources reconciled.
      }
    }
    reconciledAt: TimeStamp with {
      briefly "Reconciled"
      described as {
        |Reconciliation time.
      }
    }
  } with {
    briefly "Drift reconciled"
    described as {
      |Emitted when drift is fixed.
    }
  }
  event VariablesUpdated is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    variableCount: Natural with {
      briefly "Count"
      described as {
        |Variables updated.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Variables updated"
    described as {
      |Emitted when variables change.
    }
  }
  event StackDestroyed is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    resourcesDestroyed: Natural with {
      briefly "Destroyed"
      described as {
        |Resources destroyed.
      }
    }
    destroyedAt: TimeStamp with {
      briefly "Destroyed"
      described as {
        |Destruction time.
      }
    }
  } with {
    briefly "Stack destroyed"
    described as {
      |Emitted when stack is destroyed.
    }
  }
  event StackLocked is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Lock reason.
      }
    }
    lockedBy: String(1,200) with {
      briefly "Locked by"
      described as {
        |Locker.
      }
    }
    lockedAt: TimeStamp with {
      briefly "Locked"
      described as {
        |Lock time.
      }
    }
  } with {
    briefly "Stack locked"
    described as {
      |Emitted when stack is locked.
    }
  }
  event StackUnlocked is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    unlockedBy: String(1,200) with {
      briefly "Unlocked by"
      described as {
        |Unlocker.
      }
    }
    unlockedAt: TimeStamp with {
      briefly "Unlocked"
      described as {
        |Unlock time.
      }
    }
  } with {
    briefly "Stack unlocked"
    described as {
      |Emitted when stack is unlocked.
    }
  }
  // State Records
  record ActiveStateData is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    workspace: WorkspaceInfo with {
      briefly "Workspace"
      described as {
        |Workspace config.
      }
    }
    config: StackConfiguration with {
      briefly "Config"
      described as {
        |Stack configuration.
      }
    }
    resources: ResourceState* with {
      briefly "Resources"
      described as {
        |Current resources.
      }
    }
    status: StackStatus with {
      briefly "Status"
      described as {
        |Stack status.
      }
    }
    currentRunId: RunId? with {
      briefly "Current run"
      described as {
        |Current run ID.
      }
    }
    lastPlan: ExecutionPlan? with {
      briefly "Last plan"
      described as {
        |Last execution plan.
      }
    }
    isLocked: Boolean with {
      briefly "Locked"
      described as {
        |Whether stack is locked.
      }
    }
    updatedLockedBy: String(1,200)? with {
      briefly "Locked by"
      described as {
        |Locker identity.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active stack.
    }
  }
  record DestroyedStateData is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    workspace: WorkspaceInfo with {
      briefly "Workspace"
      described as {
        |Workspace config.
      }
    }
    destroyedAt: TimeStamp with {
      briefly "Destroyed"
      described as {
        |Destruction time.
      }
    }
  } with {
    briefly "Destroyed state"
    described as {
      |State for destroyed stack.
    }
  }
  // States
  state ActiveState of type Stack.ActiveStateData
  state DestroyedState of type Stack.DestroyedStateData
  // Handler
  handler StackHandler is {
    on command CreateStack is {
      morph entity StackContext.Stack to state StackContext.Stack.ActiveState with command CreateStack
      tell event StackCreated to entity StackContext.Stack
    }
    on command PlanStack is {
      tell event PlanGenerated to entity StackContext.Stack
    }
    on command ApplyStack is {
      tell event StackApplyStarted to entity StackContext.Stack
      tell event StackApplyCompleted to entity StackContext.Stack
    }
    on command DetectDrift is {
      tell event DriftDetected to entity StackContext.Stack
    }
    on command ReconcileDrift is {
      tell event DriftReconciled to entity StackContext.Stack
    }
    on command UpdateVariables is {
      tell event VariablesUpdated to entity StackContext.Stack
    }
    on command DestroyStack is {
      morph entity StackContext.Stack to state StackContext.Stack.DestroyedState with command DestroyStack
      tell event StackDestroyed to entity StackContext.Stack
    }
    on command LockStack is {
      tell event StackLocked to entity StackContext.Stack
    }
    on command UnlockStack is {
      tell event StackUnlocked to entity StackContext.Stack
    }
  } with {
    briefly "Processes stack commands"
    described as {
      | Handles stack lifecycle from creation
      | through provisioning, drift detection, and destruction.
    }
  }
} with {
  briefly "Stack aggregate"
  described as {
    | The Stack entity manages infrastructure as code
    | stacks, state, and provisioning lifecycle.
  }
}
