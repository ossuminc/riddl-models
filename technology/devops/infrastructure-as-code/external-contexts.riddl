// Infrastructure as Code - External Contexts
// Cloud Provider Service
context CloudProviderService is {
  command ProvisionResource is  {
    resourceType: String(1,100) with {
      briefly "Type"
      described as {
        |Resource type.
      }
    }
    properties: String(1,2000)+ with {
      briefly "Properties"
      described as {
        |Resource properties.
      }
    }
    region: String(1,50) with {
      briefly "Region"
      described as {
        |Cloud region.
      }
    }
  } with {
    briefly "Provision resource"
    described as {
      |Provisions a cloud resource.
    }
  }
  event ResourceProvisioned is  {
    resourceId: ResourceId with {
      briefly "Resource"
      described as {
        |Resource ID.
      }
    }
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    provisionedAt: TimeStamp with {
      briefly "Provisioned"
      described as {
        |Provisioning time.
      }
    }
  } with {
    briefly "Resource provisioned"
    described as {
      |Emitted when resource is provisioned.
    }
  }
  event ProvisioningFailed is  {
    resourceType: String(1,100) with {
      briefly "Type"
      described as {
        |Resource type.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error"
      described as {
        |Error code.
      }
    }
    provisioningError: String(1,1000) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
  } with {
    briefly "Provisioning failed"
    described as {
      |Emitted when provisioning fails.
    }
  }
  command UpdateResource is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    properties: String(1,2000)+ with {
      briefly "Properties"
      described as {
        |Updated properties.
      }
    }
  } with {
    briefly "Update resource"
    described as {
      |Updates cloud resource.
    }
  }
  event ResourceUpdated is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Resource updated"
    described as {
      |Emitted when resource is updated.
    }
  }
  command DestroyResource is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    force: Boolean with {
      briefly "Force"
      described as {
        |Force destruction.
      }
    }
  } with {
    briefly "Destroy resource"
    described as {
      |Destroys cloud resource.
    }
  }
  event ResourceDestroyed is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    destroyedAt: TimeStamp with {
      briefly "Destroyed"
      described as {
        |Destruction time.
      }
    }
  } with {
    briefly "Resource destroyed"
    described as {
      |Emitted when resource is destroyed.
    }
  }
  query GetResourceState is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
  } with {
    briefly "Get resource state"
    described as {
      |Retrieves current resource state.
    }
  }
  result ResourceCurrentState is  {
    cloudPhysicalId: String(1,500) with {
      briefly "Physical ID"
      described as {
        |Cloud resource ID.
      }
    }
    properties: String(1,2000)+ with {
      briefly "Properties"
      described as {
        |Current properties.
      }
    }
    cloudStatus: String(1,50) with {
      briefly "Status"
      described as {
        |Resource status.
      }
    }
    retrievedAt: TimeStamp with {
      briefly "Retrieved"
      described as {
        |Retrieval time.
      }
    }
  } with {
    briefly "Resource current state"
    described as {
      |Current cloud resource state.
    }
  }
} with {
  option external()
  briefly "External cloud provider"
  described as {
    |External cloud provider API (AWS, Azure, GCP).
  }
}
// State Backend Service
context StateBackendService is {
  command LockState is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    lockId: UUID with {
      briefly "Lock ID"
      described as {
        |Lock identifier.
      }
    }
    stateLockedBy: String(1,200) with {
      briefly "Locked by"
      described as {
        |Locker identity.
      }
    }
  } with {
    briefly "Lock state"
    described as {
      |Acquires state lock.
    }
  }
  event StateLocked is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    lockId: UUID with {
      briefly "Lock ID"
      described as {
        |Lock identifier.
      }
    }
    lockedAt: TimeStamp with {
      briefly "Locked"
      described as {
        |Lock time.
      }
    }
  } with {
    briefly "State locked"
    described as {
      |Emitted when state is locked.
    }
  }
  command UnlockState is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    lockId: UUID with {
      briefly "Lock ID"
      described as {
        |Lock identifier.
      }
    }
  } with {
    briefly "Unlock state"
    described as {
      |Releases state lock.
    }
  }
  event StateUnlocked is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    unlockedAt: TimeStamp with {
      briefly "Unlocked"
      described as {
        |Unlock time.
      }
    }
  } with {
    briefly "State unlocked"
    described as {
      |Emitted when state is unlocked.
    }
  }
  command SaveState is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    stateData: String(1,100000) with {
      briefly "State"
      described as {
        |State JSON.
      }
    }
    stateVersion: Natural with {
      briefly "Version"
      described as {
        |State version.
      }
    }
  } with {
    briefly "Save state"
    described as {
      |Persists state to backend.
    }
  }
  event StateSaved is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    stateVersion: Natural with {
      briefly "Version"
      described as {
        |State version.
      }
    }
    savedAt: TimeStamp with {
      briefly "Saved"
      described as {
        |Save time.
      }
    }
  } with {
    briefly "State saved"
    described as {
      |Emitted when state is saved.
    }
  }
  query LoadState is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
  } with {
    briefly "Load state"
    described as {
      |Loads state from backend.
    }
  }
  result StateData is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    stateData: String(1,100000) with {
      briefly "State"
      described as {
        |State JSON.
      }
    }
    stateVersion: Natural with {
      briefly "Version"
      described as {
        |State version.
      }
    }
    lastModified: TimeStamp with {
      briefly "Modified"
      described as {
        |Last modification.
      }
    }
  } with {
    briefly "State data"
    described as {
      |Retrieved state data.
    }
  }
} with {
  option external()
  briefly "External state backend"
  described as {
    |External state storage service (S3, GCS, Consul).
  }
}
// Secret Manager Service
context SecretManagerService is {
  query GetSecret is  {
    secretPath: String(1,500) with {
      briefly "Path"
      described as {
        |Secret path.
      }
    }
    secretVersion: String(1,50)? with {
      briefly "Version"
      described as {
        |Secret version.
      }
    }
  } with {
    briefly "Get secret"
    described as {
      |Retrieves secret value.
    }
  }
  result SecretValue is  {
    secretPath: String(1,500) with {
      briefly "Path"
      described as {
        |Secret path.
      }
    }
    value: String(1,10000) with {
      briefly "Value"
      described as {
        |Secret value.
      }
    }
    version: String(1,50) with {
      briefly "Version"
      described as {
        |Secret version.
      }
    }
  } with {
    briefly "Secret value"
    described as {
      |Retrieved secret value.
    }
  }
  command RotateSecret is  {
    secretPath: String(1,500) with {
      briefly "Path"
      described as {
        |Secret path.
      }
    }
  } with {
    briefly "Rotate secret"
    described as {
      |Rotates secret value.
    }
  }
  event SecretRotated is  {
    secretPath: String(1,500) with {
      briefly "Path"
      described as {
        |Secret path.
      }
    }
    newVersion: String(1,50) with {
      briefly "Version"
      described as {
        |New secret version.
      }
    }
    rotatedAt: TimeStamp with {
      briefly "Rotated"
      described as {
        |Rotation time.
      }
    }
  } with {
    briefly "Secret rotated"
    described as {
      |Emitted when secret is rotated.
    }
  }
} with {
  option external()
  briefly "External secret manager"
  described as {
    |External secret management service (Vault, AWS Secrets Manager).
  }
}
// Module Registry Service
context ModuleRegistryService is {
  query GetModule is  {
    moduleSource: String(1,500) with {
      briefly "Source"
      described as {
        |Module source.
      }
    }
    version: String(1,50) with {
      briefly "Version"
      described as {
        |Module version.
      }
    }
  } with {
    briefly "Get module"
    described as {
      |Downloads IaC module.
    }
  }
  result ModuleBundle is  {
    moduleId: ModuleId with {
      briefly "Module"
      described as {
        |Module ID.
      }
    }
    source: String(1,500) with {
      briefly "Source"
      described as {
        |Module source.
      }
    }
    version: String(1,50) with {
      briefly "Version"
      described as {
        |Module version.
      }
    }
    checksum: String(64,64) with {
      briefly "Checksum"
      described as {
        |Module checksum.
      }
    }
    downloadUrl: URL with {
      briefly "URL"
      described as {
        |Download URL.
      }
    }
  } with {
    briefly "Module bundle"
    described as {
      |Downloaded module information.
    }
  }
  query ListModuleVersions is  {
    moduleSource: String(1,500) with {
      briefly "Source"
      described as {
        |Module source.
      }
    }
  } with {
    briefly "List versions"
    described as {
      |Lists available module versions.
    }
  }
  result ModuleVersionList is  {
    moduleSource: String(1,500) with {
      briefly "Source"
      described as {
        |Module source.
      }
    }
    versions: String(1,50)+ with {
      briefly "Versions"
      described as {
        |Available versions.
      }
    }
    latestVersion: String(1,50) with {
      briefly "Latest"
      described as {
        |Latest version.
      }
    }
  } with {
    briefly "Module version list"
    described as {
      |Available module versions.
    }
  }
} with {
  option external()
  briefly "External module registry"
  described as {
    |External IaC module registry (Terraform Registry).
  }
}
// Policy Engine Service
context PolicyEngineService is {
  command EvaluatePolicy is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    planJson: String(1,100000) with {
      briefly "Plan"
      described as {
        |Execution plan JSON.
      }
    }
    policySet: String(1,200) with {
      briefly "Policy set"
      described as {
        |Policy set to evaluate.
      }
    }
  } with {
    briefly "Evaluate policy"
    described as {
      |Evaluates plan against policies.
    }
  }
  event PolicyEvaluated is  {
    stackId: StackId with {
      briefly "Stack"
      described as {
        |Stack ID.
      }
    }
    passed: Boolean with {
      briefly "Passed"
      described as {
        |Whether evaluation passed.
      }
    }
    violations: String(1,500)* with {
      briefly "Violations"
      described as {
        |Policy violations.
      }
    }
    evaluatedAt: TimeStamp with {
      briefly "Evaluated"
      described as {
        |Evaluation time.
      }
    }
  } with {
    briefly "Policy evaluated"
    described as {
      |Emitted when policy evaluation completes.
    }
  }
} with {
  option external()
  briefly "External policy engine"
  described as {
    |External policy evaluation service (Sentinel, OPA).
  }
}
