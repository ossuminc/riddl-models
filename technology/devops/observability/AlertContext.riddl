// Observability - Alert Context

context AlertContext is {

  include "types.riddl"
  include "Alert.riddl"

  // Repository for alert persistence
  repository AlertRepository is {
    schema AlertData is relational
      of alerts as Alert
      index on field Alert.alertId
      index on field Alert.rule.severity

    handler AlertPersistence is {
      on event Alert.AlertCreated {
        prompt "Store new alert"
      }
      on event Alert.AlertAcknowledged {
        prompt "Update acknowledgment status"
      }
      on event Alert.AlertResolved {
        prompt "Update to resolved"
      }
      on event Alert.AlertSilenced {
        prompt "Update silence status"
      }
      on event Alert.AlertEscalated {
        prompt "Update escalation level"
      }
      on event Alert.CommentAdded {
        prompt "Store alert comment"
      }
      on event Alert.AlertExpired {
        prompt "Update to expired"
      }
    } with {
      briefly "Persists alert events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Alert data persistence"
    described by {
      | The AlertRepository provides persistent storage for
      | alerts, comments, and resolution history.
    }
  }

  // Projector for observability analytics
  projector ObservabilityAnalytics is {
    updates repository AlertRepository

    record ObservabilityStats is {
      activeAlerts is Natural with { briefly "Active" described by "Active alerts." }
      criticalAlerts is Natural with { briefly "Critical" described by "Critical alerts." }
      alertsToday is Natural with { briefly "Today" described by "Alerts fired today." }
      mttr is Natural with { briefly "MTTR" described by "Mean time to resolve (minutes)." }
      acknowledgeRate is Decimal(5, 4) with { briefly "Ack rate" described by "Acknowledgment rate." }
    } with {
      briefly "Observability statistics"
      described by "Alert and incident metrics."
    }

    handler AnalyticsHandler is {
      on event Alert.AlertCreated {
        prompt "Update alert counts"
      }
      on event Alert.AlertAcknowledged {
        prompt "Update ack metrics"
      }
      on event Alert.AlertResolved {
        prompt "Update resolution metrics"
      }
    } with {
      briefly "Maintains observability analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Observability analytics projections"
    described by "Maintains alert and incident analytics data."
  }

} with {
  briefly "Bounded context for alerting"
  described by {
    | The AlertContext is the bounded context for
    | alert management and incident tracking.
  }
}
