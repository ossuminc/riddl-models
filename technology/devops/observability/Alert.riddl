// Observability - Alert Entity
entity Alert is {
  // Commands
  command CreateAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |New alert identifier.
      }
    }
    rule: AlertRule with {
      briefly "Rule"
      described as {
        |Triggering alert rule.
      }
    }
    value: Decimal(20,6) with {
      briefly "Value"
      described as {
        |Triggering metric value.
      }
    }
  } with {
    briefly "Create alert"
    described as {
      |Creates a new alert instance.
    }
  }
  command AcknowledgeAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
    acknowledgedBy: String(1,200) with {
      briefly "Acknowledged by"
      described as {
        |Person acknowledging.
      }
    }
    updatedComment: String(1,500)? with {
      briefly "Comment"
      described as {
        |Acknowledgment comment.
      }
    }
  } with {
    briefly "Acknowledge alert"
    described as {
      |Acknowledges an alert.
    }
  }
  command ResolveAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
    resolvedBy: String(1,200) with {
      briefly "Resolved by"
      described as {
        |Person resolving.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |Resolution description.
      }
    }
  } with {
    briefly "Resolve alert"
    described as {
      |Resolves an alert.
    }
  }
  command SilenceAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
    silence: SilenceRule with {
      briefly "Silence"
      described as {
        |Silence configuration.
      }
    }
  } with {
    briefly "Silence alert"
    described as {
      |Silences an alert.
    }
  }
  command EscalateAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
    escalationLevel: Natural with {
      briefly "Level"
      described as {
        |Escalation level.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Escalation reason.
      }
    }
  } with {
    briefly "Escalate alert"
    described as {
      |Escalates alert severity.
    }
  }
  command AddComment is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
    author: String(1,200) with {
      briefly "Author"
      described as {
        |Comment author.
      }
    }
    comment: String(1,2000) with {
      briefly "Comment"
      described as {
        |Comment text.
      }
    }
  } with {
    briefly "Add comment"
    described as {
      |Adds a comment to alert.
    }
  }
  command ExpireAlert is  {
    alertId: AlertId with {
      briefly "Alert ID"
      described as {
        |Alert identifier.
      }
    }
  } with {
    briefly "Expire alert"
    described as {
      |Expires an alert automatically.
    }
  }
  // Events
  event AlertCreated is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    rule: AlertRule with {
      briefly "Rule"
      described as {
        |Alert rule.
      }
    }
    value: Decimal(20,6) with {
      briefly "Value"
      described as {
        |Triggering value.
      }
    }
    firedAt: TimeStamp with {
      briefly "Fired"
      described as {
        |Fire time.
      }
    }
  } with {
    briefly "Alert created"
    described as {
      |Emitted when alert fires.
    }
  }
  event AlertAcknowledged is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    acknowledgedBy: String(1,200) with {
      briefly "Acknowledged by"
      described as {
        |Acknowledger.
      }
    }
    updatedComment: String(1,500)? with {
      briefly "Comment"
      described as {
        |Ack comment.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |Ack time.
      }
    }
  } with {
    briefly "Alert acknowledged"
    described as {
      |Emitted when alert is acknowledged.
    }
  }
  event AlertResolved is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    resolvedBy: String(1,200) with {
      briefly "Resolved by"
      described as {
        |Resolver.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |Resolution notes.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Alert resolved"
    described as {
      |Emitted when alert is resolved.
    }
  }
  event AlertSilenced is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    silence: SilenceRule with {
      briefly "Silence"
      described as {
        |Silence rule.
      }
    }
    silencedAt: TimeStamp with {
      briefly "Silenced"
      described as {
        |Silence time.
      }
    }
  } with {
    briefly "Alert silenced"
    described as {
      |Emitted when alert is silenced.
    }
  }
  event AlertEscalated is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    previousLevel: Natural with {
      briefly "Previous"
      described as {
        |Previous level.
      }
    }
    newLevel: Natural with {
      briefly "New"
      described as {
        |New level.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Escalation reason.
      }
    }
    escalatedAt: TimeStamp with {
      briefly "Escalated"
      described as {
        |Escalation time.
      }
    }
  } with {
    briefly "Alert escalated"
    described as {
      |Emitted when alert is escalated.
    }
  }
  event CommentAdded is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    author: String(1,200) with {
      briefly "Author"
      described as {
        |Comment author.
      }
    }
    comment: String(1,2000) with {
      briefly "Comment"
      described as {
        |Comment text.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Comment time.
      }
    }
  } with {
    briefly "Comment added"
    described as {
      |Emitted when comment is added.
    }
  }
  event AlertExpired is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    expiredAt: TimeStamp with {
      briefly "Expired"
      described as {
        |Expiration time.
      }
    }
  } with {
    briefly "Alert expired"
    described as {
      |Emitted when alert expires.
    }
  }
  // State Records
  record FiringStateData is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    rule: AlertRule with {
      briefly "Rule"
      described as {
        |Alert rule.
      }
    }
    value: Decimal(20,6) with {
      briefly "Value"
      described as {
        |Triggering value.
      }
    }
    status: AlertStatus with {
      briefly "Status"
      described as {
        |Alert status.
      }
    }
    escalationLevel: Natural with {
      briefly "Escalation"
      described as {
        |Current escalation level.
      }
    }
    updatedAcknowledgedBy: String(1,200)? with {
      briefly "Ack by"
      described as {
        |Acknowledger.
      }
    }
    comments: String(1,2000)* with {
      briefly "Comments"
      described as {
        |Alert comments.
      }
    }
    firedAt: TimeStamp with {
      briefly "Fired"
      described as {
        |Fire time.
      }
    }
  } with {
    briefly "Firing state"
    described as {
      |State for firing alert.
    }
  }
  record ResolvedStateData is  {
    alertId: AlertId with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    rule: AlertRule with {
      briefly "Rule"
      described as {
        |Alert rule.
      }
    }
    resolvedBy: String(1,200) with {
      briefly "Resolved by"
      described as {
        |Resolver.
      }
    }
    resolution: String(1,1000) with {
      briefly "Resolution"
      described as {
        |Resolution notes.
      }
    }
    firedAt: TimeStamp with {
      briefly "Fired"
      described as {
        |Fire time.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Resolved state"
    described as {
      |State for resolved alert.
    }
  }
  // States
  state FiringState of type Alert.FiringStateData
  state ResolvedState of type Alert.ResolvedStateData
  // Handler
  handler AlertHandler is {
    on command CreateAlert is {
      morph entity AlertContext.Alert to state AlertContext.Alert.FiringState with command CreateAlert
      tell event AlertCreated to entity AlertContext.Alert
    }
    on command AcknowledgeAlert is {
      tell event AlertAcknowledged to entity AlertContext.Alert
    }
    on command ResolveAlert is {
      morph entity AlertContext.Alert to state AlertContext.Alert.ResolvedState with command ResolveAlert
      tell event AlertResolved to entity AlertContext.Alert
    }
    on command SilenceAlert is {
      tell event AlertSilenced to entity AlertContext.Alert
    }
    on command EscalateAlert is {
      tell event AlertEscalated to entity AlertContext.Alert
    }
    on command AddComment is {
      tell event CommentAdded to entity AlertContext.Alert
    }
    on command ExpireAlert is {
      morph entity AlertContext.Alert to state AlertContext.Alert.ResolvedState with command ExpireAlert
      tell event AlertExpired to entity AlertContext.Alert
    }
  } with {
    briefly "Processes alert commands"
    described as {
      | Handles alert lifecycle from firing
      | through acknowledgment and resolution.
    }
  }
} with {
  briefly "Alert aggregate"
  described as {
    | The Alert entity manages alert instances
    | and their lifecycle through resolution.
  }
}
