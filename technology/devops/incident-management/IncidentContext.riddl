// Incident Management Bounded Context

context IncidentContext is {

  include "types.riddl"
  include "Incident.riddl"

  // Repository for incident persistence and queries

  repository IncidentRepository is {

    schema IncidentData is relational
      of incidents as Incident
      index on field Incident.info.status
      index on field Incident.info.severity
      index on field Incident.info.createdAt

    handler IncidentPersistence is {
      on command Incident.CreateIncident {
        prompt "Persist new incident to database"
      }
      on command Incident.AcknowledgeIncident {
        prompt "Update incident with acknowledgment data"
      }
      on command Incident.EscalateIncident {
        prompt "Update incident severity and affected services"
      }
      on command Incident.UpdateStatus {
        prompt "Update incident status"
      }
      on command Incident.AssignIncidentCommander {
        prompt "Update incident commander assignment"
      }
      on command Incident.AddTimelineEntry {
        prompt "Append timeline entry to incident"
      }
      on command Incident.ResolveIncident {
        prompt "Update incident with resolution data"
      }
      on command Incident.CreatePostMortem {
        prompt "Store post-mortem linked to incident"
      }
      on command Incident.CloseIncident {
        prompt "Update incident to closed status"
      }
    } with {
      briefly "Persists incident events to storage"
      described by "Handles all event-driven persistence operations for incidents."
    }
  } with {
    briefly "Persistent storage for incidents"
    described by {
      | Repository providing CRUD operations and queries for
      | incident records, timelines, and post-mortem documents.
    }
  }

  // Projector for MTTR and incident frequency metrics

  projector IncidentMetricsProjector is {

    updates repository IncidentRepository

    record MetricsState is {
      totalIncidents is Natural with {
        briefly "Total incidents"
        described by "Count of all incidents tracked."
      }
      incidentsBySeveritySev1 is Natural with {
        briefly "Sev1 incidents"
        described by "Count of Sev1 incidents."
      }
      incidentsBySeveritySev2 is Natural with {
        briefly "Sev2 incidents"
        described by "Count of Sev2 incidents."
      }
      incidentsBySeveritySev3 is Natural with {
        briefly "Sev3 incidents"
        described by "Count of Sev3 incidents."
      }
      incidentsBySeveritySev4 is Natural with {
        briefly "Sev4 incidents"
        described by "Count of Sev4 incidents."
      }
      incidentsBySeveritySev5 is Natural with {
        briefly "Sev5 incidents"
        described by "Count of Sev5 incidents."
      }
      avgTimeToAcknowledge is Duration with {
        briefly "Average TTA"
        described by "Mean time to acknowledge incidents."
      }
      avgTimeToMitigate is Duration with {
        briefly "Average TTM"
        described by "Mean time to mitigate incidents."
      }
      avgTimeToResolve is Duration with {
        briefly "Average TTR"
        described by "Mean time to resolve incidents."
      }
    } with {
      briefly "Aggregated metrics state"
      described by {
        | Running aggregations of incident metrics for dashboard
        | display and reporting.
      }
    }

    handler MetricsProjectionHandler is {
      on event Incident.IncidentCreated {
        prompt "Increment incident count for severity level"
      }
      on event Incident.IncidentAcknowledged {
        prompt "Calculate and update time-to-acknowledge metrics"
      }
      on event Incident.IncidentResolved {
        prompt "Calculate and update time-to-resolve metrics"
      }
      on event Incident.IncidentClosed {
        prompt "Finalize metrics for closed incident"
      }
    } with {
      briefly "Updates metrics on incident events"
      described by {
        | Processes incident lifecycle events to maintain
        | up-to-date metrics for MTTR, MTTA, and incident frequency.
      }
    }

  } with {
    briefly "Projects incident metrics for reporting"
    described by {
      | Maintains real-time aggregations of key incident metrics:
      | - MTTA: Mean Time To Acknowledge
      | - MTTM: Mean Time To Mitigate
      | - MTTR: Mean Time To Resolve
      | - Incident frequency by severity
      | - Incident frequency by service
      |
      | These metrics are essential for SRE reporting, capacity planning,
      | and continuous improvement of incident response processes.
    }
  }

  // Projector for incident trends and patterns

  projector IncidentTrendsProjector is {

    updates repository IncidentRepository

    record TrendsState is {
      weeklyIncidentCount is Natural with {
        briefly "Weekly count"
        described by "Incidents in the current week."
      }
      monthlyIncidentCount is Natural with {
        briefly "Monthly count"
        described by "Incidents in the current month."
      }
      topAffectedServices is many ServiceId with {
        briefly "Top affected services"
        described by "Services with most incidents."
      }
      commonRootCauses is many String with {
        briefly "Common root causes"
        described by "Frequently occurring root causes."
      }
      sev1Count is Natural with {
        briefly "Sev1 count"
        described by "Sev1 incidents in period."
      }
      sev2Count is Natural with {
        briefly "Sev2 count"
        described by "Sev2 incidents in period."
      }
      sev3Count is Natural with {
        briefly "Sev3 count"
        described by "Sev3 incidents in period."
      }
    } with {
      briefly "Incident trend analysis state"
      described by {
        | Aggregated data for trend analysis including weekly
        | and monthly patterns, most affected services, and common causes.
      }
    }

    handler TrendsProjectionHandler is {
      on event Incident.IncidentCreated {
        prompt "Update weekly and monthly incident counts"
      }
      on event Incident.IncidentResolved {
        prompt "Update resolution trends"
      }
      on event Incident.PostMortemCreated {
        prompt "Extract and aggregate root cause patterns"
      }
    } with {
      briefly "Updates trends on incident events"
      described by {
        | Processes incident events to maintain trend data for
        | pattern recognition and proactive improvement.
      }
    }

  } with {
    briefly "Projects incident trends for analysis"
    described by {
      | Analyzes incident patterns over time to identify:
      | - Recurring issues
      | - Problematic services
      | - Common root causes
      | - Seasonal or periodic patterns
      |
      | This data supports proactive reliability improvements and
      | resource allocation decisions.
    }
  }

  // Adaptor for alerting service integration
  adaptor AlertAdapter from context AlertingService is {
    handler InboundAlerts is {
      on event AlertingService.AlertTriggered {
        tell command CreateIncident to entity Incident
      }
      on event AlertingService.AlertResolved {
        prompt "Check if incident should be auto-resolved"
      }
    } with {
      briefly "Handles alert events from monitoring"
      described by "Processes inbound alerts and creates incidents."
    }
  } with {
    briefly "Translates alerting service events"
    described by {
      | Receives alert events from external monitoring systems
      | and creates incidents in the incident management system.
    }
  }

  // Adaptor for PagerDuty integration
  adaptor PagerDutyAdapter from context PagerDutyIntegration is {
    handler InboundPages is {
      on event PagerDutyIntegration.PageAcknowledged {
        tell command AcknowledgeIncident to entity Incident
      }
    } with {
      briefly "Handles PagerDuty events"
      described by "Processes page acknowledgments from PagerDuty."
    }
  } with {
    briefly "Translates PagerDuty events"
    described by {
      | Receives events from PagerDuty for page acknowledgments
      | and updates incident status accordingly.
    }
  }

  // Adaptor for Slack integration
  adaptor SlackAdapter from context SlackIntegration is {
    handler InboundSlack is {
      on event SlackIntegration.ChannelCreated {
        prompt "Update incident with communication channel"
      }
      on event SlackIntegration.MessagePosted {
        prompt "Log message as timeline entry if relevant"
      }
    } with {
      briefly "Handles Slack events"
      described by "Processes Slack channel and message events."
    }
  } with {
    briefly "Translates Slack events"
    described by {
      | Receives events from Slack integration for channel
      | creation and message posting.
    }
  }

} with {
  briefly "Bounded context for incident management"
  described by {
    | The Incident Management context handles the full lifecycle of
    | service incidents from detection through resolution and post-mortem.
    |
    | Key capabilities:
    | - Incident creation and tracking
    | - Severity management and escalation
    | - Timeline and audit logging
    | - Post-mortem documentation
    | - Metrics calculation (MTTR, MTTA)
    | - Trend analysis and reporting
    |
    | This context integrates with alerting systems, communication tools,
    | and on-call scheduling to provide a complete incident response
    | platform for DevOps and SRE teams.
  }
}
