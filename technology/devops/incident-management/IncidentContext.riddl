// Incident Management Bounded Context
context IncidentContext is {
  include "types.riddl"
  include "Incident.riddl"
  // Repository for incident persistence and queries
  repository IncidentRepository is {
    schema IncidentData is relational
      of incidents as type Incident
        index on field Incident.info.status
        index on field Incident.info.severity
        index on field Incident.info.createdAt

    handler IncidentPersistence is {
      on command Incident.CreateIncident is {
        prompt "Persist new incident to database"
      }
      on command Incident.AcknowledgeIncident is {
        prompt "Update incident with acknowledgment data"
      }
      on command Incident.EscalateIncident is {
        prompt "Update incident severity and affected services"
      }
      on command Incident.UpdateStatus is {
        prompt "Update incident status"
      }
      on command Incident.AssignIncidentCommander is {
        prompt "Update incident commander assignment"
      }
      on command Incident.AddTimelineEntry is {
        prompt "Append timeline entry to incident"
      }
      on command Incident.ResolveIncident is {
        prompt "Update incident with resolution data"
      }
      on command Incident.CreatePostMortem is {
        prompt "Store post-mortem linked to incident"
      }
      on command Incident.CloseIncident is {
        prompt "Update incident to closed status"
      }
    } with {
      briefly "Persists incident events to storage"
      described as {
        |Handles all event-driven persistence operations for incidents.
      }
    }
  } with {
    briefly "Persistent storage for incidents"
    described as {
      | Repository providing CRUD operations and queries for
      | incident records, timelines, and post-mortem documents.
    }
  }
  // Projector for MTTR and incident frequency metrics
  projector IncidentMetricsProjector is {
    record MetricsState is  {
      totalIncidents: Natural with {
        briefly "Total incidents"
        described as {
          |Count of all incidents tracked.
        }
      }
      incidentsBySeveritySev1: Natural with {
        briefly "Sev1 incidents"
        described as {
          |Count of Sev1 incidents.
        }
      }
      incidentsBySeveritySev2: Natural with {
        briefly "Sev2 incidents"
        described as {
          |Count of Sev2 incidents.
        }
      }
      incidentsBySeveritySev3: Natural with {
        briefly "Sev3 incidents"
        described as {
          |Count of Sev3 incidents.
        }
      }
      incidentsBySeveritySev4: Natural with {
        briefly "Sev4 incidents"
        described as {
          |Count of Sev4 incidents.
        }
      }
      incidentsBySeveritySev5: Natural with {
        briefly "Sev5 incidents"
        described as {
          |Count of Sev5 incidents.
        }
      }
      avgTimeToAcknowledge: Duration with {
        briefly "Average TTA"
        described as {
          |Mean time to acknowledge incidents.
        }
      }
      avgTimeToMitigate: Duration with {
        briefly "Average TTM"
        described as {
          |Mean time to mitigate incidents.
        }
      }
      avgTimeToResolve: Duration with {
        briefly "Average TTR"
        described as {
          |Mean time to resolve incidents.
        }
      }
    } with {
      briefly "Aggregated metrics state"
      described as {
        | Running aggregations of incident metrics for dashboard
        | display and reporting.
      }
    }
    handler MetricsProjectionHandler is {
      on event Incident.IncidentCreated is {
        prompt "Increment incident count for severity level"
      }
      on event Incident.IncidentAcknowledged is {
        prompt "Calculate and update time-to-acknowledge metrics"
      }
      on event Incident.IncidentResolved is {
        prompt "Calculate and update time-to-resolve metrics"
      }
      on event Incident.IncidentClosed is {
        prompt "Finalize metrics for closed incident"
      }
    } with {
      briefly "Updates metrics on incident events"
      described as {
        | Processes incident lifecycle events to maintain
        | up-to-date metrics for MTTR, MTTA, and incident frequency.
      }
    }
  } with {
    briefly "Projects incident metrics for reporting"
    described as {
      | Maintains real-time aggregations of key incident metrics:
      | - MTTA: Mean Time To Acknowledge
      | - MTTM: Mean Time To Mitigate
      | - MTTR: Mean Time To Resolve
      | - Incident frequency by severity
      | - Incident frequency by service
      |
      | These metrics are essential for SRE reporting, capacity planning,
      | and continuous improvement of incident response processes.
    }
  }
  // Projector for incident trends and patterns
  projector IncidentTrendsProjector is {
    record TrendsState is  {
      weeklyIncidentCount: Natural with {
        briefly "Weekly count"
        described as {
          |Incidents in the current week.
        }
      }
      monthlyIncidentCount: Natural with {
        briefly "Monthly count"
        described as {
          |Incidents in the current month.
        }
      }
      topAffectedServices: ServiceId+ with {
        briefly "Top affected services"
        described as {
          |Services with most incidents.
        }
      }
      commonRootCauses: String+ with {
        briefly "Common root causes"
        described as {
          |Frequently occurring root causes.
        }
      }
      sev1Count: Natural with {
        briefly "Sev1 count"
        described as {
          |Sev1 incidents in period.
        }
      }
      sev2Count: Natural with {
        briefly "Sev2 count"
        described as {
          |Sev2 incidents in period.
        }
      }
      sev3Count: Natural with {
        briefly "Sev3 count"
        described as {
          |Sev3 incidents in period.
        }
      }
    } with {
      briefly "Incident trend analysis state"
      described as {
        | Aggregated data for trend analysis including weekly
        | and monthly patterns, most affected services, and common causes.
      }
    }
    handler TrendsProjectionHandler is {
      on event Incident.IncidentCreated is {
        prompt "Update weekly and monthly incident counts"
      }
      on event Incident.IncidentResolved is {
        prompt "Update resolution trends"
      }
      on event Incident.PostMortemCreated is {
        prompt "Extract and aggregate root cause patterns"
      }
    } with {
      briefly "Updates trends on incident events"
      described as {
        | Processes incident events to maintain trend data for
        | pattern recognition and proactive improvement.
      }
    }
  } with {
    briefly "Projects incident trends for analysis"
    described as {
      | Analyzes incident patterns over time to identify:
      | - Recurring issues
      | - Problematic services
      | - Common root causes
      | - Seasonal or periodic patterns
      |
      | This data supports proactive reliability improvements and
      | resource allocation decisions.
    }
  }
  // Adaptor for alerting service integration
  adaptor AlertAdapter from context AlertingService is { 
    handler InboundAlerts is {
      on event AlertingService.AlertTriggered is {
        tell command CreateIncident to entity Incident
      }
      on event AlertingService.AlertResolved is {
        prompt "Check if incident should be auto-resolved"
      }
    } with {
      briefly "Handles alert events from monitoring"
      described as {
        |Processes inbound alerts and creates incidents.
      }
    }
  } with {
    briefly "Translates alerting service events"
    described as {
      | Receives alert events from external monitoring systems
      | and creates incidents in the incident management system.
    }
  }
  // Adaptor for PagerDuty integration
  adaptor PagerDutyAdapter from context PagerDutyIntegration is { 
    handler InboundPages is {
      on event PagerDutyIntegration.PageAcknowledged is {
        tell command AcknowledgeIncident to entity Incident
      }
    } with {
      briefly "Handles PagerDuty events"
      described as {
        |Processes page acknowledgments from PagerDuty.
      }
    }
  } with {
    briefly "Translates PagerDuty events"
    described as {
      | Receives events from PagerDuty for page acknowledgments
      | and updates incident status accordingly.
    }
  }
  // Adaptor for Slack integration
  adaptor SlackAdapter from context SlackIntegration is { 
    handler InboundSlack is {
      on event SlackIntegration.ChannelCreated is {
        prompt "Update incident with communication channel"
      }
      on event SlackIntegration.MessagePosted is {
        prompt "Log message as timeline entry if relevant"
      }
    } with {
      briefly "Handles Slack events"
      described as {
        |Processes Slack channel and message events.
      }
    }
  } with {
    briefly "Translates Slack events"
    described as {
      | Receives events from Slack integration for channel
      | creation and message posting.
    }
  }
} with {
  briefly "Bounded context for incident management"
  described as {
    | The Incident Management context handles the full lifecycle of
    | service incidents from detection through resolution and post-mortem.
    |
    | Key capabilities:
    | - Incident creation and tracking
    | - Severity management and escalation
    | - Timeline and audit logging
    | - Post-mortem documentation
    | - Metrics calculation (MTTR, MTTA)
    | - Trend analysis and reporting
    |
    | This context integrates with alerting systems, communication tools,
    | and on-call scheduling to provide a complete incident response
    | platform for DevOps and SRE teams.
  }
}
