// Incident Entity for Incident Management Domain

entity Incident is {

  // Commands

  command CreateIncident is {
    title is String(1, 200) with {
      briefly "Incident title"
      described by "Brief summary of the incident."
    }
    description is String(1, 2000) with {
      briefly "Incident description"
      described by "Detailed description of the issue."
    }
    severity is IncidentSeverity with {
      briefly "Severity level"
      described by "Initial severity classification."
    }
    affectedServices is many ServiceId with {
      briefly "Affected services"
      described by "Services impacted by this incident."
    }
    alertIds is many AlertId with {
      briefly "Related alerts"
      described by "Alert identifiers that triggered this incident."
    }
    customerImpact is String(1, 1000) with {
      briefly "Customer impact"
      described by "Description of how customers are affected."
    }
    communicationChannel is String(1, 200) with {
      briefly "Communication channel"
      described by "Slack channel or other coordination channel."
    }
  } with {
    briefly "Create a new incident from an alert or manual report"
    described by {
      | Initiates a new incident record, typically triggered by an
      | alerting system or reported manually by an engineer. Sets the initial
      | severity and identifies affected services.
    }
  }

  command AcknowledgeIncident is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being acknowledged."
    }
    acknowledgedBy is String(1, 100) with {
      briefly "Acknowledged by"
      described by "Engineer acknowledging the incident."
    }
    initialAssessment is String(1, 1000) with {
      briefly "Initial assessment"
      described by "First observations and assessment notes."
    }
  } with {
    briefly "Acknowledge an incident and begin response"
    described by {
      | Marks the incident as acknowledged by an on-call engineer,
      | recording who responded and their initial assessment. Starts the
      | investigation phase.
    }
  }

  command EscalateIncident is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being escalated."
    }
    newSeverity is IncidentSeverity with {
      briefly "New severity"
      described by "The escalated severity level."
    }
    escalatedBy is String(1, 100) with {
      briefly "Escalated by"
      described by "Person escalating the incident."
    }
    reason is String(1, 1000) with {
      briefly "Escalation reason"
      described by "Why the incident is being escalated."
    }
    additionalServices is many ServiceId with {
      briefly "Additional services"
      described by "Newly identified affected services."
    }
  } with {
    briefly "Escalate incident severity or scope"
    described by {
      | Increases the severity level of an incident or expands the
      | scope of affected services. Used when initial assessment underestimated
      | the impact or when the situation worsens.
    }
  }

  command UpdateStatus is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being updated."
    }
    newStatus is IncidentStatus with {
      briefly "New status"
      described by "The new incident status."
    }
    updatedBy is String(1, 100) with {
      briefly "Updated by"
      described by "Person updating the status."
    }
    notes is String(1, 2000) with {
      briefly "Status notes"
      described by "Notes about the status change."
    }
  } with {
    briefly "Update the incident status"
    described by {
      | Transitions the incident through its lifecycle states,
      | recording who made the change and any relevant notes about the
      | current situation.
    }
  }

  command AssignIncidentCommander is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being assigned."
    }
    commander is String(1, 100) with {
      briefly "Commander name"
      described by "Person being assigned as incident commander."
    }
    assignedBy is String(1, 100) with {
      briefly "Assigned by"
      described by "Person making the assignment."
    }
  } with {
    briefly "Assign an incident commander"
    described by {
      | Designates a specific person as the incident commander
      | responsible for coordinating the response effort and making
      | critical decisions.
    }
  }

  command AddTimelineEntry is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident to update."
    }
    author is String(1, 100) with {
      briefly "Author"
      described by "Person adding the entry."
    }
    action is String(1, 200) with {
      briefly "Action taken"
      described by "Description of the action or observation."
    }
    details is String(1, 2000) with {
      briefly "Details"
      described by "Additional details about the action."
    }
  } with {
    briefly "Add an entry to the incident timeline"
    described by {
      | Records a significant event, action, or observation during
      | incident response. Builds the audit trail for post-mortem analysis.
    }
  }

  command ResolveIncident is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being resolved."
    }
    resolvedBy is String(1, 100) with {
      briefly "Resolved by"
      described by "Person resolving the incident."
    }
    resolutionSummary is String(1, 2000) with {
      briefly "Resolution summary"
      described by "Summary of how the incident was resolved."
    }
    updatedRootCause is optional String(1, 2000) with {
      briefly "Root cause"
      described by "Preliminary root cause if known."
    }
  } with {
    briefly "Mark the incident as resolved"
    described by {
      | Indicates that service has been restored and the immediate
      | incident is over. Captures resolution summary and preliminary root
      | cause if known.
    }
  }

  command CreatePostMortem is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident for the post-mortem."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Executive summary of the incident."
    }
    rootCause is String(1, 2000) with {
      briefly "Root cause"
      described by "Root cause analysis findings."
    }
    impact is String(1, 2000) with {
      briefly "Impact"
      described by "Quantified impact assessment."
    }
    lessonsLearned is many String with {
      briefly "Lessons learned"
      described by "Key insights from the incident."
    }
    actionItems is many String with {
      briefly "Action items"
      described by "Follow-up tasks to complete."
    }
    preventionMeasures is many String with {
      briefly "Prevention measures"
      described by "Steps to prevent recurrence."
    }
    author is String(1, 100) with {
      briefly "Author"
      described by "Person writing the post-mortem."
    }
  } with {
    briefly "Create a post-mortem analysis"
    described by {
      | Completes the incident lifecycle by documenting the full
      | blameless post-mortem including root cause analysis, lessons learned,
      | and action items for preventing future occurrences.
    }
  }

  command CloseIncident is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident being closed."
    }
    closedBy is String(1, 100) with {
      briefly "Closed by"
      described by "Person closing the incident."
    }
  } with {
    briefly "Close the incident after post-mortem"
    described by {
      | Marks the incident as fully closed after the post-mortem
      | has been completed and reviewed.
    }
  }

  // Events

  event IncidentCreated is {
    info is IncidentInfo with {
      briefly "Incident information"
      described by "Complete initial incident data."
    }
    timeline is many TimelineEntry with {
      briefly "Initial timeline"
      described by "Initial timeline entry."
    }
  } with {
    briefly "An incident has been created"
    described by {
      | Emitted when a new incident is created, containing the
      | full initial incident information and the first timeline entry.
    }
  }

  event IncidentAcknowledged is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The acknowledged incident."
    }
    acknowledgedBy is String(1, 100) with {
      briefly "Acknowledged by"
      described by "Who acknowledged."
    }
    acknowledgedAt is TimeStamp with {
      briefly "Acknowledged at"
      described by "When acknowledged."
    }
    initialAssessment is String(1, 1000) with {
      briefly "Initial assessment"
      described by "First assessment notes."
    }
  } with {
    briefly "An incident has been acknowledged"
    described by {
      | Emitted when an on-call engineer acknowledges the incident,
      | starting the clock on time-to-mitigate metrics.
    }
  }

  event IncidentEscalated is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The escalated incident."
    }
    previousSeverity is IncidentSeverity with {
      briefly "Previous severity"
      described by "Severity before escalation."
    }
    newSeverity is IncidentSeverity with {
      briefly "New severity"
      described by "Severity after escalation."
    }
    escalatedBy is String(1, 100) with {
      briefly "Escalated by"
      described by "Who escalated."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Why escalated."
    }
    additionalServices is many ServiceId with {
      briefly "Additional services"
      described by "Newly affected services."
    }
  } with {
    briefly "An incident has been escalated"
    described by {
      | Emitted when incident severity is increased or scope
      | expanded due to worsening conditions or revised assessment.
    }
  }

  event IncidentStatusUpdated is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The updated incident."
    }
    previousStatus is IncidentStatus with {
      briefly "Previous status"
      described by "Status before update."
    }
    newStatus is IncidentStatus with {
      briefly "New status"
      described by "Status after update."
    }
    updatedBy is String(1, 100) with {
      briefly "Updated by"
      described by "Who made the update."
    }
    notes is String(1, 2000) with {
      briefly "Notes"
      described by "Update notes."
    }
    updatedAt is TimeStamp with {
      briefly "Updated at"
      described by "When updated."
    }
  } with {
    briefly "Incident status has changed"
    described by {
      | Emitted when the incident transitions between lifecycle
      | states, recording the transition for metrics and audit purposes.
    }
  }

  event IncidentCommanderAssigned is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident."
    }
    commander is String(1, 100) with {
      briefly "Commander"
      described by "Assigned commander."
    }
    assignedBy is String(1, 100) with {
      briefly "Assigned by"
      described by "Who made the assignment."
    }
    assignedAt is TimeStamp with {
      briefly "Assigned at"
      described by "When assigned."
    }
  } with {
    briefly "An incident commander has been assigned"
    described by {
      | Emitted when someone is designated as incident commander
      | responsible for coordinating the response.
    }
  }

  event TimelineEntryAdded is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident."
    }
    entry is TimelineEntry with {
      briefly "Timeline entry"
      described by "The new entry."
    }
  } with {
    briefly "A timeline entry has been added"
    described by {
      | Emitted when a new event, action, or observation is
      | recorded in the incident timeline.
    }
  }

  event IncidentResolved is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The resolved incident."
    }
    resolvedBy is String(1, 100) with {
      briefly "Resolved by"
      described by "Who resolved it."
    }
    resolvedAt is TimeStamp with {
      briefly "Resolved at"
      described by "When resolved."
    }
    resolutionSummary is String(1, 2000) with {
      briefly "Resolution summary"
      described by "How it was resolved."
    }
    updatedRootCause is optional String(1, 2000) with {
      briefly "Root cause"
      described by "Preliminary root cause."
    }
    timeToResolve is Duration with {
      briefly "Time to resolve"
      described by "Total resolution time."
    }
  } with {
    briefly "An incident has been resolved"
    described by {
      | Emitted when service is restored and the incident is
      | resolved. Includes calculated MTTR for this incident.
    }
  }

  event PostMortemCreated is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The incident."
    }
    postMortem is PostMortem with {
      briefly "Post-mortem"
      described by "The post-mortem document."
    }
  } with {
    briefly "A post-mortem has been created"
    described by {
      | Emitted when the blameless post-mortem analysis is
      | completed and documented.
    }
  }

  event IncidentClosed is {
    incidentId is IncidentId with {
      briefly "Incident identifier"
      described by "The closed incident."
    }
    closedBy is String(1, 100) with {
      briefly "Closed by"
      described by "Who closed it."
    }
    closedAt is TimeStamp with {
      briefly "Closed at"
      described by "When closed."
    }
  } with {
    briefly "An incident has been closed"
    described by {
      | Emitted when the incident is fully closed after post-mortem
      | review is complete.
    }
  }

  // State Records

  record TriggeredStateData is {
    info is IncidentInfo with {
      briefly "Incident info"
      described by "Complete incident information."
    }
    timeline is many TimelineEntry with {
      briefly "Timeline"
      described by "Incident timeline entries."
    }
  } with {
    briefly "State data for triggered incidents"
    described by "Data for incidents that have been created but not acknowledged."
  }

  record ActiveStateData is {
    info is IncidentInfo with {
      briefly "Incident info"
      described by "Complete incident information."
    }
    timeline is many TimelineEntry with {
      briefly "Timeline"
      described by "Incident timeline entries."
    }
    acknowledgedAt is TimeStamp with {
      briefly "Acknowledged at"
      described by "When the incident was acknowledged."
    }
    acknowledgedBy is String(1, 100) with {
      briefly "Acknowledged by"
      described by "Who acknowledged the incident."
    }
  } with {
    briefly "State data for active incidents"
    described by "Data for incidents being actively worked."
  }

  record ResolvedStateData is {
    info is IncidentInfo with {
      briefly "Incident info"
      described by "Complete incident information."
    }
    timeline is many TimelineEntry with {
      briefly "Timeline"
      described by "Incident timeline entries."
    }
    resolvedAt is TimeStamp with {
      briefly "Resolved at"
      described by "When the incident was resolved."
    }
    resolvedBy is String(1, 100) with {
      briefly "Resolved by"
      described by "Who resolved the incident."
    }
    resolutionSummary is String(1, 2000) with {
      briefly "Resolution summary"
      described by "How the incident was resolved."
    }
    updatedRootCause is optional String(1, 2000) with {
      briefly "Root cause"
      described by "Preliminary root cause if known."
    }
  } with {
    briefly "State data for resolved incidents"
    described by "Data for incidents that are resolved but awaiting post-mortem."
  }

  record ClosedStateData is {
    info is IncidentInfo with {
      briefly "Incident info"
      described by "Complete incident information."
    }
    timeline is many TimelineEntry with {
      briefly "Timeline"
      described by "Incident timeline entries."
    }
    postMortem is PostMortem with {
      briefly "Post-mortem"
      described by "Completed post-mortem document."
    }
    closedAt is TimeStamp with {
      briefly "Closed at"
      described by "When the incident was closed."
    }
  } with {
    briefly "State data for closed incidents"
    described by "Data for incidents that are fully closed with post-mortem complete."
  }

  // States

  state TriggeredState of Incident.TriggeredStateData with {
    briefly "Initial state when incident is triggered"
    described by {
      | The incident has been created from an alert or manual report
      | but has not yet been acknowledged by an on-call engineer.
    }
  }

  state ActiveState of Incident.ActiveStateData with {
    briefly "Incident is being actively worked"
    described by {
      | The incident has been acknowledged and is being actively
      | investigated and mitigated by the response team.
    }
  }

  state ResolvedState of Incident.ResolvedStateData with {
    briefly "Incident is resolved but awaiting post-mortem"
    described by {
      | Service has been restored but the post-mortem analysis
      | has not yet been completed.
    }
  }

  state ClosedState of Incident.ClosedStateData with {
    briefly "Incident is fully closed"
    described by {
      | The incident has been resolved and the post-mortem has
      | been completed and reviewed. This is the terminal state.
    }
  }

  // Handler

  handler IncidentHandler is {
    on command CreateIncident {
      morph entity Incident to state Incident.TriggeredState with command CreateIncident
      tell event IncidentCreated to entity Incident
    }
    on command AcknowledgeIncident {
      morph entity Incident to state Incident.ActiveState with command AcknowledgeIncident
      tell event IncidentAcknowledged to entity Incident
    }
    on command EscalateIncident {
      tell event IncidentEscalated to entity Incident
    }
    on command UpdateStatus {
      tell event IncidentStatusUpdated to entity Incident
    }
    on command AssignIncidentCommander {
      tell event IncidentCommanderAssigned to entity Incident
    }
    on command AddTimelineEntry {
      tell event TimelineEntryAdded to entity Incident
    }
    on command ResolveIncident {
      morph entity Incident to state Incident.ResolvedState with command ResolveIncident
      tell event IncidentResolved to entity Incident
    }
    on command CreatePostMortem {
      tell event PostMortemCreated to entity Incident
    }
    on command CloseIncident {
      morph entity Incident to state Incident.ClosedState with command CloseIncident
      tell event IncidentClosed to entity Incident
    }
  } with {
    briefly "Handles all incident lifecycle commands"
    described by {
      | Processes commands for incident creation, acknowledgment,
      | escalation, status updates, resolution, and closure.
    }
  }

} with {
  option is aggregate
  option is event-sourced
  briefly "An incident requiring response and resolution"
  described by {
    | The Incident entity represents a service disruption or degradation
    | that requires coordinated response. It tracks the full lifecycle
    | from initial alert through resolution and post-mortem analysis.
    |
    | Incidents are event-sourced, maintaining a complete audit trail
    | of all actions taken during response for compliance, learning,
    | and metrics calculation.
  }
}
