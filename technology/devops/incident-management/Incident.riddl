// Incident Entity for Incident Management Domain
entity Incident is {
  // Commands
  command CreateIncident is  {
    title: String(1,200) with {
      briefly "Incident title"
      described as {
        |Brief summary of the incident.
      }
    }
    description: String(1,2000) with {
      briefly "Incident description"
      described as {
        |Detailed description of the issue.
      }
    }
    severity: IncidentSeverity with {
      briefly "Severity level"
      described as {
        |Initial severity classification.
      }
    }
    affectedServices: ServiceId+ with {
      briefly "Affected services"
      described as {
        |Services impacted by this incident.
      }
    }
    alertIds: AlertId+ with {
      briefly "Related alerts"
      described as {
        |Alert identifiers that triggered this incident.
      }
    }
    customerImpact: String(1,1000) with {
      briefly "Customer impact"
      described as {
        |Description of how customers are affected.
      }
    }
    communicationChannel: String(1,200) with {
      briefly "Communication channel"
      described as {
        |Slack channel or other coordination channel.
      }
    }
  } with {
    briefly "Create a new incident from an alert or manual report"
    described as {
      | Initiates a new incident record, typically triggered by an
      | alerting system or reported manually by an engineer. Sets the initial
      | severity and identifies affected services.
    }
  }
  command AcknowledgeIncident is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being acknowledged.
      }
    }
    acknowledgedBy: String(1,100) with {
      briefly "Acknowledged by"
      described as {
        |Engineer acknowledging the incident.
      }
    }
    initialAssessment: String(1,1000) with {
      briefly "Initial assessment"
      described as {
        |First observations and assessment notes.
      }
    }
  } with {
    briefly "Acknowledge an incident and begin response"
    described as {
      | Marks the incident as acknowledged by an on-call engineer,
      | recording who responded and their initial assessment. Starts the
      | investigation phase.
    }
  }
  command EscalateIncident is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being escalated.
      }
    }
    newSeverity: IncidentSeverity with {
      briefly "New severity"
      described as {
        |The escalated severity level.
      }
    }
    escalatedBy: String(1,100) with {
      briefly "Escalated by"
      described as {
        |Person escalating the incident.
      }
    }
    reason: String(1,1000) with {
      briefly "Escalation reason"
      described as {
        |Why the incident is being escalated.
      }
    }
    additionalServices: ServiceId+ with {
      briefly "Additional services"
      described as {
        |Newly identified affected services.
      }
    }
  } with {
    briefly "Escalate incident severity or scope"
    described as {
      | Increases the severity level of an incident or expands the
      | scope of affected services. Used when initial assessment underestimated
      | the impact or when the situation worsens.
    }
  }
  command UpdateStatus is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being updated.
      }
    }
    newStatus: IncidentStatus with {
      briefly "New status"
      described as {
        |The new incident status.
      }
    }
    updatedBy: String(1,100) with {
      briefly "Updated by"
      described as {
        |Person updating the status.
      }
    }
    notes: String(1,2000) with {
      briefly "Status notes"
      described as {
        |Notes about the status change.
      }
    }
  } with {
    briefly "Update the incident status"
    described as {
      | Transitions the incident through its lifecycle states,
      | recording who made the change and any relevant notes about the
      | current situation.
    }
  }
  command AssignIncidentCommander is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being assigned.
      }
    }
    commander: String(1,100) with {
      briefly "Commander name"
      described as {
        |Person being assigned as incident commander.
      }
    }
    assignedBy: String(1,100) with {
      briefly "Assigned by"
      described as {
        |Person making the assignment.
      }
    }
  } with {
    briefly "Assign an incident commander"
    described as {
      | Designates a specific person as the incident commander
      | responsible for coordinating the response effort and making
      | critical decisions.
    }
  }
  command AddTimelineEntry is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident to update.
      }
    }
    author: String(1,100) with {
      briefly "Author"
      described as {
        |Person adding the entry.
      }
    }
    action: String(1,200) with {
      briefly "Action taken"
      described as {
        |Description of the action or observation.
      }
    }
    details: String(1,2000) with {
      briefly "Details"
      described as {
        |Additional details about the action.
      }
    }
  } with {
    briefly "Add an entry to the incident timeline"
    described as {
      | Records a significant event, action, or observation during
      | incident response. Builds the audit trail for post-mortem analysis.
    }
  }
  command ResolveIncident is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being resolved.
      }
    }
    resolvedBy: String(1,100) with {
      briefly "Resolved by"
      described as {
        |Person resolving the incident.
      }
    }
    resolutionSummary: String(1,2000) with {
      briefly "Resolution summary"
      described as {
        |Summary of how the incident was resolved.
      }
    }
    updatedRootCause: String(1,2000)? with {
      briefly "Root cause"
      described as {
        |Preliminary root cause if known.
      }
    }
  } with {
    briefly "Mark the incident as resolved"
    described as {
      | Indicates that service has been restored and the immediate
      | incident is over. Captures resolution summary and preliminary root
      | cause if known.
    }
  }
  command CreatePostMortem is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident for the post-mortem.
      }
    }
    summary: String(1,2000) with {
      briefly "Summary"
      described as {
        |Executive summary of the incident.
      }
    }
    rootCause: String(1,2000) with {
      briefly "Root cause"
      described as {
        |Root cause analysis findings.
      }
    }
    impact: String(1,2000) with {
      briefly "Impact"
      described as {
        |Quantified impact assessment.
      }
    }
    lessonsLearned: String+ with {
      briefly "Lessons learned"
      described as {
        |Key insights from the incident.
      }
    }
    actionItems: String+ with {
      briefly "Action items"
      described as {
        |Follow-up tasks to complete.
      }
    }
    preventionMeasures: String+ with {
      briefly "Prevention measures"
      described as {
        |Steps to prevent recurrence.
      }
    }
    author: String(1,100) with {
      briefly "Author"
      described as {
        |Person writing the post-mortem.
      }
    }
  } with {
    briefly "Create a post-mortem analysis"
    described as {
      | Completes the incident lifecycle by documenting the full
      | blameless post-mortem including root cause analysis, lessons learned,
      | and action items for preventing future occurrences.
    }
  }
  command CloseIncident is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident being closed.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Person closing the incident.
      }
    }
  } with {
    briefly "Close the incident after post-mortem"
    described as {
      | Marks the incident as fully closed after the post-mortem
      | has been completed and reviewed.
    }
  }
  // Events
  event IncidentCreated is  {
    info: IncidentInfo with {
      briefly "Incident information"
      described as {
        |Complete initial incident data.
      }
    }
    timeline: TimelineEntry+ with {
      briefly "Initial timeline"
      described as {
        |Initial timeline entry.
      }
    }
  } with {
    briefly "An incident has been created"
    described as {
      | Emitted when a new incident is created, containing the
      | full initial incident information and the first timeline entry.
    }
  }
  event IncidentAcknowledged is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The acknowledged incident.
      }
    }
    acknowledgedBy: String(1,100) with {
      briefly "Acknowledged by"
      described as {
        |Who acknowledged.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged at"
      described as {
        |When acknowledged.
      }
    }
    initialAssessment: String(1,1000) with {
      briefly "Initial assessment"
      described as {
        |First assessment notes.
      }
    }
  } with {
    briefly "An incident has been acknowledged"
    described as {
      | Emitted when an on-call engineer acknowledges the incident,
      | starting the clock on time-to-mitigate metrics.
    }
  }
  event IncidentEscalated is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The escalated incident.
      }
    }
    previousSeverity: IncidentSeverity with {
      briefly "Previous severity"
      described as {
        |Severity before escalation.
      }
    }
    newSeverity: IncidentSeverity with {
      briefly "New severity"
      described as {
        |Severity after escalation.
      }
    }
    escalatedBy: String(1,100) with {
      briefly "Escalated by"
      described as {
        |Who escalated.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Why escalated.
      }
    }
    additionalServices: ServiceId+ with {
      briefly "Additional services"
      described as {
        |Newly affected services.
      }
    }
  } with {
    briefly "An incident has been escalated"
    described as {
      | Emitted when incident severity is increased or scope
      | expanded due to worsening conditions or revised assessment.
    }
  }
  event IncidentStatusUpdated is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The updated incident.
      }
    }
    previousStatus: IncidentStatus with {
      briefly "Previous status"
      described as {
        |Status before update.
      }
    }
    newStatus: IncidentStatus with {
      briefly "New status"
      described as {
        |Status after update.
      }
    }
    updatedBy: String(1,100) with {
      briefly "Updated by"
      described as {
        |Who made the update.
      }
    }
    notes: String(1,2000) with {
      briefly "Notes"
      described as {
        |Update notes.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated at"
      described as {
        |When updated.
      }
    }
  } with {
    briefly "Incident status has changed"
    described as {
      | Emitted when the incident transitions between lifecycle
      | states, recording the transition for metrics and audit purposes.
    }
  }
  event IncidentCommanderAssigned is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident.
      }
    }
    commander: String(1,100) with {
      briefly "Commander"
      described as {
        |Assigned commander.
      }
    }
    assignedBy: String(1,100) with {
      briefly "Assigned by"
      described as {
        |Who made the assignment.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned at"
      described as {
        |When assigned.
      }
    }
  } with {
    briefly "An incident commander has been assigned"
    described as {
      | Emitted when someone is designated as incident commander
      | responsible for coordinating the response.
    }
  }
  event TimelineEntryAdded is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident.
      }
    }
    entry: TimelineEntry with {
      briefly "Timeline entry"
      described as {
        |The new entry.
      }
    }
  } with {
    briefly "A timeline entry has been added"
    described as {
      | Emitted when a new event, action, or observation is
      | recorded in the incident timeline.
    }
  }
  event IncidentResolved is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The resolved incident.
      }
    }
    resolvedBy: String(1,100) with {
      briefly "Resolved by"
      described as {
        |Who resolved it.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved at"
      described as {
        |When resolved.
      }
    }
    resolutionSummary: String(1,2000) with {
      briefly "Resolution summary"
      described as {
        |How it was resolved.
      }
    }
    updatedRootCause: String(1,2000)? with {
      briefly "Root cause"
      described as {
        |Preliminary root cause.
      }
    }
    timeToResolve: Duration with {
      briefly "Time to resolve"
      described as {
        |Total resolution time.
      }
    }
  } with {
    briefly "An incident has been resolved"
    described as {
      | Emitted when service is restored and the incident is
      | resolved. Includes calculated MTTR for this incident.
    }
  }
  event PostMortemCreated is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The incident.
      }
    }
    postMortem: PostMortem with {
      briefly "Post-mortem"
      described as {
        |The post-mortem document.
      }
    }
  } with {
    briefly "A post-mortem has been created"
    described as {
      | Emitted when the blameless post-mortem analysis is
      | completed and documented.
    }
  }
  event IncidentClosed is  {
    incidentId: IncidentId with {
      briefly "Incident identifier"
      described as {
        |The closed incident.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Who closed it.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed at"
      described as {
        |When closed.
      }
    }
  } with {
    briefly "An incident has been closed"
    described as {
      | Emitted when the incident is fully closed after post-mortem
      | review is complete.
    }
  }
  // State Records
  record TriggeredStateData is  {
    info: IncidentInfo with {
      briefly "Incident info"
      described as {
        |Complete incident information.
      }
    }
    timeline: TimelineEntry+ with {
      briefly "Timeline"
      described as {
        |Incident timeline entries.
      }
    }
  } with {
    briefly "State data for triggered incidents"
    described as {
      |Data for incidents that have been created but not acknowledged.
    }
  }
  record ActiveStateData is  {
    info: IncidentInfo with {
      briefly "Incident info"
      described as {
        |Complete incident information.
      }
    }
    timeline: TimelineEntry+ with {
      briefly "Timeline"
      described as {
        |Incident timeline entries.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged at"
      described as {
        |When the incident was acknowledged.
      }
    }
    acknowledgedBy: String(1,100) with {
      briefly "Acknowledged by"
      described as {
        |Who acknowledged the incident.
      }
    }
  } with {
    briefly "State data for active incidents"
    described as {
      |Data for incidents being actively worked.
    }
  }
  record ResolvedStateData is  {
    info: IncidentInfo with {
      briefly "Incident info"
      described as {
        |Complete incident information.
      }
    }
    timeline: TimelineEntry+ with {
      briefly "Timeline"
      described as {
        |Incident timeline entries.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved at"
      described as {
        |When the incident was resolved.
      }
    }
    resolvedBy: String(1,100) with {
      briefly "Resolved by"
      described as {
        |Who resolved the incident.
      }
    }
    resolutionSummary: String(1,2000) with {
      briefly "Resolution summary"
      described as {
        |How the incident was resolved.
      }
    }
    updatedRootCause: String(1,2000)? with {
      briefly "Root cause"
      described as {
        |Preliminary root cause if known.
      }
    }
  } with {
    briefly "State data for resolved incidents"
    described as {
      |Data for incidents that are resolved but awaiting post-mortem.
    }
  }
  record ClosedStateData is  {
    info: IncidentInfo with {
      briefly "Incident info"
      described as {
        |Complete incident information.
      }
    }
    timeline: TimelineEntry+ with {
      briefly "Timeline"
      described as {
        |Incident timeline entries.
      }
    }
    postMortem: PostMortem with {
      briefly "Post-mortem"
      described as {
        |Completed post-mortem document.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed at"
      described as {
        |When the incident was closed.
      }
    }
  } with {
    briefly "State data for closed incidents"
    described as {
      |Data for incidents that are fully closed with post-mortem complete.
    }
  }
  // States
  state TriggeredState of type Incident.TriggeredStateData
  state ActiveState of type Incident.ActiveStateData
  state ResolvedState of type Incident.ResolvedStateData
  state ClosedState of type Incident.ClosedStateData
  // Handler
  handler IncidentHandler is {
    on command CreateIncident is {
      morph entity Incident to state Incident.TriggeredState with command CreateIncident
      tell event IncidentCreated to entity Incident
    }
    on command AcknowledgeIncident is {
      morph entity Incident to state Incident.ActiveState with command AcknowledgeIncident
      tell event IncidentAcknowledged to entity Incident
    }
    on command EscalateIncident is {
      tell event IncidentEscalated to entity Incident
    }
    on command UpdateStatus is {
      tell event IncidentStatusUpdated to entity Incident
    }
    on command AssignIncidentCommander is {
      tell event IncidentCommanderAssigned to entity Incident
    }
    on command AddTimelineEntry is {
      tell event TimelineEntryAdded to entity Incident
    }
    on command ResolveIncident is {
      morph entity Incident to state Incident.ResolvedState with command ResolveIncident
      tell event IncidentResolved to entity Incident
    }
    on command CreatePostMortem is {
      tell event PostMortemCreated to entity Incident
    }
    on command CloseIncident is {
      morph entity Incident to state Incident.ClosedState with command CloseIncident
      tell event IncidentClosed to entity Incident
    }
  } with {
    briefly "Handles all incident lifecycle commands"
    described as {
      | Processes commands for incident creation, acknowledgment,
      | escalation, status updates, resolution, and closure.
    }
  }
} with {
  option aggregate()
  option event-sourced()
  briefly "An incident requiring response and resolution"
  described as {
    | The Incident entity represents a service disruption or degradation
    | that requires coordinated response. It tracks the full lifecycle
    | from initial alert through resolution and post-mortem analysis.
    |
    | Incidents are event-sourced, maintaining a complete audit trail
    | of all actions taken during response for compliance, learning,
    | and metrics calculation.
  }
}
