// External Contexts for Incident Management Domain
// These represent external systems that Incident Management integrates with

context AlertingService is {

  type AlertPayload is {
    alertId is AlertId with {
      briefly "Alert identifier"
      described by "Unique ID from the alerting system."
    }
    alertName is String(1, 200) with {
      briefly "Alert name"
      described by "Name of the alert rule that triggered."
    }
    severity is String(1, 20) with {
      briefly "Alert severity"
      described by "Severity level from the alerting system."
    }
    source is String(1, 100) with {
      briefly "Alert source"
      described by "Monitoring system that generated the alert."
    }
    affectedService is ServiceId with {
      briefly "Affected service"
      described by "Primary service affected by this alert."
    }
    message is String(1, 2000) with {
      briefly "Alert message"
      described by "Detailed alert message with context."
    }
    timestamp is TimeStamp with {
      briefly "Alert timestamp"
      described by "When the alert was triggered."
    }
    labels is many String with {
      briefly "Alert labels"
      described by "Additional labels for routing and filtering."
    }
  } with {
    briefly "Payload from alerting system"
    described by {
      | Structured alert data from monitoring systems like
      | Prometheus, Datadog, or CloudWatch.
    }
  }

  event AlertTriggered is {
    payload is AlertPayload with {
      briefly "Alert data"
      described by "Complete alert information."
    }
  } with {
    briefly "An alert has been triggered"
    described by {
      | Emitted by the alerting system when a monitoring rule
      | threshold is breached or an anomaly is detected.
    }
  }

  event AlertResolved is {
    alertId is AlertId with {
      briefly "Alert identifier"
      described by "The alert that resolved."
    }
    resolvedAt is TimeStamp with {
      briefly "Resolution time"
      described by "When the alert condition cleared."
    }
  } with {
    briefly "An alert has auto-resolved"
    described by {
      | Emitted when the alerting system detects that the
      | condition that triggered the alert has returned to normal.
    }
  }

  handler AlertHandler is {
    on event AlertTriggered {
      prompt "Forward alert to incident management"
    }
    on event AlertResolved {
      prompt "Notify incident management of resolution"
    }
  } with {
    briefly "Handles alert events"
    described by "Processes alert lifecycle events from monitoring systems."
  }

} with {
  briefly "External alerting and monitoring system"
  option is external
  described by {
    | Represents external monitoring and alerting systems such as:
    | - Prometheus Alertmanager
    | - Datadog Monitors
    | - AWS CloudWatch Alarms
    | - Grafana Alerting
    |
    | This context receives alerts and converts them into incidents
    | in the incident management system.
  }
}

context PagerDutyIntegration is {

  type OnCallSchedule is {
    scheduleId is String(1, 100) with {
      briefly "Schedule ID"
      described by "PagerDuty schedule identifier."
    }
    scheduleName is String(1, 200) with {
      briefly "Schedule name"
      described by "Human-readable schedule name."
    }
    currentOnCall is String(1, 100) with {
      briefly "Current on-call"
      described by "Person currently on-call."
    }
    escalationPolicy is String(1, 200) with {
      briefly "Escalation policy"
      described by "Name of the escalation policy."
    }
  } with {
    briefly "Current on-call schedule information"
    described by {
      | Information about who is currently on-call and the
      | escalation policy to follow.
    }
  }

  type PageRequest is {
    userId is String(1, 100) with {
      briefly "User ID"
      described by "PagerDuty user to page."
    }
    urgency is String(1, 20) with {
      briefly "Urgency"
      described by "Page urgency level (high, low)."
    }
    message is String(1, 1000) with {
      briefly "Message"
      described by "Page message content."
    }
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident identifier."
    }
  } with {
    briefly "Request to page an on-call engineer"
    described by {
      | Parameters for sending a page to notify an engineer
      | of an incident requiring attention.
    }
  }

  command SendPage is {
    request is PageRequest with {
      briefly "Page request"
      described by "Page request parameters."
    }
  } with {
    briefly "Send a page to on-call engineer"
    described by {
      | Triggers a notification to the on-call engineer via
      | PagerDuty's notification channels (phone, SMS, push, email).
    }
  }

  command EscalatePage is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident to escalate."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Why escalation is needed."
    }
  } with {
    briefly "Escalate to next level in escalation policy"
    described by {
      | Triggers escalation to the next person or team in the
      | escalation policy when the current on-call doesn't respond.
    }
  }

  event PageSent is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    pagedUser is String(1, 100) with {
      briefly "Paged user"
      described by "User who was paged."
    }
    sentAt is TimeStamp with {
      briefly "Sent at"
      described by "When the page was sent."
    }
  } with {
    briefly "A page has been sent"
    described by {
      | Confirmation that a page was successfully sent to an
      | on-call engineer.
    }
  }

  event PageAcknowledged is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    acknowledgedBy is String(1, 100) with {
      briefly "Acknowledged by"
      described by "User who acknowledged."
    }
    acknowledgedAt is TimeStamp with {
      briefly "Acknowledged at"
      described by "When acknowledged."
    }
  } with {
    briefly "A page has been acknowledged"
    described by {
      | Notification that the paged engineer has acknowledged
      | the page and is responding.
    }
  }

  query GetCurrentOnCall is {
    scheduleId is String(1, 100) with {
      briefly "Schedule ID"
      described by "Schedule to query."
    }
  } with {
    briefly "Get the current on-call engineer"
    described by {
      | Queries PagerDuty for who is currently on-call for a
      | given schedule.
    }
  }

  result OnCallResult is {
    schedule is OnCallSchedule with {
      briefly "Schedule"
      described by "Current on-call information."
    }
  } with {
    briefly "Current on-call information"
    described by {
      | Contains the current on-call engineer and escalation
      | policy information.
    }
  }

  handler PagerDutyHandler is {
    on command SendPage {
      tell event PageSent to context PagerDutyIntegration
    }
    on command EscalatePage {
      tell event PageSent to context PagerDutyIntegration
    }
    on query GetCurrentOnCall {
      ???
    }
  } with {
    briefly "Handles PagerDuty commands"
    described by "Processes paging and on-call queries."
  }

} with {
  briefly "PagerDuty on-call and escalation integration"
  option is external
  described by {
    | Integration with PagerDuty for:
    | - On-call schedule management
    | - Incident notification and paging
    | - Escalation policy execution
    | - Acknowledgment tracking
    |
    | This external context handles all communication with PagerDuty's
    | API for notifying the right people during incidents.
  }
}

context SlackIntegration is {

  type SlackChannel is {
    channelId is String(1, 100) with {
      briefly "Channel ID"
      described by "Slack channel identifier."
    }
    channelName is String(1, 200) with {
      briefly "Channel name"
      described by "Human-readable channel name."
    }
    isPrivate is Boolean with {
      briefly "Is private"
      described by "Whether the channel is private."
    }
  } with {
    briefly "Slack channel information"
    described by "Identifies a Slack channel for incident communication."
  }

  type SlackMessage is {
    channelId is String(1, 100) with {
      briefly "Channel ID"
      described by "Channel to post to."
    }
    message is String(1, 4000) with {
      briefly "Message"
      described by "Message text content."
    }
    threadTs is optional String(1, 50) with {
      briefly "Thread timestamp"
      described by "Thread to reply to, if applicable."
    }
    blocks is many String with {
      briefly "Block kit blocks"
      described by "Rich formatting blocks."
    }
  } with {
    briefly "Message to post to Slack"
    described by {
      | A message with optional rich formatting blocks to post
      | to a Slack channel, optionally as a thread reply.
    }
  }

  command CreateIncidentChannel is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    channelName is String(1, 80) with {
      briefly "Channel name"
      described by "Name for the new channel."
    }
    initialMembers is many String with {
      briefly "Initial members"
      described by "Users to invite to the channel."
    }
  } with {
    briefly "Create a dedicated incident channel"
    described by {
      | Creates a new Slack channel for incident coordination,
      | inviting the incident commander and responders.
    }
  }

  command PostUpdate is {
    message is SlackMessage with {
      briefly "Message"
      described by "Message to post."
    }
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
  } with {
    briefly "Post an update to the incident channel"
    described by {
      | Posts a status update or important information to the
      | incident's Slack channel.
    }
  }

  command PostToStatusPage is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    statusMessage is String(1, 2000) with {
      briefly "Status message"
      described by "Customer-facing status update."
    }
    severity is IncidentSeverity with {
      briefly "Severity"
      described by "Incident severity level."
    }
  } with {
    briefly "Post update to public status page channel"
    described by {
      | Posts a customer-facing status update to the channel
      | that feeds the public status page.
    }
  }

  command ArchiveIncidentChannel is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    channelId is String(1, 100) with {
      briefly "Channel ID"
      described by "Channel to archive."
    }
  } with {
    briefly "Archive the incident channel after closure"
    described by {
      | Archives the incident Slack channel after the incident
      | is closed, preserving the conversation history.
    }
  }

  event ChannelCreated is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    channel is SlackChannel with {
      briefly "Channel"
      described by "The created channel."
    }
  } with {
    briefly "Incident channel has been created"
    described by {
      | Confirms that a dedicated Slack channel was created
      | for incident coordination.
    }
  }

  event MessagePosted is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    channelId is String(1, 100) with {
      briefly "Channel ID"
      described by "Channel message was posted to."
    }
    timestamp is TimeStamp with {
      briefly "Timestamp"
      described by "When the message was posted."
    }
    messageTs is String(1, 50) with {
      briefly "Message timestamp"
      described by "Slack message timestamp for threading."
    }
  } with {
    briefly "A message has been posted"
    described by {
      | Confirms that a message was successfully posted to Slack,
      | including the message timestamp for threading.
    }
  }

  event ChannelArchived is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Related incident."
    }
    channelId is String(1, 100) with {
      briefly "Channel ID"
      described by "Channel that was archived."
    }
    archivedAt is TimeStamp with {
      briefly "Archived at"
      described by "When the channel was archived."
    }
  } with {
    briefly "Incident channel has been archived"
    described by {
      | Confirms that the incident Slack channel was archived
      | after incident closure.
    }
  }

  handler SlackHandler is {
    on command CreateIncidentChannel {
      tell event ChannelCreated to context SlackIntegration
    }
    on command PostUpdate {
      tell event MessagePosted to context SlackIntegration
    }
    on command PostToStatusPage {
      tell event MessagePosted to context SlackIntegration
    }
    on command ArchiveIncidentChannel {
      tell event ChannelArchived to context SlackIntegration
    }
  } with {
    briefly "Handles Slack commands"
    described by "Processes Slack channel and message commands."
  }

} with {
  briefly "Slack communication integration"
  option is external
  described by {
    | Integration with Slack for incident communication:
    | - Creating dedicated incident channels
    | - Posting status updates
    | - Coordinating response team communication
    | - Archiving channels after resolution
    |
    | Slack serves as the primary real-time communication platform
    | during incident response, keeping all stakeholders informed.
  }
}
