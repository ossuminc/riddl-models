// External Contexts for Incident Management Domain
// These represent external systems that Incident Management integrates with
context AlertingService is {
  type AlertPayload is {
    alertId: AlertId with {
      briefly "Alert identifier"
      described as {
        |Unique ID from the alerting system.
      }
    }
    alertName: String(1,200) with {
      briefly "Alert name"
      described as {
        |Name of the alert rule that triggered.
      }
    }
    alertSeverity: String(1,20) with {
      briefly "Alert severity"
      described as {
        |Severity level from the alerting system.
      }
    }
    source: String(1,100) with {
      briefly "Alert source"
      described as {
        |Monitoring system that generated the alert.
      }
    }
    affectedService: ServiceId with {
      briefly "Affected service"
      described as {
        |Primary service affected by this alert.
      }
    }
    message: String(1,2000) with {
      briefly "Alert message"
      described as {
        |Detailed alert message with context.
      }
    }
    timestamp: TimeStamp with {
      briefly "Alert timestamp"
      described as {
        |When the alert was triggered.
      }
    }
    labels: String+ with {
      briefly "Alert labels"
      described as {
        |Additional labels for routing and filtering.
      }
    }
  } with {
    briefly "Payload from alerting system"
    described as {
      | Structured alert data from monitoring systems like
      | Prometheus, Datadog, or CloudWatch.
    }
  }
  event AlertTriggered is  {
    payload: AlertPayload with {
      briefly "Alert data"
      described as {
        |Complete alert information.
      }
    }
  } with {
    briefly "An alert has been triggered"
    described as {
      | Emitted by the alerting system when a monitoring rule
      | threshold is breached or an anomaly is detected.
    }
  }
  event AlertResolved is  {
    alertId: AlertId with {
      briefly "Alert identifier"
      described as {
        |The alert that resolved.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolution time"
      described as {
        |When the alert condition cleared.
      }
    }
  } with {
    briefly "An alert has auto-resolved"
    described as {
      | Emitted when the alerting system detects that the
      | condition that triggered the alert has returned to normal.
    }
  }
  handler AlertHandler is {
    on event AlertTriggered is {
      prompt "Forward alert to incident management"
    }
    on event AlertResolved is {
      prompt "Notify incident management of resolution"
    }
  } with {
    briefly "Handles alert events"
    described as {
      |Processes alert lifecycle events from monitoring systems.
    }
  }
} with {
  briefly "External alerting and monitoring system"
  option external()
  described as {
    | Represents external monitoring and alerting systems such as:
    | - Prometheus Alertmanager
    | - Datadog Monitors
    | - AWS CloudWatch Alarms
    | - Grafana Alerting
    |
    | This context receives alerts and converts them into incidents
    | in the incident management system.
  }
}
context PagerDutyIntegration is {
  type OnCallSchedule is {
    scheduleId: String(1,100) with {
      briefly "Schedule ID"
      described as {
        |PagerDuty schedule identifier.
      }
    }
    scheduleName: String(1,200) with {
      briefly "Schedule name"
      described as {
        |Human-readable schedule name.
      }
    }
    currentOnCall: String(1,100) with {
      briefly "Current on-call"
      described as {
        |Person currently on-call.
      }
    }
    escalationPolicy: String(1,200) with {
      briefly "Escalation policy"
      described as {
        |Name of the escalation policy.
      }
    }
  } with {
    briefly "Current on-call schedule information"
    described as {
      | Information about who is currently on-call and the
      | escalation policy to follow.
    }
  }
  type PageRequest is {
    userId: String(1,100) with {
      briefly "User ID"
      described as {
        |PagerDuty user to page.
      }
    }
    urgency: String(1,20) with {
      briefly "Urgency"
      described as {
        |Page urgency level (high, low).
      }
    }
    message: String(1,1000) with {
      briefly "Message"
      described as {
        |Page message content.
      }
    }
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident identifier.
      }
    }
  } with {
    briefly "Request to page an on-call engineer"
    described as {
      | Parameters for sending a page to notify an engineer
      | of an incident requiring attention.
    }
  }
  command SendPage is  {
    request: PageRequest with {
      briefly "Page request"
      described as {
        |Page request parameters.
      }
    }
  } with {
    briefly "Send a page to on-call engineer"
    described as {
      | Triggers a notification to the on-call engineer via
      | PagerDuty's notification channels (phone, SMS, push, email).
    }
  }
  command EscalatePage is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident to escalate.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Why escalation is needed.
      }
    }
  } with {
    briefly "Escalate to next level in escalation policy"
    described as {
      | Triggers escalation to the next person or team in the
      | escalation policy when the current on-call doesn't respond.
    }
  }
  event PageSent is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    pagedUser: String(1,100) with {
      briefly "Paged user"
      described as {
        |User who was paged.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent at"
      described as {
        |When the page was sent.
      }
    }
  } with {
    briefly "A page has been sent"
    described as {
      | Confirmation that a page was successfully sent to an
      | on-call engineer.
    }
  }
  event PageAcknowledged is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    acknowledgedBy: String(1,100) with {
      briefly "Acknowledged by"
      described as {
        |User who acknowledged.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged at"
      described as {
        |When acknowledged.
      }
    }
  } with {
    briefly "A page has been acknowledged"
    described as {
      | Notification that the paged engineer has acknowledged
      | the page and is responding.
    }
  }
  query GetCurrentOnCall is  {
    scheduleId: String(1,100) with {
      briefly "Schedule ID"
      described as {
        |Schedule to query.
      }
    }
  } with {
    briefly "Get the current on-call engineer"
    described as {
      | Queries PagerDuty for who is currently on-call for a
      | given schedule.
    }
  }
  result OnCallResult is  {
    schedule: OnCallSchedule with {
      briefly "Schedule"
      described as {
        |Current on-call information.
      }
    }
  } with {
    briefly "Current on-call information"
    described as {
      | Contains the current on-call engineer and escalation
      | policy information.
    }
  }
  handler PagerDutyHandler is {
    on command SendPage is {
      tell event PageSent to context PagerDutyIntegration
    }
    on command EscalatePage is {
      tell event PageSent to context PagerDutyIntegration
    }
    on query GetCurrentOnCall is { ??? }
  } with {
    briefly "Handles PagerDuty commands"
    described as {
      |Processes paging and on-call queries.
    }
  }
} with {
  briefly "PagerDuty on-call and escalation integration"
  option external()
  described as {
    | Integration with PagerDuty for:
    | - On-call schedule management
    | - Incident notification and paging
    | - Escalation policy execution
    | - Acknowledgment tracking
    |
    | This external context handles all communication with PagerDuty's
    | API for notifying the right people during incidents.
  }
}
context SlackIntegration is {
  type SlackChannel is {
    channelId: String(1,100) with {
      briefly "Channel ID"
      described as {
        |Slack channel identifier.
      }
    }
    channelName: String(1,200) with {
      briefly "Channel name"
      described as {
        |Human-readable channel name.
      }
    }
    isPrivate: Boolean with {
      briefly "Is private"
      described as {
        |Whether the channel is private.
      }
    }
  } with {
    briefly "Slack channel information"
    described as {
      |Identifies a Slack channel for incident communication.
    }
  }
  type SlackMessage is {
    channelId: String(1,100) with {
      briefly "Channel ID"
      described as {
        |Channel to post to.
      }
    }
    message: String(1,4000) with {
      briefly "Message"
      described as {
        |Message text content.
      }
    }
    threadTs: String(1,50)? with {
      briefly "Thread timestamp"
      described as {
        |Thread to reply to, if applicable.
      }
    }
    blocks: String+ with {
      briefly "Block kit blocks"
      described as {
        |Rich formatting blocks.
      }
    }
  } with {
    briefly "Message to post to Slack"
    described as {
      | A message with optional rich formatting blocks to post
      | to a Slack channel, optionally as a thread reply.
    }
  }
  command CreateIncidentChannel is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    channelName: String(1,80) with {
      briefly "Channel name"
      described as {
        |Name for the new channel.
      }
    }
    initialMembers: String+ with {
      briefly "Initial members"
      described as {
        |Users to invite to the channel.
      }
    }
  } with {
    briefly "Create a dedicated incident channel"
    described as {
      | Creates a new Slack channel for incident coordination,
      | inviting the incident commander and responders.
    }
  }
  command PostUpdate is  {
    slackMessage: SlackMessage with {
      briefly "Message"
      described as {
        |Message to post.
      }
    }
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
  } with {
    briefly "Post an update to the incident channel"
    described as {
      | Posts a status update or important information to the
      | incident's Slack channel.
    }
  }
  command PostToStatusPage is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    statusMessage: String(1,2000) with {
      briefly "Status message"
      described as {
        |Customer-facing status update.
      }
    }
    severity: IncidentSeverity with {
      briefly "Severity"
      described as {
        |Incident severity level.
      }
    }
  } with {
    briefly "Post update to public status page channel"
    described as {
      | Posts a customer-facing status update to the channel
      | that feeds the public status page.
    }
  }
  command ArchiveIncidentChannel is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    channelId: String(1,100) with {
      briefly "Channel ID"
      described as {
        |Channel to archive.
      }
    }
  } with {
    briefly "Archive the incident channel after closure"
    described as {
      | Archives the incident Slack channel after the incident
      | is closed, preserving the conversation history.
    }
  }
  event ChannelCreated is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    channel: SlackChannel with {
      briefly "Channel"
      described as {
        |The created channel.
      }
    }
  } with {
    briefly "Incident channel has been created"
    described as {
      | Confirms that a dedicated Slack channel was created
      | for incident coordination.
    }
  }
  event MessagePosted is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    channelId: String(1,100) with {
      briefly "Channel ID"
      described as {
        |Channel message was posted to.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |When the message was posted.
      }
    }
    messageTs: String(1,50) with {
      briefly "Message timestamp"
      described as {
        |Slack message timestamp for threading.
      }
    }
  } with {
    briefly "A message has been posted"
    described as {
      | Confirms that a message was successfully posted to Slack,
      | including the message timestamp for threading.
    }
  }
  event ChannelArchived is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Related incident.
      }
    }
    channelId: String(1,100) with {
      briefly "Channel ID"
      described as {
        |Channel that was archived.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived at"
      described as {
        |When the channel was archived.
      }
    }
  } with {
    briefly "Incident channel has been archived"
    described as {
      | Confirms that the incident Slack channel was archived
      | after incident closure.
    }
  }
  handler SlackHandler is {
    on command CreateIncidentChannel is {
      tell event ChannelCreated to context SlackIntegration
    }
    on command PostUpdate is {
      tell event MessagePosted to context SlackIntegration
    }
    on command PostToStatusPage is {
      tell event MessagePosted to context SlackIntegration
    }
    on command ArchiveIncidentChannel is {
      tell event ChannelArchived to context SlackIntegration
    }
  } with {
    briefly "Handles Slack commands"
    described as {
      |Processes Slack channel and message commands.
    }
  }
} with {
  briefly "Slack communication integration"
  option external()
  described as {
    | Integration with Slack for incident communication:
    | - Creating dedicated incident channels
    | - Posting status updates
    | - Coordinating response team communication
    | - Archiving channels after resolution
    |
    | Slack serves as the primary real-time communication platform
    | during incident response, keeping all stakeholders informed.
  }
}
