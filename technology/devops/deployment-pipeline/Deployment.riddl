// Deployment Pipeline - Deployment Entity
// The primary aggregate for deployment lifecycle management

entity Deployment is {

  // Commands

  command InitiateDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The unique identifier for the new deployment."
    }
    artifactId is ArtifactId with {
      briefly "Artifact reference"
      described by "The artifact to be deployed."
    }
    targetEnvironment is EnvironmentId with {
      briefly "Target environment"
      described by "The environment where the artifact will be deployed."
    }
    deploymentStrategy is DeploymentStrategy with {
      briefly "Deployment strategy"
      described by "How the deployment should be executed."
    }
    healthCheckUrl is URL with {
      briefly "Health check URL"
      described by "Endpoint to verify deployment health."
    }
    timeoutMinutes is Integer with {
      briefly "Timeout"
      described by "Maximum time allowed for deployment in minutes."
    }
    requiresApproval is Boolean with {
      briefly "Requires approval"
      described by "Whether manual approval is needed before execution."
    }
    initiatedBy is String(1, 100) with {
      briefly "Initiated by"
      described by "User or system that initiated the deployment."
    }
  } with {
    briefly "Initiates a new deployment request"
    described by {
      | Creates a new deployment with the specified configuration. If the
      | target environment requires approval, the deployment enters the
      | AwaitingApproval state; otherwise it proceeds directly to execution.
    }
  }

  command ApproveDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment being approved."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "User who approved the deployment."
    }
    approvalNotes is optional String(1, 500) with {
      briefly "Approval notes"
      described by "Optional notes about the approval decision."
    }
  } with {
    briefly "Approves a pending deployment for execution"
    described by {
      | Records approval for a deployment that requires manual sign-off.
      | Only deployments in AwaitingApproval state can be approved.
    }
  }

  command ExecuteDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment to execute."
    }
  } with {
    briefly "Begins execution of an approved deployment"
    described by {
      | Triggers the actual deployment process for an approved deployment.
      | This initiates communication with infrastructure services.
    }
  }

  command VerifyDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment being verified."
    }
    healthCheckPassed is Boolean with {
      briefly "Health check result"
      described by "Whether the health check passed."
    }
    responseTimeMs is Integer with {
      briefly "Response time"
      described by "Average response time in milliseconds."
    }
    errorRate is Decimal(5, 2) with {
      briefly "Error rate"
      described by "Percentage of requests that failed."
    }
    details is String(1, 1000) with {
      briefly "Details"
      described by "Additional verification details."
    }
  } with {
    briefly "Records verification results for a deployment"
    described by {
      | Captures the results of post-deployment verification checks.
      | If verification passes, the deployment can be completed.
    }
  }

  command CompleteDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment to complete."
    }
    completedAt is TimeStamp with {
      briefly "Completion time"
      described by "When the deployment completed."
    }
  } with {
    briefly "Marks a deployment as successfully completed"
    described by "Finalizes a deployment after successful verification."
  }

  command RollbackDeployment is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment to roll back."
    }
    reason is String(1, 500) with {
      briefly "Rollback reason"
      described by "Why the rollback was initiated."
    }
    rolledBackBy is String(1, 100) with {
      briefly "Rolled back by"
      described by "User or system that initiated the rollback."
    }
  } with {
    briefly "Initiates rollback to the previous deployment"
    described by {
      | Triggers a rollback of the current deployment to the previous
      | stable version. This can be initiated manually or automatically.
    }
  }

  // Events

  event DeploymentInitiated is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment that was initiated."
    }
    artifactId is ArtifactId with {
      briefly "Artifact reference"
      described by "The artifact being deployed."
    }
    targetEnvironment is EnvironmentId with {
      briefly "Target environment"
      described by "Where the artifact will be deployed."
    }
    initiatedBy is String(1, 100) with {
      briefly "Initiated by"
      described by "Who initiated the deployment."
    }
    initiatedAt is TimeStamp with {
      briefly "Initiated at"
      described by "When the deployment was initiated."
    }
  } with {
    briefly "A deployment has been initiated"
    described by "Records that a new deployment request has been created."
  }

  event DeploymentAwaitingApproval is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment awaiting approval."
    }
    targetEnvironment is EnvironmentId with {
      briefly "Target environment"
      described by "The environment requiring approval."
    }
    requestedAt is TimeStamp with {
      briefly "Requested at"
      described by "When approval was requested."
    }
  } with {
    briefly "A deployment is waiting for approval"
    described by "Indicates that a deployment requires manual approval."
  }

  event DeploymentApproved is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The approved deployment."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved the deployment."
    }
    approvalNotes is optional String(1, 500) with {
      briefly "Approval notes"
      described by "Notes from the approver."
    }
    approvedAt is TimeStamp with {
      briefly "Approved at"
      described by "When approval was granted."
    }
  } with {
    briefly "A deployment has been approved"
    described by "Records that a deployment received required approval."
  }

  event DeploymentStarted is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The deployment that started."
    }
    artifactId is ArtifactId with {
      briefly "Artifact reference"
      described by "The artifact being deployed."
    }
    targetEnvironment is EnvironmentId with {
      briefly "Target environment"
      described by "Where deployment is executing."
    }
    startedAt is TimeStamp with {
      briefly "Started at"
      described by "When execution began."
    }
  } with {
    briefly "Deployment execution has started"
    described by "Records that the actual deployment process has begun."
  }

  event DeploymentVerified is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The verified deployment."
    }
    healthCheckPassed is Boolean with {
      briefly "Health check result"
      described by "Whether health checks passed."
    }
    verifiedAt is TimeStamp with {
      briefly "Verified at"
      described by "When verification completed."
    }
  } with {
    briefly "Deployment verification has completed"
    described by "Records the results of post-deployment verification."
  }

  event DeploymentCompleted is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The completed deployment."
    }
    completedAt is TimeStamp with {
      briefly "Completed at"
      described by "When deployment completed."
    }
    durationMinutes is Integer with {
      briefly "Duration"
      described by "Total deployment duration in minutes."
    }
  } with {
    briefly "Deployment has completed successfully"
    described by "Records that a deployment has completed all stages."
  }

  event DeploymentFailed is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The failed deployment."
    }
    failureReason is String(1, 500) with {
      briefly "Failure reason"
      described by "Why the deployment failed."
    }
    failedAt is TimeStamp with {
      briefly "Failed at"
      described by "When the failure occurred."
    }
  } with {
    briefly "Deployment has failed"
    described by "Records that a deployment failed during execution."
  }

  event DeploymentRolledBack is {
    deploymentId is DeploymentId with {
      briefly "Deployment identifier"
      described by "The rolled back deployment."
    }
    previousArtifactId is ArtifactId with {
      briefly "Previous artifact"
      described by "The artifact that was restored."
    }
    rollbackReason is String(1, 500) with {
      briefly "Rollback reason"
      described by "Why the rollback occurred."
    }
    rolledBackBy is String(1, 100) with {
      briefly "Rolled back by"
      described by "Who initiated the rollback."
    }
    rolledBackAt is TimeStamp with {
      briefly "Rolled back at"
      described by "When the rollback completed."
    }
  } with {
    briefly "Deployment has been rolled back"
    described by "Records that a deployment was rolled back."
  }

  // State Records

  record PendingData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact to deploy." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentStrategy is DeploymentStrategy with { briefly "Strategy" described by "Deployment strategy." }
    healthCheckUrl is URL with { briefly "Health URL" described by "Health check endpoint." }
    timeoutMinutes is Integer with { briefly "Timeout" described by "Timeout in minutes." }
    requiresApproval is Boolean with { briefly "Needs approval" described by "Approval required." }
    initiatedBy is String(1, 100) with { briefly "Initiated by" described by "Who initiated." }
    initiatedAt is TimeStamp with { briefly "Initiated at" described by "When initiated." }
  } with {
    briefly "Initial deployment data"
    described by "State data for a newly created deployment."
  }

  record AwaitingApprovalData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact to deploy." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentStrategy is DeploymentStrategy with { briefly "Strategy" described by "Deployment strategy." }
    healthCheckUrl is URL with { briefly "Health URL" described by "Health check endpoint." }
    timeoutMinutes is Integer with { briefly "Timeout" described by "Timeout in minutes." }
    initiatedBy is String(1, 100) with { briefly "Initiated by" described by "Who initiated." }
    initiatedAt is TimeStamp with { briefly "Initiated at" described by "When initiated." }
    awaitingApprovalSince is TimeStamp with { briefly "Awaiting since" described by "When approval was requested." }
  } with {
    briefly "Data for deployment awaiting approval"
    described by "State data for a deployment waiting for manual approval."
  }

  record ApprovedData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact to deploy." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentStrategy is DeploymentStrategy with { briefly "Strategy" described by "Deployment strategy." }
    healthCheckUrl is URL with { briefly "Health URL" described by "Health check endpoint." }
    timeoutMinutes is Integer with { briefly "Timeout" described by "Timeout in minutes." }
    initiatedBy is String(1, 100) with { briefly "Initiated by" described by "Who initiated." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Who approved." }
    approvalNotes is optional String(1, 500) with { briefly "Notes" described by "Approval notes." }
    approvedAt is TimeStamp with { briefly "Approved at" described by "When approved." }
  } with {
    briefly "Data for approved deployment"
    described by "State data for a deployment that has received approval."
  }

  record InProgressData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact being deployed." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentStrategy is DeploymentStrategy with { briefly "Strategy" described by "Deployment strategy." }
    healthCheckUrl is URL with { briefly "Health URL" described by "Health check endpoint." }
    timeoutMinutes is Integer with { briefly "Timeout" described by "Timeout in minutes." }
    initiatedBy is String(1, 100) with { briefly "Initiated by" described by "Who initiated." }
    approvedBy is optional String(1, 100) with { briefly "Approved by" described by "Who approved." }
    startedAt is TimeStamp with { briefly "Started at" described by "When execution started." }
    previousArtifactId is optional ArtifactId with { briefly "Previous artifact" described by "Previously deployed artifact." }
  } with {
    briefly "Data for deployment in progress"
    described by "State data for a deployment currently executing."
  }

  record VerifyingData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact deployed." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    healthCheckUrl is URL with { briefly "Health URL" described by "Health check endpoint." }
    startedAt is TimeStamp with { briefly "Started at" described by "When execution started." }
    deployedAt is TimeStamp with { briefly "Deployed at" described by "When deployment completed." }
    previousArtifactId is optional ArtifactId with { briefly "Previous artifact" described by "Previously deployed artifact." }
  } with {
    briefly "Data for deployment being verified"
    described by "State data for a deployment undergoing verification."
  }

  record CompletedData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact deployed." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    startedAt is TimeStamp with { briefly "Started at" described by "When execution started." }
    completedAt is TimeStamp with { briefly "Completed at" described by "When completed." }
    durationMinutes is Integer with { briefly "Duration" described by "Total duration." }
    healthCheckPassed is Boolean with { briefly "Health passed" described by "Verification result." }
  } with {
    briefly "Data for completed deployment"
    described by "State data for a successfully completed deployment."
  }

  record FailedData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact that failed." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    failureReason is String(1, 500) with { briefly "Reason" described by "Why it failed." }
    failedAt is TimeStamp with { briefly "Failed at" described by "When it failed." }
  } with {
    briefly "Data for failed deployment"
    described by "State data for a deployment that failed."
  }

  record RolledBackData is {
    deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact that was rolled back." }
    targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
    previousArtifactId is ArtifactId with { briefly "Previous artifact" described by "Restored artifact." }
    rollbackReason is String(1, 500) with { briefly "Reason" described by "Why it was rolled back." }
    rolledBackBy is String(1, 100) with { briefly "Rolled back by" described by "Who initiated rollback." }
    rolledBackAt is TimeStamp with { briefly "Rolled back at" described by "When rollback completed." }
  } with {
    briefly "Data for rolled back deployment"
    described by "State data for a deployment that was rolled back."
  }

  // States

  state PendingState of Deployment.PendingData with {
    briefly "Initial state for a new deployment"
    described by "The deployment has been created but not yet processed."
  }

  state AwaitingApprovalState of Deployment.AwaitingApprovalData with {
    briefly "Deployment is waiting for approval"
    described by "The deployment requires manual approval before execution."
  }

  state ApprovedState of Deployment.ApprovedData with {
    briefly "Deployment has been approved"
    described by "The deployment has received approval and is ready for execution."
  }

  state InProgressState of Deployment.InProgressData with {
    briefly "Deployment is currently executing"
    described by "The deployment is actively being executed."
  }

  state VerifyingState of Deployment.VerifyingData with {
    briefly "Deployment is being verified"
    described by "The deployment is undergoing verification checks."
  }

  state CompletedState of Deployment.CompletedData with {
    briefly "Deployment has completed successfully"
    described by "The deployment finished all stages successfully."
  }

  state FailedState of Deployment.FailedData with {
    briefly "Deployment has failed"
    described by "The deployment encountered an error."
  }

  state RolledBackState of Deployment.RolledBackData with {
    briefly "Deployment has been rolled back"
    described by "The deployment was rolled back to the previous version."
  }

  // Handler

  handler DeploymentHandler is {
    on command InitiateDeployment {
      morph entity Deployment to state Deployment.PendingState with command InitiateDeployment
      tell event DeploymentInitiated to entity Deployment
    }

    on command ApproveDeployment {
      morph entity Deployment to state Deployment.ApprovedState with command ApproveDeployment
      tell event DeploymentApproved to entity Deployment
    }

    on command ExecuteDeployment {
      morph entity Deployment to state Deployment.InProgressState with command ExecuteDeployment
      tell event DeploymentStarted to entity Deployment
    }

    on command VerifyDeployment {
      morph entity Deployment to state Deployment.VerifyingState with command VerifyDeployment
      tell event DeploymentVerified to entity Deployment
    }

    on command CompleteDeployment {
      morph entity Deployment to state Deployment.CompletedState with command CompleteDeployment
      tell event DeploymentCompleted to entity Deployment
    }

    on command RollbackDeployment {
      morph entity Deployment to state Deployment.RolledBackState with command RollbackDeployment
      tell event DeploymentRolledBack to entity Deployment
    }
  } with {
    briefly "Handles deployment lifecycle commands"
    described by {
      | Processes all deployment commands, managing state transitions
      | and emitting appropriate events throughout the deployment lifecycle.
    }
  }

} with {
  briefly "Aggregate entity managing deployment lifecycle"
  described by {
    | The Deployment entity is the core aggregate for managing the complete
    | lifecycle of a software deployment. It tracks deployments from initiation
    | through approval, execution, verification, and completion or rollback.
  }
}
