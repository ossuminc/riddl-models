// Deployment Context - Bounded context for deployment management

context DeploymentContext is {

  include "Deployment.riddl"

  entity Environment is {

    command RegisterEnvironment is {
      environmentId is EnvironmentId with {
        briefly "Environment identifier"
        described by "The unique identifier for the environment."
      }
      name is String(1, 100) with {
        briefly "Environment name"
        described by "Human-readable name for the environment."
      }
      environmentType is EnvironmentType with {
        briefly "Environment type"
        described by "Classification of the environment."
      }
      clusterEndpoint is URL with {
        briefly "Cluster endpoint"
        described by "URL of the deployment cluster."
      }
    } with {
      briefly "Registers a new deployment environment"
      described by "Creates a new environment that can be targeted by deployments."
    }

    command UpdateEnvironmentArtifact is {
      environmentId is EnvironmentId with {
        briefly "Environment identifier"
        described by "The environment being updated."
      }
      artifactId is ArtifactId with {
        briefly "Artifact identifier"
        described by "The newly deployed artifact."
      }
      deployedAt is TimeStamp with {
        briefly "Deployed at"
        described by "When the artifact was deployed."
      }
    } with {
      briefly "Updates the currently deployed artifact"
      described by "Records the artifact currently deployed to this environment."
    }

    event EnvironmentRegistered is {
      environmentId is EnvironmentId with {
        briefly "Environment identifier"
        described by "The registered environment."
      }
      name is String(1, 100) with {
        briefly "Name"
        described by "Environment name."
      }
      environmentType is EnvironmentType with {
        briefly "Type"
        described by "Environment classification."
      }
      registeredAt is TimeStamp with {
        briefly "Registered at"
        described by "When the environment was registered."
      }
    } with {
      briefly "A new environment has been registered"
      described by "Records that a new deployment target environment is available."
    }

    event EnvironmentArtifactUpdated is {
      environmentId is EnvironmentId with {
        briefly "Environment identifier"
        described by "The updated environment."
      }
      artifactId is ArtifactId with {
        briefly "Artifact identifier"
        described by "The deployed artifact."
      }
      deployedAt is TimeStamp with {
        briefly "Deployed at"
        described by "When the artifact was deployed."
      }
    } with {
      briefly "Environment artifact has been updated"
      described by "Records that a new artifact was deployed to an environment."
    }

    record ActiveEnvironmentData is {
      environmentId is EnvironmentId with { briefly "ID" described by "Environment ID." }
      name is String(1, 100) with { briefly "Name" described by "Environment name." }
      environmentType is EnvironmentType with { briefly "Type" described by "Environment type." }
      clusterEndpoint is URL with { briefly "Endpoint" described by "Cluster endpoint." }
      currentArtifact is optional ArtifactId with { briefly "Current artifact" described by "Currently deployed artifact." }
      lastDeployedAt is optional TimeStamp with { briefly "Last deployed" described by "Last deployment time." }
    } with {
      briefly "Active environment data"
      described by "State data for an active environment."
    }

    state Active of Environment.ActiveEnvironmentData with {
      briefly "Environment is active and accepting deployments"
      described by "The environment is registered and available for deployments."
    }

    handler EnvironmentHandler is {
      on command RegisterEnvironment {
        morph entity Environment to state Environment.Active with command RegisterEnvironment
        tell event EnvironmentRegistered to entity Environment
      }
      on command UpdateEnvironmentArtifact {
        tell event EnvironmentArtifactUpdated to entity Environment
      }
    } with {
      briefly "Handles environment management commands"
      described by "Processes commands for environment registration and updates."
    }

  } with {
    briefly "Entity representing a deployment target environment"
    described by {
      | The Environment entity represents a deployment target such as
      | development, staging, or production. It tracks the currently
      | deployed artifact and environment configuration.
    }
  }

  repository DeploymentRepository is {

    query FindDeploymentById is {
      deploymentId is DeploymentId with {
        briefly "Deployment identifier"
        described by "The deployment to find."
      }
    } with {
      briefly "Find a deployment by its ID"
      described by "Retrieves a deployment record by its unique identifier."
    }

    query FindDeploymentsByEnvironment is {
      environmentId is EnvironmentId with {
        briefly "Environment identifier"
        described by "The target environment."
      }
      limit is optional Integer with {
        briefly "Result limit"
        described by "Maximum number of results."
      }
    } with {
      briefly "Find deployments for an environment"
      described by "Retrieves all deployments targeting a specific environment."
    }

    query FindDeploymentsByStatus is {
      status is DeploymentStatus with {
        briefly "Status filter"
        described by "The status to filter by."
      }
      limit is optional Integer with {
        briefly "Result limit"
        described by "Maximum number of results."
      }
    } with {
      briefly "Find deployments by status"
      described by "Retrieves all deployments with a specific status."
    }

    query FindRecentDeployments is {
      since is TimeStamp with {
        briefly "Since timestamp"
        described by "Find deployments after this time."
      }
      limit is optional Integer with {
        briefly "Result limit"
        described by "Maximum number of results."
      }
    } with {
      briefly "Find recent deployments"
      described by "Retrieves deployments initiated after the specified time."
    }

    result DeploymentResult is {
      deploymentId is DeploymentId with { briefly "ID" described by "Deployment ID." }
      artifactId is ArtifactId with { briefly "Artifact" described by "Artifact ID." }
      targetEnvironment is EnvironmentId with { briefly "Environment" described by "Target environment." }
      status is DeploymentStatus with { briefly "Status" described by "Current status." }
      initiatedBy is String(1, 100) with { briefly "Initiated by" described by "Who initiated." }
      initiatedAt is TimeStamp with { briefly "Initiated at" described by "When initiated." }
      updatedCompletedAt is optional TimeStamp with { briefly "Completed at" described by "When completed." }
    } with {
      briefly "Result of a deployment query"
      described by "Contains deployment information returned by queries."
    }

    result DeploymentListResult is {
      deployments is many DeploymentResult with {
        briefly "Deployments"
        described by "List of matching deployments."
      }
      totalCount is Integer with {
        briefly "Total count"
        described by "Total number of matching records."
      }
    } with {
      briefly "Result of a deployment list query"
      described by "Contains a list of deployments matching query criteria."
    }

    handler DeploymentRepositoryHandler is {
      on query FindDeploymentById {
        ???
      }
      on query FindDeploymentsByEnvironment {
        ???
      }
      on query FindDeploymentsByStatus {
        ???
      }
      on query FindRecentDeployments {
        ???
      }
    } with {
      briefly "Handles deployment repository queries"
      described by "Processes queries against the deployment data store."
    }

  } with {
    briefly "Repository for deployment data persistence and queries"
    described by {
      | The DeploymentRepository provides persistence and query capabilities
      | for deployment records. It supports queries by ID, environment,
      | status, and time range to support operational and reporting needs.
    }
  }

  projector DeploymentMetricsProjector is {

    record DeploymentMetricsSummary is {
      environmentId is EnvironmentId with { briefly "Environment" described by "Environment ID." }
      totalDeployments is Integer with { briefly "Total" described by "Total deployments." }
      successfulDeployments is Integer with { briefly "Successful" described by "Successful deployments." }
      failedDeployments is Integer with { briefly "Failed" described by "Failed deployments." }
      rolledBackDeployments is Integer with { briefly "Rolled back" described by "Rolled back deployments." }
      averageDurationMinutes is Integer with { briefly "Avg duration" described by "Average duration." }
      lastDeploymentAt is optional TimeStamp with { briefly "Last deployment" described by "Last deployment time." }
    } with {
      briefly "Summary of deployment metrics per environment"
      described by "Aggregated metrics for deployments to a specific environment."
    }

    handler DeploymentMetricsHandler is {
      on event Deployment.DeploymentCompleted {
        ???
      }
      on event Deployment.DeploymentFailed {
        ???
      }
      on event Deployment.DeploymentRolledBack {
        ???
      }
    } with {
      briefly "Handles events to update deployment metrics"
      described by {
        | Processes deployment events to maintain real-time metrics
        | including success rates, failure counts, and average duration.
      }
    }

  } with {
    briefly "Projector for deployment metrics and analytics"
    described by {
      | The DeploymentMetricsProjector maintains read-optimized views of
      | deployment statistics. It tracks success rates, failure rates,
      | rollback frequency, and deployment duration to support dashboards.
    }
  }

} with {
  briefly "Bounded context for deployment pipeline management"
  described by {
    | The DeploymentContext is the bounded context containing all
    | capabilities for managing software deployments. It includes the
    | Deployment aggregate, Environment entity, and supporting repository
    | and projector for persistence and analytics.
  }
}
