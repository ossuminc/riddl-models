// CI/CD Pipeline - Pipeline Context
context PipelineContext is {
  include "types.riddl"
  include "Pipeline.riddl"
  // Repository for pipeline persistence
  repository PipelineRepository is {
    schema PipelineData is relational
      of pipelines as type Pipeline
        index on field Pipeline.pipelineId
        index on field Pipeline.config.repository

    handler PipelinePersistence is {
      on command Pipeline.CreatePipeline is {
        prompt "Store new pipeline"
      }
      on command Pipeline.StartPipeline is {
        prompt "Store build execution"
      }
      on command Pipeline.CompleteStage is {
        prompt "Update stage results"
      }
      on command Pipeline.StoreArtifact is {
        prompt "Store artifact reference"
      }
      on command Pipeline.RequestApproval is {
        prompt "Store approval request"
      }
      on command Pipeline.ApproveDeployment is {
        prompt "Update approval status"
      }
      on command Pipeline.RejectDeployment is {
        prompt "Update rejection status"
      }
      on command Pipeline.CancelPipeline is {
        prompt "Update to cancelled"
      }
      on command Pipeline.CompletePipeline is {
        prompt "Update final status"
      }
    } with {
      briefly "Persists pipeline commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Pipeline data persistence"
    described as {
      | The PipelineRepository provides persistent storage for
      | pipelines, builds, and artifacts.
    }
  }
  // Projector for pipeline analytics
  projector PipelineAnalytics is {
    record PipelineStats is  {
      totalPipelines: Natural with {
        briefly "Total"
        described as {
          |Total pipelines.
        }
      }
      totalBuilds: Natural with {
        briefly "Builds"
        described as {
          |Total builds.
        }
      }
      successRate: Decimal(5,4) with {
        briefly "Success rate"
        described as {
          |Build success rate.
        }
      }
      averageDuration: Natural with {
        briefly "Avg duration"
        described as {
          |Average duration seconds.
        }
      }
      deploymentsToday: Natural with {
        briefly "Deployments"
        described as {
          |Deployments today.
        }
      }
    } with {
      briefly "Pipeline statistics"
      described as {
        |CI/CD pipeline metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Pipeline.PipelineStarted is {
        prompt "Update build counts"
      }
      on event Pipeline.PipelineCompleted is {
        prompt "Update success metrics"
      }
      on event Pipeline.DeploymentApproved is {
        prompt "Update deployment counts"
      }
    } with {
      briefly "Maintains pipeline analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Pipeline analytics projections"
    described as {
      |Maintains CI/CD pipeline analytics data.
    }
  }
} with {
  briefly "Bounded context for CI/CD pipelines"
  described as {
    | The PipelineContext is the bounded context for
    | continuous integration and deployment automation.
  }
}
