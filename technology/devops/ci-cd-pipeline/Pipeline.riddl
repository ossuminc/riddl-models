// CI/CD Pipeline - Pipeline Entity

entity Pipeline is {

  // Commands
  command CreatePipeline is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "New pipeline identifier."
    }
    config is PipelineConfig with {
      briefly "Configuration"
      described by "Pipeline configuration."
    }
  } with {
    briefly "Create pipeline"
    described by "Creates a new pipeline."
  }

  command StartPipeline is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "New build identifier."
    }
    commit is CommitInfo with {
      briefly "Commit"
      described by "Triggering commit."
    }
    triggerType is TriggerType with {
      briefly "Trigger"
      described by "What triggered this run."
    }
  } with {
    briefly "Start pipeline"
    described by "Starts a pipeline execution."
  }

  command CompleteStage is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    stageResult is StageResult with {
      briefly "Result"
      described by "Stage execution result."
    }
  } with {
    briefly "Complete stage"
    described by "Records stage completion."
  }

  command StoreArtifact is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    artifact is BuildArtifact with {
      briefly "Artifact"
      described by "Build artifact."
    }
  } with {
    briefly "Store artifact"
    described by "Stores a build artifact."
  }

  command RequestApproval is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    target is DeploymentTarget with {
      briefly "Target"
      described by "Deployment target."
    }
  } with {
    briefly "Request approval"
    described by "Requests deployment approval."
  }

  command ApproveDeployment is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    approval is ApprovalInfo with {
      briefly "Approval"
      described by "Approval details."
    }
  } with {
    briefly "Approve deployment"
    described by "Approves a deployment."
  }

  command RejectDeployment is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
    rejectedBy is String(1, 200) with {
      briefly "Rejected by"
      described by "Person rejecting."
    }
  } with {
    briefly "Reject deployment"
    described by "Rejects a deployment."
  }

  command CancelPipeline is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel pipeline"
    described by "Cancels pipeline execution."
  }

  command CompletePipeline is {
    pipelineId is PipelineId with {
      briefly "Pipeline ID"
      described by "Pipeline identifier."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build identifier."
    }
    finalStatus is PipelineStatus with {
      briefly "Status"
      described by "Final pipeline status."
    }
  } with {
    briefly "Complete pipeline"
    described by "Marks pipeline as complete."
  }

  // Events
  event PipelineCreated is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    config is PipelineConfig with { briefly "Config" described by "Pipeline configuration." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Pipeline created"
    described by "Emitted when pipeline is created."
  }

  event PipelineStarted is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    commit is CommitInfo with { briefly "Commit" described by "Triggering commit." }
    triggerType is TriggerType with { briefly "Trigger" described by "Trigger type." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Pipeline started"
    described by "Emitted when pipeline execution begins."
  }

  event StageCompleted is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    stageResult is StageResult with { briefly "Result" described by "Stage result." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Stage completed"
    described by "Emitted when a stage finishes."
  }

  event ArtifactStored is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    artifact is BuildArtifact with { briefly "Artifact" described by "Stored artifact." }
    storedAt is TimeStamp with { briefly "Stored" described by "Storage time." }
  } with {
    briefly "Artifact stored"
    described by "Emitted when artifact is stored."
  }

  event ApprovalRequested is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    target is DeploymentTarget with { briefly "Target" described by "Deployment target." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Approval requested"
    described by "Emitted when approval is needed."
  }

  event DeploymentApproved is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    approval is ApprovalInfo with { briefly "Approval" described by "Approval details." }
  } with {
    briefly "Deployment approved"
    described by "Emitted when deployment is approved."
  }

  event DeploymentRejected is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedBy is String(1, 200) with { briefly "Rejected by" described by "Rejector." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Deployment rejected"
    described by "Emitted when deployment is rejected."
  }

  event PipelineCancelled is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Pipeline cancelled"
    described by "Emitted when pipeline is cancelled."
  }

  event PipelineCompleted is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    finalStatus is PipelineStatus with { briefly "Status" described by "Final status." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Pipeline completed"
    described by "Emitted when pipeline finishes."
  }

  // State Records
  record ActiveStateData is {
    pipelineId is PipelineId with { briefly "Pipeline" described by "Pipeline ID." }
    config is PipelineConfig with { briefly "Config" described by "Pipeline configuration." }
    currentBuildId is optional BuildId with { briefly "Current build" described by "Current build ID." }
    currentCommit is optional CommitInfo with { briefly "Commit" described by "Current commit." }
    stageResults is many optional StageResult with { briefly "Stage results" described by "Stage results." }
    artifacts is many optional BuildArtifact with { briefly "Artifacts" described by "Build artifacts." }
    status is PipelineStatus with { briefly "Status" described by "Pipeline status." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active pipeline."
  }

  // States
  state ActiveState of Pipeline.ActiveStateData with {
    briefly "Pipeline active"
    described by "Pipeline is configured and available."
  }

  // Handler
  handler PipelineHandler is {
    on command CreatePipeline {
      morph entity PipelineContext.Pipeline to state PipelineContext.Pipeline.ActiveState with command CreatePipeline
      tell event PipelineCreated to entity PipelineContext.Pipeline
    }

    on command StartPipeline {
      tell event PipelineStarted to entity PipelineContext.Pipeline
    }

    on command CompleteStage {
      tell event StageCompleted to entity PipelineContext.Pipeline
    }

    on command StoreArtifact {
      tell event ArtifactStored to entity PipelineContext.Pipeline
    }

    on command RequestApproval {
      tell event ApprovalRequested to entity PipelineContext.Pipeline
    }

    on command ApproveDeployment {
      tell event DeploymentApproved to entity PipelineContext.Pipeline
    }

    on command RejectDeployment {
      tell event DeploymentRejected to entity PipelineContext.Pipeline
    }

    on command CancelPipeline {
      tell event PipelineCancelled to entity PipelineContext.Pipeline
    }

    on command CompletePipeline {
      tell event PipelineCompleted to entity PipelineContext.Pipeline
    }
  } with {
    briefly "Processes pipeline commands"
    described by {
      | Handles pipeline lifecycle from creation
      | through execution, approval, and completion.
    }
  }

} with {
  briefly "Pipeline aggregate"
  described by {
    | The Pipeline entity manages CI/CD pipeline
    | configuration and execution lifecycle.
  }
}
