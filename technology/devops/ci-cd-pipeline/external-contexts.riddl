// CI/CD Pipeline - External Contexts

// Source Control Service
context SourceControlService is {

  command FetchRepository is {
    repository is String(1, 500) with { briefly "Repository" described by "Repository URL." }
    branch is String(1, 200) with { briefly "Branch" described by "Branch to fetch." }
    commitHash is String(40, 40) with { briefly "Commit" described by "Commit hash." }
  } with {
    briefly "Fetch repository"
    described by "Clones and fetches source code."
  }

  event RepositoryFetched is {
    repository is String(1, 500) with { briefly "Repository" described by "Repository URL." }
    commitHash is String(40, 40) with { briefly "Commit" described by "Fetched commit." }
    workspacePath is String(1, 500) with { briefly "Workspace" described by "Workspace path." }
    fetchedAt is TimeStamp with { briefly "Fetched" described by "Fetch time." }
  } with {
    briefly "Repository fetched"
    described by "Emitted when repository is ready."
  }

  command SetCommitStatus is {
    repository is String(1, 500) with { briefly "Repository" described by "Repository URL." }
    commitHash is String(40, 40) with { briefly "Commit" described by "Commit hash." }
    commitStatus is String(1, 20) with { briefly "Status" described by "Status value." }
    statusContext is String(1, 100) with { briefly "Context" described by "Status context." }
    targetUrl is optional URL with { briefly "URL" described by "Details URL." }
  } with {
    briefly "Set commit status"
    described by "Updates commit status in source control."
  }

  event CommitStatusSet is {
    repository is String(1, 500) with { briefly "Repository" described by "Repository URL." }
    commitHash is String(40, 40) with { briefly "Commit" described by "Commit hash." }
    commitStatus is String(1, 20) with { briefly "Status" described by "Status value." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Commit status set"
    described by "Emitted when status is updated."
  }

} with {
  option is external
  briefly "External source control"
  described by "External source control service (GitHub, GitLab)."
}

// Container Registry Service
context ContainerRegistryService is {

  command PushImage is {
    registry is String(1, 200) with { briefly "Registry" described by "Registry URL." }
    imageName is String(1, 200) with { briefly "Image" described by "Image name." }
    tag is String(1, 100) with { briefly "Tag" described by "Image tag." }
    digest is String(1, 100) with { briefly "Digest" described by "Image digest." }
  } with {
    briefly "Push image"
    described by "Pushes container image to registry."
  }

  event ImagePushed is {
    registry is String(1, 200) with { briefly "Registry" described by "Registry URL." }
    imageName is String(1, 200) with { briefly "Image" described by "Image name." }
    tag is String(1, 100) with { briefly "Tag" described by "Image tag." }
    digest is String(1, 100) with { briefly "Digest" described by "Image digest." }
    pushedAt is TimeStamp with { briefly "Pushed" described by "Push time." }
  } with {
    briefly "Image pushed"
    described by "Emitted when image is pushed."
  }

  command ScanImage is {
    imageName is String(1, 200) with { briefly "Image" described by "Image name." }
    tag is String(1, 100) with { briefly "Tag" described by "Image tag." }
  } with {
    briefly "Scan image"
    described by "Scans image for vulnerabilities."
  }

  event ImageScanned is {
    imageName is String(1, 200) with { briefly "Image" described by "Image name." }
    tag is String(1, 100) with { briefly "Tag" described by "Image tag." }
    criticalCount is Natural with { briefly "Critical" described by "Critical vulnerabilities." }
    highCount is Natural with { briefly "High" described by "High vulnerabilities." }
    scannedAt is TimeStamp with { briefly "Scanned" described by "Scan time." }
  } with {
    briefly "Image scanned"
    described by "Emitted when scan completes."
  }

} with {
  option is external
  briefly "External container registry"
  described by "External container registry service."
}

// Artifact Storage Service
context ArtifactStorageService is {

  command UploadArtifact is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    artifactName is String(1, 200) with { briefly "Name" described by "Artifact name." }
    content is String(1, 100000) with { briefly "Content" described by "Artifact content path." }
    checksum is String(64, 64) with { briefly "Checksum" described by "SHA-256 checksum." }
  } with {
    briefly "Upload artifact"
    described by "Uploads artifact to storage."
  }

  event ArtifactUploaded is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact ID." }
    url is URL with { briefly "URL" described by "Download URL." }
    uploadedAt is TimeStamp with { briefly "Uploaded" described by "Upload time." }
  } with {
    briefly "Artifact uploaded"
    described by "Emitted when artifact is uploaded."
  }

  query DownloadArtifact is {
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact ID." }
  } with {
    briefly "Download artifact"
    described by "Retrieves artifact download URL."
  }

  result ArtifactDownloadUrl is {
    artifactId is ArtifactId with { briefly "Artifact" described by "Artifact ID." }
    url is URL with { briefly "URL" described by "Download URL." }
    expiresAt is TimeStamp with { briefly "Expires" described by "URL expiration." }
  } with {
    briefly "Artifact download URL"
    described by "Presigned download URL."
  }

} with {
  option is external
  briefly "External artifact storage"
  described by "External artifact storage service."
}

// Deployment Orchestrator Service
context DeploymentOrchestratorService is {

  command DeployToEnvironment is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    imageName is String(1, 200) with { briefly "Image" described by "Container image." }
    tag is String(1, 100) with { briefly "Tag" described by "Image tag." }
    deploymentConfig is String(1, 5000) with { briefly "Config" described by "Deployment configuration." }
  } with {
    briefly "Deploy to environment"
    described by "Deploys to target environment."
  }

  event DeploymentStarted is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentId is UUID with { briefly "Deployment" described by "Deployment ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Deployment started"
    described by "Emitted when deployment begins."
  }

  event DeploymentSucceeded is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentId is UUID with { briefly "Deployment" described by "Deployment ID." }
    succeededAt is TimeStamp with { briefly "Succeeded" described by "Success time." }
  } with {
    briefly "Deployment succeeded"
    described by "Emitted when deployment succeeds."
  }

  event DeploymentFailed is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    deploymentId is UUID with { briefly "Deployment" described by "Deployment ID." }
    error is String(1, 1000) with { briefly "Error" described by "Error message." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Deployment failed"
    described by "Emitted when deployment fails."
  }

  command RollbackDeployment is {
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    targetVersion is String(1, 100) with { briefly "Target version" described by "Version to rollback to." }
  } with {
    briefly "Rollback deployment"
    described by "Rolls back to previous version."
  }

  event DeploymentRolledBack is {
    environmentId is EnvironmentId with { briefly "Environment" described by "Target environment." }
    targetVersion is String(1, 100) with { briefly "Target version" described by "Rolled back version." }
    rolledBackAt is TimeStamp with { briefly "Rolled back" described by "Rollback time." }
  } with {
    briefly "Deployment rolled back"
    described by "Emitted when rollback completes."
  }

} with {
  option is external
  briefly "External deployment orchestrator"
  described by "External deployment orchestration service (Kubernetes)."
}

// Notification Service
context NotificationService is {

  command SendBuildNotification is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    status is PipelineStatus with { briefly "Status" described by "Build status." }
    recipients is many String(5, 254) with { briefly "Recipients" described by "Notification recipients." }
    channel is String(1, 50) with { briefly "Channel" described by "Notification channel." }
  } with {
    briefly "Send build notification"
    described by "Sends build status notification."
  }

  event NotificationSent is {
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    channel is String(1, 50) with { briefly "Channel" described by "Notification channel." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Notification sent"
    described by "Emitted when notification is delivered."
  }

} with {
  option is external
  briefly "External notifications"
  described by "External notification service (Slack, email)."
}
