// CI/CD Pipeline - External Contexts
// Source Control Service
context SourceControlService is {
  command FetchRepository is  {
    repository: String(1,500) with {
      briefly "Repository"
      described as {
        |Repository URL.
      }
    }
    branch: String(1,200) with {
      briefly "Branch"
      described as {
        |Branch to fetch.
      }
    }
    commitHash: String(40,40) with {
      briefly "Commit"
      described as {
        |Commit hash.
      }
    }
  } with {
    briefly "Fetch repository"
    described as {
      |Clones and fetches source code.
    }
  }
  event RepositoryFetched is  {
    repository: String(1,500) with {
      briefly "Repository"
      described as {
        |Repository URL.
      }
    }
    commitHash: String(40,40) with {
      briefly "Commit"
      described as {
        |Fetched commit.
      }
    }
    workspacePath: String(1,500) with {
      briefly "Workspace"
      described as {
        |Workspace path.
      }
    }
    fetchedAt: TimeStamp with {
      briefly "Fetched"
      described as {
        |Fetch time.
      }
    }
  } with {
    briefly "Repository fetched"
    described as {
      |Emitted when repository is ready.
    }
  }
  command SetCommitStatus is  {
    repository: String(1,500) with {
      briefly "Repository"
      described as {
        |Repository URL.
      }
    }
    commitHash: String(40,40) with {
      briefly "Commit"
      described as {
        |Commit hash.
      }
    }
    commitStatus: String(1,20) with {
      briefly "Status"
      described as {
        |Status value.
      }
    }
    statusContext: String(1,100) with {
      briefly "Context"
      described as {
        |Status context.
      }
    }
    targetUrl: URL? with {
      briefly "URL"
      described as {
        |Details URL.
      }
    }
  } with {
    briefly "Set commit status"
    described as {
      |Updates commit status in source control.
    }
  }
  event CommitStatusSet is  {
    repository: String(1,500) with {
      briefly "Repository"
      described as {
        |Repository URL.
      }
    }
    commitHash: String(40,40) with {
      briefly "Commit"
      described as {
        |Commit hash.
      }
    }
    commitStatus: String(1,20) with {
      briefly "Status"
      described as {
        |Status value.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Commit status set"
    described as {
      |Emitted when status is updated.
    }
  }
} with {
  option external()
  briefly "External source control"
  described as {
    |External source control service (GitHub, GitLab).
  }
}
// Container Registry Service
context ContainerRegistryService is {
  command PushImage is  {
    registry: String(1,200) with {
      briefly "Registry"
      described as {
        |Registry URL.
      }
    }
    imageName: String(1,200) with {
      briefly "Image"
      described as {
        |Image name.
      }
    }
    tag: String(1,100) with {
      briefly "Tag"
      described as {
        |Image tag.
      }
    }
    digest: String(1,100) with {
      briefly "Digest"
      described as {
        |Image digest.
      }
    }
  } with {
    briefly "Push image"
    described as {
      |Pushes container image to registry.
    }
  }
  event ImagePushed is  {
    registry: String(1,200) with {
      briefly "Registry"
      described as {
        |Registry URL.
      }
    }
    imageName: String(1,200) with {
      briefly "Image"
      described as {
        |Image name.
      }
    }
    tag: String(1,100) with {
      briefly "Tag"
      described as {
        |Image tag.
      }
    }
    digest: String(1,100) with {
      briefly "Digest"
      described as {
        |Image digest.
      }
    }
    pushedAt: TimeStamp with {
      briefly "Pushed"
      described as {
        |Push time.
      }
    }
  } with {
    briefly "Image pushed"
    described as {
      |Emitted when image is pushed.
    }
  }
  command ScanImage is  {
    imageName: String(1,200) with {
      briefly "Image"
      described as {
        |Image name.
      }
    }
    tag: String(1,100) with {
      briefly "Tag"
      described as {
        |Image tag.
      }
    }
  } with {
    briefly "Scan image"
    described as {
      |Scans image for vulnerabilities.
    }
  }
  event ImageScanned is  {
    imageName: String(1,200) with {
      briefly "Image"
      described as {
        |Image name.
      }
    }
    tag: String(1,100) with {
      briefly "Tag"
      described as {
        |Image tag.
      }
    }
    criticalCount: Natural with {
      briefly "Critical"
      described as {
        |Critical vulnerabilities.
      }
    }
    highCount: Natural with {
      briefly "High"
      described as {
        |High vulnerabilities.
      }
    }
    scannedAt: TimeStamp with {
      briefly "Scanned"
      described as {
        |Scan time.
      }
    }
  } with {
    briefly "Image scanned"
    described as {
      |Emitted when scan completes.
    }
  }
} with {
  option external()
  briefly "External container registry"
  described as {
    |External container registry service.
  }
}
// Artifact Storage Service
context ArtifactStorageService is {
  command UploadArtifact is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    artifactName: String(1,200) with {
      briefly "Name"
      described as {
        |Artifact name.
      }
    }
    content: String(1,100000) with {
      briefly "Content"
      described as {
        |Artifact content path.
      }
    }
    checksum: String(64,64) with {
      briefly "Checksum"
      described as {
        |SHA-256 checksum.
      }
    }
  } with {
    briefly "Upload artifact"
    described as {
      |Uploads artifact to storage.
    }
  }
  event ArtifactUploaded is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    artifactId: ArtifactId with {
      briefly "Artifact"
      described as {
        |Artifact ID.
      }
    }
    url: URL with {
      briefly "URL"
      described as {
        |Download URL.
      }
    }
    uploadedAt: TimeStamp with {
      briefly "Uploaded"
      described as {
        |Upload time.
      }
    }
  } with {
    briefly "Artifact uploaded"
    described as {
      |Emitted when artifact is uploaded.
    }
  }
  query DownloadArtifact is  {
    artifactId: ArtifactId with {
      briefly "Artifact"
      described as {
        |Artifact ID.
      }
    }
  } with {
    briefly "Download artifact"
    described as {
      |Retrieves artifact download URL.
    }
  }
  result ArtifactDownloadUrl is  {
    artifactId: ArtifactId with {
      briefly "Artifact"
      described as {
        |Artifact ID.
      }
    }
    url: URL with {
      briefly "URL"
      described as {
        |Download URL.
      }
    }
    expiresAt: TimeStamp with {
      briefly "Expires"
      described as {
        |URL expiration.
      }
    }
  } with {
    briefly "Artifact download URL"
    described as {
      |Presigned download URL.
    }
  }
} with {
  option external()
  briefly "External artifact storage"
  described as {
    |External artifact storage service.
  }
}
// Deployment Orchestrator Service
context DeploymentOrchestratorService is {
  command DeployToEnvironment is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    imageName: String(1,200) with {
      briefly "Image"
      described as {
        |Container image.
      }
    }
    tag: String(1,100) with {
      briefly "Tag"
      described as {
        |Image tag.
      }
    }
    deploymentConfig: String(1,5000) with {
      briefly "Config"
      described as {
        |Deployment configuration.
      }
    }
  } with {
    briefly "Deploy to environment"
    described as {
      |Deploys to target environment.
    }
  }
  event DeploymentStarted is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    deploymentId: UUID with {
      briefly "Deployment"
      described as {
        |Deployment ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Deployment started"
    described as {
      |Emitted when deployment begins.
    }
  }
  event DeploymentSucceeded is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    deploymentId: UUID with {
      briefly "Deployment"
      described as {
        |Deployment ID.
      }
    }
    succeededAt: TimeStamp with {
      briefly "Succeeded"
      described as {
        |Success time.
      }
    }
  } with {
    briefly "Deployment succeeded"
    described as {
      |Emitted when deployment succeeds.
    }
  }
  event DeploymentFailed is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    deploymentId: UUID with {
      briefly "Deployment"
      described as {
        |Deployment ID.
      }
    }
    error: String(1,1000) with {
      briefly "Error"
      described as {
        |Error message.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Deployment failed"
    described as {
      |Emitted when deployment fails.
    }
  }
  command RollbackDeployment is  {
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    targetVersion: String(1,100) with {
      briefly "Target version"
      described as {
        |Version to rollback to.
      }
    }
  } with {
    briefly "Rollback deployment"
    described as {
      |Rolls back to previous version.
    }
  }
  event DeploymentRolledBack is  {
    environmentId: EnvironmentId with {
      briefly "Environment"
      described as {
        |Target environment.
      }
    }
    targetVersion: String(1,100) with {
      briefly "Target version"
      described as {
        |Rolled back version.
      }
    }
    rolledBackAt: TimeStamp with {
      briefly "Rolled back"
      described as {
        |Rollback time.
      }
    }
  } with {
    briefly "Deployment rolled back"
    described as {
      |Emitted when rollback completes.
    }
  }
} with {
  option external()
  briefly "External deployment orchestrator"
  described as {
    |External deployment orchestration service (Kubernetes).
  }
}
// Notification Service
context NotificationService is {
  command SendBuildNotification is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    status: PipelineStatus with {
      briefly "Status"
      described as {
        |Build status.
      }
    }
    recipients: String(5,254)+ with {
      briefly "Recipients"
      described as {
        |Notification recipients.
      }
    }
    channel: String(1,50) with {
      briefly "Channel"
      described as {
        |Notification channel.
      }
    }
  } with {
    briefly "Send build notification"
    described as {
      |Sends build status notification.
    }
  }
  event NotificationSent is  {
    buildId: BuildId with {
      briefly "Build"
      described as {
        |Build ID.
      }
    }
    channel: String(1,50) with {
      briefly "Channel"
      described as {
        |Notification channel.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Notification sent"
    described as {
      |Emitted when notification is delivered.
    }
  }
} with {
  option external()
  briefly "External notifications"
  described as {
    |External notification service (Slack, email).
  }
}
