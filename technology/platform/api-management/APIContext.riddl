// API Management - APIContext
// Bounded context containing core API management capabilities

context APIContext is {

  include "types.riddl"
  include "APIProduct.riddl"

  // Repository for API Products
  repository APIProductRepository is {
    type APIProductRecord is {
      apiId: APIId,
      name: String,
      status: APIStatus,
      currentVersion: VersionId?,
      subscriptionCount: Integer,
      createdAt: DateTime,
      updatedAt: DateTime
    } with {
      briefly "Stored API product record"
      described by "Persistent representation of an API product for querying."
    }

    command StoreAPIProduct is {
      record: APIProductRecord
    } with {
      briefly "Store an API product"
      described by "Persists or updates an API product record."
    }

    command DeleteAPIProduct is {
      apiId: APIId
    } with {
      briefly "Delete an API product"
      described by "Removes an API product record from storage."
    }

    result APIProductResult is {
      record: APIProductRecord?
    } with {
      briefly "API product query result"
      described by "Returns the requested API product or nothing if not found."
    }

    result APIProductListResult is {
      records: APIProductRecord*,
      totalCount: Integer
    } with {
      briefly "API product list result"
      described by "Returns a list of API products matching query criteria."
    }

    query GetAPIProductById is {
      apiId: APIId
    } with {
      briefly "Get API product by ID"
      described by "Retrieves a single API product by its identifier."
    }

    query ListAPIProducts is {
      status: APIStatus?,
      limit: Integer,
      offset: Integer
    } with {
      briefly "List API products"
      described by "Lists API products with optional status filter and pagination."
    }

    query SearchAPIProducts is {
      searchTerm: String,
      limit: Integer
    } with {
      briefly "Search API products"
      described by "Searches API products by name or description."
    }

    handler APIProductRepositoryHandler is {
      on command StoreAPIProduct { ??? }
      on command DeleteAPIProduct { ??? }
      on query GetAPIProductById { ??? }
      on query ListAPIProducts { ??? }
      on query SearchAPIProducts { ??? }
    } with {
      briefly "Repository command and query handler"
      described by "Processes storage operations and queries for API products."
    }

  } with {
    briefly "API Product persistence repository"
    described by "Provides storage and retrieval capabilities for API product
      aggregates with support for filtering, pagination, and search."
  }

  // Projector for API Usage Metrics
  projector APIUsageMetricsProjector is {
    record ProjectorState is {
      lastUpdated: DateTime
    } with {
      briefly "Projector internal state"
      described by "Tracks the internal state of the metrics projector."
    }

    type UsageMetricRecord is {
      apiId: APIId,
      versionId: VersionId,
      date: Date,
      hourOfDay: Integer,
      totalRequests: Integer,
      successfulRequests: Integer,
      failedRequests: Integer,
      totalLatencyMs: Integer,
      uniqueConsumers: Integer
    } with {
      briefly "Hourly usage metric record"
      described by "Aggregated usage metrics for an API version per hour."
    }

    type DailyUsageSummary is {
      apiId: APIId,
      date: Date,
      totalRequests: Integer,
      uniqueConsumers: Integer,
      averageLatencyMs: Integer,
      errorRate: Real,
      topEndpoints: String*
    } with {
      briefly "Daily usage summary"
      described by "Summarized daily metrics for dashboard display."
    }

    result UsageMetricsResult is {
      metrics: UsageMetricRecord*
    } with {
      briefly "Usage metrics query result"
      described by "Returns hourly usage metrics for the requested period."
    }

    result DailySummaryResult is {
      summaries: DailyUsageSummary*
    } with {
      briefly "Daily summary result"
      described by "Returns daily usage summaries for the requested period."
    }

    query GetHourlyMetrics is {
      apiId: APIId,
      startDate: Date,
      endDate: Date
    } with {
      briefly "Get hourly usage metrics"
      described by "Retrieves hourly usage metrics for an API over a date range."
    }

    query GetDailySummary is {
      apiId: APIId,
      startDate: Date,
      endDate: Date
    } with {
      briefly "Get daily usage summary"
      described by "Retrieves daily aggregated usage summaries."
    }

    query GetTopAPIs is {
      limit: Integer,
      periodDays: Integer
    } with {
      briefly "Get top APIs by usage"
      described by "Returns the most used APIs over the specified period."
    }

    handler MetricsProjectionHandler is {
      on event APIProduct.VersionPublished { ??? }
      on event APIProduct.SubscriptionCreated { ??? }
      on query GetHourlyMetrics { ??? }
      on query GetDailySummary { ??? }
      on query GetTopAPIs { ??? }
    } with {
      briefly "Metrics projection handler"
      described by "Processes events to build usage metrics and handles queries."
    }

  } with {
    briefly "API usage metrics projector"
    described by {
      | The APIUsageMetricsProjector maintains a read-optimized view of API
      | usage statistics. It processes events from the analytics service to
      | build aggregated views suitable for:
      |
      | - Real-time usage dashboards
      | - Historical trend analysis
      | - Top API leaderboards
      | - Consumer behavior insights
      |
      | Metrics are aggregated at hourly and daily granularity for efficient
      | querying across different time ranges.
    }
  }

} with {
  briefly "API Management bounded context"
  described by {
    | The APIContext is the core bounded context for API management operations.
    | It encapsulates all functionality related to:
    |
    | - API product lifecycle management
    | - Version publishing and deprecation
    | - Subscription and access control
    | - Rate limiting configuration
    | - Usage metrics and analytics
    |
    | This context integrates with external systems including the API Gateway
    | for traffic management, Developer Portal for consumer experience, and
    | Analytics Service for usage insights.
  }
}
