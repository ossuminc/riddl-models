// API Management - APIContext
// Bounded context containing core API management capabilities
context APIContext is {
  include "types.riddl"
  include "APIProduct.riddl"
  // Repository for API Products
  repository APIProductRepository is {
    type APIProductRecord is {
      apiId: APIId
      name: String
      status: APIStatus
      updatedCurrentVersion: VersionId?
      subscriptionCount: Integer
      createdAt: DateTime
      updatedAt: DateTime
    } with {
      briefly "Stored API product record"
      described as {
        |Persistent representation of an API product for querying.
      }
    }
    command StoreAPIProduct is  { record: APIProductRecord } with {
      briefly "Store an API product"
      described as {
        |Persists or updates an API product record.
      }
    }
    command DeleteAPIProduct is  { apiId: APIId } with {
      briefly "Delete an API product"
      described as {
        |Removes an API product record from storage.
      }
    }
    result APIProductResult is  { updatedRecord: APIProductRecord? } with {
      briefly "API product query result"
      described as {
        |Returns the requested API product or nothing if not found.
      }
    }
    result APIProductListResult is  {
      records: APIProductRecord*
      totalCount: Integer
    } with {
      briefly "API product list result"
      described as {
        |Returns a list of API products matching query criteria.
      }
    }
    query GetAPIProductById is  { apiId: APIId } with {
      briefly "Get API product by ID"
      described as {
        |Retrieves a single API product by its identifier.
      }
    }
    query ListAPIProducts is  {
      filterStatus: APIStatus?
      limit: Integer
      offset: Integer
    } with {
      briefly "List API products"
      described as {
        |Lists API products with optional status filter and pagination.
      }
    }
    query SearchAPIProducts is  {
      searchTerm: String
      limit: Integer
    } with {
      briefly "Search API products"
      described as {
        |Searches API products by name or description.
      }
    }
    query GetHourlyMetrics is  {
      apiId: APIId
      startDate: Date
      endDate: Date
    } with {
      briefly "Get hourly usage metrics"
      described as {
        |Retrieves hourly usage metrics for an API over a date range.
      }
    }
    query GetDailySummary is  {
      apiId: APIId
      startDate: Date
      endDate: Date
    } with {
      briefly "Get daily usage summary"
      described as {
        |Retrieves daily aggregated usage summaries.
      }
    }
    query GetTopAPIs is  {
      limit: Integer
      periodDays: Integer
    } with {
      briefly "Get top APIs by usage"
      described as {
        |Returns the most used APIs over the specified period.
      }
    }
    handler APIProductRepositoryHandler is {
      on command StoreAPIProduct is { ??? }
      on command DeleteAPIProduct is { ??? }
      on query GetAPIProductById is { ??? }
      on query ListAPIProducts is { ??? }
      on query SearchAPIProducts is { ??? }
      on query GetHourlyMetrics is { ??? }
      on query GetDailySummary is { ??? }
      on query GetTopAPIs is { ??? }
    } with {
      briefly "Repository command and query handler"
      described as {
        |Processes storage operations and queries for API products and metrics.
      }
    }
  } with {
    briefly "API Product persistence repository"
    described as {
      |Provides storage and retrieval capabilities for API product
      |      aggregates with support for filtering, pagination, and search.
    }
  }
  // Projector for API Usage Metrics
  projector APIUsageMetricsProjector is {
    record ProjectorState is  { lastUpdated: DateTime } with {
      briefly "Projector internal state"
      described as {
        |Tracks the internal state of the metrics projector.
      }
    }
    type UsageMetricRecord is {
      apiId: APIId
      versionId: VersionId
      date: Date
      hourOfDay: Integer
      totalRequests: Integer
      successfulRequests: Integer
      failedRequests: Integer
      totalLatencyMs: Integer
      uniqueConsumers: Integer
    } with {
      briefly "Hourly usage metric record"
      described as {
        |Aggregated usage metrics for an API version per hour.
      }
    }
    type DailyUsageSummary is {
      apiId: APIId
      date: Date
      totalRequests: Integer
      uniqueConsumers: Integer
      averageLatencyMs: Integer
      errorRate: Real
      topEndpoints: String*
    } with {
      briefly "Daily usage summary"
      described as {
        |Summarized daily metrics for dashboard display.
      }
    }
    handler MetricsProjectionHandler is {
      on event APIProduct.VersionPublished is { ??? }
      on event APIProduct.SubscriptionCreated is { ??? }
    } with {
      briefly "Metrics projection handler"
      described as {
        |Processes events to build usage metrics projections.
      }
    }
  } with {
    briefly "API usage metrics projector"
    described as {
      | The APIUsageMetricsProjector maintains a read-optimized view of API
      | usage statistics. It processes events from the analytics service to
      | build aggregated views suitable for:
      |
      | - Real-time usage dashboards
      | - Historical trend analysis
      | - Top API leaderboards
      | - Consumer behavior insights
      |
      | Metrics are aggregated at hourly and daily granularity for efficient
      | querying across different time ranges.
    }
  }
} with {
  briefly "API Management bounded context"
  described as {
    | The APIContext is the core bounded context for API management operations.
    | It encapsulates all functionality related to:
    |
    | - API product lifecycle management
    | - Version publishing and deprecation
    | - Subscription and access control
    | - Rate limiting configuration
    | - Usage metrics and analytics
    |
    | This context integrates with external systems including the API Gateway
    | for traffic management, Developer Portal for consumer experience, and
    | Analytics Service for usage insights.
  }
}
