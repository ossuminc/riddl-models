// Identity entity definition

entity Identity is {

  // Commands
  command CreateIdentity is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    initialCredential is String with { briefly "Credential" described by "Initial password." }
  } with {
    briefly "Create a new user identity"
    described by "Creates a new identity in pending status with the provided
      email, display name, and initial password credential."
  }

  command VerifyIdentity is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    verificationMethod is VerificationMethod with { briefly "Method" described by "Verification method." }
    verificationCode is String with { briefly "Code" described by "Verification code." }
  } with {
    briefly "Verify a pending identity"
    described by "Completes identity verification using the specified method
      and verification code, transitioning identity to active status."
  }

  command AddCredential is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    credentialType is CredentialType with { briefly "Type" described by "Credential type." }
    credentialValue is String with { briefly "Value" described by "Credential value." }
    updatedExpiresAt is optional DateTime with { briefly "Expires" described by "Expiration time." }
  } with {
    briefly "Add a new credential to an identity"
    described by "Adds an additional authentication credential to an existing
      active identity, such as an API key or certificate."
  }

  command Authenticate is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    credentialType is CredentialType with { briefly "Type" described by "Credential type." }
    credentialValue is String with { briefly "Value" described by "Credential value." }
    ipAddress is String with { briefly "IP" described by "Client IP address." }
    userAgent is String with { briefly "Agent" described by "User agent string." }
  } with {
    briefly "Authenticate with credentials"
    described by "Attempts to authenticate an identity using the provided
      credentials and client information."
  }

  command CreateSession is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    sessionId is SessionId with { briefly "Session" described by "Session identifier." }
    ipAddress is String with { briefly "IP" described by "Client IP address." }
    userAgent is String with { briefly "Agent" described by "User agent string." }
    expiresAt is DateTime with { briefly "Expires" described by "Session expiration." }
  } with {
    briefly "Create a new authentication session"
    described by "Creates a new active session for an authenticated identity
      with the specified expiration time."
  }

  command RevokeSession is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    sessionId is SessionId with { briefly "Session" described by "Session identifier." }
    reason is String with { briefly "Reason" described by "Revocation reason." }
  } with {
    briefly "Revoke an active session"
    described by "Immediately terminates an active session, requiring the
      user to re-authenticate."
  }

  command DeactivateIdentity is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    reason is String with { briefly "Reason" described by "Deactivation reason." }
    deactivatedBy is IdentityId with { briefly "By" described by "Deactivated by identity." }
  } with {
    briefly "Permanently deactivate an identity"
    described by "Permanently deactivates an identity, revoking all active
      sessions and preventing future authentication."
  }

  command SuspendIdentity is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    reason is String with { briefly "Reason" described by "Suspension reason." }
    suspendedBy is IdentityId with { briefly "By" described by "Suspended by identity." }
  } with {
    briefly "Temporarily suspend an identity"
    described by "Temporarily suspends an identity, revoking active sessions
      while allowing future reactivation."
  }

  command ReactivateIdentity is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    reactivatedBy is IdentityId with { briefly "By" described by "Reactivated by identity." }
  } with {
    briefly "Reactivate a suspended identity"
    described by "Reactivates a suspended identity, returning it to active
      status."
  }

  // Events
  event IdentityCreated is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    createdAt is DateTime with { briefly "Created" described by "Creation timestamp." }
  } with {
    briefly "Identity was created"
    described by "Indicates a new identity has been created in pending status."
  }

  event IdentityVerified is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    verificationMethod is VerificationMethod with { briefly "Method" described by "Verification method." }
    verifiedAt is DateTime with { briefly "Verified" described by "Verification timestamp." }
  } with {
    briefly "Identity was verified"
    described by "Indicates an identity has completed verification and is
      now active."
  }

  event CredentialAdded is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    credentialId is CredentialId with { briefly "Credential" described by "Credential identifier." }
    credentialType is CredentialType with { briefly "Type" described by "Credential type." }
    addedAt is DateTime with { briefly "Added" described by "Addition timestamp." }
  } with {
    briefly "Credential was added"
    described by "Indicates a new credential has been added to an identity."
  }

  event AuthenticationSucceeded is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    credentialType is CredentialType with { briefly "Type" described by "Credential type used." }
    sessionId is SessionId with { briefly "Session" described by "Created session." }
    authenticatedAt is DateTime with { briefly "Time" described by "Authentication timestamp." }
    ipAddress is String with { briefly "IP" described by "Client IP address." }
  } with {
    briefly "Authentication succeeded"
    described by "Indicates a successful authentication attempt."
  }

  event AuthenticationFailed is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    credentialType is CredentialType with { briefly "Type" described by "Credential type used." }
    failureReason is String with { briefly "Reason" described by "Failure reason." }
    attemptedAt is DateTime with { briefly "Time" described by "Attempt timestamp." }
    ipAddress is String with { briefly "IP" described by "Client IP address." }
  } with {
    briefly "Authentication failed"
    described by "Indicates a failed authentication attempt."
  }

  event SessionCreated is {
    sessionId is SessionId with { briefly "Session" described by "Session identifier." }
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    createdAt is DateTime with { briefly "Created" described by "Creation timestamp." }
    expiresAt is DateTime with { briefly "Expires" described by "Expiration timestamp." }
  } with {
    briefly "Session was created"
    described by "Indicates a new authentication session has been created."
  }

  event SessionRevoked is {
    sessionId is SessionId with { briefly "Session" described by "Session identifier." }
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    revokedAt is DateTime with { briefly "Revoked" described by "Revocation timestamp." }
    reason is String with { briefly "Reason" described by "Revocation reason." }
  } with {
    briefly "Session was revoked"
    described by "Indicates an authentication session has been terminated."
  }

  event IdentityDeactivated is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    deactivatedAt is DateTime with { briefly "Time" described by "Deactivation timestamp." }
    reason is String with { briefly "Reason" described by "Deactivation reason." }
    deactivatedBy is IdentityId with { briefly "By" described by "Deactivated by identity." }
  } with {
    briefly "Identity was deactivated"
    described by "Indicates an identity has been permanently deactivated."
  }

  event IdentitySuspended is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    suspendedAt is DateTime with { briefly "Time" described by "Suspension timestamp." }
    reason is String with { briefly "Reason" described by "Suspension reason." }
    suspendedBy is IdentityId with { briefly "By" described by "Suspended by identity." }
  } with {
    briefly "Identity was suspended"
    described by "Indicates an identity has been temporarily suspended."
  }

  event IdentityReactivated is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    reactivatedAt is DateTime with { briefly "Time" described by "Reactivation timestamp." }
    reactivatedBy is IdentityId with { briefly "By" described by "Reactivated by identity." }
  } with {
    briefly "Identity was reactivated"
    described by "Indicates a suspended identity has been reactivated."
  }

  // State Records
  record PendingStateData is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    credentials is many Credential with { briefly "Credentials" described by "User credentials." }
    createdAt is DateTime with { briefly "Created" described by "Creation timestamp." }
  } with {
    briefly "Pending state data"
    described by "State data for identity awaiting verification."
  }

  record ActiveStateData is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    status is IdentityStatus with { briefly "Status" described by "Current status." }
    credentials is many Credential with { briefly "Credentials" described by "User credentials." }
    activeSessions is many optional SessionInfo with { briefly "Sessions" described by "Active sessions." }
    grants is many optional AccessGrant with { briefly "Grants" described by "Access grants." }
    createdAt is DateTime with { briefly "Created" described by "Creation timestamp." }
    verifiedAt is DateTime with { briefly "Verified" described by "Verification timestamp." }
  } with {
    briefly "Active state data"
    described by "State data for verified active identity."
  }

  record SuspendedStateData is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    credentials is many Credential with { briefly "Credentials" described by "User credentials." }
    suspendedAt is DateTime with { briefly "Suspended" described by "Suspension timestamp." }
    suspendedBy is IdentityId with { briefly "By" described by "Suspended by identity." }
    suspensionReason is String with { briefly "Reason" described by "Suspension reason." }
  } with {
    briefly "Suspended state data"
    described by "State data for suspended identity."
  }

  record DeactivatedStateData is {
    identityId is IdentityId with { briefly "Identity" described by "Identity identifier." }
    email is EmailAddress with { briefly "Email" described by "User email address." }
    displayName is String with { briefly "Name" described by "User display name." }
    deactivatedAt is DateTime with { briefly "Time" described by "Deactivation timestamp." }
    deactivatedBy is IdentityId with { briefly "By" described by "Deactivated by identity." }
    deactivationReason is String with { briefly "Reason" described by "Deactivation reason." }
  } with {
    briefly "Deactivated state data"
    described by "State data for permanently deactivated identity."
  }

  // States
  state PendingState of Identity.PendingStateData with {
    briefly "Identity pending verification"
    described by "Initial state for a newly created identity awaiting verification."
  }

  state ActiveState of Identity.ActiveStateData with {
    briefly "Identity is active and can authenticate"
    described by "State for a verified identity that can authenticate and
      maintain active sessions."
  }

  state SuspendedState of Identity.SuspendedStateData with {
    briefly "Identity is temporarily suspended"
    described by "State for an identity that has been temporarily suspended
      and cannot authenticate until reactivated."
  }

  state DeactivatedState of Identity.DeactivatedStateData with {
    briefly "Identity is permanently deactivated"
    described by "Terminal state for an identity that has been permanently
      deactivated and cannot be restored."
  }

  // Handler
  handler IdentityHandler is {
    on command CreateIdentity {
      morph entity IdentityContext.Identity to state IdentityContext.Identity.PendingState with command CreateIdentity
      tell event IdentityCreated to entity IdentityContext.Identity
    }

    on command VerifyIdentity {
      morph entity IdentityContext.Identity to state IdentityContext.Identity.ActiveState with command VerifyIdentity
      tell event IdentityVerified to entity IdentityContext.Identity
    }

    on command Authenticate {
      tell event AuthenticationSucceeded to entity IdentityContext.Identity
    }

    on command CreateSession {
      tell event SessionCreated to entity IdentityContext.Identity
    }

    on command RevokeSession {
      tell event SessionRevoked to entity IdentityContext.Identity
    }

    on command SuspendIdentity {
      morph entity IdentityContext.Identity to state IdentityContext.Identity.SuspendedState with command SuspendIdentity
      tell event IdentitySuspended to entity IdentityContext.Identity
    }

    on command ReactivateIdentity {
      morph entity IdentityContext.Identity to state IdentityContext.Identity.ActiveState with command ReactivateIdentity
      tell event IdentityReactivated to entity IdentityContext.Identity
    }

    on command DeactivateIdentity {
      morph entity IdentityContext.Identity to state IdentityContext.Identity.DeactivatedState with command DeactivateIdentity
      tell event IdentityDeactivated to entity IdentityContext.Identity
    }
  } with {
    briefly "Primary command handler for Identity"
    described by "Handles all commands for the Identity entity, managing
      state transitions and emitting appropriate events."
  }

} with {
  briefly "User identity aggregate"
  described by {
    | The Identity entity is the aggregate root for user identity management.
    | It encapsulates all identity-related state including credentials,
    | sessions, and access grants. The entity follows an event-sourced
    | pattern where all state changes are recorded as events.
  }
}
