// Subscription Management - External Contexts
// Payment Gateway Service
context PaymentGatewayService is {
  command ChargePayment is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Charge amount.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Currency code.
      }
    }
    paymentMethodToken: String(1,100) with {
      briefly "Token"
      described as {
        |Payment token.
      }
    }
  } with {
    briefly "Charge payment"
    described as {
      |Charges customer payment method.
    }
  }
  event PaymentCharged is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    transactionId: String(1,50) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    chargedAt: TimeStamp with {
      briefly "Charged"
      described as {
        |Charge time.
      }
    }
  } with {
    briefly "Payment charged"
    described as {
      |Emitted when payment succeeds.
    }
  }
  event PaymentChargeFailed is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    errorCode: String(1,20) with {
      briefly "Error"
      described as {
        |Error code.
      }
    }
    errorMessage: String(1,200) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
  } with {
    briefly "Payment failed"
    described as {
      |Emitted when payment fails.
    }
  }
} with {
  option external()
  briefly "External payment gateway"
  described as {
    |External payment processing service.
  }
}
// Invoice Service
context InvoiceService is {
  command GenerateInvoice is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    periodStart: Date with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    periodEnd: Date with {
      briefly "End"
      described as {
        |Period end.
      }
    }
    lineItems: String(1,200)+ with {
      briefly "Items"
      described as {
        |Line items.
      }
    }
    amounts: Decimal(10,2)+ with {
      briefly "Amounts"
      described as {
        |Line amounts.
      }
    }
  } with {
    briefly "Generate invoice"
    described as {
      |Generates an invoice.
    }
  }
  event InvoiceGenerated is  {
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice ID.
      }
    }
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    invoiceTotalAmount: Decimal(10,2) with {
      briefly "Total"
      described as {
        |Total amount.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Invoice generated"
    described as {
      |Emitted when invoice is created.
    }
  }
} with {
  option external()
  briefly "External invoicing"
  described as {
    |External invoice generation service.
  }
}
// Provisioning Service
context ProvisioningService is {
  command ProvisionAccess is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    planId: PlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    features: String(1,100)+ with {
      briefly "Features"
      described as {
        |Enabled features.
      }
    }
  } with {
    briefly "Provision access"
    described as {
      |Provisions customer access.
    }
  }
  event AccessProvisioned is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    provisionedAt: TimeStamp with {
      briefly "Provisioned"
      described as {
        |Provisioning time.
      }
    }
  } with {
    briefly "Access provisioned"
    described as {
      |Emitted when access is granted.
    }
  }
  command RevokeAccess is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
  } with {
    briefly "Revoke access"
    described as {
      |Revokes customer access.
    }
  }
  event AccessRevoked is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    revokedAt: TimeStamp with {
      briefly "Revoked"
      described as {
        |Revocation time.
      }
    }
  } with {
    briefly "Access revoked"
    described as {
      |Emitted when access is revoked.
    }
  }
} with {
  option external()
  briefly "External provisioning"
  described as {
    |External account provisioning service.
  }
}
// Usage Metering Service
context UsageMeteringService is {
  query GetUsage is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    periodStart: Date with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    periodEnd: Date with {
      briefly "End"
      described as {
        |Period end.
      }
    }
  } with {
    briefly "Get usage"
    described as {
      |Retrieves usage data.
    }
  }
  result UsageData is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    usageItems: UsageInfo+ with {
      briefly "Usage"
      described as {
        |Usage items.
      }
    }
    usageTotalAmount: Decimal(12,2) with {
      briefly "Total"
      described as {
        |Total usage amount.
      }
    }
  } with {
    briefly "Usage data"
    described as {
      |Usage-based billing data.
    }
  }
} with {
  option external()
  briefly "External usage metering"
  described as {
    |External usage tracking service.
  }
}
// Notification Service
context NotificationService is {
  command SendSubscriptionNotification is  {
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    message: String(1,1000) with {
      briefly "Message"
      described as {
        |Message content.
      }
    }
  } with {
    briefly "Send notification"
    described as {
      |Sends subscription notification.
    }
  }
  event NotificationSent is  {
    notificationId: UUID with {
      briefly "Notification"
      described as {
        |Notification ID.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Notification sent"
    described as {
      |Emitted when notification is delivered.
    }
  }
} with {
  option external()
  briefly "External notifications"
  described as {
    |External notification system.
  }
}
