// Subscription Management - Subscription Entity

entity Subscription is {

  // Commands
  command CreateSubscription is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "New subscription identifier."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    plan is PlanInfo with {
      briefly "Plan"
      described by "Subscription plan."
    }
    paymentMethod is PaymentMethod with {
      briefly "Payment"
      described by "Payment method."
    }
    startDate is Date with {
      briefly "Start"
      described by "Subscription start date."
    }
  } with {
    briefly "Create subscription"
    described by "Creates a new subscription."
  }

  command StartTrial is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "New subscription identifier."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer information."
    }
    plan is PlanInfo with {
      briefly "Plan"
      described by "Trial plan."
    }
    trialEndDate is Date with {
      briefly "Trial end"
      described by "When trial ends."
    }
  } with {
    briefly "Start trial"
    described by "Starts a free trial."
  }

  command ConvertTrial is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    paymentMethod is PaymentMethod with {
      briefly "Payment"
      described by "Payment method."
    }
  } with {
    briefly "Convert trial"
    described by "Converts trial to paid."
  }

  command ChangePlan is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    newPlan is PlanInfo with {
      briefly "New plan"
      described by "New subscription plan."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "When change takes effect."
    }
  } with {
    briefly "Change plan"
    described by "Changes subscription plan."
  }

  command ApplyDiscount is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    discount is DiscountInfo with {
      briefly "Discount"
      described by "Discount to apply."
    }
  } with {
    briefly "Apply discount"
    described by "Applies a discount."
  }

  command RecordPayment is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    invoice is InvoiceInfo with {
      briefly "Invoice"
      described by "Paid invoice."
    }
  } with {
    briefly "Record payment"
    described by "Records a payment."
  }

  command RecordPaymentFailure is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    invoiceId is InvoiceId with {
      briefly "Invoice"
      described by "Failed invoice."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Failure reason."
    }
  } with {
    briefly "Record failure"
    described by "Records payment failure."
  }

  command SuspendSubscription is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Suspension reason."
    }
  } with {
    briefly "Suspend subscription"
    described by "Suspends the subscription."
  }

  command ReactivateSubscription is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
  } with {
    briefly "Reactivate subscription"
    described by "Reactivates suspended subscription."
  }

  command CancelSubscription is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    cancellation is CancellationInfo with {
      briefly "Cancellation"
      described by "Cancellation details."
    }
  } with {
    briefly "Cancel subscription"
    described by "Cancels the subscription."
  }

  command RenewSubscription is {
    subscriptionId is SubscriptionId with {
      briefly "Subscription ID"
      described by "Subscription identifier."
    }
    renewalDate is Date with {
      briefly "Renewal date"
      described by "New renewal date."
    }
  } with {
    briefly "Renew subscription"
    described by "Renews the subscription."
  }

  // Events
  event SubscriptionCreated is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    plan is PlanInfo with { briefly "Plan" described by "Plan info." }
    startDate is Date with { briefly "Start" described by "Start date." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Subscription created"
    described by "Emitted when subscription is created."
  }

  event TrialStarted is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    plan is PlanInfo with { briefly "Plan" described by "Trial plan." }
    trialEndDate is Date with { briefly "Trial end" described by "Trial end date." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Trial started"
    described by "Emitted when trial begins."
  }

  event TrialConverted is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    convertedAt is TimeStamp with { briefly "Converted" described by "Conversion time." }
  } with {
    briefly "Trial converted"
    described by "Emitted when trial converts to paid."
  }

  event PlanChanged is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    oldPlan is PlanInfo with { briefly "Old plan" described by "Previous plan." }
    newPlan is PlanInfo with { briefly "New plan" described by "New plan." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Plan changed"
    described by "Emitted when plan changes."
  }

  event DiscountApplied is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    discount is DiscountInfo with { briefly "Discount" described by "Applied discount." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Discount applied"
    described by "Emitted when discount is applied."
  }

  event PaymentReceived is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    invoice is InvoiceInfo with { briefly "Invoice" described by "Paid invoice." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Payment received"
    described by "Emitted when payment is received."
  }

  event PaymentFailed is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    invoiceId is InvoiceId with { briefly "Invoice" described by "Failed invoice." }
    reason is String(1, 200) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Payment failed"
    described by "Emitted when payment fails."
  }

  event SubscriptionSuspended is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Subscription suspended"
    described by "Emitted when subscription is suspended."
  }

  event SubscriptionReactivated is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Subscription reactivated"
    described by "Emitted when subscription is reactivated."
  }

  event SubscriptionCanceled is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    cancellation is CancellationInfo with { briefly "Cancellation" described by "Cancellation info." }
  } with {
    briefly "Subscription canceled"
    described by "Emitted when subscription is canceled."
  }

  event SubscriptionRenewed is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    renewalDate is Date with { briefly "Renewal" described by "New renewal date." }
    renewedAt is TimeStamp with { briefly "Renewed" described by "Renewal time." }
  } with {
    briefly "Subscription renewed"
    described by "Emitted when subscription renews."
  }

  // State Records
  record ActiveStateData is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    plan is PlanInfo with { briefly "Plan" described by "Current plan." }
    paymentMethod is PaymentMethod with { briefly "Payment" described by "Payment method." }
    billing is BillingInfo with { briefly "Billing" described by "Billing info." }
    discount is optional DiscountInfo with { briefly "Discount" described by "Active discount." }
    invoices is many optional InvoiceInfo with { briefly "Invoices" described by "Invoice history." }
    status is SubscriptionStatus with { briefly "Status" described by "Subscription status." }
    startDate is Date with { briefly "Start" described by "Start date." }
  } with {
    briefly "Active state"
    described by "State for active subscription."
  }

  record CanceledStateData is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    cancellation is CancellationInfo with { briefly "Cancellation" described by "Cancellation info." }
  } with {
    briefly "Canceled state"
    described by "State for canceled subscription."
  }

  // States
  state ActiveState of Subscription.ActiveStateData with {
    briefly "Subscription active"
    described by "Subscription is active."
  }

  state CanceledState of Subscription.CanceledStateData with {
    briefly "Subscription canceled"
    described by "Subscription has been canceled."
  }

  // Handler
  handler SubscriptionHandler is {
    on command CreateSubscription {
      morph entity SubscriptionContext.Subscription to state SubscriptionContext.Subscription.ActiveState with command CreateSubscription
      tell event SubscriptionCreated to entity SubscriptionContext.Subscription
    }

    on command StartTrial {
      morph entity SubscriptionContext.Subscription to state SubscriptionContext.Subscription.ActiveState with command StartTrial
      tell event TrialStarted to entity SubscriptionContext.Subscription
    }

    on command ConvertTrial {
      tell event TrialConverted to entity SubscriptionContext.Subscription
    }

    on command ChangePlan {
      tell event PlanChanged to entity SubscriptionContext.Subscription
    }

    on command ApplyDiscount {
      tell event DiscountApplied to entity SubscriptionContext.Subscription
    }

    on command RecordPayment {
      tell event PaymentReceived to entity SubscriptionContext.Subscription
    }

    on command RecordPaymentFailure {
      tell event PaymentFailed to entity SubscriptionContext.Subscription
    }

    on command SuspendSubscription {
      tell event SubscriptionSuspended to entity SubscriptionContext.Subscription
    }

    on command ReactivateSubscription {
      tell event SubscriptionReactivated to entity SubscriptionContext.Subscription
    }

    on command CancelSubscription {
      morph entity SubscriptionContext.Subscription to state SubscriptionContext.Subscription.CanceledState with command CancelSubscription
      tell event SubscriptionCanceled to entity SubscriptionContext.Subscription
    }

    on command RenewSubscription {
      tell event SubscriptionRenewed to entity SubscriptionContext.Subscription
    }
  } with {
    briefly "Processes subscription commands"
    described by {
      | Handles subscription lifecycle from creation
      | through billing, plan changes, and cancellation.
    }
  }

} with {
  briefly "Subscription aggregate"
  described by {
    | The Subscription entity manages SaaS subscriptions
    | including plans, billing, and lifecycle.
  }
}
