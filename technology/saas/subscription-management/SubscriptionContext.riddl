// Subscription Management - Subscription Context
context SubscriptionContext is {
  include "types.riddl"
  include "Subscription.riddl"
  // Repository for subscription persistence
  repository SubscriptionRepository is {
    schema SubscriptionData is relational
      of subscriptions as type Subscription
        index on field Subscription.subscriptionId
        index on field Subscription.customer.customerId

    handler SubscriptionPersistence is {
      on command Subscription.CreateSubscription is {
        prompt "Store new subscription"
      }
      on command Subscription.StartTrial is {
        prompt "Store trial subscription"
      }
      on command Subscription.ConvertTrial is {
        prompt "Update subscription to paid"
      }
      on command Subscription.ChangePlan is {
        prompt "Update subscription plan"
      }
      on command Subscription.ApplyDiscount is {
        prompt "Store discount"
      }
      on command Subscription.RecordPayment is {
        prompt "Store payment record"
      }
      on command Subscription.RecordPaymentFailure is {
        prompt "Store payment failure"
      }
      on command Subscription.SuspendSubscription is {
        prompt "Update subscription to suspended"
      }
      on command Subscription.ReactivateSubscription is {
        prompt "Update subscription to active"
      }
      on command Subscription.CancelSubscription is {
        prompt "Update subscription to canceled"
      }
      on command Subscription.RenewSubscription is {
        prompt "Update renewal date"
      }
    } with {
      briefly "Persists subscription commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Subscription data persistence"
    described as {
      | The SubscriptionRepository provides persistent storage for
      | subscriptions, billing, and payment history.
    }
  }
  // Projector for subscription analytics
  projector SubscriptionAnalytics is {
    record SubscriptionStats is  {
      totalSubscriptions: Natural with {
        briefly "Total"
        described as {
          |Total subscriptions.
        }
      }
      activeSubscriptions: Natural with {
        briefly "Active"
        described as {
          |Active subscriptions.
        }
      }
      mrr: Decimal(15,2) with {
        briefly "MRR"
        described as {
          |Monthly recurring revenue.
        }
      }
      arr: Decimal(18,2) with {
        briefly "ARR"
        described as {
          |Annual recurring revenue.
        }
      }
      churnRate: Decimal(5,4) with {
        briefly "Churn"
        described as {
          |Churn rate.
        }
      }
      trialConversionRate: Decimal(5,4) with {
        briefly "Conversion"
        described as {
          |Trial conversion rate.
        }
      }
    } with {
      briefly "Subscription statistics"
      described as {
        |SaaS subscription metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Subscription.SubscriptionCreated is {
        prompt "Update subscription counts"
      }
      on event Subscription.PaymentReceived is {
        prompt "Update revenue metrics"
      }
      on event Subscription.SubscriptionCanceled is {
        prompt "Update churn metrics"
      }
      on event Subscription.TrialConverted is {
        prompt "Update conversion metrics"
      }
    } with {
      briefly "Maintains subscription analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Subscription analytics projections"
    described as {
      |Maintains SaaS subscription analytics data.
    }
  }
} with {
  briefly "Bounded context for subscription management"
  described as {
    | The SubscriptionContext is the bounded context for
    | SaaS subscription billing and lifecycle management.
  }
}
