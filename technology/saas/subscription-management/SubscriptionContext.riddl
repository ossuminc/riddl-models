// Subscription Management - Subscription Context

context SubscriptionContext is {

  include "types.riddl"
  include "Subscription.riddl"

  // Repository for subscription persistence
  repository SubscriptionRepository is {
    schema SubscriptionData is relational
      of subscriptions as Subscription
      index on field Subscription.subscriptionId
      index on field Subscription.customer.customerId

    handler SubscriptionPersistence is {
      on command Subscription.CreateSubscription {
        prompt "Store new subscription"
      }
      on command Subscription.StartTrial {
        prompt "Store trial subscription"
      }
      on command Subscription.ConvertTrial {
        prompt "Update subscription to paid"
      }
      on command Subscription.ChangePlan {
        prompt "Update subscription plan"
      }
      on command Subscription.ApplyDiscount {
        prompt "Store discount"
      }
      on command Subscription.RecordPayment {
        prompt "Store payment record"
      }
      on command Subscription.RecordPaymentFailure {
        prompt "Store payment failure"
      }
      on command Subscription.SuspendSubscription {
        prompt "Update subscription to suspended"
      }
      on command Subscription.ReactivateSubscription {
        prompt "Update subscription to active"
      }
      on command Subscription.CancelSubscription {
        prompt "Update subscription to canceled"
      }
      on command Subscription.RenewSubscription {
        prompt "Update renewal date"
      }
    } with {
      briefly "Persists subscription commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Subscription data persistence"
    described by {
      | The SubscriptionRepository provides persistent storage for
      | subscriptions, billing, and payment history.
    }
  }

  // Projector for subscription analytics
  projector SubscriptionAnalytics is {
    updates repository SubscriptionRepository

    record SubscriptionStats is {
      totalSubscriptions is Natural with { briefly "Total" described by "Total subscriptions." }
      activeSubscriptions is Natural with { briefly "Active" described by "Active subscriptions." }
      mrr is Decimal(15, 2) with { briefly "MRR" described by "Monthly recurring revenue." }
      arr is Decimal(18, 2) with { briefly "ARR" described by "Annual recurring revenue." }
      churnRate is Decimal(5, 4) with { briefly "Churn" described by "Churn rate." }
      trialConversionRate is Decimal(5, 4) with { briefly "Conversion" described by "Trial conversion rate." }
    } with {
      briefly "Subscription statistics"
      described by "SaaS subscription metrics."
    }

    handler AnalyticsHandler is {
      on event Subscription.SubscriptionCreated {
        prompt "Update subscription counts"
      }
      on event Subscription.PaymentReceived {
        prompt "Update revenue metrics"
      }
      on event Subscription.SubscriptionCanceled {
        prompt "Update churn metrics"
      }
      on event Subscription.TrialConverted {
        prompt "Update conversion metrics"
      }
    } with {
      briefly "Maintains subscription analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Subscription analytics projections"
    described by "Maintains SaaS subscription analytics data."
  }

} with {
  briefly "Bounded context for subscription management"
  described by {
    | The SubscriptionContext is the bounded context for
    | SaaS subscription billing and lifecycle management.
  }
}
