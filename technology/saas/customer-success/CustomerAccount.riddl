// CustomerAccount Entity - Core aggregate for customer success management

entity CustomerAccount is {

  // Commands
  command OnboardCustomer is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Unique identifier for the new account."
    }
    companyName is String(1, 200) with {
      briefly "Company name"
      described by "Name of the customer company."
    }
    contractStartDate is Date with {
      briefly "Contract start"
      described by "When the contract begins."
    }
    contractEndDate is Date with {
      briefly "Contract end"
      described by "When the contract expires."
    }
    annualContractValue is Decimal(12, 2) with {
      briefly "ACV"
      described by "Annual contract value."
    }
    tier is String(1, 50) with {
      briefly "Tier"
      described by "Customer tier or segment."
    }
    primaryContactName is String(1, 100) with {
      briefly "Contact name"
      described by "Primary contact name."
    }
    primaryContactEmail is String(5, 254) with {
      briefly "Contact email"
      described by "Primary contact email."
    }
    assignedCsmId is String(1, 50) with {
      briefly "CSM ID"
      described by "Assigned customer success manager."
    }
  } with {
    briefly "Onboard customer"
    described by {
      | Creates a new customer account record and begins the onboarding
      | process. Triggered when a deal closes and customer is handed off
      | from sales to customer success.
    }
  }

  command UpdateHealthScore is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to update."
    }
    overallScore is Integer with {
      briefly "Overall score"
      described by "Combined health score 0-100."
    }
    productAdoptionScore is Integer with {
      briefly "Adoption score"
      described by "Product adoption score 0-100."
    }
    engagementScore is Integer with {
      briefly "Engagement score"
      described by "Customer engagement score 0-100."
    }
    supportHealthScore is Integer with {
      briefly "Support score"
      described by "Support health score 0-100."
    }
    financialHealthScore is Integer with {
      briefly "Financial score"
      described by "Financial health score 0-100."
    }
    factors is many String(1, 200) with {
      briefly "Factors"
      described by "Contributing factors."
    }
  } with {
    briefly "Update health score"
    described by {
      | Records a new health score calculation for the customer.
      | Health scores are typically recalculated daily or weekly
      | based on product usage, engagement, and support metrics.
    }
  }

  command RecordTouchpoint is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account for touchpoint."
    }
    touchpointType is String(1, 50) with {
      briefly "Type"
      described by "Type of touchpoint."
    }
    summary is String(1, 1000) with {
      briefly "Summary"
      described by "Touchpoint summary."
    }
    sentiment is String(1, 20) with {
      briefly "Sentiment"
      described by "Detected sentiment."
    }
    conductedBy is String(1, 100) with {
      briefly "Conducted by"
      described by "Who conducted the touchpoint."
    }
    followUpRequired is Boolean with {
      briefly "Follow-up required"
      described by "Whether follow-up is needed."
    }
    followUpDate is optional Date with {
      briefly "Follow-up date"
      described by "When follow-up should occur."
    }
    notes is optional String(1, 2000) with {
      briefly "Notes"
      described by "Additional notes."
    }
  } with {
    briefly "Record touchpoint"
    described by {
      | Logs any interaction with the customer including calls, emails,
      | meetings, or QBRs. Touchpoint tracking is essential for
      | maintaining relationship continuity and identifying trends.
    }
  }

  command FlagAtRisk is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to flag."
    }
    riskLevel is String(1, 20) with {
      briefly "Risk level"
      described by "Risk classification."
    }
    riskScore is Integer with {
      briefly "Risk score"
      described by "Numerical risk score."
    }
    primaryRiskFactors is many String(1, 200) with {
      briefly "Risk factors"
      described by "Contributing risk factors."
    }
    mitigationPlan is optional String(1, 2000) with {
      briefly "Mitigation plan"
      described by "Plan to address risk."
    }
    estimatedChurnDate is optional Date with {
      briefly "Estimated churn date"
      described by "When churn is expected."
    }
    revenueAtRisk is Decimal(12, 2) with {
      briefly "Revenue at risk"
      described by "ARR at risk of loss."
    }
  } with {
    briefly "Flag at-risk"
    described by {
      | Marks an account as at-risk and documents the risk assessment.
      | This triggers escalation workflows and prioritizes the account
      | for CSM attention and executive involvement if needed.
    }
  }

  command InitiateRenewal is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account for renewal."
    }
    renewalDate is Date with {
      briefly "Renewal date"
      described by "Target renewal date."
    }
    proposedValue is Decimal(12, 2) with {
      briefly "Proposed value"
      described by "Proposed renewal value."
    }
    expansionOpportunities is many String(1, 200) with {
      briefly "Expansion opportunities"
      described by "Identified upsell opportunities."
    }
    renewalOwner is String(1, 100) with {
      briefly "Renewal owner"
      described by "Person driving renewal."
    }
  } with {
    briefly "Initiate renewal"
    described by {
      | Starts the formal renewal workflow, typically 90 days before
      | contract expiration. Identifies expansion opportunities and
      | assigns ownership for driving the renewal to completion.
    }
  }

  command RecordChurn is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Churned account."
    }
    churnDate is Date with {
      briefly "Churn date"
      described by "When churn occurred."
    }
    churnReason is String(1, 500) with {
      briefly "Churn reason"
      described by "Why customer churned."
    }
    lostRevenue is Decimal(12, 2) with {
      briefly "Lost revenue"
      described by "ARR lost to churn."
    }
    feedbackNotes is optional String(1, 2000) with {
      briefly "Feedback notes"
      described by "Customer feedback on exit."
    }
    winBackEligible is Boolean with {
      briefly "Win-back eligible"
      described by "Whether win-back is possible."
    }
  } with {
    briefly "Record churn"
    described by {
      | Documents customer churn including the reason and lost revenue.
      | This data is crucial for churn analysis and identifying
      | patterns that can inform retention strategies.
    }
  }

  // Events
  event CustomerOnboarded is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    companyName is String(1, 200) with { briefly "Company" described by "Company name." }
    contractStartDate is Date with { briefly "Start" described by "Contract start." }
    contractEndDate is Date with { briefly "End" described by "Contract end." }
    annualContractValue is Decimal(12, 2) with { briefly "ACV" described by "Annual value." }
    tier is String(1, 50) with { briefly "Tier" described by "Customer tier." }
    assignedCsmId is String(1, 50) with { briefly "CSM" described by "Assigned CSM." }
    onboardedAt is TimeStamp with { briefly "Onboarded" described by "Onboarding time." }
  } with {
    briefly "Customer onboarded"
    described by "Emitted when a customer account is created and onboarding begins."
  }

  event HealthScoreUpdated is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    previousScore is optional Integer with { briefly "Previous" described by "Previous score." }
    newScore is Integer with { briefly "New" described by "New score." }
    healthStatus is HealthStatus with { briefly "Status" described by "Health status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Health score updated"
    described by "Emitted when a health score calculation completes with new values."
  }

  event TouchpointRecorded is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    touchpointId is TouchpointId with { briefly "Touchpoint" described by "Touchpoint ID." }
    touchpointType is String(1, 50) with { briefly "Type" described by "Touchpoint type." }
    sentiment is String(1, 20) with { briefly "Sentiment" described by "Detected sentiment." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Touchpoint recorded"
    described by "Emitted when any customer interaction is logged in the system."
  }

  event AccountFlaggedAtRisk is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    riskLevel is String(1, 20) with { briefly "Level" described by "Risk level." }
    riskScore is Integer with { briefly "Score" described by "Risk score." }
    revenueAtRisk is Decimal(12, 2) with { briefly "Revenue" described by "ARR at risk." }
    flaggedAt is TimeStamp with { briefly "Flagged" described by "Flag time." }
  } with {
    briefly "Account flagged at-risk"
    described by "Emitted when an account transitions to at-risk status requiring intervention."
  }

  event RenewalInitiated is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    renewalDate is Date with { briefly "Renewal" described by "Renewal date." }
    proposedValue is Decimal(12, 2) with { briefly "Value" described by "Proposed value." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Renewal initiated"
    described by "Emitted when the renewal workflow begins for an upcoming contract expiration."
  }

  event CustomerChurned is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    churnDate is Date with { briefly "Churn date" described by "When churn occurred." }
    churnReason is String(1, 500) with { briefly "Reason" described by "Churn reason." }
    lostRevenue is Decimal(12, 2) with { briefly "Lost" described by "Lost revenue." }
    churnedAt is TimeStamp with { briefly "Churned" described by "Churn event time." }
  } with {
    briefly "Customer churned"
    described by "Emitted when a customer cancels or fails to renew their contract."
  }

  // State Records
  record ActiveStateData is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    companyName is String(1, 200) with { briefly "Company" described by "Company name." }
    contractStartDate is Date with { briefly "Start" described by "Contract start." }
    contractEndDate is Date with { briefly "End" described by "Contract end." }
    annualContractValue is Decimal(12, 2) with { briefly "ACV" described by "Annual value." }
    tier is String(1, 50) with { briefly "Tier" described by "Customer tier." }
    primaryContactName is String(1, 100) with { briefly "Contact" described by "Contact name." }
    primaryContactEmail is String(5, 254) with { briefly "Email" described by "Contact email." }
    assignedCsmId is String(1, 50) with { briefly "CSM" described by "Assigned CSM." }
    currentHealthScore is optional Integer with { briefly "Score" described by "Current score." }
    healthStatus is HealthStatus with { briefly "Status" described by "Health status." }
    lastTouchpointDate is optional Date with { briefly "Touchpoint" described by "Last touchpoint." }
    onboardingCompletedDate is optional Date with { briefly "Onboarded" described by "Onboarding date." }
    churnRisk is optional ChurnRisk with { briefly "Risk" described by "Churn risk data." }
    touchpointHistory is many optional TouchpointRecord with { briefly "History" described by "Touchpoint history." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State data for active customer accounts."
  }

  // States
  state NewAccountState of CustomerAccount.ActiveStateData with {
    briefly "New account"
    described by "Initial state for a newly created account."
  }

  state OnboardingState of CustomerAccount.ActiveStateData with {
    briefly "Onboarding"
    described by "Customer is actively being onboarded."
  }

  state ActiveState of CustomerAccount.ActiveStateData with {
    briefly "Active"
    described by "Customer is active and in good standing."
  }

  state AtRiskState of CustomerAccount.ActiveStateData with {
    briefly "At-risk"
    described by "Customer is at risk of churning."
  }

  state RenewalState of CustomerAccount.ActiveStateData with {
    briefly "Renewal"
    described by "Customer is in active renewal process."
  }

  state ChurnedState of CustomerAccount.ActiveStateData with {
    briefly "Churned"
    described by "Customer has churned."
  }

  // Handler
  handler CustomerAccountHandler is {
    on command OnboardCustomer {
      morph entity CustomerSuccessContext.CustomerAccount to state CustomerSuccessContext.CustomerAccount.OnboardingState with command OnboardCustomer
      tell event CustomerOnboarded to entity CustomerSuccessContext.CustomerAccount
    }

    on command UpdateHealthScore {
      tell event HealthScoreUpdated to entity CustomerSuccessContext.CustomerAccount
    }

    on command RecordTouchpoint {
      tell event TouchpointRecorded to entity CustomerSuccessContext.CustomerAccount
    }

    on command FlagAtRisk {
      morph entity CustomerSuccessContext.CustomerAccount to state CustomerSuccessContext.CustomerAccount.AtRiskState with command FlagAtRisk
      tell event AccountFlaggedAtRisk to entity CustomerSuccessContext.CustomerAccount
    }

    on command InitiateRenewal {
      morph entity CustomerSuccessContext.CustomerAccount to state CustomerSuccessContext.CustomerAccount.RenewalState with command InitiateRenewal
      tell event RenewalInitiated to entity CustomerSuccessContext.CustomerAccount
    }

    on command RecordChurn {
      morph entity CustomerSuccessContext.CustomerAccount to state CustomerSuccessContext.CustomerAccount.ChurnedState with command RecordChurn
      tell event CustomerChurned to entity CustomerSuccessContext.CustomerAccount
    }
  } with {
    briefly "Processes account commands"
    described by {
      | Handles customer account lifecycle from onboarding through
      | renewal or churn, maintaining health scores, touchpoint
      | history, and risk assessments.
    }
  }

} with {
  briefly "Customer account aggregate"
  described by {
    | The CustomerAccount entity is the central aggregate in the Customer
    | Success domain. It tracks the complete lifecycle of a customer from
    | initial onboarding through renewal or churn, maintaining health scores,
    | touchpoint history, and risk assessments.
  }
}
