// Usage Metering - Meter Context

context MeterContext is {

  include "types.riddl"
  include "Meter.riddl"

  // Repository
  repository MeterRepository is {

    query FindMeterById is {
      meterId is MeterId with {
        briefly "Meter"
        described by "Meter identifier."
      }
    } with {
      briefly "Find meter by ID"
      described by "Retrieves meter by identifier."
    }

    result MeterResult is {
      meter is Meter.ActiveStateData with {
        briefly "Meter"
        described by "Meter data."
      }
    } with {
      briefly "Meter result"
      described by "Returns meter data."
    }

    query FindByCustomer is {
      customerId is CustomerId with {
        briefly "Customer"
        described by "Customer identifier."
      }
    } with {
      briefly "Find by customer"
      described by "Finds meters for customer."
    }

    result MetersResult is {
      meters is many Meter.ActiveStateData with {
        briefly "Meters"
        described by "Matching meters."
      }
      totalCount is Natural with {
        briefly "Count"
        described by "Total matches."
      }
    } with {
      briefly "Meters result"
      described by "Returns matching meters."
    }

    query FindBySubscription is {
      subscriptionId is SubscriptionId with {
        briefly "Subscription"
        described by "Subscription identifier."
      }
    } with {
      briefly "Find by subscription"
      described by "Finds meters for subscription."
    }

    query GetCurrentUsage is {
      meterId is MeterId with {
        briefly "Meter"
        described by "Meter identifier."
      }
    } with {
      briefly "Get current usage"
      described by "Gets current period usage."
    }

    query GetUsageHistory is {
      meterId is MeterId with {
        briefly "Meter"
        described by "Meter identifier."
      }
      periods is Natural with {
        briefly "Periods"
        described by "Number of periods."
      }
    } with {
      briefly "Get usage history"
      described by "Gets historical usage."
    }

    handler MeterRepositoryHandler is {
      on query FindMeterById {
        ???
      }
      on query FindByCustomer {
        ???
      }
      on query FindBySubscription {
        ???
      }
      on query GetCurrentUsage {
        ???
      }
      on query GetUsageHistory {
        ???
      }
    } with {
      briefly "Handles repository queries"
      described by "Processes meter queries."
    }

  } with {
    briefly "Meter repository"
    described by "Persistence for meter records."
  }

  // Projector for usage analytics
  projector UsageAnalytics is {

    record AnalyticsData is {
      totalEvents is Natural with {
        briefly "Events"
        described by "Total events recorded."
      }
      totalCustomers is Natural with {
        briefly "Customers"
        described by "Total metered customers."
      }
      usageByMetric is many MetricUsage with {
        briefly "By metric"
        described by "Usage by metric type."
      }
      topCustomers is many CustomerUsage with {
        briefly "Top customers"
        described by "Highest usage customers."
      }
      alertsTriggered is Natural with {
        briefly "Alerts"
        described by "Alerts triggered today."
      }
    } with {
      briefly "Analytics data"
      described by "Usage analytics."
    }

    record MetricUsage is {
      metricType is MetricType with {
        briefly "Metric"
        described by "Metric type."
      }
      aggregatedTotalQuantity is Decimal(18, 4) with {
        briefly "Total"
        described by "Total usage."
      }
      eventCount is Natural with {
        briefly "Events"
        described by "Event count."
      }
    } with {
      briefly "Metric usage"
      described by "Usage for metric type."
    }

    record CustomerUsage is {
      customerId is CustomerId with {
        briefly "Customer"
        described by "Customer ID."
      }
      totalUsage is Decimal(14, 4) with {
        briefly "Usage"
        described by "Total usage."
      }
      totalAmount is Decimal(12, 2) with {
        briefly "Amount"
        described by "Billable amount."
      }
    } with {
      briefly "Customer usage"
      described by "Usage for customer."
    }

    handler AnalyticsHandler is {
      on event Meter.UsageEventRecorded {
        ???
      }
      on event Meter.UsageAggregated {
        ???
      }
      on event Meter.UsageAlertTriggered {
        ???
      }
      on event Meter.BillingRecordGenerated {
        ???
      }
    } with {
      briefly "Processes analytics events"
      described by "Updates usage analytics."
    }

  } with {
    briefly "Usage analytics"
    described by "Projects usage metrics for reporting."
  }

} with {
  briefly "Meter context"
  described by {
    | The Meter context manages usage metering
    | for SaaS applications.
  }
}
