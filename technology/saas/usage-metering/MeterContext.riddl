// Usage Metering - Meter Context
context MeterContext is {
  include "types.riddl"
  include "Meter.riddl"
  // Repository
  repository MeterRepository is {
    query FindMeterById is  {
      meterId: MeterId with {
        briefly "Meter"
        described as {
          |Meter identifier.
        }
      }
    } with {
      briefly "Find meter by ID"
      described as {
        |Retrieves meter by identifier.
      }
    }
    result MeterResult is  {
      meter: Meter.ActiveStateData with {
        briefly "Meter"
        described as {
          |Meter data.
        }
      }
    } with {
      briefly "Meter result"
      described as {
        |Returns meter data.
      }
    }
    query FindByCustomer is  {
      customerId: CustomerId with {
        briefly "Customer"
        described as {
          |Customer identifier.
        }
      }
    } with {
      briefly "Find by customer"
      described as {
        |Finds meters for customer.
      }
    }
    result MetersResult is  {
      meters: Meter.ActiveStateData+ with {
        briefly "Meters"
        described as {
          |Matching meters.
        }
      }
      totalCount: Natural with {
        briefly "Count"
        described as {
          |Total matches.
        }
      }
    } with {
      briefly "Meters result"
      described as {
        |Returns matching meters.
      }
    }
    query FindBySubscription is  {
      subscriptionId: SubscriptionId with {
        briefly "Subscription"
        described as {
          |Subscription identifier.
        }
      }
    } with {
      briefly "Find by subscription"
      described as {
        |Finds meters for subscription.
      }
    }
    query GetCurrentUsage is  {
      meterId: MeterId with {
        briefly "Meter"
        described as {
          |Meter identifier.
        }
      }
    } with {
      briefly "Get current usage"
      described as {
        |Gets current period usage.
      }
    }
    query GetUsageHistory is  {
      meterId: MeterId with {
        briefly "Meter"
        described as {
          |Meter identifier.
        }
      }
      periods: Natural with {
        briefly "Periods"
        described as {
          |Number of periods.
        }
      }
    } with {
      briefly "Get usage history"
      described as {
        |Gets historical usage.
      }
    }
    handler MeterRepositoryHandler is {
      on query FindMeterById is { ??? }
      on query FindByCustomer is { ??? }
      on query FindBySubscription is { ??? }
      on query GetCurrentUsage is { ??? }
      on query GetUsageHistory is { ??? }
    } with {
      briefly "Handles repository queries"
      described as {
        |Processes meter queries.
      }
    }
  } with {
    briefly "Meter repository"
    described as {
      |Persistence for meter records.
    }
  }
  // Projector for usage analytics
  projector UsageAnalytics is {
    record AnalyticsData is  {
      totalEvents: Natural with {
        briefly "Events"
        described as {
          |Total events recorded.
        }
      }
      totalCustomers: Natural with {
        briefly "Customers"
        described as {
          |Total metered customers.
        }
      }
      usageByMetric: MetricUsage+ with {
        briefly "By metric"
        described as {
          |Usage by metric type.
        }
      }
      topCustomers: CustomerUsage+ with {
        briefly "Top customers"
        described as {
          |Highest usage customers.
        }
      }
      alertsTriggered: Natural with {
        briefly "Alerts"
        described as {
          |Alerts triggered today.
        }
      }
    } with {
      briefly "Analytics data"
      described as {
        |Usage analytics.
      }
    }
    record MetricUsage is  {
      metricType: MetricType with {
        briefly "Metric"
        described as {
          |Metric type.
        }
      }
      aggregatedTotalQuantity: Decimal(18,4) with {
        briefly "Total"
        described as {
          |Total usage.
        }
      }
      eventCount: Natural with {
        briefly "Events"
        described as {
          |Event count.
        }
      }
    } with {
      briefly "Metric usage"
      described as {
        |Usage for metric type.
      }
    }
    record CustomerUsage is  {
      customerId: CustomerId with {
        briefly "Customer"
        described as {
          |Customer ID.
        }
      }
      totalUsage: Decimal(14,4) with {
        briefly "Usage"
        described as {
          |Total usage.
        }
      }
      totalAmount: Decimal(12,2) with {
        briefly "Amount"
        described as {
          |Billable amount.
        }
      }
    } with {
      briefly "Customer usage"
      described as {
        |Usage for customer.
      }
    }
    handler AnalyticsHandler is {
      on event Meter.UsageEventRecorded is { ??? }
      on event Meter.UsageAggregated is { ??? }
      on event Meter.UsageAlertTriggered is { ??? }
      on event Meter.BillingRecordGenerated is { ??? }
    } with {
      briefly "Processes analytics events"
      described as {
        |Updates usage analytics.
      }
    }
  } with {
    briefly "Usage analytics"
    described as {
      |Projects usage metrics for reporting.
    }
  }
} with {
  briefly "Meter context"
  described as {
    | The Meter context manages usage metering
    | for SaaS applications.
  }
}
