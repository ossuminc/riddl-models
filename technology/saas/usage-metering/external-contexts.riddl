// Usage Metering - External Contexts

// Billing Service
context BillingService is {

  command CreateInvoice is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    billingRecord is BillingRecord with { briefly "Record" described by "Billing record." }
  } with {
    briefly "Create invoice"
    described by "Creates invoice from usage."
  }

  event InvoiceCreated is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    invoiceId is UUID with { briefly "Invoice" described by "Invoice ID." }
    amount is Decimal(12, 2) with { briefly "Amount" described by "Invoice amount." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Invoice created"
    described by "Emitted when invoice is created."
  }

  query GetInvoiceStatus is {
    invoiceId is UUID with { briefly "Invoice" described by "Invoice ID." }
  } with {
    briefly "Get invoice status"
    described by "Gets invoice payment status."
  }

  result InvoiceStatusResult is {
    invoiceId is UUID with { briefly "Invoice" described by "Invoice ID." }
    status is String(1, 50) with { briefly "Status" described by "Payment status." }
    paidAt is optional TimeStamp with { briefly "Paid" described by "Payment time." }
  } with {
    briefly "Invoice status result"
    described by "Invoice status."
  }

} with {
  option is external
  briefly "External billing service"
  described by "Invoice and payment service."
}

// Subscription Service
context SubscriptionService is {

  query GetSubscriptionDetails is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
  } with {
    briefly "Get subscription details"
    described by "Gets subscription information."
  }

  result SubscriptionDetailsResult is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    planId is String(1, 50) with { briefly "Plan" described by "Plan ID." }
    status is String(1, 50) with { briefly "Status" described by "Subscription status." }
    billingPeriodStart is Date with { briefly "Start" described by "Billing period start." }
    billingPeriodEnd is Date with { briefly "End" described by "Billing period end." }
  } with {
    briefly "Subscription details result"
    described by "Subscription information."
  }

  event SubscriptionChanged is {
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    changeType is String(1, 50) with { briefly "Type" described by "Change type." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Subscription changed"
    described by "Emitted when subscription changes."
  }

} with {
  option is external
  briefly "External subscription service"
  described by "Subscription management."
}

// Notification Service
context NotificationService is {

  command SendUsageAlert is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    alert is UsageAlert with { briefly "Alert" described by "Usage alert." }
    recipients is many String(5, 254) with { briefly "Recipients" described by "Email recipients." }
  } with {
    briefly "Send usage alert"
    described by "Sends threshold alert."
  }

  event AlertSent is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    alertType is String(1, 50) with { briefly "Type" described by "Alert type." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Alert sent"
    described by "Emitted when alert is sent."
  }

  command SendUsageSummary is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    periodStart is Date with { briefly "Start" described by "Period start." }
    periodEnd is Date with { briefly "End" described by "Period end." }
    summaryUrl is String(1, 500) with { briefly "URL" described by "Summary URL." }
  } with {
    briefly "Send usage summary"
    described by "Sends periodic usage summary."
  }

  event SummarySent is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Summary sent"
    described by "Emitted when summary is sent."
  }

} with {
  option is external
  briefly "External notification service"
  described by "Alert and notification service."
}

// Event Ingestion Service
context EventIngestionService is {

  event RawUsageReceived is {
    source is String(1, 100) with { briefly "Source" described by "Event source." }
    eventType is String(1, 100) with { briefly "Type" described by "Event type." }
    payload is String(1, 10000) with { briefly "Payload" described by "Event payload." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Raw usage received"
    described by "Emitted when raw event arrives."
  }

  query GetIngestionStats is {
    source is optional String(1, 100) with { briefly "Source" described by "Filter by source." }
    period is String(1, 20) with { briefly "Period" described by "Time period." }
  } with {
    briefly "Get ingestion stats"
    described by "Gets event ingestion statistics."
  }

  result IngestionStatsResult is {
    totalEvents is Natural with { briefly "Total" described by "Total events." }
    successCount is Natural with { briefly "Success" described by "Successful events." }
    errorCount is Natural with { briefly "Errors" described by "Failed events." }
    avgLatencyMs is Decimal(10, 2) with { briefly "Latency" described by "Average latency." }
  } with {
    briefly "Ingestion stats result"
    described by "Ingestion statistics."
  }

} with {
  option is external
  briefly "External event ingestion"
  described by "Usage event ingestion pipeline."
}

// Analytics Export Service
context AnalyticsExportService is {

  command ExportUsageData is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    startDate is Date with { briefly "Start" described by "Start date." }
    endDate is Date with { briefly "End" described by "End date." }
    format is String(1, 20) with { briefly "Format" described by "Export format." }
  } with {
    briefly "Export usage data"
    described by "Exports usage data."
  }

  event ExportCompleted is {
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    exportUrl is String(1, 500) with { briefly "URL" described by "Download URL." }
    expiresAt is TimeStamp with { briefly "Expires" described by "URL expiration." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Export completed"
    described by "Emitted when export is ready."
  }

} with {
  option is external
  briefly "External analytics export"
  described by "Usage data export service."
}
