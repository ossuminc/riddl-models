// Usage Metering - Meter Entity
entity Meter is {
  // Commands
  command CreateMeter is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |New meter identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer identifier.
      }
    }
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription identifier.
      }
    }
    definition: MeterDefinition with {
      briefly "Definition"
      described as {
        |Meter configuration.
      }
    }
  } with {
    briefly "Create meter"
    described as {
      |Creates a usage meter.
    }
  }
  command RecordUsageEvent is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    event: UsageEvent with {
      briefly "Event"
      described as {
        |Usage event.
      }
    }
  } with {
    briefly "Record usage event"
    described as {
      |Records a usage event.
    }
  }
  command RecordBatchEvents is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    events: UsageEvent+ with {
      briefly "Events"
      described as {
        |Usage events batch.
      }
    }
  } with {
    briefly "Record batch events"
    described as {
      |Records multiple events.
    }
  }
  command AggregateUsage is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    periodStart: TimeStamp with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    periodEnd: TimeStamp with {
      briefly "End"
      described as {
        |Period end.
      }
    }
  } with {
    briefly "Aggregate usage"
    described as {
      |Aggregates usage for period.
    }
  }
  command SetAlertThreshold is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    threshold: AlertThreshold with {
      briefly "Threshold"
      described as {
        |Alert threshold.
      }
    }
  } with {
    briefly "Set alert threshold"
    described as {
      |Configures usage alert.
    }
  }
  command RemoveAlertThreshold is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    metricType: MetricType with {
      briefly "Metric"
      described as {
        |Metric type.
      }
    }
  } with {
    briefly "Remove alert threshold"
    described as {
      |Removes usage alert.
    }
  }
  command GenerateBillingRecord is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    billingPeriodStart: Date with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    billingPeriodEnd: Date with {
      briefly "End"
      described as {
        |Period end.
      }
    }
  } with {
    briefly "Generate billing record"
    described as {
      |Creates billing record.
    }
  }
  command AdjustUsage is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    metricType: MetricType with {
      briefly "Metric"
      described as {
        |Metric type.
      }
    }
    adjustment: Decimal(14,4) with {
      briefly "Adjustment"
      described as {
        |Adjustment amount.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Adjustment reason.
      }
    }
    adjustedBy: String(1,100) with {
      briefly "By"
      described as {
        |Adjusted by.
      }
    }
  } with {
    briefly "Adjust usage"
    described as {
      |Applies usage adjustment.
    }
  }
  command PauseMeter is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
  } with {
    briefly "Pause meter"
    described as {
      |Pauses usage metering.
    }
  }
  command ResumeMeter is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
  } with {
    briefly "Resume meter"
    described as {
      |Resumes usage metering.
    }
  }
  command CloseMeter is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Close reason.
      }
    }
  } with {
    briefly "Close meter"
    described as {
      |Closes the meter.
    }
  }
  // Events
  event MeterCreated is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    definition: MeterDefinition with {
      briefly "Definition"
      described as {
        |Meter config.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Meter created"
    described as {
      |Emitted when meter is created.
    }
  }
  event UsageEventRecorded is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    event: UsageEvent with {
      briefly "Event"
      described as {
        |Usage event.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Usage event recorded"
    described as {
      |Emitted when event is recorded.
    }
  }
  event BatchEventsRecorded is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    eventCount: Natural with {
      briefly "Count"
      described as {
        |Number of events.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Batch events recorded"
    described as {
      |Emitted when batch is recorded.
    }
  }
  event UsageAggregated is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    aggregation: AggregatedUsage with {
      briefly "Aggregation"
      described as {
        |Aggregated usage.
      }
    }
  } with {
    briefly "Usage aggregated"
    described as {
      |Emitted when usage is aggregated.
    }
  }
  event AlertThresholdSet is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    threshold: AlertThreshold with {
      briefly "Threshold"
      described as {
        |Alert threshold.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Alert threshold set"
    described as {
      |Emitted when threshold is set.
    }
  }
  event AlertThresholdRemoved is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    metricType: MetricType with {
      briefly "Metric"
      described as {
        |Metric type.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Remove time.
      }
    }
  } with {
    briefly "Alert threshold removed"
    described as {
      |Emitted when threshold is removed.
    }
  }
  event UsageAlertTriggered is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    alert: UsageAlert with {
      briefly "Alert"
      described as {
        |Triggered alert.
      }
    }
  } with {
    briefly "Usage alert triggered"
    described as {
      |Emitted when threshold is exceeded.
    }
  }
  event BillingRecordGenerated is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    billingRecord: BillingRecord with {
      briefly "Record"
      described as {
        |Billing record.
      }
    }
  } with {
    briefly "Billing record generated"
    described as {
      |Emitted when billing is generated.
    }
  }
  event UsageAdjusted is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    metricType: MetricType with {
      briefly "Metric"
      described as {
        |Metric type.
      }
    }
    adjustment: Decimal(14,4) with {
      briefly "Adjustment"
      described as {
        |Adjustment amount.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Adjustment reason.
      }
    }
    adjustedAt: TimeStamp with {
      briefly "Adjusted"
      described as {
        |Adjustment time.
      }
    }
  } with {
    briefly "Usage adjusted"
    described as {
      |Emitted when adjustment is applied.
    }
  }
  event MeterPaused is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Meter paused"
    described as {
      |Emitted when meter is paused.
    }
  }
  event MeterResumed is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Meter resumed"
    described as {
      |Emitted when meter is resumed.
    }
  }
  event MeterClosed is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Close reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Meter closed"
    described as {
      |Emitted when meter is closed.
    }
  }
  // State Records
  record ActiveStateData is  {
    meterId: MeterId with {
      briefly "Meter"
      described as {
        |Meter ID.
      }
    }
    status: MeterStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    subscriptionId: SubscriptionId with {
      briefly "Subscription"
      described as {
        |Subscription ID.
      }
    }
    definition: MeterDefinition with {
      briefly "Definition"
      described as {
        |Meter config.
      }
    }
    currentPeriodStart: TimeStamp with {
      briefly "Period start"
      described as {
        |Current period start.
      }
    }
    currentPeriodUsage: AggregatedUsage* with {
      briefly "Usage"
      described as {
        |Current usage.
      }
    }
    alertThresholds: AlertThreshold* with {
      briefly "Thresholds"
      described as {
        |Alert thresholds.
      }
    }
    billingHistory: BillingRecord* with {
      briefly "History"
      described as {
        |Billing history.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
    updatedClosedAt: TimeStamp? with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active meter.
    }
  }
  // States
  state ActiveState of type Meter.ActiveStateData
  // Handler
  handler MeterHandler is {
    on command CreateMeter is {
      morph entity MeterContext.Meter to state MeterContext.Meter.ActiveState with command CreateMeter
      tell event MeterCreated to entity MeterContext.Meter
    }
    on command RecordUsageEvent is {
      tell event UsageEventRecorded to entity MeterContext.Meter
    }
    on command RecordBatchEvents is {
      tell event BatchEventsRecorded to entity MeterContext.Meter
    }
    on command AggregateUsage is {
      tell event UsageAggregated to entity MeterContext.Meter
    }
    on command SetAlertThreshold is {
      tell event AlertThresholdSet to entity MeterContext.Meter
    }
    on command RemoveAlertThreshold is {
      tell event AlertThresholdRemoved to entity MeterContext.Meter
    }
    on command GenerateBillingRecord is {
      tell event BillingRecordGenerated to entity MeterContext.Meter
    }
    on command AdjustUsage is {
      tell event UsageAdjusted to entity MeterContext.Meter
    }
    on command PauseMeter is {
      tell event MeterPaused to entity MeterContext.Meter
    }
    on command ResumeMeter is {
      tell event MeterResumed to entity MeterContext.Meter
    }
    on command CloseMeter is {
      tell event MeterClosed to entity MeterContext.Meter
    }
  } with {
    briefly "Processes meter commands"
    described as {
      | Handles meter lifecycle from creation
      | through usage tracking and billing.
    }
  }
} with {
  briefly "Meter aggregate"
  described as {
    | The Meter entity manages usage metering
    | for SaaS billing.
  }
}
