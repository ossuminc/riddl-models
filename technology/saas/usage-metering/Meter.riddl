// Usage Metering - Meter Entity

entity Meter is {

  // Commands
  command CreateMeter is {
    meterId is MeterId with {
      briefly "Meter"
      described by "New meter identifier."
    }
    customerId is CustomerId with {
      briefly "Customer"
      described by "Customer identifier."
    }
    subscriptionId is SubscriptionId with {
      briefly "Subscription"
      described by "Subscription identifier."
    }
    definition is MeterDefinition with {
      briefly "Definition"
      described by "Meter configuration."
    }
  } with {
    briefly "Create meter"
    described by "Creates a usage meter."
  }

  command RecordUsageEvent is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    event is UsageEvent with {
      briefly "Event"
      described by "Usage event."
    }
  } with {
    briefly "Record usage event"
    described by "Records a usage event."
  }

  command RecordBatchEvents is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    events is many UsageEvent with {
      briefly "Events"
      described by "Usage events batch."
    }
  } with {
    briefly "Record batch events"
    described by "Records multiple events."
  }

  command AggregateUsage is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    periodStart is TimeStamp with {
      briefly "Start"
      described by "Period start."
    }
    periodEnd is TimeStamp with {
      briefly "End"
      described by "Period end."
    }
  } with {
    briefly "Aggregate usage"
    described by "Aggregates usage for period."
  }

  command SetAlertThreshold is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    threshold is AlertThreshold with {
      briefly "Threshold"
      described by "Alert threshold."
    }
  } with {
    briefly "Set alert threshold"
    described by "Configures usage alert."
  }

  command RemoveAlertThreshold is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    metricType is MetricType with {
      briefly "Metric"
      described by "Metric type."
    }
  } with {
    briefly "Remove alert threshold"
    described by "Removes usage alert."
  }

  command GenerateBillingRecord is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    billingPeriodStart is Date with {
      briefly "Start"
      described by "Period start."
    }
    billingPeriodEnd is Date with {
      briefly "End"
      described by "Period end."
    }
  } with {
    briefly "Generate billing record"
    described by "Creates billing record."
  }

  command AdjustUsage is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    metricType is MetricType with {
      briefly "Metric"
      described by "Metric type."
    }
    adjustment is Decimal(14, 4) with {
      briefly "Adjustment"
      described by "Adjustment amount."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Adjustment reason."
    }
    adjustedBy is String(1, 100) with {
      briefly "By"
      described by "Adjusted by."
    }
  } with {
    briefly "Adjust usage"
    described by "Applies usage adjustment."
  }

  command PauseMeter is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Pause reason."
    }
  } with {
    briefly "Pause meter"
    described by "Pauses usage metering."
  }

  command ResumeMeter is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
  } with {
    briefly "Resume meter"
    described by "Resumes usage metering."
  }

  command CloseMeter is {
    meterId is MeterId with {
      briefly "Meter"
      described by "Meter identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Close reason."
    }
  } with {
    briefly "Close meter"
    described by "Closes the meter."
  }

  // Events
  event MeterCreated is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    definition is MeterDefinition with { briefly "Definition" described by "Meter config." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Meter created"
    described by "Emitted when meter is created."
  }

  event UsageEventRecorded is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    event is UsageEvent with { briefly "Event" described by "Usage event." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Usage event recorded"
    described by "Emitted when event is recorded."
  }

  event BatchEventsRecorded is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    eventCount is Natural with { briefly "Count" described by "Number of events." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Batch events recorded"
    described by "Emitted when batch is recorded."
  }

  event UsageAggregated is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    aggregation is AggregatedUsage with { briefly "Aggregation" described by "Aggregated usage." }
  } with {
    briefly "Usage aggregated"
    described by "Emitted when usage is aggregated."
  }

  event AlertThresholdSet is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    threshold is AlertThreshold with { briefly "Threshold" described by "Alert threshold." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Alert threshold set"
    described by "Emitted when threshold is set."
  }

  event AlertThresholdRemoved is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    metricType is MetricType with { briefly "Metric" described by "Metric type." }
    removedAt is TimeStamp with { briefly "Removed" described by "Remove time." }
  } with {
    briefly "Alert threshold removed"
    described by "Emitted when threshold is removed."
  }

  event UsageAlertTriggered is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    alert is UsageAlert with { briefly "Alert" described by "Triggered alert." }
  } with {
    briefly "Usage alert triggered"
    described by "Emitted when threshold is exceeded."
  }

  event BillingRecordGenerated is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    billingRecord is BillingRecord with { briefly "Record" described by "Billing record." }
  } with {
    briefly "Billing record generated"
    described by "Emitted when billing is generated."
  }

  event UsageAdjusted is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    metricType is MetricType with { briefly "Metric" described by "Metric type." }
    adjustment is Decimal(14, 4) with { briefly "Adjustment" described by "Adjustment amount." }
    reason is String(1, 500) with { briefly "Reason" described by "Adjustment reason." }
    adjustedAt is TimeStamp with { briefly "Adjusted" described by "Adjustment time." }
  } with {
    briefly "Usage adjusted"
    described by "Emitted when adjustment is applied."
  }

  event MeterPaused is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Pause reason." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Meter paused"
    described by "Emitted when meter is paused."
  }

  event MeterResumed is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Meter resumed"
    described by "Emitted when meter is resumed."
  }

  event MeterClosed is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Close reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Meter closed"
    described by "Emitted when meter is closed."
  }

  // State Records
  record ActiveStateData is {
    meterId is MeterId with { briefly "Meter" described by "Meter ID." }
    status is MeterStatus with { briefly "Status" described by "Current status." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    subscriptionId is SubscriptionId with { briefly "Subscription" described by "Subscription ID." }
    definition is MeterDefinition with { briefly "Definition" described by "Meter config." }
    currentPeriodStart is TimeStamp with { briefly "Period start" described by "Current period start." }
    currentPeriodUsage is many optional AggregatedUsage with { briefly "Usage" described by "Current usage." }
    alertThresholds is many optional AlertThreshold with { briefly "Thresholds" described by "Alert thresholds." }
    billingHistory is many optional BillingRecord with { briefly "History" described by "Billing history." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
    updatedClosedAt is optional TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Active state"
    described by "State for active meter."
  }

  // States
  state ActiveState of Meter.ActiveStateData with {
    briefly "Meter active"
    described by "Meter record is active."
  }

  // Handler
  handler MeterHandler is {
    on command CreateMeter {
      morph entity MeterContext.Meter to state MeterContext.Meter.ActiveState with command CreateMeter
      tell event MeterCreated to entity MeterContext.Meter
    }

    on command RecordUsageEvent {
      tell event UsageEventRecorded to entity MeterContext.Meter
    }

    on command RecordBatchEvents {
      tell event BatchEventsRecorded to entity MeterContext.Meter
    }

    on command AggregateUsage {
      tell event UsageAggregated to entity MeterContext.Meter
    }

    on command SetAlertThreshold {
      tell event AlertThresholdSet to entity MeterContext.Meter
    }

    on command RemoveAlertThreshold {
      tell event AlertThresholdRemoved to entity MeterContext.Meter
    }

    on command GenerateBillingRecord {
      tell event BillingRecordGenerated to entity MeterContext.Meter
    }

    on command AdjustUsage {
      tell event UsageAdjusted to entity MeterContext.Meter
    }

    on command PauseMeter {
      tell event MeterPaused to entity MeterContext.Meter
    }

    on command ResumeMeter {
      tell event MeterResumed to entity MeterContext.Meter
    }

    on command CloseMeter {
      tell event MeterClosed to entity MeterContext.Meter
    }
  } with {
    briefly "Processes meter commands"
    described by {
      | Handles meter lifecycle from creation
      | through usage tracking and billing.
    }
  }

} with {
  briefly "Meter aggregate"
  described by {
    | The Meter entity manages usage metering
    | for SaaS billing.
  }
}
