// Multi-Tenant Management - Tenant Context

context TenantContext is {

  include "types.riddl"
  include "Tenant.riddl"

  repository TenantRepository is {
    schema TenantData is relational
      of tenants as Tenant
      index on field Tenant.tenantId
      index on field Tenant.tenantInfo.subdomain
      index on field Tenant.status
      index on field Tenant.tenantInfo.tier

    handler TenantPersistence is {
      on command Tenant.ProvisionTenant {
        prompt "Store new tenant record"
      }
      on command Tenant.ActivateTenant {
        prompt "Update tenant to active"
      }
      on command Tenant.UpdateSettings {
        prompt "Store tenant settings"
      }
      on command Tenant.AddUser {
        prompt "Store tenant user"
      }
      on command Tenant.RecordUsage {
        prompt "Store usage metrics"
      }
      on command Tenant.DeactivateTenant {
        prompt "Update tenant to deactivated"
      }
    } with {
      briefly "Persists tenant commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Tenant data persistence"
    described by "Persistent storage for tenants."
  }

  projector PlatformAnalytics is {
    updates repository TenantRepository

    record PlatformMetrics is {
      totalTenants is Natural with { briefly "Total" described by "Total tenants." }
      activeTenants is Natural with { briefly "Active" described by "Active tenants." }
      totalUsers is Natural with { briefly "Users" described by "Total users." }
      totalStorageGB is Decimal(15, 2) with { briefly "Storage" described by "Total storage." }
      mrr is Decimal(15, 2) with { briefly "MRR" described by "Monthly recurring revenue." }
    } with {
      briefly "Platform metrics"
      described by "Platform-wide metrics."
    }

    handler AnalyticsHandler is {
      on event Tenant.TenantProvisioned {
        prompt "Increment tenant count"
      }
      on event Tenant.UserAdded {
        prompt "Increment user count"
      }
      on event Tenant.UsageRecorded {
        prompt "Aggregate storage usage"
      }
      on event Tenant.TierChanged {
        prompt "Recalculate MRR"
      }
    } with {
      briefly "Maintains platform analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Platform analytics"
    described by "Multi-tenant platform metrics."
  }

} with {
  briefly "Bounded context for multi-tenant management"
  described by "SaaS multi-tenancy context."
}
