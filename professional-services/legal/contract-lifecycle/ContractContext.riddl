// Contract Lifecycle - Contract Context

context ContractContext is {

  include "types.riddl"
  include "Contract.riddl"

  repository ContractRepository is {
    schema ContractData is relational
      of contracts as Contract
      index on field Contract.contractId
      index on field Contract.contractInfo.contractType
      index on field Contract.status

    handler ContractPersistence is {
      on event Contract.ContractCreated {
        prompt "Store new contract draft"
      }
      on event Contract.ContractSubmittedForReview {
        prompt "Update contract to in review"
      }
      on event Contract.RedlineSubmitted {
        prompt "Store redline changes"
      }
      on event Contract.ApprovalRecorded {
        prompt "Store approval decision"
      }
      on event Contract.SignatureRecorded {
        prompt "Store signature record"
      }
      on event Contract.ContractActivated {
        prompt "Update contract to active"
      }
      on event Contract.ObligationFulfilled {
        prompt "Update obligation status"
      }
      on event Contract.ContractRenewed {
        prompt "Update contract renewal"
      }
      on event Contract.ContractExpired {
        prompt "Update contract to expired"
      }
      on event Contract.ContractTerminated {
        prompt "Update contract to terminated"
      }
    } with {
      briefly "Persists contract events"
      described by "Handles event-driven contract persistence."
    }
  } with {
    briefly "Contract data persistence"
    described by "Persistent storage for contracts."
  }

  projector ContractMetrics is {
    updates repository ContractRepository

    record ContractDashboard is {
      contractsDrafted is Natural with { briefly "Drafted" described by "Contracts drafted." }
      contractsExecuted is Natural with { briefly "Executed" described by "Contracts executed." }
      contractsExpired is Natural with { briefly "Expired" described by "Contracts expired." }
      contractsTerminated is Natural with { briefly "Terminated" described by "Contracts terminated." }
      obligationsFulfilled is Natural with { briefly "Fulfilled" described by "Obligations fulfilled." }
      averageApprovalDays is Decimal(8, 2) with { briefly "Avg approval" described by "Average days to approval." }
    } with {
      briefly "Contract dashboard"
      described by "Contract portfolio metrics."
    }

    handler MetricsHandler is {
      on event Contract.ContractCreated {
        prompt "Increment contracts drafted"
      }
      on event Contract.ContractActivated {
        prompt "Increment contracts executed and calculate approval time"
      }
      on event Contract.ContractExpired {
        prompt "Increment contracts expired"
      }
      on event Contract.ContractTerminated {
        prompt "Increment contracts terminated"
      }
      on event Contract.ObligationFulfilled {
        prompt "Increment obligations fulfilled"
      }
    } with {
      briefly "Maintains contract metrics"
      described by "Projects events into contract metrics."
    }
  } with {
    briefly "Contract metrics"
    described by "Contract lifecycle analytics."
  }

} with {
  briefly "Bounded context for contract lifecycle"
  described by "Contract lifecycle management context."
}
