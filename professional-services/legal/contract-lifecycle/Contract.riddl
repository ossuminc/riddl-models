// Contract Lifecycle - Contract Entity

entity Contract is {

  // Commands
  command CreateContract is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "New contract identifier."
    }
    contractInfo is ContractInfo with {
      briefly "Contract info"
      described by "Contract details."
    }
    templateId is optional TemplateId with {
      briefly "Template"
      described by "Template used for drafting."
    }
  } with {
    briefly "Create contract"
    described by "Creates a new contract draft."
  }

  command SubmitForReview is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    reviewers is many String(3, 200) with {
      briefly "Reviewers"
      described by "Assigned reviewers."
    }
  } with {
    briefly "Submit for review"
    described by "Submits contract for legal review."
  }

  command AddReviewComment is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    comment is ReviewComment with {
      briefly "Comment"
      described by "Review comment."
    }
  } with {
    briefly "Add review comment"
    described by "Adds a review comment to the contract."
  }

  command SubmitRedline is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    changes is many RedlineChange with {
      briefly "Changes"
      described by "Redline changes."
    }
  } with {
    briefly "Submit redline"
    described by "Submits redline changes for the contract."
  }

  command AcceptRedline is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    changeId is UUID with {
      briefly "Change ID"
      described by "Redline change to accept."
    }
  } with {
    briefly "Accept redline"
    described by "Accepts a specific redline change."
  }

  command RejectRedline is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    changeId is UUID with {
      briefly "Change ID"
      described by "Redline change to reject."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
  } with {
    briefly "Reject redline"
    described by "Rejects a specific redline change."
  }

  command RequestApproval is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    approvers is many String(3, 200) with {
      briefly "Approvers"
      described by "Required approvers."
    }
  } with {
    briefly "Request approval"
    described by "Submits contract for approval."
  }

  command RecordApproval is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    approval is ApprovalRecord with {
      briefly "Approval"
      described by "Approval decision."
    }
  } with {
    briefly "Record approval"
    described by "Records an approval decision."
  }

  command SendForSignature is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    signatories is many ContractParty with {
      briefly "Signatories"
      described by "Parties to sign."
    }
  } with {
    briefly "Send for signature"
    described by "Sends contract for e-signature."
  }

  command RecordSignature is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    signature is SignatureRecord with {
      briefly "Signature"
      described by "Signature record."
    }
  } with {
    briefly "Record signature"
    described by "Records a party signature."
  }

  command ActivateContract is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    activatedAt is TimeStamp with {
      briefly "Activated"
      described by "Activation time."
    }
  } with {
    briefly "Activate contract"
    described by "Activates an executed contract."
  }

  command AddObligation is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    obligation is Obligation with {
      briefly "Obligation"
      described by "Obligation to track."
    }
  } with {
    briefly "Add obligation"
    described by "Adds an obligation to track."
  }

  command FulfillObligation is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    obligationId is ObligationId with {
      briefly "Obligation ID"
      described by "Obligation to fulfill."
    }
    fulfilledAt is TimeStamp with {
      briefly "Fulfilled"
      described by "Fulfillment time."
    }
  } with {
    briefly "Fulfill obligation"
    described by "Marks an obligation as fulfilled."
  }

  command RenewContract is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    newExpirationDate is Date with {
      briefly "New expiration"
      described by "New expiration date after renewal."
    }
    renewedAt is TimeStamp with {
      briefly "Renewed"
      described by "Renewal time."
    }
  } with {
    briefly "Renew contract"
    described by "Renews the contract for another term."
  }

  command ExpireContract is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    expiredAt is TimeStamp with {
      briefly "Expired"
      described by "Expiration time."
    }
  } with {
    briefly "Expire contract"
    described by "Marks contract as expired."
  }

  command TerminateContract is {
    contractId is ContractId with {
      briefly "Contract ID"
      described by "Contract identifier."
    }
    reason is String(3, 1000) with {
      briefly "Reason"
      described by "Termination reason."
    }
    terminatedAt is TimeStamp with {
      briefly "Terminated"
      described by "Termination time."
    }
  } with {
    briefly "Terminate contract"
    described by "Terminates the contract early."
  }

  // Events
  event ContractCreated is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    contractInfo is ContractInfo with { briefly "Info" described by "Contract info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Contract created"
    described by "Emitted when a contract draft is created."
  }

  event ContractSubmittedForReview is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    reviewers is many String(3, 200) with { briefly "Reviewers" described by "Assigned reviewers." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Contract submitted for review"
    described by "Emitted when contract is sent for review."
  }

  event ReviewCommentAdded is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    comment is ReviewComment with { briefly "Comment" described by "Review comment." }
  } with {
    briefly "Review comment added"
    described by "Emitted when a review comment is added."
  }

  event RedlineSubmitted is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    changeCount is Natural with { briefly "Changes" described by "Number of changes." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Redline submitted"
    described by "Emitted when redline changes are submitted."
  }

  event RedlineAccepted is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    changeId is UUID with { briefly "Change" described by "Accepted change ID." }
    acceptedAt is TimeStamp with { briefly "Accepted" described by "Acceptance time." }
  } with {
    briefly "Redline accepted"
    described by "Emitted when a redline change is accepted."
  }

  event RedlineRejected is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    changeId is UUID with { briefly "Change" described by "Rejected change ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Redline rejected"
    described by "Emitted when a redline change is rejected."
  }

  event ApprovalRequested is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    approvers is many String(3, 200) with { briefly "Approvers" described by "Required approvers." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Approval requested"
    described by "Emitted when approval is requested."
  }

  event ApprovalRecorded is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    approval is ApprovalRecord with { briefly "Approval" described by "Approval decision." }
  } with {
    briefly "Approval recorded"
    described by "Emitted when an approval decision is recorded."
  }

  event ContractSentForSignature is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    signatoryCount is Natural with { briefly "Signatories" described by "Number of signatories." }
    sentAt is TimeStamp with { briefly "Sent" described by "Time sent." }
  } with {
    briefly "Contract sent for signature"
    described by "Emitted when contract is sent for signing."
  }

  event SignatureRecorded is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    signature is SignatureRecord with { briefly "Signature" described by "Signature record." }
  } with {
    briefly "Signature recorded"
    described by "Emitted when a signature is recorded."
  }

  event ContractActivated is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Contract activated"
    described by "Emitted when contract becomes active."
  }

  event ObligationAdded is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    obligation is Obligation with { briefly "Obligation" described by "Added obligation." }
  } with {
    briefly "Obligation added"
    described by "Emitted when an obligation is added."
  }

  event ObligationFulfilled is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    obligationId is ObligationId with { briefly "Obligation" described by "Obligation ID." }
    fulfilledAt is TimeStamp with { briefly "Fulfilled" described by "Fulfillment time." }
  } with {
    briefly "Obligation fulfilled"
    described by "Emitted when an obligation is fulfilled."
  }

  event ContractRenewed is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    newExpirationDate is Date with { briefly "Expiration" described by "New expiration date." }
    renewedAt is TimeStamp with { briefly "Renewed" described by "Renewal time." }
  } with {
    briefly "Contract renewed"
    described by "Emitted when contract is renewed."
  }

  event ContractExpired is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    expiredAt is TimeStamp with { briefly "Expired" described by "Expiration time." }
  } with {
    briefly "Contract expired"
    described by "Emitted when contract expires."
  }

  event ContractTerminated is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    reason is String(3, 1000) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Contract terminated"
    described by "Emitted when contract is terminated early."
  }

  // States
  record DraftStateData is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    contractInfo is ContractInfo with { briefly "Info" described by "Contract info." }
    status is ContractStatus with { briefly "Status" described by "Contract status." }
    templateId is optional TemplateId with { briefly "Template" described by "Template used." }
    reviewComments is many optional ReviewComment with { briefly "Comments" described by "Review comments." }
    redlineChanges is many optional RedlineChange with { briefly "Redlines" described by "Redline changes." }
    approvals is many optional ApprovalRecord with { briefly "Approvals" described by "Approval records." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft contract state"
    described by "State for contract in draft through approval."
  }

  record ExecutedStateData is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    contractInfo is ContractInfo with { briefly "Info" described by "Contract info." }
    status is ContractStatus with { briefly "Status" described by "Contract status." }
    signatures is many SignatureRecord with { briefly "Signatures" described by "Signature records." }
    obligations is many optional Obligation with { briefly "Obligations" described by "Contract obligations." }
    renewalTerms is optional RenewalTerms with { briefly "Renewal" described by "Renewal terms." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Executed contract state"
    described by "State for executed and active contracts."
  }

  record ClosedStateData is {
    contractId is ContractId with { briefly "Contract" described by "Contract ID." }
    status is ContractStatus with { briefly "Status" described by "Final status." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
    reason is optional String(3, 1000) with { briefly "Reason" described by "Close reason." }
  } with {
    briefly "Closed contract state"
    described by "State for expired or terminated contracts."
  }

  state DraftState of Contract.DraftStateData with {
    briefly "Contract draft"
    described by "Contract is being drafted, reviewed, or approved."
  }

  state ExecutedState of Contract.ExecutedStateData with {
    briefly "Contract executed"
    described by "Contract is signed and active."
  }

  state ClosedState of Contract.ClosedStateData with {
    briefly "Contract closed"
    described by "Contract is expired or terminated."
  }

  handler ContractHandler is {
    on command CreateContract {
      morph entity ContractContext.Contract to state ContractContext.Contract.DraftState with command CreateContract
      tell event ContractCreated to entity ContractContext.Contract
    }
    on command SubmitForReview {
      tell event ContractSubmittedForReview to entity ContractContext.Contract
    }
    on command AddReviewComment {
      tell event ReviewCommentAdded to entity ContractContext.Contract
    }
    on command SubmitRedline {
      tell event RedlineSubmitted to entity ContractContext.Contract
    }
    on command AcceptRedline {
      tell event RedlineAccepted to entity ContractContext.Contract
    }
    on command RejectRedline {
      tell event RedlineRejected to entity ContractContext.Contract
    }
    on command RequestApproval {
      tell event ApprovalRequested to entity ContractContext.Contract
    }
    on command RecordApproval {
      tell event ApprovalRecorded to entity ContractContext.Contract
    }
    on command SendForSignature {
      tell event ContractSentForSignature to entity ContractContext.Contract
    }
    on command RecordSignature {
      tell event SignatureRecorded to entity ContractContext.Contract
    }
    on command ActivateContract {
      morph entity ContractContext.Contract to state ContractContext.Contract.ExecutedState with command ActivateContract
      tell event ContractActivated to entity ContractContext.Contract
    }
    on command AddObligation {
      tell event ObligationAdded to entity ContractContext.Contract
    }
    on command FulfillObligation {
      tell event ObligationFulfilled to entity ContractContext.Contract
    }
    on command RenewContract {
      tell event ContractRenewed to entity ContractContext.Contract
    }
    on command ExpireContract {
      morph entity ContractContext.Contract to state ContractContext.Contract.ClosedState with command ExpireContract
      tell event ContractExpired to entity ContractContext.Contract
    }
    on command TerminateContract {
      morph entity ContractContext.Contract to state ContractContext.Contract.ClosedState with command TerminateContract
      tell event ContractTerminated to entity ContractContext.Contract
    }
  } with {
    briefly "Processes contract commands"
    described by "Handles contract lifecycle transitions."
  }

} with {
  briefly "Contract aggregate"
  described by "Manages contract lifecycle from draft to closure."
}
