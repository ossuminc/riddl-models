// Case Management Bounded Context

context CaseContext is {

  include "LegalCase.riddl"

  repository CaseRepository is {
    schema CaseSchema is relational

    data record CaseRecord is {
      caseId: CaseId,
      matterId: MatterId,
      title: String,
      clientId: ClientId,
      clientName: String,
      practiceArea: PracticeArea,
      billingType: BillingType,
      status: CaseStatus,
      priority: CasePriority,
      leadAttorneyId: AttorneyId?,
      createdAt: DateTime,
      lastUpdated: DateTime,
      closedAt: DateTime?
    } briefly "Persisted case record"
      described by "The database record structure for storing case data."

    handler CaseQueryHandler is {
      on query FindCaseById {
        ???
      } briefly "Find case by ID"
        described by "Retrieves a single case by its unique identifier."

      on query FindCasesByClient {
        ???
      } briefly "Find cases by client"
        described by "Retrieves all cases for a specific client."

      on query FindCasesByAttorney {
        ???
      } briefly "Find cases by attorney"
        described by "Retrieves all cases assigned to an attorney."

      on query FindCasesByStatus {
        ???
      } briefly "Find cases by status"
        described by "Retrieves cases filtered by their status."

      on query SearchCases {
        ???
      } briefly "Search cases"
        described by "Full-text search across case records."
    } briefly "Handles case queries"
      described by "Processes read queries against the case repository."

    query FindCaseById is {
      caseId: CaseId
    } briefly "Query to find case by ID"
      described by "Looks up a case using its unique identifier."

    query FindCasesByClient is {
      clientId: ClientId
    } briefly "Query to find cases by client"
      described by "Retrieves all cases associated with a client."

    query FindCasesByAttorney is {
      attorneyId: AttorneyId
    } briefly "Query to find cases by attorney"
      described by "Retrieves all cases where an attorney is assigned."

    query FindCasesByStatus is {
      status: CaseStatus,
      practiceArea: PracticeArea?
    } briefly "Query to find cases by status"
      described by "Filters cases by status with optional practice area filter."

    query SearchCases is {
      searchText: String,
      practiceArea: PracticeArea?,
      status: CaseStatus?,
      fromDate: Date?,
      toDate: Date?
    } briefly "Full-text case search query"
      described by "Searches cases with optional filters for practice area, status, and date range."

    result CaseResult is {
      found: Boolean,
      caseRecord: CaseRecord?
    } briefly "Single case query result"
      described by "Returns a single case record if found."

    result CaseListResult is {
      totalCount: Integer,
      cases: CaseRecord*
    } briefly "Multiple case query result"
      described by "Returns a list of case records with total count."

  } briefly "Case persistence repository"
    described by {
      | The CaseRepository provides persistence and query capabilities for
      | legal cases. It supports finding cases by ID, client, attorney,
      | status, and full-text search.
    }

  projector CaseDashboard is {
    record CaseDashboardData is {
      totalActiveCases: Integer,
      casesByStatus: CaseStatusCount*,
      casesByPracticeArea: PracticeAreaCount*,
      upcomingDeadlines: UpcomingDeadline*,
      recentActivity: RecentCaseActivity*
    } briefly "Dashboard projection data"
      described by "Aggregated data for the case management dashboard."

    record CaseStatusCount is {
      status: CaseStatus,
      count: Integer
    } briefly "Count by status"
      described by "Number of cases in each status."

    record PracticeAreaCount is {
      practiceArea: PracticeArea,
      count: Integer
    } briefly "Count by practice area"
      described by "Number of cases in each practice area."

    record UpcomingDeadline is {
      caseId: CaseId,
      matterId: MatterId,
      title: String,
      eventType: CourtEventType,
      dueDate: DateTime,
      daysUntilDue: Integer
    } briefly "Upcoming deadline summary"
      described by "Court dates and deadlines approaching in the near future."

    record RecentCaseActivity is {
      caseId: CaseId,
      matterId: MatterId,
      title: String,
      activityType: String,
      activityDescription: String,
      occurredAt: DateTime
    } briefly "Recent case activity"
      described by "Latest activities across all cases."

    handler DashboardHandler is {
      on event LegalCase.CaseCreated {
        ???
      } briefly "Handle case creation"
        described by "Updates dashboard when a new case is created."

      on event LegalCase.CaseStatusUpdated {
        ???
      } briefly "Handle status change"
        described by "Updates counts when case status changes."

      on event LegalCase.CourtDateScheduled {
        ???
      } briefly "Handle court date scheduling"
        described by "Adds to upcoming deadlines projection."

      on event LegalCase.CaseClosed {
        ???
      } briefly "Handle case closure"
        described by "Updates dashboard when a case is closed."
    } briefly "Processes events for dashboard"
      described by "Maintains the dashboard projection by processing case events."

  } briefly "Case management dashboard projector"
    described by {
      | The CaseDashboard projector maintains aggregated views of case data
      | for display on management dashboards. It tracks case counts by status
      | and practice area, upcoming deadlines, and recent activity.
    }

  projector AttorneyWorkload is {
    record AttorneyWorkloadData is {
      attorneyId: AttorneyId,
      attorneyName: String,
      activeCases: Integer,
      totalBillableHoursThisMonth: Decimal,
      billableTarget: Decimal,
      utilizationPercent: Decimal,
      caseBreakdown: AttorneyCaseAssignment*
    } briefly "Attorney workload data"
      described by "Tracks attorney workload and utilization metrics."

    record AttorneyCaseAssignment is {
      caseId: CaseId,
      matterId: MatterId,
      title: String,
      role: TeamRole,
      hoursThisMonth: Decimal
    } briefly "Attorney case assignment"
      described by "Case assignments and hours for an attorney."

    handler WorkloadHandler is {
      on event LegalCase.TeamMemberAssigned {
        ???
      } briefly "Handle team assignment"
        described by "Updates workload when attorney is assigned to case."

      on event LegalCase.TeamMemberRemoved {
        ???
      } briefly "Handle team removal"
        described by "Updates workload when attorney is removed from case."

      on event LegalCase.TimeEntryRecorded {
        ???
      } briefly "Handle time entry"
        described by "Updates billable hours when time is recorded."

      on event LegalCase.CaseClosed {
        ???
      } briefly "Handle case closure"
        described by "Updates workload when case is closed."
    } briefly "Processes events for workload tracking"
      described by "Maintains attorney workload projections from case events."

  } briefly "Attorney workload projector"
    described by {
      | The AttorneyWorkload projector tracks each attorney's case assignments
      | and billable hours. It calculates utilization against targets and
      | provides workload distribution visibility for management.
    }

  projector BillingProjection is {
    record BillingData is {
      caseId: CaseId,
      matterId: MatterId,
      clientId: ClientId,
      billingType: BillingType,
      unbilledHours: Decimal,
      unbilledExpenses: Decimal,
      totalBilled: Decimal,
      lastBilledDate: Date?
    } briefly "Case billing summary"
      described by "Aggregated billing data for a case."

    handler BillingHandler is {
      on event LegalCase.TimeEntryRecorded {
        ???
      } briefly "Handle time entry"
        described by "Adds unbilled hours when time is recorded."

      on event LegalCase.ExpenseRecorded {
        ???
      } briefly "Handle expense"
        described by "Adds unbilled expense when expense is recorded."

      on event LegalCase.CaseClosed {
        ???
      } briefly "Handle case closure"
        described by "Finalizes billing data when case is closed."
    } briefly "Processes events for billing"
      described by "Maintains billing projections from time and expense events."

  } briefly "Billing summary projector"
    described by {
      | The BillingProjection tracks unbilled time and expenses for each case.
      | It provides data for generating client invoices and accounts receivable
      | reporting.
    }

} briefly "Case management bounded context"
  described by {
    | The CaseContext is the core bounded context for legal case management.
    | It contains the LegalCase entity, the CaseRepository for persistence,
    | and projectors for dashboard views, attorney workload tracking, and
    | billing summaries.
  }
