// Legal Case Entity

entity LegalCase is {

  option is aggregate
  option is event-sourced

  // Commands
  command CreateCase is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String
  } briefly "Create a new legal case"
    described by "Initiates a new legal case with client information and initial details."

  command AssignTeamMember is {
    caseId: CaseId,
    member: TeamMember
  } briefly "Assign attorney or paralegal to case"
    described by "Adds a team member to work on the case with their role and billing rate."

  command RemoveTeamMember is {
    caseId: CaseId,
    memberId: AttorneyId
  } briefly "Remove team member from case"
    described by "Removes an attorney or paralegal from the case team."

  command RecordTimeEntry is {
    caseId: CaseId,
    entry: TimeEntry
  } briefly "Record billable time"
    described by "Logs time spent working on the case for billing purposes."

  command RecordExpense is {
    caseId: CaseId,
    expense: Expense
  } briefly "Record case expense"
    described by "Logs an expense incurred for the case."

  command AddDocument is {
    caseId: CaseId,
    document: CaseDocument
  } briefly "Add document to case file"
    described by "Uploads a new document to the case file."

  command ScheduleCourtDate is {
    caseId: CaseId,
    courtDate: CourtDate
  } briefly "Schedule court appearance or deadline"
    described by "Adds a court date or deadline to the case calendar."

  command CancelCourtDate is {
    caseId: CaseId,
    dateId: Id(CaseManagement.CaseContext.LegalCase)
  } briefly "Cancel scheduled court date"
    described by "Removes a court date from the case calendar."

  command AddNote is {
    caseId: CaseId,
    note: CaseNote
  } briefly "Add note to case"
    described by "Records an internal note or observation on the case."

  command UpdateCaseStatus is {
    caseId: CaseId,
    newStatus: CaseStatus,
    reason: String
  } briefly "Update case status"
    described by "Changes the case status as it progresses through its lifecycle."

  command SetCasePriority is {
    caseId: CaseId,
    priority: CasePriority
  } briefly "Set case priority"
    described by "Adjusts the priority level of the case."

  command PlaceCaseOnHold is {
    caseId: CaseId,
    reason: String
  } briefly "Place case on hold"
    described by "Suspends active work on the case temporarily."

  command ReactivateCase is {
    caseId: CaseId,
    reason: String
  } briefly "Reactivate held case"
    described by "Resumes work on a case that was on hold."

  command CloseCase is {
    caseId: CaseId,
    resolution: CaseResolution,
    closingNotes: String
  } briefly "Close the case"
    described by "Marks the case as closed with its resolution outcome."

  command ArchiveCase is {
    caseId: CaseId
  } briefly "Archive closed case"
    described by "Moves a closed case to long-term archive storage."

  // Types local to this entity
  type CaseResolution is one of {
    Settled,
    WonAtTrial,
    LostAtTrial,
    Dismissed,
    Withdrawn,
    TransferredOut,
    Other
  } briefly "Outcome of the case"
    described by "Records how the case was ultimately resolved."

  // Events
  event CaseCreated is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    createdAt: DateTime
  } briefly "New case created"
    described by "Indicates a new legal case has been opened in the system."

  event TeamMemberAssigned is {
    caseId: CaseId,
    member: TeamMember
  } briefly "Team member assigned to case"
    described by "Records assignment of an attorney or paralegal to the case."

  event TeamMemberRemoved is {
    caseId: CaseId,
    memberId: AttorneyId,
    removedAt: DateTime
  } briefly "Team member removed from case"
    described by "Records removal of a team member from the case."

  event TimeEntryRecorded is {
    caseId: CaseId,
    entry: TimeEntry
  } briefly "Time entry logged"
    described by "Records billable time added to the case."

  event ExpenseRecorded is {
    caseId: CaseId,
    expense: Expense
  } briefly "Expense logged"
    described by "Records an expense added to the case."

  event DocumentAdded is {
    caseId: CaseId,
    document: CaseDocument
  } briefly "Document added to case"
    described by "Records a new document uploaded to the case file."

  event CourtDateScheduled is {
    caseId: CaseId,
    courtDate: CourtDate
  } briefly "Court date scheduled"
    described by "Records a new court date added to the calendar."

  event CourtDateCancelled is {
    caseId: CaseId,
    dateId: Id(CaseManagement.CaseContext.LegalCase),
    cancelledAt: DateTime
  } briefly "Court date cancelled"
    described by "Records removal of a court date from the calendar."

  event NoteAdded is {
    caseId: CaseId,
    note: CaseNote
  } briefly "Note added to case"
    described by "Records a new note added to the case file."

  event CaseStatusUpdated is {
    caseId: CaseId,
    oldStatus: CaseStatus,
    newStatus: CaseStatus,
    reason: String,
    updatedAt: DateTime
  } briefly "Case status changed"
    described by "Records a change in the case's status."

  event CasePrioritySet is {
    caseId: CaseId,
    oldPriority: CasePriority,
    newPriority: CasePriority
  } briefly "Case priority changed"
    described by "Records a change in the case's priority level."

  event CasePlacedOnHold is {
    caseId: CaseId,
    reason: String,
    heldAt: DateTime
  } briefly "Case placed on hold"
    described by "Records that work on the case has been suspended."

  event CaseReactivated is {
    caseId: CaseId,
    reason: String,
    reactivatedAt: DateTime
  } briefly "Case reactivated"
    described by "Records that work on a held case has resumed."

  event CaseClosed is {
    caseId: CaseId,
    resolution: CaseResolution,
    closingNotes: String,
    closedAt: DateTime
  } briefly "Case closed"
    described by "Records that the case has been closed with its resolution."

  event CaseArchived is {
    caseId: CaseId,
    archivedAt: DateTime
  } briefly "Case archived"
    described by "Records that the case has been moved to archive storage."

  // States
  state IntakeState of LegalCase.IntakeStateData is {
    handler IntakeHandler is {
      on command CreateCase {
        send event CaseCreated to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ActiveState with command CreateCase
      } briefly "Handle case creation"
        described by "Processes new case creation and transitions to active state."
    } briefly "Handles intake commands"
      described by "Processes commands during the intake phase."
  } briefly "Case in intake phase"
    described by "Initial state when a case is being set up."

  state ActiveState of LegalCase.ActiveStateData is {
    handler ActiveHandler is {
      on command AssignTeamMember {
        send event TeamMemberAssigned to outlet LegalCase.CaseEvents
      } briefly "Handle team assignment"
        described by "Processes team member assignments."

      on command RemoveTeamMember {
        send event TeamMemberRemoved to outlet LegalCase.CaseEvents
      } briefly "Handle team removal"
        described by "Processes team member removals."

      on command RecordTimeEntry {
        send event TimeEntryRecorded to outlet LegalCase.CaseEvents
      } briefly "Handle time entry"
        described by "Processes time entry recording."

      on command RecordExpense {
        send event ExpenseRecorded to outlet LegalCase.CaseEvents
      } briefly "Handle expense"
        described by "Processes expense recording."

      on command AddDocument {
        send event DocumentAdded to outlet LegalCase.CaseEvents
      } briefly "Handle document upload"
        described by "Processes document additions."

      on command ScheduleCourtDate {
        send event CourtDateScheduled to outlet LegalCase.CaseEvents
      } briefly "Handle court date scheduling"
        described by "Processes court date scheduling."

      on command CancelCourtDate {
        send event CourtDateCancelled to outlet LegalCase.CaseEvents
      } briefly "Handle court date cancellation"
        described by "Processes court date cancellations."

      on command AddNote {
        send event NoteAdded to outlet LegalCase.CaseEvents
      } briefly "Handle note addition"
        described by "Processes note additions."

      on command UpdateCaseStatus {
        send event CaseStatusUpdated to outlet LegalCase.CaseEvents
      } briefly "Handle status update"
        described by "Processes case status changes."

      on command SetCasePriority {
        send event CasePrioritySet to outlet LegalCase.CaseEvents
      } briefly "Handle priority change"
        described by "Processes case priority changes."

      on command PlaceCaseOnHold {
        send event CasePlacedOnHold to outlet LegalCase.CaseEvents
        morph entity LegalCase to state OnHoldState with command PlaceCaseOnHold
      } briefly "Handle hold request"
        described by "Processes requests to place case on hold."

      on command CloseCase {
        send event CaseClosed to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ClosedState with command CloseCase
      } briefly "Handle case closure"
        described by "Processes case closure requests."
    } briefly "Handles active case commands"
      described by "Processes all commands while case is actively being worked."
  } briefly "Case actively being worked"
    described by "State when the case is open and being actively managed."

  state OnHoldState of LegalCase.OnHoldStateData is {
    handler OnHoldHandler is {
      on command ReactivateCase {
        send event CaseReactivated to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ActiveState with command ReactivateCase
      } briefly "Handle reactivation"
        described by "Processes requests to reactivate held cases."

      on command CloseCase {
        send event CaseClosed to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ClosedState with command CloseCase
      } briefly "Handle closure from hold"
        described by "Processes closure requests for held cases."

      on command AddNote {
        send event NoteAdded to outlet LegalCase.CaseEvents
      } briefly "Allow notes while on hold"
        described by "Permits adding notes even when case is on hold."
    } briefly "Handles on-hold commands"
      described by "Processes limited commands while case is on hold."
  } briefly "Case work suspended"
    described by "State when work on the case has been temporarily suspended."

  state ClosedState of LegalCase.ClosedStateData is {
    handler ClosedHandler is {
      on command ArchiveCase {
        send event CaseArchived to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ArchivedState with command ArchiveCase
      } briefly "Handle archival"
        described by "Processes requests to archive closed cases."

      on command ReactivateCase {
        send event CaseReactivated to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ActiveState with command ReactivateCase
      } briefly "Handle reopening"
        described by "Processes requests to reopen closed cases."
    } briefly "Handles closed case commands"
      described by "Processes limited commands for closed cases."
  } briefly "Case resolved and closed"
    described by "State when the case has been closed with a resolution."

  state ArchivedState of LegalCase.ArchivedStateData is {
    handler ArchivedHandler is {
      on command ReactivateCase {
        send event CaseReactivated to outlet LegalCase.CaseEvents
        morph entity LegalCase to state ActiveState with command ReactivateCase
      } briefly "Handle unarchiving"
        described by "Processes requests to unarchive and reopen cases."
    } briefly "Handles archived case commands"
      described by "Processes minimal commands for archived cases."
  } briefly "Case in long-term archive"
    described by "State when the case has been archived for long-term storage."

  // State data records
  record IntakeStateData is {
    caseId: CaseId,
    createdAt: DateTime
  } briefly "Data during intake"
    described by "Minimal data captured during initial case creation."

  record ActiveStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    priority: CasePriority,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    createdAt: DateTime,
    lastUpdated: DateTime
  } briefly "Active case data"
    described by "Complete case data during active work."

  record OnHoldStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    priority: CasePriority,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    holdReason: String,
    heldAt: DateTime,
    createdAt: DateTime,
    lastUpdated: DateTime
  } briefly "On-hold case data"
    described by "Case data including hold reason and timestamp."

  record ClosedStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    resolution: CaseResolution,
    closingNotes: String,
    closedAt: DateTime,
    createdAt: DateTime
  } briefly "Closed case data"
    described by "Complete case data including resolution details."

  record ArchivedStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientName: String,
    practiceArea: PracticeArea,
    resolution: CaseResolution,
    archivedAt: DateTime,
    createdAt: DateTime,
    closedAt: DateTime
  } briefly "Archived case data"
    described by "Minimal case data retained in archive."

  outlet CaseEvents is event CaseCreated
    briefly "Outlet for case events"
    described by "Publishes case lifecycle events for downstream processing."

} briefly "Legal case aggregate entity"
  described by {
    | The LegalCase entity represents a single legal matter being handled
    | by the firm. It aggregates all case-related data including team
    | assignments, time entries, expenses, documents, court dates, and
    | notes. The entity progresses through states from intake through
    | active work to closure and archival.
  }
