// Legal Case Entity

entity LegalCase is {

  // Commands
  command CreateCase is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String
  } with {
    briefly "Create a new legal case"
    described by "Initiates a new legal case with client information and initial details."
  }

  command AssignTeamMember is {
    caseId: CaseId,
    member: TeamMember
  } with {
    briefly "Assign attorney or paralegal to case"
    described by "Adds a team member to work on the case with their role and billing rate."
  }

  command RemoveTeamMember is {
    caseId: CaseId,
    memberId: AttorneyId
  } with {
    briefly "Remove team member from case"
    described by "Removes an attorney or paralegal from the case team."
  }

  command RecordTimeEntry is {
    caseId: CaseId,
    entry: TimeEntry
  } with {
    briefly "Record billable time"
    described by "Logs time spent working on the case for billing purposes."
  }

  command RecordExpense is {
    caseId: CaseId,
    expense: Expense
  } with {
    briefly "Record case expense"
    described by "Logs an expense incurred for the case."
  }

  command AddDocument is {
    caseId: CaseId,
    document: CaseDocument
  } with {
    briefly "Add document to case file"
    described by "Uploads a new document to the case file."
  }

  command ScheduleCourtDate is {
    caseId: CaseId,
    courtDate: CourtDate
  } with {
    briefly "Schedule court appearance or deadline"
    described by "Adds a court date or deadline to the case calendar."
  }

  command CancelCourtDate is {
    caseId: CaseId,
    dateId: Id(CaseManagement.CaseContext.LegalCase)
  } with {
    briefly "Cancel scheduled court date"
    described by "Removes a court date from the case calendar."
  }

  command AddNote is {
    caseId: CaseId,
    note: CaseNote
  } with {
    briefly "Add note to case"
    described by "Records an internal note or observation on the case."
  }

  command UpdateCaseStatus is {
    caseId: CaseId,
    newStatus: CaseStatus,
    reason: String
  } with {
    briefly "Update case status"
    described by "Changes the case status as it progresses through its lifecycle."
  }

  command SetCasePriority is {
    caseId: CaseId,
    priority: CasePriority
  } with {
    briefly "Set case priority"
    described by "Adjusts the priority level of the case."
  }

  command PlaceCaseOnHold is {
    caseId: CaseId,
    reason: String
  } with {
    briefly "Place case on hold"
    described by "Suspends active work on the case temporarily."
  }

  command ReactivateCase is {
    caseId: CaseId,
    reason: String
  } with {
    briefly "Reactivate held case"
    described by "Resumes work on a case that was on hold."
  }

  command CloseCase is {
    caseId: CaseId,
    resolution: CaseResolution,
    closingNotes: String
  } with {
    briefly "Close the case"
    described by "Marks the case as closed with its resolution outcome."
  }

  command ArchiveCase is {
    caseId: CaseId
  } with {
    briefly "Archive closed case"
    described by "Moves a closed case to long-term archive storage."
  }

  // Types local to this entity
  type CaseResolution is any of {
    Settled,
    WonAtTrial,
    LostAtTrial,
    Dismissed,
    Withdrawn,
    TransferredOut,
    Other
  } with {
    briefly "Outcome of the case"
    described by "Records how the case was ultimately resolved."
  }

  // Events
  event CaseCreated is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    createdAt: DateTime
  } with {
    briefly "New case created"
    described by "Indicates a new legal case has been opened in the system."
  }

  event TeamMemberAssigned is {
    caseId: CaseId,
    member: TeamMember
  } with {
    briefly "Team member assigned to case"
    described by "Records assignment of an attorney or paralegal to the case."
  }

  event TeamMemberRemoved is {
    caseId: CaseId,
    memberId: AttorneyId,
    removedAt: DateTime
  } with {
    briefly "Team member removed from case"
    described by "Records removal of a team member from the case."
  }

  event TimeEntryRecorded is {
    caseId: CaseId,
    entry: TimeEntry
  } with {
    briefly "Time entry logged"
    described by "Records billable time added to the case."
  }

  event ExpenseRecorded is {
    caseId: CaseId,
    expense: Expense
  } with {
    briefly "Expense logged"
    described by "Records an expense added to the case."
  }

  event DocumentAdded is {
    caseId: CaseId,
    document: CaseDocument
  } with {
    briefly "Document added to case"
    described by "Records a new document uploaded to the case file."
  }

  event CourtDateScheduled is {
    caseId: CaseId,
    courtDate: CourtDate
  } with {
    briefly "Court date scheduled"
    described by "Records a new court date added to the calendar."
  }

  event CourtDateCancelled is {
    caseId: CaseId,
    dateId: Id(CaseManagement.CaseContext.LegalCase),
    cancelledAt: DateTime
  } with {
    briefly "Court date cancelled"
    described by "Records removal of a court date from the calendar."
  }

  event NoteAdded is {
    caseId: CaseId,
    note: CaseNote
  } with {
    briefly "Note added to case"
    described by "Records a new note added to the case file."
  }

  event CaseStatusUpdated is {
    caseId: CaseId,
    oldStatus: CaseStatus,
    newStatus: CaseStatus,
    reason: String,
    updatedAt: DateTime
  } with {
    briefly "Case status changed"
    described by "Records a change in the case's status."
  }

  event CasePrioritySet is {
    caseId: CaseId,
    oldPriority: CasePriority,
    newPriority: CasePriority
  } with {
    briefly "Case priority changed"
    described by "Records a change in the case's priority level."
  }

  event CasePlacedOnHold is {
    caseId: CaseId,
    reason: String,
    heldAt: DateTime
  } with {
    briefly "Case placed on hold"
    described by "Records that work on the case has been suspended."
  }

  event CaseReactivated is {
    caseId: CaseId,
    reason: String,
    reactivatedAt: DateTime
  } with {
    briefly "Case reactivated"
    described by "Records that work on a held case has resumed."
  }

  event CaseClosed is {
    caseId: CaseId,
    resolution: CaseResolution,
    closingNotes: String,
    closedAt: DateTime
  } with {
    briefly "Case closed"
    described by "Records that the case has been closed with its resolution."
  }

  event CaseArchived is {
    caseId: CaseId,
    archivedAt: DateTime
  } with {
    briefly "Case archived"
    described by "Records that the case has been moved to archive storage."
  }

  // State data records
  record IntakeStateData is {
    caseId: CaseId,
    createdAt: DateTime
  } with {
    briefly "Data during intake"
    described by "Minimal data captured during initial case creation."
  }

  record ActiveStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    priority: CasePriority,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    createdAt: DateTime,
    lastUpdated: DateTime
  } with {
    briefly "Active case data"
    described by "Complete case data during active work."
  }

  record OnHoldStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    priority: CasePriority,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    holdReason: String,
    heldAt: DateTime,
    createdAt: DateTime,
    lastUpdated: DateTime
  } with {
    briefly "On-hold case data"
    described by "Case data including hold reason and timestamp."
  }

  record ClosedStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientInfo: ClientInfo,
    practiceArea: PracticeArea,
    billingType: BillingType,
    description: String,
    status: CaseStatus,
    teamMembers: TeamMember*,
    timeEntries: TimeEntry*,
    expenses: Expense*,
    documents: CaseDocument*,
    courtDates: CourtDate*,
    notes: CaseNote*,
    resolution: CaseResolution,
    closingNotes: String,
    closedAt: DateTime,
    createdAt: DateTime
  } with {
    briefly "Closed case data"
    described by "Complete case data including resolution details."
  }

  record ArchivedStateData is {
    caseId: CaseId,
    matterId: MatterId,
    title: String,
    clientName: String,
    practiceArea: PracticeArea,
    resolution: CaseResolution,
    archivedAt: DateTime,
    createdAt: DateTime,
    closedAt: DateTime
  } with {
    briefly "Archived case data"
    described by "Minimal case data retained in archive."
  }

  // States
  state IntakeState of LegalCase.IntakeStateData with {
    briefly "Case in intake phase"
    described by "Initial state when a case is being set up."
  }

  state ActiveState of LegalCase.ActiveStateData with {
    briefly "Case actively being worked"
    described by "State when the case is open and being actively managed."
  }

  state OnHoldState of LegalCase.OnHoldStateData with {
    briefly "Case work suspended"
    described by "State when work on the case has been temporarily suspended."
  }

  state ClosedState of LegalCase.ClosedStateData with {
    briefly "Case resolved and closed"
    described by "State when the case has been closed with a resolution."
  }

  state ArchivedState of LegalCase.ArchivedStateData with {
    briefly "Case in long-term archive"
    described by "State when the case has been archived for long-term storage."
  }

  // Handler
  handler CaseHandler is {
    on command CreateCase {
      morph entity CaseContext.LegalCase to state CaseContext.LegalCase.ActiveState with command CreateCase
      tell event CaseCreated to entity CaseContext.LegalCase
    }

    on command AssignTeamMember {
      tell event TeamMemberAssigned to entity CaseContext.LegalCase
    }

    on command RemoveTeamMember {
      tell event TeamMemberRemoved to entity CaseContext.LegalCase
    }

    on command RecordTimeEntry {
      tell event TimeEntryRecorded to entity CaseContext.LegalCase
    }

    on command RecordExpense {
      tell event ExpenseRecorded to entity CaseContext.LegalCase
    }

    on command AddDocument {
      tell event DocumentAdded to entity CaseContext.LegalCase
    }

    on command ScheduleCourtDate {
      tell event CourtDateScheduled to entity CaseContext.LegalCase
    }

    on command CancelCourtDate {
      tell event CourtDateCancelled to entity CaseContext.LegalCase
    }

    on command AddNote {
      tell event NoteAdded to entity CaseContext.LegalCase
    }

    on command UpdateCaseStatus {
      tell event CaseStatusUpdated to entity CaseContext.LegalCase
    }

    on command SetCasePriority {
      tell event CasePrioritySet to entity CaseContext.LegalCase
    }

    on command PlaceCaseOnHold {
      morph entity CaseContext.LegalCase to state CaseContext.LegalCase.OnHoldState with command PlaceCaseOnHold
      tell event CasePlacedOnHold to entity CaseContext.LegalCase
    }

    on command ReactivateCase {
      morph entity CaseContext.LegalCase to state CaseContext.LegalCase.ActiveState with command ReactivateCase
      tell event CaseReactivated to entity CaseContext.LegalCase
    }

    on command CloseCase {
      morph entity CaseContext.LegalCase to state CaseContext.LegalCase.ClosedState with command CloseCase
      tell event CaseClosed to entity CaseContext.LegalCase
    }

    on command ArchiveCase {
      morph entity CaseContext.LegalCase to state CaseContext.LegalCase.ArchivedState with command ArchiveCase
      tell event CaseArchived to entity CaseContext.LegalCase
    }
  } with {
    briefly "Processes case lifecycle commands"
    described by {
      | Handles all case lifecycle commands including creation,
      | team management, billing, documents, and status changes.
    }
  }

} with {
  option is aggregate
  option is event-sourced
  briefly "Legal case aggregate entity"
  described by {
    | The LegalCase entity represents a single legal matter being handled
    | by the firm. It aggregates all case-related data including team
    | assignments, time entries, expenses, documents, court dates, and
    | notes. The entity progresses through states from intake through
    | active work to closure and archival.
  }
}
