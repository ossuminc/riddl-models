// Matter Management - LegalMatter Entity

entity LegalMatter is {

  command CreateMatter is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "New matter identifier."
    }
    matterInfo is MatterInfo with {
      briefly "Matter info"
      described by "Matter details."
    }
  } with {
    briefly "Create matter"
    described by "Creates a new legal matter."
  }

  command RecordConflictCheck is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    conflictResult is ConflictCheckResult with {
      briefly "Result"
      described by "Conflict check result."
    }
  } with {
    briefly "Record conflict check"
    described by "Records conflict of interest check result."
  }

  command AssignTeam is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    leadAttorney is TeamMember with {
      briefly "Lead"
      described by "Lead attorney assignment."
    }
    teamMembers is many optional TeamMember with {
      briefly "Members"
      described by "Additional team members."
    }
  } with {
    briefly "Assign team"
    described by "Assigns attorney team to the matter."
  }

  command ActivateMatter is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    activatedAt is TimeStamp with {
      briefly "Activated"
      described by "Activation time."
    }
  } with {
    briefly "Activate matter"
    described by "Activates the matter for active work."
  }

  command RecordTime is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    timeEntry is TimeEntry with {
      briefly "Time entry"
      described by "Time record to add."
    }
  } with {
    briefly "Record time"
    described by "Records billable time on the matter."
  }

  command RecordExpense is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    expenseEntry is ExpenseEntry with {
      briefly "Expense"
      described by "Expense record to add."
    }
  } with {
    briefly "Record expense"
    described by "Records an expense on the matter."
  }

  command AttachDocument is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    document is MatterDocument with {
      briefly "Document"
      described by "Document to attach."
    }
  } with {
    briefly "Attach document"
    described by "Attaches a document to the matter."
  }

  command AddCourtDeadline is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    deadline is CourtDeadline with {
      briefly "Deadline"
      described by "Court deadline to add."
    }
  } with {
    briefly "Add court deadline"
    described by "Adds a court filing deadline."
  }

  command CompleteDeadline is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    deadlineId is UUID with {
      briefly "Deadline ID"
      described by "Deadline identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
  } with {
    briefly "Complete deadline"
    described by "Marks a court deadline as completed."
  }

  command PlaceMatterOnHold is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Place matter on hold"
    described by "Places the matter on hold."
  }

  command ReactivateMatter is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    reactivatedAt is TimeStamp with {
      briefly "Reactivated"
      described by "Reactivation time."
    }
  } with {
    briefly "Reactivate matter"
    described by "Reactivates a matter that was on hold."
  }

  command CloseMatter is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    closureNotes is String(3, 2000) with {
      briefly "Notes"
      described by "Closure notes."
    }
    closedAt is TimeStamp with {
      briefly "Closed"
      described by "Closure time."
    }
  } with {
    briefly "Close matter"
    described by "Closes the legal matter."
  }

  command RejectMatter is {
    matterId is MatterId with {
      briefly "Matter ID"
      described by "Matter identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
  } with {
    briefly "Reject matter"
    described by "Rejects the matter due to conflict or policy."
  }

  // Events
  event MatterCreated is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    matterInfo is MatterInfo with { briefly "Info" described by "Matter info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Matter created"
    described by "Emitted when matter is created."
  }

  event ConflictCheckRecorded is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    conflictResult is ConflictCheckResult with { briefly "Result" described by "Conflict result." }
  } with {
    briefly "Conflict check recorded"
    described by "Emitted when conflict check is completed."
  }

  event TeamAssigned is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    leadAttorney is TeamMember with { briefly "Lead" described by "Lead attorney." }
    teamSize is Natural with { briefly "Size" described by "Team size." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Team assigned"
    described by "Emitted when team is assigned to matter."
  }

  event MatterActivated is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Matter activated"
    described by "Emitted when matter becomes active."
  }

  event TimeRecorded is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    entryId is UUID with { briefly "Entry" described by "Time entry ID." }
    hours is Decimal(5, 2) with { briefly "Hours" described by "Hours recorded." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Time recorded"
    described by "Emitted when time is recorded."
  }

  event ExpenseRecorded is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    entryId is UUID with { briefly "Entry" described by "Expense entry ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Expense amount." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Expense recorded"
    described by "Emitted when expense is recorded."
  }

  event DocumentAttached is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    documentId is DocumentId with { briefly "Document" described by "Document ID." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Document attached"
    described by "Emitted when document is attached."
  }

  event CourtDeadlineAdded is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    deadlineId is UUID with { briefly "Deadline" described by "Deadline ID." }
    dueDate is Date with { briefly "Due" described by "Due date." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Court deadline added"
    described by "Emitted when court deadline is added."
  }

  event DeadlineCompleted is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    deadlineId is UUID with { briefly "Deadline" described by "Deadline ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Deadline completed"
    described by "Emitted when a court deadline is met."
  }

  event MatterPlacedOnHold is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Matter placed on hold"
    described by "Emitted when matter is placed on hold."
  }

  event MatterReactivated is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Matter reactivated"
    described by "Emitted when matter is reactivated."
  }

  event MatterClosed is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    closureNotes is String(3, 2000) with { briefly "Notes" described by "Closure notes." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Matter closed"
    described by "Emitted when matter is closed."
  }

  event MatterRejected is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Matter rejected"
    described by "Emitted when matter is rejected."
  }

  // States
  record IntakeStateData is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    matterInfo is MatterInfo with { briefly "Info" described by "Matter info." }
    updatedConflictResult is optional ConflictCheckResult with { briefly "Conflict" described by "Conflict check result." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Intake state data"
    described by "State data for matter in intake."
  }

  record ActiveStateData is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    matterInfo is MatterInfo with { briefly "Info" described by "Matter info." }
    status is MatterStatus with { briefly "Status" described by "Matter status." }
    conflictResult is ConflictCheckResult with { briefly "Conflict" described by "Conflict check result." }
    leadAttorney is TeamMember with { briefly "Lead" described by "Lead attorney." }
    teamMembers is many optional TeamMember with { briefly "Team" described by "Team members." }
    timeEntries is many optional TimeEntry with { briefly "Time" described by "Time entries." }
    expenseEntries is many optional ExpenseEntry with { briefly "Expenses" described by "Expense entries." }
    documents is many optional MatterDocument with { briefly "Documents" described by "Attached documents." }
    updatedDeadlines is many optional CourtDeadline with { briefly "Deadlines" described by "Court deadlines." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Active state data"
    described by "State data for active matter."
  }

  record ClosedStateData is {
    matterId is MatterId with { briefly "Matter" described by "Matter ID." }
    matterInfo is MatterInfo with { briefly "Info" described by "Matter info." }
    closureNotes is String(3, 2000) with { briefly "Notes" described by "Closure notes." }
    totalHours is Decimal(8, 2) with { briefly "Hours" described by "Total billable hours." }
    totalExpenses is Decimal(12, 2) with { briefly "Expenses" described by "Total expenses." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state data"
    described by "State data for closed matter."
  }

  state IntakeState of LegalMatter.IntakeStateData with {
    briefly "Matter intake"
    described by "Matter is in intake and conflict checking."
  }

  state ActiveState of LegalMatter.ActiveStateData with {
    briefly "Matter active"
    described by "Matter is actively being worked."
  }

  state ClosedState of LegalMatter.ClosedStateData with {
    briefly "Matter closed"
    described by "Matter is closed."
  }

  handler LegalMatterHandler is {
    on command CreateMatter {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.IntakeState with command CreateMatter
      tell event MatterCreated to entity MatterContext.LegalMatter
    }
    on command RecordConflictCheck {
      tell event ConflictCheckRecorded to entity MatterContext.LegalMatter
    }
    on command AssignTeam {
      tell event TeamAssigned to entity MatterContext.LegalMatter
    }
    on command ActivateMatter {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.ActiveState with command ActivateMatter
      tell event MatterActivated to entity MatterContext.LegalMatter
    }
    on command RecordTime {
      tell event TimeRecorded to entity MatterContext.LegalMatter
    }
    on command RecordExpense {
      tell event ExpenseRecorded to entity MatterContext.LegalMatter
    }
    on command AttachDocument {
      tell event DocumentAttached to entity MatterContext.LegalMatter
    }
    on command AddCourtDeadline {
      tell event CourtDeadlineAdded to entity MatterContext.LegalMatter
    }
    on command CompleteDeadline {
      tell event DeadlineCompleted to entity MatterContext.LegalMatter
    }
    on command PlaceMatterOnHold {
      tell event MatterPlacedOnHold to entity MatterContext.LegalMatter
    }
    on command ReactivateMatter {
      tell event MatterReactivated to entity MatterContext.LegalMatter
    }
    on command CloseMatter {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.ClosedState with command CloseMatter
      tell event MatterClosed to entity MatterContext.LegalMatter
    }
    on command RejectMatter {
      tell event MatterRejected to entity MatterContext.LegalMatter
    }
  } with {
    briefly "Processes legal matter commands"
    described by "Handles legal matter lifecycle."
  }

} with {
  briefly "LegalMatter aggregate"
  described by "Manages legal matter lifecycle and tracking."
}
