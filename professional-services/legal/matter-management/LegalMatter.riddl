// Matter Management - LegalMatter Entity
entity LegalMatter is {
  command CreateMatter is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |New matter identifier.
      }
    }
    matterInfo: MatterInfo with {
      briefly "Matter info"
      described as {
        |Matter details.
      }
    }
  } with {
    briefly "Create matter"
    described as {
      |Creates a new legal matter.
    }
  }
  command RecordConflictCheck is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    conflictResult: ConflictCheckResult with {
      briefly "Result"
      described as {
        |Conflict check result.
      }
    }
  } with {
    briefly "Record conflict check"
    described as {
      |Records conflict of interest check result.
    }
  }
  command AssignTeam is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    leadAttorney: TeamMember with {
      briefly "Lead"
      described as {
        |Lead attorney assignment.
      }
    }
    teamMembers: TeamMember* with {
      briefly "Members"
      described as {
        |Additional team members.
      }
    }
  } with {
    briefly "Assign team"
    described as {
      |Assigns attorney team to the matter.
    }
  }
  command ActivateMatter is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Activate matter"
    described as {
      |Activates the matter for active work.
    }
  }
  command RecordTime is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    timeEntry: TimeEntry with {
      briefly "Time entry"
      described as {
        |Time record to add.
      }
    }
  } with {
    briefly "Record time"
    described as {
      |Records billable time on the matter.
    }
  }
  command RecordExpense is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    expenseEntry: ExpenseEntry with {
      briefly "Expense"
      described as {
        |Expense record to add.
      }
    }
  } with {
    briefly "Record expense"
    described as {
      |Records an expense on the matter.
    }
  }
  command AttachDocument is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    document: MatterDocument with {
      briefly "Document"
      described as {
        |Document to attach.
      }
    }
  } with {
    briefly "Attach document"
    described as {
      |Attaches a document to the matter.
    }
  }
  command AddCourtDeadline is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    deadline: CourtDeadline with {
      briefly "Deadline"
      described as {
        |Court deadline to add.
      }
    }
  } with {
    briefly "Add court deadline"
    described as {
      |Adds a court filing deadline.
    }
  }
  command CompleteDeadline is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    deadlineId: UUID with {
      briefly "Deadline ID"
      described as {
        |Deadline identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Complete deadline"
    described as {
      |Marks a court deadline as completed.
    }
  }
  command PlaceMatterOnHold is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
  } with {
    briefly "Place matter on hold"
    described as {
      |Places the matter on hold.
    }
  }
  command ReactivateMatter is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated"
      described as {
        |Reactivation time.
      }
    }
  } with {
    briefly "Reactivate matter"
    described as {
      |Reactivates a matter that was on hold.
    }
  }
  command CloseMatter is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    closureNotes: String(3,2000) with {
      briefly "Notes"
      described as {
        |Closure notes.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Close matter"
    described as {
      |Closes the legal matter.
    }
  }
  command RejectMatter is  {
    matterId: MatterId with {
      briefly "Matter ID"
      described as {
        |Matter identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject matter"
    described as {
      |Rejects the matter due to conflict or policy.
    }
  }
  // Events
  event MatterCreated is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    matterInfo: MatterInfo with {
      briefly "Info"
      described as {
        |Matter info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Matter created"
    described as {
      |Emitted when matter is created.
    }
  }
  event ConflictCheckRecorded is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    conflictResult: ConflictCheckResult with {
      briefly "Result"
      described as {
        |Conflict result.
      }
    }
  } with {
    briefly "Conflict check recorded"
    described as {
      |Emitted when conflict check is completed.
    }
  }
  event TeamAssigned is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    leadAttorney: TeamMember with {
      briefly "Lead"
      described as {
        |Lead attorney.
      }
    }
    teamSize: Natural with {
      briefly "Size"
      described as {
        |Team size.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Team assigned"
    described as {
      |Emitted when team is assigned to matter.
    }
  }
  event MatterActivated is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Matter activated"
    described as {
      |Emitted when matter becomes active.
    }
  }
  event TimeRecorded is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    entryId: UUID with {
      briefly "Entry"
      described as {
        |Time entry ID.
      }
    }
    hours: Decimal(5,2) with {
      briefly "Hours"
      described as {
        |Hours recorded.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Time recorded"
    described as {
      |Emitted when time is recorded.
    }
  }
  event ExpenseRecorded is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    entryId: UUID with {
      briefly "Entry"
      described as {
        |Expense entry ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Expense amount.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Expense recorded"
    described as {
      |Emitted when expense is recorded.
    }
  }
  event DocumentAttached is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    documentId: DocumentId with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    attachedAt: TimeStamp with {
      briefly "Attached"
      described as {
        |Attachment time.
      }
    }
  } with {
    briefly "Document attached"
    described as {
      |Emitted when document is attached.
    }
  }
  event CourtDeadlineAdded is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    deadlineId: UUID with {
      briefly "Deadline"
      described as {
        |Deadline ID.
      }
    }
    dueDate: Date with {
      briefly "Due"
      described as {
        |Due date.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Court deadline added"
    described as {
      |Emitted when court deadline is added.
    }
  }
  event DeadlineCompleted is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    deadlineId: UUID with {
      briefly "Deadline"
      described as {
        |Deadline ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Deadline completed"
    described as {
      |Emitted when a court deadline is met.
    }
  }
  event MatterPlacedOnHold is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "Matter placed on hold"
    described as {
      |Emitted when matter is placed on hold.
    }
  }
  event MatterReactivated is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated"
      described as {
        |Reactivation time.
      }
    }
  } with {
    briefly "Matter reactivated"
    described as {
      |Emitted when matter is reactivated.
    }
  }
  event MatterClosed is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    closureNotes: String(3,2000) with {
      briefly "Notes"
      described as {
        |Closure notes.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Matter closed"
    described as {
      |Emitted when matter is closed.
    }
  }
  event MatterRejected is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Matter rejected"
    described as {
      |Emitted when matter is rejected.
    }
  }
  // States
  record IntakeStateData is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    matterInfo: MatterInfo with {
      briefly "Info"
      described as {
        |Matter info.
      }
    }
    updatedConflictResult: ConflictCheckResult? with {
      briefly "Conflict"
      described as {
        |Conflict check result.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Intake state data"
    described as {
      |State data for matter in intake.
    }
  }
  record ActiveStateData is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    matterInfo: MatterInfo with {
      briefly "Info"
      described as {
        |Matter info.
      }
    }
    status: MatterStatus with {
      briefly "Status"
      described as {
        |Matter status.
      }
    }
    conflictResult: ConflictCheckResult with {
      briefly "Conflict"
      described as {
        |Conflict check result.
      }
    }
    leadAttorney: TeamMember with {
      briefly "Lead"
      described as {
        |Lead attorney.
      }
    }
    teamMembers: TeamMember* with {
      briefly "Team"
      described as {
        |Team members.
      }
    }
    timeEntries: TimeEntry* with {
      briefly "Time"
      described as {
        |Time entries.
      }
    }
    expenseEntries: ExpenseEntry* with {
      briefly "Expenses"
      described as {
        |Expense entries.
      }
    }
    documents: MatterDocument* with {
      briefly "Documents"
      described as {
        |Attached documents.
      }
    }
    updatedDeadlines: CourtDeadline* with {
      briefly "Deadlines"
      described as {
        |Court deadlines.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active matter.
    }
  }
  record ClosedStateData is  {
    matterId: MatterId with {
      briefly "Matter"
      described as {
        |Matter ID.
      }
    }
    matterInfo: MatterInfo with {
      briefly "Info"
      described as {
        |Matter info.
      }
    }
    closureNotes: String(3,2000) with {
      briefly "Notes"
      described as {
        |Closure notes.
      }
    }
    totalHours: Decimal(8,2) with {
      briefly "Hours"
      described as {
        |Total billable hours.
      }
    }
    totalExpenses: Decimal(12,2) with {
      briefly "Expenses"
      described as {
        |Total expenses.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |State data for closed matter.
    }
  }
  state IntakeState of type LegalMatter.IntakeStateData
  state ActiveState of type LegalMatter.ActiveStateData
  state ClosedState of type LegalMatter.ClosedStateData
  handler LegalMatterHandler is {
    on command CreateMatter is {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.IntakeState with command CreateMatter
      tell event MatterCreated to entity MatterContext.LegalMatter
    }
    on command RecordConflictCheck is {
      tell event ConflictCheckRecorded to entity MatterContext.LegalMatter
    }
    on command AssignTeam is {
      tell event TeamAssigned to entity MatterContext.LegalMatter
    }
    on command ActivateMatter is {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.ActiveState with command ActivateMatter
      tell event MatterActivated to entity MatterContext.LegalMatter
    }
    on command RecordTime is {
      tell event TimeRecorded to entity MatterContext.LegalMatter
    }
    on command RecordExpense is {
      tell event ExpenseRecorded to entity MatterContext.LegalMatter
    }
    on command AttachDocument is {
      tell event DocumentAttached to entity MatterContext.LegalMatter
    }
    on command AddCourtDeadline is {
      tell event CourtDeadlineAdded to entity MatterContext.LegalMatter
    }
    on command CompleteDeadline is {
      tell event DeadlineCompleted to entity MatterContext.LegalMatter
    }
    on command PlaceMatterOnHold is {
      tell event MatterPlacedOnHold to entity MatterContext.LegalMatter
    }
    on command ReactivateMatter is {
      tell event MatterReactivated to entity MatterContext.LegalMatter
    }
    on command CloseMatter is {
      morph entity MatterContext.LegalMatter to state MatterContext.LegalMatter.ClosedState with command CloseMatter
      tell event MatterClosed to entity MatterContext.LegalMatter
    }
    on command RejectMatter is {
      tell event MatterRejected to entity MatterContext.LegalMatter
    }
  } with {
    briefly "Processes legal matter commands"
    described as {
      |Handles legal matter lifecycle.
    }
  }
} with {
  briefly "LegalMatter aggregate"
  described as {
    |Manages legal matter lifecycle and tracking.
  }
}
