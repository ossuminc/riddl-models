// Client Accounting - External Contexts
// Bank Feed Service
context BankFeedService is {
  query GetTransactions is  {
    accountNumber: String(1,50) with {
      briefly "Account"
      described as {
        |Bank account.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Start date.
      }
    }
    endDate: Date with {
      briefly "End"
      described as {
        |End date.
      }
    }
  } with {
    briefly "Get transactions"
    described as {
      |Retrieves bank transactions.
    }
  }
  result BankTransactionsResult is  {
    transactions: BankTransaction+ with {
      briefly "Transactions"
      described as {
        |Bank transactions.
      }
    }
    balance: Decimal(14,2) with {
      briefly "Balance"
      described as {
        |Ending balance.
      }
    }
  } with {
    briefly "Bank transactions result"
    described as {
      |Bank transaction data.
    }
  }
  type BankTransaction is {
    transactionDate: Date with {
      briefly "Date"
      described as {
        |Transaction date.
      }
    }
    description: String(1,200) with {
      briefly "Description"
      described as {
        |Transaction description.
      }
    }
    transactionAmount: Decimal(12,2) with {
      briefly "Amount"
      described as {
        |Transaction amount.
      }
    }
    bankTransactionType: String(1,20) with {
      briefly "Type"
      described as {
        |Debit or credit.
      }
    }
    reference: String(1,100)? with {
      briefly "Reference"
      described as {
        |Check/reference number.
      }
    }
  } with {
    briefly "Bank transaction"
    described as {
      |Single bank transaction.
    }
  }
} with {
  option external()
  briefly "External bank feed"
  described as {
    |Bank transaction feed service.
  }
}
// Document Storage Service
context DocumentStorageService is {
  command StoreDocument is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    documentType: String(1,100) with {
      briefly "Type"
      described as {
        |Document type.
      }
    }
    fileName: String(1,255) with {
      briefly "File"
      described as {
        |File name.
      }
    }
  } with {
    briefly "Store document"
    described as {
      |Stores workpaper or document.
    }
  }
  event DocumentStored is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    storedAt: TimeStamp with {
      briefly "Stored"
      described as {
        |Storage time.
      }
    }
  } with {
    briefly "Document stored"
    described as {
      |Emitted when document is stored.
    }
  }
  query RetrieveDocument is  {
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
  } with {
    briefly "Retrieve document"
    described as {
      |Retrieves stored document.
    }
  }
  result DocumentResult is  {
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    downloadUrl: String(1,500) with {
      briefly "URL"
      described as {
        |Download URL.
      }
    }
    expiresAt: TimeStamp with {
      briefly "Expires"
      described as {
        |URL expiration.
      }
    }
  } with {
    briefly "Document result"
    described as {
      |Document retrieval result.
    }
  }
} with {
  option external()
  briefly "External document service"
  described as {
    |Workpaper and document storage.
  }
}
// Tax Service
context TaxService is {
  query GetTaxRates is  {
    jurisdiction: String(1,100) with {
      briefly "Jurisdiction"
      described as {
        |Tax jurisdiction.
      }
    }
    taxYear: Natural with {
      briefly "Year"
      described as {
        |Tax year.
      }
    }
  } with {
    briefly "Get tax rates"
    described as {
      |Retrieves tax rates.
    }
  }
  result TaxRatesResult is  {
    rates: TaxRate+ with {
      briefly "Rates"
      described as {
        |Tax rates.
      }
    }
  } with {
    briefly "Tax rates result"
    described as {
      |Tax rate information.
    }
  }
  type TaxRate is {
    rateType: String(1,100) with {
      briefly "Type"
      described as {
        |Rate type.
      }
    }
    taxRate: Decimal(6,4) with {
      briefly "Rate"
      described as {
        |Tax rate.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Tax rate"
    described as {
      |Individual tax rate.
    }
  }
  command CalculateTaxLiability is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    taxYear: Natural with {
      briefly "Year"
      described as {
        |Tax year.
      }
    }
    taxableIncome: Decimal(14,2) with {
      briefly "Income"
      described as {
        |Taxable income.
      }
    }
  } with {
    briefly "Calculate tax liability"
    described as {
      |Calculates tax liability.
    }
  }
  event TaxLiabilityCalculated is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    taxYear: Natural with {
      briefly "Year"
      described as {
        |Tax year.
      }
    }
    liability: Decimal(12,2) with {
      briefly "Liability"
      described as {
        |Tax liability.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Tax liability calculated"
    described as {
      |Emitted when liability is calculated.
    }
  }
} with {
  option external()
  briefly "External tax service"
  described as {
    |Tax rate and calculation service.
  }
}
// Payment Processing Service
context PaymentProcessingService is {
  command ProcessPayment is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    invoiceNumber: String(1,50) with {
      briefly "Invoice"
      described as {
        |Invoice number.
      }
    }
    paymentAmount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    paymentMethod: String(1,50) with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
  } with {
    briefly "Process payment"
    described as {
      |Processes client payment.
    }
  }
  event PaymentProcessed is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    invoiceNumber: String(1,50) with {
      briefly "Invoice"
      described as {
        |Invoice number.
      }
    }
    confirmationNumber: String(1,50) with {
      briefly "Confirmation"
      described as {
        |Confirmation number.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Processing time.
      }
    }
  } with {
    briefly "Payment processed"
    described as {
      |Emitted when payment completes.
    }
  }
} with {
  option external()
  briefly "External payment service"
  described as {
    |Client payment processing.
  }
}
// Client Portal Service
context ClientPortalService is {
  command PublishDocument is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    documentType: String(1,100) with {
      briefly "Type"
      described as {
        |Document type.
      }
    }
  } with {
    briefly "Publish document"
    described as {
      |Publishes document to portal.
    }
  }
  event DocumentPublished is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    publishedAt: TimeStamp with {
      briefly "Published"
      described as {
        |Publish time.
      }
    }
  } with {
    briefly "Document published"
    described as {
      |Emitted when document is published.
    }
  }
  event ClientAccessedDocument is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    documentId: UUID with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    accessedAt: TimeStamp with {
      briefly "Accessed"
      described as {
        |Access time.
      }
    }
  } with {
    briefly "Client accessed document"
    described as {
      |Emitted when client views document.
    }
  }
} with {
  option external()
  briefly "External client portal"
  described as {
    |Client document portal.
  }
}
