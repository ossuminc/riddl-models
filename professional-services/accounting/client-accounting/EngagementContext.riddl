// Client Accounting - Engagement Context

context EngagementContext is {

  include "types.riddl"
  include "Engagement.riddl"

  // Repository
  repository EngagementRepository is {

    query FindEngagementById is {
      engagementId is EngagementId with {
        briefly "Engagement"
        described by "Engagement identifier."
      }
    } with {
      briefly "Find engagement by ID"
      described by "Retrieves engagement by identifier."
    }

    result EngagementResult is {
      engagement is Engagement.ActiveStateData with {
        briefly "Engagement"
        described by "Engagement data."
      }
    } with {
      briefly "Engagement result"
      described by "Returns engagement data."
    }

    query SearchEngagements is {
      filterStatus is optional EngagementStatus with {
        briefly "Status"
        described by "Filter by status."
      }
      filterAccountantId is optional AccountantId with {
        briefly "Accountant"
        described by "Filter by accountant."
      }
      filterServiceType is optional ServiceType with {
        briefly "Service"
        described by "Filter by service type."
      }
    } with {
      briefly "Search engagements"
      described by "Searches engagements by criteria."
    }

    result EngagementsResult is {
      engagements is many Engagement.ActiveStateData with {
        briefly "Engagements"
        described by "Matching engagements."
      }
      totalCount is Natural with {
        briefly "Count"
        described by "Total matches."
      }
    } with {
      briefly "Engagements result"
      described by "Returns matching engagements."
    }

    query FindByClient is {
      clientId is ClientId with {
        briefly "Client"
        described by "Client identifier."
      }
    } with {
      briefly "Find by client"
      described by "Finds engagements for client."
    }

    query GetTrialBalance is {
      engagementId is EngagementId with {
        briefly "Engagement"
        described by "Engagement identifier."
      }
      asOfDate is Date with {
        briefly "Date"
        described by "As-of date."
      }
    } with {
      briefly "Get trial balance"
      described by "Generates trial balance."
    }

    handler EngagementRepositoryHandler is {
      on query FindEngagementById {
        ???
      }
      on query SearchEngagements {
        ???
      }
      on query FindByClient {
        ???
      }
      on query GetTrialBalance {
        ???
      }
    } with {
      briefly "Handles repository queries"
      described by "Processes engagement queries."
    }

  } with {
    briefly "Engagement repository"
    described by "Persistence for engagement records."
  }

  // Projector for billing analytics
  projector BillingAnalytics is {

    record AnalyticsData is {
      totalBillableHours is Decimal(10, 2) with {
        briefly "Hours"
        described by "Total billable hours."
      }
      totalFeesBilled is Decimal(12, 2) with {
        briefly "Billed"
        described by "Total fees billed."
      }
      totalCollected is Decimal(12, 2) with {
        briefly "Collected"
        described by "Total collected."
      }
      outstandingAR is Decimal(12, 2) with {
        briefly "AR"
        described by "Outstanding receivables."
      }
      utilizationByAccountant is many AccountantUtilization with {
        briefly "Utilization"
        described by "Utilization by accountant."
      }
      revenueByServiceType is many ServiceRevenue with {
        briefly "By service"
        described by "Revenue by service type."
      }
    } with {
      briefly "Analytics data"
      described by "Billing metrics."
    }

    record AccountantUtilization is {
      accountantId is AccountantId with {
        briefly "Accountant"
        described by "Accountant ID."
      }
      billableHours is Decimal(8, 2) with {
        briefly "Billable"
        described by "Billable hours."
      }
      totalHours is Decimal(8, 2) with {
        briefly "Total"
        described by "Total hours."
      }
      utilizationRate is Decimal(5, 2) with {
        briefly "Rate"
        described by "Utilization percentage."
      }
    } with {
      briefly "Accountant utilization"
      described by "Utilization for accountant."
    }

    record ServiceRevenue is {
      serviceType is ServiceType with {
        briefly "Service"
        described by "Service type."
      }
      revenue is Decimal(12, 2) with {
        briefly "Revenue"
        described by "Service revenue."
      }
    } with {
      briefly "Service revenue"
      described by "Revenue for service type."
    }

    handler AnalyticsHandler is {
      on event Engagement.TimeRecorded {
        ???
      }
      on event Engagement.InvoiceGenerated {
        ???
      }
      on event Engagement.PaymentRecorded {
        ???
      }
    } with {
      briefly "Processes analytics events"
      described by "Updates billing analytics."
    }

  } with {
    briefly "Billing analytics"
    described by "Projects billing metrics for reporting."
  }

} with {
  briefly "Engagement context"
  described by {
    | The Engagement context manages client
    | accounting engagements.
  }
}
