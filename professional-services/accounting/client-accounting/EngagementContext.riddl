// Client Accounting - Engagement Context
context EngagementContext is {
  include "types.riddl"
  include "Engagement.riddl"
  // Repository
  repository EngagementRepository is {
    query FindEngagementById is  {
      engagementId: EngagementId with {
        briefly "Engagement"
        described as {
          |Engagement identifier.
        }
      }
    } with {
      briefly "Find engagement by ID"
      described as {
        |Retrieves engagement by identifier.
      }
    }
    result EngagementResult is  {
      engagement: Engagement.ActiveStateData with {
        briefly "Engagement"
        described as {
          |Engagement data.
        }
      }
    } with {
      briefly "Engagement result"
      described as {
        |Returns engagement data.
      }
    }
    query SearchEngagements is  {
      filterStatus: EngagementStatus? with {
        briefly "Status"
        described as {
          |Filter by status.
        }
      }
      filterAccountantId: AccountantId? with {
        briefly "Accountant"
        described as {
          |Filter by accountant.
        }
      }
      filterServiceType: ServiceType? with {
        briefly "Service"
        described as {
          |Filter by service type.
        }
      }
    } with {
      briefly "Search engagements"
      described as {
        |Searches engagements by criteria.
      }
    }
    result EngagementsResult is  {
      engagements: Engagement.ActiveStateData+ with {
        briefly "Engagements"
        described as {
          |Matching engagements.
        }
      }
      totalCount: Natural with {
        briefly "Count"
        described as {
          |Total matches.
        }
      }
    } with {
      briefly "Engagements result"
      described as {
        |Returns matching engagements.
      }
    }
    query FindByClient is  {
      clientId: ClientId with {
        briefly "Client"
        described as {
          |Client identifier.
        }
      }
    } with {
      briefly "Find by client"
      described as {
        |Finds engagements for client.
      }
    }
    query GetTrialBalance is  {
      engagementId: EngagementId with {
        briefly "Engagement"
        described as {
          |Engagement identifier.
        }
      }
      asOfDate: Date with {
        briefly "Date"
        described as {
          |As-of date.
        }
      }
    } with {
      briefly "Get trial balance"
      described as {
        |Generates trial balance.
      }
    }
    handler EngagementRepositoryHandler is {
      on query FindEngagementById is { ??? }
      on query SearchEngagements is { ??? }
      on query FindByClient is { ??? }
      on query GetTrialBalance is { ??? }
    } with {
      briefly "Handles repository queries"
      described as {
        |Processes engagement queries.
      }
    }
  } with {
    briefly "Engagement repository"
    described as {
      |Persistence for engagement records.
    }
  }
  // Projector for billing analytics
  projector BillingAnalytics is {
    record AnalyticsData is  {
      totalBillableHours: Decimal(10,2) with {
        briefly "Hours"
        described as {
          |Total billable hours.
        }
      }
      totalFeesBilled: Decimal(12,2) with {
        briefly "Billed"
        described as {
          |Total fees billed.
        }
      }
      totalCollected: Decimal(12,2) with {
        briefly "Collected"
        described as {
          |Total collected.
        }
      }
      outstandingAR: Decimal(12,2) with {
        briefly "AR"
        described as {
          |Outstanding receivables.
        }
      }
      utilizationByAccountant: AccountantUtilization+ with {
        briefly "Utilization"
        described as {
          |Utilization by accountant.
        }
      }
      revenueByServiceType: ServiceRevenue+ with {
        briefly "By service"
        described as {
          |Revenue by service type.
        }
      }
    } with {
      briefly "Analytics data"
      described as {
        |Billing metrics.
      }
    }
    record AccountantUtilization is  {
      accountantId: AccountantId with {
        briefly "Accountant"
        described as {
          |Accountant ID.
        }
      }
      billableHours: Decimal(8,2) with {
        briefly "Billable"
        described as {
          |Billable hours.
        }
      }
      totalHours: Decimal(8,2) with {
        briefly "Total"
        described as {
          |Total hours.
        }
      }
      utilizationRate: Decimal(5,2) with {
        briefly "Rate"
        described as {
          |Utilization percentage.
        }
      }
    } with {
      briefly "Accountant utilization"
      described as {
        |Utilization for accountant.
      }
    }
    record ServiceRevenue is  {
      serviceType: ServiceType with {
        briefly "Service"
        described as {
          |Service type.
        }
      }
      revenue: Decimal(12,2) with {
        briefly "Revenue"
        described as {
          |Service revenue.
        }
      }
    } with {
      briefly "Service revenue"
      described as {
        |Revenue for service type.
      }
    }
    handler AnalyticsHandler is {
      on event Engagement.TimeRecorded is { ??? }
      on event Engagement.InvoiceGenerated is { ??? }
      on event Engagement.PaymentRecorded is { ??? }
    } with {
      briefly "Processes analytics events"
      described as {
        |Updates billing analytics.
      }
    }
  } with {
    briefly "Billing analytics"
    described as {
      |Projects billing metrics for reporting.
    }
  }
} with {
  briefly "Engagement context"
  described as {
    | The Engagement context manages client
    | accounting engagements.
  }
}
