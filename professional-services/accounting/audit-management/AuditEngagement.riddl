// Audit Management - AuditEngagement Entity

entity AuditEngagement is {

  command CreateEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "New engagement identifier."
    }
    engagementInfo is EngagementInfo with {
      briefly "Engagement info"
      described by "Audit engagement details."
    }
    leadPartner is AuditorId with {
      briefly "Lead partner"
      described by "Engagement lead partner."
    }
  } with {
    briefly "Create engagement"
    described by "Creates a new audit engagement."
  }

  command AssignTeam is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    teamMembers is many TeamMember with {
      briefly "Team members"
      described by "Audit team assignments."
    }
  } with {
    briefly "Assign team"
    described by "Assigns audit team to engagement."
  }

  command BeginFieldwork is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    startDate is Date with {
      briefly "Start date"
      described by "Fieldwork start date."
    }
  } with {
    briefly "Begin fieldwork"
    described by "Begins audit fieldwork phase."
  }

  command AddWorkpaper is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    workpaper is Workpaper with {
      briefly "Workpaper"
      described by "Workpaper to add."
    }
  } with {
    briefly "Add workpaper"
    described by "Adds a workpaper to the engagement."
  }

  command SubmitWorkpaperForReview is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    workpaperId is WorkpaperId with {
      briefly "Workpaper ID"
      described by "Workpaper to submit."
    }
    reviewerId is AuditorId with {
      briefly "Reviewer"
      described by "Assigned reviewer."
    }
  } with {
    briefly "Submit workpaper for review"
    described by "Submits workpaper to review cycle."
  }

  command CompleteWorkpaperReview is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    workpaperId is WorkpaperId with {
      briefly "Workpaper ID"
      described by "Workpaper reviewed."
    }
    reviewCycle is ReviewCycle with {
      briefly "Review cycle"
      described by "Review cycle details."
    }
  } with {
    briefly "Complete workpaper review"
    described by "Completes a workpaper review cycle."
  }

  command RecordFinding is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    finding is AuditFinding with {
      briefly "Finding"
      described by "Audit finding to record."
    }
  } with {
    briefly "Record finding"
    described by "Records an audit finding."
  }

  command DraftReport is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    report is AuditReport with {
      briefly "Report"
      described by "Draft audit report."
    }
  } with {
    briefly "Draft report"
    described by "Drafts the audit report."
  }

  command SubmitReportForReview is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    reviewerId is AuditorId with {
      briefly "Reviewer"
      described by "Report reviewer."
    }
  } with {
    briefly "Submit report for review"
    described by "Submits audit report for partner review."
  }

  command IssueReport is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    issuedDate is Date with {
      briefly "Issued date"
      described by "Report issue date."
    }
    approvedBy is AuditorId with {
      briefly "Approved by"
      described by "Partner who approved report."
    }
  } with {
    briefly "Issue report"
    described by "Issues the final audit report."
  }

  command CloseEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    closedDate is Date with {
      briefly "Closed date"
      described by "Engagement close date."
    }
  } with {
    briefly "Close engagement"
    described by "Closes the audit engagement."
  }

  command CancelEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel engagement"
    described by "Cancels the audit engagement."
  }

  // Events
  event EngagementCreated is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    engagementInfo is EngagementInfo with { briefly "Info" described by "Engagement info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Engagement created"
    described by "Emitted when engagement is created."
  }

  event TeamAssigned is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    memberCount is Natural with { briefly "Members" described by "Team member count." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Team assigned"
    described by "Emitted when audit team is assigned."
  }

  event FieldworkBegan is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    startDate is Date with { briefly "Start" described by "Fieldwork start date." }
    beganAt is TimeStamp with { briefly "Began" described by "Begin time." }
  } with {
    briefly "Fieldwork began"
    described by "Emitted when fieldwork begins."
  }

  event WorkpaperAdded is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    workpaperId is WorkpaperId with { briefly "Workpaper" described by "Workpaper ID." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Workpaper added"
    described by "Emitted when workpaper is added."
  }

  event WorkpaperSubmittedForReview is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    workpaperId is WorkpaperId with { briefly "Workpaper" described by "Workpaper ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Workpaper submitted for review"
    described by "Emitted when workpaper enters review."
  }

  event WorkpaperReviewCompleted is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    workpaperId is WorkpaperId with { briefly "Workpaper" described by "Workpaper ID." }
    status is ReviewStatus with { briefly "Status" described by "Review decision." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Workpaper review completed"
    described by "Emitted when workpaper review is completed."
  }

  event FindingRecorded is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    findingId is FindingId with { briefly "Finding" described by "Finding ID." }
    severity is FindingSeverity with { briefly "Severity" described by "Finding severity." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Finding recorded"
    described by "Emitted when an audit finding is recorded."
  }

  event ReportDrafted is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    reportTitle is String(3, 300) with { briefly "Title" described by "Report title." }
    draftedAt is TimeStamp with { briefly "Drafted" described by "Draft time." }
  } with {
    briefly "Report drafted"
    described by "Emitted when audit report is drafted."
  }

  event ReportSubmittedForReview is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    reviewerId is AuditorId with { briefly "Reviewer" described by "Reviewer ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Report submitted for review"
    described by "Emitted when report enters partner review."
  }

  event ReportIssued is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    issuedDate is Date with { briefly "Issued" described by "Issue date." }
    issuedAt is TimeStamp with { briefly "Issued at" described by "Issue time." }
  } with {
    briefly "Report issued"
    described by "Emitted when audit report is issued."
  }

  event EngagementClosed is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    closedDate is Date with { briefly "Closed" described by "Close date." }
    closedAt is TimeStamp with { briefly "Closed at" described by "Close time." }
  } with {
    briefly "Engagement closed"
    described by "Emitted when engagement is closed."
  }

  event EngagementCancelled is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Engagement cancelled"
    described by "Emitted when engagement is cancelled."
  }

  // States
  record ActiveEngagementData is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    engagementInfo is EngagementInfo with { briefly "Info" described by "Engagement info." }
    leadPartner is AuditorId with { briefly "Lead partner" described by "Lead partner ID." }
    status is EngagementStatus with { briefly "Status" described by "Engagement status." }
    teamMembers is many optional TeamMember with { briefly "Team" described by "Team members." }
    workpapers is many optional Workpaper with { briefly "Workpapers" described by "Engagement workpapers." }
    findings is many optional AuditFinding with { briefly "Findings" described by "Audit findings." }
    report is optional AuditReport with { briefly "Report" described by "Audit report." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active engagement state"
    described by "State for an active audit engagement."
  }

  record ClosedEngagementData is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    reportTitle is String(3, 300) with { briefly "Report title" described by "Final report title." }
    issuedDate is Date with { briefly "Issued date" described by "Report issue date." }
    closedDate is Date with { briefly "Closed date" described by "Engagement close date." }
  } with {
    briefly "Closed engagement state"
    described by "State for a closed audit engagement."
  }

  state ActiveEngagement of AuditEngagement.ActiveEngagementData with {
    briefly "Engagement active"
    described by "Audit engagement is in progress."
  }

  state ClosedEngagement of AuditEngagement.ClosedEngagementData with {
    briefly "Engagement closed"
    described by "Audit engagement is closed."
  }

  handler AuditEngagementHandler is {
    on command CreateEngagement {
      morph entity AuditContext.AuditEngagement to state AuditContext.AuditEngagement.ActiveEngagement with command CreateEngagement
      tell event EngagementCreated to entity AuditContext.AuditEngagement
    }
    on command AssignTeam {
      tell event TeamAssigned to entity AuditContext.AuditEngagement
    }
    on command BeginFieldwork {
      tell event FieldworkBegan to entity AuditContext.AuditEngagement
    }
    on command AddWorkpaper {
      tell event WorkpaperAdded to entity AuditContext.AuditEngagement
    }
    on command SubmitWorkpaperForReview {
      tell event WorkpaperSubmittedForReview to entity AuditContext.AuditEngagement
    }
    on command CompleteWorkpaperReview {
      tell event WorkpaperReviewCompleted to entity AuditContext.AuditEngagement
    }
    on command RecordFinding {
      tell event FindingRecorded to entity AuditContext.AuditEngagement
    }
    on command DraftReport {
      tell event ReportDrafted to entity AuditContext.AuditEngagement
    }
    on command SubmitReportForReview {
      tell event ReportSubmittedForReview to entity AuditContext.AuditEngagement
    }
    on command IssueReport {
      morph entity AuditContext.AuditEngagement to state AuditContext.AuditEngagement.ClosedEngagement with command IssueReport
      tell event ReportIssued to entity AuditContext.AuditEngagement
    }
    on command CloseEngagement {
      tell event EngagementClosed to entity AuditContext.AuditEngagement
    }
    on command CancelEngagement {
      tell event EngagementCancelled to entity AuditContext.AuditEngagement
    }
  } with {
    briefly "Processes audit engagement commands"
    described by "Handles audit engagement lifecycle."
  }

} with {
  briefly "AuditEngagement aggregate"
  described by "Manages audit engagements through their lifecycle."
}
