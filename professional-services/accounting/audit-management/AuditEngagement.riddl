// Audit Management - AuditEngagement Entity
entity AuditEngagement is {
  command CreateEngagement is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |New engagement identifier.
      }
    }
    engagementInfo: EngagementInfo with {
      briefly "Engagement info"
      described as {
        |Audit engagement details.
      }
    }
    leadPartner: AuditorId with {
      briefly "Lead partner"
      described as {
        |Engagement lead partner.
      }
    }
  } with {
    briefly "Create engagement"
    described as {
      |Creates a new audit engagement.
    }
  }
  command AssignTeam is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    teamMembers: TeamMember+ with {
      briefly "Team members"
      described as {
        |Audit team assignments.
      }
    }
  } with {
    briefly "Assign team"
    described as {
      |Assigns audit team to engagement.
    }
  }
  command BeginFieldwork is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    startDate: Date with {
      briefly "Start date"
      described as {
        |Fieldwork start date.
      }
    }
  } with {
    briefly "Begin fieldwork"
    described as {
      |Begins audit fieldwork phase.
    }
  }
  command AddWorkpaper is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    workpaper: Workpaper with {
      briefly "Workpaper"
      described as {
        |Workpaper to add.
      }
    }
  } with {
    briefly "Add workpaper"
    described as {
      |Adds a workpaper to the engagement.
    }
  }
  command SubmitWorkpaperForReview is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    workpaperId: WorkpaperId with {
      briefly "Workpaper ID"
      described as {
        |Workpaper to submit.
      }
    }
    reviewerId: AuditorId with {
      briefly "Reviewer"
      described as {
        |Assigned reviewer.
      }
    }
  } with {
    briefly "Submit workpaper for review"
    described as {
      |Submits workpaper to review cycle.
    }
  }
  command CompleteWorkpaperReview is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    workpaperId: WorkpaperId with {
      briefly "Workpaper ID"
      described as {
        |Workpaper reviewed.
      }
    }
    reviewCycle: ReviewCycle with {
      briefly "Review cycle"
      described as {
        |Review cycle details.
      }
    }
  } with {
    briefly "Complete workpaper review"
    described as {
      |Completes a workpaper review cycle.
    }
  }
  command RecordFinding is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    finding: AuditFinding with {
      briefly "Finding"
      described as {
        |Audit finding to record.
      }
    }
  } with {
    briefly "Record finding"
    described as {
      |Records an audit finding.
    }
  }
  command DraftReport is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    report: AuditReport with {
      briefly "Report"
      described as {
        |Draft audit report.
      }
    }
  } with {
    briefly "Draft report"
    described as {
      |Drafts the audit report.
    }
  }
  command SubmitReportForReview is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    reviewerId: AuditorId with {
      briefly "Reviewer"
      described as {
        |Report reviewer.
      }
    }
  } with {
    briefly "Submit report for review"
    described as {
      |Submits audit report for partner review.
    }
  }
  command IssueReport is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    issuedDate: Date with {
      briefly "Issued date"
      described as {
        |Report issue date.
      }
    }
    approvedBy: AuditorId with {
      briefly "Approved by"
      described as {
        |Partner who approved report.
      }
    }
  } with {
    briefly "Issue report"
    described as {
      |Issues the final audit report.
    }
  }
  command CloseEngagement is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    closedDate: Date with {
      briefly "Closed date"
      described as {
        |Engagement close date.
      }
    }
  } with {
    briefly "Close engagement"
    described as {
      |Closes the audit engagement.
    }
  }
  command CancelEngagement is  {
    engagementId: EngagementId with {
      briefly "Engagement ID"
      described as {
        |Engagement identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel engagement"
    described as {
      |Cancels the audit engagement.
    }
  }
  // Events
  event EngagementCreated is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    engagementInfo: EngagementInfo with {
      briefly "Info"
      described as {
        |Engagement info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Engagement created"
    described as {
      |Emitted when engagement is created.
    }
  }
  event TeamAssigned is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    memberCount: Natural with {
      briefly "Members"
      described as {
        |Team member count.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Team assigned"
    described as {
      |Emitted when audit team is assigned.
    }
  }
  event FieldworkBegan is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Fieldwork start date.
      }
    }
    beganAt: TimeStamp with {
      briefly "Began"
      described as {
        |Begin time.
      }
    }
  } with {
    briefly "Fieldwork began"
    described as {
      |Emitted when fieldwork begins.
    }
  }
  event WorkpaperAdded is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    workpaperId: WorkpaperId with {
      briefly "Workpaper"
      described as {
        |Workpaper ID.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Workpaper added"
    described as {
      |Emitted when workpaper is added.
    }
  }
  event WorkpaperSubmittedForReview is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    workpaperId: WorkpaperId with {
      briefly "Workpaper"
      described as {
        |Workpaper ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Workpaper submitted for review"
    described as {
      |Emitted when workpaper enters review.
    }
  }
  event WorkpaperReviewCompleted is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    workpaperId: WorkpaperId with {
      briefly "Workpaper"
      described as {
        |Workpaper ID.
      }
    }
    reviewStatus: ReviewStatus with {
      briefly "Status"
      described as {
        |Review decision.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Workpaper review completed"
    described as {
      |Emitted when workpaper review is completed.
    }
  }
  event FindingRecorded is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    findingId: FindingId with {
      briefly "Finding"
      described as {
        |Finding ID.
      }
    }
    severity: FindingSeverity with {
      briefly "Severity"
      described as {
        |Finding severity.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Finding recorded"
    described as {
      |Emitted when an audit finding is recorded.
    }
  }
  event ReportDrafted is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    reportTitle: String(3,300) with {
      briefly "Title"
      described as {
        |Report title.
      }
    }
    draftedAt: TimeStamp with {
      briefly "Drafted"
      described as {
        |Draft time.
      }
    }
  } with {
    briefly "Report drafted"
    described as {
      |Emitted when audit report is drafted.
    }
  }
  event ReportSubmittedForReview is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    reviewerId: AuditorId with {
      briefly "Reviewer"
      described as {
        |Reviewer ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Report submitted for review"
    described as {
      |Emitted when report enters partner review.
    }
  }
  event ReportIssued is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    issuedDate: Date with {
      briefly "Issued"
      described as {
        |Issue date.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued at"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Report issued"
    described as {
      |Emitted when audit report is issued.
    }
  }
  event EngagementClosed is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    closedDate: Date with {
      briefly "Closed"
      described as {
        |Close date.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed at"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Engagement closed"
    described as {
      |Emitted when engagement is closed.
    }
  }
  event EngagementCancelled is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Engagement cancelled"
    described as {
      |Emitted when engagement is cancelled.
    }
  }
  // States
  record ActiveEngagementData is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    engagementInfo: EngagementInfo with {
      briefly "Info"
      described as {
        |Engagement info.
      }
    }
    leadPartner: AuditorId with {
      briefly "Lead partner"
      described as {
        |Lead partner ID.
      }
    }
    status: EngagementStatus with {
      briefly "Status"
      described as {
        |Engagement status.
      }
    }
    updatedTeamMembers: TeamMember* with {
      briefly "Team"
      described as {
        |Team members.
      }
    }
    workpapers: Workpaper* with {
      briefly "Workpapers"
      described as {
        |Engagement workpapers.
      }
    }
    updatedFindings: AuditFinding* with {
      briefly "Findings"
      described as {
        |Audit findings.
      }
    }
    updatedReport: AuditReport? with {
      briefly "Report"
      described as {
        |Audit report.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active engagement state"
    described as {
      |State for an active audit engagement.
    }
  }
  record ClosedEngagementData is  {
    engagementId: EngagementId with {
      briefly "Engagement"
      described as {
        |Engagement ID.
      }
    }
    reportTitle: String(3,300) with {
      briefly "Report title"
      described as {
        |Final report title.
      }
    }
    issuedDate: Date with {
      briefly "Issued date"
      described as {
        |Report issue date.
      }
    }
    closedDate: Date with {
      briefly "Closed date"
      described as {
        |Engagement close date.
      }
    }
  } with {
    briefly "Closed engagement state"
    described as {
      |State for a closed audit engagement.
    }
  }
  state ActiveEngagement of type AuditEngagement.ActiveEngagementData
  state ClosedEngagement of type AuditEngagement.ClosedEngagementData
  handler AuditEngagementHandler is {
    on command CreateEngagement is {
      morph entity AuditContext.AuditEngagement to state AuditContext.AuditEngagement.ActiveEngagement with command CreateEngagement
      tell event EngagementCreated to entity AuditContext.AuditEngagement
    }
    on command AssignTeam is {
      tell event TeamAssigned to entity AuditContext.AuditEngagement
    }
    on command BeginFieldwork is {
      tell event FieldworkBegan to entity AuditContext.AuditEngagement
    }
    on command AddWorkpaper is {
      tell event WorkpaperAdded to entity AuditContext.AuditEngagement
    }
    on command SubmitWorkpaperForReview is {
      tell event WorkpaperSubmittedForReview to entity AuditContext.AuditEngagement
    }
    on command CompleteWorkpaperReview is {
      tell event WorkpaperReviewCompleted to entity AuditContext.AuditEngagement
    }
    on command RecordFinding is {
      tell event FindingRecorded to entity AuditContext.AuditEngagement
    }
    on command DraftReport is {
      tell event ReportDrafted to entity AuditContext.AuditEngagement
    }
    on command SubmitReportForReview is {
      tell event ReportSubmittedForReview to entity AuditContext.AuditEngagement
    }
    on command IssueReport is {
      morph entity AuditContext.AuditEngagement to state AuditContext.AuditEngagement.ClosedEngagement with command IssueReport
      tell event ReportIssued to entity AuditContext.AuditEngagement
    }
    on command CloseEngagement is {
      tell event EngagementClosed to entity AuditContext.AuditEngagement
    }
    on command CancelEngagement is {
      tell event EngagementCancelled to entity AuditContext.AuditEngagement
    }
  } with {
    briefly "Processes audit engagement commands"
    described as {
      |Handles audit engagement lifecycle.
    }
  }
} with {
  briefly "AuditEngagement aggregate"
  described as {
    |Manages audit engagements through their lifecycle.
  }
}
