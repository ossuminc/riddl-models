// Audit Management - Audit Context
context AuditContext is {
  include "types.riddl"
  include "AuditEngagement.riddl"
  repository AuditRepository is {
    schema AuditData is relational
      of engagements as type AuditEngagement
        index on field AuditEngagement.engagementId
        index on field AuditEngagement.engagementInfo.clientId
        index on field AuditEngagement.status

    handler AuditPersistence is {
      on command AuditEngagement.CreateEngagement is {
        prompt "Store new audit engagement"
      }
      on command AuditEngagement.AssignTeam is {
        prompt "Update engagement team assignments"
      }
      on command AuditEngagement.BeginFieldwork is {
        prompt "Update engagement to in-progress"
      }
      on command AuditEngagement.AddWorkpaper is {
        prompt "Store new workpaper"
      }
      on command AuditEngagement.CompleteWorkpaperReview is {
        prompt "Update workpaper review status"
      }
      on command AuditEngagement.RecordFinding is {
        prompt "Store audit finding"
      }
      on command AuditEngagement.IssueReport is {
        prompt "Update engagement to report issued"
      }
      on command AuditEngagement.CloseEngagement is {
        prompt "Update engagement to closed"
      }
    } with {
      briefly "Persists audit commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Audit data persistence"
    described as {
      |Persistent storage for audit engagements.
    }
  }
  projector AuditMetrics is {
    record EngagementMetrics is  {
      engagementsPlanned: Natural with {
        briefly "Planned"
        described as {
          |Engagements planned.
        }
      }
      engagementsInProgress: Natural with {
        briefly "In progress"
        described as {
          |Engagements in progress.
        }
      }
      reportsIssued: Natural with {
        briefly "Issued"
        described as {
          |Reports issued.
        }
      }
      totalFindings: Natural with {
        briefly "Findings"
        described as {
          |Total findings recorded.
        }
      }
      criticalFindings: Natural with {
        briefly "Critical"
        described as {
          |Critical findings recorded.
        }
      }
      averageEngagementDays: Decimal(8,2) with {
        briefly "Avg days"
        described as {
          |Average engagement duration in days.
        }
      }
    } with {
      briefly "Engagement metrics"
      described as {
        |Audit engagement metrics.
      }
    }
    handler MetricsHandler is {
      on event AuditEngagement.EngagementCreated is {
        prompt "Increment engagements planned"
      }
      on event AuditEngagement.FieldworkBegan is {
        prompt "Increment engagements in progress"
      }
      on event AuditEngagement.ReportIssued is {
        prompt "Increment reports issued and calculate duration"
      }
      on event AuditEngagement.FindingRecorded is {
        prompt "Increment findings count by severity"
      }
    } with {
      briefly "Maintains audit metrics"
      described as {
        |Projects events into audit metrics.
      }
    }
  } with {
    briefly "Audit metrics"
    described as {
      |Audit engagement analytics.
    }
  }
} with {
  briefly "Bounded context for audit management"
  described as {
    |Audit engagement management context.
  }
}
