// Audit Management - Audit Context

context AuditContext is {

  include "types.riddl"
  include "AuditEngagement.riddl"

  repository AuditRepository is {
    schema AuditData is relational
      of engagements as AuditEngagement
      index on field AuditEngagement.engagementId
      index on field AuditEngagement.engagementInfo.clientId
      index on field AuditEngagement.status

    handler AuditPersistence is {
      on event AuditEngagement.EngagementCreated {
        prompt "Store new audit engagement"
      }
      on event AuditEngagement.TeamAssigned {
        prompt "Update engagement team assignments"
      }
      on event AuditEngagement.FieldworkBegan {
        prompt "Update engagement to in-progress"
      }
      on event AuditEngagement.WorkpaperAdded {
        prompt "Store new workpaper"
      }
      on event AuditEngagement.WorkpaperReviewCompleted {
        prompt "Update workpaper review status"
      }
      on event AuditEngagement.FindingRecorded {
        prompt "Store audit finding"
      }
      on event AuditEngagement.ReportIssued {
        prompt "Update engagement to report issued"
      }
      on event AuditEngagement.EngagementClosed {
        prompt "Update engagement to closed"
      }
    } with {
      briefly "Persists audit events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Audit data persistence"
    described by "Persistent storage for audit engagements."
  }

  projector AuditMetrics is {
    updates repository AuditRepository

    record EngagementMetrics is {
      engagementsPlanned is Natural with { briefly "Planned" described by "Engagements planned." }
      engagementsInProgress is Natural with { briefly "In progress" described by "Engagements in progress." }
      reportsIssued is Natural with { briefly "Issued" described by "Reports issued." }
      totalFindings is Natural with { briefly "Findings" described by "Total findings recorded." }
      criticalFindings is Natural with { briefly "Critical" described by "Critical findings recorded." }
      averageEngagementDays is Decimal(8, 2) with { briefly "Avg days" described by "Average engagement duration in days." }
    } with {
      briefly "Engagement metrics"
      described by "Audit engagement metrics."
    }

    handler MetricsHandler is {
      on event AuditEngagement.EngagementCreated {
        prompt "Increment engagements planned"
      }
      on event AuditEngagement.FieldworkBegan {
        prompt "Increment engagements in progress"
      }
      on event AuditEngagement.ReportIssued {
        prompt "Increment reports issued and calculate duration"
      }
      on event AuditEngagement.FindingRecorded {
        prompt "Increment findings count by severity"
      }
    } with {
      briefly "Maintains audit metrics"
      described by "Projects events into audit metrics."
    }
  } with {
    briefly "Audit metrics"
    described by "Audit engagement analytics."
  }

} with {
  briefly "Bounded context for audit management"
  described by "Audit engagement management context."
}
