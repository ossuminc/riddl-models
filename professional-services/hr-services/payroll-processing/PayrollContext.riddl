// Payroll Processing - Payroll Context

context PayrollContext is {

  include "types.riddl"
  include "PayrollRun.riddl"

  repository PayrollRepository is {
    schema PayrollData is relational
      of payrollRuns as PayrollRun
      index on field PayrollRun.runId
      index on field PayrollRun.payPeriod.periodId
      index on field PayrollRun.status

    handler PayrollPersistence is {
      on event PayrollRun.PayrollInitiated {
        prompt "Store new payroll run"
      }
      on event PayrollRun.PayrollCalculated {
        prompt "Store calculated totals"
      }
      on event PayrollRun.TimeEntryAdded {
        prompt "Store time entry"
      }
      on event PayrollRun.PayrollApproved {
        prompt "Update status to approved"
      }
      on event PayrollRun.PayrollCompleted {
        prompt "Update status to completed"
      }
    } with {
      briefly "Persists payroll events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Payroll data persistence"
    described by "Persistent storage for payroll."
  }

  projector PayrollAnalytics is {
    updates repository PayrollRepository

    record PayrollMetrics is {
      year is Natural with { briefly "Year" described by "Fiscal year." }
      month is Natural with { briefly "Month" described by "Month number." }
      totalGrossPaid is Decimal(18, 2) with { briefly "Gross" described by "Total gross paid." }
      totalTaxesPaid is Decimal(18, 2) with { briefly "Taxes" described by "Total taxes paid." }
      totalNetPaid is Decimal(18, 2) with { briefly "Net" described by "Total net paid." }
      payrollRunCount is Natural with { briefly "Runs" described by "Payroll runs." }
    } with {
      briefly "Payroll metrics"
      described by "Monthly payroll metrics."
    }

    handler AnalyticsHandler is {
      on event PayrollRun.PayrollCompleted {
        prompt "Aggregate payroll totals by month"
      }
    } with {
      briefly "Maintains payroll analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Payroll analytics"
    described by "Payroll reporting and analysis."
  }

} with {
  briefly "Bounded context for payroll processing"
  described by "Payroll and compensation context."
}
