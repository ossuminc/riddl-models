// Payroll Processing - PayrollRun Entity
entity PayrollRun is {
  command InitiatePayroll is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |New payroll run identifier.
      }
    }
    payPeriod: PayPeriod with {
      briefly "Period"
      described as {
        |Pay period.
      }
    }
    employeeIds: EmployeeId+ with {
      briefly "Employees"
      described as {
        |Employees in payroll.
      }
    }
  } with {
    briefly "Initiate payroll"
    described as {
      |Initiates a new payroll run.
    }
  }
  command CalculatePayroll is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
  } with {
    briefly "Calculate payroll"
    described as {
      |Calculates earnings and deductions.
    }
  }
  command AddTimeEntry is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    earningsEntry: EarningsLine with {
      briefly "Earnings"
      described as {
        |Earnings entry.
      }
    }
  } with {
    briefly "Add time entry"
    described as {
      |Adds time/earnings entry.
    }
  }
  command ApplyDeduction is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    deduction: DeductionLine with {
      briefly "Deduction"
      described as {
        |Deduction entry.
      }
    }
  } with {
    briefly "Apply deduction"
    described as {
      |Applies a deduction.
    }
  }
  command CalculateTaxes is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
  } with {
    briefly "Calculate taxes"
    described as {
      |Calculates tax withholdings.
    }
  }
  command SubmitForApproval is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    submittedBy: String(1,100) with {
      briefly "Submitted by"
      described as {
        |Submitter name.
      }
    }
  } with {
    briefly "Submit for approval"
    described as {
      |Submits payroll for approval.
    }
  }
  command ApprovePayroll is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver name.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved at"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Approve payroll"
    described as {
      |Approves payroll run.
    }
  }
  command ProcessPayments is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
  } with {
    briefly "Process payments"
    described as {
      |Processes employee payments.
    }
  }
  command CompletePayroll is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Complete payroll"
    described as {
      |Marks payroll as completed.
    }
  }
  command VoidPayroll is  {
    runId: PayrollRunId with {
      briefly "Run ID"
      described as {
        |Payroll run identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
  } with {
    briefly "Void payroll"
    described as {
      |Voids payroll run.
    }
  }
  // Events
  event PayrollInitiated is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    payPeriod: PayPeriod with {
      briefly "Period"
      described as {
        |Pay period.
      }
    }
    employeeCount: Natural with {
      briefly "Employees"
      described as {
        |Employee count.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Payroll initiated"
    described as {
      |Emitted when payroll is initiated.
    }
  }
  event PayrollCalculated is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    totals: PayrollTotals with {
      briefly "Totals"
      described as {
        |Payroll totals.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Payroll calculated"
    described as {
      |Emitted when payroll is calculated.
    }
  }
  event TimeEntryAdded is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    earningsEntry: EarningsLine with {
      briefly "Earnings"
      described as {
        |Earnings.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Time entry added"
    described as {
      |Emitted when time entry added.
    }
  }
  event DeductionApplied is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    deduction: DeductionLine with {
      briefly "Deduction"
      described as {
        |Deduction.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Apply time.
      }
    }
  } with {
    briefly "Deduction applied"
    described as {
      |Emitted when deduction applied.
    }
  }
  event TaxesCalculated is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    totalTaxes: Decimal(15,2) with {
      briefly "Total"
      described as {
        |Total taxes.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Taxes calculated"
    described as {
      |Emitted when taxes calculated.
    }
  }
  event PayrollSubmittedForApproval is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    submittedBy: String(1,100) with {
      briefly "Submitted by"
      described as {
        |Submitter.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submit time.
      }
    }
  } with {
    briefly "Payroll submitted"
    described as {
      |Emitted when submitted for approval.
    }
  }
  event PayrollApproved is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Payroll approved"
    described as {
      |Emitted when approved.
    }
  }
  event PaymentsProcessed is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    totalAmount: Decimal(15,2) with {
      briefly "Total"
      described as {
        |Total paid.
      }
    }
    employeeCount: Natural with {
      briefly "Employees"
      described as {
        |Employees paid.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Payments processed"
    described as {
      |Emitted when payments sent.
    }
  }
  event PayrollCompleted is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    totals: PayrollTotals with {
      briefly "Totals"
      described as {
        |Final totals.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Payroll completed"
    described as {
      |Emitted when payroll complete.
    }
  }
  event PayrollVoided is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |Void time.
      }
    }
  } with {
    briefly "Payroll voided"
    described as {
      |Emitted when payroll voided.
    }
  }
  // States
  record ActiveStateData is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    payPeriod: PayPeriod with {
      briefly "Period"
      described as {
        |Pay period.
      }
    }
    status: PayrollStatus with {
      briefly "Status"
      described as {
        |Payroll status.
      }
    }
    payStubs: EmployeePayStub* with {
      briefly "Stubs"
      described as {
        |Pay stubs.
      }
    }
    updatedTotals: PayrollTotals? with {
      briefly "Totals"
      described as {
        |Payroll totals.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Active payroll state"
    described as {
      |State for active payroll run.
    }
  }
  record CompletedStateData is  {
    runId: PayrollRunId with {
      briefly "Run"
      described as {
        |Run ID.
      }
    }
    payPeriod: PayPeriod with {
      briefly "Period"
      described as {
        |Pay period.
      }
    }
    totals: PayrollTotals with {
      briefly "Totals"
      described as {
        |Final totals.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed payroll state"
    described as {
      |State for completed payroll.
    }
  }
  state ActiveState of type PayrollRun.ActiveStateData
  state CompletedState of type PayrollRun.CompletedStateData
  handler PayrollRunHandler is {
    on command InitiatePayroll is {
      morph entity PayrollContext.PayrollRun to state PayrollContext.PayrollRun.ActiveState with command InitiatePayroll
      tell event PayrollInitiated to entity PayrollContext.PayrollRun
    }
    on command CalculatePayroll is {
      tell event PayrollCalculated to entity PayrollContext.PayrollRun
    }
    on command AddTimeEntry is {
      tell event TimeEntryAdded to entity PayrollContext.PayrollRun
    }
    on command ApplyDeduction is {
      tell event DeductionApplied to entity PayrollContext.PayrollRun
    }
    on command CalculateTaxes is {
      tell event TaxesCalculated to entity PayrollContext.PayrollRun
    }
    on command SubmitForApproval is {
      tell event PayrollSubmittedForApproval to entity PayrollContext.PayrollRun
    }
    on command ApprovePayroll is {
      tell event PayrollApproved to entity PayrollContext.PayrollRun
    }
    on command ProcessPayments is {
      tell event PaymentsProcessed to entity PayrollContext.PayrollRun
    }
    on command CompletePayroll is {
      morph entity PayrollContext.PayrollRun to state PayrollContext.PayrollRun.CompletedState with command CompletePayroll
      tell event PayrollCompleted to entity PayrollContext.PayrollRun
    }
    on command VoidPayroll is {
      tell event PayrollVoided to entity PayrollContext.PayrollRun
    }
  } with {
    briefly "Processes payroll commands"
    described as {
      |Handles payroll run lifecycle.
    }
  }
} with {
  briefly "PayrollRun aggregate"
  described as {
    |Manages payroll processing cycles.
  }
}
