// Benefits Administration - BenefitsEnrollment Entity

entity BenefitsEnrollment is {

  command CreateEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "New enrollment identifier."
    }
    employeeId is EmployeeId with {
      briefly "Employee"
      described by "Employee identifier."
    }
    planYear is Year with {
      briefly "Plan year"
      described by "Benefits plan year."
    }
  } with {
    briefly "Create enrollment"
    described by "Creates a new benefits enrollment for an employee."
  }

  command SelectPlan is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    election is PlanElection with {
      briefly "Election"
      described by "Plan election details."
    }
  } with {
    briefly "Select plan"
    described by "Selects a benefits plan for the enrollment."
  }

  command AddDependent is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    dependent is DependentInfo with {
      briefly "Dependent"
      described by "Dependent to add."
    }
  } with {
    briefly "Add dependent"
    described by "Adds a dependent to the enrollment."
  }

  command RemoveDependent is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    dependentId is DependentId with {
      briefly "Dependent ID"
      described by "Dependent to remove."
    }
  } with {
    briefly "Remove dependent"
    described by "Removes a dependent from the enrollment."
  }

  command SubmitEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    submittedAt is TimeStamp with {
      briefly "Submitted"
      described by "Submission timestamp."
    }
  } with {
    briefly "Submit enrollment"
    described by "Submits enrollment elections for approval."
  }

  command ApproveEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    approvedBy is String(3, 100) with {
      briefly "Approved by"
      described by "Person approving the enrollment."
    }
  } with {
    briefly "Approve enrollment"
    described by "Approves enrollment elections."
  }

  command DenyEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Denial reason."
    }
  } with {
    briefly "Deny enrollment"
    described by "Denies enrollment elections."
  }

  command RecordLifeEvent is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    lifeEvent is LifeEventInfo with {
      briefly "Life event"
      described by "Qualifying life event details."
    }
  } with {
    briefly "Record life event"
    described by "Records a qualifying life event for mid-year changes."
  }

  command InitiateCobra is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    cobraInfo is CobraInfo with {
      briefly "COBRA info"
      described by "COBRA continuation details."
    }
  } with {
    briefly "Initiate COBRA"
    described by "Initiates COBRA continuation coverage."
  }

  command TerminateEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment identifier."
    }
    terminationDate is Date with {
      briefly "Termination date"
      described by "Coverage termination date."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Termination reason."
    }
  } with {
    briefly "Terminate enrollment"
    described by "Terminates benefits enrollment."
  }

  // Events
  event EnrollmentCreated is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    employeeId is EmployeeId with { briefly "Employee" described by "Employee ID." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Enrollment created"
    described by "Emitted when enrollment is created."
  }

  event PlanSelected is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    election is PlanElection with { briefly "Election" described by "Plan election." }
    selectedAt is TimeStamp with { briefly "Selected" described by "Selection time." }
  } with {
    briefly "Plan selected"
    described by "Emitted when a plan is selected."
  }

  event DependentAdded is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    dependent is DependentInfo with { briefly "Dependent" described by "Added dependent." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Dependent added"
    described by "Emitted when a dependent is added."
  }

  event DependentRemoved is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    dependentId is DependentId with { briefly "Dependent" described by "Removed dependent." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Dependent removed"
    described by "Emitted when a dependent is removed."
  }

  event EnrollmentSubmitted is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Enrollment submitted"
    described by "Emitted when enrollment is submitted."
  }

  event EnrollmentApproved is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    approvedBy is String(3, 100) with { briefly "Approved by" described by "Approver." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Enrollment approved"
    described by "Emitted when enrollment is approved."
  }

  event EnrollmentDenied is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Denial reason." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Enrollment denied"
    described by "Emitted when enrollment is denied."
  }

  event LifeEventRecorded is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    lifeEvent is LifeEventInfo with { briefly "Life event" described by "Recorded life event." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Life event recorded"
    described by "Emitted when a qualifying life event is recorded."
  }

  event CobraInitiated is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    cobraInfo is CobraInfo with { briefly "COBRA" described by "COBRA details." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "COBRA initiated"
    described by "Emitted when COBRA coverage is initiated."
  }

  event EnrollmentTerminated is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    terminationDate is Date with { briefly "Termination" described by "Termination date." }
    reason is String(3, 500) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Enrollment terminated"
    described by "Emitted when enrollment is terminated."
  }

  // States
  record ActiveEnrollmentData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    employeeId is EmployeeId with { briefly "Employee" described by "Employee ID." }
    planYear is Year with { briefly "Plan year" described by "Benefits plan year." }
    status is EnrollmentStatus with { briefly "Status" described by "Enrollment status." }
    updatedElections is many optional PlanElection with { briefly "Elections" described by "Plan elections." }
    dependents is many optional DependentInfo with { briefly "Dependents" described by "Enrolled dependents." }
    lifeEvents is many optional LifeEventInfo with { briefly "Life events" described by "Qualifying life events." }
    updatedCobraInfo is optional CobraInfo with { briefly "COBRA" described by "COBRA coverage info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active enrollment state"
    described by "State for an active benefits enrollment."
  }

  record TerminatedEnrollmentData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    employeeId is EmployeeId with { briefly "Employee" described by "Employee ID." }
    terminationDate is Date with { briefly "Termination" described by "Termination date." }
    reason is String(3, 500) with { briefly "Reason" described by "Termination reason." }
    terminatedAt is TimeStamp with { briefly "Terminated" described by "Termination time." }
  } with {
    briefly "Terminated enrollment state"
    described by "State for a terminated benefits enrollment."
  }

  state ActiveEnrollment of BenefitsEnrollment.ActiveEnrollmentData with {
    briefly "Enrollment active"
    described by "Benefits enrollment is active and being managed."
  }

  state TerminatedEnrollment of BenefitsEnrollment.TerminatedEnrollmentData with {
    briefly "Enrollment terminated"
    described by "Benefits enrollment has been terminated."
  }

  handler BenefitsEnrollmentHandler is {
    on command CreateEnrollment {
      morph entity BenefitsContext.BenefitsEnrollment to state BenefitsContext.BenefitsEnrollment.ActiveEnrollment with command CreateEnrollment
      tell event EnrollmentCreated to entity BenefitsContext.BenefitsEnrollment
    }
    on command SelectPlan {
      tell event PlanSelected to entity BenefitsContext.BenefitsEnrollment
    }
    on command AddDependent {
      tell event DependentAdded to entity BenefitsContext.BenefitsEnrollment
    }
    on command RemoveDependent {
      tell event DependentRemoved to entity BenefitsContext.BenefitsEnrollment
    }
    on command SubmitEnrollment {
      tell event EnrollmentSubmitted to entity BenefitsContext.BenefitsEnrollment
    }
    on command ApproveEnrollment {
      tell event EnrollmentApproved to entity BenefitsContext.BenefitsEnrollment
    }
    on command DenyEnrollment {
      tell event EnrollmentDenied to entity BenefitsContext.BenefitsEnrollment
    }
    on command RecordLifeEvent {
      tell event LifeEventRecorded to entity BenefitsContext.BenefitsEnrollment
    }
    on command InitiateCobra {
      tell event CobraInitiated to entity BenefitsContext.BenefitsEnrollment
    }
    on command TerminateEnrollment {
      morph entity BenefitsContext.BenefitsEnrollment to state BenefitsContext.BenefitsEnrollment.TerminatedEnrollment with command TerminateEnrollment
      tell event EnrollmentTerminated to entity BenefitsContext.BenefitsEnrollment
    }
  } with {
    briefly "Processes enrollment commands"
    described by "Handles benefits enrollment lifecycle."
  }

} with {
  briefly "BenefitsEnrollment aggregate"
  described by "Manages employee benefits enrollments."
}
