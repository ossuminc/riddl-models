// Benefits Administration - BenefitsEnrollment Entity
entity BenefitsEnrollment is {
  command CreateEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |New enrollment identifier.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee identifier.
      }
    }
    planYear: Year with {
      briefly "Plan year"
      described as {
        |Benefits plan year.
      }
    }
  } with {
    briefly "Create enrollment"
    described as {
      |Creates a new benefits enrollment for an employee.
    }
  }
  command SelectPlan is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    election: PlanElection with {
      briefly "Election"
      described as {
        |Plan election details.
      }
    }
  } with {
    briefly "Select plan"
    described as {
      |Selects a benefits plan for the enrollment.
    }
  }
  command AddDependent is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    dependent: DependentInfo with {
      briefly "Dependent"
      described as {
        |Dependent to add.
      }
    }
  } with {
    briefly "Add dependent"
    described as {
      |Adds a dependent to the enrollment.
    }
  }
  command RemoveDependent is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    dependentId: DependentId with {
      briefly "Dependent ID"
      described as {
        |Dependent to remove.
      }
    }
  } with {
    briefly "Remove dependent"
    described as {
      |Removes a dependent from the enrollment.
    }
  }
  command SubmitEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission timestamp.
      }
    }
  } with {
    briefly "Submit enrollment"
    described as {
      |Submits enrollment elections for approval.
    }
  }
  command ApproveEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    approvedBy: String(3,100) with {
      briefly "Approved by"
      described as {
        |Person approving the enrollment.
      }
    }
  } with {
    briefly "Approve enrollment"
    described as {
      |Approves enrollment elections.
    }
  }
  command DenyEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
  } with {
    briefly "Deny enrollment"
    described as {
      |Denies enrollment elections.
    }
  }
  command RecordLifeEvent is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    lifeEvent: LifeEventInfo with {
      briefly "Life event"
      described as {
        |Qualifying life event details.
      }
    }
  } with {
    briefly "Record life event"
    described as {
      |Records a qualifying life event for mid-year changes.
    }
  }
  command InitiateCobra is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    cobraInfo: CobraInfo with {
      briefly "COBRA info"
      described as {
        |COBRA continuation details.
      }
    }
  } with {
    briefly "Initiate COBRA"
    described as {
      |Initiates COBRA continuation coverage.
    }
  }
  command TerminateEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |Coverage termination date.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
  } with {
    briefly "Terminate enrollment"
    described as {
      |Terminates benefits enrollment.
    }
  }
  // Events
  event EnrollmentCreated is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Enrollment created"
    described as {
      |Emitted when enrollment is created.
    }
  }
  event PlanSelected is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    election: PlanElection with {
      briefly "Election"
      described as {
        |Plan election.
      }
    }
    selectedAt: TimeStamp with {
      briefly "Selected"
      described as {
        |Selection time.
      }
    }
  } with {
    briefly "Plan selected"
    described as {
      |Emitted when a plan is selected.
    }
  }
  event DependentAdded is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    dependent: DependentInfo with {
      briefly "Dependent"
      described as {
        |Added dependent.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Dependent added"
    described as {
      |Emitted when a dependent is added.
    }
  }
  event DependentRemoved is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    dependentId: DependentId with {
      briefly "Dependent"
      described as {
        |Removed dependent.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Dependent removed"
    described as {
      |Emitted when a dependent is removed.
    }
  }
  event EnrollmentSubmitted is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Enrollment submitted"
    described as {
      |Emitted when enrollment is submitted.
    }
  }
  event EnrollmentApproved is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    approvedBy: String(3,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Enrollment approved"
    described as {
      |Emitted when enrollment is approved.
    }
  }
  event EnrollmentDenied is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Enrollment denied"
    described as {
      |Emitted when enrollment is denied.
    }
  }
  event LifeEventRecorded is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    lifeEvent: LifeEventInfo with {
      briefly "Life event"
      described as {
        |Recorded life event.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Life event recorded"
    described as {
      |Emitted when a qualifying life event is recorded.
    }
  }
  event CobraInitiated is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    cobraInfo: CobraInfo with {
      briefly "COBRA"
      described as {
        |COBRA details.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "COBRA initiated"
    described as {
      |Emitted when COBRA coverage is initiated.
    }
  }
  event EnrollmentTerminated is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    terminationDate: Date with {
      briefly "Termination"
      described as {
        |Termination date.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    terminatedAt: TimeStamp with {
      briefly "Terminated"
      described as {
        |Termination time.
      }
    }
  } with {
    briefly "Enrollment terminated"
    described as {
      |Emitted when enrollment is terminated.
    }
  }
  // States
  record ActiveEnrollmentData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    planYear: Year with {
      briefly "Plan year"
      described as {
        |Benefits plan year.
      }
    }
    status: EnrollmentStatus with {
      briefly "Status"
      described as {
        |Enrollment status.
      }
    }
    updatedElections: PlanElection* with {
      briefly "Elections"
      described as {
        |Plan elections.
      }
    }
    dependents: DependentInfo* with {
      briefly "Dependents"
      described as {
        |Enrolled dependents.
      }
    }
    lifeEvents: LifeEventInfo* with {
      briefly "Life events"
      described as {
        |Qualifying life events.
      }
    }
    updatedCobraInfo: CobraInfo? with {
      briefly "COBRA"
      described as {
        |COBRA coverage info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active enrollment state"
    described as {
      |State for an active benefits enrollment.
    }
  }
  record TerminatedEnrollmentData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment"
      described as {
        |Enrollment ID.
      }
    }
    employeeId: EmployeeId with {
      briefly "Employee"
      described as {
        |Employee ID.
      }
    }
    terminationDate: Date with {
      briefly "Termination"
      described as {
        |Termination date.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    terminatedAt: TimeStamp with {
      briefly "Terminated"
      described as {
        |Termination time.
      }
    }
  } with {
    briefly "Terminated enrollment state"
    described as {
      |State for a terminated benefits enrollment.
    }
  }
  state ActiveEnrollment of type BenefitsEnrollment.ActiveEnrollmentData
  state TerminatedEnrollment of type BenefitsEnrollment.TerminatedEnrollmentData
  handler BenefitsEnrollmentHandler is {
    on command CreateEnrollment is {
      morph entity BenefitsContext.BenefitsEnrollment to state BenefitsContext.BenefitsEnrollment.ActiveEnrollment with command CreateEnrollment
      tell event EnrollmentCreated to entity BenefitsContext.BenefitsEnrollment
    }
    on command SelectPlan is {
      tell event PlanSelected to entity BenefitsContext.BenefitsEnrollment
    }
    on command AddDependent is {
      tell event DependentAdded to entity BenefitsContext.BenefitsEnrollment
    }
    on command RemoveDependent is {
      tell event DependentRemoved to entity BenefitsContext.BenefitsEnrollment
    }
    on command SubmitEnrollment is {
      tell event EnrollmentSubmitted to entity BenefitsContext.BenefitsEnrollment
    }
    on command ApproveEnrollment is {
      tell event EnrollmentApproved to entity BenefitsContext.BenefitsEnrollment
    }
    on command DenyEnrollment is {
      tell event EnrollmentDenied to entity BenefitsContext.BenefitsEnrollment
    }
    on command RecordLifeEvent is {
      tell event LifeEventRecorded to entity BenefitsContext.BenefitsEnrollment
    }
    on command InitiateCobra is {
      tell event CobraInitiated to entity BenefitsContext.BenefitsEnrollment
    }
    on command TerminateEnrollment is {
      morph entity BenefitsContext.BenefitsEnrollment to state BenefitsContext.BenefitsEnrollment.TerminatedEnrollment with command TerminateEnrollment
      tell event EnrollmentTerminated to entity BenefitsContext.BenefitsEnrollment
    }
  } with {
    briefly "Processes enrollment commands"
    described as {
      |Handles benefits enrollment lifecycle.
    }
  }
} with {
  briefly "BenefitsEnrollment aggregate"
  described as {
    |Manages employee benefits enrollments.
  }
}
