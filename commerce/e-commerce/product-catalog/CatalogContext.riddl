// Product Catalog - Catalog Context

context CatalogContext is {

  include "types.riddl"
  include "Product.riddl"
  include "Category.riddl"
  include "PriceList.riddl"

  // Adaptors for external system integration
  adaptor InventoryAdapter from context InventoryService is {
    handler InventoryEvents is {
      on event InventoryService.StockLevelChanged {
        prompt "Update product availability display"
      }
      on event InventoryService.StockDepleted {
        prompt "Mark product as out of stock"
      }
    } with {
      briefly "Handles inventory events"
      described by "Processes inventory updates for availability display."
    }
  } with {
    briefly "Inventory integration"
    described by "Receives stock level updates from the inventory system."
  }

  adaptor SearchAdapter to context SearchEngine is {
    handler SearchIndexing is {
      on command SearchEngine.IndexProduct {
        prompt "Index or update product in search engine"
      }
      on command SearchEngine.RemoveProduct {
        prompt "Remove product from search index"
      }
    } with {
      briefly "Handles search indexing"
      described by "Translates product commands for search engine indexing."
    }
  } with {
    briefly "Search engine integration"
    described by "Publishes product changes to the search engine for discovery."
  }

  adaptor ContentAdapter from context ContentManagement is {
    handler ContentEvents is {
      on event ContentManagement.ImageUploaded {
        prompt "Associate image with product"
      }
      on event ContentManagement.ImageDeleted {
        prompt "Remove image reference from product"
      }
    } with {
      briefly "Handles content events"
      described by "Processes image and content updates."
    }
  } with {
    briefly "Content management integration"
    described by "Receives image and content updates from the CMS."
  }

  // Repository for catalog persistence
  repository CatalogRepository is {
    schema CatalogData is relational
      of products as Product
      of categories as Category
      of priceLists as PriceList
      link productCategories as field Product.primaryCategory to field Category.categoryId
      index on field Product.sku
      index on field Product.name
      index on field Category.categoryName

    handler CatalogPersistence is {
      on command Product.CreateProduct {
        prompt "Persist new product to database"
      }
      on command Product.UpdateProduct {
        prompt "Update product in database"
      }
      on command Product.SetPrice {
        prompt "Update product price in database"
      }
      on command Product.PublishProduct {
        prompt "Update product status to published"
      }
      on command Product.RetireProduct {
        prompt "Update product status to retired"
      }
      on command Category.CreateCategory {
        prompt "Persist new category"
      }
      on command Category.UpdateCategory {
        prompt "Update category in database"
      }
      on command PriceList.CreatePriceList {
        prompt "Persist new price list"
      }
      on command PriceList.SetProductPrice {
        prompt "Update product price in list"
      }
    } with {
      briefly "Persists catalog commands"
      described by "Handles command-driven persistence for catalog data."
    }
  } with {
    briefly "Catalog data persistence"
    described by {
      | The CatalogRepository provides persistent storage for products,
      | categories, and price lists with indexes for efficient queries.
    }
  }

  // Projector for catalog views
  projector CatalogViews is {
    updates repository CatalogRepository

    record ProductSummary is {
      productId is ProductId with { briefly "ID" described by "Product identifier." }
      sku is SKU with { briefly "SKU" described by "Stock keeping unit." }
      name is ProductName with { briefly "Name" described by "Product name." }
      basePrice is Money with { briefly "Price" described by "Base price." }
      category is String(1, 100) with { briefly "Category" described by "Primary category name." }
      status is ProductStatus with { briefly "Status" described by "Product status." }
      imageUrl is optional ImageUrl with { briefly "Image" described by "Primary image URL." }
    } with {
      briefly "Product summary for listings"
      described by "Lightweight product view for catalog listings."
    }

    handler ViewHandler is {
      on event Product.ProductCreated {
        prompt "Create product summary view"
      }
      on event Product.ProductPublished {
        prompt "Update product summary as active"
      }
      on event Product.CategoryAssigned {
        prompt "Update product category in summary"
      }
    } with {
      briefly "Maintains catalog views"
      described by "Projects events into optimized read views."
    }
  } with {
    briefly "Catalog view projections"
    described by "Maintains read-optimized views of catalog data."
  }

} with {
  briefly "Bounded context for product catalog"
  described by {
    | The CatalogContext is the bounded context for product catalog
    | management. It contains entities for products, categories, and
    | price lists, with integrations to inventory, search, and content
    | management systems.
  }
}
