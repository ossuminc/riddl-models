// Product Catalog - Product Entity

entity Product is {

  // Commands
  command CreateProduct is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Unique identifier for the new product."
    }
    sku is SKU with {
      briefly "SKU"
      described by "Stock keeping unit for the product."
    }
    name is ProductName with {
      briefly "Name"
      described by "Display name for the product."
    }
    description is ProductDescription with {
      briefly "Description"
      described by "Detailed product description."
    }
    basePrice is Money with {
      briefly "Base price"
      described by "Default price before tier adjustments."
    }
    attributes is many AttributeValue with {
      briefly "Attributes"
      described by "Product attributes like color, material, size."
    }
    images is many ImageUrl with {
      briefly "Images"
      described by "Product image URLs."
    }
  } with {
    briefly "Create a new product"
    described by "Adds a new product to the catalog in draft status."
  }

  command UpdateProduct is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to update."
    }
    name is optional ProductName with {
      briefly "Name"
      described by "New product name if changing."
    }
    description is optional ProductDescription with {
      briefly "Description"
      described by "New description if changing."
    }
    attributes is many optional AttributeValue with {
      briefly "Attributes"
      described by "Updated attributes if changing."
    }
    images is many optional ImageUrl with {
      briefly "Images"
      described by "Updated images if changing."
    }
  } with {
    briefly "Update product details"
    described by "Modifies product information for an existing product."
  }

  command SetPrice is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to price."
    }
    basePrice is Money with {
      briefly "Base price"
      described by "New base price for the product."
    }
    tiers is many optional PriceTier with {
      briefly "Price tiers"
      described by "Volume or segment-based pricing tiers."
    }
  } with {
    briefly "Set product pricing"
    described by "Updates the base price and optional pricing tiers."
  }

  command AddVariant is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to add variant to."
    }
    variant is ProductVariant with {
      briefly "Variant"
      described by "The variant to add."
    }
  } with {
    briefly "Add a product variant"
    described by "Adds a variant with specific attributes like size or color."
  }

  command AssignCategory is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to categorize."
    }
    categoryId is CategoryId with {
      briefly "Category ID"
      described by "Category to assign."
    }
    isPrimary is Boolean with {
      briefly "Primary category"
      described by "Whether this is the primary category for navigation."
    }
  } with {
    briefly "Assign product to category"
    described by "Associates the product with a category for navigation."
  }

  command PublishProduct is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to publish."
    }
  } with {
    briefly "Publish product to catalog"
    described by "Makes the product visible to customers in the catalog."
  }

  command RetireProduct is {
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to retire."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Explanation for retiring the product."
    }
  } with {
    briefly "Retire a product"
    described by "Marks the product as discontinued and removes from active catalog."
  }

  // Events
  event ProductCreated is {
    productId is ProductId with { briefly "Product ID" described by "New product identifier." }
    sku is SKU with { briefly "SKU" described by "Product SKU." }
    name is ProductName with { briefly "Name" described by "Product name." }
    description is ProductDescription with { briefly "Description" described by "Product description." }
    basePrice is Money with { briefly "Base price" described by "Initial price." }
    createdAt is TimeStamp with { briefly "Created at" described by "When the product was created." }
  } with {
    briefly "Product was created"
    described by "Emitted when a new product is added to the catalog."
  }

  event ProductUpdated is {
    productId is ProductId with { briefly "Product ID" described by "Updated product." }
    name is optional ProductName with { briefly "Name" described by "New name if changed." }
    description is optional ProductDescription with { briefly "Description" described by "New description if changed." }
    updatedAt is TimeStamp with { briefly "Updated at" described by "When the update occurred." }
  } with {
    briefly "Product details were updated"
    described by "Emitted when product information is modified."
  }

  event PriceChanged is {
    productId is ProductId with { briefly "Product ID" described by "Repriced product." }
    oldPrice is Money with { briefly "Old price" described by "Previous base price." }
    newPrice is Money with { briefly "New price" described by "New base price." }
    changedAt is TimeStamp with { briefly "Changed at" described by "When price changed." }
  } with {
    briefly "Product price was changed"
    described by "Emitted when the product base price is updated."
  }

  event VariantAdded is {
    productId is ProductId with { briefly "Product ID" described by "Parent product." }
    variant is ProductVariant with { briefly "Variant" described by "The added variant." }
    addedAt is TimeStamp with { briefly "Added at" described by "When variant was added." }
  } with {
    briefly "Variant was added to product"
    described by "Emitted when a new variant is added to a product."
  }

  event CategoryAssigned is {
    productId is ProductId with { briefly "Product ID" described by "Categorized product." }
    categoryId is CategoryId with { briefly "Category ID" described by "Assigned category." }
    isPrimary is Boolean with { briefly "Primary" described by "If primary category." }
    assignedAt is TimeStamp with { briefly "Assigned at" described by "When assigned." }
  } with {
    briefly "Product was assigned to category"
    described by "Emitted when a product is categorized."
  }

  event ProductPublished is {
    productId is ProductId with { briefly "Product ID" described by "Published product." }
    publishedAt is TimeStamp with { briefly "Published at" described by "When published." }
  } with {
    briefly "Product was published"
    described by "Emitted when a product becomes visible in the catalog."
  }

  event ProductRetired is {
    productId is ProductId with { briefly "Product ID" described by "Retired product." }
    reason is String(1, 500) with { briefly "Reason" described by "Retirement reason." }
    retiredAt is TimeStamp with { briefly "Retired at" described by "When retired." }
  } with {
    briefly "Product was retired"
    described by "Emitted when a product is discontinued."
  }

  // State Records
  record DraftProductData is {
    productId is ProductId with { briefly "Product ID" described by "Product identifier." }
    sku is SKU with { briefly "SKU" described by "Stock keeping unit." }
    name is ProductName with { briefly "Name" described by "Product name." }
    description is ProductDescription with { briefly "Description" described by "Product description." }
    basePrice is Money with { briefly "Base price" described by "Default price." }
    attributes is many AttributeValue with { briefly "Attributes" described by "Product attributes." }
    images is many ImageUrl with { briefly "Images" described by "Product images." }
    variants is many ProductVariant with { briefly "Variants" described by "Product variants." }
    categories is many CategoryId with { briefly "Categories" described by "Assigned categories." }
    primaryCategory is optional CategoryId with { briefly "Primary category" described by "Main category." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft product data"
    described by "State data for a product being prepared for publication."
  }

  record ActiveProductData is {
    productId is ProductId with { briefly "Product ID" described by "Product identifier." }
    sku is SKU with { briefly "SKU" described by "Stock keeping unit." }
    name is ProductName with { briefly "Name" described by "Product name." }
    description is ProductDescription with { briefly "Description" described by "Product description." }
    basePrice is Money with { briefly "Base price" described by "Default price." }
    priceTiers is many PriceTier with { briefly "Price tiers" described by "Volume pricing." }
    attributes is many AttributeValue with { briefly "Attributes" described by "Product attributes." }
    images is many ImageUrl with { briefly "Images" described by "Product images." }
    variants is many ProductVariant with { briefly "Variants" described by "Product variants." }
    categories is many CategoryId with { briefly "Categories" described by "Assigned categories." }
    primaryCategory is CategoryId with { briefly "Primary category" described by "Main category." }
    publishedAt is TimeStamp with { briefly "Published" described by "Publication time." }
  } with {
    briefly "Active product data"
    described by "State data for a published product visible in the catalog."
  }

  record RetiredProductData is {
    productId is ProductId with { briefly "Product ID" described by "Product identifier." }
    sku is SKU with { briefly "SKU" described by "Stock keeping unit." }
    name is ProductName with { briefly "Name" described by "Product name." }
    reason is String(1, 500) with { briefly "Reason" described by "Retirement reason." }
    retiredAt is TimeStamp with { briefly "Retired" described by "Retirement time." }
  } with {
    briefly "Retired product data"
    described by "State data for a discontinued product."
  }

  // States
  state Draft of Product.DraftProductData with {
    briefly "Product in draft"
    described by "Product is being prepared and not yet visible to customers."
  }

  state Active of Product.ActiveProductData with {
    briefly "Product is active"
    described by "Product is published and visible in the catalog."
  }

  state Retired of Product.RetiredProductData with {
    briefly "Product is retired"
    described by "Product is discontinued and no longer available."
  }

  // Handler
  handler ProductHandler is {
    on command CreateProduct {
      morph entity Product to state Product.Draft with command CreateProduct
      tell event ProductCreated to entity Product
    }

    on command UpdateProduct {
      tell event ProductUpdated to entity Product
    }

    on command SetPrice {
      tell event PriceChanged to entity Product
    }

    on command AddVariant {
      tell event VariantAdded to entity Product
    }

    on command AssignCategory {
      tell event CategoryAssigned to entity Product
    }

    on command PublishProduct {
      morph entity Product to state Product.Active with command PublishProduct
      tell event ProductPublished to entity Product
    }

    on command RetireProduct {
      morph entity Product to state Product.Retired with command RetireProduct
      tell event ProductRetired to entity Product
    }
  } with {
    briefly "Processes product lifecycle commands"
    described by {
      | Handles all commands related to product management including
      | creation, updates, pricing, categorization, and lifecycle changes.
    }
  }

} with {
  briefly "Product aggregate for catalog items"
  described by {
    | The Product entity manages individual products in the catalog including
    | their attributes, variants, pricing, and categorization. Products
    | progress through draft, active, and retired states.
  }
}
