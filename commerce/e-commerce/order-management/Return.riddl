// Order Management - Return Entity
// Handles return requests, refunds, and restocking

entity Return is {

  type ReturnStatus is any of {
    StatusRequested with { briefly "Requested" described by "Return request submitted." },
    StatusApproved with { briefly "Approved" described by "Return request approved." },
    StatusShipped with { briefly "Shipped" described by "Return shipment in transit." },
    StatusReceived with { briefly "Received" described by "Return items received." },
    StatusRefunded with { briefly "Refunded" described by "Refund processed." },
    StatusDenied with { briefly "Denied" described by "Return request denied." },
    StatusClosed with { briefly "Closed" described by "Return process completed." }
  } with {
    briefly "Return process states"
    described by "Enumeration of possible states in the return workflow."
  }

  record ReturnItemRecord is {
    itemId is OrderItemId with { briefly "Item ID" described by "Original order item ID." }
    productId is ProductId with { briefly "Product ID" described by "Product being returned." }
    quantity is Quantity with { briefly "Quantity" described by "Number of units returning." }
    reason is ReturnReason with { briefly "Reason" described by "Why item is being returned." }
    condition is String(1, 100) with { briefly "Condition" described by "Item condition." }
  } with {
    briefly "An item being returned"
    described by "Details about a specific item included in a return request."
  }

  // Commands
  command RequestReturn is {
    returnId is ReturnId with { briefly "Return ID" described by "Unique return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order reference." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer making request." }
    items is many ReturnItemRecord with { briefly "Items" described by "Items to return." }
    reason is ReturnReason with { briefly "Reason" described by "Primary return reason." }
    comments is optional String(1, 1000) with { briefly "Comments" described by "Additional comments." }
  } with {
    briefly "Initiate a return request"
    described by "Submits a request to return one or more items from a delivered order."
  }

  command ApproveReturn is {
    returnId is ReturnId with { briefly "Return ID" described by "Return to approve." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Who approved." }
    returnLabel is optional String(1, 200) with { briefly "Return label" described by "Shipping label URL." }
  } with {
    briefly "Approve a return request and issue return label"
    described by "Approves the return and provides shipping label for customer."
  }

  command DenyReturn is {
    returnId is ReturnId with { briefly "Return ID" described by "Return to deny." }
    deniedBy is String(1, 100) with { briefly "Denied by" described by "Who denied." }
    reason is String(1, 500) with { briefly "Reason" described by "Denial reason." }
  } with {
    briefly "Deny a return request"
    described by "Rejects the return request with explanation."
  }

  command ReceiveReturn is {
    returnId is ReturnId with { briefly "Return ID" described by "Received return." }
    receivedAt is TimeStamp with { briefly "Received at" described by "Receipt time." }
    condition is String(1, 200) with { briefly "Condition" described by "Item condition on receipt." }
    allItemsReceived is Boolean with { briefly "All received" described by "All items received." }
  } with {
    briefly "Record receipt of returned items"
    described by "Records that returned items have been received at warehouse."
  }

  command ProcessRefund is {
    returnId is ReturnId with { briefly "Return ID" described by "Return for refund." }
    refundAmount is Money with { briefly "Amount" described by "Refund amount." }
    refundMethod is PaymentMethod with { briefly "Method" described by "Refund method." }
  } with {
    briefly "Process refund for returned items"
    described by "Initiates refund to customer for approved return."
  }

  // Events
  event ReturnRequested is {
    returnId is ReturnId with { briefly "Return ID" described by "New return ID." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    items is many ReturnItemRecord with { briefly "Items" described by "Items to return." }
    reason is ReturnReason with { briefly "Reason" described by "Return reason." }
    requestedAt is TimeStamp with { briefly "Requested at" described by "Request time." }
  } with {
    briefly "A return was requested"
    described by "Emitted when customer submits a return request."
  }

  event ReturnApproved is {
    returnId is ReturnId with { briefly "Return ID" described by "Approved return." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Approver." }
    returnLabel is optional String(1, 200) with { briefly "Label" described by "Return label." }
    approvedAt is TimeStamp with { briefly "Approved at" described by "Approval time." }
  } with {
    briefly "Return request was approved"
    described by "Emitted when return is approved for processing."
  }

  event ReturnDenied is {
    returnId is ReturnId with { briefly "Return ID" described by "Denied return." }
    deniedBy is String(1, 100) with { briefly "Denied by" described by "Who denied." }
    reason is String(1, 500) with { briefly "Reason" described by "Denial reason." }
    deniedAt is TimeStamp with { briefly "Denied at" described by "Denial time." }
  } with {
    briefly "Return request was denied"
    described by "Emitted when return request is rejected."
  }

  event ReturnReceived is {
    returnId is ReturnId with { briefly "Return ID" described by "Received return." }
    receivedAt is TimeStamp with { briefly "Received at" described by "Receipt time." }
    condition is String(1, 200) with { briefly "Condition" described by "Item condition." }
    allItemsReceived is Boolean with { briefly "All received" described by "Complete receipt." }
  } with {
    briefly "Returned items were received"
    described by "Emitted when warehouse receives returned items."
  }

  event RefundProcessed is {
    returnId is ReturnId with { briefly "Return ID" described by "Refunded return." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    refundAmount is Money with { briefly "Amount" described by "Refund amount." }
    refundMethod is PaymentMethod with { briefly "Method" described by "Refund method." }
    processedAt is TimeStamp with { briefly "Processed at" described by "Process time." }
  } with {
    briefly "Refund was processed"
    described by "Emitted when refund is sent to customer."
  }

  // State Records
  record RequestedReturnData is {
    returnId is ReturnId with { briefly "Return ID" described by "Return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    items is many ReturnItemRecord with { briefly "Items" described by "Return items." }
    reason is ReturnReason with { briefly "Reason" described by "Return reason." }
    comments is optional String(1, 1000) with { briefly "Comments" described by "Customer comments." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Pending return request"
    described by "State data for a return request awaiting review."
  }

  record ApprovedReturnData is {
    returnId is ReturnId with { briefly "Return ID" described by "Return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    items is many ReturnItemRecord with { briefly "Items" described by "Return items." }
    returnLabel is optional String(1, 200) with { briefly "Label" described by "Return label." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Approver." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Approved return awaiting shipment"
    described by "State data for an approved return waiting for customer to ship."
  }

  record ReceivedReturnData is {
    returnId is ReturnId with { briefly "Return ID" described by "Return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    items is many ReturnItemRecord with { briefly "Items" described by "Return items." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
    condition is String(1, 200) with { briefly "Condition" described by "Item condition." }
  } with {
    briefly "Returned items received"
    described by "State data for a return where items have been received."
  }

  record RefundedReturnData is {
    returnId is ReturnId with { briefly "Return ID" described by "Return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    refundAmount is Money with { briefly "Amount" described by "Refund amount." }
    refundMethod is PaymentMethod with { briefly "Method" described by "Refund method." }
    refundedAt is TimeStamp with { briefly "Refunded" described by "Refund time." }
  } with {
    briefly "Return completed with refund"
    described by "State data for a completed return with refund processed."
  }

  record DeniedReturnData is {
    returnId is ReturnId with { briefly "Return ID" described by "Return identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Original order." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer." }
    deniedBy is String(1, 100) with { briefly "Denied by" described by "Who denied." }
    reason is String(1, 500) with { briefly "Reason" described by "Denial reason." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Denied return request"
    described by "State data for a return that was denied."
  }

  // States
  state Requested of Return.RequestedReturnData with {
    briefly "Return request pending review"
    described by "Customer has submitted a return request awaiting approval."
  }

  state Approved of Return.ApprovedReturnData with {
    briefly "Return approved, awaiting shipment"
    described by "Return approved, customer has return label to ship items."
  }

  state Received of Return.ReceivedReturnData with {
    briefly "Returned items received"
    described by "Warehouse has received and inspected the returned items."
  }

  state Refunded of Return.RefundedReturnData with {
    briefly "Return completed with refund"
    described by "Refund has been processed and return is complete."
  }

  state Denied of Return.DeniedReturnData with {
    briefly "Return request was denied"
    described by "Return did not meet eligibility criteria and was rejected."
  }

  // Handler
  handler ReturnHandler is {
    on command RequestReturn {
      morph entity Return to state Return.Requested with command RequestReturn
      tell event ReturnRequested to entity Return
    }

    on command ApproveReturn {
      morph entity Return to state Return.Approved with command ApproveReturn
      tell event ReturnApproved to entity Return
    }

    on command DenyReturn {
      morph entity Return to state Return.Denied with command DenyReturn
      tell event ReturnDenied to entity Return
    }

    on command ReceiveReturn {
      morph entity Return to state Return.Received with command ReceiveReturn
      tell event ReturnReceived to entity Return
    }

    on command ProcessRefund {
      morph entity Return to state Return.Refunded with command ProcessRefund
      tell event RefundProcessed to entity Return
    }
  } with {
    briefly "Processes return lifecycle commands"
    described by "Handles all commands related to return processing and refunds."
  }

} with {
  briefly "Manages product returns and refunds"
  described by {
    | The Return entity handles the complete return lifecycle from
    | request through refund. It tracks return reasons, approval
    | workflow, receipt of items, and refund processing.
  }
}
