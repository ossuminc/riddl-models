// Order Management - Return Entity
// Handles return requests, refunds, and restocking
entity Return is {
  type ReturnStatus is any of {
    StatusRequested,
    StatusApproved,
    StatusShipped,
    StatusReceived,
    StatusRefunded,
    StatusDenied,
    StatusClosed
  } with {
    briefly "Return process states"
    described as {
      |Enumeration of possible states in the return workflow.
    }
  }
  record ReturnItemRecord is  {
    itemId: OrderItemId with {
      briefly "Item ID"
      described as {
        |Original order item ID.
      }
    }
    productId: ProductId with {
      briefly "Product ID"
      described as {
        |Product being returned.
      }
    }
    quantity: Quantity with {
      briefly "Quantity"
      described as {
        |Number of units returning.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Why item is being returned.
      }
    }
    condition: String(1,100) with {
      briefly "Condition"
      described as {
        |Item condition.
      }
    }
  } with {
    briefly "An item being returned"
    described as {
      |Details about a specific item included in a return request.
    }
  }
  // Commands
  command RequestReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Unique return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order reference.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer making request.
      }
    }
    returnItems: ReturnItemRecord+ with {
      briefly "Items"
      described as {
        |Items to return.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Primary return reason.
      }
    }
    comments: String(1,1000)? with {
      briefly "Comments"
      described as {
        |Additional comments.
      }
    }
  } with {
    briefly "Initiate a return request"
    described as {
      |Submits a request to return one or more items from a delivered order.
    }
  }
  command ApproveReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return to approve.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Who approved.
      }
    }
    returnLabel: String(1,200)? with {
      briefly "Return label"
      described as {
        |Shipping label URL.
      }
    }
  } with {
    briefly "Approve a return request and issue return label"
    described as {
      |Approves the return and provides shipping label for customer.
    }
  }
  command DenyReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return to deny.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Who denied.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
  } with {
    briefly "Deny a return request"
    described as {
      |Rejects the return request with explanation.
    }
  }
  command ReceiveReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Received return.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received at"
      described as {
        |Receipt time.
      }
    }
    condition: String(1,200) with {
      briefly "Condition"
      described as {
        |Item condition on receipt.
      }
    }
    allItemsReceived: Boolean with {
      briefly "All received"
      described as {
        |All items received.
      }
    }
  } with {
    briefly "Record receipt of returned items"
    described as {
      |Records that returned items have been received at warehouse.
    }
  }
  command ProcessRefund is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return for refund.
      }
    }
    refundAmount: Money with {
      briefly "Amount"
      described as {
        |Refund amount.
      }
    }
    refundMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Refund method.
      }
    }
  } with {
    briefly "Process refund for returned items"
    described as {
      |Initiates refund to customer for approved return.
    }
  }
  // Events
  event ReturnRequested is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |New return ID.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    returnItems: ReturnItemRecord+ with {
      briefly "Items"
      described as {
        |Items to return.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested at"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "A return was requested"
    described as {
      |Emitted when customer submits a return request.
    }
  }
  event ReturnApproved is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Approved return.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    returnLabel: String(1,200)? with {
      briefly "Label"
      described as {
        |Return label.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved at"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Return request was approved"
    described as {
      |Emitted when return is approved for processing.
    }
  }
  event ReturnDenied is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Denied return.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Who denied.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied at"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Return request was denied"
    described as {
      |Emitted when return request is rejected.
    }
  }
  event ReturnReceived is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Received return.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received at"
      described as {
        |Receipt time.
      }
    }
    condition: String(1,200) with {
      briefly "Condition"
      described as {
        |Item condition.
      }
    }
    allItemsReceived: Boolean with {
      briefly "All received"
      described as {
        |Complete receipt.
      }
    }
  } with {
    briefly "Returned items were received"
    described as {
      |Emitted when warehouse receives returned items.
    }
  }
  event RefundProcessed is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Refunded return.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    refundAmount: Money with {
      briefly "Amount"
      described as {
        |Refund amount.
      }
    }
    refundMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Refund method.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed at"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Refund was processed"
    described as {
      |Emitted when refund is sent to customer.
    }
  }
  // State Records
  record RequestedReturnData is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    returnItems: ReturnItemRecord+ with {
      briefly "Items"
      described as {
        |Return items.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
    comments: String(1,1000)? with {
      briefly "Comments"
      described as {
        |Customer comments.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Pending return request"
    described as {
      |State data for a return request awaiting review.
    }
  }
  record ApprovedReturnData is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    returnItems: ReturnItemRecord+ with {
      briefly "Items"
      described as {
        |Return items.
      }
    }
    returnLabel: String(1,200)? with {
      briefly "Label"
      described as {
        |Return label.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Approved return awaiting shipment"
    described as {
      |State data for an approved return waiting for customer to ship.
    }
  }
  record ReceivedReturnData is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    returnItems: ReturnItemRecord+ with {
      briefly "Items"
      described as {
        |Return items.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
    condition: String(1,200) with {
      briefly "Condition"
      described as {
        |Item condition.
      }
    }
  } with {
    briefly "Returned items received"
    described as {
      |State data for a return where items have been received.
    }
  }
  record RefundedReturnData is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    refundAmount: Money with {
      briefly "Amount"
      described as {
        |Refund amount.
      }
    }
    refundMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Refund method.
      }
    }
    refundedAt: TimeStamp with {
      briefly "Refunded"
      described as {
        |Refund time.
      }
    }
  } with {
    briefly "Return completed with refund"
    described as {
      |State data for a completed return with refund processed.
    }
  }
  record DeniedReturnData is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Original order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Who denied.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Denied return request"
    described as {
      |State data for a return that was denied.
    }
  }
  // States
  state Requested of type Return.RequestedReturnData
  state Approved of type Return.ApprovedReturnData
  state Received of type Return.ReceivedReturnData
  state Refunded of type Return.RefundedReturnData
  state Denied of type Return.DeniedReturnData
  // Handler
  handler ReturnHandler is {
    on command RequestReturn is {
      morph entity Return to state Return.Requested with command RequestReturn
      tell event ReturnRequested to entity Return
    }
    on command ApproveReturn is {
      morph entity Return to state Return.Approved with command ApproveReturn
      tell event ReturnApproved to entity Return
    }
    on command DenyReturn is {
      morph entity Return to state Return.Denied with command DenyReturn
      tell event ReturnDenied to entity Return
    }
    on command ReceiveReturn is {
      morph entity Return to state Return.Received with command ReceiveReturn
      tell event ReturnReceived to entity Return
    }
    on command ProcessRefund is {
      morph entity Return to state Return.Refunded with command ProcessRefund
      tell event RefundProcessed to entity Return
    }
  } with {
    briefly "Processes return lifecycle commands"
    described as {
      |Handles all commands related to return processing and refunds.
    }
  }
} with {
  briefly "Manages product returns and refunds"
  described as {
    | The Return entity handles the complete return lifecycle from
    | request through refund. It tracks return reasons, approval
    | workflow, receipt of items, and refund processing.
  }
}
