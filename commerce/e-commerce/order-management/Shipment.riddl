// Order Management - Shipment Entity
// Tracks fulfillment and delivery information
entity Shipment is {
  type ShipmentStatus is any of {
    AwaitingPickup,
    PickedUp,
    InTransitStatus,
    OutForDelivery,
    DeliveredStatus,
    DeliveryFailed,
    ReturnedToSender
  } with {
    briefly "Shipment tracking states"
    described as {
      | Enumeration of possible shipment statuses during the delivery
      | lifecycle from warehouse pickup through final delivery.
    }
  }
  record ShipmentEvent is  {
    status: ShipmentStatus with {
      briefly "Status"
      described as {
        | The shipment status at the time of this tracking event.
        | Represents the current state in the delivery process.
      }
    }
    location: String(1,200)? with {
      briefly "Location"
      described as {
        | Physical location where this event occurred, such as
        | city, facility name, or delivery address.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        | Date and time when this tracking event occurred
        | according to the carrier's system.
      }
    }
    description: String(1,500) with {
      briefly "Description"
      described as {
        | Human-readable description of the event provided by
        | the carrier, such as "Arrived at sort facility".
      }
    }
  } with {
    briefly "A tracking event from the carrier"
    described as {
      | Represents a single tracking update received from the shipping
      | carrier. Multiple events form the complete tracking history.
    }
  }
  // Commands
  command InitShipment is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Unique identifier assigned to this new shipment for
        | tracking throughout the delivery lifecycle.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        | Reference to the order being fulfilled by this shipment.
        | Links shipment tracking to order status.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        | The shipping carrier selected for this delivery based
        | on shipping method, destination, and cost.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        | Carrier-assigned tracking number for this shipment.
        | Used by customer to track delivery progress.
      }
    }
    shippingAddress: Address with {
      briefly "Address"
      described as {
        | Destination address where the shipment will be delivered.
        | Copied from order at time of shipment creation.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        | List of order items included in this shipment. May be
        | a subset of order items for split shipments.
      }
    }
  } with {
    briefly "Create a new shipment for an order"
    described as {
      | Initializes a shipment record when warehouse has picked and
      | packed an order. Creates tracking and notifies customer.
    }
  }
  command UpdateTracking is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Identifier of the shipment to update with new
        | tracking information from the carrier.
      }
    }
    status: ShipmentStatus with {
      briefly "Status"
      described as {
        | New status for the shipment based on carrier
        | tracking update.
      }
    }
    location: String(1,200)? with {
      briefly "Location"
      described as {
        | Current location of the package if provided by
        | the carrier tracking update.
      }
    }
    description: String(1,500) with {
      briefly "Description"
      described as {
        | Description of the tracking event from the carrier
        | webhook or API response.
      }
    }
  } with {
    briefly "Update shipment tracking from carrier webhook"
    described as {
      | Processes tracking updates received from carrier webhook
      | callbacks or polling. Updates shipment status and history.
    }
  }
  command MarkDelivered is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Identifier of the shipment that was successfully
        | delivered to the recipient.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered at"
      described as {
        | Date and time when the carrier confirmed delivery
        | of the package.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        | Name of the person who signed for the delivery if
        | signature was required and captured.
      }
    }
  } with {
    briefly "Mark shipment as delivered"
    described as {
      | Records successful delivery confirmation from the carrier.
      | Triggers order completion and customer notification.
    }
  }
  command MarkFailed is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Identifier of the shipment that could not be
        | delivered successfully.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        | Explanation of why delivery failed, such as bad
        | address, recipient refused, or access issues.
      }
    }
  } with {
    briefly "Mark shipment as failed delivery"
    described as {
      | Records that the carrier was unable to complete delivery.
      | May trigger customer service outreach or reshipment.
    }
  }
  // Events
  event ShipmentCreated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Unique identifier assigned to the newly created
        | shipment record.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        | Reference to the order being shipped. Used to
        | update order status.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        | The shipping carrier handling this delivery.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        | Carrier tracking number for customer to track
        | their package.
      }
    }
    shippingAddress: Address with {
      briefly "Address"
      described as {
        | Destination address for this shipment.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created at"
      described as {
        | When the shipment was created in the system.
      }
    }
  } with {
    briefly "A new shipment was created"
    described as {
      | Emitted when a shipment is created for an order. Triggers
      | order status update and customer shipping notification.
    }
  }
  event TrackingUpdated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Shipment that received a tracking update.
      }
    }
    status: ShipmentStatus with {
      briefly "Status"
      described as {
        | New status from the tracking update.
      }
    }
    location: String(1,200)? with {
      briefly "Location"
      described as {
        | Current location if provided in the update.
      }
    }
    description: String(1,500) with {
      briefly "Description"
      described as {
        | Carrier-provided description of the event.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated at"
      described as {
        | When the tracking update was received.
      }
    }
  } with {
    briefly "Shipment tracking was updated"
    described as {
      | Emitted when new tracking information is received from the
      | carrier. Updates tracking history and may notify customer.
    }
  }
  event ShipmentDelivered is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Shipment that was successfully delivered.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        | Associated order to update as delivered.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered at"
      described as {
        | When delivery was confirmed by carrier.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        | Name of person who signed if applicable.
      }
    }
  } with {
    briefly "Shipment was successfully delivered"
    described as {
      | Emitted when carrier confirms successful delivery. Triggers
      | order completion and delivery confirmation to customer.
    }
  }
  event ShipmentFailed is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        | Shipment that could not be delivered.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        | Associated order affected by the failure.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        | Why the delivery could not be completed.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed at"
      described as {
        | When the delivery failure was recorded.
      }
    }
  } with {
    briefly "Shipment delivery failed"
    described as {
      | Emitted when carrier reports delivery failure. Triggers
      | customer service notification and potential reshipment.
    }
  }
  // State Records
  record ActiveShipmentData is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Unique shipment identifier for tracking.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Associated order being fulfilled.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |Shipping carrier handling delivery.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Carrier tracking number.
      }
    }
    shippingAddress: Address with {
      briefly "Address"
      described as {
        |Delivery destination address.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Items included in shipment.
      }
    }
    status: ShipmentStatus with {
      briefly "Status"
      described as {
        |Current shipment status.
      }
    }
    trackingHistory: ShipmentEvent+ with {
      briefly "History"
      described as {
        |Tracking event history.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |When shipment was created.
      }
    }
  } with {
    briefly "Active shipment being tracked"
    described as {
      | State data for a shipment that is actively in transit.
      | Includes complete tracking history and current status.
    }
  }
  record DeliveredShipmentData is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Delivered shipment identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Associated order.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |Carrier that delivered.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery confirmation time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        |Recipient signature.
      }
    }
  } with {
    briefly "Successfully delivered shipment"
    described as {
      | State data for a shipment that has been successfully delivered.
      | Final state for normal order fulfillment.
    }
  }
  record FailedShipmentData is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Failed shipment identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Associated order.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |Carrier that attempted delivery.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Why delivery failed.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed at"
      described as {
        |When failure was recorded.
      }
    }
  } with {
    briefly "Failed shipment data"
    described as {
      | State data for a shipment that could not be delivered.
      | Requires customer service intervention or reshipment.
    }
  }
  // States
  state Active of type Shipment.ActiveShipmentData
  state DeliveryComplete of type Shipment.DeliveredShipmentData
  state DeliveryFailedState of type Shipment.FailedShipmentData
  // Handler
  handler ShipmentHandler is {
    on command InitShipment is {
      morph entity Shipment to state Shipment.Active with command InitShipment
      tell event ShipmentCreated to entity Shipment
    }
    on command UpdateTracking is {
      tell event TrackingUpdated to entity Shipment
    }
    on command MarkDelivered is {
      morph entity Shipment to state Shipment.DeliveryComplete with command MarkDelivered
      tell event ShipmentDelivered to entity Shipment
    }
    on command MarkFailed is {
      morph entity Shipment to state Shipment.DeliveryFailedState with command MarkFailed
      tell event ShipmentFailed to entity Shipment
    }
  } with {
    briefly "Processes shipment lifecycle commands"
    described as {
      | Handles all commands related to shipment tracking and delivery
      | status. Manages state transitions and emits events.
    }
  }
} with {
  briefly "Tracks order shipment and delivery"
  described as {
    | The Shipment entity manages the fulfillment lifecycle of an order.
    | It tracks carrier information, provides tracking updates, and
    | records delivery or failure outcomes.
  }
}
