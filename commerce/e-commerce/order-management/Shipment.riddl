// Order Management - Shipment Entity
// Tracks fulfillment and delivery information

entity Shipment is {

  type ShipmentStatus is any of {
    AwaitingPickup with {
      briefly "Awaiting pickup"
      described by {
        | Shipment has been created and labeled but carrier has not
        | yet picked up the package from the warehouse.
      }
    },
    PickedUp with {
      briefly "Picked up"
      described by {
        | Carrier has picked up the package from the warehouse
        | and it has entered the carrier's network.
      }
    },
    InTransitStatus with {
      briefly "In transit"
      described by {
        | Package is moving through the carrier's network toward
        | the destination. May pass through multiple facilities.
      }
    },
    OutForDelivery with {
      briefly "Out for delivery"
      described by {
        | Package is on a delivery vehicle and will be delivered
        | today. Final mile delivery in progress.
      }
    },
    DeliveredStatus with {
      briefly "Delivered"
      described by {
        | Package has been successfully delivered to the recipient
        | at the shipping address.
      }
    },
    DeliveryFailed with {
      briefly "Delivery failed"
      described by {
        | Delivery attempt was unsuccessful. May be due to address
        | issues, recipient unavailable, or access problems.
      }
    },
    ReturnedToSender with {
      briefly "Returned"
      described by {
        | Package is being returned to the sender after failed
        | delivery attempts or recipient refusal.
      }
    }
  } with {
    briefly "Shipment tracking states"
    described by {
      | Enumeration of possible shipment statuses during the delivery
      | lifecycle from warehouse pickup through final delivery.
    }
  }

  record ShipmentEvent is {
    status is ShipmentStatus with {
      briefly "Status"
      described by {
        | The shipment status at the time of this tracking event.
        | Represents the current state in the delivery process.
      }
    }
    location is optional String(1, 200) with {
      briefly "Location"
      described by {
        | Physical location where this event occurred, such as
        | city, facility name, or delivery address.
      }
    }
    timestamp is TimeStamp with {
      briefly "Timestamp"
      described by {
        | Date and time when this tracking event occurred
        | according to the carrier's system.
      }
    }
    description is String(1, 500) with {
      briefly "Description"
      described by {
        | Human-readable description of the event provided by
        | the carrier, such as "Arrived at sort facility".
      }
    }
  } with {
    briefly "A tracking event from the carrier"
    described by {
      | Represents a single tracking update received from the shipping
      | carrier. Multiple events form the complete tracking history.
    }
  }

  // Commands
  command InitShipment is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Unique identifier assigned to this new shipment for
        | tracking throughout the delivery lifecycle.
      }
    }
    orderId is OrderId with {
      briefly "Order ID"
      described by {
        | Reference to the order being fulfilled by this shipment.
        | Links shipment tracking to order status.
      }
    }
    carrier is CarrierCode with {
      briefly "Carrier"
      described by {
        | The shipping carrier selected for this delivery based
        | on shipping method, destination, and cost.
      }
    }
    trackingNumber is TrackingNumber with {
      briefly "Tracking"
      described by {
        | Carrier-assigned tracking number for this shipment.
        | Used by customer to track delivery progress.
      }
    }
    shippingAddress is Address with {
      briefly "Address"
      described by {
        | Destination address where the shipment will be delivered.
        | Copied from order at time of shipment creation.
      }
    }
    items is many OrderItemRecord with {
      briefly "Items"
      described by {
        | List of order items included in this shipment. May be
        | a subset of order items for split shipments.
      }
    }
  } with {
    briefly "Create a new shipment for an order"
    described by {
      | Initializes a shipment record when warehouse has picked and
      | packed an order. Creates tracking and notifies customer.
    }
  }

  command UpdateTracking is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Identifier of the shipment to update with new
        | tracking information from the carrier.
      }
    }
    status is ShipmentStatus with {
      briefly "Status"
      described by {
        | New status for the shipment based on carrier
        | tracking update.
      }
    }
    location is optional String(1, 200) with {
      briefly "Location"
      described by {
        | Current location of the package if provided by
        | the carrier tracking update.
      }
    }
    description is String(1, 500) with {
      briefly "Description"
      described by {
        | Description of the tracking event from the carrier
        | webhook or API response.
      }
    }
  } with {
    briefly "Update shipment tracking from carrier webhook"
    described by {
      | Processes tracking updates received from carrier webhook
      | callbacks or polling. Updates shipment status and history.
    }
  }

  command MarkDelivered is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Identifier of the shipment that was successfully
        | delivered to the recipient.
      }
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered at"
      described by {
        | Date and time when the carrier confirmed delivery
        | of the package.
      }
    }
    signedBy is optional String(1, 100) with {
      briefly "Signed by"
      described by {
        | Name of the person who signed for the delivery if
        | signature was required and captured.
      }
    }
  } with {
    briefly "Mark shipment as delivered"
    described by {
      | Records successful delivery confirmation from the carrier.
      | Triggers order completion and customer notification.
    }
  }

  command MarkFailed is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Identifier of the shipment that could not be
        | delivered successfully.
      }
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by {
        | Explanation of why delivery failed, such as bad
        | address, recipient refused, or access issues.
      }
    }
  } with {
    briefly "Mark shipment as failed delivery"
    described by {
      | Records that the carrier was unable to complete delivery.
      | May trigger customer service outreach or reshipment.
    }
  }

  // Events
  event ShipmentCreated is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Unique identifier assigned to the newly created
        | shipment record.
      }
    }
    orderId is OrderId with {
      briefly "Order ID"
      described by {
        | Reference to the order being shipped. Used to
        | update order status.
      }
    }
    carrier is CarrierCode with {
      briefly "Carrier"
      described by {
        | The shipping carrier handling this delivery.
      }
    }
    trackingNumber is TrackingNumber with {
      briefly "Tracking"
      described by {
        | Carrier tracking number for customer to track
        | their package.
      }
    }
    shippingAddress is Address with {
      briefly "Address"
      described by {
        | Destination address for this shipment.
      }
    }
    createdAt is TimeStamp with {
      briefly "Created at"
      described by {
        | When the shipment was created in the system.
      }
    }
  } with {
    briefly "A new shipment was created"
    described by {
      | Emitted when a shipment is created for an order. Triggers
      | order status update and customer shipping notification.
    }
  }

  event TrackingUpdated is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Shipment that received a tracking update.
      }
    }
    status is ShipmentStatus with {
      briefly "Status"
      described by {
        | New status from the tracking update.
      }
    }
    location is optional String(1, 200) with {
      briefly "Location"
      described by {
        | Current location if provided in the update.
      }
    }
    description is String(1, 500) with {
      briefly "Description"
      described by {
        | Carrier-provided description of the event.
      }
    }
    updatedAt is TimeStamp with {
      briefly "Updated at"
      described by {
        | When the tracking update was received.
      }
    }
  } with {
    briefly "Shipment tracking was updated"
    described by {
      | Emitted when new tracking information is received from the
      | carrier. Updates tracking history and may notify customer.
    }
  }

  event ShipmentDelivered is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Shipment that was successfully delivered.
      }
    }
    orderId is OrderId with {
      briefly "Order ID"
      described by {
        | Associated order to update as delivered.
      }
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered at"
      described by {
        | When delivery was confirmed by carrier.
      }
    }
    signedBy is optional String(1, 100) with {
      briefly "Signed by"
      described by {
        | Name of person who signed if applicable.
      }
    }
  } with {
    briefly "Shipment was successfully delivered"
    described by {
      | Emitted when carrier confirms successful delivery. Triggers
      | order completion and delivery confirmation to customer.
    }
  }

  event ShipmentFailed is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by {
        | Shipment that could not be delivered.
      }
    }
    orderId is OrderId with {
      briefly "Order ID"
      described by {
        | Associated order affected by the failure.
      }
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by {
        | Why the delivery could not be completed.
      }
    }
    failedAt is TimeStamp with {
      briefly "Failed at"
      described by {
        | When the delivery failure was recorded.
      }
    }
  } with {
    briefly "Shipment delivery failed"
    described by {
      | Emitted when carrier reports delivery failure. Triggers
      | customer service notification and potential reshipment.
    }
  }

  // State Records
  record ActiveShipmentData is {
    shipmentId is ShipmentId with { briefly "Shipment ID" described by "Unique shipment identifier for tracking." }
    orderId is OrderId with { briefly "Order ID" described by "Associated order being fulfilled." }
    carrier is CarrierCode with { briefly "Carrier" described by "Shipping carrier handling delivery." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Carrier tracking number." }
    shippingAddress is Address with { briefly "Address" described by "Delivery destination address." }
    items is many OrderItemRecord with { briefly "Items" described by "Items included in shipment." }
    status is ShipmentStatus with { briefly "Status" described by "Current shipment status." }
    trackingHistory is many ShipmentEvent with { briefly "History" described by "Tracking event history." }
    createdAt is TimeStamp with { briefly "Created" described by "When shipment was created." }
  } with {
    briefly "Active shipment being tracked"
    described by {
      | State data for a shipment that is actively in transit.
      | Includes complete tracking history and current status.
    }
  }

  record DeliveredShipmentData is {
    shipmentId is ShipmentId with { briefly "Shipment ID" described by "Delivered shipment identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Associated order." }
    carrier is CarrierCode with { briefly "Carrier" described by "Carrier that delivered." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery confirmation time." }
    signedBy is optional String(1, 100) with { briefly "Signed by" described by "Recipient signature." }
  } with {
    briefly "Successfully delivered shipment"
    described by {
      | State data for a shipment that has been successfully delivered.
      | Final state for normal order fulfillment.
    }
  }

  record FailedShipmentData is {
    shipmentId is ShipmentId with { briefly "Shipment ID" described by "Failed shipment identifier." }
    orderId is OrderId with { briefly "Order ID" described by "Associated order." }
    carrier is CarrierCode with { briefly "Carrier" described by "Carrier that attempted delivery." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    reason is String(1, 500) with { briefly "Reason" described by "Why delivery failed." }
    failedAt is TimeStamp with { briefly "Failed at" described by "When failure was recorded." }
  } with {
    briefly "Failed shipment data"
    described by {
      | State data for a shipment that could not be delivered.
      | Requires customer service intervention or reshipment.
    }
  }

  // States
  state Active of Shipment.ActiveShipmentData with {
    briefly "Shipment in transit"
    described by {
      | Shipment is actively being tracked and in transit to the
      | customer. Receives tracking updates from carrier.
    }
  }

  state DeliveryComplete of Shipment.DeliveredShipmentData with {
    briefly "Shipment delivered"
    described by {
      | Shipment has been successfully delivered to the customer.
      | Terminal state for successful fulfillment.
    }
  }

  state DeliveryFailedState of Shipment.FailedShipmentData with {
    briefly "Shipment delivery failed"
    described by {
      | Shipment could not be delivered to the customer. May require
      | address correction, reshipment, or refund.
    }
  }

  // Handler
  handler ShipmentHandler is {
    on command InitShipment {
      morph entity Shipment to state Shipment.Active with command InitShipment
      tell event ShipmentCreated to entity Shipment
    }

    on command UpdateTracking {
      tell event TrackingUpdated to entity Shipment
    }

    on command MarkDelivered {
      morph entity Shipment to state Shipment.DeliveryComplete with command MarkDelivered
      tell event ShipmentDelivered to entity Shipment
    }

    on command MarkFailed {
      morph entity Shipment to state Shipment.DeliveryFailedState with command MarkFailed
      tell event ShipmentFailed to entity Shipment
    }
  } with {
    briefly "Processes shipment lifecycle commands"
    described by {
      | Handles all commands related to shipment tracking and delivery
      | status. Manages state transitions and emits events.
    }
  }

} with {
  briefly "Tracks order shipment and delivery"
  described by {
    | The Shipment entity manages the fulfillment lifecycle of an order.
    | It tracks carrier information, provides tracking updates, and
    | records delivery or failure outcomes.
  }
}
