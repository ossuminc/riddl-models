// Order Management - Order Entity
// The primary aggregate for order lifecycle management
entity Order is {
  // Commands
  command PlaceOrder is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The unique identifier for the new order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer reference"
      described as {
        |Reference to the customer placing the order.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Order line items"
      described as {
        |The products being ordered with quantities and prices.
      }
    }
    shippingAddress: Address with {
      briefly "Shipping destination"
      described as {
        |The address where the order should be delivered.
      }
    }
    billingAddress: Address with {
      briefly "Billing address"
      described as {
        |The address associated with the payment method.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Payment method"
      described as {
        |How the customer will pay for the order.
      }
    }
  } with {
    briefly "Create a new order from cart items"
    described as {
      | Initiates a new order with the specified items and addresses.
      | The order starts in PendingPayment state awaiting payment confirmation.
    }
  }
  command ConfirmPayment is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order for which payment is being confirmed.
      }
    }
    transactionId: String(1,100) with {
      briefly "Payment transaction ID"
      described as {
        |The transaction identifier from the payment gateway.
      }
    }
    amountPaid: Money with {
      briefly "Amount paid"
      described as {
        |The monetary amount that was successfully charged.
      }
    }
  } with {
    briefly "Record successful payment from payment gateway"
    described as {
      |Confirms that payment has been received and transitions order to fulfillment.
    }
  }
  command AllocateInventory is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order for which inventory is being allocated.
      }
    }
    allocations: {
      itemId: OrderItemId with {
        briefly "Item identifier"
        described as {
          |The line item being allocated.
        }
      }
      allocated: Boolean with {
        briefly "Allocation success"
        described as {
          |Whether inventory was successfully allocated for this item.
        }
      }
    }
+ with {
      briefly "Allocation results"
      described as {
        |Results of inventory allocation for each line item.
      }
    }
  } with {
    briefly "Record inventory allocation results"
    described as {
      |Records the results of attempting to allocate inventory for order items.
    }
  }
  command ShipOrder is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order being shipped.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment reference"
      described as {
        |Reference to the shipment entity tracking this delivery.
      }
    }
    carrier: CarrierCode with {
      briefly "Shipping carrier"
      described as {
        |The carrier handling the shipment.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking number"
      described as {
        |The carrier's tracking number for this shipment.
      }
    }
  } with {
    briefly "Mark order as shipped with tracking information"
    described as {
      |Records shipment details and transitions order to in-transit state.
    }
  }
  command DeliverOrder is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order that was delivered.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivery timestamp"
      described as {
        |When the order was delivered.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signature"
      described as {
        |Name of person who signed for delivery, if applicable.
      }
    }
  } with {
    briefly "Mark order as delivered"
    described as {
      |Records delivery completion and finalizes the order fulfillment.
    }
  }
  command CancelOrder is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order being cancelled.
      }
    }
    reason: String(1,500) with {
      briefly "Cancellation reason"
      described as {
        |Explanation for why the order is being cancelled.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Identifier of person or system cancelling the order.
      }
    }
  } with {
    briefly "Cancel an order before shipment"
    described as {
      |Cancels an order that has not yet shipped, triggering refund if paid.
    }
  }
  // Events
  event OrderPlaced is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The unique identifier of the placed order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer reference"
      described as {
        |The customer who placed the order.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Order items"
      described as {
        |The line items included in the order.
      }
    }
    subtotal: Money with {
      briefly "Subtotal"
      described as {
        |Sum of line item totals before tax and shipping.
      }
    }
    tax: Money with {
      briefly "Tax amount"
      described as {
        |Total tax charged on the order.
      }
    }
    shippingCost: Money with {
      briefly "Shipping cost"
      described as {
        |Cost of shipping for this order.
      }
    }
    total: Money with {
      briefly "Order total"
      described as {
        |Final total including items, tax, and shipping.
      }
    }
    shippingAddress: Address with {
      briefly "Shipping address"
      described as {
        |Where the order will be delivered.
      }
    }
    billingAddress: Address with {
      briefly "Billing address"
      described as {
        |Address associated with payment.
      }
    }
    placedAt: TimeStamp with {
      briefly "Placed timestamp"
      described as {
        |When the order was placed.
      }
    }
  } with {
    briefly "A new order was created"
    described as {
      |Emitted when a customer successfully places a new order.
    }
  }
  event PaymentConfirmed is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order for which payment was confirmed.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction ID"
      described as {
        |Payment gateway transaction identifier.
      }
    }
    amountPaid: Money with {
      briefly "Amount paid"
      described as {
        |The amount successfully charged.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmation timestamp"
      described as {
        |When payment was confirmed.
      }
    }
  } with {
    briefly "Payment was successfully processed"
    described as {
      |Emitted when the payment gateway confirms successful payment.
    }
  }
  event InventoryAllocated is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order for which inventory was allocated.
      }
    }
    allItemsAllocated: Boolean with {
      briefly "Full allocation"
      described as {
        |Whether all items were successfully allocated.
      }
    }
    allocatedAt: TimeStamp with {
      briefly "Allocation timestamp"
      described as {
        |When allocation was completed.
      }
    }
  } with {
    briefly "Inventory was reserved for order items"
    described as {
      |Emitted when inventory allocation completes for an order.
    }
  }
  event OrderShipped is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order that was shipped.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment reference"
      described as {
        |Reference to the shipment tracking entity.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |The shipping carrier.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking number"
      described as {
        |Carrier tracking number.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped timestamp"
      described as {
        |When the order was shipped.
      }
    }
  } with {
    briefly "Order was dispatched to carrier"
    described as {
      |Emitted when the order is handed off to the shipping carrier.
    }
  }
  event OrderDelivered is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order that was delivered.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivery timestamp"
      described as {
        |When delivery occurred.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        |Who signed for the delivery.
      }
    }
  } with {
    briefly "Order was delivered to customer"
    described as {
      |Emitted when carrier confirms successful delivery.
    }
  }
  event OrderCancelled is  {
    orderId: OrderId with {
      briefly "Order identifier"
      described as {
        |The order that was cancelled.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Why the order was cancelled.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Who cancelled the order.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled timestamp"
      described as {
        |When the order was cancelled.
      }
    }
  } with {
    briefly "Order was cancelled"
    described as {
      |Emitted when an order is cancelled before shipment.
    }
  }
  // State Records
  record PendingPaymentData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer reference.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Order line items.
      }
    }
    subtotal: Money with {
      briefly "Subtotal"
      described as {
        |Items subtotal.
      }
    }
    tax: Money with {
      briefly "Tax"
      described as {
        |Tax amount.
      }
    }
    shippingCost: Money with {
      briefly "Shipping"
      described as {
        |Shipping cost.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    shippingAddress: Address with {
      briefly "Ship to"
      described as {
        |Shipping address.
      }
    }
    billingAddress: Address with {
      briefly "Bill to"
      described as {
        |Billing address.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Payment"
      described as {
        |Payment method.
      }
    }
    placedAt: TimeStamp with {
      briefly "Placed at"
      described as {
        |When placed.
      }
    }
  } with {
    briefly "Order data awaiting payment"
    described as {
      |State data for an order that has been placed but not yet paid.
    }
  }
  record AwaitingFulfillmentData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer reference.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Order line items.
      }
    }
    subtotal: Money with {
      briefly "Subtotal"
      described as {
        |Items subtotal.
      }
    }
    tax: Money with {
      briefly "Tax"
      described as {
        |Tax amount.
      }
    }
    shippingCost: Money with {
      briefly "Shipping"
      described as {
        |Shipping cost.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    shippingAddress: Address with {
      briefly "Ship to"
      described as {
        |Shipping address.
      }
    }
    billingAddress: Address with {
      briefly "Bill to"
      described as {
        |Billing address.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Payment transaction ID.
      }
    }
    amountPaid: Money with {
      briefly "Paid"
      described as {
        |Amount paid.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Payment confirmation time.
      }
    }
  } with {
    briefly "Order data after payment confirmed"
    described as {
      |State data for an order with confirmed payment awaiting fulfillment.
    }
  }
  record InTransitData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer reference.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Order line items.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    shippingAddress: Address with {
      briefly "Ship to"
      described as {
        |Shipping address.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment reference.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |Shipping carrier.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Ship date.
      }
    }
  } with {
    briefly "Order data after shipment"
    described as {
      |State data for an order that has been shipped and is in transit.
    }
  }
  record DeliveredData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer reference.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Order line items.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    shippingAddress: Address with {
      briefly "Ship to"
      described as {
        |Shipping address.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment reference.
      }
    }
    carrier: CarrierCode with {
      briefly "Carrier"
      described as {
        |Shipping carrier.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        |Signature.
      }
    }
  } with {
    briefly "Order data after delivery"
    described as {
      |State data for an order that has been successfully delivered.
    }
  }
  record CancelledData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Customer reference.
      }
    }
    items: OrderItemRecord+ with {
      briefly "Items"
      described as {
        |Order line items.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "By"
      described as {
        |Who cancelled.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |When cancelled.
      }
    }
  } with {
    briefly "Order data after cancellation"
    described as {
      |State data for an order that was cancelled before shipment.
    }
  }
  // States
  state PendingPayment of type Order.PendingPaymentData
  state AwaitingFulfillment of type Order.AwaitingFulfillmentData
  state InTransit of type Order.InTransitData
  state Delivered of type Order.DeliveredData
  state Cancelled of type Order.CancelledData
  // Handler
  handler OrderHandler is {
    on command PlaceOrder is {
      morph entity Order to state Order.PendingPayment with command PlaceOrder
      tell event OrderPlaced to entity Order
    }
    on command ConfirmPayment is {
      morph entity Order to state Order.AwaitingFulfillment with command ConfirmPayment
      tell event PaymentConfirmed to entity Order
    }
    on command ShipOrder is {
      morph entity Order to state Order.InTransit with command ShipOrder
      tell event OrderShipped to entity Order
    }
    on command DeliverOrder is {
      morph entity Order to state Order.Delivered with command DeliverOrder
      tell event OrderDelivered to entity Order
    }
    on command CancelOrder is {
      morph entity Order to state Order.Cancelled with command CancelOrder
      tell event OrderCancelled to entity Order
    }
  } with {
    briefly "Processes order lifecycle commands"
    described as {
      | Handles all commands related to order state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }
} with {
  briefly "The order aggregate managing order lifecycle"
  described as {
    | The Order entity is the primary aggregate for the Order Management
    | bounded context. It tracks orders from placement through delivery
    | or cancellation, maintaining a complete audit trail via events.
  }
}
