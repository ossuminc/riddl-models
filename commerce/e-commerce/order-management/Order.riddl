// Order Management - Order Entity
// The primary aggregate for order lifecycle management

entity Order is {

  // Commands
  command PlaceOrder is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The unique identifier for the new order."
    }
    customerId is CustomerId with {
      briefly "Customer reference"
      described by "Reference to the customer placing the order."
    }
    items is many OrderItemRecord with {
      briefly "Order line items"
      described by "The products being ordered with quantities and prices."
    }
    shippingAddress is Address with {
      briefly "Shipping destination"
      described by "The address where the order should be delivered."
    }
    billingAddress is Address with {
      briefly "Billing address"
      described by "The address associated with the payment method."
    }
    paymentMethod is PaymentMethod with {
      briefly "Payment method"
      described by "How the customer will pay for the order."
    }
  } with {
    briefly "Create a new order from cart items"
    described by {
      | Initiates a new order with the specified items and addresses.
      | The order starts in PendingPayment state awaiting payment confirmation.
    }
  }

  command ConfirmPayment is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order for which payment is being confirmed."
    }
    transactionId is String(1, 100) with {
      briefly "Payment transaction ID"
      described by "The transaction identifier from the payment gateway."
    }
    amountPaid is Money with {
      briefly "Amount paid"
      described by "The monetary amount that was successfully charged."
    }
  } with {
    briefly "Record successful payment from payment gateway"
    described by "Confirms that payment has been received and transitions order to fulfillment."
  }

  command AllocateInventory is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order for which inventory is being allocated."
    }
    allocations is many {
      itemId is OrderItemId with {
        briefly "Item identifier"
        described by "The line item being allocated."
      }
      allocated is Boolean with {
        briefly "Allocation success"
        described by "Whether inventory was successfully allocated for this item."
      }
    } with {
      briefly "Allocation results"
      described by "Results of inventory allocation for each line item."
    }
  } with {
    briefly "Record inventory allocation results"
    described by "Records the results of attempting to allocate inventory for order items."
  }

  command ShipOrder is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order being shipped."
    }
    shipmentId is ShipmentId with {
      briefly "Shipment reference"
      described by "Reference to the shipment entity tracking this delivery."
    }
    carrier is CarrierCode with {
      briefly "Shipping carrier"
      described by "The carrier handling the shipment."
    }
    trackingNumber is TrackingNumber with {
      briefly "Tracking number"
      described by "The carrier's tracking number for this shipment."
    }
  } with {
    briefly "Mark order as shipped with tracking information"
    described by "Records shipment details and transitions order to in-transit state."
  }

  command DeliverOrder is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order that was delivered."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivery timestamp"
      described by "When the order was delivered."
    }
    signedBy is optional String(1, 100) with {
      briefly "Signature"
      described by "Name of person who signed for delivery, if applicable."
    }
  } with {
    briefly "Mark order as delivered"
    described by "Records delivery completion and finalizes the order fulfillment."
  }

  command CancelOrder is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order being cancelled."
    }
    reason is String(1, 500) with {
      briefly "Cancellation reason"
      described by "Explanation for why the order is being cancelled."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Identifier of person or system cancelling the order."
    }
  } with {
    briefly "Cancel an order before shipment"
    described by "Cancels an order that has not yet shipped, triggering refund if paid."
  }

  // Events
  event OrderPlaced is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The unique identifier of the placed order."
    }
    customerId is CustomerId with {
      briefly "Customer reference"
      described by "The customer who placed the order."
    }
    items is many OrderItemRecord with {
      briefly "Order items"
      described by "The line items included in the order."
    }
    subtotal is Money with {
      briefly "Subtotal"
      described by "Sum of line item totals before tax and shipping."
    }
    tax is Money with {
      briefly "Tax amount"
      described by "Total tax charged on the order."
    }
    shippingCost is Money with {
      briefly "Shipping cost"
      described by "Cost of shipping for this order."
    }
    total is Money with {
      briefly "Order total"
      described by "Final total including items, tax, and shipping."
    }
    shippingAddress is Address with {
      briefly "Shipping address"
      described by "Where the order will be delivered."
    }
    billingAddress is Address with {
      briefly "Billing address"
      described by "Address associated with payment."
    }
    placedAt is TimeStamp with {
      briefly "Placed timestamp"
      described by "When the order was placed."
    }
  } with {
    briefly "A new order was created"
    described by "Emitted when a customer successfully places a new order."
  }

  event PaymentConfirmed is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order for which payment was confirmed."
    }
    transactionId is String(1, 100) with {
      briefly "Transaction ID"
      described by "Payment gateway transaction identifier."
    }
    amountPaid is Money with {
      briefly "Amount paid"
      described by "The amount successfully charged."
    }
    confirmedAt is TimeStamp with {
      briefly "Confirmation timestamp"
      described by "When payment was confirmed."
    }
  } with {
    briefly "Payment was successfully processed"
    described by "Emitted when the payment gateway confirms successful payment."
  }

  event InventoryAllocated is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order for which inventory was allocated."
    }
    allItemsAllocated is Boolean with {
      briefly "Full allocation"
      described by "Whether all items were successfully allocated."
    }
    allocatedAt is TimeStamp with {
      briefly "Allocation timestamp"
      described by "When allocation was completed."
    }
  } with {
    briefly "Inventory was reserved for order items"
    described by "Emitted when inventory allocation completes for an order."
  }

  event OrderShipped is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order that was shipped."
    }
    shipmentId is ShipmentId with {
      briefly "Shipment reference"
      described by "Reference to the shipment tracking entity."
    }
    carrier is CarrierCode with {
      briefly "Carrier"
      described by "The shipping carrier."
    }
    trackingNumber is TrackingNumber with {
      briefly "Tracking number"
      described by "Carrier tracking number."
    }
    shippedAt is TimeStamp with {
      briefly "Shipped timestamp"
      described by "When the order was shipped."
    }
  } with {
    briefly "Order was dispatched to carrier"
    described by "Emitted when the order is handed off to the shipping carrier."
  }

  event OrderDelivered is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order that was delivered."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivery timestamp"
      described by "When delivery occurred."
    }
    signedBy is optional String(1, 100) with {
      briefly "Signed by"
      described by "Who signed for the delivery."
    }
  } with {
    briefly "Order was delivered to customer"
    described by "Emitted when carrier confirms successful delivery."
  }

  event OrderCancelled is {
    orderId is OrderId with {
      briefly "Order identifier"
      described by "The order that was cancelled."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Why the order was cancelled."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Who cancelled the order."
    }
    cancelledAt is TimeStamp with {
      briefly "Cancelled timestamp"
      described by "When the order was cancelled."
    }
  } with {
    briefly "Order was cancelled"
    described by "Emitted when an order is cancelled before shipment."
  }

  // State Records
  record PendingPaymentData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer reference." }
    items is many OrderItemRecord with { briefly "Items" described by "Order line items." }
    subtotal is Money with { briefly "Subtotal" described by "Items subtotal." }
    tax is Money with { briefly "Tax" described by "Tax amount." }
    shippingCost is Money with { briefly "Shipping" described by "Shipping cost." }
    total is Money with { briefly "Total" described by "Order total." }
    shippingAddress is Address with { briefly "Ship to" described by "Shipping address." }
    billingAddress is Address with { briefly "Bill to" described by "Billing address." }
    paymentMethod is PaymentMethod with { briefly "Payment" described by "Payment method." }
    placedAt is TimeStamp with { briefly "Placed at" described by "When placed." }
  } with {
    briefly "Order data awaiting payment"
    described by "State data for an order that has been placed but not yet paid."
  }

  record AwaitingFulfillmentData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer reference." }
    items is many OrderItemRecord with { briefly "Items" described by "Order line items." }
    subtotal is Money with { briefly "Subtotal" described by "Items subtotal." }
    tax is Money with { briefly "Tax" described by "Tax amount." }
    shippingCost is Money with { briefly "Shipping" described by "Shipping cost." }
    total is Money with { briefly "Total" described by "Order total." }
    shippingAddress is Address with { briefly "Ship to" described by "Shipping address." }
    billingAddress is Address with { briefly "Bill to" described by "Billing address." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Payment transaction ID." }
    amountPaid is Money with { briefly "Paid" described by "Amount paid." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Payment confirmation time." }
  } with {
    briefly "Order data after payment confirmed"
    described by "State data for an order with confirmed payment awaiting fulfillment."
  }

  record InTransitData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer reference." }
    items is many OrderItemRecord with { briefly "Items" described by "Order line items." }
    total is Money with { briefly "Total" described by "Order total." }
    shippingAddress is Address with { briefly "Ship to" described by "Shipping address." }
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment reference." }
    carrier is CarrierCode with { briefly "Carrier" described by "Shipping carrier." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    shippedAt is TimeStamp with { briefly "Shipped" described by "Ship date." }
  } with {
    briefly "Order data after shipment"
    described by "State data for an order that has been shipped and is in transit."
  }

  record DeliveredData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer reference." }
    items is many OrderItemRecord with { briefly "Items" described by "Order line items." }
    total is Money with { briefly "Total" described by "Order total." }
    shippingAddress is Address with { briefly "Ship to" described by "Shipping address." }
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment reference." }
    carrier is CarrierCode with { briefly "Carrier" described by "Shipping carrier." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    signedBy is optional String(1, 100) with { briefly "Signed by" described by "Signature." }
  } with {
    briefly "Order data after delivery"
    described by "State data for an order that has been successfully delivered."
  }

  record CancelledData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer ID" described by "Customer reference." }
    items is many OrderItemRecord with { briefly "Items" described by "Order line items." }
    total is Money with { briefly "Total" described by "Order total." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledBy is String(1, 100) with { briefly "By" described by "Who cancelled." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "When cancelled." }
  } with {
    briefly "Order data after cancellation"
    described by "State data for an order that was cancelled before shipment."
  }

  // States
  state PendingPayment of Order.PendingPaymentData with {
    briefly "Order placed, awaiting payment"
    described by "Order has been placed and is waiting for payment confirmation."
  }

  state AwaitingFulfillment of Order.AwaitingFulfillmentData with {
    briefly "Payment received, ready for fulfillment"
    described by "Payment confirmed, order is ready for warehouse processing."
  }

  state InTransit of Order.InTransitData with {
    briefly "Order dispatched to carrier"
    described by "Order has been shipped and is in transit to customer."
  }

  state Delivered of Order.DeliveredData with {
    briefly "Order successfully delivered"
    described by "Order has been delivered to the customer."
  }

  state Cancelled of Order.CancelledData with {
    briefly "Order was cancelled"
    described by "Order was cancelled before shipment."
  }

  // Handler
  handler OrderHandler is {
    on command PlaceOrder {
      morph entity Order to state Order.PendingPayment with command PlaceOrder
      tell event OrderPlaced to entity Order
    }

    on command ConfirmPayment {
      morph entity Order to state Order.AwaitingFulfillment with command ConfirmPayment
      tell event PaymentConfirmed to entity Order
    }

    on command ShipOrder {
      morph entity Order to state Order.InTransit with command ShipOrder
      tell event OrderShipped to entity Order
    }

    on command DeliverOrder {
      morph entity Order to state Order.Delivered with command DeliverOrder
      tell event OrderDelivered to entity Order
    }

    on command CancelOrder {
      morph entity Order to state Order.Cancelled with command CancelOrder
      tell event OrderCancelled to entity Order
    }
  } with {
    briefly "Processes order lifecycle commands"
    described by {
      | Handles all commands related to order state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }

} with {
  briefly "The order aggregate managing order lifecycle"
  described by {
    | The Order entity is the primary aggregate for the Order Management
    | bounded context. It tracks orders from placement through delivery
    | or cancellation, maintaining a complete audit trail via events.
  }
}
