// Shopping Cart - Cart Entity
entity Cart is {
  // Commands
  command CreateCart is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Unique identifier for the new cart.
      }
    }
    customerId: CustomerId? with {
      briefly "Customer ID"
      described as {
        |Customer if authenticated, none for guest.
      }
    }
    sessionId: SessionId with {
      briefly "Session ID"
      described as {
        |Browser session for cart association.
      }
    }
  } with {
    briefly "Create a new shopping cart"
    described as {
      |Initializes an empty shopping cart for the session.
    }
  }
  command AddItem is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to add item to.
      }
    }
    productId: ProductId with {
      briefly "Product ID"
      described as {
        |Product to add.
      }
    }
    sku: SKU with {
      briefly "SKU"
      described as {
        |Product SKU.
      }
    }
    name: ProductName with {
      briefly "Name"
      described as {
        |Product name.
      }
    }
    quantity: Quantity with {
      briefly "Quantity"
      described as {
        |Number of units to add.
      }
    }
    unitPrice: Money with {
      briefly "Unit price"
      described as {
        |Current unit price.
      }
    }
  } with {
    briefly "Add item to cart"
    described as {
      |Adds a product to the shopping cart or increases quantity.
    }
  }
  command UpdateQuantity is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart containing the item.
      }
    }
    productId: ProductId with {
      briefly "Product ID"
      described as {
        |Product to update.
      }
    }
    newQuantity: Quantity with {
      briefly "New quantity"
      described as {
        |Updated quantity for the item.
      }
    }
  } with {
    briefly "Update item quantity"
    described as {
      |Changes the quantity of an item in the cart.
    }
  }
  command RemoveItem is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart containing the item.
      }
    }
    productId: ProductId with {
      briefly "Product ID"
      described as {
        |Product to remove.
      }
    }
  } with {
    briefly "Remove item from cart"
    described as {
      |Removes an item completely from the cart.
    }
  }
  command ApplyPromoCode is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to apply code to.
      }
    }
    code: PromoCode with {
      briefly "Promo code"
      described as {
        |Promotional code to apply.
      }
    }
  } with {
    briefly "Apply promotional code"
    described as {
      |Applies a discount code to the cart.
    }
  }
  command RemovePromoCode is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to remove code from.
      }
    }
    code: PromoCode with {
      briefly "Promo code"
      described as {
        |Promotional code to remove.
      }
    }
  } with {
    briefly "Remove promotional code"
    described as {
      |Removes a previously applied promo code.
    }
  }
  command SetShippingAddress is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to set address for.
      }
    }
    address: ShippingAddress with {
      briefly "Address"
      described as {
        |Shipping address for the order.
      }
    }
  } with {
    briefly "Set shipping address"
    described as {
      |Sets the delivery address for checkout.
    }
  }
  command MergeCart is  {
    targetCartId: CartId with {
      briefly "Target cart ID"
      described as {
        |Cart to merge into.
      }
    }
    sourceCartId: CartId with {
      briefly "Source cart ID"
      described as {
        |Cart to merge from.
      }
    }
  } with {
    briefly "Merge carts"
    described as {
      |Merges a guest cart into a customer cart after login.
    }
  }
  command Checkout is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to checkout.
      }
    }
  } with {
    briefly "Initiate checkout"
    described as {
      |Begins the checkout process for the cart.
    }
  }
  command AbandonCart is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart to mark abandoned.
      }
    }
  } with {
    briefly "Mark cart as abandoned"
    described as {
      |Marks an inactive cart as abandoned.
    }
  }
  // Events
  event CartCreated is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |New cart identifier.
      }
    }
    customerId: CustomerId? with {
      briefly "Customer"
      described as {
        |Customer if known.
      }
    }
    sessionId: SessionId with {
      briefly "Session"
      described as {
        |Browser session.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Cart was created"
    described as {
      |Emitted when a new shopping cart is initialized.
    }
  }
  event ItemAdded is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    item: CartItem with {
      briefly "Item"
      described as {
        |Added item details.
      }
    }
    newTotal: Money with {
      briefly "New total"
      described as {
        |Updated cart total.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |When item was added.
      }
    }
  } with {
    briefly "Item was added to cart"
    described as {
      |Emitted when a product is added to the cart.
    }
  }
  event ItemQuantityUpdated is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Updated product.
      }
    }
    oldQuantity: Quantity with {
      briefly "Old qty"
      described as {
        |Previous quantity.
      }
    }
    newQuantity: Quantity with {
      briefly "New qty"
      described as {
        |Updated quantity.
      }
    }
    newTotal: Money with {
      briefly "New total"
      described as {
        |Updated cart total.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |When updated.
      }
    }
  } with {
    briefly "Item quantity was updated"
    described as {
      |Emitted when an item quantity changes.
    }
  }
  event ItemRemoved is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Removed product.
      }
    }
    newTotal: Money with {
      briefly "New total"
      described as {
        |Updated cart total.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |When removed.
      }
    }
  } with {
    briefly "Item was removed from cart"
    described as {
      |Emitted when an item is removed from the cart.
    }
  }
  event PromoCodeApplied is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    discount: DiscountAmount with {
      briefly "Discount"
      described as {
        |Applied discount.
      }
    }
    newTotal: Money with {
      briefly "New total"
      described as {
        |Updated cart total.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |When applied.
      }
    }
  } with {
    briefly "Promo code was applied"
    described as {
      |Emitted when a promotional code is applied.
    }
  }
  event PromoCodeRemoved is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    code: PromoCode with {
      briefly "Code"
      described as {
        |Removed code.
      }
    }
    newTotal: Money with {
      briefly "New total"
      described as {
        |Updated cart total.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |When removed.
      }
    }
  } with {
    briefly "Promo code was removed"
    described as {
      |Emitted when a promo code is removed.
    }
  }
  event ShippingAddressSet is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    address: ShippingAddress with {
      briefly "Address"
      described as {
        |Set address.
      }
    }
    shippingEstimate: Money with {
      briefly "Shipping"
      described as {
        |Estimated shipping cost.
      }
    }
    setAt: TimeStamp with {
      briefly "Set at"
      described as {
        |When address was set.
      }
    }
  } with {
    briefly "Shipping address was set"
    described as {
      |Emitted when shipping address is provided.
    }
  }
  event CartsMerged is  {
    targetCartId: CartId with {
      briefly "Target"
      described as {
        |Merged into cart.
      }
    }
    sourceCartId: CartId with {
      briefly "Source"
      described as {
        |Merged from cart.
      }
    }
    addedItems: Natural with {
      briefly "Added"
      described as {
        |Items added from source.
      }
    }
    mergedAt: TimeStamp with {
      briefly "Merged"
      described as {
        |When merged.
      }
    }
  } with {
    briefly "Carts were merged"
    described as {
      |Emitted when a guest cart is merged into customer cart.
    }
  }
  event CartCheckedOut is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Checked out cart.
      }
    }
    orderId: UUID with {
      briefly "Order ID"
      described as {
        |Resulting order.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    checkedOutAt: TimeStamp with {
      briefly "Checked out"
      described as {
        |Checkout time.
      }
    }
  } with {
    briefly "Cart was checked out"
    described as {
      |Emitted when cart is converted to an order.
    }
  }
  event CartAbandoned is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Abandoned cart.
      }
    }
    itemCount: Natural with {
      briefly "Items"
      described as {
        |Items in cart.
      }
    }
    cartValue: Money with {
      briefly "Value"
      described as {
        |Cart value.
      }
    }
    abandonedAt: TimeStamp with {
      briefly "Abandoned"
      described as {
        |When marked abandoned.
      }
    }
  } with {
    briefly "Cart was abandoned"
    described as {
      |Emitted when cart is marked as abandoned.
    }
  }
  // State Records
  record ActiveCartData is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    customerId: CustomerId? with {
      briefly "Customer"
      described as {
        |Customer if known.
      }
    }
    sessionId: SessionId with {
      briefly "Session"
      described as {
        |Browser session.
      }
    }
    items: CartItem+ with {
      briefly "Items"
      described as {
        |Cart line items.
      }
    }
    discounts: DiscountAmount+ with {
      briefly "Discounts"
      described as {
        |Applied discounts.
      }
    }
    shippingAddress: ShippingAddress? with {
      briefly "Shipping"
      described as {
        |Delivery address.
      }
    }
    summary: CartSummary with {
      briefly "Summary"
      described as {
        |Cart totals.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
    lastUpdatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Last update time.
      }
    }
  } with {
    briefly "Active cart data"
    described as {
      |State data for an active shopping cart.
    }
  }
  record CheckedOutCartData is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    orderId: UUID with {
      briefly "Order ID"
      described as {
        |Resulting order.
      }
    }
    total: Money with {
      briefly "Total"
      described as {
        |Final order total.
      }
    }
    checkedOutAt: TimeStamp with {
      briefly "Checked out"
      described as {
        |Checkout time.
      }
    }
  } with {
    briefly "Checked out cart data"
    described as {
      |State data for a cart that was converted to an order.
    }
  }
  record AbandonedCartData is  {
    cartId: CartId with {
      briefly "Cart ID"
      described as {
        |Cart identifier.
      }
    }
    customerId: CustomerId? with {
      briefly "Customer"
      described as {
        |Customer if known.
      }
    }
    items: CartItem+ with {
      briefly "Items"
      described as {
        |Cart items at abandonment.
      }
    }
    cartValue: Money with {
      briefly "Value"
      described as {
        |Cart value.
      }
    }
    abandonedAt: TimeStamp with {
      briefly "Abandoned"
      described as {
        |When marked abandoned.
      }
    }
  } with {
    briefly "Abandoned cart data"
    described as {
      |State data for an abandoned shopping cart.
    }
  }
  // States
  state ActiveState of type Cart.ActiveCartData
  state CheckedOutState of type Cart.CheckedOutCartData
  state AbandonedState of type Cart.AbandonedCartData
  // Handler
  handler CartHandler is {
    on command CreateCart is {
      morph entity Cart to state Cart.ActiveState with command CreateCart
      tell event CartCreated to entity Cart
    }
    on command AddItem is {
      tell event ItemAdded to entity Cart
    }
    on command UpdateQuantity is {
      tell event ItemQuantityUpdated to entity Cart
    }
    on command RemoveItem is {
      tell event ItemRemoved to entity Cart
    }
    on command ApplyPromoCode is {
      tell event PromoCodeApplied to entity Cart
    }
    on command RemovePromoCode is {
      tell event PromoCodeRemoved to entity Cart
    }
    on command SetShippingAddress is {
      tell event ShippingAddressSet to entity Cart
    }
    on command MergeCart is {
      tell event CartsMerged to entity Cart
    }
    on command Checkout is {
      morph entity Cart to state Cart.CheckedOutState with command Checkout
      tell event CartCheckedOut to entity Cart
    }
    on command AbandonCart is {
      morph entity Cart to state Cart.AbandonedState with command AbandonCart
      tell event CartAbandoned to entity Cart
    }
  } with {
    briefly "Processes cart commands"
    described as {
      | Handles all shopping cart operations including item management,
      | promotions, and checkout initiation.
    }
  }
} with {
  briefly "Shopping cart aggregate"
  described as {
    | The Cart entity manages a customer's shopping cart including
    | item management, pricing, discounts, and checkout initiation.
    | Supports both authenticated customers and guest sessions.
  }
}
