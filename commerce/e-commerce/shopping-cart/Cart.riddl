// Shopping Cart - Cart Entity

entity Cart is {

  // Commands
  command CreateCart is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Unique identifier for the new cart."
    }
    customerId is optional CustomerId with {
      briefly "Customer ID"
      described by "Customer if authenticated, none for guest."
    }
    sessionId is SessionId with {
      briefly "Session ID"
      described by "Browser session for cart association."
    }
  } with {
    briefly "Create a new shopping cart"
    described by "Initializes an empty shopping cart for the session."
  }

  command AddItem is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to add item to."
    }
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to add."
    }
    sku is SKU with {
      briefly "SKU"
      described by "Product SKU."
    }
    name is ProductName with {
      briefly "Name"
      described by "Product name."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Number of units to add."
    }
    unitPrice is Money with {
      briefly "Unit price"
      described by "Current unit price."
    }
  } with {
    briefly "Add item to cart"
    described by "Adds a product to the shopping cart or increases quantity."
  }

  command UpdateQuantity is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart containing the item."
    }
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to update."
    }
    newQuantity is Quantity with {
      briefly "New quantity"
      described by "Updated quantity for the item."
    }
  } with {
    briefly "Update item quantity"
    described by "Changes the quantity of an item in the cart."
  }

  command RemoveItem is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart containing the item."
    }
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to remove."
    }
  } with {
    briefly "Remove item from cart"
    described by "Removes an item completely from the cart."
  }

  command ApplyPromoCode is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to apply code to."
    }
    code is PromoCode with {
      briefly "Promo code"
      described by "Promotional code to apply."
    }
  } with {
    briefly "Apply promotional code"
    described by "Applies a discount code to the cart."
  }

  command RemovePromoCode is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to remove code from."
    }
    code is PromoCode with {
      briefly "Promo code"
      described by "Promotional code to remove."
    }
  } with {
    briefly "Remove promotional code"
    described by "Removes a previously applied promo code."
  }

  command SetShippingAddress is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to set address for."
    }
    address is ShippingAddress with {
      briefly "Address"
      described by "Shipping address for the order."
    }
  } with {
    briefly "Set shipping address"
    described by "Sets the delivery address for checkout."
  }

  command MergeCart is {
    targetCartId is CartId with {
      briefly "Target cart ID"
      described by "Cart to merge into."
    }
    sourceCartId is CartId with {
      briefly "Source cart ID"
      described by "Cart to merge from."
    }
  } with {
    briefly "Merge carts"
    described by "Merges a guest cart into a customer cart after login."
  }

  command Checkout is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to checkout."
    }
  } with {
    briefly "Initiate checkout"
    described by "Begins the checkout process for the cart."
  }

  command AbandonCart is {
    cartId is CartId with {
      briefly "Cart ID"
      described by "Cart to mark abandoned."
    }
  } with {
    briefly "Mark cart as abandoned"
    described by "Marks an inactive cart as abandoned."
  }

  // Events
  event CartCreated is {
    cartId is CartId with { briefly "Cart ID" described by "New cart identifier." }
    customerId is optional CustomerId with { briefly "Customer" described by "Customer if known." }
    sessionId is SessionId with { briefly "Session" described by "Browser session." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Cart was created"
    described by "Emitted when a new shopping cart is initialized."
  }

  event ItemAdded is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    item is CartItem with { briefly "Item" described by "Added item details." }
    newTotal is Money with { briefly "New total" described by "Updated cart total." }
    addedAt is TimeStamp with { briefly "Added" described by "When item was added." }
  } with {
    briefly "Item was added to cart"
    described by "Emitted when a product is added to the cart."
  }

  event ItemQuantityUpdated is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    productId is ProductId with { briefly "Product" described by "Updated product." }
    oldQuantity is Quantity with { briefly "Old qty" described by "Previous quantity." }
    newQuantity is Quantity with { briefly "New qty" described by "Updated quantity." }
    newTotal is Money with { briefly "New total" described by "Updated cart total." }
    updatedAt is TimeStamp with { briefly "Updated" described by "When updated." }
  } with {
    briefly "Item quantity was updated"
    described by "Emitted when an item quantity changes."
  }

  event ItemRemoved is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    productId is ProductId with { briefly "Product" described by "Removed product." }
    newTotal is Money with { briefly "New total" described by "Updated cart total." }
    removedAt is TimeStamp with { briefly "Removed" described by "When removed." }
  } with {
    briefly "Item was removed from cart"
    described by "Emitted when an item is removed from the cart."
  }

  event PromoCodeApplied is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    discount is DiscountAmount with { briefly "Discount" described by "Applied discount." }
    newTotal is Money with { briefly "New total" described by "Updated cart total." }
    appliedAt is TimeStamp with { briefly "Applied" described by "When applied." }
  } with {
    briefly "Promo code was applied"
    described by "Emitted when a promotional code is applied."
  }

  event PromoCodeRemoved is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    code is PromoCode with { briefly "Code" described by "Removed code." }
    newTotal is Money with { briefly "New total" described by "Updated cart total." }
    removedAt is TimeStamp with { briefly "Removed" described by "When removed." }
  } with {
    briefly "Promo code was removed"
    described by "Emitted when a promo code is removed."
  }

  event ShippingAddressSet is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    address is ShippingAddress with { briefly "Address" described by "Set address." }
    estimatedShipping is Money with { briefly "Shipping" described by "Estimated shipping cost." }
    setAt is TimeStamp with { briefly "Set at" described by "When address was set." }
  } with {
    briefly "Shipping address was set"
    described by "Emitted when shipping address is provided."
  }

  event CartsMerged is {
    targetCartId is CartId with { briefly "Target" described by "Merged into cart." }
    sourceCartId is CartId with { briefly "Source" described by "Merged from cart." }
    addedItems is Natural with { briefly "Added" described by "Items added from source." }
    mergedAt is TimeStamp with { briefly "Merged" described by "When merged." }
  } with {
    briefly "Carts were merged"
    described by "Emitted when a guest cart is merged into customer cart."
  }

  event CartCheckedOut is {
    cartId is CartId with { briefly "Cart ID" described by "Checked out cart." }
    orderId is UUID with { briefly "Order ID" described by "Resulting order." }
    total is Money with { briefly "Total" described by "Order total." }
    checkedOutAt is TimeStamp with { briefly "Checked out" described by "Checkout time." }
  } with {
    briefly "Cart was checked out"
    described by "Emitted when cart is converted to an order."
  }

  event CartAbandoned is {
    cartId is CartId with { briefly "Cart ID" described by "Abandoned cart." }
    itemCount is Natural with { briefly "Items" described by "Items in cart." }
    cartValue is Money with { briefly "Value" described by "Cart value." }
    abandonedAt is TimeStamp with { briefly "Abandoned" described by "When marked abandoned." }
  } with {
    briefly "Cart was abandoned"
    described by "Emitted when cart is marked as abandoned."
  }

  // State Records
  record ActiveCartData is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    customerId is optional CustomerId with { briefly "Customer" described by "Customer if known." }
    sessionId is SessionId with { briefly "Session" described by "Browser session." }
    items is many CartItem with { briefly "Items" described by "Cart line items." }
    discounts is many DiscountAmount with { briefly "Discounts" described by "Applied discounts." }
    shippingAddress is optional ShippingAddress with { briefly "Shipping" described by "Delivery address." }
    summary is CartSummary with { briefly "Summary" described by "Cart totals." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
    lastUpdatedAt is TimeStamp with { briefly "Updated" described by "Last update time." }
  } with {
    briefly "Active cart data"
    described by "State data for an active shopping cart."
  }

  record CheckedOutCartData is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    orderId is UUID with { briefly "Order ID" described by "Resulting order." }
    total is Money with { briefly "Total" described by "Final order total." }
    checkedOutAt is TimeStamp with { briefly "Checked out" described by "Checkout time." }
  } with {
    briefly "Checked out cart data"
    described by "State data for a cart that was converted to an order."
  }

  record AbandonedCartData is {
    cartId is CartId with { briefly "Cart ID" described by "Cart identifier." }
    customerId is optional CustomerId with { briefly "Customer" described by "Customer if known." }
    items is many CartItem with { briefly "Items" described by "Cart items at abandonment." }
    cartValue is Money with { briefly "Value" described by "Cart value." }
    abandonedAt is TimeStamp with { briefly "Abandoned" described by "When marked abandoned." }
  } with {
    briefly "Abandoned cart data"
    described by "State data for an abandoned shopping cart."
  }

  // States
  state ActiveState of Cart.ActiveCartData with {
    briefly "Cart is active"
    described by "Cart is being actively used for shopping."
  }

  state CheckedOutState of Cart.CheckedOutCartData with {
    briefly "Cart is checked out"
    described by "Cart has been converted to an order."
  }

  state AbandonedState of Cart.AbandonedCartData with {
    briefly "Cart is abandoned"
    described by "Cart was inactive and marked as abandoned."
  }

  // Handler
  handler CartHandler is {
    on command CreateCart {
      morph entity Cart to state Cart.ActiveState with command CreateCart
      tell event CartCreated to entity Cart
    }

    on command AddItem {
      tell event ItemAdded to entity Cart
    }

    on command UpdateQuantity {
      tell event ItemQuantityUpdated to entity Cart
    }

    on command RemoveItem {
      tell event ItemRemoved to entity Cart
    }

    on command ApplyPromoCode {
      tell event PromoCodeApplied to entity Cart
    }

    on command RemovePromoCode {
      tell event PromoCodeRemoved to entity Cart
    }

    on command SetShippingAddress {
      tell event ShippingAddressSet to entity Cart
    }

    on command MergeCart {
      tell event CartsMerged to entity Cart
    }

    on command Checkout {
      morph entity Cart to state Cart.CheckedOutState with command Checkout
      tell event CartCheckedOut to entity Cart
    }

    on command AbandonCart {
      morph entity Cart to state Cart.AbandonedState with command AbandonCart
      tell event CartAbandoned to entity Cart
    }
  } with {
    briefly "Processes cart commands"
    described by {
      | Handles all shopping cart operations including item management,
      | promotions, and checkout initiation.
    }
  }

} with {
  briefly "Shopping cart aggregate"
  described by {
    | The Cart entity manages a customer's shopping cart including
    | item management, pricing, discounts, and checkout initiation.
    | Supports both authenticated customers and guest sessions.
  }
}
