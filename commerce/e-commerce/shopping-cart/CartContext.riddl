// Shopping Cart - Cart Context
context CartContext is {
  include "types.riddl"
  include "Cart.riddl"
  // Adaptors for external system integration
  adaptor PricingAdapter from context PricingService is { 
    handler PricingEvents is {
      on event PricingService.PriceChanged is {
        prompt "Update item prices in active carts"
      }
      on event PricingService.PromotionActivated is {
        prompt "Apply eligible promotions to carts"
      }
    } with {
      briefly "Handles pricing events"
      described as {
        |Processes price and promotion updates.
      }
    }
  } with {
    briefly "Pricing integration"
    described as {
      |Receives pricing updates from the pricing service.
    }
  }
  adaptor InventoryAdapter from context InventoryService is { 
    handler InventoryEvents is {
      on event InventoryService.StockDepleted is {
        prompt "Mark item as out of stock in cart"
      }
      on event InventoryService.StockReplenished is {
        prompt "Update availability in carts with waiting items"
      }
    } with {
      briefly "Handles inventory events"
      described as {
        |Processes stock level updates for cart items.
      }
    }
  } with {
    briefly "Inventory integration"
    described as {
      |Receives stock updates from inventory system.
    }
  }
  adaptor OrderAdapter to context OrderService is { 
    handler OrderCreation is {
      on command OrderService.CreateOrder is {
        prompt "Create order from checked out cart"
      }
    } with {
      briefly "Handles order creation"
      described as {
        |Sends cart data to order service on checkout.
      }
    }
  } with {
    briefly "Order service integration"
    described as {
      |Creates orders from checked out carts.
    }
  }
  // Repository for cart persistence
  repository CartRepository is {
    schema CartData is relational
      of carts as type Cart
        index on field Cart.customerId
        index on field Cart.sessionId

    handler CartPersistence is {
      on command Cart.CreateCart is {
        prompt "Persist new cart to database"
      }
      on command Cart.AddItem is {
        prompt "Update cart items in database"
      }
      on command Cart.RemoveItem is {
        prompt "Remove item from cart in database"
      }
      on command Cart.UpdateQuantity is {
        prompt "Update item quantity in database"
      }
      on command Cart.ApplyPromoCode is {
        prompt "Persist applied discount"
      }
      on command Cart.Checkout is {
        prompt "Update cart status to checked out"
      }
      on command Cart.AbandonCart is {
        prompt "Update cart status to abandoned"
      }
    } with {
      briefly "Persists cart commands"
      described as {
        |Handles command-driven persistence for cart data.
      }
    }
  } with {
    briefly "Cart data persistence"
    described as {
      | The CartRepository provides persistent storage for shopping carts
      | with indexes for customer and session lookup.
    }
  }
  // Projector for cart analytics
  projector CartAnalytics is {
    record AbandonedCartMetrics is  {
      period: Date with {
        briefly "Period"
        described as {
          |Reporting period.
        }
      }
      abandonedCount: Natural with {
        briefly "Count"
        described as {
          |Abandoned carts.
        }
      }
      totalValue: Money with {
        briefly "Value"
        described as {
          |Total abandoned value.
        }
      }
      avgItems: Decimal(5,2) with {
        briefly "Avg items"
        described as {
          |Average items.
        }
      }
    } with {
      briefly "Abandoned cart metrics"
      described as {
        |Analytics for abandoned carts.
      }
    }
    handler AnalyticsHandler is {
      on event Cart.CartAbandoned is {
        prompt "Update abandoned cart metrics"
      }
      on event Cart.CartCheckedOut is {
        prompt "Update conversion metrics"
      }
    } with {
      briefly "Maintains analytics views"
      described as {
        |Projects events into analytics data.
      }
    }
  } with {
    briefly "Cart analytics projections"
    described as {
      |Maintains analytics views for cart behavior.
    }
  }
} with {
  briefly "Bounded context for shopping carts"
  described as {
    | The CartContext is the bounded context for shopping cart management.
    | It contains the Cart entity with integrations to pricing, inventory,
    | and order management systems.
  }
}
