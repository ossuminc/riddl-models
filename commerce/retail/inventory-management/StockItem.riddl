// Inventory Management - StockItem Entity

entity StockItem is {

  // Commands
  command CreateStockItem is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Unique identifier."
    }
    productId is ProductId with {
      briefly "Product ID"
      described by "Product reference."
    }
    sku is SKU with {
      briefly "SKU"
      described by "Product SKU."
    }
    location is StorageLocation with {
      briefly "Location"
      described by "Initial storage location."
    }
    initialQuantity is Quantity with {
      briefly "Initial qty"
      described by "Starting quantity."
    }
    reorderPoint is optional ReorderPoint with {
      briefly "Reorder point"
      described by "Replenishment settings."
    }
  } with {
    briefly "Create stock item"
    described by "Establishes a new inventory item at a location."
  }

  command ReceiveStock is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item receiving stock."
    }
    receipt is ReceiptInfo with {
      briefly "Receipt"
      described by "Receipt details."
    }
  } with {
    briefly "Receive inventory"
    described by "Records receipt of new inventory."
  }

  command ReserveStock is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to reserve."
    }
    orderId is UUID with {
      briefly "Order ID"
      described by "Reserving order."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Quantity to reserve."
    }
  } with {
    briefly "Reserve stock for order"
    described by "Allocates stock for a pending order."
  }

  command ReleaseReservation is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to release."
    }
    orderId is UUID with {
      briefly "Order ID"
      described by "Order releasing reservation."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Quantity to release."
    }
  } with {
    briefly "Release reserved stock"
    described by "Releases previously reserved stock."
  }

  command DeductStock is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to deduct."
    }
    orderId is UUID with {
      briefly "Order ID"
      described by "Fulfilling order."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Quantity to deduct."
    }
  } with {
    briefly "Deduct stock for fulfillment"
    described by "Removes stock when order is fulfilled."
  }

  command AdjustStock is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to adjust."
    }
    adjustment is InventoryAdjustment with {
      briefly "Adjustment"
      described by "Adjustment details."
    }
  } with {
    briefly "Adjust inventory"
    described by "Adjusts quantity for damage, theft, or count."
  }

  command TransferStock is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to transfer."
    }
    toLocation is StorageLocation with {
      briefly "To location"
      described by "Destination location."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Quantity to transfer."
    }
    transferredBy is String(1, 100) with {
      briefly "Transferred by"
      described by "Person initiating transfer."
    }
  } with {
    briefly "Transfer stock between locations"
    described by "Moves inventory to a different location."
  }

  command SetReorderPoint is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item to configure."
    }
    reorderPoint is ReorderPoint with {
      briefly "Reorder point"
      described by "Replenishment settings."
    }
  } with {
    briefly "Set reorder parameters"
    described by "Configures automatic replenishment settings."
  }

  command CreateReplenishmentOrder is {
    stockItemId is StockItemId with {
      briefly "Stock item ID"
      described by "Item needing replenishment."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Quantity to order."
    }
    requestedBy is String(1, 100) with {
      briefly "Requested by"
      described by "Who requested order."
    }
  } with {
    briefly "Create replenishment order"
    described by "Initiates purchase order for restocking."
  }

  // Events
  event StockItemCreated is {
    stockItemId is StockItemId with { briefly "ID" described by "New item ID." }
    productId is ProductId with { briefly "Product" described by "Product reference." }
    sku is SKU with { briefly "SKU" described by "Product SKU." }
    location is StorageLocation with { briefly "Location" described by "Storage location." }
    initialQuantity is Quantity with { briefly "Qty" described by "Initial quantity." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Stock item was created"
    described by "Emitted when new inventory item is established."
  }

  event StockReceived is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    quantityReceived is Quantity with { briefly "Received" described by "Quantity received." }
    newOnHand is Quantity with { briefly "On hand" described by "New on-hand quantity." }
    receipt is ReceiptInfo with { briefly "Receipt" described by "Receipt details." }
    receivedAt is TimeStamp with { briefly "Received at" described by "Receipt time." }
  } with {
    briefly "Stock was received"
    described by "Emitted when inventory is received."
  }

  event StockReserved is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    orderId is UUID with { briefly "Order" described by "Reserving order." }
    quantity is Quantity with { briefly "Qty" described by "Reserved quantity." }
    newAvailable is Quantity with { briefly "Available" described by "New available qty." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "Reservation time." }
  } with {
    briefly "Stock was reserved"
    described by "Emitted when stock is allocated to an order."
  }

  event ReservationReleased is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    orderId is UUID with { briefly "Order" described by "Released order." }
    quantity is Quantity with { briefly "Qty" described by "Released quantity." }
    newAvailable is Quantity with { briefly "Available" described by "New available qty." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
  } with {
    briefly "Reservation was released"
    described by "Emitted when stock reservation is cancelled."
  }

  event StockDeducted is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    orderId is UUID with { briefly "Order" described by "Fulfilled order." }
    quantity is Quantity with { briefly "Qty" described by "Deducted quantity." }
    newOnHand is Quantity with { briefly "On hand" described by "New on-hand qty." }
    deductedAt is TimeStamp with { briefly "Deducted" described by "Deduction time." }
  } with {
    briefly "Stock was deducted"
    described by "Emitted when stock is removed for fulfillment."
  }

  event StockAdjusted is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    adjustment is InventoryAdjustment with { briefly "Adjustment" described by "Adjustment details." }
    newOnHand is Quantity with { briefly "On hand" described by "New on-hand qty." }
    adjustedAt is TimeStamp with { briefly "Adjusted" described by "Adjustment time." }
  } with {
    briefly "Stock was adjusted"
    described by "Emitted when inventory is adjusted."
  }

  event StockTransferred is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    fromLocation is StorageLocation with { briefly "From" described by "Source location." }
    toLocation is StorageLocation with { briefly "To" described by "Destination location." }
    quantity is Quantity with { briefly "Qty" described by "Transferred quantity." }
    transferredAt is TimeStamp with { briefly "Transferred" described by "Transfer time." }
  } with {
    briefly "Stock was transferred"
    described by "Emitted when stock moves between locations."
  }

  event LowStockDetected is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    currentQuantity is Quantity with { briefly "Current" described by "Current quantity." }
    reorderPoint is Quantity with { briefly "Reorder at" described by "Reorder threshold." }
    detectedAt is TimeStamp with { briefly "Detected" described by "Detection time." }
  } with {
    briefly "Low stock was detected"
    described by "Emitted when stock falls below reorder point."
  }

  event ReplenishmentOrderCreated is {
    stockItemId is StockItemId with { briefly "ID" described by "Item ID." }
    purchaseOrderId is UUID with { briefly "PO ID" described by "Created order." }
    quantity is Quantity with { briefly "Qty" described by "Order quantity." }
    createdAt is TimeStamp with { briefly "Created" described by "Order creation time." }
  } with {
    briefly "Replenishment order was created"
    described by "Emitted when restock order is generated."
  }

  // State Records
  record ActiveStockData is {
    stockItemId is StockItemId with { briefly "ID" described by "Item identifier." }
    productId is ProductId with { briefly "Product" described by "Product reference." }
    sku is SKU with { briefly "SKU" described by "Product SKU." }
    location is StorageLocation with { briefly "Location" described by "Storage location." }
    quantityOnHand is Quantity with { briefly "On hand" described by "Current quantity." }
    quantityReserved is Quantity with { briefly "Reserved" described by "Reserved quantity." }
    quantityAvailable is Quantity with { briefly "Available" described by "Available quantity." }
    reorderPoint is optional ReorderPoint with { briefly "Reorder" described by "Reorder settings." }
    unitCost is Money with { briefly "Cost" described by "Unit cost." }
    lastReceivedAt is optional TimeStamp with { briefly "Last received" described by "Last receipt." }
    lastAdjustedAt is optional TimeStamp with { briefly "Last adjusted" described by "Last adjustment." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active stock data"
    described by "State data for an active inventory item."
  }

  // States
  state ActiveState of StockItem.ActiveStockData with {
    briefly "Stock item is active"
    described by "Item is actively tracked in inventory."
  }

  // Handler
  handler StockItemHandler is {
    on command CreateStockItem {
      morph entity InventoryContext.StockItem to state InventoryContext.StockItem.ActiveState with command CreateStockItem
      tell event StockItemCreated to entity InventoryContext.StockItem
    }

    on command ReceiveStock {
      tell event StockReceived to entity InventoryContext.StockItem
    }

    on command ReserveStock {
      tell event StockReserved to entity InventoryContext.StockItem
    }

    on command ReleaseReservation {
      tell event ReservationReleased to entity InventoryContext.StockItem
    }

    on command DeductStock {
      tell event StockDeducted to entity InventoryContext.StockItem
    }

    on command AdjustStock {
      tell event StockAdjusted to entity InventoryContext.StockItem
    }

    on command TransferStock {
      tell event StockTransferred to entity InventoryContext.StockItem
    }

    on command CreateReplenishmentOrder {
      tell event ReplenishmentOrderCreated to entity InventoryContext.StockItem
    }
  } with {
    briefly "Processes stock commands"
    described by {
      | Handles inventory operations including receiving, reservations,
      | adjustments, and transfers.
    }
  }

} with {
  briefly "Inventory stock item aggregate"
  described by {
    | The StockItem entity tracks inventory for a product at a specific
    | location including quantities, reservations, and replenishment.
  }
}
