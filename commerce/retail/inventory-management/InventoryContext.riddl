// Inventory Management - Inventory Context

context InventoryContext is {

  include "types.riddl"
  include "StockItem.riddl"

  // Adaptors for external system integration
  adaptor OrderAdapter from context OrderService is {
    handler OrderEvents is {
      on event OrderService.OrderPlaced {
        prompt "Reserve stock for order items"
      }
      on event OrderService.OrderCancelled {
        prompt "Release reserved stock"
      }
      on event OrderService.OrderFulfilled {
        prompt "Deduct fulfilled stock"
      }
    } with {
      briefly "Handles order events"
      described by "Processes orders for stock allocation."
    }
  } with {
    briefly "Order integration"
    described by "Receives order events for inventory allocation."
  }

  adaptor PurchasingAdapter to context PurchasingService is {
    handler ReplenishmentEvents is {
      on event StockItem.LowStockDetected {
        prompt "Create purchase requisition"
      }
      on event StockItem.ReplenishmentOrderCreated {
        prompt "Submit purchase order"
      }
    } with {
      briefly "Handles replenishment"
      described by "Sends restock requests to purchasing."
    }
  } with {
    briefly "Purchasing integration"
    described by "Publishes replenishment needs to purchasing."
  }

  adaptor ReceivingAdapter from context ReceivingService is {
    handler ReceivingEvents is {
      on event ReceivingService.GoodsReceived {
        prompt "Update stock quantities from receipt"
      }
      on event ReceivingService.ReceiptDiscrepancy {
        prompt "Flag discrepancy for review"
      }
    } with {
      briefly "Handles receiving events"
      described by "Processes goods receipt notifications."
    }
  } with {
    briefly "Receiving integration"
    described by "Receives goods receipt notifications."
  }

  // Repository for inventory persistence
  repository InventoryRepository is {
    schema InventoryData is relational
      of stockItems as StockItem
      index on field StockItem.productId
      index on field StockItem.sku
      index on field StockItem.location

    handler InventoryPersistence is {
      on command StockItem.CreateStockItem {
        prompt "Persist new stock item"
      }
      on command StockItem.ReceiveStock {
        prompt "Update stock quantities"
      }
      on command StockItem.ReserveStock {
        prompt "Update reservations"
      }
      on command StockItem.DeductStock {
        prompt "Update on-hand quantities"
      }
      on command StockItem.AdjustStock {
        prompt "Record adjustment and update quantities"
      }
      on command StockItem.TransferStock {
        prompt "Update location quantities"
      }
    } with {
      briefly "Persists inventory commands"
      described by "Handles command-driven persistence for inventory."
    }
  } with {
    briefly "Inventory data persistence"
    described by {
      | The InventoryRepository provides persistent storage for stock
      | items with indexes for product and location lookup.
    }
  }

  // Projector for inventory views
  projector InventoryViews is {
    updates repository InventoryRepository

    record LocationInventorySummary is {
      locationId is LocationId with { briefly "Location" described by "Location ID." }
      locationName is String(1, 100) with { briefly "Name" described by "Location name." }
      totalItems is Natural with { briefly "Items" described by "Total unique items." }
      totalUnits is Quantity with { briefly "Units" described by "Total units on hand." }
      totalValue is Money with { briefly "Value" described by "Total inventory value." }
    } with {
      briefly "Location inventory summary"
      described by "Aggregated inventory for a location."
    }

    handler ViewHandler is {
      on event StockItem.StockReceived {
        prompt "Update location summary"
      }
      on event StockItem.StockDeducted {
        prompt "Update location summary"
      }
      on event StockItem.StockTransferred {
        prompt "Update both location summaries"
      }
    } with {
      briefly "Maintains inventory views"
      described by "Projects events into summary views."
    }
  } with {
    briefly "Inventory view projections"
    described by "Maintains summarized views of inventory."
  }

} with {
  briefly "Bounded context for inventory management"
  described by {
    | The InventoryContext is the bounded context for stock tracking.
    | It manages inventory levels, reservations, and replenishment
    | across locations.
  }
}
