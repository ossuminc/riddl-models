// Point of Sale - Transaction Entity
entity Transaction is {
  // Commands
  command StartTransaction is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Unique identifier.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal ID"
      described as {
        |Operating terminal.
      }
    }
    cashierId: CashierId with {
      briefly "Cashier ID"
      described as {
        |Operating cashier.
      }
    }
  } with {
    briefly "Start new transaction"
    described as {
      |Initializes a new POS transaction.
    }
  }
  command AddLineItem is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Active transaction.
      }
    }
    productId: ProductId with {
      briefly "Product ID"
      described as {
        |Product to add.
      }
    }
    sku: SKU with {
      briefly "SKU"
      described as {
        |Product SKU.
      }
    }
    barcode: Barcode with {
      briefly "Barcode"
      described as {
        |Scanned barcode.
      }
    }
    description: String(1,200) with {
      briefly "Description"
      described as {
        |Product description.
      }
    }
    quantity: Quantity with {
      briefly "Quantity"
      described as {
        |Units to add.
      }
    }
    unitPrice: Money with {
      briefly "Unit price"
      described as {
        |Price per unit.
      }
    }
  } with {
    briefly "Add item to transaction"
    described as {
      |Adds a scanned item to the transaction.
    }
  }
  command VoidLineItem is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Active transaction.
      }
    }
    lineNumber: Natural with {
      briefly "Line number"
      described as {
        |Line to void.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
  } with {
    briefly "Void a line item"
    described as {
      |Removes an item from the transaction.
    }
  }
  command ApplyDiscount is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Active transaction.
      }
    }
    discount: DiscountInfo with {
      briefly "Discount"
      described as {
        |Discount to apply.
      }
    }
    targetLineNumber: Natural? with {
      briefly "Line number"
      described as {
        |Specific line, or whole transaction.
      }
    }
  } with {
    briefly "Apply discount"
    described as {
      |Applies a discount to item or transaction.
    }
  }
  command ProcessPayment is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Transaction to pay.
      }
    }
    tender: PaymentTender with {
      briefly "Tender"
      described as {
        |Payment tender.
      }
    }
  } with {
    briefly "Process payment"
    described as {
      |Processes a payment for the transaction.
    }
  }
  command CompleteTransaction is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Transaction to complete.
      }
    }
  } with {
    briefly "Complete transaction"
    described as {
      |Finalizes the transaction after full payment.
    }
  }
  command VoidTransaction is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Transaction to void.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    authorizedBy: CashierId? with {
      briefly "Authorized by"
      described as {
        |Manager authorization if required.
      }
    }
  } with {
    briefly "Void transaction"
    described as {
      |Cancels the entire transaction.
    }
  }
  command SuspendTransaction is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Transaction to suspend.
      }
    }
  } with {
    briefly "Suspend transaction"
    described as {
      |Puts transaction on hold for later.
    }
  }
  command ResumeTransaction is  {
    transactionId: TransactionId with {
      briefly "Transaction ID"
      described as {
        |Transaction to resume.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal ID"
      described as {
        |Resuming terminal.
      }
    }
  } with {
    briefly "Resume transaction"
    described as {
      |Continues a suspended transaction.
    }
  }
  // Events
  event TransactionStarted is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal"
      described as {
        |Terminal ID.
      }
    }
    cashierId: CashierId with {
      briefly "Cashier"
      described as {
        |Cashier ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Transaction was started"
    described as {
      |Emitted when new transaction begins.
    }
  }
  event LineItemAdded is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    lineItem: LineItem with {
      briefly "Item"
      described as {
        |Added line item.
      }
    }
    newTotal: Money with {
      briefly "Total"
      described as {
        |New transaction total.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |When added.
      }
    }
  } with {
    briefly "Line item was added"
    described as {
      |Emitted when item is scanned.
    }
  }
  event LineItemVoided is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    lineNumber: Natural with {
      briefly "Line"
      described as {
        |Voided line.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    newTotal: Money with {
      briefly "Total"
      described as {
        |New transaction total.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |When voided.
      }
    }
  } with {
    briefly "Line item was voided"
    described as {
      |Emitted when item is removed.
    }
  }
  event DiscountApplied is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    discount: DiscountInfo with {
      briefly "Discount"
      described as {
        |Applied discount.
      }
    }
    targetLineNumber: Natural? with {
      briefly "Line"
      described as {
        |Affected line.
      }
    }
    newTotal: Money with {
      briefly "Total"
      described as {
        |New transaction total.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |When applied.
      }
    }
  } with {
    briefly "Discount was applied"
    described as {
      |Emitted when discount is applied.
    }
  }
  event PaymentProcessed is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    tender: PaymentTender with {
      briefly "Tender"
      described as {
        |Payment tender.
      }
    }
    remainingBalance: Money with {
      briefly "Balance"
      described as {
        |Remaining to pay.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |When processed.
      }
    }
  } with {
    briefly "Payment was processed"
    described as {
      |Emitted when payment is applied.
    }
  }
  event TransactionCompleted is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    totals: TransactionTotals with {
      briefly "Totals"
      described as {
        |Final totals.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Transaction was completed"
    described as {
      |Emitted when transaction is finalized.
    }
  }
  event TransactionVoided is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |When voided.
      }
    }
  } with {
    briefly "Transaction was voided"
    described as {
      |Emitted when transaction is cancelled.
    }
  }
  event TransactionSuspended is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |When suspended.
      }
    }
  } with {
    briefly "Transaction was suspended"
    described as {
      |Emitted when transaction is put on hold.
    }
  }
  event TransactionResumed is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal"
      described as {
        |Resuming terminal.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |When resumed.
      }
    }
  } with {
    briefly "Transaction was resumed"
    described as {
      |Emitted when suspended transaction continues.
    }
  }
  // State Records
  record ActiveTransactionData is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal"
      described as {
        |Terminal ID.
      }
    }
    cashierId: CashierId with {
      briefly "Cashier"
      described as {
        |Cashier ID.
      }
    }
    lineItems: LineItem+ with {
      briefly "Items"
      described as {
        |Line items.
      }
    }
    discounts: DiscountInfo+ with {
      briefly "Discounts"
      described as {
        |Discounts.
      }
    }
    payments: PaymentTender+ with {
      briefly "Payments"
      described as {
        |Payments.
      }
    }
    totals: TransactionTotals with {
      briefly "Totals"
      described as {
        |Current totals.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Active transaction data"
    described as {
      |State data for an in-progress transaction.
    }
  }
  record CompletedTransactionData is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    terminalId: TerminalId with {
      briefly "Terminal"
      described as {
        |Terminal ID.
      }
    }
    cashierId: CashierId with {
      briefly "Cashier"
      described as {
        |Cashier ID.
      }
    }
    lineItems: LineItem+ with {
      briefly "Items"
      described as {
        |Line items.
      }
    }
    payments: PaymentTender+ with {
      briefly "Payments"
      described as {
        |Payments.
      }
    }
    totals: TransactionTotals with {
      briefly "Totals"
      described as {
        |Final totals.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed transaction data"
    described as {
      |State data for a finalized transaction.
    }
  }
  record VoidedTransactionData is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |When voided.
      }
    }
  } with {
    briefly "Voided transaction data"
    described as {
      |State data for a cancelled transaction.
    }
  }
  record SuspendedTransactionData is  {
    transactionId: TransactionId with {
      briefly "ID"
      described as {
        |Transaction ID.
      }
    }
    lineItems: LineItem+ with {
      briefly "Items"
      described as {
        |Line items.
      }
    }
    totals: TransactionTotals with {
      briefly "Totals"
      described as {
        |Current totals.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |When suspended.
      }
    }
  } with {
    briefly "Suspended transaction data"
    described as {
      |State data for a transaction on hold.
    }
  }
  // States
  state ActiveState of type Transaction.ActiveTransactionData
  state CompletedState of type Transaction.CompletedTransactionData
  state VoidedState of type Transaction.VoidedTransactionData
  state SuspendedState of type Transaction.SuspendedTransactionData
  // Handler
  handler TransactionHandler is {
    on command StartTransaction is {
      morph entity POSContext.Transaction to state POSContext.Transaction.ActiveState with command StartTransaction
      tell event TransactionStarted to entity POSContext.Transaction
    }
    on command AddLineItem is {
      tell event LineItemAdded to entity POSContext.Transaction
    }
    on command VoidLineItem is {
      tell event LineItemVoided to entity POSContext.Transaction
    }
    on command ApplyDiscount is {
      tell event DiscountApplied to entity POSContext.Transaction
    }
    on command ProcessPayment is {
      tell event PaymentProcessed to entity POSContext.Transaction
    }
    on command CompleteTransaction is {
      morph entity POSContext.Transaction to state POSContext.Transaction.CompletedState with command CompleteTransaction
      tell event TransactionCompleted to entity POSContext.Transaction
    }
    on command VoidTransaction is {
      morph entity POSContext.Transaction to state POSContext.Transaction.VoidedState with command VoidTransaction
      tell event TransactionVoided to entity POSContext.Transaction
    }
    on command SuspendTransaction is {
      morph entity POSContext.Transaction to state POSContext.Transaction.SuspendedState with command SuspendTransaction
      tell event TransactionSuspended to entity POSContext.Transaction
    }
    on command ResumeTransaction is {
      morph entity POSContext.Transaction to state POSContext.Transaction.ActiveState with command ResumeTransaction
      tell event TransactionResumed to entity POSContext.Transaction
    }
  } with {
    briefly "Processes transaction commands"
    described as {
      | Handles POS transaction operations including item scanning,
      | discounts, payments, and transaction lifecycle.
    }
  }
} with {
  briefly "POS transaction aggregate"
  described as {
    | The Transaction entity manages point of sale transactions including
    | line items, discounts, payments, and receipts.
  }
}
