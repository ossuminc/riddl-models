// Point of Sale - Transaction Entity

entity Transaction is {

  // Commands
  command StartTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Unique identifier."
    }
    terminalId is TerminalId with {
      briefly "Terminal ID"
      described by "Operating terminal."
    }
    cashierId is CashierId with {
      briefly "Cashier ID"
      described by "Operating cashier."
    }
  } with {
    briefly "Start new transaction"
    described by "Initializes a new POS transaction."
  }

  command AddLineItem is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Active transaction."
    }
    productId is ProductId with {
      briefly "Product ID"
      described by "Product to add."
    }
    sku is SKU with {
      briefly "SKU"
      described by "Product SKU."
    }
    barcode is Barcode with {
      briefly "Barcode"
      described by "Scanned barcode."
    }
    description is String(1, 200) with {
      briefly "Description"
      described by "Product description."
    }
    quantity is Quantity with {
      briefly "Quantity"
      described by "Units to add."
    }
    unitPrice is Money with {
      briefly "Unit price"
      described by "Price per unit."
    }
  } with {
    briefly "Add item to transaction"
    described by "Adds a scanned item to the transaction."
  }

  command VoidLineItem is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Active transaction."
    }
    lineNumber is Natural with {
      briefly "Line number"
      described by "Line to void."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Void reason."
    }
  } with {
    briefly "Void a line item"
    described by "Removes an item from the transaction."
  }

  command ApplyDiscount is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Active transaction."
    }
    discount is DiscountInfo with {
      briefly "Discount"
      described by "Discount to apply."
    }
    targetLineNumber is optional Natural with {
      briefly "Line number"
      described by "Specific line, or whole transaction."
    }
  } with {
    briefly "Apply discount"
    described by "Applies a discount to item or transaction."
  }

  command ProcessPayment is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction to pay."
    }
    tender is PaymentTender with {
      briefly "Tender"
      described by "Payment tender."
    }
  } with {
    briefly "Process payment"
    described by "Processes a payment for the transaction."
  }

  command CompleteTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction to complete."
    }
  } with {
    briefly "Complete transaction"
    described by "Finalizes the transaction after full payment."
  }

  command VoidTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction to void."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Void reason."
    }
    authorizedBy is optional CashierId with {
      briefly "Authorized by"
      described by "Manager authorization if required."
    }
  } with {
    briefly "Void transaction"
    described by "Cancels the entire transaction."
  }

  command SuspendTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction to suspend."
    }
  } with {
    briefly "Suspend transaction"
    described by "Puts transaction on hold for later."
  }

  command ResumeTransaction is {
    transactionId is TransactionId with {
      briefly "Transaction ID"
      described by "Transaction to resume."
    }
    terminalId is TerminalId with {
      briefly "Terminal ID"
      described by "Resuming terminal."
    }
  } with {
    briefly "Resume transaction"
    described by "Continues a suspended transaction."
  }

  // Events
  event TransactionStarted is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    terminalId is TerminalId with { briefly "Terminal" described by "Terminal ID." }
    cashierId is CashierId with { briefly "Cashier" described by "Cashier ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Transaction was started"
    described by "Emitted when new transaction begins."
  }

  event LineItemAdded is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    lineItem is LineItem with { briefly "Item" described by "Added line item." }
    newTotal is Money with { briefly "Total" described by "New transaction total." }
    addedAt is TimeStamp with { briefly "Added" described by "When added." }
  } with {
    briefly "Line item was added"
    described by "Emitted when item is scanned."
  }

  event LineItemVoided is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    lineNumber is Natural with { briefly "Line" described by "Voided line." }
    reason is String(1, 200) with { briefly "Reason" described by "Void reason." }
    newTotal is Money with { briefly "Total" described by "New transaction total." }
    voidedAt is TimeStamp with { briefly "Voided" described by "When voided." }
  } with {
    briefly "Line item was voided"
    described by "Emitted when item is removed."
  }

  event DiscountApplied is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    discount is DiscountInfo with { briefly "Discount" described by "Applied discount." }
    targetLineNumber is optional Natural with { briefly "Line" described by "Affected line." }
    newTotal is Money with { briefly "Total" described by "New transaction total." }
    appliedAt is TimeStamp with { briefly "Applied" described by "When applied." }
  } with {
    briefly "Discount was applied"
    described by "Emitted when discount is applied."
  }

  event PaymentProcessed is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    tender is PaymentTender with { briefly "Tender" described by "Payment tender." }
    remainingBalance is Money with { briefly "Balance" described by "Remaining to pay." }
    processedAt is TimeStamp with { briefly "Processed" described by "When processed." }
  } with {
    briefly "Payment was processed"
    described by "Emitted when payment is applied."
  }

  event TransactionCompleted is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    totals is TransactionTotals with { briefly "Totals" described by "Final totals." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Transaction was completed"
    described by "Emitted when transaction is finalized."
  }

  event TransactionVoided is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "When voided." }
  } with {
    briefly "Transaction was voided"
    described by "Emitted when transaction is cancelled."
  }

  event TransactionSuspended is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "When suspended." }
  } with {
    briefly "Transaction was suspended"
    described by "Emitted when transaction is put on hold."
  }

  event TransactionResumed is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    terminalId is TerminalId with { briefly "Terminal" described by "Resuming terminal." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "When resumed." }
  } with {
    briefly "Transaction was resumed"
    described by "Emitted when suspended transaction continues."
  }

  // State Records
  record ActiveTransactionData is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    terminalId is TerminalId with { briefly "Terminal" described by "Terminal ID." }
    cashierId is CashierId with { briefly "Cashier" described by "Cashier ID." }
    lineItems is many LineItem with { briefly "Items" described by "Line items." }
    discounts is many DiscountInfo with { briefly "Discounts" described by "Discounts." }
    payments is many PaymentTender with { briefly "Payments" described by "Payments." }
    totals is TransactionTotals with { briefly "Totals" described by "Current totals." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Active transaction data"
    described by "State data for an in-progress transaction."
  }

  record CompletedTransactionData is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    terminalId is TerminalId with { briefly "Terminal" described by "Terminal ID." }
    cashierId is CashierId with { briefly "Cashier" described by "Cashier ID." }
    lineItems is many LineItem with { briefly "Items" described by "Line items." }
    payments is many PaymentTender with { briefly "Payments" described by "Payments." }
    totals is TransactionTotals with { briefly "Totals" described by "Final totals." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed transaction data"
    described by "State data for a finalized transaction."
  }

  record VoidedTransactionData is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "When voided." }
  } with {
    briefly "Voided transaction data"
    described by "State data for a cancelled transaction."
  }

  record SuspendedTransactionData is {
    transactionId is TransactionId with { briefly "ID" described by "Transaction ID." }
    lineItems is many LineItem with { briefly "Items" described by "Line items." }
    totals is TransactionTotals with { briefly "Totals" described by "Current totals." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "When suspended." }
  } with {
    briefly "Suspended transaction data"
    described by "State data for a transaction on hold."
  }

  // States
  state ActiveState of Transaction.ActiveTransactionData with {
    briefly "Transaction is active"
    described by "Transaction is in progress."
  }

  state CompletedState of Transaction.CompletedTransactionData with {
    briefly "Transaction is completed"
    described by "Transaction is finalized."
  }

  state VoidedState of Transaction.VoidedTransactionData with {
    briefly "Transaction is voided"
    described by "Transaction was cancelled."
  }

  state SuspendedState of Transaction.SuspendedTransactionData with {
    briefly "Transaction is suspended"
    described by "Transaction is on hold."
  }

  // Handler
  handler TransactionHandler is {
    on command StartTransaction {
      morph entity POSContext.Transaction to state POSContext.Transaction.ActiveState with command StartTransaction
      tell event TransactionStarted to entity POSContext.Transaction
    }

    on command AddLineItem {
      tell event LineItemAdded to entity POSContext.Transaction
    }

    on command VoidLineItem {
      tell event LineItemVoided to entity POSContext.Transaction
    }

    on command ApplyDiscount {
      tell event DiscountApplied to entity POSContext.Transaction
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity POSContext.Transaction
    }

    on command CompleteTransaction {
      morph entity POSContext.Transaction to state POSContext.Transaction.CompletedState with command CompleteTransaction
      tell event TransactionCompleted to entity POSContext.Transaction
    }

    on command VoidTransaction {
      morph entity POSContext.Transaction to state POSContext.Transaction.VoidedState with command VoidTransaction
      tell event TransactionVoided to entity POSContext.Transaction
    }

    on command SuspendTransaction {
      morph entity POSContext.Transaction to state POSContext.Transaction.SuspendedState with command SuspendTransaction
      tell event TransactionSuspended to entity POSContext.Transaction
    }

    on command ResumeTransaction {
      morph entity POSContext.Transaction to state POSContext.Transaction.ActiveState with command ResumeTransaction
      tell event TransactionResumed to entity POSContext.Transaction
    }
  } with {
    briefly "Processes transaction commands"
    described by {
      | Handles POS transaction operations including item scanning,
      | discounts, payments, and transaction lifecycle.
    }
  }

} with {
  briefly "POS transaction aggregate"
  described by {
    | The Transaction entity manages point of sale transactions including
    | line items, discounts, payments, and receipts.
  }
}
