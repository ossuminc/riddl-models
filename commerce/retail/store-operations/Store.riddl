// Store Operations - Store Entity

entity Store is {

  // Commands
  command OpenStore is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store to open."
    }
    managerId is EmployeeId with {
      briefly "Manager"
      described by "Opening manager."
    }
    actualOpeningTime is TimeStamp with {
      briefly "Opening time"
      described by "Actual opening time."
    }
  } with {
    briefly "Open store for business"
    described by "Records store opening and enables operations."
  }

  command CloseStore is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store to close."
    }
    managerId is EmployeeId with {
      briefly "Manager"
      described by "Closing manager."
    }
    actualClosingTime is TimeStamp with {
      briefly "Closing time"
      described by "Actual closing time."
    }
  } with {
    briefly "Close store"
    described by "Records store closing for the day."
  }

  command StartShift is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    shift is ShiftInfo with {
      briefly "Shift"
      described by "Shift details."
    }
  } with {
    briefly "Start employee shift"
    described by "Records an employee starting their shift."
  }

  command EndShift is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    shiftId is ShiftId with {
      briefly "Shift ID"
      described by "Shift to end."
    }
    actualEndTime is TimeStamp with {
      briefly "End time"
      described by "Actual end time."
    }
  } with {
    briefly "End employee shift"
    described by "Records an employee ending their shift."
  }

  command OpenRegister is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    registerId is RegisterId with {
      briefly "Register"
      described by "Register to open."
    }
    cashierId is EmployeeId with {
      briefly "Cashier"
      described by "Operating cashier."
    }
    openingBalance is Money with {
      briefly "Opening balance"
      described by "Starting cash amount."
    }
  } with {
    briefly "Open cash register"
    described by "Opens a register with starting cash."
  }

  command CloseRegister is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    registerId is RegisterId with {
      briefly "Register"
      described by "Register to close."
    }
    countedBalance is Money with {
      briefly "Counted"
      described by "Counted cash amount."
    }
  } with {
    briefly "Close cash register"
    described by "Closes register with cash count."
  }

  command RecordIncident is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    incident is IncidentReport with {
      briefly "Incident"
      described by "Incident details."
    }
  } with {
    briefly "Record operational incident"
    described by "Logs an incident for the store."
  }

  command AssignTask is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    task is OperationalTask with {
      briefly "Task"
      described by "Task to assign."
    }
  } with {
    briefly "Assign operational task"
    described by "Creates and assigns a task to staff."
  }

  command CompleteTask is {
    storeId is StoreId with {
      briefly "Store ID"
      described by "Store location."
    }
    taskId is UUID with {
      briefly "Task ID"
      described by "Task to complete."
    }
    completedBy is EmployeeId with {
      briefly "Completed by"
      described by "Employee who completed."
    }
  } with {
    briefly "Complete operational task"
    described by "Marks a task as completed."
  }

  // Events
  event StoreOpened is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    managerId is EmployeeId with { briefly "Manager" described by "Opening manager." }
    openedAt is TimeStamp with { briefly "Opened" described by "Opening time." }
  } with {
    briefly "Store was opened"
    described by "Emitted when store opens for business."
  }

  event StoreClosed is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    managerId is EmployeeId with { briefly "Manager" described by "Closing manager." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closing time." }
  } with {
    briefly "Store was closed"
    described by "Emitted when store closes."
  }

  event ShiftStarted is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    shift is ShiftInfo with { briefly "Shift" described by "Started shift." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Shift was started"
    described by "Emitted when employee starts shift."
  }

  event ShiftEnded is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    shiftId is ShiftId with { briefly "Shift" described by "Ended shift." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Shift was ended"
    described by "Emitted when employee ends shift."
  }

  event RegisterOpened is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    registerId is RegisterId with { briefly "Register" described by "Opened register." }
    cashierId is EmployeeId with { briefly "Cashier" described by "Operator." }
    openingBalance is Money with { briefly "Balance" described by "Starting cash." }
    openedAt is TimeStamp with { briefly "Opened" described by "Open time." }
  } with {
    briefly "Register was opened"
    described by "Emitted when register is opened."
  }

  event RegisterClosed is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    registerId is RegisterId with { briefly "Register" described by "Closed register." }
    drawer is CashDrawer with { briefly "Drawer" described by "Final drawer state." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Register was closed"
    described by "Emitted when register is closed."
  }

  event IncidentRecorded is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    incident is IncidentReport with { briefly "Incident" described by "Recorded incident." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Incident was recorded"
    described by "Emitted when incident is logged."
  }

  event TaskAssigned is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    task is OperationalTask with { briefly "Task" described by "Assigned task." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Task was assigned"
    described by "Emitted when task is created."
  }

  event TaskCompleted is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    taskId is UUID with { briefly "Task" described by "Completed task." }
    completedBy is EmployeeId with { briefly "Completed by" described by "Employee." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Task was completed"
    described by "Emitted when task is finished."
  }

  // State Records
  record OpenStoreData is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    name is String(1, 200) with { briefly "Name" described by "Store name." }
    status is StoreStatus with { briefly "Status" described by "Current status." }
    activeShifts is many ShiftInfo with { briefly "Shifts" described by "Active shifts." }
    openRegisters is many RegisterId with { briefly "Registers" described by "Open registers." }
    pendingTasks is many OperationalTask with { briefly "Tasks" described by "Pending tasks." }
    todaysIncidents is many IncidentReport with { briefly "Incidents" described by "Today's incidents." }
    openedAt is TimeStamp with { briefly "Opened" described by "Open time." }
    openedBy is EmployeeId with { briefly "Opened by" described by "Opening manager." }
  } with {
    briefly "Open store data"
    described by "State data for an open store."
  }

  record ClosedStoreData is {
    storeId is StoreId with { briefly "Store" described by "Store ID." }
    name is String(1, 200) with { briefly "Name" described by "Store name." }
    lastClosedAt is TimeStamp with { briefly "Closed" described by "Last close time." }
    lastClosedBy is EmployeeId with { briefly "Closed by" described by "Closing manager." }
  } with {
    briefly "Closed store data"
    described by "State data for a closed store."
  }

  // States
  state OpenState of Store.OpenStoreData with {
    briefly "Store is open"
    described by "Store is open for business."
  }

  state ClosedState of Store.ClosedStoreData with {
    briefly "Store is closed"
    described by "Store is closed."
  }

  // Handler
  handler StoreHandler is {
    on command OpenStore {
      morph entity StoreContext.Store to state StoreContext.Store.OpenState with command OpenStore
      tell event StoreOpened to entity StoreContext.Store
    }

    on command CloseStore {
      morph entity StoreContext.Store to state StoreContext.Store.ClosedState with command CloseStore
      tell event StoreClosed to entity StoreContext.Store
    }

    on command StartShift {
      tell event ShiftStarted to entity StoreContext.Store
    }

    on command EndShift {
      tell event ShiftEnded to entity StoreContext.Store
    }

    on command OpenRegister {
      tell event RegisterOpened to entity StoreContext.Store
    }

    on command CloseRegister {
      tell event RegisterClosed to entity StoreContext.Store
    }

    on command RecordIncident {
      tell event IncidentRecorded to entity StoreContext.Store
    }

    on command AssignTask {
      tell event TaskAssigned to entity StoreContext.Store
    }

    on command CompleteTask {
      tell event TaskCompleted to entity StoreContext.Store
    }
  } with {
    briefly "Processes store commands"
    described by {
      | Handles store operations including opening, closing,
      | shift management, and incident reporting.
    }
  }

} with {
  briefly "Retail store aggregate"
  described by {
    | The Store entity manages daily operations of a retail location
    | including scheduling, cash management, and incident tracking.
  }
}
