// Trade Credit - CreditAccount Entity
entity CreditAccount is {
  // Commands
  command ApplyForCredit is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |New account identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Applying customer.
      }
    }
    requestedLimit: Money with {
      briefly "Requested limit"
      described as {
        |Requested credit limit.
      }
    }
    requestedTerms: CreditTerms with {
      briefly "Requested terms"
      described as {
        |Requested payment terms.
      }
    }
  } with {
    briefly "Apply for credit"
    described as {
      |Submits a credit application.
    }
  }
  command ApproveCredit is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to approve.
      }
    }
    creditLimit: CreditLimit with {
      briefly "Limit"
      described as {
        |Approved credit limit.
      }
    }
    terms: CreditTerms with {
      briefly "Terms"
      described as {
        |Approved credit terms.
      }
    }
    riskLevel: CreditRisk with {
      briefly "Risk"
      described as {
        |Assessed risk level.
      }
    }
  } with {
    briefly "Approve credit application"
    described as {
      |Approves credit with specified terms.
    }
  }
  command DenyCredit is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to deny.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Who denied.
      }
    }
  } with {
    briefly "Deny credit application"
    described as {
      |Denies credit application.
    }
  }
  command PostInvoice is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to invoice.
      }
    }
    invoice: Invoice with {
      briefly "Invoice"
      described as {
        |Invoice to post.
      }
    }
  } with {
    briefly "Post invoice to account"
    described as {
      |Posts an invoice to the credit account.
    }
  }
  command ApplyPayment is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to credit.
      }
    }
    payment: Payment with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    targetInvoiceId: InvoiceId? with {
      briefly "Invoice"
      described as {
        |Specific invoice to apply to.
      }
    }
  } with {
    briefly "Apply payment"
    described as {
      |Applies a payment to the account.
    }
  }
  command AdjustCreditLimit is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to adjust.
      }
    }
    newLimit: CreditLimit with {
      briefly "New limit"
      described as {
        |Adjusted credit limit.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Adjustment reason.
      }
    }
  } with {
    briefly "Adjust credit limit"
    described as {
      |Changes the credit limit.
    }
  }
  command SuspendAccount is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to suspend.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedBy: String(1,100) with {
      briefly "Suspended by"
      described as {
        |Who suspended.
      }
    }
  } with {
    briefly "Suspend credit account"
    described as {
      |Suspends the credit account.
    }
  }
  command ReinstateAccount is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account to reinstate.
      }
    }
    reinstatedBy: String(1,100) with {
      briefly "Reinstated by"
      described as {
        |Who reinstated.
      }
    }
  } with {
    briefly "Reinstate credit account"
    described as {
      |Reinstates a suspended account.
    }
  }
  command RecordCollectionAction is  {
    creditAccountId: CreditAccountId with {
      briefly "Account ID"
      described as {
        |Account in collections.
      }
    }
    action: CollectionAction with {
      briefly "Action"
      described as {
        |Collection action taken.
      }
    }
  } with {
    briefly "Record collection action"
    described as {
      |Logs a collections activity.
    }
  }
  // Events
  event CreditApplied is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    requestedLimit: Money with {
      briefly "Limit"
      described as {
        |Requested limit.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Credit was applied for"
    described as {
      |Emitted when credit application is submitted.
    }
  }
  event CreditApproved is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    creditLimit: CreditLimit with {
      briefly "Limit"
      described as {
        |Approved limit.
      }
    }
    terms: CreditTerms with {
      briefly "Terms"
      described as {
        |Approved terms.
      }
    }
    riskLevel: CreditRisk with {
      briefly "Risk"
      described as {
        |Risk level.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Credit was approved"
    described as {
      |Emitted when credit is approved.
    }
  }
  event CreditDenied is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Credit was denied"
    described as {
      |Emitted when credit is denied.
    }
  }
  event InvoicePosted is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    invoice: Invoice with {
      briefly "Invoice"
      described as {
        |Posted invoice.
      }
    }
    newBalance: CreditBalance with {
      briefly "Balance"
      described as {
        |Updated balance.
      }
    }
    postedAt: TimeStamp with {
      briefly "Posted"
      described as {
        |Post time.
      }
    }
  } with {
    briefly "Invoice was posted"
    described as {
      |Emitted when invoice is posted.
    }
  }
  event PaymentApplied is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    payment: Payment with {
      briefly "Payment"
      described as {
        |Applied payment.
      }
    }
    newBalance: CreditBalance with {
      briefly "Balance"
      described as {
        |Updated balance.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Payment was applied"
    described as {
      |Emitted when payment is credited.
    }
  }
  event CreditLimitAdjusted is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    oldLimit: Money with {
      briefly "Old limit"
      described as {
        |Previous limit.
      }
    }
    newLimit: CreditLimit with {
      briefly "New limit"
      described as {
        |New limit.
      }
    }
    adjustedAt: TimeStamp with {
      briefly "Adjusted"
      described as {
        |Adjustment time.
      }
    }
  } with {
    briefly "Credit limit was adjusted"
    described as {
      |Emitted when credit limit changes.
    }
  }
  event AccountSuspended is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Account was suspended"
    described as {
      |Emitted when account is suspended.
    }
  }
  event AccountReinstated is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reinstatedAt: TimeStamp with {
      briefly "Reinstated"
      described as {
        |Reinstatement time.
      }
    }
  } with {
    briefly "Account was reinstated"
    described as {
      |Emitted when account is reinstated.
    }
  }
  event CollectionActionRecorded is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    action: CollectionAction with {
      briefly "Action"
      described as {
        |Collection action.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Collection action was recorded"
    described as {
      |Emitted when collection activity is logged.
    }
  }
  // State Records
  record PendingAccountData is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    requestedLimit: Money with {
      briefly "Limit"
      described as {
        |Requested limit.
      }
    }
    requestedTerms: CreditTerms with {
      briefly "Terms"
      described as {
        |Requested terms.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Pending account data"
    described as {
      |State data for pending credit application.
    }
  }
  record ActiveAccountData is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    creditLimit: CreditLimit with {
      briefly "Limit"
      described as {
        |Credit limit.
      }
    }
    terms: CreditTerms with {
      briefly "Terms"
      described as {
        |Credit terms.
      }
    }
    riskLevel: CreditRisk with {
      briefly "Risk"
      described as {
        |Risk level.
      }
    }
    balance: CreditBalance with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    invoices: Invoice+ with {
      briefly "Invoices"
      described as {
        |Open invoices.
      }
    }
    collectionActions: CollectionAction+ with {
      briefly "Actions"
      described as {
        |Collection history.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Active account data"
    described as {
      |State data for an active credit account.
    }
  }
  record SuspendedAccountData is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    balance: CreditBalance with {
      briefly "Balance"
      described as {
        |Outstanding balance.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Suspended account data"
    described as {
      |State data for a suspended account.
    }
  }
  record DeniedAccountData is  {
    creditAccountId: CreditAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Denied account data"
    described as {
      |State data for a denied application.
    }
  }
  // States
  state PendingState of type CreditAccount.PendingAccountData
  state ActiveState of type CreditAccount.ActiveAccountData
  state SuspendedState of type CreditAccount.SuspendedAccountData
  state DeniedState of type CreditAccount.DeniedAccountData
  // Handler
  handler CreditAccountHandler is {
    on command ApplyForCredit is {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.PendingState with command ApplyForCredit
      tell event CreditApplied to entity CreditContext.CreditAccount
    }
    on command ApproveCredit is {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.ActiveState with command ApproveCredit
      tell event CreditApproved to entity CreditContext.CreditAccount
    }
    on command DenyCredit is {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.DeniedState with command DenyCredit
      tell event CreditDenied to entity CreditContext.CreditAccount
    }
    on command PostInvoice is {
      tell event InvoicePosted to entity CreditContext.CreditAccount
    }
    on command ApplyPayment is {
      tell event PaymentApplied to entity CreditContext.CreditAccount
    }
    on command AdjustCreditLimit is {
      tell event CreditLimitAdjusted to entity CreditContext.CreditAccount
    }
    on command SuspendAccount is {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.SuspendedState with command SuspendAccount
      tell event AccountSuspended to entity CreditContext.CreditAccount
    }
    on command ReinstateAccount is {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.ActiveState with command ReinstateAccount
      tell event AccountReinstated to entity CreditContext.CreditAccount
    }
    on command RecordCollectionAction is {
      tell event CollectionActionRecorded to entity CreditContext.CreditAccount
    }
  } with {
    briefly "Processes credit account commands"
    described as {
      | Handles credit account lifecycle including applications,
      | approvals, invoicing, payments, and collections.
    }
  }
} with {
  briefly "Trade credit account aggregate"
  described as {
    | The CreditAccount entity manages wholesale credit accounts
    | including applications, limits, invoicing, and collections.
  }
}
