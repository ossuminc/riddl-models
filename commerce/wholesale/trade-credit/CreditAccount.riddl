// Trade Credit - CreditAccount Entity

entity CreditAccount is {

  // Commands
  command ApplyForCredit is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "New account identifier."
    }
    customerId is CustomerId with {
      briefly "Customer"
      described by "Applying customer."
    }
    requestedLimit is Money with {
      briefly "Requested limit"
      described by "Requested credit limit."
    }
    requestedTerms is CreditTerms with {
      briefly "Requested terms"
      described by "Requested payment terms."
    }
  } with {
    briefly "Apply for credit"
    described by "Submits a credit application."
  }

  command ApproveCredit is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to approve."
    }
    creditLimit is CreditLimit with {
      briefly "Limit"
      described by "Approved credit limit."
    }
    terms is CreditTerms with {
      briefly "Terms"
      described by "Approved credit terms."
    }
    riskLevel is CreditRisk with {
      briefly "Risk"
      described by "Assessed risk level."
    }
  } with {
    briefly "Approve credit application"
    described by "Approves credit with specified terms."
  }

  command DenyCredit is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to deny."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Denial reason."
    }
    deniedBy is String(1, 100) with {
      briefly "Denied by"
      described by "Who denied."
    }
  } with {
    briefly "Deny credit application"
    described by "Denies credit application."
  }

  command PostInvoice is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to invoice."
    }
    invoice is Invoice with {
      briefly "Invoice"
      described by "Invoice to post."
    }
  } with {
    briefly "Post invoice to account"
    described by "Posts an invoice to the credit account."
  }

  command ApplyPayment is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to credit."
    }
    payment is Payment with {
      briefly "Payment"
      described by "Payment details."
    }
    invoiceId is optional InvoiceId with {
      briefly "Invoice"
      described by "Specific invoice to apply to."
    }
  } with {
    briefly "Apply payment"
    described by "Applies a payment to the account."
  }

  command AdjustCreditLimit is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to adjust."
    }
    newLimit is CreditLimit with {
      briefly "New limit"
      described by "Adjusted credit limit."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Adjustment reason."
    }
  } with {
    briefly "Adjust credit limit"
    described by "Changes the credit limit."
  }

  command SuspendAccount is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to suspend."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Suspension reason."
    }
    suspendedBy is String(1, 100) with {
      briefly "Suspended by"
      described by "Who suspended."
    }
  } with {
    briefly "Suspend credit account"
    described by "Suspends the credit account."
  }

  command ReinstateAccount is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account to reinstate."
    }
    reinstatedBy is String(1, 100) with {
      briefly "Reinstated by"
      described by "Who reinstated."
    }
  } with {
    briefly "Reinstate credit account"
    described by "Reinstates a suspended account."
  }

  command RecordCollectionAction is {
    creditAccountId is CreditAccountId with {
      briefly "Account ID"
      described by "Account in collections."
    }
    action is CollectionAction with {
      briefly "Action"
      described by "Collection action taken."
    }
  } with {
    briefly "Record collection action"
    described by "Logs a collections activity."
  }

  // Events
  event CreditApplied is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    requestedLimit is Money with { briefly "Limit" described by "Requested limit." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Credit was applied for"
    described by "Emitted when credit application is submitted."
  }

  event CreditApproved is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    creditLimit is CreditLimit with { briefly "Limit" described by "Approved limit." }
    terms is CreditTerms with { briefly "Terms" described by "Approved terms." }
    riskLevel is CreditRisk with { briefly "Risk" described by "Risk level." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Credit was approved"
    described by "Emitted when credit is approved."
  }

  event CreditDenied is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Denial reason." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Credit was denied"
    described by "Emitted when credit is denied."
  }

  event InvoicePosted is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    invoice is Invoice with { briefly "Invoice" described by "Posted invoice." }
    newBalance is CreditBalance with { briefly "Balance" described by "Updated balance." }
    postedAt is TimeStamp with { briefly "Posted" described by "Post time." }
  } with {
    briefly "Invoice was posted"
    described by "Emitted when invoice is posted."
  }

  event PaymentApplied is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    payment is Payment with { briefly "Payment" described by "Applied payment." }
    newBalance is CreditBalance with { briefly "Balance" described by "Updated balance." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Payment was applied"
    described by "Emitted when payment is credited."
  }

  event CreditLimitAdjusted is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    oldLimit is Money with { briefly "Old limit" described by "Previous limit." }
    newLimit is CreditLimit with { briefly "New limit" described by "New limit." }
    adjustedAt is TimeStamp with { briefly "Adjusted" described by "Adjustment time." }
  } with {
    briefly "Credit limit was adjusted"
    described by "Emitted when credit limit changes."
  }

  event AccountSuspended is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Account was suspended"
    described by "Emitted when account is suspended."
  }

  event AccountReinstated is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    reinstatedAt is TimeStamp with { briefly "Reinstated" described by "Reinstatement time." }
  } with {
    briefly "Account was reinstated"
    described by "Emitted when account is reinstated."
  }

  event CollectionActionRecorded is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    action is CollectionAction with { briefly "Action" described by "Collection action." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Collection action was recorded"
    described by "Emitted when collection activity is logged."
  }

  // State Records
  record PendingAccountData is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    requestedLimit is Money with { briefly "Limit" described by "Requested limit." }
    requestedTerms is CreditTerms with { briefly "Terms" described by "Requested terms." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Pending account data"
    described by "State data for pending credit application."
  }

  record ActiveAccountData is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    creditLimit is CreditLimit with { briefly "Limit" described by "Credit limit." }
    terms is CreditTerms with { briefly "Terms" described by "Credit terms." }
    riskLevel is CreditRisk with { briefly "Risk" described by "Risk level." }
    balance is CreditBalance with { briefly "Balance" described by "Current balance." }
    invoices is many Invoice with { briefly "Invoices" described by "Open invoices." }
    collectionActions is many CollectionAction with { briefly "Actions" described by "Collection history." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Active account data"
    described by "State data for an active credit account."
  }

  record SuspendedAccountData is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    balance is CreditBalance with { briefly "Balance" described by "Outstanding balance." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Suspended account data"
    described by "State data for a suspended account."
  }

  record DeniedAccountData is {
    creditAccountId is CreditAccountId with { briefly "Account" described by "Account ID." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Denial reason." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Denied account data"
    described by "State data for a denied application."
  }

  // States
  state PendingState of CreditAccount.PendingAccountData with {
    briefly "Account is pending"
    described by "Credit application is under review."
  }

  state ActiveState of CreditAccount.ActiveAccountData with {
    briefly "Account is active"
    described by "Credit account is approved and active."
  }

  state SuspendedState of CreditAccount.SuspendedAccountData with {
    briefly "Account is suspended"
    described by "Credit account is suspended."
  }

  state DeniedState of CreditAccount.DeniedAccountData with {
    briefly "Account is denied"
    described by "Credit application was denied."
  }

  // Handler
  handler CreditAccountHandler is {
    on command ApplyForCredit {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.PendingState with command ApplyForCredit
      tell event CreditApplied to entity CreditContext.CreditAccount
    }

    on command ApproveCredit {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.ActiveState with command ApproveCredit
      tell event CreditApproved to entity CreditContext.CreditAccount
    }

    on command DenyCredit {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.DeniedState with command DenyCredit
      tell event CreditDenied to entity CreditContext.CreditAccount
    }

    on command PostInvoice {
      tell event InvoicePosted to entity CreditContext.CreditAccount
    }

    on command ApplyPayment {
      tell event PaymentApplied to entity CreditContext.CreditAccount
    }

    on command AdjustCreditLimit {
      tell event CreditLimitAdjusted to entity CreditContext.CreditAccount
    }

    on command SuspendAccount {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.SuspendedState with command SuspendAccount
      tell event AccountSuspended to entity CreditContext.CreditAccount
    }

    on command ReinstateAccount {
      morph entity CreditContext.CreditAccount to state CreditContext.CreditAccount.ActiveState with command ReinstateAccount
      tell event AccountReinstated to entity CreditContext.CreditAccount
    }

    on command RecordCollectionAction {
      tell event CollectionActionRecorded to entity CreditContext.CreditAccount
    }
  } with {
    briefly "Processes credit account commands"
    described by {
      | Handles credit account lifecycle including applications,
      | approvals, invoicing, payments, and collections.
    }
  }

} with {
  briefly "Trade credit account aggregate"
  described by {
    | The CreditAccount entity manages wholesale credit accounts
    | including applications, limits, invoicing, and collections.
  }
}
