// Trade Credit - Credit Context

context CreditContext is {

  include "types.riddl"
  include "CreditAccount.riddl"

  // Adaptors for external system integration
  adaptor CreditBureauAdapter to context CreditBureauService is {
    handler CreditChecks is {
      on event CreditAccount.CreditApplied {
        prompt "Request credit bureau report"
      }
    } with {
      briefly "Handles credit checks"
      described by "Requests credit reports for applications."
    }
  } with {
    briefly "Credit bureau integration"
    described by "Integrates with credit bureaus."
  }

  adaptor OrderAdapter from context OrderService is {
    handler OrderEvents is {
      on event OrderService.OrderShipped {
        prompt "Post invoice to credit account"
      }
    } with {
      briefly "Handles order events"
      described by "Creates invoices from shipped orders."
    }
  } with {
    briefly "Order integration"
    described by "Receives order events for invoicing."
  }

  adaptor PaymentAdapter from context PaymentService is {
    handler PaymentEvents is {
      on event PaymentService.PaymentReceived {
        prompt "Apply payment to credit account"
      }
    } with {
      briefly "Handles payment events"
      described by "Processes payments on account."
    }
  } with {
    briefly "Payment integration"
    described by "Receives payment notifications."
  }

  // Repository for credit persistence
  repository CreditRepository is {
    schema CreditData is relational
      of accounts as CreditAccount
      index on field CreditAccount.customerId
      index on field CreditAccount.creditAccountId

    handler CreditPersistence is {
      on event CreditAccount.CreditApplied {
        prompt "Create pending credit application"
      }
      on event CreditAccount.CreditApproved {
        prompt "Update account status to active"
      }
      on event CreditAccount.CreditDenied {
        prompt "Update account status to denied"
      }
      on event CreditAccount.InvoicePosted {
        prompt "Record invoice and update balance"
      }
      on event CreditAccount.PaymentApplied {
        prompt "Record payment and update balance"
      }
      on event CreditAccount.AccountSuspended {
        prompt "Update account status to suspended"
      }
    } with {
      briefly "Persists credit events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Credit data persistence"
    described by {
      | The CreditRepository provides persistent storage for
      | credit accounts and invoices.
    }
  }

  // Projector for credit analytics
  projector CreditAnalytics is {
    updates repository CreditRepository

    record AgingReport is {
      customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
      current is Money with { briefly "Current" described by "Current balance." }
      thirtyDays is Money with { briefly "30 days" described by "31-60 days." }
      sixtyDays is Money with { briefly "60 days" described by "61-90 days." }
      ninetyPlus is Money with { briefly "90+ days" described by "Over 90 days." }
    } with {
      briefly "Aging report"
      described by "Accounts receivable aging."
    }

    handler AnalyticsHandler is {
      on event CreditAccount.InvoicePosted {
        prompt "Update aging report"
      }
      on event CreditAccount.PaymentApplied {
        prompt "Update aging report"
      }
    } with {
      briefly "Maintains analytics views"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Credit analytics projections"
    described by "Maintains credit analytics data."
  }

} with {
  briefly "Bounded context for trade credit"
  described by {
    | The CreditContext is the bounded context for wholesale
    | credit management. It handles accounts, invoicing, and collections.
  }
}
