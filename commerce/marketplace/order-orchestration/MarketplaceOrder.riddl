// Order Orchestration - MarketplaceOrder Entity
entity MarketplaceOrder is {
  // Commands
  command CreateOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Unique order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer ID"
      described as {
        |Ordering customer.
      }
    }
    items: OrderItem+ with {
      briefly "Items"
      described as {
        |All order items.
      }
    }
    shippingAddress: Address with {
      briefly "Shipping address"
      described as {
        |Delivery destination.
      }
    }
    paymentInfo: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment information.
      }
    }
  } with {
    briefly "Create marketplace order"
    described as {
      |Creates a new order and splits by vendor.
    }
  }
  command AcknowledgeSubOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order ID"
      described as {
        |Acknowledged sub-order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor ID"
      described as {
        |Acknowledging vendor.
      }
    }
    estimatedShipDate: Date with {
      briefly "Ship date"
      described as {
        |Expected ship date.
      }
    }
  } with {
    briefly "Vendor acknowledges sub-order"
    described as {
      |Vendor confirms receipt and provides ship estimate.
    }
  }
  command ShipSubOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order ID"
      described as {
        |Shipped sub-order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor ID"
      described as {
        |Shipping vendor.
      }
    }
    tracking: TrackingInfo with {
      briefly "Tracking"
      described as {
        |Shipment tracking info.
      }
    }
  } with {
    briefly "Mark sub-order as shipped"
    described as {
      |Records shipment with tracking information.
    }
  }
  command ConfirmDelivery is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order ID"
      described as {
        |Delivered sub-order.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered at"
      described as {
        |Delivery timestamp.
      }
    }
  } with {
    briefly "Confirm sub-order delivery"
    described as {
      |Marks a sub-order as delivered.
    }
  }
  command CancelSubOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order ID"
      described as {
        |Sub-order to cancel.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Who cancelled.
      }
    }
  } with {
    briefly "Cancel a sub-order"
    described as {
      |Cancels a vendor sub-order.
    }
  }
  command CancelOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order to cancel.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledBy: String(1,100) with {
      briefly "Cancelled by"
      described as {
        |Who cancelled.
      }
    }
  } with {
    briefly "Cancel entire order"
    described as {
      |Cancels the order and all sub-orders.
    }
  }
  // Events
  event OrderCreated is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |New order.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    subOrders: VendorSubOrder+ with {
      briefly "Sub-orders"
      described as {
        |Vendor splits.
      }
    }
    totalAmount: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Order was created"
    described as {
      |Emitted when a new marketplace order is placed.
    }
  }
  event SubOrderRouted is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order"
      described as {
        |Routed sub-order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor"
      described as {
        |Target vendor.
      }
    }
    routedAt: TimeStamp with {
      briefly "Routed"
      described as {
        |When routed.
      }
    }
  } with {
    briefly "Sub-order was routed to vendor"
    described as {
      |Emitted when a sub-order is sent to a vendor.
    }
  }
  event SubOrderAcknowledged is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order"
      described as {
        |Acknowledged sub-order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor"
      described as {
        |Vendor.
      }
    }
    estimatedShipDate: Date with {
      briefly "Ship date"
      described as {
        |Expected ship.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |When acknowledged.
      }
    }
  } with {
    briefly "Sub-order was acknowledged"
    described as {
      |Emitted when vendor confirms sub-order receipt.
    }
  }
  event SubOrderShipped is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order"
      described as {
        |Shipped sub-order.
      }
    }
    vendorId: VendorId with {
      briefly "Vendor"
      described as {
        |Vendor.
      }
    }
    tracking: TrackingInfo with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Ship time.
      }
    }
  } with {
    briefly "Sub-order was shipped"
    described as {
      |Emitted when vendor ships sub-order items.
    }
  }
  event SubOrderDelivered is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order"
      described as {
        |Delivered sub-order.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Sub-order was delivered"
    described as {
      |Emitted when sub-order items are delivered.
    }
  }
  event SubOrderCancelled is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Parent order.
      }
    }
    subOrderId: SubOrderId with {
      briefly "Sub-order"
      described as {
        |Cancelled sub-order.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Sub-order was cancelled"
    described as {
      |Emitted when a sub-order is cancelled.
    }
  }
  event OrderCompleted is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Completed order.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Order was completed"
    described as {
      |Emitted when all sub-orders are delivered.
    }
  }
  event OrderCancelled is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Cancelled order.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Order was cancelled"
    described as {
      |Emitted when entire order is cancelled.
    }
  }
  // State Records
  record ActiveOrderData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    subOrders: VendorSubOrder+ with {
      briefly "Sub-orders"
      described as {
        |Vendor sub-orders.
      }
    }
    shippingAddress: Address with {
      briefly "Address"
      described as {
        |Delivery address.
      }
    }
    paymentInfo: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    totalAmount: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active order data"
    described as {
      |State data for an order in progress.
    }
  }
  record CompletedOrderData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    subOrders: VendorSubOrder+ with {
      briefly "Sub-orders"
      described as {
        |Vendor sub-orders.
      }
    }
    totalAmount: Money with {
      briefly "Total"
      described as {
        |Order total.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed order data"
    described as {
      |State data for a fully delivered order.
    }
  }
  record CancelledOrderData is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    refundAmount: Money with {
      briefly "Refund"
      described as {
        |Refund amount.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Cancelled order data"
    described as {
      |State data for a cancelled order.
    }
  }
  // States
  state ActiveState of type MarketplaceOrder.ActiveOrderData
  state CompletedState of type MarketplaceOrder.CompletedOrderData
  state CancelledState of type MarketplaceOrder.CancelledOrderData
  // Handler
  handler OrderHandler is {
    on command CreateOrder is {
      morph entity OrchestrationContext.MarketplaceOrder to state OrchestrationContext.MarketplaceOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity OrchestrationContext.MarketplaceOrder
    }
    on command AcknowledgeSubOrder is {
      tell event SubOrderAcknowledged to entity OrchestrationContext.MarketplaceOrder
    }
    on command ShipSubOrder is {
      tell event SubOrderShipped to entity OrchestrationContext.MarketplaceOrder
    }
    on command ConfirmDelivery is {
      tell event SubOrderDelivered to entity OrchestrationContext.MarketplaceOrder
    }
    on command CancelSubOrder is {
      tell event SubOrderCancelled to entity OrchestrationContext.MarketplaceOrder
    }
    on command CancelOrder is {
      morph entity OrchestrationContext.MarketplaceOrder to state OrchestrationContext.MarketplaceOrder.CancelledState with command CancelOrder
      tell event OrderCancelled to entity OrchestrationContext.MarketplaceOrder
    }
  } with {
    briefly "Processes order commands"
    described as {
      | Handles marketplace order lifecycle including creation,
      | sub-order management, and completion tracking.
    }
  }
} with {
  briefly "Marketplace order aggregate"
  described as {
    | The MarketplaceOrder entity manages multi-vendor orders including
    | splitting by vendor, tracking sub-order status, and coordinating
    | delivery across multiple fulfillment streams.
  }
}
