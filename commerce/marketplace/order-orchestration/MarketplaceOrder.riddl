// Order Orchestration - MarketplaceOrder Entity

entity MarketplaceOrder is {

  // Commands
  command CreateOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Unique order identifier."
    }
    customerId is CustomerId with {
      briefly "Customer ID"
      described by "Ordering customer."
    }
    items is many OrderItem with {
      briefly "Items"
      described by "All order items."
    }
    shippingAddress is Address with {
      briefly "Shipping address"
      described by "Delivery destination."
    }
    paymentInfo is PaymentInfo with {
      briefly "Payment"
      described by "Payment information."
    }
  } with {
    briefly "Create marketplace order"
    described by "Creates a new order and splits by vendor."
  }

  command AcknowledgeSubOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Parent order."
    }
    subOrderId is SubOrderId with {
      briefly "Sub-order ID"
      described by "Acknowledged sub-order."
    }
    vendorId is VendorId with {
      briefly "Vendor ID"
      described by "Acknowledging vendor."
    }
    estimatedShipDate is Date with {
      briefly "Ship date"
      described by "Expected ship date."
    }
  } with {
    briefly "Vendor acknowledges sub-order"
    described by "Vendor confirms receipt and provides ship estimate."
  }

  command ShipSubOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Parent order."
    }
    subOrderId is SubOrderId with {
      briefly "Sub-order ID"
      described by "Shipped sub-order."
    }
    vendorId is VendorId with {
      briefly "Vendor ID"
      described by "Shipping vendor."
    }
    tracking is TrackingInfo with {
      briefly "Tracking"
      described by "Shipment tracking info."
    }
  } with {
    briefly "Mark sub-order as shipped"
    described by "Records shipment with tracking information."
  }

  command ConfirmDelivery is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Parent order."
    }
    subOrderId is SubOrderId with {
      briefly "Sub-order ID"
      described by "Delivered sub-order."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered at"
      described by "Delivery timestamp."
    }
  } with {
    briefly "Confirm sub-order delivery"
    described by "Marks a sub-order as delivered."
  }

  command CancelSubOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Parent order."
    }
    subOrderId is SubOrderId with {
      briefly "Sub-order ID"
      described by "Sub-order to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Who cancelled."
    }
  } with {
    briefly "Cancel a sub-order"
    described by "Cancels a vendor sub-order."
  }

  command CancelOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    cancelledBy is String(1, 100) with {
      briefly "Cancelled by"
      described by "Who cancelled."
    }
  } with {
    briefly "Cancel entire order"
    described by "Cancels the order and all sub-orders."
  }

  // Events
  event OrderCreated is {
    orderId is OrderId with { briefly "Order ID" described by "New order." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    subOrders is many VendorSubOrder with { briefly "Sub-orders" described by "Vendor splits." }
    totalAmount is Money with { briefly "Total" described by "Order total." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Order was created"
    described by "Emitted when a new marketplace order is placed."
  }

  event SubOrderRouted is {
    orderId is OrderId with { briefly "Order ID" described by "Parent order." }
    subOrderId is SubOrderId with { briefly "Sub-order" described by "Routed sub-order." }
    vendorId is VendorId with { briefly "Vendor" described by "Target vendor." }
    routedAt is TimeStamp with { briefly "Routed" described by "When routed." }
  } with {
    briefly "Sub-order was routed to vendor"
    described by "Emitted when a sub-order is sent to a vendor."
  }

  event SubOrderAcknowledged is {
    orderId is OrderId with { briefly "Order ID" described by "Parent order." }
    subOrderId is SubOrderId with { briefly "Sub-order" described by "Acknowledged sub-order." }
    vendorId is VendorId with { briefly "Vendor" described by "Vendor." }
    estimatedShipDate is Date with { briefly "Ship date" described by "Expected ship." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "When acknowledged." }
  } with {
    briefly "Sub-order was acknowledged"
    described by "Emitted when vendor confirms sub-order receipt."
  }

  event SubOrderShipped is {
    orderId is OrderId with { briefly "Order ID" described by "Parent order." }
    subOrderId is SubOrderId with { briefly "Sub-order" described by "Shipped sub-order." }
    vendorId is VendorId with { briefly "Vendor" described by "Vendor." }
    tracking is TrackingInfo with { briefly "Tracking" described by "Tracking info." }
    shippedAt is TimeStamp with { briefly "Shipped" described by "Ship time." }
  } with {
    briefly "Sub-order was shipped"
    described by "Emitted when vendor ships sub-order items."
  }

  event SubOrderDelivered is {
    orderId is OrderId with { briefly "Order ID" described by "Parent order." }
    subOrderId is SubOrderId with { briefly "Sub-order" described by "Delivered sub-order." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Sub-order was delivered"
    described by "Emitted when sub-order items are delivered."
  }

  event SubOrderCancelled is {
    orderId is OrderId with { briefly "Order ID" described by "Parent order." }
    subOrderId is SubOrderId with { briefly "Sub-order" described by "Cancelled sub-order." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Sub-order was cancelled"
    described by "Emitted when a sub-order is cancelled."
  }

  event OrderCompleted is {
    orderId is OrderId with { briefly "Order ID" described by "Completed order." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Order was completed"
    described by "Emitted when all sub-orders are delivered."
  }

  event OrderCancelled is {
    orderId is OrderId with { briefly "Order ID" described by "Cancelled order." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Order was cancelled"
    described by "Emitted when entire order is cancelled."
  }

  // State Records
  record ActiveOrderData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    subOrders is many VendorSubOrder with { briefly "Sub-orders" described by "Vendor sub-orders." }
    shippingAddress is Address with { briefly "Address" described by "Delivery address." }
    paymentInfo is PaymentInfo with { briefly "Payment" described by "Payment details." }
    totalAmount is Money with { briefly "Total" described by "Order total." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active order data"
    described by "State data for an order in progress."
  }

  record CompletedOrderData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    subOrders is many VendorSubOrder with { briefly "Sub-orders" described by "Vendor sub-orders." }
    totalAmount is Money with { briefly "Total" described by "Order total." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed order data"
    described by "State data for a fully delivered order."
  }

  record CancelledOrderData is {
    orderId is OrderId with { briefly "Order ID" described by "Order identifier." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    refundAmount is Money with { briefly "Refund" described by "Refund amount." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Cancelled order data"
    described by "State data for a cancelled order."
  }

  // States
  state ActiveState of MarketplaceOrder.ActiveOrderData with {
    briefly "Order is active"
    described by "Order is in progress with pending fulfillment."
  }

  state CompletedState of MarketplaceOrder.CompletedOrderData with {
    briefly "Order is completed"
    described by "All sub-orders have been delivered."
  }

  state CancelledState of MarketplaceOrder.CancelledOrderData with {
    briefly "Order is cancelled"
    described by "Order was cancelled."
  }

  // Handler
  handler OrderHandler is {
    on command CreateOrder {
      morph entity OrchestrationContext.MarketplaceOrder to state OrchestrationContext.MarketplaceOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity OrchestrationContext.MarketplaceOrder
    }

    on command AcknowledgeSubOrder {
      tell event SubOrderAcknowledged to entity OrchestrationContext.MarketplaceOrder
    }

    on command ShipSubOrder {
      tell event SubOrderShipped to entity OrchestrationContext.MarketplaceOrder
    }

    on command ConfirmDelivery {
      tell event SubOrderDelivered to entity OrchestrationContext.MarketplaceOrder
    }

    on command CancelSubOrder {
      tell event SubOrderCancelled to entity OrchestrationContext.MarketplaceOrder
    }

    on command CancelOrder {
      morph entity OrchestrationContext.MarketplaceOrder to state OrchestrationContext.MarketplaceOrder.CancelledState with command CancelOrder
      tell event OrderCancelled to entity OrchestrationContext.MarketplaceOrder
    }
  } with {
    briefly "Processes order commands"
    described by {
      | Handles marketplace order lifecycle including creation,
      | sub-order management, and completion tracking.
    }
  }

} with {
  briefly "Marketplace order aggregate"
  described by {
    | The MarketplaceOrder entity manages multi-vendor orders including
    | splitting by vendor, tracking sub-order status, and coordinating
    | delivery across multiple fulfillment streams.
  }
}
