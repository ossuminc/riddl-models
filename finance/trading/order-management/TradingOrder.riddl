// Order Management - Trading Order Entity

entity TradingOrder is {

  // Commands
  command PlaceOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "New order identifier."
    }
    details is OrderDetails with {
      briefly "Details"
      described by "Order details."
    }
    placedBy is String(1, 100) with {
      briefly "Placed by"
      described by "Trader placing order."
    }
  } with {
    briefly "Place order"
    described by "Places a new trading order."
  }

  command AcknowledgeOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    brokerOrderId is String(1, 50) with {
      briefly "Broker ID"
      described by "Broker order reference."
    }
  } with {
    briefly "Acknowledge order"
    described by "Confirms order received by broker."
  }

  command ReportExecution is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    execution is Execution with {
      briefly "Execution"
      described by "Execution details."
    }
  } with {
    briefly "Report execution"
    described by "Reports a trade execution."
  }

  command AmendOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    amendment is OrderAmendment with {
      briefly "Amendment"
      described by "Amendment details."
    }
    amendedBy is String(1, 100) with {
      briefly "Amended by"
      described by "Person amending."
    }
  } with {
    briefly "Amend order"
    described by "Modifies an existing order."
  }

  command CancelOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is CancelReason with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    canceledBy is String(1, 100) with {
      briefly "Canceled by"
      described by "Person canceling."
    }
  } with {
    briefly "Cancel order"
    described by "Cancels an open order."
  }

  command RejectOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    rejection is RejectReason with {
      briefly "Rejection"
      described by "Rejection details."
    }
  } with {
    briefly "Reject order"
    described by "Rejects an order."
  }

  command ExpireOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    expiredAt is TimeStamp with {
      briefly "Expired"
      described by "Expiration time."
    }
  } with {
    briefly "Expire order"
    described by "Marks order as expired."
  }

  command SuspendOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Suspension reason."
    }
  } with {
    briefly "Suspend order"
    described by "Suspends order execution."
  }

  command ResumeOrder is {
    orderId is OrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
  } with {
    briefly "Resume order"
    described by "Resumes suspended order."
  }

  // Events
  event OrderPlaced is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    details is OrderDetails with { briefly "Details" described by "Order details." }
    placedBy is String(1, 100) with { briefly "Placed by" described by "Trader." }
    placedAt is TimeStamp with { briefly "Placed" described by "Placement time." }
  } with {
    briefly "Order placed"
    described by "Emitted when order is placed."
  }

  event OrderAcknowledged is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    brokerOrderId is String(1, 50) with { briefly "Broker ID" described by "Broker reference." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "Acknowledgment time." }
  } with {
    briefly "Order acknowledged"
    described by "Emitted when broker acknowledges."
  }

  event ExecutionReported is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    execution is Execution with { briefly "Execution" described by "Execution details." }
    cumulativeQuantity is Natural with { briefly "Cumulative" described by "Total filled." }
    remainingQuantity is Natural with { briefly "Remaining" described by "Unfilled quantity." }
    avgPrice is Decimal(12, 4) with { briefly "Avg price" described by "Average fill price." }
  } with {
    briefly "Execution reported"
    described by "Emitted when execution occurs."
  }

  event OrderFilled is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    totalQuantity is Natural with { briefly "Quantity" described by "Total filled." }
    avgPrice is Decimal(12, 4) with { briefly "Avg price" described by "Average price." }
    totalCommission is Decimal(10, 4) with { briefly "Commission" described by "Total commission." }
    totalFees is Decimal(10, 4) with { briefly "Fees" described by "Total fees." }
    filledAt is TimeStamp with { briefly "Filled" described by "Fill completion time." }
  } with {
    briefly "Order filled"
    described by "Emitted when order is completely filled."
  }

  event OrderAmended is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    amendment is OrderAmendment with { briefly "Amendment" described by "Changes made." }
    amendedBy is String(1, 100) with { briefly "Amended by" described by "Person who amended." }
    amendedAt is TimeStamp with { briefly "Amended" described by "Amendment time." }
  } with {
    briefly "Order amended"
    described by "Emitted when order is modified."
  }

  event OrderCanceled is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    reason is CancelReason with { briefly "Reason" described by "Cancel reason." }
    canceledBy is String(1, 100) with { briefly "Canceled by" described by "Who canceled." }
    canceledAt is TimeStamp with { briefly "Canceled" described by "Cancel time." }
    filledQuantity is Natural with { briefly "Filled" described by "Quantity filled before cancel." }
  } with {
    briefly "Order canceled"
    described by "Emitted when order is canceled."
  }

  event OrderRejected is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    rejection is RejectReason with { briefly "Rejection" described by "Rejection details." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Order rejected"
    described by "Emitted when order is rejected."
  }

  event OrderExpired is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    expiredAt is TimeStamp with { briefly "Expired" described by "Expiration time." }
    filledQuantity is Natural with { briefly "Filled" described by "Quantity filled before expiry." }
  } with {
    briefly "Order expired"
    described by "Emitted when order expires."
  }

  event OrderSuspended is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Order suspended"
    described by "Emitted when order is suspended."
  }

  event OrderResumed is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Order resumed"
    described by "Emitted when order resumes."
  }

  // State Records
  record OpenStateData is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    details is OrderDetails with { briefly "Details" described by "Order details." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    brokerOrderId is optional String(1, 50) with { briefly "Broker ID" described by "Broker reference." }
    executions is many optional Execution with { briefly "Executions" described by "Order executions." }
    filledQuantity is Natural with { briefly "Filled" described by "Quantity filled." }
    remainingQuantity is Natural with { briefly "Remaining" described by "Quantity remaining." }
    avgPrice is Decimal(12, 4) with { briefly "Avg price" described by "Average fill price." }
    placedBy is String(1, 100) with { briefly "Placed by" described by "Trader." }
    placedAt is TimeStamp with { briefly "Placed" described by "Placement time." }
  } with {
    briefly "Open state data"
    described by "State for open order."
  }

  record FilledStateData is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    details is OrderDetails with { briefly "Details" described by "Order details." }
    executions is many Execution with { briefly "Executions" described by "All executions." }
    totalQuantity is Natural with { briefly "Quantity" described by "Total filled." }
    avgPrice is Decimal(12, 4) with { briefly "Avg price" described by "Average price." }
    totalCommission is Decimal(10, 4) with { briefly "Commission" described by "Total commission." }
    totalFees is Decimal(10, 4) with { briefly "Fees" described by "Total fees." }
    filledAt is TimeStamp with { briefly "Filled" described by "Fill time." }
  } with {
    briefly "Filled state data"
    described by "State for filled order."
  }

  record ClosedStateData is {
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    details is OrderDetails with { briefly "Details" described by "Order details." }
    finalStatus is OrderStatus with { briefly "Status" described by "Final status." }
    executions is many optional Execution with { briefly "Executions" described by "Executions if any." }
    filledQuantity is Natural with { briefly "Filled" described by "Quantity filled." }
    closedReason is String(1, 200) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state data"
    described by "State for canceled/rejected/expired order."
  }

  // States
  state OpenState of TradingOrder.OpenStateData with {
    briefly "Order is open"
    described by "Order is active in market."
  }

  state FilledState of TradingOrder.FilledStateData with {
    briefly "Order is filled"
    described by "Order completely executed."
  }

  state ClosedState of TradingOrder.ClosedStateData with {
    briefly "Order is closed"
    described by "Order canceled, rejected, or expired."
  }

  // Handler
  handler OrderHandler is {
    on command PlaceOrder {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.OpenState with command PlaceOrder
      tell event OrderPlaced to entity OrderContext.TradingOrder
    }

    on command AcknowledgeOrder {
      tell event OrderAcknowledged to entity OrderContext.TradingOrder
    }

    on command ReportExecution {
      tell event ExecutionReported to entity OrderContext.TradingOrder
    }

    on command AmendOrder {
      tell event OrderAmended to entity OrderContext.TradingOrder
    }

    on command CancelOrder {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command CancelOrder
      tell event OrderCanceled to entity OrderContext.TradingOrder
    }

    on command RejectOrder {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command RejectOrder
      tell event OrderRejected to entity OrderContext.TradingOrder
    }

    on command ExpireOrder {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command ExpireOrder
      tell event OrderExpired to entity OrderContext.TradingOrder
    }

    on command SuspendOrder {
      tell event OrderSuspended to entity OrderContext.TradingOrder
    }

    on command ResumeOrder {
      tell event OrderResumed to entity OrderContext.TradingOrder
    }
  } with {
    briefly "Processes order commands"
    described by {
      | Handles trading order lifecycle from placement
      | through execution, amendment, and cancellation.
    }
  }

} with {
  briefly "Trading order aggregate"
  described by {
    | The TradingOrder entity manages securities orders
    | including execution, fills, and status tracking.
  }
}
