// Order Management - Trading Order Entity
entity TradingOrder is {
  // Commands
  command PlaceOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |New order identifier.
      }
    }
    details: OrderDetails with {
      briefly "Details"
      described as {
        |Order details.
      }
    }
    placedBy: String(1,100) with {
      briefly "Placed by"
      described as {
        |Trader placing order.
      }
    }
  } with {
    briefly "Place order"
    described as {
      |Places a new trading order.
    }
  }
  command AcknowledgeOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    brokerOrderId: String(1,50) with {
      briefly "Broker ID"
      described as {
        |Broker order reference.
      }
    }
  } with {
    briefly "Acknowledge order"
    described as {
      |Confirms order received by broker.
    }
  }
  command ReportExecution is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    execution: Execution with {
      briefly "Execution"
      described as {
        |Execution details.
      }
    }
  } with {
    briefly "Report execution"
    described as {
      |Reports a trade execution.
    }
  }
  command AmendOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    amendment: OrderAmendment with {
      briefly "Amendment"
      described as {
        |Amendment details.
      }
    }
    amendedBy: String(1,100) with {
      briefly "Amended by"
      described as {
        |Person amending.
      }
    }
  } with {
    briefly "Amend order"
    described as {
      |Modifies an existing order.
    }
  }
  command CancelOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: CancelReason with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    canceledBy: String(1,100) with {
      briefly "Canceled by"
      described as {
        |Person canceling.
      }
    }
  } with {
    briefly "Cancel order"
    described as {
      |Cancels an open order.
    }
  }
  command RejectOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    rejection: RejectReason with {
      briefly "Rejection"
      described as {
        |Rejection details.
      }
    }
  } with {
    briefly "Reject order"
    described as {
      |Rejects an order.
    }
  }
  command ExpireOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    expiredAt: TimeStamp with {
      briefly "Expired"
      described as {
        |Expiration time.
      }
    }
  } with {
    briefly "Expire order"
    described as {
      |Marks order as expired.
    }
  }
  command FillOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order to fill.
      }
    }
    totalQuantity: Natural with {
      briefly "Quantity"
      described as {
        |Total quantity filled.
      }
    }
    avgPrice: Decimal(12,4) with {
      briefly "Avg price"
      described as {
        |Average fill price.
      }
    }
  } with {
    briefly "Fill order"
    described as {
      |Marks order as completely filled.
    }
  }
  command SuspendOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    suspensionReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
  } with {
    briefly "Suspend order"
    described as {
      |Suspends order execution.
    }
  }
  command ResumeOrder is  {
    orderId: OrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
  } with {
    briefly "Resume order"
    described as {
      |Resumes suspended order.
    }
  }
  // Events
  event OrderPlaced is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    details: OrderDetails with {
      briefly "Details"
      described as {
        |Order details.
      }
    }
    placedBy: String(1,100) with {
      briefly "Placed by"
      described as {
        |Trader.
      }
    }
    placedAt: TimeStamp with {
      briefly "Placed"
      described as {
        |Placement time.
      }
    }
  } with {
    briefly "Order placed"
    described as {
      |Emitted when order is placed.
    }
  }
  event OrderAcknowledged is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    brokerOrderId: String(1,50) with {
      briefly "Broker ID"
      described as {
        |Broker reference.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |Acknowledgment time.
      }
    }
  } with {
    briefly "Order acknowledged"
    described as {
      |Emitted when broker acknowledges.
    }
  }
  event ExecutionReported is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    execution: Execution with {
      briefly "Execution"
      described as {
        |Execution details.
      }
    }
    cumulativeQuantity: Natural with {
      briefly "Cumulative"
      described as {
        |Total filled.
      }
    }
    remainingQuantity: Natural with {
      briefly "Remaining"
      described as {
        |Unfilled quantity.
      }
    }
    avgPrice: Decimal(12,4) with {
      briefly "Avg price"
      described as {
        |Average fill price.
      }
    }
  } with {
    briefly "Execution reported"
    described as {
      |Emitted when execution occurs.
    }
  }
  event OrderFilled is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    totalQuantity: Natural with {
      briefly "Quantity"
      described as {
        |Total filled.
      }
    }
    avgPrice: Decimal(12,4) with {
      briefly "Avg price"
      described as {
        |Average price.
      }
    }
    totalCommission: Decimal(10,4) with {
      briefly "Commission"
      described as {
        |Total commission.
      }
    }
    totalFees: Decimal(10,4) with {
      briefly "Fees"
      described as {
        |Total fees.
      }
    }
    filledAt: TimeStamp with {
      briefly "Filled"
      described as {
        |Fill completion time.
      }
    }
  } with {
    briefly "Order filled"
    described as {
      |Emitted when order is completely filled.
    }
  }
  event OrderAmended is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    amendment: OrderAmendment with {
      briefly "Amendment"
      described as {
        |Changes made.
      }
    }
    amendedBy: String(1,100) with {
      briefly "Amended by"
      described as {
        |Person who amended.
      }
    }
    amendedAt: TimeStamp with {
      briefly "Amended"
      described as {
        |Amendment time.
      }
    }
  } with {
    briefly "Order amended"
    described as {
      |Emitted when order is modified.
    }
  }
  event OrderCanceled is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: CancelReason with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    canceledBy: String(1,100) with {
      briefly "Canceled by"
      described as {
        |Who canceled.
      }
    }
    canceledAt: TimeStamp with {
      briefly "Canceled"
      described as {
        |Cancel time.
      }
    }
    filledQuantity: Natural with {
      briefly "Filled"
      described as {
        |Quantity filled before cancel.
      }
    }
  } with {
    briefly "Order canceled"
    described as {
      |Emitted when order is canceled.
    }
  }
  event OrderRejected is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    rejection: RejectReason with {
      briefly "Rejection"
      described as {
        |Rejection details.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Order rejected"
    described as {
      |Emitted when order is rejected.
    }
  }
  event OrderExpired is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    expiredAt: TimeStamp with {
      briefly "Expired"
      described as {
        |Expiration time.
      }
    }
    filledQuantity: Natural with {
      briefly "Filled"
      described as {
        |Quantity filled before expiry.
      }
    }
  } with {
    briefly "Order expired"
    described as {
      |Emitted when order expires.
    }
  }
  event OrderSuspended is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    suspensionReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Order suspended"
    described as {
      |Emitted when order is suspended.
    }
  }
  event OrderResumed is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Order resumed"
    described as {
      |Emitted when order resumes.
    }
  }
  // State Records
  record OpenStateData is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    details: OrderDetails with {
      briefly "Details"
      described as {
        |Order details.
      }
    }
    status: OrderStatus with {
      briefly "Status"
      described as {
        |Order status.
      }
    }
    assignedBrokerOrderId: String(1,50)? with {
      briefly "Broker ID"
      described as {
        |Broker reference.
      }
    }
    partialExecutions: Execution* with {
      briefly "Executions"
      described as {
        |Order executions.
      }
    }
    filledQuantity: Natural with {
      briefly "Filled"
      described as {
        |Quantity filled.
      }
    }
    remainingQuantity: Natural with {
      briefly "Remaining"
      described as {
        |Quantity remaining.
      }
    }
    avgPrice: Decimal(12,4) with {
      briefly "Avg price"
      described as {
        |Average fill price.
      }
    }
    placedBy: String(1,100) with {
      briefly "Placed by"
      described as {
        |Trader.
      }
    }
    placedAt: TimeStamp with {
      briefly "Placed"
      described as {
        |Placement time.
      }
    }
  } with {
    briefly "Open state data"
    described as {
      |State for open order.
    }
  }
  record FilledStateData is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    details: OrderDetails with {
      briefly "Details"
      described as {
        |Order details.
      }
    }
    executions: Execution+ with {
      briefly "Executions"
      described as {
        |All executions.
      }
    }
    totalQuantity: Natural with {
      briefly "Quantity"
      described as {
        |Total filled.
      }
    }
    avgPrice: Decimal(12,4) with {
      briefly "Avg price"
      described as {
        |Average price.
      }
    }
    totalCommission: Decimal(10,4) with {
      briefly "Commission"
      described as {
        |Total commission.
      }
    }
    totalFees: Decimal(10,4) with {
      briefly "Fees"
      described as {
        |Total fees.
      }
    }
    filledAt: TimeStamp with {
      briefly "Filled"
      described as {
        |Fill time.
      }
    }
  } with {
    briefly "Filled state data"
    described as {
      |State for filled order.
    }
  }
  record ClosedStateData is  {
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    details: OrderDetails with {
      briefly "Details"
      described as {
        |Order details.
      }
    }
    finalStatus: OrderStatus with {
      briefly "Status"
      described as {
        |Final status.
      }
    }
    priorExecutions: Execution* with {
      briefly "Executions"
      described as {
        |Executions if any.
      }
    }
    filledQuantity: Natural with {
      briefly "Filled"
      described as {
        |Quantity filled.
      }
    }
    closedReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |State for canceled/rejected/expired order.
    }
  }
  // States
  state OpenState of type TradingOrder.OpenStateData
  state FilledState of type TradingOrder.FilledStateData
  state ClosedState of type TradingOrder.ClosedStateData
  // Handler
  handler OrderHandler is {
    on command PlaceOrder is {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.OpenState with command PlaceOrder
      tell event OrderPlaced to entity OrderContext.TradingOrder
    }
    on command AcknowledgeOrder is {
      tell event OrderAcknowledged to entity OrderContext.TradingOrder
    }
    on command ReportExecution is {
      tell event ExecutionReported to entity OrderContext.TradingOrder
    }
    on command AmendOrder is {
      tell event OrderAmended to entity OrderContext.TradingOrder
    }
    on command CancelOrder is {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command CancelOrder
      tell event OrderCanceled to entity OrderContext.TradingOrder
    }
    on command RejectOrder is {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command RejectOrder
      tell event OrderRejected to entity OrderContext.TradingOrder
    }
    on command ExpireOrder is {
      morph entity OrderContext.TradingOrder to state OrderContext.TradingOrder.ClosedState with command ExpireOrder
      tell event OrderExpired to entity OrderContext.TradingOrder
    }
    on command SuspendOrder is {
      tell event OrderSuspended to entity OrderContext.TradingOrder
    }
    on command ResumeOrder is {
      tell event OrderResumed to entity OrderContext.TradingOrder
    }
  } with {
    briefly "Processes order commands"
    described as {
      | Handles trading order lifecycle from placement
      | through execution, amendment, and cancellation.
    }
  }
} with {
  briefly "Trading order aggregate"
  described as {
    | The TradingOrder entity manages securities orders
    | including execution, fills, and status tracking.
  }
}
