// Trade Settlement - External Contexts
// Clearinghouse Service
context ClearinghouseService is {
  command SubmitForClearing is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
  } with {
    briefly "Submit for clearing"
    described as {
      |Submits trade to clearinghouse.
    }
  }
  event ClearingAccepted is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    clearingReference: String(1,50) with {
      briefly "Reference"
      described as {
        |Clearing reference.
      }
    }
    acceptedAt: TimeStamp with {
      briefly "Accepted"
      described as {
        |Acceptance time.
      }
    }
  } with {
    briefly "Clearing accepted"
    described as {
      |Emitted when clearing accepts trade.
    }
  }
  event ClearingRejected is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Clearing rejected"
    described as {
      |Emitted when clearing rejects trade.
    }
  }
} with {
  option external()
  briefly "External clearinghouse"
  described as {
    |External clearinghouse integration.
  }
}
// Custodian Service
context CustodianService is {
  command SendSettlementInstruction is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    instruction: SettlementInstruction with {
      briefly "Instruction"
      described as {
        |Settlement instruction.
      }
    }
  } with {
    briefly "Send instruction"
    described as {
      |Sends instruction to custodian.
    }
  }
  event InstructionAcknowledged is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    custodianReference: String(1,50) with {
      briefly "Reference"
      described as {
        |Custodian reference.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |Acknowledgment time.
      }
    }
  } with {
    briefly "Instruction acknowledged"
    described as {
      |Emitted when custodian acknowledges.
    }
  }
  event SettlementExecuted is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    confirmation: SettlementConfirmation with {
      briefly "Confirmation"
      described as {
        |Settlement confirmation.
      }
    }
  } with {
    briefly "Settlement executed"
    described as {
      |Emitted when custodian settles.
    }
  }
  event SettlementFailedAtCustodian is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Settlement failed"
    described as {
      |Emitted when custodian cannot settle.
    }
  }
} with {
  option external()
  briefly "External custodian"
  described as {
    |External custodian bank integration.
  }
}
// Trade Matching Service
context TradeMatchingService is {
  command SubmitForMatching is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
  } with {
    briefly "Submit for matching"
    described as {
      |Submits trade for matching.
    }
  }
  event TradeMatchFound is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    matching: MatchingInfo with {
      briefly "Matching"
      described as {
        |Match details.
      }
    }
  } with {
    briefly "Match found"
    described as {
      |Emitted when match is found.
    }
  }
  event NoMatchFound is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |No match reason.
      }
    }
  } with {
    briefly "No match"
    described as {
      |Emitted when no match is found.
    }
  }
} with {
  option external()
  briefly "External trade matching"
  described as {
    |External trade matching service.
  }
}
// Position Management Service
context PositionService is {
  command UpdatePosition is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    securityId: SecurityId with {
      briefly "Security"
      described as {
        |Security ID.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Position change.
      }
    }
    direction: String(1,10) with {
      briefly "Direction"
      described as {
        |Buy or sell.
      }
    }
  } with {
    briefly "Update position"
    described as {
      |Updates account position.
    }
  }
  event PositionUpdated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    securityId: SecurityId with {
      briefly "Security"
      described as {
        |Security ID.
      }
    }
    newQuantity: Natural with {
      briefly "Quantity"
      described as {
        |New position.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Position updated"
    described as {
      |Emitted when position changes.
    }
  }
} with {
  option external()
  briefly "External position management"
  described as {
    |External position tracking service.
  }
}
// Cash Management Service
context CashService is {
  command UpdateCashBalance is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    amount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Cash amount.
      }
    }
    direction: String(1,10) with {
      briefly "Direction"
      described as {
        |Credit or debit.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Currency code.
      }
    }
  } with {
    briefly "Update cash"
    described as {
      |Updates account cash balance.
    }
  }
  event CashBalanceUpdated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Currency code.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Cash updated"
    described as {
      |Emitted when cash balance changes.
    }
  }
} with {
  option external()
  briefly "External cash management"
  described as {
    |External cash balance service.
  }
}
// Notification Service
context NotificationService is {
  command SendSettlementNotification is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    recipients: String(1,100)+ with {
      briefly "Recipients"
      described as {
        |Notification recipients.
      }
    }
    message: String(1,1000) with {
      briefly "Message"
      described as {
        |Message content.
      }
    }
  } with {
    briefly "Send notification"
    described as {
      |Sends settlement notification.
    }
  }
  event NotificationSent is  {
    notificationId: UUID with {
      briefly "Notification"
      described as {
        |Notification ID.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Notification sent"
    described as {
      |Emitted when notification is delivered.
    }
  }
} with {
  option external()
  briefly "External notifications"
  described as {
    |External notification system.
  }
}
