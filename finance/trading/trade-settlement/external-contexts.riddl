// Trade Settlement - External Contexts

// Clearinghouse Service
context ClearinghouseService is {

  command SubmitForClearing is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    trade is TradeDetails with { briefly "Trade" described by "Trade details." }
  } with {
    briefly "Submit for clearing"
    described by "Submits trade to clearinghouse."
  }

  event ClearingAccepted is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    clearingReference is String(1, 50) with { briefly "Reference" described by "Clearing reference." }
    acceptedAt is TimeStamp with { briefly "Accepted" described by "Acceptance time." }
  } with {
    briefly "Clearing accepted"
    described by "Emitted when clearing accepts trade."
  }

  event ClearingRejected is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Rejection reason." }
  } with {
    briefly "Clearing rejected"
    described by "Emitted when clearing rejects trade."
  }

} with {
  option is external
  briefly "External clearinghouse"
  described by "External clearinghouse integration."
}

// Custodian Service
context CustodianService is {

  command SendSettlementInstruction is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    instruction is SettlementInstruction with { briefly "Instruction" described by "Settlement instruction." }
  } with {
    briefly "Send instruction"
    described by "Sends instruction to custodian."
  }

  event InstructionAcknowledged is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    custodianReference is String(1, 50) with { briefly "Reference" described by "Custodian reference." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "Acknowledgment time." }
  } with {
    briefly "Instruction acknowledged"
    described by "Emitted when custodian acknowledges."
  }

  event SettlementExecuted is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    confirmation is SettlementConfirmation with { briefly "Confirmation" described by "Settlement confirmation." }
  } with {
    briefly "Settlement executed"
    described by "Emitted when custodian settles."
  }

  event SettlementFailedAtCustodian is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Settlement failed"
    described by "Emitted when custodian cannot settle."
  }

} with {
  option is external
  briefly "External custodian"
  described by "External custodian bank integration."
}

// Trade Matching Service
context TradeMatchingService is {

  command SubmitForMatching is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    trade is TradeDetails with { briefly "Trade" described by "Trade details." }
  } with {
    briefly "Submit for matching"
    described by "Submits trade for matching."
  }

  event TradeMatchFound is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    matching is MatchingInfo with { briefly "Matching" described by "Match details." }
  } with {
    briefly "Match found"
    described by "Emitted when match is found."
  }

  event NoMatchFound is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    reason is String(1, 200) with { briefly "Reason" described by "No match reason." }
  } with {
    briefly "No match"
    described by "Emitted when no match is found."
  }

} with {
  option is external
  briefly "External trade matching"
  described by "External trade matching service."
}

// Position Management Service
context PositionService is {

  command UpdatePosition is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    securityId is SecurityId with { briefly "Security" described by "Security ID." }
    quantity is Natural with { briefly "Quantity" described by "Position change." }
    direction is String(1, 10) with { briefly "Direction" described by "Buy or sell." }
  } with {
    briefly "Update position"
    described by "Updates account position."
  }

  event PositionUpdated is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    securityId is SecurityId with { briefly "Security" described by "Security ID." }
    newQuantity is Natural with { briefly "Quantity" described by "New position." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Position updated"
    described by "Emitted when position changes."
  }

} with {
  option is external
  briefly "External position management"
  described by "External position tracking service."
}

// Cash Management Service
context CashService is {

  command UpdateCashBalance is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    amount is Decimal(15, 2) with { briefly "Amount" described by "Cash amount." }
    direction is String(1, 10) with { briefly "Direction" described by "Credit or debit." }
    currency is String(3, 3) with { briefly "Currency" described by "Currency code." }
  } with {
    briefly "Update cash"
    described by "Updates account cash balance."
  }

  event CashBalanceUpdated is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    currency is String(3, 3) with { briefly "Currency" described by "Currency code." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Cash updated"
    described by "Emitted when cash balance changes."
  }

} with {
  option is external
  briefly "External cash management"
  described by "External cash balance service."
}

// Notification Service
context NotificationService is {

  command SendSettlementNotification is {
    settlementId is SettlementId with { briefly "Settlement" described by "Settlement ID." }
    notificationType is String(1, 50) with { briefly "Type" described by "Notification type." }
    recipients is many String(1, 100) with { briefly "Recipients" described by "Notification recipients." }
    message is String(1, 1000) with { briefly "Message" described by "Message content." }
  } with {
    briefly "Send notification"
    described by "Sends settlement notification."
  }

  event NotificationSent is {
    notificationId is UUID with { briefly "Notification" described by "Notification ID." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Notification sent"
    described by "Emitted when notification is delivered."
  }

} with {
  option is external
  briefly "External notifications"
  described by "External notification system."
}
