// Trade Settlement - Settlement Context
context SettlementContext is {
  include "types.riddl"
  include "Settlement.riddl"
  // Repository for settlement persistence
  repository SettlementRepository is {
    schema SettlementData is relational
      of settlements as type Settlement
        index on field Settlement.settlementId
        index on field Settlement.trade.tradeId

    handler SettlementPersistence is {
      on command Settlement.InitiateSettlement is {
        prompt "Store new settlement"
      }
      on command Settlement.MatchTrade is {
        prompt "Update matching info"
      }
      on command Settlement.AffirmTrade is {
        prompt "Update affirmation status"
      }
      on command Settlement.SendInstructions is {
        prompt "Store sent instructions"
      }
      on command Settlement.ConfirmSettlement is {
        prompt "Update settlement to complete"
      }
      on command Settlement.RecordPartialSettlement is {
        prompt "Update partial settlement"
      }
      on command Settlement.FailSettlement is {
        prompt "Update settlement to failed"
      }
      on command Settlement.RetrySettlement is {
        prompt "Update retry information"
      }
      on command Settlement.CancelSettlement is {
        prompt "Update settlement to canceled"
      }
      on command Settlement.HoldSettlement is {
        prompt "Update settlement to held"
      }
      on command Settlement.ReleaseHold is {
        prompt "Release settlement hold"
      }
    } with {
      briefly "Persists settlement commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Settlement data persistence"
    described as {
      | The SettlementRepository provides persistent storage for
      | trade settlements, instructions, and confirmations.
    }
  }
  // Projector for settlement analytics
  projector SettlementAnalytics is {
    record SettlementStats is  {
      totalSettlements: Natural with {
        briefly "Total"
        described as {
          |Total settlements.
        }
      }
      settledValue: Decimal(18,2) with {
        briefly "Value"
        described as {
          |Settled value.
        }
      }
      settlementRate: Decimal(5,4) with {
        briefly "Rate"
        described as {
          |Settlement success rate.
        }
      }
      avgSettlementTime: Duration with {
        briefly "Avg time"
        described as {
          |Average settlement time.
        }
      }
      failRate: Decimal(5,4) with {
        briefly "Fail rate"
        described as {
          |Failure rate.
        }
      }
      pendingValue: Decimal(18,2) with {
        briefly "Pending"
        described as {
          |Pending settlement value.
        }
      }
    } with {
      briefly "Settlement statistics"
      described as {
        |Settlement processing metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Settlement.SettlementInitiated is {
        prompt "Update pending counts"
      }
      on event Settlement.SettlementConfirmed is {
        prompt "Update settled metrics"
      }
      on event Settlement.SettlementFailed is {
        prompt "Update fail metrics"
      }
      on event Settlement.PartialSettlementRecorded is {
        prompt "Update partial metrics"
      }
    } with {
      briefly "Maintains settlement analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Settlement analytics projections"
    described as {
      |Maintains trade settlement analytics data.
    }
  }
} with {
  briefly "Bounded context for trade settlement"
  described as {
    | The SettlementContext is the bounded context for
    | post-trade clearing and settlement processing.
  }
}
