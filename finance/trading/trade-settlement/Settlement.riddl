// Trade Settlement - Settlement Entity
entity Settlement is {
  // Commands
  command InitiateSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |New settlement identifier.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade to settle.
      }
    }
  } with {
    briefly "Initiate settlement"
    described as {
      |Initiates trade settlement.
    }
  }
  command MatchTrade is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    matching: MatchingInfo with {
      briefly "Matching"
      described as {
        |Matching information.
      }
    }
  } with {
    briefly "Match trade"
    described as {
      |Records trade match with counterparty.
    }
  }
  command AffirmTrade is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    affirmedBy: CounterpartyId with {
      briefly "Affirmed by"
      described as {
        |Affirming counterparty.
      }
    }
  } with {
    briefly "Affirm trade"
    described as {
      |Counterparty affirms trade details.
    }
  }
  command SendInstructions is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    instructions: SettlementInstruction+ with {
      briefly "Instructions"
      described as {
        |Settlement instructions.
      }
    }
  } with {
    briefly "Send instructions"
    described as {
      |Sends settlement instructions to custodian.
    }
  }
  command ConfirmSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    confirmation: SettlementConfirmation with {
      briefly "Confirmation"
      described as {
        |Settlement confirmation.
      }
    }
  } with {
    briefly "Confirm settlement"
    described as {
      |Confirms successful settlement.
    }
  }
  command RecordPartialSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    partialConfirmation: SettlementConfirmation with {
      briefly "Partial"
      described as {
        |Partial settlement details.
      }
    }
  } with {
    briefly "Record partial"
    described as {
      |Records partial settlement.
    }
  }
  command FailSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    failure: FailureInfo with {
      briefly "Failure"
      described as {
        |Failure details.
      }
    }
  } with {
    briefly "Fail settlement"
    described as {
      |Records settlement failure.
    }
  }
  command RetrySettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    newSettlementDate: Date with {
      briefly "New date"
      described as {
        |New settlement date.
      }
    }
  } with {
    briefly "Retry settlement"
    described as {
      |Retries failed settlement.
    }
  }
  command CancelSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel settlement"
    described as {
      |Cancels pending settlement.
    }
  }
  command HoldSettlement is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
  } with {
    briefly "Hold settlement"
    described as {
      |Places settlement on hold.
    }
  }
  command ReleaseHold is  {
    settlementId: SettlementId with {
      briefly "Settlement ID"
      described as {
        |Settlement identifier.
      }
    }
  } with {
    briefly "Release hold"
    described as {
      |Releases held settlement.
    }
  }
  // Events
  event SettlementInitiated is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Settlement initiated"
    described as {
      |Emitted when settlement begins.
    }
  }
  event TradeMatched is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    matching: MatchingInfo with {
      briefly "Matching"
      described as {
        |Match details.
      }
    }
  } with {
    briefly "Trade matched"
    described as {
      |Emitted when trade is matched.
    }
  }
  event TradeAffirmed is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    affirmedBy: CounterpartyId with {
      briefly "Affirmed by"
      described as {
        |Affirming party.
      }
    }
    affirmedAt: TimeStamp with {
      briefly "Affirmed"
      described as {
        |Affirmation time.
      }
    }
  } with {
    briefly "Trade affirmed"
    described as {
      |Emitted when counterparty affirms.
    }
  }
  event InstructionsSent is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    instructions: SettlementInstruction+ with {
      briefly "Instructions"
      described as {
        |Sent instructions.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Instructions sent"
    described as {
      |Emitted when instructions are sent.
    }
  }
  event SettlementConfirmed is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    confirmation: SettlementConfirmation with {
      briefly "Confirmation"
      described as {
        |Confirmation details.
      }
    }
  } with {
    briefly "Settlement confirmed"
    described as {
      |Emitted when settlement completes.
    }
  }
  event PartialSettlementRecorded is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    partialConfirmation: SettlementConfirmation with {
      briefly "Partial"
      described as {
        |Partial details.
      }
    }
    remainingQuantity: Natural with {
      briefly "Remaining"
      described as {
        |Unsettled quantity.
      }
    }
    remainingAmount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Unsettled amount.
      }
    }
  } with {
    briefly "Partial settlement"
    described as {
      |Emitted when partial settlement occurs.
    }
  }
  event SettlementFailed is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    failure: FailureInfo with {
      briefly "Failure"
      described as {
        |Failure info.
      }
    }
  } with {
    briefly "Settlement failed"
    described as {
      |Emitted when settlement fails.
    }
  }
  event SettlementRetried is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    newSettlementDate: Date with {
      briefly "New date"
      described as {
        |New settlement date.
      }
    }
    retriedAt: TimeStamp with {
      briefly "Retried"
      described as {
        |Retry time.
      }
    }
  } with {
    briefly "Settlement retried"
    described as {
      |Emitted when settlement is retried.
    }
  }
  event SettlementCanceled is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    canceledAt: TimeStamp with {
      briefly "Canceled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Settlement canceled"
    described as {
      |Emitted when settlement is canceled.
    }
  }
  event SettlementOnHold is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "Settlement on hold"
    described as {
      |Emitted when settlement is held.
    }
  }
  event HoldReleased is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |Release time.
      }
    }
  } with {
    briefly "Hold released"
    described as {
      |Emitted when hold is released.
    }
  }
  // State Records
  record PendingStateData is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
    status: SettlementStatus with {
      briefly "Status"
      described as {
        |Settlement status.
      }
    }
    matchingResult: MatchingInfo? with {
      briefly "Matching"
      described as {
        |Match info.
      }
    }
    affirmed: Boolean with {
      briefly "Affirmed"
      described as {
        |Is affirmed.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Pending state data"
    described as {
      |State for pending settlement.
    }
  }
  record InProcessStateData is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
    status: SettlementStatus with {
      briefly "Status"
      described as {
        |Settlement status.
      }
    }
    instructions: SettlementInstruction+ with {
      briefly "Instructions"
      described as {
        |Sent instructions.
      }
    }
    settledQuantity: Natural with {
      briefly "Settled qty"
      described as {
        |Quantity settled.
      }
    }
    settledAmount: Decimal(15,2) with {
      briefly "Settled amt"
      described as {
        |Amount settled.
      }
    }
    instructionsSentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Instructions sent time.
      }
    }
  } with {
    briefly "In process state data"
    described as {
      |State for in-process settlement.
    }
  }
  record SettledStateData is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
    confirmation: SettlementConfirmation with {
      briefly "Confirmation"
      described as {
        |Final confirmation.
      }
    }
    totalSettledQuantity: Natural with {
      briefly "Quantity"
      described as {
        |Total settled.
      }
    }
    totalSettledAmount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Total amount.
      }
    }
  } with {
    briefly "Settled state data"
    described as {
      |State for completed settlement.
    }
  }
  record FailedStateData is  {
    settlementId: SettlementId with {
      briefly "Settlement"
      described as {
        |Settlement ID.
      }
    }
    trade: TradeDetails with {
      briefly "Trade"
      described as {
        |Trade details.
      }
    }
    failure: FailureInfo with {
      briefly "Failure"
      described as {
        |Failure details.
      }
    }
    settledQuantity: Natural with {
      briefly "Settled"
      described as {
        |Quantity settled before fail.
      }
    }
    retryCount: Natural with {
      briefly "Retries"
      described as {
        |Number of retries.
      }
    }
  } with {
    briefly "Failed state data"
    described as {
      |State for failed settlement.
    }
  }
  // States
  state PendingState of type Settlement.PendingStateData
  state InProcessState of type Settlement.InProcessStateData
  state SettledState of type Settlement.SettledStateData
  state FailedState of type Settlement.FailedStateData
  // Handler
  handler SettlementHandler is {
    on command InitiateSettlement is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.PendingState with command InitiateSettlement
      tell event SettlementInitiated to entity SettlementContext.Settlement
    }
    on command MatchTrade is {
      tell event TradeMatched to entity SettlementContext.Settlement
    }
    on command AffirmTrade is {
      tell event TradeAffirmed to entity SettlementContext.Settlement
    }
    on command SendInstructions is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.InProcessState with command SendInstructions
      tell event InstructionsSent to entity SettlementContext.Settlement
    }
    on command ConfirmSettlement is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.SettledState with command ConfirmSettlement
      tell event SettlementConfirmed to entity SettlementContext.Settlement
    }
    on command RecordPartialSettlement is {
      tell event PartialSettlementRecorded to entity SettlementContext.Settlement
    }
    on command FailSettlement is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.FailedState with command FailSettlement
      tell event SettlementFailed to entity SettlementContext.Settlement
    }
    on command RetrySettlement is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.PendingState with command RetrySettlement
      tell event SettlementRetried to entity SettlementContext.Settlement
    }
    on command CancelSettlement is {
      morph entity SettlementContext.Settlement to state SettlementContext.Settlement.FailedState with command CancelSettlement
      tell event SettlementCanceled to entity SettlementContext.Settlement
    }
    on command HoldSettlement is {
      tell event SettlementOnHold to entity SettlementContext.Settlement
    }
    on command ReleaseHold is {
      tell event HoldReleased to entity SettlementContext.Settlement
    }
  } with {
    briefly "Processes settlement commands"
    described as {
      | Handles settlement lifecycle from initiation
      | through matching, instructions, and confirmation.
    }
  }
} with {
  briefly "Settlement aggregate"
  described as {
    | The Settlement entity manages trade settlements
    | including matching, instructions, and confirmation.
  }
}
