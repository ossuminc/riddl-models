// Loan Origination - Loan Entity

entity Loan is {

  // Commands
  command SubmitApplication is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "New loan identifier."
    }
    borrower is BorrowerInfo with {
      briefly "Borrower"
      described by "Borrower information."
    }
    request is LoanRequest with {
      briefly "Request"
      described by "Loan request details."
    }
  } with {
    briefly "Submit application"
    described by "Submits loan application."
  }

  command RequestDocuments is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    requiredDocuments is many DocumentType with {
      briefly "Documents"
      described by "Required document types."
    }
  } with {
    briefly "Request documents"
    described by "Requests additional documents."
  }

  command UploadDocument is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    document is LoanDocument with {
      briefly "Document"
      described by "Uploaded document."
    }
  } with {
    briefly "Upload document"
    described by "Uploads a loan document."
  }

  command ReviewDocument is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    documentId is DocumentId with {
      briefly "Document"
      described by "Document to review."
    }
    accepted is Boolean with {
      briefly "Accepted"
      described by "Is document accepted."
    }
    rejectionReason is optional String(1, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
  } with {
    briefly "Review document"
    described by "Reviews uploaded document."
  }

  command SendToUnderwriting is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
  } with {
    briefly "Send to underwriting"
    described by "Sends loan to underwriting."
  }

  command ApproveLoan is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    terms is LoanTerms with {
      briefly "Terms"
      described by "Approved loan terms."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Approving underwriter."
    }
  } with {
    briefly "Approve loan"
    described by "Approves the loan application."
  }

  command ConditionallyApproveLoan is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    terms is LoanTerms with {
      briefly "Terms"
      described by "Conditional loan terms."
    }
    conditions is many String(1, 500) with {
      briefly "Conditions"
      described by "Approval conditions."
    }
  } with {
    briefly "Conditionally approve"
    described by "Approves with conditions."
  }

  command DeclineLoan is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    reasons is many String(1, 200) with {
      briefly "Reasons"
      described by "Decline reasons."
    }
    declinedBy is String(1, 100) with {
      briefly "Declined by"
      described by "Declining underwriter."
    }
  } with {
    briefly "Decline loan"
    described by "Declines the loan application."
  }

  command AcceptOffer is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    acceptedAt is TimeStamp with {
      briefly "Accepted"
      described by "Acceptance time."
    }
  } with {
    briefly "Accept offer"
    described by "Borrower accepts loan offer."
  }

  command ScheduleClosing is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    closing is ClosingDetails with {
      briefly "Closing"
      described by "Closing details."
    }
  } with {
    briefly "Schedule closing"
    described by "Schedules loan closing."
  }

  command FundLoan is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    funding is FundingInfo with {
      briefly "Funding"
      described by "Funding details."
    }
  } with {
    briefly "Fund loan"
    described by "Disburses loan funds."
  }

  command WithdrawApplication is {
    loanId is LoanId with {
      briefly "Loan ID"
      described by "Loan identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Withdrawal reason."
    }
  } with {
    briefly "Withdraw application"
    described by "Withdraws loan application."
  }

  // Events
  event ApplicationSubmitted is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    request is LoanRequest with { briefly "Request" described by "Loan request." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Application submitted"
    described by "Emitted when application is submitted."
  }

  event DocumentsRequested is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    requiredDocuments is many DocumentType with { briefly "Documents" described by "Required documents." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Documents requested"
    described by "Emitted when documents are requested."
  }

  event DocumentUploaded is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    document is LoanDocument with { briefly "Document" described by "Uploaded document." }
    uploadedAt is TimeStamp with { briefly "Uploaded" described by "Upload time." }
  } with {
    briefly "Document uploaded"
    described by "Emitted when document is uploaded."
  }

  event DocumentReviewed is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    documentId is DocumentId with { briefly "Document" described by "Document ID." }
    accepted is Boolean with { briefly "Accepted" described by "Is accepted." }
    rejectionReason is optional String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    reviewedAt is TimeStamp with { briefly "Reviewed" described by "Review time." }
  } with {
    briefly "Document reviewed"
    described by "Emitted when document is reviewed."
  }

  event SentToUnderwriting is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Sent to underwriting"
    described by "Emitted when sent to underwriting."
  }

  event LoanApproved is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    terms is LoanTerms with { briefly "Terms" described by "Approved terms." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Approver." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Loan approved"
    described by "Emitted when loan is approved."
  }

  event LoanConditionallyApproved is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    terms is LoanTerms with { briefly "Terms" described by "Conditional terms." }
    conditions is many String(1, 500) with { briefly "Conditions" described by "Approval conditions." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Conditionally approved"
    described by "Emitted when conditionally approved."
  }

  event LoanDeclined is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    reasons is many String(1, 200) with { briefly "Reasons" described by "Decline reasons." }
    declinedBy is String(1, 100) with { briefly "Declined by" described by "Decliner." }
    declinedAt is TimeStamp with { briefly "Declined" described by "Decline time." }
  } with {
    briefly "Loan declined"
    described by "Emitted when loan is declined."
  }

  event OfferAccepted is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    acceptedAt is TimeStamp with { briefly "Accepted" described by "Acceptance time." }
  } with {
    briefly "Offer accepted"
    described by "Emitted when borrower accepts."
  }

  event ClosingScheduled is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    closing is ClosingDetails with { briefly "Closing" described by "Closing details." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Closing scheduled"
    described by "Emitted when closing is scheduled."
  }

  event LoanFunded is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    funding is FundingInfo with { briefly "Funding" described by "Funding info." }
  } with {
    briefly "Loan funded"
    described by "Emitted when loan is funded."
  }

  event ApplicationWithdrawn is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Application withdrawn"
    described by "Emitted when application is withdrawn."
  }

  // State Records
  record SubmittedStateData is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    request is LoanRequest with { briefly "Request" described by "Loan request." }
    documents is many optional LoanDocument with { briefly "Documents" described by "Loan documents." }
    status is LoanStatus with { briefly "Status" described by "Loan status." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Submitted state data"
    described by "State for submitted loan."
  }

  record UnderwritingStateData is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    request is LoanRequest with { briefly "Request" described by "Loan request." }
    documents is many optional LoanDocument with { briefly "Documents" described by "Loan documents." }
    status is LoanStatus with { briefly "Status" described by "Loan status." }
    sentToUnderwritingAt is TimeStamp with { briefly "Sent" described by "Underwriting start." }
  } with {
    briefly "Underwriting state data"
    described by "State for loan in underwriting."
  }

  record ApprovedStateData is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    request is LoanRequest with { briefly "Request" described by "Loan request." }
    terms is LoanTerms with { briefly "Terms" described by "Approved terms." }
    documents is many optional LoanDocument with { briefly "Documents" described by "Loan documents." }
    status is LoanStatus with { briefly "Status" described by "Loan status." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Approved state data"
    described by "State for approved loan."
  }

  record FundedStateData is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    terms is LoanTerms with { briefly "Terms" described by "Final terms." }
    funding is FundingInfo with { briefly "Funding" described by "Funding info." }
    status is LoanStatus with { briefly "Status" described by "Loan status." }
  } with {
    briefly "Funded state data"
    described by "State for funded loan."
  }

  record ClosedStateData is {
    loanId is LoanId with { briefly "Loan" described by "Loan ID." }
    borrower is BorrowerInfo with { briefly "Borrower" described by "Borrower info." }
    reason is String(1, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state data"
    described by "State for closed/declined loan."
  }

  // States
  state SubmittedState of Loan.SubmittedStateData with {
    briefly "Application submitted"
    described by "Loan application in review."
  }

  state UnderwritingState of Loan.UnderwritingStateData with {
    briefly "In underwriting"
    described by "Loan under underwriting review."
  }

  state ApprovedState of Loan.ApprovedStateData with {
    briefly "Loan approved"
    described by "Loan approved, awaiting closing."
  }

  state FundedState of Loan.FundedStateData with {
    briefly "Loan funded"
    described by "Loan has been funded."
  }

  state ClosedState of Loan.ClosedStateData with {
    briefly "Application closed"
    described by "Loan declined or withdrawn."
  }

  // Handler
  handler LoanHandler is {
    on command SubmitApplication {
      morph entity LoanContext.Loan to state LoanContext.Loan.SubmittedState with command SubmitApplication
      tell event ApplicationSubmitted to entity LoanContext.Loan
    }

    on command RequestDocuments {
      tell event DocumentsRequested to entity LoanContext.Loan
    }

    on command UploadDocument {
      tell event DocumentUploaded to entity LoanContext.Loan
    }

    on command ReviewDocument {
      tell event DocumentReviewed to entity LoanContext.Loan
    }

    on command SendToUnderwriting {
      morph entity LoanContext.Loan to state LoanContext.Loan.UnderwritingState with command SendToUnderwriting
      tell event SentToUnderwriting to entity LoanContext.Loan
    }

    on command ApproveLoan {
      morph entity LoanContext.Loan to state LoanContext.Loan.ApprovedState with command ApproveLoan
      tell event LoanApproved to entity LoanContext.Loan
    }

    on command ConditionallyApproveLoan {
      morph entity LoanContext.Loan to state LoanContext.Loan.ApprovedState with command ConditionallyApproveLoan
      tell event LoanConditionallyApproved to entity LoanContext.Loan
    }

    on command DeclineLoan {
      morph entity LoanContext.Loan to state LoanContext.Loan.ClosedState with command DeclineLoan
      tell event LoanDeclined to entity LoanContext.Loan
    }

    on command AcceptOffer {
      tell event OfferAccepted to entity LoanContext.Loan
    }

    on command ScheduleClosing {
      tell event ClosingScheduled to entity LoanContext.Loan
    }

    on command FundLoan {
      morph entity LoanContext.Loan to state LoanContext.Loan.FundedState with command FundLoan
      tell event LoanFunded to entity LoanContext.Loan
    }

    on command WithdrawApplication {
      morph entity LoanContext.Loan to state LoanContext.Loan.ClosedState with command WithdrawApplication
      tell event ApplicationWithdrawn to entity LoanContext.Loan
    }
  } with {
    briefly "Processes loan commands"
    described by {
      | Handles loan lifecycle from application through
      | underwriting, approval, and funding.
    }
  }

} with {
  briefly "Loan aggregate"
  described by {
    | The Loan entity manages loan applications from
    | submission through approval, closing, and funding.
  }
}
