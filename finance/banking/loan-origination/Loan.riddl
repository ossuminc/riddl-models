// Loan Origination - Loan Entity
entity Loan is {
  // Commands
  command SubmitApplication is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |New loan identifier.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower information.
      }
    }
    request: LoanRequest with {
      briefly "Request"
      described as {
        |Loan request details.
      }
    }
  } with {
    briefly "Submit application"
    described as {
      |Submits loan application.
    }
  }
  command RequestDocuments is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    requiredDocuments: DocumentType+ with {
      briefly "Documents"
      described as {
        |Required document types.
      }
    }
  } with {
    briefly "Request documents"
    described as {
      |Requests additional documents.
    }
  }
  command UploadDocument is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    document: LoanDocument with {
      briefly "Document"
      described as {
        |Uploaded document.
      }
    }
  } with {
    briefly "Upload document"
    described as {
      |Uploads a loan document.
    }
  }
  command ReviewDocument is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    documentId: DocumentId with {
      briefly "Document"
      described as {
        |Document to review.
      }
    }
    accepted: Boolean with {
      briefly "Accepted"
      described as {
        |Is document accepted.
      }
    }
    rejectionReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Review document"
    described as {
      |Reviews uploaded document.
    }
  }
  command SendToUnderwriting is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
  } with {
    briefly "Send to underwriting"
    described as {
      |Sends loan to underwriting.
    }
  }
  command ApproveLoan is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Approved loan terms.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approving underwriter.
      }
    }
  } with {
    briefly "Approve loan"
    described as {
      |Approves the loan application.
    }
  }
  command ConditionallyApproveLoan is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Conditional loan terms.
      }
    }
    conditions: String(1,500)+ with {
      briefly "Conditions"
      described as {
        |Approval conditions.
      }
    }
  } with {
    briefly "Conditionally approve"
    described as {
      |Approves with conditions.
    }
  }
  command DeclineLoan is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    reasons: String(1,200)+ with {
      briefly "Reasons"
      described as {
        |Decline reasons.
      }
    }
    declinedBy: String(1,100) with {
      briefly "Declined by"
      described as {
        |Declining underwriter.
      }
    }
  } with {
    briefly "Decline loan"
    described as {
      |Declines the loan application.
    }
  }
  command AcceptOffer is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    acceptedAt: TimeStamp with {
      briefly "Accepted"
      described as {
        |Acceptance time.
      }
    }
  } with {
    briefly "Accept offer"
    described as {
      |Borrower accepts loan offer.
    }
  }
  command ScheduleClosing is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    closing: ClosingDetails with {
      briefly "Closing"
      described as {
        |Closing details.
      }
    }
  } with {
    briefly "Schedule closing"
    described as {
      |Schedules loan closing.
    }
  }
  command FundLoan is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    funding: FundingInfo with {
      briefly "Funding"
      described as {
        |Funding details.
      }
    }
  } with {
    briefly "Fund loan"
    described as {
      |Disburses loan funds.
    }
  }
  command WithdrawApplication is  {
    loanId: LoanId with {
      briefly "Loan ID"
      described as {
        |Loan identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
  } with {
    briefly "Withdraw application"
    described as {
      |Withdraws loan application.
    }
  }
  // Events
  event ApplicationSubmitted is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    request: LoanRequest with {
      briefly "Request"
      described as {
        |Loan request.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Application submitted"
    described as {
      |Emitted when application is submitted.
    }
  }
  event DocumentsRequested is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    requiredDocuments: DocumentType+ with {
      briefly "Documents"
      described as {
        |Required documents.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Documents requested"
    described as {
      |Emitted when documents are requested.
    }
  }
  event DocumentUploaded is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    document: LoanDocument with {
      briefly "Document"
      described as {
        |Uploaded document.
      }
    }
    uploadedAt: TimeStamp with {
      briefly "Uploaded"
      described as {
        |Upload time.
      }
    }
  } with {
    briefly "Document uploaded"
    described as {
      |Emitted when document is uploaded.
    }
  }
  event DocumentReviewed is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    documentId: DocumentId with {
      briefly "Document"
      described as {
        |Document ID.
      }
    }
    accepted: Boolean with {
      briefly "Accepted"
      described as {
        |Is accepted.
      }
    }
    rejectionReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    reviewedAt: TimeStamp with {
      briefly "Reviewed"
      described as {
        |Review time.
      }
    }
  } with {
    briefly "Document reviewed"
    described as {
      |Emitted when document is reviewed.
    }
  }
  event SentToUnderwriting is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Sent to underwriting"
    described as {
      |Emitted when sent to underwriting.
    }
  }
  event LoanApproved is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Approved terms.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Loan approved"
    described as {
      |Emitted when loan is approved.
    }
  }
  event LoanConditionallyApproved is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Conditional terms.
      }
    }
    conditions: String(1,500)+ with {
      briefly "Conditions"
      described as {
        |Approval conditions.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Conditionally approved"
    described as {
      |Emitted when conditionally approved.
    }
  }
  event LoanDeclined is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    reasons: String(1,200)+ with {
      briefly "Reasons"
      described as {
        |Decline reasons.
      }
    }
    declinedBy: String(1,100) with {
      briefly "Declined by"
      described as {
        |Decliner.
      }
    }
    declinedAt: TimeStamp with {
      briefly "Declined"
      described as {
        |Decline time.
      }
    }
  } with {
    briefly "Loan declined"
    described as {
      |Emitted when loan is declined.
    }
  }
  event OfferAccepted is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    acceptedAt: TimeStamp with {
      briefly "Accepted"
      described as {
        |Acceptance time.
      }
    }
  } with {
    briefly "Offer accepted"
    described as {
      |Emitted when borrower accepts.
    }
  }
  event ClosingScheduled is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    closing: ClosingDetails with {
      briefly "Closing"
      described as {
        |Closing details.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Schedule time.
      }
    }
  } with {
    briefly "Closing scheduled"
    described as {
      |Emitted when closing is scheduled.
    }
  }
  event LoanFunded is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    funding: FundingInfo with {
      briefly "Funding"
      described as {
        |Funding info.
      }
    }
  } with {
    briefly "Loan funded"
    described as {
      |Emitted when loan is funded.
    }
  }
  event ApplicationWithdrawn is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Application withdrawn"
    described as {
      |Emitted when application is withdrawn.
    }
  }
  // State Records
  record SubmittedStateData is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    request: LoanRequest with {
      briefly "Request"
      described as {
        |Loan request.
      }
    }
    documents: LoanDocument* with {
      briefly "Documents"
      described as {
        |Loan documents.
      }
    }
    status: LoanStatus with {
      briefly "Status"
      described as {
        |Loan status.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Submitted state data"
    described as {
      |State for submitted loan.
    }
  }
  record UnderwritingStateData is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    request: LoanRequest with {
      briefly "Request"
      described as {
        |Loan request.
      }
    }
    documents: LoanDocument* with {
      briefly "Documents"
      described as {
        |Loan documents.
      }
    }
    status: LoanStatus with {
      briefly "Status"
      described as {
        |Loan status.
      }
    }
    sentToUnderwritingAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Underwriting start.
      }
    }
  } with {
    briefly "Underwriting state data"
    described as {
      |State for loan in underwriting.
    }
  }
  record ApprovedStateData is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    request: LoanRequest with {
      briefly "Request"
      described as {
        |Loan request.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Approved terms.
      }
    }
    documents: LoanDocument* with {
      briefly "Documents"
      described as {
        |Loan documents.
      }
    }
    status: LoanStatus with {
      briefly "Status"
      described as {
        |Loan status.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Approved state data"
    described as {
      |State for approved loan.
    }
  }
  record FundedStateData is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    terms: LoanTerms with {
      briefly "Terms"
      described as {
        |Final terms.
      }
    }
    funding: FundingInfo with {
      briefly "Funding"
      described as {
        |Funding info.
      }
    }
    status: LoanStatus with {
      briefly "Status"
      described as {
        |Loan status.
      }
    }
  } with {
    briefly "Funded state data"
    described as {
      |State for funded loan.
    }
  }
  record ClosedStateData is  {
    loanId: LoanId with {
      briefly "Loan"
      described as {
        |Loan ID.
      }
    }
    borrower: BorrowerInfo with {
      briefly "Borrower"
      described as {
        |Borrower info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |State for closed/declined loan.
    }
  }
  // States
  state SubmittedState of type Loan.SubmittedStateData
  state UnderwritingState of type Loan.UnderwritingStateData
  state ApprovedState of type Loan.ApprovedStateData
  state FundedState of type Loan.FundedStateData
  state ClosedState of type Loan.ClosedStateData
  // Handler
  handler LoanHandler is {
    on command SubmitApplication is {
      morph entity LoanContext.Loan to state LoanContext.Loan.SubmittedState with command SubmitApplication
      tell event ApplicationSubmitted to entity LoanContext.Loan
    }
    on command RequestDocuments is {
      tell event DocumentsRequested to entity LoanContext.Loan
    }
    on command UploadDocument is {
      tell event DocumentUploaded to entity LoanContext.Loan
    }
    on command ReviewDocument is {
      tell event DocumentReviewed to entity LoanContext.Loan
    }
    on command SendToUnderwriting is {
      morph entity LoanContext.Loan to state LoanContext.Loan.UnderwritingState with command SendToUnderwriting
      tell event SentToUnderwriting to entity LoanContext.Loan
    }
    on command ApproveLoan is {
      morph entity LoanContext.Loan to state LoanContext.Loan.ApprovedState with command ApproveLoan
      tell event LoanApproved to entity LoanContext.Loan
    }
    on command ConditionallyApproveLoan is {
      morph entity LoanContext.Loan to state LoanContext.Loan.ApprovedState with command ConditionallyApproveLoan
      tell event LoanConditionallyApproved to entity LoanContext.Loan
    }
    on command DeclineLoan is {
      morph entity LoanContext.Loan to state LoanContext.Loan.ClosedState with command DeclineLoan
      tell event LoanDeclined to entity LoanContext.Loan
    }
    on command AcceptOffer is {
      tell event OfferAccepted to entity LoanContext.Loan
    }
    on command ScheduleClosing is {
      tell event ClosingScheduled to entity LoanContext.Loan
    }
    on command FundLoan is {
      morph entity LoanContext.Loan to state LoanContext.Loan.FundedState with command FundLoan
      tell event LoanFunded to entity LoanContext.Loan
    }
    on command WithdrawApplication is {
      morph entity LoanContext.Loan to state LoanContext.Loan.ClosedState with command WithdrawApplication
      tell event ApplicationWithdrawn to entity LoanContext.Loan
    }
  } with {
    briefly "Processes loan commands"
    described as {
      | Handles loan lifecycle from application through
      | underwriting, approval, and funding.
    }
  }
} with {
  briefly "Loan aggregate"
  described as {
    | The Loan entity manages loan applications from
    | submission through approval, closing, and funding.
  }
}
