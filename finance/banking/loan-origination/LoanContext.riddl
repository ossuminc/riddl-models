// Loan Origination - Loan Context
context LoanContext is {
  include "types.riddl"
  include "Loan.riddl"
  // Repository for loan persistence
  repository LoanRepository is {
    schema LoanData is relational
      of loans as type Loan
        index on field Loan.loanId
        index on field Loan.borrower.borrowerId

    handler LoanPersistence is {
      on command Loan.SubmitApplication is {
        prompt "Store new loan application"
      }
      on command Loan.RequestDocuments is {
        prompt "Store document requirements"
      }
      on command Loan.UploadDocument is {
        prompt "Store uploaded document"
      }
      on command Loan.ReviewDocument is {
        prompt "Update document status"
      }
      on command Loan.SendToUnderwriting is {
        prompt "Update loan to underwriting"
      }
      on command Loan.ApproveLoan is {
        prompt "Store loan approval"
      }
      on command Loan.ConditionallyApproveLoan is {
        prompt "Store conditional approval"
      }
      on command Loan.DeclineLoan is {
        prompt "Store loan decline"
      }
      on command Loan.AcceptOffer is {
        prompt "Store offer acceptance"
      }
      on command Loan.ScheduleClosing is {
        prompt "Store closing schedule"
      }
      on command Loan.FundLoan is {
        prompt "Store funding record"
      }
      on command Loan.WithdrawApplication is {
        prompt "Store withdrawal record"
      }
    } with {
      briefly "Persists loan commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Loan data persistence"
    described as {
      | The LoanRepository provides persistent storage for
      | loan applications, documents, and status history.
    }
  }
  // Projector for loan analytics
  projector LoanAnalytics is {
    record LoanStats is  {
      totalApplications: Natural with {
        briefly "Total"
        described as {
          |Total applications.
        }
      }
      approvalRate: Decimal(5,4) with {
        briefly "Approval"
        described as {
          |Approval rate.
        }
      }
      fundingRate: Decimal(5,4) with {
        briefly "Funding"
        described as {
          |Funding rate.
        }
      }
      avgLoanAmount: Decimal(12,2) with {
        briefly "Avg amount"
        described as {
          |Average loan amount.
        }
      }
      avgProcessingTime: Duration with {
        briefly "Avg time"
        described as {
          |Average processing time.
        }
      }
      totalFunded: Decimal(15,2) with {
        briefly "Total funded"
        described as {
          |Total amount funded.
        }
      }
    } with {
      briefly "Loan statistics"
      described as {
        |Loan origination metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Loan.ApplicationSubmitted is {
        prompt "Update application counts"
      }
      on event Loan.LoanApproved is {
        prompt "Update approval metrics"
      }
      on event Loan.LoanFunded is {
        prompt "Update funding metrics"
      }
      on event Loan.LoanDeclined is {
        prompt "Update decline metrics"
      }
    } with {
      briefly "Maintains loan analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Loan analytics projections"
    described as {
      |Maintains loan origination analytics data.
    }
  }
} with {
  briefly "Bounded context for loan origination"
  described as {
    | The LoanContext is the bounded context for loan
    | application processing, underwriting, and funding.
  }
}
