// Loan Origination - Loan Context

context LoanContext is {

  include "types.riddl"
  include "Loan.riddl"

  // Repository for loan persistence
  repository LoanRepository is {
    schema LoanData is relational
      of loans as Loan
      index on field Loan.loanId
      index on field Loan.borrower.borrowerId

    handler LoanPersistence is {
      on command Loan.SubmitApplication {
        prompt "Store new loan application"
      }
      on command Loan.RequestDocuments {
        prompt "Store document requirements"
      }
      on command Loan.UploadDocument {
        prompt "Store uploaded document"
      }
      on command Loan.ReviewDocument {
        prompt "Update document status"
      }
      on command Loan.SendToUnderwriting {
        prompt "Update loan to underwriting"
      }
      on command Loan.ApproveLoan {
        prompt "Store loan approval"
      }
      on command Loan.ConditionallyApproveLoan {
        prompt "Store conditional approval"
      }
      on command Loan.DeclineLoan {
        prompt "Store loan decline"
      }
      on command Loan.AcceptOffer {
        prompt "Store offer acceptance"
      }
      on command Loan.ScheduleClosing {
        prompt "Store closing schedule"
      }
      on command Loan.FundLoan {
        prompt "Store funding record"
      }
      on command Loan.WithdrawApplication {
        prompt "Store withdrawal record"
      }
    } with {
      briefly "Persists loan commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Loan data persistence"
    described by {
      | The LoanRepository provides persistent storage for
      | loan applications, documents, and status history.
    }
  }

  // Projector for loan analytics
  projector LoanAnalytics is {
    updates repository LoanRepository

    record LoanStats is {
      totalApplications is Natural with { briefly "Total" described by "Total applications." }
      approvalRate is Decimal(5, 4) with { briefly "Approval" described by "Approval rate." }
      fundingRate is Decimal(5, 4) with { briefly "Funding" described by "Funding rate." }
      avgLoanAmount is Decimal(12, 2) with { briefly "Avg amount" described by "Average loan amount." }
      avgProcessingTime is Duration with { briefly "Avg time" described by "Average processing time." }
      totalFunded is Decimal(15, 2) with { briefly "Total funded" described by "Total amount funded." }
    } with {
      briefly "Loan statistics"
      described by "Loan origination metrics."
    }

    handler AnalyticsHandler is {
      on event Loan.ApplicationSubmitted {
        prompt "Update application counts"
      }
      on event Loan.LoanApproved {
        prompt "Update approval metrics"
      }
      on event Loan.LoanFunded {
        prompt "Update funding metrics"
      }
      on event Loan.LoanDeclined {
        prompt "Update decline metrics"
      }
    } with {
      briefly "Maintains loan analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Loan analytics projections"
    described by "Maintains loan origination analytics data."
  }

} with {
  briefly "Bounded context for loan origination"
  described by {
    | The LoanContext is the bounded context for loan
    | application processing, underwriting, and funding.
  }
}
