// Account Management - Account Entity

entity Account is {

  // Commands
  command OpenAccount is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "New account identifier."
    }
    info is AccountInfo with {
      briefly "Info"
      described by "Account information."
    }
    initialDeposit is Decimal(15, 2) with {
      briefly "Initial deposit"
      described by "Opening deposit amount."
    }
  } with {
    briefly "Open account"
    described by "Opens a new bank account."
  }

  command UpdateAccountInfo is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to update."
    }
    info is AccountInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update account"
    described by "Updates account details."
  }

  command AddAccountHolder is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account identifier."
    }
    holder is AccountHolder with {
      briefly "Holder"
      described by "New account holder."
    }
  } with {
    briefly "Add holder"
    described by "Adds an account holder."
  }

  command RecordTransaction is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account identifier."
    }
    transaction is Transaction with {
      briefly "Transaction"
      described by "Transaction details."
    }
  } with {
    briefly "Record transaction"
    described by "Records an account transaction."
  }

  command ProcessTransfer is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Source account."
    }
    transfer is TransferDetails with {
      briefly "Transfer"
      described by "Transfer details."
    }
  } with {
    briefly "Process transfer"
    described by "Processes an account transfer."
  }

  command SetLimit is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account identifier."
    }
    limit is AccountLimit with {
      briefly "Limit"
      described by "Account limit."
    }
  } with {
    briefly "Set limit"
    described by "Sets account transaction limit."
  }

  command ApplyFee is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account identifier."
    }
    fee is FeeSchedule with {
      briefly "Fee"
      described by "Fee to apply."
    }
  } with {
    briefly "Apply fee"
    described by "Applies an account fee."
  }

  command FreezeAccount is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to freeze."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Freeze reason."
    }
  } with {
    briefly "Freeze account"
    described by "Freezes the account."
  }

  command UnfreezeAccount is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to unfreeze."
    }
  } with {
    briefly "Unfreeze account"
    described by "Unfreezes the account."
  }

  command CloseAccount is {
    accountId is AccountId with {
      briefly "Account ID"
      described by "Account to close."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Closure reason."
    }
  } with {
    briefly "Close account"
    described by "Closes the account."
  }

  // Events
  event AccountOpened is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    info is AccountInfo with { briefly "Info" described by "Account info." }
    initialBalance is Decimal(15, 2) with { briefly "Balance" described by "Initial balance." }
    openedAt is TimeStamp with { briefly "Opened" described by "Opening time." }
  } with {
    briefly "Account was opened"
    described by "Emitted when account is opened."
  }

  event AccountInfoUpdated is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    info is AccountInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Account info was updated"
    described by "Emitted when info changes."
  }

  event AccountHolderAdded is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    holder is AccountHolder with { briefly "Holder" described by "New holder." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Holder was added"
    described by "Emitted when holder is added."
  }

  event TransactionRecorded is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    transaction is Transaction with { briefly "Transaction" described by "Transaction." }
    newBalance is AccountBalance with { briefly "Balance" described by "New balance." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Transaction was recorded"
    described by "Emitted when transaction completes."
  }

  event TransferProcessed is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    transfer is TransferDetails with { briefly "Transfer" described by "Transfer details." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Transfer was processed"
    described by "Emitted when transfer completes."
  }

  event LimitSet is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    limit is AccountLimit with { briefly "Limit" described by "New limit." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Limit was set"
    described by "Emitted when limit is configured."
  }

  event FeeApplied is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    fee is FeeSchedule with { briefly "Fee" described by "Applied fee." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Fee was applied"
    described by "Emitted when fee is charged."
  }

  event AccountFrozen is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Freeze reason." }
    frozenAt is TimeStamp with { briefly "Frozen" described by "Freeze time." }
  } with {
    briefly "Account was frozen"
    described by "Emitted when account is frozen."
  }

  event AccountUnfrozen is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    unfrozenAt is TimeStamp with { briefly "Unfrozen" described by "Unfreeze time." }
  } with {
    briefly "Account was unfrozen"
    described by "Emitted when account is unfrozen."
  }

  event AccountClosed is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Account was closed"
    described by "Emitted when account is closed."
  }

  // State Records
  record ActiveStateData is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    info is AccountInfo with { briefly "Info" described by "Account info." }
    status is AccountStatus with { briefly "Status" described by "Account status." }
    balance is AccountBalance with { briefly "Balance" described by "Current balance." }
    holders is many AccountHolder with { briefly "Holders" described by "Account holders." }
    limits is many AccountLimit with { briefly "Limits" described by "Account limits." }
    transactions is many Transaction with { briefly "Transactions" described by "Recent transactions." }
    openedAt is TimeStamp with { briefly "Opened" described by "Opening time." }
  } with {
    briefly "Active state data"
    described by "State data for active account."
  }

  record FrozenStateData is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    info is AccountInfo with { briefly "Info" described by "Account info." }
    balance is AccountBalance with { briefly "Balance" described by "Current balance." }
    reason is String(1, 500) with { briefly "Reason" described by "Freeze reason." }
    frozenAt is TimeStamp with { briefly "Frozen" described by "Freeze time." }
  } with {
    briefly "Frozen state data"
    described by "State data for frozen account."
  }

  record ClosedStateData is {
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    info is AccountInfo with { briefly "Info" described by "Account info." }
    reason is String(1, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state data"
    described by "State data for closed account."
  }

  // States
  state ActiveState of Account.ActiveStateData with {
    briefly "Account is active"
    described by "Account is open for transactions."
  }

  state FrozenState of Account.FrozenStateData with {
    briefly "Account is frozen"
    described by "Account is temporarily frozen."
  }

  state ClosedState of Account.ClosedStateData with {
    briefly "Account is closed"
    described by "Account has been closed."
  }

  // Handler
  handler AccountHandler is {
    on command OpenAccount {
      morph entity AccountContext.Account to state AccountContext.Account.ActiveState with command OpenAccount
      tell event AccountOpened to entity AccountContext.Account
    }

    on command UpdateAccountInfo {
      tell event AccountInfoUpdated to entity AccountContext.Account
    }

    on command AddAccountHolder {
      tell event AccountHolderAdded to entity AccountContext.Account
    }

    on command RecordTransaction {
      tell event TransactionRecorded to entity AccountContext.Account
    }

    on command ProcessTransfer {
      tell event TransferProcessed to entity AccountContext.Account
    }

    on command SetLimit {
      tell event LimitSet to entity AccountContext.Account
    }

    on command ApplyFee {
      tell event FeeApplied to entity AccountContext.Account
    }

    on command FreezeAccount {
      morph entity AccountContext.Account to state AccountContext.Account.FrozenState with command FreezeAccount
      tell event AccountFrozen to entity AccountContext.Account
    }

    on command UnfreezeAccount {
      morph entity AccountContext.Account to state AccountContext.Account.ActiveState with command UnfreezeAccount
      tell event AccountUnfrozen to entity AccountContext.Account
    }

    on command CloseAccount {
      morph entity AccountContext.Account to state AccountContext.Account.ClosedState with command CloseAccount
      tell event AccountClosed to entity AccountContext.Account
    }
  } with {
    briefly "Processes account commands"
    described by {
      | Handles account lifecycle including transactions,
      | transfers, limits, and status changes.
    }
  }

} with {
  briefly "Account aggregate"
  described by {
    | The Account entity manages bank accounts including
    | transactions, balances, and account holders.
  }
}
