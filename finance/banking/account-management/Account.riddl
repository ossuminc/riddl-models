// Account Management - Account Entity
entity Account is {
  // Commands
  command OpenAccount is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |New account identifier.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Account information.
      }
    }
    initialDeposit: Decimal(15,2) with {
      briefly "Initial deposit"
      described as {
        |Opening deposit amount.
      }
    }
  } with {
    briefly "Open account"
    described as {
      |Opens a new bank account.
    }
  }
  command UpdateAccountInfo is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account to update.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Updated information.
      }
    }
  } with {
    briefly "Update account"
    described as {
      |Updates account details.
    }
  }
  command AddAccountHolder is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account identifier.
      }
    }
    holder: AccountHolder with {
      briefly "Holder"
      described as {
        |New account holder.
      }
    }
  } with {
    briefly "Add holder"
    described as {
      |Adds an account holder.
    }
  }
  command RecordTransaction is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account identifier.
      }
    }
    transaction: Transaction with {
      briefly "Transaction"
      described as {
        |Transaction details.
      }
    }
  } with {
    briefly "Record transaction"
    described as {
      |Records an account transaction.
    }
  }
  command ProcessTransfer is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Source account.
      }
    }
    transfer: TransferDetails with {
      briefly "Transfer"
      described as {
        |Transfer details.
      }
    }
  } with {
    briefly "Process transfer"
    described as {
      |Processes an account transfer.
    }
  }
  command SetLimit is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account identifier.
      }
    }
    limit: AccountLimit with {
      briefly "Limit"
      described as {
        |Account limit.
      }
    }
  } with {
    briefly "Set limit"
    described as {
      |Sets account transaction limit.
    }
  }
  command ApplyFee is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account identifier.
      }
    }
    fee: FeeSchedule with {
      briefly "Fee"
      described as {
        |Fee to apply.
      }
    }
  } with {
    briefly "Apply fee"
    described as {
      |Applies an account fee.
    }
  }
  command FreezeAccount is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account to freeze.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Freeze reason.
      }
    }
  } with {
    briefly "Freeze account"
    described as {
      |Freezes the account.
    }
  }
  command UnfreezeAccount is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account to unfreeze.
      }
    }
  } with {
    briefly "Unfreeze account"
    described as {
      |Unfreezes the account.
    }
  }
  command CloseAccount is  {
    accountId: AccountId with {
      briefly "Account ID"
      described as {
        |Account to close.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
  } with {
    briefly "Close account"
    described as {
      |Closes the account.
    }
  }
  // Events
  event AccountOpened is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Account info.
      }
    }
    initialBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |Initial balance.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Opening time.
      }
    }
  } with {
    briefly "Account was opened"
    described as {
      |Emitted when account is opened.
    }
  }
  event AccountInfoUpdated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Updated info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Account info was updated"
    described as {
      |Emitted when info changes.
    }
  }
  event AccountHolderAdded is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    holder: AccountHolder with {
      briefly "Holder"
      described as {
        |New holder.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Holder was added"
    described as {
      |Emitted when holder is added.
    }
  }
  event TransactionRecorded is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    transaction: Transaction with {
      briefly "Transaction"
      described as {
        |Transaction.
      }
    }
    newBalance: AccountBalance with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Transaction was recorded"
    described as {
      |Emitted when transaction completes.
    }
  }
  event TransferProcessed is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    transfer: TransferDetails with {
      briefly "Transfer"
      described as {
        |Transfer details.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Transfer was processed"
    described as {
      |Emitted when transfer completes.
    }
  }
  event LimitSet is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    limit: AccountLimit with {
      briefly "Limit"
      described as {
        |New limit.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Limit was set"
    described as {
      |Emitted when limit is configured.
    }
  }
  event FeeApplied is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    fee: FeeSchedule with {
      briefly "Fee"
      described as {
        |Applied fee.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Fee was applied"
    described as {
      |Emitted when fee is charged.
    }
  }
  event AccountFrozen is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Freeze reason.
      }
    }
    frozenAt: TimeStamp with {
      briefly "Frozen"
      described as {
        |Freeze time.
      }
    }
  } with {
    briefly "Account was frozen"
    described as {
      |Emitted when account is frozen.
    }
  }
  event AccountUnfrozen is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    unfrozenAt: TimeStamp with {
      briefly "Unfrozen"
      described as {
        |Unfreeze time.
      }
    }
  } with {
    briefly "Account was unfrozen"
    described as {
      |Emitted when account is unfrozen.
    }
  }
  event AccountClosed is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Account was closed"
    described as {
      |Emitted when account is closed.
    }
  }
  // State Records
  record ActiveStateData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Account info.
      }
    }
    status: AccountStatus with {
      briefly "Status"
      described as {
        |Account status.
      }
    }
    balance: AccountBalance with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    holders: AccountHolder+ with {
      briefly "Holders"
      described as {
        |Account holders.
      }
    }
    limits: AccountLimit+ with {
      briefly "Limits"
      described as {
        |Account limits.
      }
    }
    transactions: Transaction+ with {
      briefly "Transactions"
      described as {
        |Recent transactions.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Opening time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active account.
    }
  }
  record FrozenStateData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Account info.
      }
    }
    balance: AccountBalance with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Freeze reason.
      }
    }
    frozenAt: TimeStamp with {
      briefly "Frozen"
      described as {
        |Freeze time.
      }
    }
  } with {
    briefly "Frozen state data"
    described as {
      |State data for frozen account.
    }
  }
  record ClosedStateData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    info: AccountInfo with {
      briefly "Info"
      described as {
        |Account info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |State data for closed account.
    }
  }
  // States
  state ActiveState of type Account.ActiveStateData
  state FrozenState of type Account.FrozenStateData
  state ClosedState of type Account.ClosedStateData
  // Handler
  handler AccountHandler is {
    on command OpenAccount is {
      morph entity AccountContext.Account to state AccountContext.Account.ActiveState with command OpenAccount
      tell event AccountOpened to entity AccountContext.Account
    }
    on command UpdateAccountInfo is {
      tell event AccountInfoUpdated to entity AccountContext.Account
    }
    on command AddAccountHolder is {
      tell event AccountHolderAdded to entity AccountContext.Account
    }
    on command RecordTransaction is {
      tell event TransactionRecorded to entity AccountContext.Account
    }
    on command ProcessTransfer is {
      tell event TransferProcessed to entity AccountContext.Account
    }
    on command SetLimit is {
      tell event LimitSet to entity AccountContext.Account
    }
    on command ApplyFee is {
      tell event FeeApplied to entity AccountContext.Account
    }
    on command FreezeAccount is {
      morph entity AccountContext.Account to state AccountContext.Account.FrozenState with command FreezeAccount
      tell event AccountFrozen to entity AccountContext.Account
    }
    on command UnfreezeAccount is {
      morph entity AccountContext.Account to state AccountContext.Account.ActiveState with command UnfreezeAccount
      tell event AccountUnfrozen to entity AccountContext.Account
    }
    on command CloseAccount is {
      morph entity AccountContext.Account to state AccountContext.Account.ClosedState with command CloseAccount
      tell event AccountClosed to entity AccountContext.Account
    }
  } with {
    briefly "Processes account commands"
    described as {
      | Handles account lifecycle including transactions,
      | transfers, limits, and status changes.
    }
  }
} with {
  briefly "Account aggregate"
  described as {
    | The Account entity manages bank accounts including
    | transactions, balances, and account holders.
  }
}
