// Fund Transfer - Transfer Entity

entity Transfer is {

  // Commands
  command SubmitTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "New transfer identifier."
    }
    info is TransferInfo with {
      briefly "Info"
      described by "Transfer information."
    }
    domesticRecipient is optional DomesticRecipient with {
      briefly "Domestic"
      described by "Domestic recipient."
    }
    internationalRecipient is optional InternationalRecipient with {
      briefly "International"
      described by "International recipient."
    }
    customerId is CustomerId with {
      briefly "Customer"
      described by "Initiating customer."
    }
  } with {
    briefly "Submit transfer"
    described by "Submits a new fund transfer."
  }

  command ValidateTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to validate."
    }
  } with {
    briefly "Validate transfer"
    described by "Validates transfer details."
  }

  command ApplyFees is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer identifier."
    }
    fees is TransferFees with {
      briefly "Fees"
      described by "Transfer fees."
    }
  } with {
    briefly "Apply fees"
    described by "Applies transfer fees."
  }

  command ApplyExchangeRate is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer identifier."
    }
    exchangeRate is ExchangeRate with {
      briefly "Rate"
      described by "Exchange rate."
    }
  } with {
    briefly "Apply exchange rate"
    described by "Applies currency exchange."
  }

  command RouteTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to route."
    }
    networkReference is String(1, 50) with {
      briefly "Reference"
      described by "Network reference."
    }
  } with {
    briefly "Route transfer"
    described by "Routes to payment network."
  }

  command ProcessTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to process."
    }
  } with {
    briefly "Process transfer"
    described by "Processes the transfer."
  }

  command CompleteTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to complete."
    }
  } with {
    briefly "Complete transfer"
    described by "Marks transfer as complete."
  }

  command ReturnTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to return."
    }
    returnReason is ReturnReason with {
      briefly "Reason"
      described by "Return reason."
    }
  } with {
    briefly "Return transfer"
    described by "Returns the transfer."
  }

  command CancelTransfer is {
    transferId is TransferId with {
      briefly "Transfer ID"
      described by "Transfer to cancel."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel transfer"
    described by "Cancels the transfer."
  }

  // Events
  event TransferSubmitted is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    info is TransferInfo with { briefly "Info" described by "Transfer info." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Transfer was submitted"
    described by "Emitted when transfer is submitted."
  }

  event TransferValidated is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    validatedAt is TimeStamp with { briefly "Validated" described by "Validation time." }
  } with {
    briefly "Transfer was validated"
    described by "Emitted when validation passes."
  }

  event FeesApplied is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    fees is TransferFees with { briefly "Fees" described by "Applied fees." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Fees were applied"
    described by "Emitted when fees are calculated."
  }

  event ExchangeRateApplied is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    exchangeRate is ExchangeRate with { briefly "Rate" described by "Exchange rate." }
    convertedAmount is Decimal(15, 2) with { briefly "Amount" described by "Converted amount." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Exchange rate was applied"
    described by "Emitted when currency is converted."
  }

  event TransferRouted is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    networkReference is String(1, 50) with { briefly "Reference" described by "Network reference." }
    routedAt is TimeStamp with { briefly "Routed" described by "Routing time." }
  } with {
    briefly "Transfer was routed"
    described by "Emitted when sent to network."
  }

  event TransferProcessed is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    processedAt is TimeStamp with { briefly "Processed" described by "Processing time." }
  } with {
    briefly "Transfer was processed"
    described by "Emitted when processing completes."
  }

  event TransferCompleted is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    tracking is TransferTracking with { briefly "Tracking" described by "Tracking info." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Transfer was completed"
    described by "Emitted when transfer finishes."
  }

  event TransferReturned is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    returnReason is ReturnReason with { briefly "Reason" described by "Return reason." }
    returnedAt is TimeStamp with { briefly "Returned" described by "Return time." }
  } with {
    briefly "Transfer was returned"
    described by "Emitted when transfer is returned."
  }

  event TransferCancelled is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Transfer was cancelled"
    described by "Emitted when transfer is cancelled."
  }

  // State Records
  record PendingStateData is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    info is TransferInfo with { briefly "Info" described by "Transfer info." }
    status is TransferStatus with { briefly "Status" described by "Current status." }
    customerId is CustomerId with { briefly "Customer" described by "Customer ID." }
    domesticRecipient is optional DomesticRecipient with { briefly "Domestic" described by "Domestic recipient." }
    internationalRecipient is optional InternationalRecipient with { briefly "International" described by "International recipient." }
    appliedFees is optional TransferFees with { briefly "Fees" described by "Transfer fees." }
    appliedExchangeRate is optional ExchangeRate with { briefly "Rate" described by "Exchange rate." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Pending state data"
    described by "State data for pending transfer."
  }

  record ProcessingStateData is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    info is TransferInfo with { briefly "Info" described by "Transfer info." }
    status is TransferStatus with { briefly "Status" described by "Current status." }
    tracking is TransferTracking with { briefly "Tracking" described by "Tracking info." }
    fees is TransferFees with { briefly "Fees" described by "Transfer fees." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
    routedAt is TimeStamp with { briefly "Routed" described by "Routing time." }
  } with {
    briefly "Processing state data"
    described by "State data for processing transfer."
  }

  record CompletedStateData is {
    transferId is TransferId with { briefly "Transfer" described by "Transfer ID." }
    info is TransferInfo with { briefly "Info" described by "Transfer info." }
    tracking is TransferTracking with { briefly "Tracking" described by "Tracking info." }
    fees is TransferFees with { briefly "Fees" described by "Transfer fees." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state data"
    described by "State data for completed transfer."
  }

  // States
  state PendingState of Transfer.PendingStateData with {
    briefly "Transfer is pending"
    described by "Transfer is awaiting processing."
  }

  state ProcessingState of Transfer.ProcessingStateData with {
    briefly "Transfer is processing"
    described by "Transfer is being processed."
  }

  state CompletedState of Transfer.CompletedStateData with {
    briefly "Transfer is completed"
    described by "Transfer has finished."
  }

  // Handler
  handler TransferHandler is {
    on command SubmitTransfer {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.PendingState with command SubmitTransfer
      tell event TransferSubmitted to entity TransferContext.Transfer
    }

    on command ValidateTransfer {
      tell event TransferValidated to entity TransferContext.Transfer
    }

    on command ApplyFees {
      tell event FeesApplied to entity TransferContext.Transfer
    }

    on command ApplyExchangeRate {
      tell event ExchangeRateApplied to entity TransferContext.Transfer
    }

    on command RouteTransfer {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.ProcessingState with command RouteTransfer
      tell event TransferRouted to entity TransferContext.Transfer
    }

    on command ProcessTransfer {
      tell event TransferProcessed to entity TransferContext.Transfer
    }

    on command CompleteTransfer {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.CompletedState with command CompleteTransfer
      tell event TransferCompleted to entity TransferContext.Transfer
    }

    on command ReturnTransfer {
      tell event TransferReturned to entity TransferContext.Transfer
    }

    on command CancelTransfer {
      tell event TransferCancelled to entity TransferContext.Transfer
    }
  } with {
    briefly "Processes transfer commands"
    described by {
      | Handles fund transfer lifecycle including validation,
      | routing, processing, and completion.
    }
  }

} with {
  briefly "Transfer aggregate"
  described by {
    | The Transfer entity manages fund transfers including
    | domestic and international payments.
  }
}
