// Fund Transfer - Transfer Entity
entity Transfer is {
  // Commands
  command SubmitTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |New transfer identifier.
      }
    }
    info: TransferInfo with {
      briefly "Info"
      described as {
        |Transfer information.
      }
    }
    domesticRecipient: DomesticRecipient? with {
      briefly "Domestic"
      described as {
        |Domestic recipient.
      }
    }
    internationalRecipient: InternationalRecipient? with {
      briefly "International"
      described as {
        |International recipient.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Initiating customer.
      }
    }
  } with {
    briefly "Submit transfer"
    described as {
      |Submits a new fund transfer.
    }
  }
  command ValidateTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to validate.
      }
    }
  } with {
    briefly "Validate transfer"
    described as {
      |Validates transfer details.
    }
  }
  command ApplyFees is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer identifier.
      }
    }
    fees: TransferFees with {
      briefly "Fees"
      described as {
        |Transfer fees.
      }
    }
  } with {
    briefly "Apply fees"
    described as {
      |Applies transfer fees.
    }
  }
  command ApplyExchangeRate is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer identifier.
      }
    }
    exchangeRate: ExchangeRate with {
      briefly "Rate"
      described as {
        |Exchange rate.
      }
    }
  } with {
    briefly "Apply exchange rate"
    described as {
      |Applies currency exchange.
    }
  }
  command RouteTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to route.
      }
    }
    networkReference: String(1,50) with {
      briefly "Reference"
      described as {
        |Network reference.
      }
    }
  } with {
    briefly "Route transfer"
    described as {
      |Routes to payment network.
    }
  }
  command ProcessTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to process.
      }
    }
  } with {
    briefly "Process transfer"
    described as {
      |Processes the transfer.
    }
  }
  command CompleteTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to complete.
      }
    }
  } with {
    briefly "Complete transfer"
    described as {
      |Marks transfer as complete.
    }
  }
  command ReturnTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to return.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
  } with {
    briefly "Return transfer"
    described as {
      |Returns the transfer.
    }
  }
  command CancelTransfer is  {
    transferId: TransferId with {
      briefly "Transfer ID"
      described as {
        |Transfer to cancel.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel transfer"
    described as {
      |Cancels the transfer.
    }
  }
  // Events
  event TransferSubmitted is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    info: TransferInfo with {
      briefly "Info"
      described as {
        |Transfer info.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Transfer was submitted"
    described as {
      |Emitted when transfer is submitted.
    }
  }
  event TransferValidated is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    validatedAt: TimeStamp with {
      briefly "Validated"
      described as {
        |Validation time.
      }
    }
  } with {
    briefly "Transfer was validated"
    described as {
      |Emitted when validation passes.
    }
  }
  event FeesApplied is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    fees: TransferFees with {
      briefly "Fees"
      described as {
        |Applied fees.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Fees were applied"
    described as {
      |Emitted when fees are calculated.
    }
  }
  event ExchangeRateApplied is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    exchangeRate: ExchangeRate with {
      briefly "Rate"
      described as {
        |Exchange rate.
      }
    }
    convertedAmount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Converted amount.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Exchange rate was applied"
    described as {
      |Emitted when currency is converted.
    }
  }
  event TransferRouted is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    networkReference: String(1,50) with {
      briefly "Reference"
      described as {
        |Network reference.
      }
    }
    routedAt: TimeStamp with {
      briefly "Routed"
      described as {
        |Routing time.
      }
    }
  } with {
    briefly "Transfer was routed"
    described as {
      |Emitted when sent to network.
    }
  }
  event TransferProcessed is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Processing time.
      }
    }
  } with {
    briefly "Transfer was processed"
    described as {
      |Emitted when processing completes.
    }
  }
  event TransferCompleted is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    tracking: TransferTracking with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Transfer was completed"
    described as {
      |Emitted when transfer finishes.
    }
  }
  event TransferReturned is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    returnReason: ReturnReason with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
    returnedAt: TimeStamp with {
      briefly "Returned"
      described as {
        |Return time.
      }
    }
  } with {
    briefly "Transfer was returned"
    described as {
      |Emitted when transfer is returned.
    }
  }
  event TransferCancelled is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Transfer was cancelled"
    described as {
      |Emitted when transfer is cancelled.
    }
  }
  // State Records
  record PendingStateData is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    info: TransferInfo with {
      briefly "Info"
      described as {
        |Transfer info.
      }
    }
    status: TransferStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    customerId: CustomerId with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    domesticRecipient: DomesticRecipient? with {
      briefly "Domestic"
      described as {
        |Domestic recipient.
      }
    }
    internationalRecipient: InternationalRecipient? with {
      briefly "International"
      described as {
        |International recipient.
      }
    }
    appliedFees: TransferFees? with {
      briefly "Fees"
      described as {
        |Transfer fees.
      }
    }
    appliedExchangeRate: ExchangeRate? with {
      briefly "Rate"
      described as {
        |Exchange rate.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Pending state data"
    described as {
      |State data for pending transfer.
    }
  }
  record ProcessingStateData is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    info: TransferInfo with {
      briefly "Info"
      described as {
        |Transfer info.
      }
    }
    status: TransferStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    tracking: TransferTracking with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    fees: TransferFees with {
      briefly "Fees"
      described as {
        |Transfer fees.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
    routedAt: TimeStamp with {
      briefly "Routed"
      described as {
        |Routing time.
      }
    }
  } with {
    briefly "Processing state data"
    described as {
      |State data for processing transfer.
    }
  }
  record CompletedStateData is  {
    transferId: TransferId with {
      briefly "Transfer"
      described as {
        |Transfer ID.
      }
    }
    info: TransferInfo with {
      briefly "Info"
      described as {
        |Transfer info.
      }
    }
    tracking: TransferTracking with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    fees: TransferFees with {
      briefly "Fees"
      described as {
        |Transfer fees.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |State data for completed transfer.
    }
  }
  // States
  state PendingState of type Transfer.PendingStateData
  state ProcessingState of type Transfer.ProcessingStateData
  state CompletedState of type Transfer.CompletedStateData
  // Handler
  handler TransferHandler is {
    on command SubmitTransfer is {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.PendingState with command SubmitTransfer
      tell event TransferSubmitted to entity TransferContext.Transfer
    }
    on command ValidateTransfer is {
      tell event TransferValidated to entity TransferContext.Transfer
    }
    on command ApplyFees is {
      tell event FeesApplied to entity TransferContext.Transfer
    }
    on command ApplyExchangeRate is {
      tell event ExchangeRateApplied to entity TransferContext.Transfer
    }
    on command RouteTransfer is {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.ProcessingState with command RouteTransfer
      tell event TransferRouted to entity TransferContext.Transfer
    }
    on command ProcessTransfer is {
      tell event TransferProcessed to entity TransferContext.Transfer
    }
    on command CompleteTransfer is {
      morph entity TransferContext.Transfer to state TransferContext.Transfer.CompletedState with command CompleteTransfer
      tell event TransferCompleted to entity TransferContext.Transfer
    }
    on command ReturnTransfer is {
      tell event TransferReturned to entity TransferContext.Transfer
    }
    on command CancelTransfer is {
      tell event TransferCancelled to entity TransferContext.Transfer
    }
  } with {
    briefly "Processes transfer commands"
    described as {
      | Handles fund transfer lifecycle including validation,
      | routing, processing, and completion.
    }
  }
} with {
  briefly "Transfer aggregate"
  described as {
    | The Transfer entity manages fund transfers including
    | domestic and international payments.
  }
}
