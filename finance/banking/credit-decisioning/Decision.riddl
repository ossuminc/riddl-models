// Credit Decisioning - Decision Entity

entity Decision is {

  // Commands
  command EvaluateApplication is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "New decision identifier."
    }
    applicationId is ApplicationId with {
      briefly "Application"
      described by "Application to evaluate."
    }
    applicant is ApplicantInfo with {
      briefly "Applicant"
      described by "Applicant information."
    }
    request is CreditRequest with {
      briefly "Request"
      described by "Credit request details."
    }
  } with {
    briefly "Evaluate application"
    described by "Initiates credit evaluation."
  }

  command AddBureauData is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
    bureauData is CreditBureauData with {
      briefly "Bureau data"
      described by "Credit bureau report."
    }
  } with {
    briefly "Add bureau data"
    described by "Adds credit bureau information."
  }

  command CalculateScore is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
  } with {
    briefly "Calculate score"
    described by "Calculates credit scores."
  }

  command ApplyPolicy is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
  } with {
    briefly "Apply policy"
    described by "Applies credit policy rules."
  }

  command RenderDecision is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
  } with {
    briefly "Render decision"
    described by "Renders automated decision."
  }

  command ReferToUnderwriter is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Referral reason."
    }
  } with {
    briefly "Refer to underwriter"
    described by "Sends to manual review."
  }

  command ApproveManually is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
    result is DecisionResult with {
      briefly "Result"
      described by "Approval decision."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Approving underwriter."
    }
  } with {
    briefly "Approve manually"
    described by "Manual approval decision."
  }

  command DeclineManually is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
    reasons is many String(1, 200) with {
      briefly "Reasons"
      described by "Decline reasons."
    }
    declinedBy is String(1, 100) with {
      briefly "Declined by"
      described by "Declining underwriter."
    }
  } with {
    briefly "Decline manually"
    described by "Manual decline decision."
  }

  command OverrideDecision is {
    decisionId is DecisionId with {
      briefly "Decision ID"
      described by "Decision identifier."
    }
    newResult is DecisionResult with {
      briefly "New result"
      described by "Overridden decision."
    }
    override is OverrideInfo with {
      briefly "Override"
      described by "Override details."
    }
  } with {
    briefly "Override decision"
    described by "Overrides existing decision."
  }

  // Events
  event ApplicationEvaluationStarted is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    applicationId is ApplicationId with { briefly "Application" described by "Application ID." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant info." }
    request is CreditRequest with { briefly "Request" described by "Credit request." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Evaluation started"
    described by "Emitted when evaluation begins."
  }

  event BureauDataAdded is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    bureauData is CreditBureauData with { briefly "Bureau" described by "Bureau data." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Bureau data added"
    described by "Emitted when bureau data is received."
  }

  event ScoreCalculated is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    score is CreditScore with { briefly "Score" described by "Calculated scores." }
    calculatedAt is TimeStamp with { briefly "Calculated" described by "Calculation time." }
  } with {
    briefly "Score calculated"
    described by "Emitted when scores are calculated."
  }

  event PolicyApplied is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    rules is many PolicyRule with { briefly "Rules" described by "Policy rule results." }
    allPassed is Boolean with { briefly "All passed" described by "All rules passed." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Policy applied"
    described by "Emitted when policy rules are evaluated."
  }

  event DecisionRendered is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    result is DecisionResult with { briefly "Result" described by "Decision result." }
    automated is Boolean with { briefly "Automated" described by "Was automated." }
    renderedAt is TimeStamp with { briefly "Rendered" described by "Decision time." }
  } with {
    briefly "Decision rendered"
    described by "Emitted when decision is made."
  }

  event ReferredToUnderwriter is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Referral reason." }
    referredAt is TimeStamp with { briefly "Referred" described by "Referral time." }
  } with {
    briefly "Referred to underwriter"
    described by "Emitted when sent to manual review."
  }

  event ManuallyApproved is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    result is DecisionResult with { briefly "Result" described by "Approval result." }
    approvedBy is String(1, 100) with { briefly "Approved by" described by "Approver." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Manually approved"
    described by "Emitted when manually approved."
  }

  event ManuallyDeclined is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    reasons is many String(1, 200) with { briefly "Reasons" described by "Decline reasons." }
    declinedBy is String(1, 100) with { briefly "Declined by" described by "Decliner." }
    declinedAt is TimeStamp with { briefly "Declined" described by "Decline time." }
  } with {
    briefly "Manually declined"
    described by "Emitted when manually declined."
  }

  event DecisionOverridden is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    previousResult is DecisionResult with { briefly "Previous" described by "Prior decision." }
    newResult is DecisionResult with { briefly "New" described by "New decision." }
    override is OverrideInfo with { briefly "Override" described by "Override info." }
  } with {
    briefly "Decision overridden"
    described by "Emitted when decision is overridden."
  }

  // State Records
  record PendingStateData is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    applicationId is ApplicationId with { briefly "Application" described by "Application ID." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant info." }
    request is CreditRequest with { briefly "Request" described by "Credit request." }
    status is DecisionStatus with { briefly "Status" described by "Decision status." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Pending state data"
    described by "State for pending evaluation."
  }

  record InReviewStateData is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    applicationId is ApplicationId with { briefly "Application" described by "Application ID." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant info." }
    request is CreditRequest with { briefly "Request" described by "Credit request." }
    bureauData is many optional CreditBureauData with { briefly "Bureau" described by "Bureau data." }
    score is optional CreditScore with { briefly "Score" described by "Credit scores." }
    policyResults is many optional PolicyRule with { briefly "Policy" described by "Policy results." }
    status is DecisionStatus with { briefly "Status" described by "Decision status." }
  } with {
    briefly "In review state data"
    described by "State for application under review."
  }

  record DecidedStateData is {
    decisionId is DecisionId with { briefly "Decision" described by "Decision ID." }
    applicationId is ApplicationId with { briefly "Application" described by "Application ID." }
    applicant is ApplicantInfo with { briefly "Applicant" described by "Applicant info." }
    request is CreditRequest with { briefly "Request" described by "Credit request." }
    bureauData is many optional CreditBureauData with { briefly "Bureau" described by "Bureau data." }
    score is CreditScore with { briefly "Score" described by "Credit scores." }
    result is DecisionResult with { briefly "Result" described by "Decision result." }
    automated is Boolean with { briefly "Automated" described by "Was automated." }
    decidedBy is optional String(1, 100) with { briefly "Decided by" described by "Decider if manual." }
    decidedAt is TimeStamp with { briefly "Decided" described by "Decision time." }
  } with {
    briefly "Decided state data"
    described by "State for completed decision."
  }

  // States
  state PendingState of Decision.PendingStateData with {
    briefly "Decision pending"
    described by "Awaiting evaluation data."
  }

  state InReviewState of Decision.InReviewStateData with {
    briefly "In review"
    described by "Under active evaluation."
  }

  state DecidedState of Decision.DecidedStateData with {
    briefly "Decision made"
    described by "Final decision rendered."
  }

  // Handler
  handler DecisionHandler is {
    on command EvaluateApplication {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.PendingState with command EvaluateApplication
      tell event ApplicationEvaluationStarted to entity DecisionContext.Decision
    }

    on command AddBureauData {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.InReviewState with command AddBureauData
      tell event BureauDataAdded to entity DecisionContext.Decision
    }

    on command CalculateScore {
      tell event ScoreCalculated to entity DecisionContext.Decision
    }

    on command ApplyPolicy {
      tell event PolicyApplied to entity DecisionContext.Decision
    }

    on command RenderDecision {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command RenderDecision
      tell event DecisionRendered to entity DecisionContext.Decision
    }

    on command ReferToUnderwriter {
      tell event ReferredToUnderwriter to entity DecisionContext.Decision
    }

    on command ApproveManually {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command ApproveManually
      tell event ManuallyApproved to entity DecisionContext.Decision
    }

    on command DeclineManually {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command DeclineManually
      tell event ManuallyDeclined to entity DecisionContext.Decision
    }

    on command OverrideDecision {
      tell event DecisionOverridden to entity DecisionContext.Decision
    }
  } with {
    briefly "Processes decision commands"
    described by {
      | Handles credit decision lifecycle from evaluation
      | through scoring, policy application, and final decision.
    }
  }

} with {
  briefly "Decision aggregate"
  described by {
    | The Decision entity manages credit decisions including
    | scoring, policy evaluation, and approval workflow.
  }
}
