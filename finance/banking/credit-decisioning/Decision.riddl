// Credit Decisioning - Decision Entity
entity Decision is {
  // Commands
  command EvaluateApplication is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |New decision identifier.
      }
    }
    applicationId: ApplicationId with {
      briefly "Application"
      described as {
        |Application to evaluate.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant information.
      }
    }
    request: CreditRequest with {
      briefly "Request"
      described as {
        |Credit request details.
      }
    }
  } with {
    briefly "Evaluate application"
    described as {
      |Initiates credit evaluation.
    }
  }
  command AddBureauData is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
    bureauData: CreditBureauData with {
      briefly "Bureau data"
      described as {
        |Credit bureau report.
      }
    }
  } with {
    briefly "Add bureau data"
    described as {
      |Adds credit bureau information.
    }
  }
  command CalculateScore is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
  } with {
    briefly "Calculate score"
    described as {
      |Calculates credit scores.
    }
  }
  command ApplyPolicy is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
  } with {
    briefly "Apply policy"
    described as {
      |Applies credit policy rules.
    }
  }
  command RenderDecision is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
  } with {
    briefly "Render decision"
    described as {
      |Renders automated decision.
    }
  }
  command ReferToUnderwriter is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Referral reason.
      }
    }
  } with {
    briefly "Refer to underwriter"
    described as {
      |Sends to manual review.
    }
  }
  command ApproveManually is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
    result: DecisionResult with {
      briefly "Result"
      described as {
        |Approval decision.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approving underwriter.
      }
    }
  } with {
    briefly "Approve manually"
    described as {
      |Manual approval decision.
    }
  }
  command DeclineManually is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
    reasons: String(1,200)+ with {
      briefly "Reasons"
      described as {
        |Decline reasons.
      }
    }
    declinedBy: String(1,100) with {
      briefly "Declined by"
      described as {
        |Declining underwriter.
      }
    }
  } with {
    briefly "Decline manually"
    described as {
      |Manual decline decision.
    }
  }
  command OverrideDecision is  {
    decisionId: DecisionId with {
      briefly "Decision ID"
      described as {
        |Decision identifier.
      }
    }
    newResult: DecisionResult with {
      briefly "New result"
      described as {
        |Overridden decision.
      }
    }
    override: OverrideInfo with {
      briefly "Override"
      described as {
        |Override details.
      }
    }
  } with {
    briefly "Override decision"
    described as {
      |Overrides existing decision.
    }
  }
  // Events
  event ApplicationEvaluationStarted is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    applicationId: ApplicationId with {
      briefly "Application"
      described as {
        |Application ID.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant info.
      }
    }
    request: CreditRequest with {
      briefly "Request"
      described as {
        |Credit request.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Evaluation started"
    described as {
      |Emitted when evaluation begins.
    }
  }
  event BureauDataAdded is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    bureauData: CreditBureauData with {
      briefly "Bureau"
      described as {
        |Bureau data.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Bureau data added"
    described as {
      |Emitted when bureau data is received.
    }
  }
  event ScoreCalculated is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    score: CreditScore with {
      briefly "Score"
      described as {
        |Calculated scores.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Score calculated"
    described as {
      |Emitted when scores are calculated.
    }
  }
  event PolicyApplied is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    rules: PolicyRule+ with {
      briefly "Rules"
      described as {
        |Policy rule results.
      }
    }
    allPassed: Boolean with {
      briefly "All passed"
      described as {
        |All rules passed.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Policy applied"
    described as {
      |Emitted when policy rules are evaluated.
    }
  }
  event DecisionRendered is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    result: DecisionResult with {
      briefly "Result"
      described as {
        |Decision result.
      }
    }
    automated: Boolean with {
      briefly "Automated"
      described as {
        |Was automated.
      }
    }
    renderedAt: TimeStamp with {
      briefly "Rendered"
      described as {
        |Decision time.
      }
    }
  } with {
    briefly "Decision rendered"
    described as {
      |Emitted when decision is made.
    }
  }
  event ReferredToUnderwriter is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Referral reason.
      }
    }
    referredAt: TimeStamp with {
      briefly "Referred"
      described as {
        |Referral time.
      }
    }
  } with {
    briefly "Referred to underwriter"
    described as {
      |Emitted when sent to manual review.
    }
  }
  event ManuallyApproved is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    result: DecisionResult with {
      briefly "Result"
      described as {
        |Approval result.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Manually approved"
    described as {
      |Emitted when manually approved.
    }
  }
  event ManuallyDeclined is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    reasons: String(1,200)+ with {
      briefly "Reasons"
      described as {
        |Decline reasons.
      }
    }
    declinedBy: String(1,100) with {
      briefly "Declined by"
      described as {
        |Decliner.
      }
    }
    declinedAt: TimeStamp with {
      briefly "Declined"
      described as {
        |Decline time.
      }
    }
  } with {
    briefly "Manually declined"
    described as {
      |Emitted when manually declined.
    }
  }
  event DecisionOverridden is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    previousResult: DecisionResult with {
      briefly "Previous"
      described as {
        |Prior decision.
      }
    }
    newResult: DecisionResult with {
      briefly "New"
      described as {
        |New decision.
      }
    }
    override: OverrideInfo with {
      briefly "Override"
      described as {
        |Override info.
      }
    }
  } with {
    briefly "Decision overridden"
    described as {
      |Emitted when decision is overridden.
    }
  }
  // State Records
  record PendingStateData is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    applicationId: ApplicationId with {
      briefly "Application"
      described as {
        |Application ID.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant info.
      }
    }
    request: CreditRequest with {
      briefly "Request"
      described as {
        |Credit request.
      }
    }
    status: DecisionStatus with {
      briefly "Status"
      described as {
        |Decision status.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Pending state data"
    described as {
      |State for pending evaluation.
    }
  }
  record InReviewStateData is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    applicationId: ApplicationId with {
      briefly "Application"
      described as {
        |Application ID.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant info.
      }
    }
    request: CreditRequest with {
      briefly "Request"
      described as {
        |Credit request.
      }
    }
    collectedBureauData: CreditBureauData* with {
      briefly "Bureau"
      described as {
        |Bureau data.
      }
    }
    calculatedScore: CreditScore? with {
      briefly "Score"
      described as {
        |Credit scores.
      }
    }
    policyResults: PolicyRule* with {
      briefly "Policy"
      described as {
        |Policy results.
      }
    }
    status: DecisionStatus with {
      briefly "Status"
      described as {
        |Decision status.
      }
    }
  } with {
    briefly "In review state data"
    described as {
      |State for application under review.
    }
  }
  record DecidedStateData is  {
    decisionId: DecisionId with {
      briefly "Decision"
      described as {
        |Decision ID.
      }
    }
    applicationId: ApplicationId with {
      briefly "Application"
      described as {
        |Application ID.
      }
    }
    applicant: ApplicantInfo with {
      briefly "Applicant"
      described as {
        |Applicant info.
      }
    }
    request: CreditRequest with {
      briefly "Request"
      described as {
        |Credit request.
      }
    }
    collectedBureauData: CreditBureauData* with {
      briefly "Bureau"
      described as {
        |Bureau data.
      }
    }
    finalScore: CreditScore with {
      briefly "Score"
      described as {
        |Credit scores.
      }
    }
    result: DecisionResult with {
      briefly "Result"
      described as {
        |Decision result.
      }
    }
    automated: Boolean with {
      briefly "Automated"
      described as {
        |Was automated.
      }
    }
    decidedBy: String(1,100)? with {
      briefly "Decided by"
      described as {
        |Decider if manual.
      }
    }
    decidedAt: TimeStamp with {
      briefly "Decided"
      described as {
        |Decision time.
      }
    }
  } with {
    briefly "Decided state data"
    described as {
      |State for completed decision.
    }
  }
  // States
  state PendingState of type Decision.PendingStateData
  state InReviewState of type Decision.InReviewStateData
  state DecidedState of type Decision.DecidedStateData
  // Handler
  handler DecisionHandler is {
    on command EvaluateApplication is {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.PendingState with command EvaluateApplication
      tell event ApplicationEvaluationStarted to entity DecisionContext.Decision
    }
    on command AddBureauData is {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.InReviewState with command AddBureauData
      tell event BureauDataAdded to entity DecisionContext.Decision
    }
    on command CalculateScore is {
      tell event ScoreCalculated to entity DecisionContext.Decision
    }
    on command ApplyPolicy is {
      tell event PolicyApplied to entity DecisionContext.Decision
    }
    on command RenderDecision is {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command RenderDecision
      tell event DecisionRendered to entity DecisionContext.Decision
    }
    on command ReferToUnderwriter is {
      tell event ReferredToUnderwriter to entity DecisionContext.Decision
    }
    on command ApproveManually is {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command ApproveManually
      tell event ManuallyApproved to entity DecisionContext.Decision
    }
    on command DeclineManually is {
      morph entity DecisionContext.Decision to state DecisionContext.Decision.DecidedState with command DeclineManually
      tell event ManuallyDeclined to entity DecisionContext.Decision
    }
    on command OverrideDecision is {
      tell event DecisionOverridden to entity DecisionContext.Decision
    }
  } with {
    briefly "Processes decision commands"
    described as {
      | Handles credit decision lifecycle from evaluation
      | through scoring, policy application, and final decision.
    }
  }
} with {
  briefly "Decision aggregate"
  described as {
    | The Decision entity manages credit decisions including
    | scoring, policy evaluation, and approval workflow.
  }
}
