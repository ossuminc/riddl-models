// Credit Decisioning - Decision Context

context DecisionContext is {

  include "types.riddl"
  include "Decision.riddl"

  // Repository for decision persistence
  repository DecisionRepository is {
    schema DecisionData is relational
      of decisions as Decision
      index on field Decision.decisionId
      index on field Decision.applicationId

    handler DecisionPersistence is {
      on event Decision.ApplicationEvaluationStarted {
        prompt "Store new decision record"
      }
      on event Decision.BureauDataAdded {
        prompt "Store bureau data"
      }
      on event Decision.ScoreCalculated {
        prompt "Store calculated scores"
      }
      on event Decision.PolicyApplied {
        prompt "Store policy results"
      }
      on event Decision.DecisionRendered {
        prompt "Store final decision"
      }
      on event Decision.ReferredToUnderwriter {
        prompt "Update status to manual review"
      }
      on event Decision.ManuallyApproved {
        prompt "Store manual approval"
      }
      on event Decision.ManuallyDeclined {
        prompt "Store manual decline"
      }
      on event Decision.DecisionOverridden {
        prompt "Store override record"
      }
    } with {
      briefly "Persists decision events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Decision data persistence"
    described by {
      | The DecisionRepository provides persistent storage for
      | credit decisions and evaluation data.
    }
  }

  // Projector for decision analytics
  projector DecisionAnalytics is {
    updates repository DecisionRepository

    record DecisionStats is {
      totalApplications is Natural with { briefly "Total" described by "Total applications." }
      autoApprovalRate is Decimal(5, 4) with { briefly "Auto approval" described by "Auto-approval rate." }
      manualReviewRate is Decimal(5, 4) with { briefly "Manual review" described by "Manual review rate." }
      overallApprovalRate is Decimal(5, 4) with { briefly "Approval" described by "Overall approval rate." }
      avgDecisionTime is Duration with { briefly "Avg time" described by "Average decision time." }
      avgApprovedAmount is Decimal(12, 2) with { briefly "Avg amount" described by "Average approved amount." }
    } with {
      briefly "Decision statistics"
      described by "Credit decisioning metrics."
    }

    handler AnalyticsHandler is {
      on event Decision.ApplicationEvaluationStarted {
        prompt "Update application counts"
      }
      on event Decision.DecisionRendered {
        prompt "Update decision metrics"
      }
      on event Decision.ManuallyApproved {
        prompt "Update approval metrics"
      }
      on event Decision.ManuallyDeclined {
        prompt "Update decline metrics"
      }
    } with {
      briefly "Maintains decision analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Decision analytics projections"
    described by "Maintains credit decisioning analytics data."
  }

} with {
  briefly "Bounded context for credit decisioning"
  described by {
    | The DecisionContext is the bounded context for credit
    | evaluation, scoring, and approval decisions.
  }
}
