// Digital Wallet - Wallet Entity
entity Wallet is {
  // Commands
  command CreateWallet is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |New wallet identifier.
      }
    }
    userId: UserId with {
      briefly "User ID"
      described as {
        |Wallet owner.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Primary currency.
      }
    }
  } with {
    briefly "Create wallet"
    described as {
      |Creates a new digital wallet.
    }
  }
  command AddPaymentMethod is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    method: LinkedPaymentMethod with {
      briefly "Method"
      described as {
        |Payment method to add.
      }
    }
  } with {
    briefly "Add payment method"
    described as {
      |Links a payment method to wallet.
    }
  }
  command RemovePaymentMethod is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    methodId: PaymentMethodId with {
      briefly "Method ID"
      described as {
        |Method to remove.
      }
    }
  } with {
    briefly "Remove payment method"
    described as {
      |Unlinks a payment method.
    }
  }
  command SetDefaultMethod is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    methodId: PaymentMethodId with {
      briefly "Method ID"
      described as {
        |Method to set as default.
      }
    }
  } with {
    briefly "Set default method"
    described as {
      |Sets the default payment method.
    }
  }
  command TopUpBalance is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    topUp: TopUpDetails with {
      briefly "Top-up"
      described as {
        |Top-up details.
      }
    }
  } with {
    briefly "Top up balance"
    described as {
      |Adds funds to wallet balance.
    }
  }
  command MakePayment is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    payment: PaymentDetails with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    paymentSourceMethodId: PaymentMethodId? with {
      briefly "Source"
      described as {
        |Payment source.
      }
    }
  } with {
    briefly "Make payment"
    described as {
      |Makes a payment from wallet.
    }
  }
  command TransferFunds is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Sender wallet.
      }
    }
    transfer: TransferDetails with {
      briefly "Transfer"
      described as {
        |Transfer details.
      }
    }
  } with {
    briefly "Transfer funds"
    described as {
      |Sends funds to another wallet.
    }
  }
  command WithdrawFunds is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    withdrawal: WithdrawalDetails with {
      briefly "Withdrawal"
      described as {
        |Withdrawal details.
      }
    }
  } with {
    briefly "Withdraw funds"
    described as {
      |Withdraws funds from wallet.
    }
  }
  command SuspendWallet is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
  } with {
    briefly "Suspend wallet"
    described as {
      |Suspends wallet access.
    }
  }
  command ReactivateWallet is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
  } with {
    briefly "Reactivate wallet"
    described as {
      |Reactivates suspended wallet.
    }
  }
  command ReceiveFunds is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Recipient wallet identifier.
      }
    }
    senderWalletId: WalletId with {
      briefly "Sender"
      described as {
        |Sender wallet.
      }
    }
    amount: Decimal(12,2) with {
      briefly "Amount"
      described as {
        |Received amount.
      }
    }
  } with {
    briefly "Receive funds"
    described as {
      |Receives transferred funds into wallet.
    }
  }
  command CloseWallet is  {
    walletId: WalletId with {
      briefly "Wallet ID"
      described as {
        |Wallet identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
  } with {
    briefly "Close wallet"
    described as {
      |Permanently closes wallet.
    }
  }
  // Events
  event WalletCreated is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    userId: UserId with {
      briefly "User"
      described as {
        |Owner ID.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Primary currency.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Wallet created"
    described as {
      |Emitted when wallet is created.
    }
  }
  event PaymentMethodAdded is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    method: LinkedPaymentMethod with {
      briefly "Method"
      described as {
        |Added method.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Payment method added"
    described as {
      |Emitted when method is linked.
    }
  }
  event PaymentMethodRemoved is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    methodId: PaymentMethodId with {
      briefly "Method"
      described as {
        |Removed method.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Payment method removed"
    described as {
      |Emitted when method is unlinked.
    }
  }
  event DefaultMethodSet is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    methodId: PaymentMethodId with {
      briefly "Method"
      described as {
        |New default.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Default method set"
    described as {
      |Emitted when default changes.
    }
  }
  event BalanceToppedUp is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    topUp: TopUpDetails with {
      briefly "Top-up"
      described as {
        |Top-up details.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    toppedUpAt: TimeStamp with {
      briefly "Topped up"
      described as {
        |Top-up time.
      }
    }
  } with {
    briefly "Balance topped up"
    described as {
      |Emitted when funds are added.
    }
  }
  event PaymentMade is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    payment: PaymentDetails with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    paidAt: TimeStamp with {
      briefly "Paid"
      described as {
        |Payment time.
      }
    }
  } with {
    briefly "Payment made"
    described as {
      |Emitted when payment completes.
    }
  }
  event FundsTransferred is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Sender wallet.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    transfer: TransferDetails with {
      briefly "Transfer"
      described as {
        |Transfer details.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    transferredAt: TimeStamp with {
      briefly "Transferred"
      described as {
        |Transfer time.
      }
    }
  } with {
    briefly "Funds transferred"
    described as {
      |Emitted when transfer completes.
    }
  }
  event FundsReceived is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Recipient wallet.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    senderWalletId: WalletId with {
      briefly "Sender"
      described as {
        |Sender wallet.
      }
    }
    amount: Decimal(12,2) with {
      briefly "Amount"
      described as {
        |Received amount.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Funds received"
    described as {
      |Emitted when transfer is received.
    }
  }
  event FundsWithdrawn is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    transactionId: TransactionId with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    withdrawal: WithdrawalDetails with {
      briefly "Withdrawal"
      described as {
        |Withdrawal details.
      }
    }
    newBalance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Funds withdrawn"
    described as {
      |Emitted when withdrawal completes.
    }
  }
  event WalletSuspended is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Wallet suspended"
    described as {
      |Emitted when wallet is suspended.
    }
  }
  event WalletReactivated is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated"
      described as {
        |Reactivation time.
      }
    }
  } with {
    briefly "Wallet reactivated"
    described as {
      |Emitted when wallet is reactivated.
    }
  }
  event WalletClosed is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Wallet closed"
    described as {
      |Emitted when wallet is closed.
    }
  }
  // State Records
  record ActiveStateData is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    userId: UserId with {
      briefly "User"
      described as {
        |Owner ID.
      }
    }
    balance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Primary currency.
      }
    }
    paymentMethods: LinkedPaymentMethod* with {
      briefly "Methods"
      described as {
        |Linked methods.
      }
    }
    defaultMethodId: PaymentMethodId? with {
      briefly "Default"
      described as {
        |Default method.
      }
    }
    transactions: WalletTransaction* with {
      briefly "Transactions"
      described as {
        |Recent transactions.
      }
    }
    status: WalletStatus with {
      briefly "Status"
      described as {
        |Wallet status.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active wallet.
    }
  }
  record SuspendedStateData is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    userId: UserId with {
      briefly "User"
      described as {
        |Owner ID.
      }
    }
    balance: Decimal(15,2) with {
      briefly "Balance"
      described as {
        |Frozen balance.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Primary currency.
      }
    }
    paymentMethods: LinkedPaymentMethod* with {
      briefly "Methods"
      described as {
        |Linked methods.
      }
    }
    suspensionReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Suspended state data"
    described as {
      |State data for suspended wallet.
    }
  }
  record ClosedStateData is  {
    walletId: WalletId with {
      briefly "Wallet"
      described as {
        |Wallet ID.
      }
    }
    userId: UserId with {
      briefly "User"
      described as {
        |Owner ID.
      }
    }
    closureReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |State data for closed wallet.
    }
  }
  // States
  state ActiveState of type Wallet.ActiveStateData
  state SuspendedState of type Wallet.SuspendedStateData
  state ClosedState of type Wallet.ClosedStateData
  // Handler
  handler WalletHandler is {
    on command CreateWallet is {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command CreateWallet
      tell event WalletCreated to entity WalletContext.Wallet
    }
    on command AddPaymentMethod is {
      tell event PaymentMethodAdded to entity WalletContext.Wallet
    }
    on command RemovePaymentMethod is {
      tell event PaymentMethodRemoved to entity WalletContext.Wallet
    }
    on command SetDefaultMethod is {
      tell event DefaultMethodSet to entity WalletContext.Wallet
    }
    on command TopUpBalance is {
      tell event BalanceToppedUp to entity WalletContext.Wallet
    }
    on command MakePayment is {
      tell event PaymentMade to entity WalletContext.Wallet
    }
    on command TransferFunds is {
      tell event FundsTransferred to entity WalletContext.Wallet
    }
    on command WithdrawFunds is {
      tell event FundsWithdrawn to entity WalletContext.Wallet
    }
    on command SuspendWallet is {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.SuspendedState with command SuspendWallet
      tell event WalletSuspended to entity WalletContext.Wallet
    }
    on command ReactivateWallet is {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command ReactivateWallet
      tell event WalletReactivated to entity WalletContext.Wallet
    }
    on command CloseWallet is {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ClosedState with command CloseWallet
      tell event WalletClosed to entity WalletContext.Wallet
    }
  } with {
    briefly "Processes wallet commands"
    described as {
      | Handles wallet lifecycle including payments,
      | transfers, top-ups, and withdrawals.
    }
  }
} with {
  briefly "Wallet aggregate"
  described as {
    | The Wallet entity manages digital wallet accounts
    | including balance, linked methods, and transactions.
  }
}
