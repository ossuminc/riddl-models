// Digital Wallet - Wallet Entity

entity Wallet is {

  // Commands
  command CreateWallet is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "New wallet identifier."
    }
    userId is UserId with {
      briefly "User ID"
      described by "Wallet owner."
    }
    currency is String(3, 3) with {
      briefly "Currency"
      described by "Primary currency."
    }
  } with {
    briefly "Create wallet"
    described by "Creates a new digital wallet."
  }

  command AddPaymentMethod is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    method is LinkedPaymentMethod with {
      briefly "Method"
      described by "Payment method to add."
    }
  } with {
    briefly "Add payment method"
    described by "Links a payment method to wallet."
  }

  command RemovePaymentMethod is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    methodId is PaymentMethodId with {
      briefly "Method ID"
      described by "Method to remove."
    }
  } with {
    briefly "Remove payment method"
    described by "Unlinks a payment method."
  }

  command SetDefaultMethod is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    methodId is PaymentMethodId with {
      briefly "Method ID"
      described by "Method to set as default."
    }
  } with {
    briefly "Set default method"
    described by "Sets the default payment method."
  }

  command TopUpBalance is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    topUp is TopUpDetails with {
      briefly "Top-up"
      described by "Top-up details."
    }
  } with {
    briefly "Top up balance"
    described by "Adds funds to wallet balance."
  }

  command MakePayment is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    payment is PaymentDetails with {
      briefly "Payment"
      described by "Payment details."
    }
    paymentSourceMethodId is optional PaymentMethodId with {
      briefly "Source"
      described by "Payment source."
    }
  } with {
    briefly "Make payment"
    described by "Makes a payment from wallet."
  }

  command TransferFunds is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Sender wallet."
    }
    transfer is TransferDetails with {
      briefly "Transfer"
      described by "Transfer details."
    }
  } with {
    briefly "Transfer funds"
    described by "Sends funds to another wallet."
  }

  command WithdrawFunds is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    withdrawal is WithdrawalDetails with {
      briefly "Withdrawal"
      described by "Withdrawal details."
    }
  } with {
    briefly "Withdraw funds"
    described by "Withdraws funds from wallet."
  }

  command SuspendWallet is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Suspension reason."
    }
  } with {
    briefly "Suspend wallet"
    described by "Suspends wallet access."
  }

  command ReactivateWallet is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
  } with {
    briefly "Reactivate wallet"
    described by "Reactivates suspended wallet."
  }

  command ReceiveFunds is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Recipient wallet identifier."
    }
    senderWalletId is WalletId with {
      briefly "Sender"
      described by "Sender wallet."
    }
    amount is Decimal(12, 2) with {
      briefly "Amount"
      described by "Received amount."
    }
  } with {
    briefly "Receive funds"
    described by "Receives transferred funds into wallet."
  }

  command CloseWallet is {
    walletId is WalletId with {
      briefly "Wallet ID"
      described by "Wallet identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Closure reason."
    }
  } with {
    briefly "Close wallet"
    described by "Permanently closes wallet."
  }

  // Events
  event WalletCreated is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    userId is UserId with { briefly "User" described by "Owner ID." }
    currency is String(3, 3) with { briefly "Currency" described by "Primary currency." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Wallet created"
    described by "Emitted when wallet is created."
  }

  event PaymentMethodAdded is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    method is LinkedPaymentMethod with { briefly "Method" described by "Added method." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Payment method added"
    described by "Emitted when method is linked."
  }

  event PaymentMethodRemoved is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    methodId is PaymentMethodId with { briefly "Method" described by "Removed method." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Payment method removed"
    described by "Emitted when method is unlinked."
  }

  event DefaultMethodSet is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    methodId is PaymentMethodId with { briefly "Method" described by "New default." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Default method set"
    described by "Emitted when default changes."
  }

  event BalanceToppedUp is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    topUp is TopUpDetails with { briefly "Top-up" described by "Top-up details." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    toppedUpAt is TimeStamp with { briefly "Topped up" described by "Top-up time." }
  } with {
    briefly "Balance topped up"
    described by "Emitted when funds are added."
  }

  event PaymentMade is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    payment is PaymentDetails with { briefly "Payment" described by "Payment details." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    paidAt is TimeStamp with { briefly "Paid" described by "Payment time." }
  } with {
    briefly "Payment made"
    described by "Emitted when payment completes."
  }

  event FundsTransferred is {
    walletId is WalletId with { briefly "Wallet" described by "Sender wallet." }
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    transfer is TransferDetails with { briefly "Transfer" described by "Transfer details." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    transferredAt is TimeStamp with { briefly "Transferred" described by "Transfer time." }
  } with {
    briefly "Funds transferred"
    described by "Emitted when transfer completes."
  }

  event FundsReceived is {
    walletId is WalletId with { briefly "Wallet" described by "Recipient wallet." }
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    senderWalletId is WalletId with { briefly "Sender" described by "Sender wallet." }
    amount is Decimal(12, 2) with { briefly "Amount" described by "Received amount." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Funds received"
    described by "Emitted when transfer is received."
  }

  event FundsWithdrawn is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    transactionId is TransactionId with { briefly "Transaction" described by "Transaction ID." }
    withdrawal is WithdrawalDetails with { briefly "Withdrawal" described by "Withdrawal details." }
    newBalance is Decimal(15, 2) with { briefly "Balance" described by "New balance." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Funds withdrawn"
    described by "Emitted when withdrawal completes."
  }

  event WalletSuspended is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Wallet suspended"
    described by "Emitted when wallet is suspended."
  }

  event WalletReactivated is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Wallet reactivated"
    described by "Emitted when wallet is reactivated."
  }

  event WalletClosed is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Wallet closed"
    described by "Emitted when wallet is closed."
  }

  // State Records
  record ActiveStateData is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    userId is UserId with { briefly "User" described by "Owner ID." }
    balance is Decimal(15, 2) with { briefly "Balance" described by "Current balance." }
    currency is String(3, 3) with { briefly "Currency" described by "Primary currency." }
    paymentMethods is many optional LinkedPaymentMethod with { briefly "Methods" described by "Linked methods." }
    defaultMethodId is optional PaymentMethodId with { briefly "Default" described by "Default method." }
    transactions is many optional WalletTransaction with { briefly "Transactions" described by "Recent transactions." }
    status is WalletStatus with { briefly "Status" described by "Wallet status." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state data"
    described by "State data for active wallet."
  }

  record SuspendedStateData is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    userId is UserId with { briefly "User" described by "Owner ID." }
    balance is Decimal(15, 2) with { briefly "Balance" described by "Frozen balance." }
    currency is String(3, 3) with { briefly "Currency" described by "Primary currency." }
    paymentMethods is many optional LinkedPaymentMethod with { briefly "Methods" described by "Linked methods." }
    suspensionReason is String(1, 200) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Suspended state data"
    described by "State data for suspended wallet."
  }

  record ClosedStateData is {
    walletId is WalletId with { briefly "Wallet" described by "Wallet ID." }
    userId is UserId with { briefly "User" described by "Owner ID." }
    closureReason is String(1, 200) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state data"
    described by "State data for closed wallet."
  }

  // States
  state ActiveState of Wallet.ActiveStateData with {
    briefly "Wallet is active"
    described by "Wallet available for transactions."
  }

  state SuspendedState of Wallet.SuspendedStateData with {
    briefly "Wallet is suspended"
    described by "Wallet temporarily disabled."
  }

  state ClosedState of Wallet.ClosedStateData with {
    briefly "Wallet is closed"
    described by "Wallet permanently closed."
  }

  // Handler
  handler WalletHandler is {
    on command CreateWallet {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command CreateWallet
      tell event WalletCreated to entity WalletContext.Wallet
    }

    on command AddPaymentMethod {
      tell event PaymentMethodAdded to entity WalletContext.Wallet
    }

    on command RemovePaymentMethod {
      tell event PaymentMethodRemoved to entity WalletContext.Wallet
    }

    on command SetDefaultMethod {
      tell event DefaultMethodSet to entity WalletContext.Wallet
    }

    on command TopUpBalance {
      tell event BalanceToppedUp to entity WalletContext.Wallet
    }

    on command MakePayment {
      tell event PaymentMade to entity WalletContext.Wallet
    }

    on command TransferFunds {
      tell event FundsTransferred to entity WalletContext.Wallet
    }

    on command WithdrawFunds {
      tell event FundsWithdrawn to entity WalletContext.Wallet
    }

    on command SuspendWallet {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.SuspendedState with command SuspendWallet
      tell event WalletSuspended to entity WalletContext.Wallet
    }

    on command ReactivateWallet {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ActiveState with command ReactivateWallet
      tell event WalletReactivated to entity WalletContext.Wallet
    }

    on command CloseWallet {
      morph entity WalletContext.Wallet to state WalletContext.Wallet.ClosedState with command CloseWallet
      tell event WalletClosed to entity WalletContext.Wallet
    }
  } with {
    briefly "Processes wallet commands"
    described by {
      | Handles wallet lifecycle including payments,
      | transfers, top-ups, and withdrawals.
    }
  }

} with {
  briefly "Wallet aggregate"
  described by {
    | The Wallet entity manages digital wallet accounts
    | including balance, linked methods, and transactions.
  }
}
