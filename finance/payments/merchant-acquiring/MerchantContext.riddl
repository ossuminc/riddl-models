// Merchant Acquiring - Merchant Context

context MerchantContext is {

  include "types.riddl"
  include "Merchant.riddl"

  // Repository for merchant persistence
  repository MerchantRepository is {
    schema MerchantData is relational
      of merchants as Merchant
      index on field Merchant.merchantId
      index on field Merchant.business.legalName

    handler MerchantPersistence is {
      on event MerchantContext.Merchant.ApplicationSubmitted {
        prompt "Store merchant application"
      }
      on event MerchantContext.Merchant.ApplicationApproved {
        prompt "Update merchant to approved"
      }
      on event MerchantContext.Merchant.ApplicationDeclined {
        prompt "Store decline record"
      }
      on event MerchantContext.Merchant.MerchantActivated {
        prompt "Update merchant to active"
      }
      on event MerchantContext.Merchant.PricingUpdated {
        prompt "Update merchant pricing"
      }
      on event MerchantContext.Merchant.MerchantSuspended {
        prompt "Update merchant to suspended"
      }
      on event MerchantContext.Merchant.MerchantReactivated {
        prompt "Update merchant to active"
      }
      on event MerchantContext.Merchant.MerchantTerminated {
        prompt "Update merchant to terminated"
      }
    } with {
      briefly "Persists merchant events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Merchant data persistence"
    described by {
      | The MerchantRepository provides persistent storage for
      | merchant accounts and underwriting data.
    }
  }

  // Projector for merchant analytics
  projector MerchantAnalytics is {
    updates repository MerchantRepository

    record MerchantStats is {
      totalApplications is Natural with { briefly "Applications" described by "Total applications." }
      approvalRate is Decimal(5, 4) with { briefly "Approval rate" described by "Approval rate." }
      activeMerchants is Natural with { briefly "Active" described by "Active merchants." }
      avgMonthlyVolume is Decimal(15, 2) with { briefly "Avg volume" described by "Average monthly volume." }
      avgRiskScore is Decimal(5, 4) with { briefly "Avg risk" described by "Average risk level." }
      chargebackRate is Decimal(5, 4) with { briefly "Chargeback rate" described by "Portfolio chargeback rate." }
    } with {
      briefly "Merchant statistics"
      described by "Merchant portfolio metrics."
    }

    handler AnalyticsHandler is {
      on event MerchantContext.Merchant.ApplicationSubmitted {
        prompt "Update application counts"
      }
      on event MerchantContext.Merchant.ApplicationApproved {
        prompt "Update approval metrics"
      }
      on event MerchantContext.Merchant.MerchantActivated {
        prompt "Update active merchant count"
      }
      on event MerchantContext.Merchant.MerchantTerminated {
        prompt "Update termination metrics"
      }
    } with {
      briefly "Maintains merchant analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Merchant analytics projections"
    described by "Maintains merchant portfolio analytics data."
  }

} with {
  briefly "Bounded context for merchant acquiring"
  described by {
    | The MerchantContext is the bounded context for merchant
    | onboarding, underwriting, and account management.
  }
}
