// Payment Processing - Payment Entity

entity Payment is {

  // Commands
  command AuthorizePayment is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "New payment identifier."
    }
    info is PaymentInfo with {
      briefly "Info"
      described by "Payment information."
    }
    card is CardDetails with {
      briefly "Card"
      described by "Card details."
    }
  } with {
    briefly "Authorize payment"
    described by "Requests payment authorization."
  }

  command CapturePayment is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Payment to capture."
    }
    amount is optional Decimal(12, 2) with {
      briefly "Amount"
      described by "Capture amount."
    }
  } with {
    briefly "Capture payment"
    described by "Captures authorized payment."
  }

  command VoidPayment is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Payment to void."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Void reason."
    }
  } with {
    briefly "Void payment"
    described by "Voids authorized payment."
  }

  command RefundPayment is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Payment to refund."
    }
    refund is RefundInfo with {
      briefly "Refund"
      described by "Refund details."
    }
  } with {
    briefly "Refund payment"
    described by "Refunds captured payment."
  }

  command SettlePayment is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Payment to settle."
    }
    settlement is SettlementInfo with {
      briefly "Settlement"
      described by "Settlement details."
    }
  } with {
    briefly "Settle payment"
    described by "Settles captured payment."
  }

  command RecordDispute is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Disputed payment."
    }
    dispute is DisputeInfo with {
      briefly "Dispute"
      described by "Dispute details."
    }
  } with {
    briefly "Record dispute"
    described by "Records chargeback dispute."
  }

  command ResolveDispute is {
    paymentId is PaymentId with {
      briefly "Payment ID"
      described by "Payment identifier."
    }
    disputeId is UUID with {
      briefly "Dispute"
      described by "Dispute to resolve."
    }
    resolution is String(1, 200) with {
      briefly "Resolution"
      described by "Dispute resolution."
    }
    wonDispute is Boolean with {
      briefly "Won"
      described by "Dispute won."
    }
  } with {
    briefly "Resolve dispute"
    described by "Resolves chargeback dispute."
  }

  // Events
  event PaymentAuthorized is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    info is PaymentInfo with { briefly "Info" described by "Payment info." }
    card is CardDetails with { briefly "Card" described by "Card used." }
    result is AuthorizationResult with { briefly "Result" described by "Auth result." }
    authorizedAt is TimeStamp with { briefly "Authorized" described by "Auth time." }
  } with {
    briefly "Payment was authorized"
    described by "Emitted when payment is authorized."
  }

  event PaymentDeclined is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    info is PaymentInfo with { briefly "Info" described by "Payment info." }
    result is AuthorizationResult with { briefly "Result" described by "Decline result." }
    declinedAt is TimeStamp with { briefly "Declined" described by "Decline time." }
  } with {
    briefly "Payment was declined"
    described by "Emitted when payment is declined."
  }

  event PaymentCaptured is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    capturedAmount is Decimal(12, 2) with { briefly "Amount" described by "Captured amount." }
    capturedAt is TimeStamp with { briefly "Captured" described by "Capture time." }
  } with {
    briefly "Payment was captured"
    described by "Emitted when payment is captured."
  }

  event PaymentVoided is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "Void time." }
  } with {
    briefly "Payment was voided"
    described by "Emitted when payment is voided."
  }

  event PaymentRefunded is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    refund is RefundInfo with { briefly "Refund" described by "Refund details." }
    refundedAt is TimeStamp with { briefly "Refunded" described by "Refund time." }
  } with {
    briefly "Payment was refunded"
    described by "Emitted when payment is refunded."
  }

  event PaymentSettled is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    settlement is SettlementInfo with { briefly "Settlement" described by "Settlement info." }
    settledAt is TimeStamp with { briefly "Settled" described by "Settlement time." }
  } with {
    briefly "Payment was settled"
    described by "Emitted when payment is settled."
  }

  event DisputeRecorded is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    dispute is DisputeInfo with { briefly "Dispute" described by "Dispute details." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Dispute was recorded"
    described by "Emitted when dispute is filed."
  }

  event DisputeResolved is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    disputeId is UUID with { briefly "Dispute" described by "Dispute ID." }
    resolution is String(1, 200) with { briefly "Resolution" described by "Resolution." }
    wonDispute is Boolean with { briefly "Won" described by "Won dispute." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Dispute was resolved"
    described by "Emitted when dispute is resolved."
  }

  // State Records
  record AuthorizedStateData is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    info is PaymentInfo with { briefly "Info" described by "Payment info." }
    card is CardDetails with { briefly "Card" described by "Card details." }
    status is PaymentStatus with { briefly "Status" described by "Payment status." }
    authResult is AuthorizationResult with { briefly "Auth" described by "Auth result." }
    authorizedAt is TimeStamp with { briefly "Authorized" described by "Auth time." }
  } with {
    briefly "Authorized state data"
    described by "State data for authorized payment."
  }

  record CapturedStateData is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    info is PaymentInfo with { briefly "Info" described by "Payment info." }
    card is CardDetails with { briefly "Card" described by "Card details." }
    status is PaymentStatus with { briefly "Status" described by "Payment status." }
    capturedAmount is Decimal(12, 2) with { briefly "Amount" described by "Captured amount." }
    refunds is many RefundInfo with { briefly "Refunds" described by "Payment refunds." }
    disputes is many DisputeInfo with { briefly "Disputes" described by "Payment disputes." }
    capturedAt is TimeStamp with { briefly "Captured" described by "Capture time." }
  } with {
    briefly "Captured state data"
    described by "State data for captured payment."
  }

  record SettledStateData is {
    paymentId is PaymentId with { briefly "Payment" described by "Payment ID." }
    info is PaymentInfo with { briefly "Info" described by "Payment info." }
    settlement is SettlementInfo with { briefly "Settlement" described by "Settlement info." }
    settledAt is TimeStamp with { briefly "Settled" described by "Settlement time." }
  } with {
    briefly "Settled state data"
    described by "State data for settled payment."
  }

  // States
  state AuthorizedState of Payment.AuthorizedStateData with {
    briefly "Payment is authorized"
    described by "Payment awaits capture."
  }

  state CapturedState of Payment.CapturedStateData with {
    briefly "Payment is captured"
    described by "Payment funds captured."
  }

  state SettledState of Payment.SettledStateData with {
    briefly "Payment is settled"
    described by "Payment is settled."
  }

  // Handler
  handler PaymentHandler is {
    on command AuthorizePayment {
      morph entity PaymentContext.Payment to state PaymentContext.Payment.AuthorizedState with command AuthorizePayment
      tell event PaymentAuthorized to entity PaymentContext.Payment
    }

    on command CapturePayment {
      morph entity PaymentContext.Payment to state PaymentContext.Payment.CapturedState with command CapturePayment
      tell event PaymentCaptured to entity PaymentContext.Payment
    }

    on command VoidPayment {
      tell event PaymentVoided to entity PaymentContext.Payment
    }

    on command RefundPayment {
      tell event PaymentRefunded to entity PaymentContext.Payment
    }

    on command SettlePayment {
      morph entity PaymentContext.Payment to state PaymentContext.Payment.SettledState with command SettlePayment
      tell event PaymentSettled to entity PaymentContext.Payment
    }

    on command RecordDispute {
      tell event DisputeRecorded to entity PaymentContext.Payment
    }

    on command ResolveDispute {
      tell event DisputeResolved to entity PaymentContext.Payment
    }
  } with {
    briefly "Processes payment commands"
    described by {
      | Handles payment lifecycle including authorization,
      | capture, refunds, and disputes.
    }
  }

} with {
  briefly "Payment aggregate"
  described by {
    | The Payment entity manages card transactions including
    | authorization, capture, settlement, and disputes.
  }
}
