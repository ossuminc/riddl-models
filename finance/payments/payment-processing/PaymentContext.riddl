// Payment Processing - Payment Context
context PaymentContext is {
  include "types.riddl"
  include "Payment.riddl"
  // Repository for payment persistence
  repository PaymentRepository is {
    schema PaymentData is relational
      of payments as type Payment
        index on field Payment.paymentId
        index on field Payment.info.merchantId

    handler PaymentPersistence is {
      on command Payment.AuthorizePayment is {
        prompt "Store payment authorization"
      }
      on command Payment.DeclinePayment is {
        prompt "Store decline record"
      }
      on command Payment.CapturePayment is {
        prompt "Update payment to captured"
      }
      on command Payment.VoidPayment is {
        prompt "Update payment to voided"
      }
      on command Payment.RefundPayment is {
        prompt "Store refund record"
      }
      on command Payment.SettlePayment is {
        prompt "Update payment to settled"
      }
      on command Payment.RecordDispute is {
        prompt "Store dispute record"
      }
      on command Payment.ResolveDispute is {
        prompt "Update dispute resolution"
      }
    } with {
      briefly "Persists payment commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Payment data persistence"
    described as {
      | The PaymentRepository provides persistent storage for
      | payment transactions and settlement data.
    }
  }
  // Projector for payment analytics
  projector PaymentAnalytics is {
    record PaymentStats is  {
      merchantId: MerchantId with {
        briefly "Merchant"
        described as {
          |Merchant ID.
        }
      }
      totalTransactions: Natural with {
        briefly "Transactions"
        described as {
          |Total transactions.
        }
      }
      totalVolume: Decimal(15,2) with {
        briefly "Volume"
        described as {
          |Total volume.
        }
      }
      approvalRate: Decimal(5,4) with {
        briefly "Approval"
        described as {
          |Approval rate.
        }
      }
      avgTransactionSize: Decimal(10,2) with {
        briefly "Average"
        described as {
          |Avg transaction.
        }
      }
      chargebackRate: Decimal(5,4) with {
        briefly "Chargeback"
        described as {
          |Chargeback rate.
        }
      }
    } with {
      briefly "Payment statistics"
      described as {
        |Payment processing metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Payment.PaymentAuthorized is {
        prompt "Update transaction counts"
      }
      on event Payment.PaymentCaptured is {
        prompt "Update volume metrics"
      }
      on event Payment.DisputeRecorded is {
        prompt "Update chargeback metrics"
      }
    } with {
      briefly "Maintains payment analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Payment analytics projections"
    described as {
      |Maintains payment processing analytics data.
    }
  }
} with {
  briefly "Bounded context for payments"
  described as {
    | The PaymentContext is the bounded context for card
    | payment processing, settlement, and disputes.
  }
}
