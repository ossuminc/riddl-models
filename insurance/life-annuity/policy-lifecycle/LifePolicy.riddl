// Life Policy Entity - Core aggregate for policy lifecycle management
entity LifePolicy is {
  // Commands
  command IssueLifePolicy is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |Unique identifier for the new policy.
      }
    }
    policyNumber: String(1,20) with {
      briefly "Policy number"
      described as {
        |Human-readable policy number.
      }
    }
    productType: String(1,50) with {
      briefly "Product type"
      described as {
        |Type of life insurance product.
      }
    }
    insuredName: String(1,100) with {
      briefly "Insured name"
      described as {
        |Full name of the insured person.
      }
    }
    insuredDateOfBirth: Date with {
      briefly "Insured date of birth"
      described as {
        |Birth date of the insured.
      }
    }
    faceAmount: Money with {
      briefly "Face amount"
      described as {
        |Death benefit amount.
      }
    }
    premiumAmount: Money with {
      briefly "Premium amount"
      described as {
        |Premium payment per period.
      }
    }
    premiumFrequency: PremiumFrequency with {
      briefly "Premium frequency"
      described as {
        |How often premiums are due.
      }
    }
    ownerName: String(1,100) with {
      briefly "Owner name"
      described as {
        |Name of the policy owner.
      }
    }
    ownerRelationship: String(1,50) with {
      briefly "Owner relationship"
      described as {
        |Owner's relationship to insured.
      }
    }
    underwritingClass: String(1,30) with {
      briefly "Underwriting class"
      described as {
        |Risk classification from underwriting.
      }
    }
  } with {
    briefly "Issue a new life insurance policy"
    described as {
      |Creates a new life insurance policy after underwriting approval.
    }
  }
  command AddBeneficiary is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to add beneficiary to.
      }
    }
    beneficiary: BeneficiaryInfo with {
      briefly "Beneficiary information"
      described as {
        |Complete beneficiary designation details.
      }
    }
  } with {
    briefly "Add or update a beneficiary designation"
    described as {
      |Adds a new beneficiary to the policy.
    }
  }
  command RemoveBeneficiary is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to remove beneficiary from.
      }
    }
    beneficiaryId: BeneficiaryId with {
      briefly "Beneficiary identifier"
      described as {
        |The beneficiary to remove.
      }
    }
  } with {
    briefly "Remove a beneficiary designation"
    described as {
      |Removes a beneficiary from the policy.
    }
  }
  command AddRider is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to add rider to.
      }
    }
    rider: RiderInfo with {
      briefly "Rider information"
      described as {
        |Complete rider details.
      }
    }
  } with {
    briefly "Add an optional rider to the policy"
    described as {
      |Attaches an optional rider to the base policy.
    }
  }
  command RemoveRider is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to remove rider from.
      }
    }
    riderId: RiderId with {
      briefly "Rider identifier"
      described as {
        |The rider to remove.
      }
    }
  } with {
    briefly "Remove a rider from the policy"
    described as {
      |Removes an optional rider from the policy.
    }
  }
  command ProcessPremium is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy receiving payment.
      }
    }
    payment: PremiumPayment with {
      briefly "Payment details"
      described as {
        |Premium payment information.
      }
    }
  } with {
    briefly "Process a premium payment"
    described as {
      |Records a premium payment and updates policy status.
    }
  }
  command RequestLoan is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to borrow against.
      }
    }
    requestedAmount: Money with {
      briefly "Requested amount"
      described as {
        |Amount to borrow.
      }
    }
    disbursementMethod: String(1,30) with {
      briefly "Disbursement method"
      described as {
        |How to disburse the loan funds.
      }
    }
  } with {
    briefly "Request a policy loan"
    described as {
      |Initiates a loan against the policy cash value.
    }
  }
  command RepayLoan is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy with outstanding loan.
      }
    }
    repaymentAmount: Money with {
      briefly "Repayment amount"
      described as {
        |Amount to apply to loan balance.
      }
    }
    paymentMethod: String(1,30) with {
      briefly "Payment method"
      described as {
        |Method of repayment.
      }
    }
  } with {
    briefly "Repay policy loan balance"
    described as {
      |Applies a payment to the outstanding policy loan.
    }
  }
  command SurrenderPolicy is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to surrender.
      }
    }
    surrenderReason: String(1,200) with {
      briefly "Surrender reason"
      described as {
        |Reason for surrendering the policy.
      }
    }
    disbursementMethod: String(1,30) with {
      briefly "Disbursement method"
      described as {
        |How to disburse the surrender value.
      }
    }
  } with {
    briefly "Surrender policy for cash value"
    described as {
      |Terminates the policy and disburses the net cash surrender value.
    }
  }
  command ProcessDeath is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy with death claim.
      }
    }
    claimInfo: DeathClaimInfo with {
      briefly "Claim information"
      described as {
        |Death claim submission details.
      }
    }
  } with {
    briefly "Process a death benefit claim"
    described as {
      |Initiates death benefit claim processing.
    }
  }
  command LapsePolicy is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to lapse.
      }
    }
    lapseDate: Date with {
      briefly "Lapse date"
      described as {
        |Date the policy lapsed.
      }
    }
    reason: String(1,200) with {
      briefly "Lapse reason"
      described as {
        |Reason for the lapse.
      }
    }
  } with {
    briefly "Lapse policy due to non-payment"
    described as {
      |Marks the policy as lapsed when premiums are not received.
    }
  }
  command ReinstatePolicyFromLapse is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy to reinstate.
      }
    }
    backPremiums: Money with {
      briefly "Back premiums"
      described as {
        |Amount of back premiums paid.
      }
    }
    interestDue: Money with {
      briefly "Interest due"
      described as {
        |Interest owed on back premiums.
      }
    }
    reinstateDate: Date with {
      briefly "Reinstate date"
      described as {
        |Date of reinstatement.
      }
    }
  } with {
    briefly "Reinstate a lapsed policy"
    described as {
      |Restores a lapsed policy to active status.
    }
  }
  // Events
  event LifePolicyIssued is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |Identifier of the issued policy.
      }
    }
    policyInfo: LifePolicyInfo with {
      briefly "Policy information"
      described as {
        |Complete policy details.
      }
    }
    issueDate: Date with {
      briefly "Issue date"
      described as {
        |Date the policy was issued.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Date coverage begins.
      }
    }
  } with {
    briefly "Life policy has been issued"
    described as {
      |Records the successful issuance of a new life insurance policy.
    }
  }
  event BeneficiaryAdded is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy affected.
      }
    }
    beneficiary: BeneficiaryInfo with {
      briefly "Beneficiary"
      described as {
        |The added beneficiary.
      }
    }
    addedDate: Date with {
      briefly "Added date"
      described as {
        |Date the beneficiary was added.
      }
    }
  } with {
    briefly "Beneficiary added to policy"
    described as {
      |Records the addition of a new beneficiary designation.
    }
  }
  event BeneficiaryRemoved is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy affected.
      }
    }
    beneficiaryId: BeneficiaryId with {
      briefly "Beneficiary identifier"
      described as {
        |The removed beneficiary.
      }
    }
    removedDate: Date with {
      briefly "Removed date"
      described as {
        |Date the beneficiary was removed.
      }
    }
  } with {
    briefly "Beneficiary removed from policy"
    described as {
      |Records the removal of a beneficiary designation.
    }
  }
  event RiderAdded is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy affected.
      }
    }
    rider: RiderInfo with {
      briefly "Rider"
      described as {
        |The added rider.
      }
    }
    addedDate: Date with {
      briefly "Added date"
      described as {
        |Date the rider was added.
      }
    }
  } with {
    briefly "Rider added to policy"
    described as {
      |Records the addition of an optional rider.
    }
  }
  event RiderRemoved is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy affected.
      }
    }
    riderId: RiderId with {
      briefly "Rider identifier"
      described as {
        |The removed rider.
      }
    }
    removedDate: Date with {
      briefly "Removed date"
      described as {
        |Date the rider was removed.
      }
    }
  } with {
    briefly "Rider removed from policy"
    described as {
      |Records the removal of an optional rider.
    }
  }
  event PremiumProcessed is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy receiving payment.
      }
    }
    payment: PremiumPayment with {
      briefly "Payment"
      described as {
        |The processed payment.
      }
    }
    newPaidToDate: Date with {
      briefly "New paid-to date"
      described as {
        |Updated paid-to date after payment.
      }
    }
  } with {
    briefly "Premium payment processed"
    described as {
      |Records successful processing of a premium payment.
    }
  }
  event LoanDisbursed is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy with loan.
      }
    }
    loanTransaction: LoanTransaction with {
      briefly "Loan transaction"
      described as {
        |Details of the loan disbursement.
      }
    }
    disbursementDate: Date with {
      briefly "Disbursement date"
      described as {
        |Date funds were disbursed.
      }
    }
  } with {
    briefly "Policy loan disbursed"
    described as {
      |Records disbursement of a policy loan.
    }
  }
  event LoanRepaid is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy with loan.
      }
    }
    loanTransaction: LoanTransaction with {
      briefly "Loan transaction"
      described as {
        |Details of the repayment.
      }
    }
    remainingBalance: Money with {
      briefly "Remaining balance"
      described as {
        |Loan balance after repayment.
      }
    }
  } with {
    briefly "Loan repayment applied"
    described as {
      |Records a loan repayment and the remaining balance.
    }
  }
  event PolicySurrendered is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The surrendered policy.
      }
    }
    surrenderDate: Date with {
      briefly "Surrender date"
      described as {
        |Date of surrender.
      }
    }
    surrenderValue: Money with {
      briefly "Surrender value"
      described as {
        |Net value disbursed.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Reason for surrender.
      }
    }
  } with {
    briefly "Policy surrendered"
    described as {
      |Records the surrender of a policy.
    }
  }
  event DeathClaimInitiated is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The policy with claim.
      }
    }
    claimInfo: DeathClaimInfo with {
      briefly "Claim information"
      described as {
        |Death claim details.
      }
    }
    initiatedDate: Date with {
      briefly "Initiated date"
      described as {
        |Date claim was initiated.
      }
    }
  } with {
    briefly "Death claim initiated"
    described as {
      |Records the initiation of a death benefit claim.
    }
  }
  event PolicyLapsed is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The lapsed policy.
      }
    }
    lapseDate: Date with {
      briefly "Lapse date"
      described as {
        |Date of lapse.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Reason for lapse.
      }
    }
    gracePeriodEnd: Date with {
      briefly "Grace period end"
      described as {
        |End of grace period.
      }
    }
  } with {
    briefly "Policy lapsed"
    described as {
      |Records that the policy has lapsed.
    }
  }
  event PolicyReinstated is  {
    policyId: LifePolicyId with {
      briefly "Policy identifier"
      described as {
        |The reinstated policy.
      }
    }
    reinstateDate: Date with {
      briefly "Reinstate date"
      described as {
        |Date of reinstatement.
      }
    }
    premiumsPaid: Money with {
      briefly "Premiums paid"
      described as {
        |Total paid for reinstatement.
      }
    }
  } with {
    briefly "Policy reinstated"
    described as {
      |Records the reinstatement of a lapsed policy.
    }
  }
  // State Records
  record ApplicationStateData is  {
    policyId: LifePolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    applicationDate: Date with {
      briefly "Application date"
      described as {
        |When submitted.
      }
    }
    proposedInfo: LifePolicyInfo with {
      briefly "Proposed info"
      described as {
        |Proposed details.
      }
    }
  } with {
    briefly "Application state data"
    described as {
      |Data for a policy in application stage.
    }
  }
  record ActiveStateData is  {
    policyInfo: LifePolicyInfo with {
      briefly "Policy info"
      described as {
        |Current details.
      }
    }
    beneficiaries: BeneficiaryInfo+ with {
      briefly "Beneficiaries"
      described as {
        |Designations.
      }
    }
    riders: RiderInfo+ with {
      briefly "Riders"
      described as {
        |Active riders.
      }
    }
    cashValue: CashValueInfo with {
      briefly "Cash value"
      described as {
        |Current values.
      }
    }
    paidToDate: Date with {
      briefly "Paid-to date"
      described as {
        |Premiums paid through.
      }
    }
    premiumHistory: PremiumPayment+ with {
      briefly "Premiums"
      described as {
        |Payment history.
      }
    }
    loanHistory: LoanTransaction+ with {
      briefly "Loans"
      described as {
        |Loan history.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |Data for an active policy in force.
    }
  }
  record LapsedStateData is  {
    policyInfo: LifePolicyInfo with {
      briefly "Policy info"
      described as {
        |Policy details.
      }
    }
    beneficiaries: BeneficiaryInfo+ with {
      briefly "Beneficiaries"
      described as {
        |Designations.
      }
    }
    riders: RiderInfo+ with {
      briefly "Riders"
      described as {
        |Policy riders.
      }
    }
    cashValue: CashValueInfo with {
      briefly "Cash value"
      described as {
        |Cash value at lapse.
      }
    }
    lapseDate: Date with {
      briefly "Lapse date"
      described as {
        |When lapsed.
      }
    }
    reinstatementDeadline: Date with {
      briefly "Deadline"
      described as {
        |Reinstatement deadline.
      }
    }
  } with {
    briefly "Lapsed state data"
    described as {
      |Data for a lapsed policy.
    }
  }
  record SurrenderedStateData is  {
    policyInfo: LifePolicyInfo with {
      briefly "Policy info"
      described as {
        |Policy details.
      }
    }
    surrenderDate: Date with {
      briefly "Surrender date"
      described as {
        |When surrendered.
      }
    }
    surrenderValue: Money with {
      briefly "Surrender value"
      described as {
        |Value disbursed.
      }
    }
    finalDisbursement: Money with {
      briefly "Final amount"
      described as {
        |Final disbursement.
      }
    }
  } with {
    briefly "Surrendered state data"
    described as {
      |Data for a surrendered policy.
    }
  }
  record DeathClaimStateData is  {
    policyInfo: LifePolicyInfo with {
      briefly "Policy info"
      described as {
        |Policy details.
      }
    }
    beneficiaries: BeneficiaryInfo+ with {
      briefly "Beneficiaries"
      described as {
        |Recipients.
      }
    }
    riders: RiderInfo+ with {
      briefly "Riders"
      described as {
        |Benefit riders.
      }
    }
    claimInfo: DeathClaimInfo with {
      briefly "Claim info"
      described as {
        |Claim details.
      }
    }
    totalBenefitCalculated: Money with {
      briefly "Total benefit"
      described as {
        |Calculated benefit.
      }
    }
  } with {
    briefly "Death claim state data"
    described as {
      |Data for a policy with pending death claim.
    }
  }
  record TerminatedStateData is  {
    policyInfo: LifePolicyInfo with {
      briefly "Policy info"
      described as {
        |Final details.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |When terminated.
      }
    }
    terminationReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    finalSettlement: Money with {
      briefly "Settlement"
      described as {
        |Final settlement.
      }
    }
  } with {
    briefly "Terminated state data"
    described as {
      |Data for a terminated policy.
    }
  }
  // States
  state ApplicationState of type LifePolicy.ApplicationStateData
  state ActiveState of type LifePolicy.ActiveStateData
  state LapsedState of type LifePolicy.LapsedStateData
  state SurrenderedState of type LifePolicy.SurrenderedStateData
  state DeathClaimState of type LifePolicy.DeathClaimStateData
  state TerminatedState of type LifePolicy.TerminatedStateData
  // Handler
  handler LifePolicyHandler is {
    on command IssueLifePolicy is {
      morph entity LifePolicy to state LifePolicy.ActiveState with command IssueLifePolicy
      tell event LifePolicyIssued to entity LifePolicy
    }
    on command AddBeneficiary is {
      tell event BeneficiaryAdded to entity LifePolicy
    }
    on command RemoveBeneficiary is {
      tell event BeneficiaryRemoved to entity LifePolicy
    }
    on command AddRider is {
      tell event RiderAdded to entity LifePolicy
    }
    on command RemoveRider is {
      tell event RiderRemoved to entity LifePolicy
    }
    on command ProcessPremium is {
      tell event PremiumProcessed to entity LifePolicy
    }
    on command RequestLoan is {
      tell event LoanDisbursed to entity LifePolicy
    }
    on command RepayLoan is {
      tell event LoanRepaid to entity LifePolicy
    }
    on command SurrenderPolicy is {
      morph entity LifePolicy to state LifePolicy.SurrenderedState with command SurrenderPolicy
      tell event PolicySurrendered to entity LifePolicy
    }
    on command ProcessDeath is {
      morph entity LifePolicy to state LifePolicy.DeathClaimState with command ProcessDeath
      tell event DeathClaimInitiated to entity LifePolicy
    }
    on command LapsePolicy is {
      morph entity LifePolicy to state LifePolicy.LapsedState with command LapsePolicy
      tell event PolicyLapsed to entity LifePolicy
    }
    on command ReinstatePolicyFromLapse is {
      morph entity LifePolicy to state LifePolicy.ActiveState with command ReinstatePolicyFromLapse
      tell event PolicyReinstated to entity LifePolicy
    }
  } with {
    briefly "Primary command handler for life policy"
    described as {
      |Handles all commands for life policy lifecycle management.
    }
  }
} with {
  briefly "Life insurance policy aggregate"
  described as {
    | The LifePolicy entity is the central aggregate for managing the complete
    | lifecycle of a life insurance policy from issuance through termination.
  }
}
