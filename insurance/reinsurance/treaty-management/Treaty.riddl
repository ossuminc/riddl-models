// Treaty Entity
// Core entity managing reinsurance treaty lifecycle

entity Treaty is {

  // Commands

  command NegotiateTreaty is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company identifier." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer identifier." }
    proposedTerms is TreatyTerms with { briefly "Terms" described by "Proposed treaty terms." }
    commissionTerms is CommissionInfo with { briefly "Commission" described by "Commission structure." }
    negotiatorId is String(1, 100) with { briefly "Negotiator" described by "Person initiating negotiation." }
  } with {
    briefly "Initiate treaty negotiation with proposed terms"
    described by {
      | Starts the treaty negotiation process by capturing
      | proposed terms from either party.
    }
  }

  command ExecuteTreaty is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    finalTerms is TreatyTerms with { briefly "Terms" described by "Final agreed terms." }
    finalCommission is CommissionInfo with { briefly "Commission" described by "Final commission structure." }
    executionDate is Date with { briefly "Execution date" described by "Date of execution." }
    signatories is many String(1, 100) with { briefly "Signatories" described by "Parties signing." }
  } with {
    briefly "Execute the treaty after successful negotiation"
    described by "Finalizes the treaty with agreed terms."
  }

  command RecordCession is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    cession is CessionInfo with { briefly "Cession" described by "Cession details." }
  } with {
    briefly "Record a risk cession under the treaty"
    described by "Records an individual risk transfer under the treaty."
  }

  command SubmitBordereau is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    bordereau is BordereauSubmission with { briefly "Bordereau" described by "Bordereau data." }
  } with {
    briefly "Submit bordereau report for the treaty"
    described by "Accepts a bordereau submission from the ceding company."
  }

  command ProcessSettlement is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    settlementPeriodStart is Date with { briefly "Start" described by "Settlement period start." }
    settlementPeriodEnd is Date with { briefly "End" described by "Settlement period end." }
  } with {
    briefly "Calculate and process settlement for a period"
    described by "Calculates the net settlement between parties."
  }

  command RenewTreaty is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    renewalTerms is RenewalTerms with { briefly "Terms" described by "Renewal terms." }
    newCoveragePeriod is DateRange with { briefly "Period" described by "New coverage period." }
  } with {
    briefly "Renew the treaty for a new period"
    described by "Initiates renewal of an expiring treaty."
  }

  command SuspendTreaty is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    suspensionDate is Date with { briefly "Date" described by "Suspension effective date." }
  } with {
    briefly "Suspend treaty operations temporarily"
    described by "Temporarily suspends treaty operations."
  }

  command TerminateTreaty is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    terminationDate is Date with { briefly "Date" described by "Termination date." }
    reason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    runoffTerms is optional String(1, 1000) with { briefly "Runoff" described by "Runoff terms." }
  } with {
    briefly "Terminate the treaty before natural expiration"
    described by "Ends the treaty prior to scheduled expiration."
  }

  // Events

  event TreatyNegotiationStarted is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    proposedTerms is TreatyTerms with { briefly "Terms" described by "Proposed terms." }
    commissionTerms is CommissionInfo with { briefly "Commission" described by "Commission terms." }
    negotiatorId is String(1, 100) with { briefly "Negotiator" described by "Initiating party." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty negotiation has been initiated"
    described by "Records the start of treaty negotiations."
  }

  event TreatyExecuted is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    finalTerms is TreatyTerms with { briefly "Terms" described by "Final terms." }
    finalCommission is CommissionInfo with { briefly "Commission" described by "Commission terms." }
    executionDate is Date with { briefly "Execution date" described by "Date executed." }
    signatories is many String(1, 100) with { briefly "Signatories" described by "Parties." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty has been executed by all parties"
    described by "Confirms that the treaty has been signed."
  }

  event CessionRecorded is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    cession is CessionInfo with { briefly "Cession" described by "Cession details." }
    remainingCapacity is optional MonetaryAmount with { briefly "Capacity" described by "Remaining capacity." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Risk cession has been recorded under treaty"
    described by "Confirms acceptance of a cession."
  }

  event BordereauReceived is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    bordereauxId is BordereauId with { briefly "Bordereau ID" described by "Bordereau identifier." }
    bordereauxType is BordereauType with { briefly "Type" described by "Bordereau type." }
    recordCount is Integer with { briefly "Records" described by "Number of records." }
    periodStart is Date with { briefly "Start" described by "Period start." }
    periodEnd is Date with { briefly "End" described by "Period end." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Bordereau submission has been received"
    described by "Acknowledges receipt of bordereau data."
  }

  event SettlementProcessed is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    settlement is SettlementInfo with { briefly "Settlement" described by "Settlement details." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Settlement has been calculated for a period"
    described by "Records the completed settlement calculation."
  }

  event TreatyRenewed is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Original treaty identifier." }
    newTreatyId is TreatyId with { briefly "New treaty ID" described by "Renewal treaty identifier." }
    renewalTerms is RenewalTerms with { briefly "Terms" described by "Renewal terms." }
    newCoveragePeriod is DateRange with { briefly "Period" described by "New coverage period." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty has been renewed for a new period"
    described by "Confirms treaty renewal."
  }

  event TreatySuspended is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    suspensionDate is Date with { briefly "Date" described by "Suspension date." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty has been suspended"
    described by "Records the suspension of treaty operations."
  }

  event TreatyTerminated is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    terminationDate is Date with { briefly "Date" described by "Termination date." }
    reason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    runoffTerms is optional String(1, 1000) with { briefly "Runoff" described by "Runoff terms." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty has been terminated"
    described by "Records treaty termination."
  }

  event TreatyExpired is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "The treaty identifier." }
    expirationDate is Date with { briefly "Expiration" described by "Expiration date." }
    finalSettlementDue is Date with { briefly "Settlement due" described by "Final settlement due date." }
    timestamp is TimeStamp with { briefly "Timestamp" described by "Event time." }
  } with {
    briefly "Treaty has reached natural expiration"
    described by "Records that a treaty has expired."
  }

  // State Records

  record DraftData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    createdDate is Date with { briefly "Created" described by "Creation date." }
  } with {
    briefly "Draft treaty data"
    described by "Data for a treaty in draft state."
  }

  record NegotiatingData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    proposedTerms is TreatyTerms with { briefly "Terms" described by "Proposed terms." }
    commissionTerms is CommissionInfo with { briefly "Commission" described by "Commission terms." }
    negotiationStartDate is Date with { briefly "Started" described by "Negotiation start." }
    counterOffers is Integer with { briefly "Counters" described by "Number of counter-offers." }
  } with {
    briefly "Negotiating treaty data"
    described by "Data for a treaty under negotiation."
  }

  record ExecutedData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    terms is TreatyTerms with { briefly "Terms" described by "Agreed terms." }
    commission is CommissionInfo with { briefly "Commission" described by "Commission structure." }
    executionDate is Date with { briefly "Executed" described by "Execution date." }
    signatories is many String(1, 100) with { briefly "Signatories" described by "Signing parties." }
  } with {
    briefly "Executed treaty data"
    described by "Data for an executed treaty awaiting effective date."
  }

  record ActiveData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    terms is TreatyTerms with { briefly "Terms" described by "Treaty terms." }
    commission is CommissionInfo with { briefly "Commission" described by "Commission structure." }
    executionDate is Date with { briefly "Executed" described by "Execution date." }
    cessions is many CessionInfo with { briefly "Cessions" described by "Recorded cessions." }
    bordereaux is many BordereauSubmission with { briefly "Bordereaux" described by "Submitted bordereaux." }
    settlements is many SettlementInfo with { briefly "Settlements" described by "Processed settlements." }
    totalCededPremium is MonetaryAmount with { briefly "Total premium" described by "Cumulative ceded premium." }
    totalPaidLosses is MonetaryAmount with { briefly "Total losses" described by "Cumulative paid losses." }
    utilizationPercentage is Percentage with { briefly "Utilization" described by "Capacity utilization." }
  } with {
    briefly "Active treaty data"
    described by "Data for an active treaty accepting cessions."
  }

  record SuspendedData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    terms is TreatyTerms with { briefly "Terms" described by "Treaty terms." }
    suspensionDate is Date with { briefly "Suspended" described by "Suspension date." }
    suspensionReason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    priorState is String(1, 50) with { briefly "Prior state" described by "State before suspension." }
  } with {
    briefly "Suspended treaty data"
    described by "Data for a suspended treaty."
  }

  record ExpiredData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    terms is TreatyTerms with { briefly "Terms" described by "Treaty terms." }
    expirationDate is Date with { briefly "Expired" described by "Expiration date." }
    totalCessions is Integer with { briefly "Cessions" described by "Total cession count." }
    totalCededPremium is MonetaryAmount with { briefly "Premium" described by "Total ceded premium." }
    totalPaidLosses is MonetaryAmount with { briefly "Losses" described by "Total paid losses." }
    outstandingReserves is MonetaryAmount with { briefly "Reserves" described by "Outstanding reserves." }
    renewedToTreatyId is optional TreatyId with { briefly "Renewed to" described by "Renewal treaty ID." }
  } with {
    briefly "Expired treaty data"
    described by "Data for an expired treaty."
  }

  record TerminatedData is {
    treatyId is TreatyId with { briefly "Treaty ID" described by "Treaty identifier." }
    cedingCompanyId is String(1, 100) with { briefly "Cedent" described by "Ceding company." }
    reinsurerId is String(1, 100) with { briefly "Reinsurer" described by "Reinsurer." }
    terminationDate is Date with { briefly "Terminated" described by "Termination date." }
    terminationReason is String(1, 500) with { briefly "Reason" described by "Termination reason." }
    runoffTerms is optional String(1, 1000) with { briefly "Runoff" described by "Runoff terms." }
    outstandingObligations is MonetaryAmount with { briefly "Obligations" described by "Outstanding obligations." }
  } with {
    briefly "Terminated treaty data"
    described by "Data for a terminated treaty."
  }

  // States

  state DraftState of Treaty.DraftData with {
    briefly "Initial draft state before negotiation"
    described by "The treaty exists as a draft placeholder."
  }

  state NegotiatingState of Treaty.NegotiatingData with {
    briefly "Treaty is under active negotiation"
    described by "Terms are being negotiated between parties."
  }

  state ExecutedState of Treaty.ExecutedData with {
    briefly "Treaty has been executed awaiting effective date"
    described by "Treaty is signed but not yet active."
  }

  state ActiveState of Treaty.ActiveData with {
    briefly "Treaty is active and accepting cessions"
    described by "The treaty is in force during its coverage period."
  }

  state SuspendedState of Treaty.SuspendedData with {
    briefly "Treaty operations are temporarily suspended"
    described by "Treaty is suspended pending resolution of issues."
  }

  state ExpiredState of Treaty.ExpiredData with {
    briefly "Treaty has expired at end of coverage period"
    described by "Treaty has reached natural expiration."
  }

  state TerminatedState of Treaty.TerminatedData with {
    briefly "Treaty has been terminated early"
    described by "Treaty was terminated before natural expiration."
  }

  // Handler

  handler TreatyHandler is {
    on command NegotiateTreaty {
      morph entity Treaty to state Treaty.NegotiatingState with command NegotiateTreaty
      tell event TreatyNegotiationStarted to entity Treaty
    }

    on command ExecuteTreaty {
      morph entity Treaty to state Treaty.ExecutedState with command ExecuteTreaty
      tell event TreatyExecuted to entity Treaty
    }

    on command RecordCession {
      tell event CessionRecorded to entity Treaty
    }

    on command SubmitBordereau {
      tell event BordereauReceived to entity Treaty
    }

    on command ProcessSettlement {
      tell event SettlementProcessed to entity Treaty
    }

    on command RenewTreaty {
      morph entity Treaty to state Treaty.ExpiredState with command RenewTreaty
      tell event TreatyRenewed to entity Treaty
    }

    on command SuspendTreaty {
      morph entity Treaty to state Treaty.SuspendedState with command SuspendTreaty
      tell event TreatySuspended to entity Treaty
    }

    on command TerminateTreaty {
      morph entity Treaty to state Treaty.TerminatedState with command TerminateTreaty
      tell event TreatyTerminated to entity Treaty
    }
  } with {
    briefly "Processes treaty lifecycle commands"
    described by {
      | Handles all commands related to treaty state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }

} with {
  option aggregate
  briefly "The treaty aggregate managing reinsurance treaty lifecycle"
  described by {
    | The Treaty entity is the core aggregate managing the complete
    | lifecycle of a reinsurance treaty. It handles negotiation,
    | execution, cession recording, bordereau processing, settlement,
    | and termination or renewal.
  }
}
