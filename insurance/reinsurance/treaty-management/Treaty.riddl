// Treaty Entity
// Core entity managing reinsurance treaty lifecycle
entity Treaty is {
  // Commands
  command NegotiateTreaty is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company identifier.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer identifier.
      }
    }
    proposedTerms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Proposed treaty terms.
      }
    }
    commissionTerms: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission structure.
      }
    }
    negotiatorId: String(1,100) with {
      briefly "Negotiator"
      described as {
        |Person initiating negotiation.
      }
    }
  } with {
    briefly "Initiate treaty negotiation with proposed terms"
    described as {
      | Starts the treaty negotiation process by capturing
      | proposed terms from either party.
    }
  }
  command ExecuteTreaty is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    finalTerms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Final agreed terms.
      }
    }
    finalCommission: CommissionInfo with {
      briefly "Commission"
      described as {
        |Final commission structure.
      }
    }
    executionDate: Date with {
      briefly "Execution date"
      described as {
        |Date of execution.
      }
    }
    signatories: String(1,100)+ with {
      briefly "Signatories"
      described as {
        |Parties signing.
      }
    }
  } with {
    briefly "Execute the treaty after successful negotiation"
    described as {
      |Finalizes the treaty with agreed terms.
    }
  }
  command RecordCession is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    cession: CessionInfo with {
      briefly "Cession"
      described as {
        |Cession details.
      }
    }
  } with {
    briefly "Record a risk cession under the treaty"
    described as {
      |Records an individual risk transfer under the treaty.
    }
  }
  command SubmitBordereau is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    bordereau: BordereauSubmission with {
      briefly "Bordereau"
      described as {
        |Bordereau data.
      }
    }
  } with {
    briefly "Submit bordereau report for the treaty"
    described as {
      |Accepts a bordereau submission from the ceding company.
    }
  }
  command ProcessSettlement is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    settlementPeriodStart: Date with {
      briefly "Start"
      described as {
        |Settlement period start.
      }
    }
    settlementPeriodEnd: Date with {
      briefly "End"
      described as {
        |Settlement period end.
      }
    }
  } with {
    briefly "Calculate and process settlement for a period"
    described as {
      |Calculates the net settlement between parties.
    }
  }
  command RenewTreaty is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    renewalTerms: RenewalTerms with {
      briefly "Terms"
      described as {
        |Renewal terms.
      }
    }
    newCoveragePeriod: DateRange with {
      briefly "Period"
      described as {
        |New coverage period.
      }
    }
  } with {
    briefly "Renew the treaty for a new period"
    described as {
      |Initiates renewal of an expiring treaty.
    }
  }
  command SuspendTreaty is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspensionDate: Date with {
      briefly "Date"
      described as {
        |Suspension effective date.
      }
    }
  } with {
    briefly "Suspend treaty operations temporarily"
    described as {
      |Temporarily suspends treaty operations.
    }
  }
  command TerminateTreaty is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    terminationDate: Date with {
      briefly "Date"
      described as {
        |Termination date.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    runoffTerms: String(1,1000)? with {
      briefly "Runoff"
      described as {
        |Runoff terms.
      }
    }
  } with {
    briefly "Terminate the treaty before natural expiration"
    described as {
      |Ends the treaty prior to scheduled expiration.
    }
  }
  // Events
  event TreatyNegotiationStarted is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    proposedTerms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Proposed terms.
      }
    }
    commissionTerms: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission terms.
      }
    }
    negotiatorId: String(1,100) with {
      briefly "Negotiator"
      described as {
        |Initiating party.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty negotiation has been initiated"
    described as {
      |Records the start of treaty negotiations.
    }
  }
  event TreatyExecuted is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    finalTerms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Final terms.
      }
    }
    finalCommission: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission terms.
      }
    }
    executionDate: Date with {
      briefly "Execution date"
      described as {
        |Date executed.
      }
    }
    signatories: String(1,100)+ with {
      briefly "Signatories"
      described as {
        |Parties.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty has been executed by all parties"
    described as {
      |Confirms that the treaty has been signed.
    }
  }
  event CessionRecorded is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    cession: CessionInfo with {
      briefly "Cession"
      described as {
        |Cession details.
      }
    }
    remainingCapacity: MonetaryAmount? with {
      briefly "Capacity"
      described as {
        |Remaining capacity.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Risk cession has been recorded under treaty"
    described as {
      |Confirms acceptance of a cession.
    }
  }
  event BordereauReceived is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    bordereauxId: BordereauId with {
      briefly "Bordereau ID"
      described as {
        |Bordereau identifier.
      }
    }
    bordereauxType: BordereauType with {
      briefly "Type"
      described as {
        |Bordereau type.
      }
    }
    recordCount: Integer with {
      briefly "Records"
      described as {
        |Number of records.
      }
    }
    periodStart: Date with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    periodEnd: Date with {
      briefly "End"
      described as {
        |Period end.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Bordereau submission has been received"
    described as {
      |Acknowledges receipt of bordereau data.
    }
  }
  event SettlementProcessed is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    settlement: SettlementInfo with {
      briefly "Settlement"
      described as {
        |Settlement details.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Settlement has been calculated for a period"
    described as {
      |Records the completed settlement calculation.
    }
  }
  event TreatyRenewed is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Original treaty identifier.
      }
    }
    newTreatyId: TreatyId with {
      briefly "New treaty ID"
      described as {
        |Renewal treaty identifier.
      }
    }
    renewalTerms: RenewalTerms with {
      briefly "Terms"
      described as {
        |Renewal terms.
      }
    }
    newCoveragePeriod: DateRange with {
      briefly "Period"
      described as {
        |New coverage period.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty has been renewed for a new period"
    described as {
      |Confirms treaty renewal.
    }
  }
  event TreatySuspended is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspensionDate: Date with {
      briefly "Date"
      described as {
        |Suspension date.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty has been suspended"
    described as {
      |Records the suspension of treaty operations.
    }
  }
  event TreatyTerminated is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    terminationDate: Date with {
      briefly "Date"
      described as {
        |Termination date.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    runoffTerms: String(1,1000)? with {
      briefly "Runoff"
      described as {
        |Runoff terms.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty has been terminated"
    described as {
      |Records treaty termination.
    }
  }
  event TreatyExpired is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |The treaty identifier.
      }
    }
    expirationDate: Date with {
      briefly "Expiration"
      described as {
        |Expiration date.
      }
    }
    finalSettlementDue: Date with {
      briefly "Settlement due"
      described as {
        |Final settlement due date.
      }
    }
    timestamp: TimeStamp with {
      briefly "Timestamp"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Treaty has reached natural expiration"
    described as {
      |Records that a treaty has expired.
    }
  }
  // State Records
  record DraftData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    createdDate: Date with {
      briefly "Created"
      described as {
        |Creation date.
      }
    }
  } with {
    briefly "Draft treaty data"
    described as {
      |Data for a treaty in draft state.
    }
  }
  record NegotiatingData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    proposedTerms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Proposed terms.
      }
    }
    commissionTerms: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission terms.
      }
    }
    negotiationStartDate: Date with {
      briefly "Started"
      described as {
        |Negotiation start.
      }
    }
    counterOffers: Integer with {
      briefly "Counters"
      described as {
        |Number of counter-offers.
      }
    }
  } with {
    briefly "Negotiating treaty data"
    described as {
      |Data for a treaty under negotiation.
    }
  }
  record ExecutedData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    terms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Agreed terms.
      }
    }
    commission: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission structure.
      }
    }
    executionDate: Date with {
      briefly "Executed"
      described as {
        |Execution date.
      }
    }
    signatories: String(1,100)+ with {
      briefly "Signatories"
      described as {
        |Signing parties.
      }
    }
  } with {
    briefly "Executed treaty data"
    described as {
      |Data for an executed treaty awaiting effective date.
    }
  }
  record ActiveData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    terms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Treaty terms.
      }
    }
    commission: CommissionInfo with {
      briefly "Commission"
      described as {
        |Commission structure.
      }
    }
    executionDate: Date with {
      briefly "Executed"
      described as {
        |Execution date.
      }
    }
    cessions: CessionInfo+ with {
      briefly "Cessions"
      described as {
        |Recorded cessions.
      }
    }
    bordereaux: BordereauSubmission+ with {
      briefly "Bordereaux"
      described as {
        |Submitted bordereaux.
      }
    }
    settlements: SettlementInfo+ with {
      briefly "Settlements"
      described as {
        |Processed settlements.
      }
    }
    totalCededPremium: MonetaryAmount with {
      briefly "Total premium"
      described as {
        |Cumulative ceded premium.
      }
    }
    totalPaidLosses: MonetaryAmount with {
      briefly "Total losses"
      described as {
        |Cumulative paid losses.
      }
    }
    utilizationPercentage: Percentage with {
      briefly "Utilization"
      described as {
        |Capacity utilization.
      }
    }
  } with {
    briefly "Active treaty data"
    described as {
      |Data for an active treaty accepting cessions.
    }
  }
  record SuspendedData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    terms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Treaty terms.
      }
    }
    suspensionDate: Date with {
      briefly "Suspended"
      described as {
        |Suspension date.
      }
    }
    suspensionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    priorState: String(1,50) with {
      briefly "Prior state"
      described as {
        |State before suspension.
      }
    }
  } with {
    briefly "Suspended treaty data"
    described as {
      |Data for a suspended treaty.
    }
  }
  record ExpiredData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    terms: TreatyTerms with {
      briefly "Terms"
      described as {
        |Treaty terms.
      }
    }
    expirationDate: Date with {
      briefly "Expired"
      described as {
        |Expiration date.
      }
    }
    totalCessions: Integer with {
      briefly "Cessions"
      described as {
        |Total cession count.
      }
    }
    totalCededPremium: MonetaryAmount with {
      briefly "Premium"
      described as {
        |Total ceded premium.
      }
    }
    totalPaidLosses: MonetaryAmount with {
      briefly "Losses"
      described as {
        |Total paid losses.
      }
    }
    outstandingReserves: MonetaryAmount with {
      briefly "Reserves"
      described as {
        |Outstanding reserves.
      }
    }
    renewedToTreatyId: TreatyId? with {
      briefly "Renewed to"
      described as {
        |Renewal treaty ID.
      }
    }
  } with {
    briefly "Expired treaty data"
    described as {
      |Data for an expired treaty.
    }
  }
  record TerminatedData is  {
    treatyId: TreatyId with {
      briefly "Treaty ID"
      described as {
        |Treaty identifier.
      }
    }
    cedingCompanyId: String(1,100) with {
      briefly "Cedent"
      described as {
        |Ceding company.
      }
    }
    reinsurerId: String(1,100) with {
      briefly "Reinsurer"
      described as {
        |Reinsurer.
      }
    }
    terminationDate: Date with {
      briefly "Terminated"
      described as {
        |Termination date.
      }
    }
    terminationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    runoffTerms: String(1,1000)? with {
      briefly "Runoff"
      described as {
        |Runoff terms.
      }
    }
    outstandingObligations: MonetaryAmount with {
      briefly "Obligations"
      described as {
        |Outstanding obligations.
      }
    }
  } with {
    briefly "Terminated treaty data"
    described as {
      |Data for a terminated treaty.
    }
  }
  // States
  state DraftState of type Treaty.DraftData
  state NegotiatingState of type Treaty.NegotiatingData
  state ExecutedState of type Treaty.ExecutedData
  state ActiveState of type Treaty.ActiveData
  state SuspendedState of type Treaty.SuspendedData
  state ExpiredState of type Treaty.ExpiredData
  state TerminatedState of type Treaty.TerminatedData
  // Handler
  handler TreatyHandler is {
    on command NegotiateTreaty is {
      morph entity Treaty to state Treaty.NegotiatingState with command NegotiateTreaty
      tell event TreatyNegotiationStarted to entity Treaty
    }
    on command ExecuteTreaty is {
      morph entity Treaty to state Treaty.ExecutedState with command ExecuteTreaty
      tell event TreatyExecuted to entity Treaty
    }
    on command RecordCession is {
      tell event CessionRecorded to entity Treaty
    }
    on command SubmitBordereau is {
      tell event BordereauReceived to entity Treaty
    }
    on command ProcessSettlement is {
      tell event SettlementProcessed to entity Treaty
    }
    on command RenewTreaty is {
      morph entity Treaty to state Treaty.ExpiredState with command RenewTreaty
      tell event TreatyRenewed to entity Treaty
    }
    on command SuspendTreaty is {
      morph entity Treaty to state Treaty.SuspendedState with command SuspendTreaty
      tell event TreatySuspended to entity Treaty
    }
    on command TerminateTreaty is {
      morph entity Treaty to state Treaty.TerminatedState with command TerminateTreaty
      tell event TreatyTerminated to entity Treaty
    }
  } with {
    briefly "Processes treaty lifecycle commands"
    described as {
      | Handles all commands related to treaty state transitions.
      | Validates state transitions and emits appropriate events.
    }
  }
} with {
  option aggregate()
  briefly "The treaty aggregate managing reinsurance treaty lifecycle"
  described as {
    | The Treaty entity is the core aggregate managing the complete
    | lifecycle of a reinsurance treaty. It handles negotiation,
    | execution, cession recording, bordereau processing, settlement,
    | and termination or renewal.
  }
}
