// Policy Management - Policy Entity
entity Policy is {
  // Commands
  command IssuePolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |New policy identifier.
      }
    }
    policyholder: PolicyholderInfo with {
      briefly "Policyholder"
      described as {
        |Policyholder information.
      }
    }
    policyType: PolicyType with {
      briefly "Type"
      described as {
        |Policy type.
      }
    }
    property: InsuredProperty with {
      briefly "Property"
      described as {
        |Insured property.
      }
    }
    coverages: CoverageInfo+ with {
      briefly "Coverages"
      described as {
        |Policy coverages.
      }
    }
    period: PolicyPeriod with {
      briefly "Period"
      described as {
        |Policy period.
      }
    }
    premium: PremiumInfo with {
      briefly "Premium"
      described as {
        |Premium details.
      }
    }
  } with {
    briefly "Issue policy"
    described as {
      |Issues a new policy.
    }
  }
  command BindPolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    paymentFrequency: PaymentFrequency with {
      briefly "Payment frequency"
      described as {
        |How premiums are paid.
      }
    }
  } with {
    briefly "Bind policy"
    described as {
      |Binds coverage to the policy.
    }
  }
  command AddEndorsement is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    endorsement: EndorsementInfo with {
      briefly "Endorsement"
      described as {
        |Endorsement details.
      }
    }
  } with {
    briefly "Add endorsement"
    described as {
      |Adds policy endorsement.
    }
  }
  command ProcessRenewal is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    renewal: RenewalInfo with {
      briefly "Renewal"
      described as {
        |Renewal details.
      }
    }
  } with {
    briefly "Process renewal"
    described as {
      |Processes policy renewal.
    }
  }
  command AcceptRenewal is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
  } with {
    briefly "Accept renewal"
    described as {
      |Accepts renewal offer.
    }
  }
  command SuspendPolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    suspensionReason: String(1,500) with {
      briefly "Suspension Reason"
      described as {
        |Suspension reason.
      }
    }
  } with {
    briefly "Suspend policy"
    described as {
      |Suspends the policy.
    }
  }
  command ReinstatePolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    paymentReceived: Decimal(10,2) with {
      briefly "Payment"
      described as {
        |Reinstatement payment.
      }
    }
  } with {
    briefly "Reinstate policy"
    described as {
      |Reinstates suspended policy.
    }
  }
  command CancelPolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation details.
      }
    }
  } with {
    briefly "Cancel policy"
    described as {
      |Cancels the policy.
    }
  }
  command NonRenewPolicy is  {
    policyId: PolicyId with {
      briefly "Policy ID"
      described as {
        |Policy identifier.
      }
    }
    nonRenewalReason: String(1,500) with {
      briefly "Non-Renewal Reason"
      described as {
        |Non-renewal reason.
      }
    }
  } with {
    briefly "Non-renew policy"
    described as {
      |Non-renews the policy.
    }
  }
  // Events
  event PolicyIssued is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    policyholder: PolicyholderInfo with {
      briefly "Policyholder"
      described as {
        |Policyholder info.
      }
    }
    policyType: PolicyType with {
      briefly "Type"
      described as {
        |Policy type.
      }
    }
    coverages: CoverageInfo+ with {
      briefly "Coverages"
      described as {
        |Policy coverages.
      }
    }
    period: PolicyPeriod with {
      briefly "Period"
      described as {
        |Policy period.
      }
    }
    premium: PremiumInfo with {
      briefly "Premium"
      described as {
        |Premium info.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Policy issued"
    described as {
      |Emitted when policy is issued.
    }
  }
  event PolicyBound is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    paymentFrequency: PaymentFrequency with {
      briefly "Frequency"
      described as {
        |Payment frequency.
      }
    }
    boundAt: TimeStamp with {
      briefly "Bound"
      described as {
        |Bind time.
      }
    }
  } with {
    briefly "Policy bound"
    described as {
      |Emitted when policy is bound.
    }
  }
  event EndorsementAdded is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    endorsement: EndorsementInfo with {
      briefly "Endorsement"
      described as {
        |Endorsement details.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Endorsement added"
    described as {
      |Emitted when endorsement is added.
    }
  }
  event RenewalOffered is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    renewal: RenewalInfo with {
      briefly "Renewal"
      described as {
        |Renewal details.
      }
    }
    offeredAt: TimeStamp with {
      briefly "Offered"
      described as {
        |Offer time.
      }
    }
  } with {
    briefly "Renewal offered"
    described as {
      |Emitted when renewal is offered.
    }
  }
  event RenewalAccepted is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    newPeriod: PolicyPeriod with {
      briefly "Period"
      described as {
        |New policy period.
      }
    }
    acceptedAt: TimeStamp with {
      briefly "Accepted"
      described as {
        |Acceptance time.
      }
    }
  } with {
    briefly "Renewal accepted"
    described as {
      |Emitted when renewal is accepted.
    }
  }
  event PolicySuspended is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    suspensionReason: String(1,500) with {
      briefly "Suspension Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Policy suspended"
    described as {
      |Emitted when policy is suspended.
    }
  }
  event PolicyReinstated is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    paymentReceived: Decimal(10,2) with {
      briefly "Payment"
      described as {
        |Reinstatement payment.
      }
    }
    reinstatedAt: TimeStamp with {
      briefly "Reinstated"
      described as {
        |Reinstatement time.
      }
    }
  } with {
    briefly "Policy reinstated"
    described as {
      |Emitted when policy is reinstated.
    }
  }
  event PolicyCancelled is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation info.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Policy cancelled"
    described as {
      |Emitted when policy is cancelled.
    }
  }
  event PolicyNonRenewed is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    nonRenewalReason: String(1,500) with {
      briefly "Non-Renewal Reason"
      described as {
        |Non-renewal reason.
      }
    }
    nonRenewedAt: TimeStamp with {
      briefly "Non-renewed"
      described as {
        |Non-renewal time.
      }
    }
  } with {
    briefly "Policy non-renewed"
    described as {
      |Emitted when policy is non-renewed.
    }
  }
  // State Records
  record ActiveStateData is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    policyholder: PolicyholderInfo with {
      briefly "Policyholder"
      described as {
        |Policyholder info.
      }
    }
    policyType: PolicyType with {
      briefly "Type"
      described as {
        |Policy type.
      }
    }
    property: InsuredProperty with {
      briefly "Property"
      described as {
        |Insured property.
      }
    }
    coverages: CoverageInfo+ with {
      briefly "Coverages"
      described as {
        |Policy coverages.
      }
    }
    period: PolicyPeriod with {
      briefly "Period"
      described as {
        |Policy period.
      }
    }
    premium: PremiumInfo with {
      briefly "Premium"
      described as {
        |Premium info.
      }
    }
    endorsements: EndorsementInfo* with {
      briefly "Endorsements"
      described as {
        |Policy endorsements.
      }
    }
    status: PolicyStatus with {
      briefly "Status"
      described as {
        |Policy status.
      }
    }
    selectedPaymentFrequency: PaymentFrequency? with {
      briefly "Frequency"
      described as {
        |Payment frequency.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active policy.
    }
  }
  record TerminatedStateData is  {
    policyId: PolicyId with {
      briefly "Policy"
      described as {
        |Policy ID.
      }
    }
    policyholder: PolicyholderInfo with {
      briefly "Policyholder"
      described as {
        |Policyholder info.
      }
    }
    terminationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    terminatedAt: TimeStamp with {
      briefly "Terminated"
      described as {
        |Termination time.
      }
    }
  } with {
    briefly "Terminated state"
    described as {
      |State for terminated policy.
    }
  }
  // States
  state ActiveState of type Policy.ActiveStateData
  state TerminatedState of type Policy.TerminatedStateData
  // Handler
  handler PolicyHandler is {
    on command IssuePolicy is {
      morph entity PolicyContext.Policy to state PolicyContext.Policy.ActiveState with command IssuePolicy
      tell event PolicyIssued to entity PolicyContext.Policy
    }
    on command BindPolicy is {
      tell event PolicyBound to entity PolicyContext.Policy
    }
    on command AddEndorsement is {
      tell event EndorsementAdded to entity PolicyContext.Policy
    }
    on command ProcessRenewal is {
      tell event RenewalOffered to entity PolicyContext.Policy
    }
    on command AcceptRenewal is {
      tell event RenewalAccepted to entity PolicyContext.Policy
    }
    on command SuspendPolicy is {
      tell event PolicySuspended to entity PolicyContext.Policy
    }
    on command ReinstatePolicy is {
      tell event PolicyReinstated to entity PolicyContext.Policy
    }
    on command CancelPolicy is {
      morph entity PolicyContext.Policy to state PolicyContext.Policy.TerminatedState with command CancelPolicy
      tell event PolicyCancelled to entity PolicyContext.Policy
    }
    on command NonRenewPolicy is {
      morph entity PolicyContext.Policy to state PolicyContext.Policy.TerminatedState with command NonRenewPolicy
      tell event PolicyNonRenewed to entity PolicyContext.Policy
    }
  } with {
    briefly "Processes policy commands"
    described as {
      | Handles policy lifecycle from issuance
      | through endorsements, renewals, and termination.
    }
  }
} with {
  briefly "Policy aggregate"
  described as {
    | The Policy entity manages insurance policies
    | and their lifecycle from issuance to termination.
  }
}
