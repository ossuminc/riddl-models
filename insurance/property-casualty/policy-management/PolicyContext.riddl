// Policy Management - Policy Context
context PolicyContext is {
  include "types.riddl"
  include "Policy.riddl"
  // Repository for policy persistence
  repository PolicyRepository is {
    schema PolicyData is relational
      of policies as type Policy
        index on field Policy.policyId
        index on field Policy.policyholder.policyholderId
        index on field Policy.period.expirationDate

    handler PolicyPersistence is {
      on command Policy.IssuePolicy is {
        prompt "Store new policy"
      }
      on command Policy.BindPolicy is {
        prompt "Update to bound"
      }
      on command Policy.AddEndorsement is {
        prompt "Store endorsement"
      }
      on command Policy.ProcessRenewal is {
        prompt "Store renewal offer"
      }
      on command Policy.AcceptRenewal is {
        prompt "Update policy period"
      }
      on command Policy.SuspendPolicy is {
        prompt "Update to suspended"
      }
      on command Policy.ReinstatePolicy is {
        prompt "Update to active"
      }
      on command Policy.CancelPolicy is {
        prompt "Update to cancelled"
      }
      on command Policy.NonRenewPolicy is {
        prompt "Update to non-renewed"
      }
    } with {
      briefly "Persists policy commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Policy data persistence"
    described as {
      | The PolicyRepository provides persistent storage for
      | policies, endorsements, and history.
    }
  }
  // Projector for policy analytics
  projector PolicyAnalytics is {
    record PolicyStats is  {
      totalPolicies: Natural with {
        briefly "Total"
        described as {
          |Total policies.
        }
      }
      activePolicies: Natural with {
        briefly "Active"
        described as {
          |Active policies.
        }
      }
      totalPremiumInForce: Decimal(15,2) with {
        briefly "Premium"
        described as {
          |Total premium in force.
        }
      }
      renewalRate: Decimal(5,4) with {
        briefly "Renewal rate"
        described as {
          |Renewal rate.
        }
      }
      cancellationRate: Decimal(5,4) with {
        briefly "Cancellation rate"
        described as {
          |Cancellation rate.
        }
      }
      averagePremium: Decimal(10,2) with {
        briefly "Avg premium"
        described as {
          |Average premium.
        }
      }
    } with {
      briefly "Policy statistics"
      described as {
        |Insurance policy metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Policy.PolicyIssued is {
        prompt "Update policy counts"
      }
      on event Policy.PolicyBound is {
        prompt "Update premium metrics"
      }
      on event Policy.RenewalAccepted is {
        prompt "Update renewal metrics"
      }
      on event Policy.PolicyCancelled is {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains policy analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Policy analytics projections"
    described as {
      |Maintains insurance policy analytics data.
    }
  }
} with {
  briefly "Bounded context for policy management"
  described as {
    | The PolicyContext is the bounded context for
    | insurance policy administration and lifecycle.
  }
}
