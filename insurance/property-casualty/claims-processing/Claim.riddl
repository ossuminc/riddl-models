// Claim Entity - Core aggregate for claims processing

entity Claim is {

  // Commands

  command FileClaim is {
    claimInfo is ClaimInfo with {
      briefly "Claim information"
      described by "Core claim details from first notice of loss."
    }
  } with {
    briefly "Submit a new claim for processing"
    described by {
      | Initiates a new claim based on first notice of loss information.
      | Validates required fields and creates the claim in Filed status.
    }
  }

  command AssignAdjuster is {
    adjusterId is AdjusterId with {
      briefly "Adjuster identifier"
      described by "The adjuster being assigned to this claim."
    }
    assignmentNotes is String(1, 1000) with {
      briefly "Assignment notes"
      described by "Notes about the assignment reason or special instructions."
    }
  } with {
    briefly "Assign an adjuster to investigate the claim"
    described by {
      | Assigns a specific adjuster to handle the claim investigation.
      | May be based on workload, expertise, or geographic location.
    }
  }

  command InvestigateClaim is {
    investigationNotes is InvestigationNotes with {
      briefly "Investigation notes"
      described by "Notes documenting investigation activities."
    }
    coverageAnalysis is optional CoverageAnalysis with {
      briefly "Coverage analysis"
      described by "Results of coverage analysis if completed."
    }
  } with {
    briefly "Record investigation findings"
    described by {
      | Documents investigation activities and findings. May include
      | partial or complete coverage analysis results.
    }
  }

  command SetReserve is {
    reserveInfo is ReserveInfo with {
      briefly "Reserve information"
      described by "The reserve amounts being established."
    }
  } with {
    briefly "Establish or update claim reserves"
    described by {
      | Sets the financial reserve estimate for the claim. Reserves
      | may be updated multiple times as investigation progresses.
    }
  }

  command ApproveClaim is {
    approvedAmount is Decimal(12, 2) with {
      briefly "Approved amount"
      described by "The settlement amount approved for payment."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Name or ID of the person approving the claim."
    }
    approvalNotes is String(1, 2000) with {
      briefly "Approval notes"
      described by "Notes documenting the approval decision."
    }
  } with {
    briefly "Approve the claim for payment"
    described by {
      | Final approval of the claim settlement amount. Triggers
      | the payment process and updates claim status.
    }
  }

  command IssuePay is {
    paymentInfo is PaymentInfo with {
      briefly "Payment information"
      described by "Details of the payment being issued."
    }
  } with {
    briefly "Issue payment for an approved claim"
    described by {
      | Records that payment has been issued for the claim.
      | Coordinates with external PaymentService for actual disbursement.
    }
  }

  command DenyClaim is {
    denialReason is DenialReason with {
      briefly "Denial reason"
      described by "The reason for denying the claim."
    }
    denialNotes is String(1, 2000) with {
      briefly "Denial notes"
      described by "Detailed explanation of the denial."
    }
    deniedBy is String(1, 100) with {
      briefly "Denied by"
      described by "Name or ID of the person denying the claim."
    }
  } with {
    briefly "Deny the claim"
    described by {
      | Formally denies the claim with documented reasoning.
      | Triggers policyholder notification process.
    }
  }

  command CloseClaim is {
    closureNotes is String(1, 2000) with {
      briefly "Closure notes"
      described by "Notes documenting the claim closure."
    }
    closedBy is String(1, 100) with {
      briefly "Closed by"
      described by "Name or ID of the person closing the claim."
    }
  } with {
    briefly "Close the claim after final disposition"
    described by {
      | Closes the claim after all processing is complete.
      | Applicable after payment or denial has been finalized.
    }
  }

  // Events

  event ClaimFiled is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The unique identifier assigned to the new claim."
    }
    claimInfo is ClaimInfo with {
      briefly "Claim information"
      described by "Core details of the filed claim."
    }
    filedAt is TimeStamp with {
      briefly "Filed timestamp"
      described by "When the claim was filed."
    }
  } with {
    briefly "A new claim has been filed"
    described by {
      | Records that a claim has been successfully filed and
      | entered into the system for processing.
    }
  }

  event AdjusterAssigned is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim to which the adjuster was assigned."
    }
    adjusterId is AdjusterId with {
      briefly "Adjuster identifier"
      described by "The adjuster assigned to the claim."
    }
    assignedAt is TimeStamp with {
      briefly "Assigned timestamp"
      described by "When the adjuster was assigned."
    }
    assignmentNotes is String(1, 1000) with {
      briefly "Assignment notes"
      described by "Notes about the assignment."
    }
  } with {
    briefly "An adjuster has been assigned to the claim"
    described by {
      | Records adjuster assignment for workload tracking
      | and investigation accountability.
    }
  }

  event InvestigationUpdated is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim being investigated."
    }
    investigationNotes is InvestigationNotes with {
      briefly "Investigation notes"
      described by "The notes being added."
    }
    coverageAnalysis is optional CoverageAnalysis with {
      briefly "Coverage analysis"
      described by "Coverage analysis if updated."
    }
    updatedAt is TimeStamp with {
      briefly "Updated timestamp"
      described by "When the investigation was updated."
    }
  } with {
    briefly "Investigation findings have been recorded"
    described by {
      | Documents investigation progress and findings for
      | audit trail and decision support.
    }
  }

  event ReserveEstablished is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim for which reserves were set."
    }
    reserveInfo is ReserveInfo with {
      briefly "Reserve information"
      described by "The reserve amounts established."
    }
    establishedAt is TimeStamp with {
      briefly "Established timestamp"
      described by "When the reserves were set."
    }
  } with {
    briefly "Financial reserves have been set or updated"
    described by {
      | Records reserve establishment or change for financial
      | reporting and exposure tracking.
    }
  }

  event ClaimApproved is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim that was approved."
    }
    approvedAmount is Decimal(12, 2) with {
      briefly "Approved amount"
      described by "The settlement amount approved."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Who approved the claim."
    }
    approvalNotes is String(1, 2000) with {
      briefly "Approval notes"
      described by "Notes on the approval decision."
    }
    approvedAt is TimeStamp with {
      briefly "Approved timestamp"
      described by "When the claim was approved."
    }
  } with {
    briefly "The claim has been approved for payment"
    described by {
      | Records approval decision including amount and approver
      | for audit and payment processing.
    }
  }

  event PaymentIssued is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim for which payment was issued."
    }
    paymentInfo is PaymentInfo with {
      briefly "Payment information"
      described by "Details of the payment issued."
    }
    issuedAt is TimeStamp with {
      briefly "Issued timestamp"
      described by "When the payment was issued."
    }
  } with {
    briefly "Payment has been issued for the claim"
    described by {
      | Records payment details for financial reconciliation
      | and claim history.
    }
  }

  event ClaimDenied is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim that was denied."
    }
    denialReason is DenialReason with {
      briefly "Denial reason"
      described by "Why the claim was denied."
    }
    denialNotes is String(1, 2000) with {
      briefly "Denial notes"
      described by "Detailed denial explanation."
    }
    deniedBy is String(1, 100) with {
      briefly "Denied by"
      described by "Who denied the claim."
    }
    deniedAt is TimeStamp with {
      briefly "Denied timestamp"
      described by "When the claim was denied."
    }
  } with {
    briefly "The claim has been denied"
    described by {
      | Records denial decision with reasoning for compliance
      | reporting and potential appeals handling.
    }
  }

  event ClaimClosed is {
    claimId is ClaimId with {
      briefly "Claim identifier"
      described by "The claim that was closed."
    }
    closureNotes is String(1, 2000) with {
      briefly "Closure notes"
      described by "Notes on the claim closure."
    }
    closedBy is String(1, 100) with {
      briefly "Closed by"
      described by "Who closed the claim."
    }
    closedAt is TimeStamp with {
      briefly "Closed timestamp"
      described by "When the claim was closed."
    }
  } with {
    briefly "The claim has been closed"
    described by {
      | Records final closure of the claim for reporting
      | and historical analysis.
    }
  }

  // State Records

  record FiledStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    filedAt is TimeStamp with { briefly "Filed at" described by "When filed." }
  } with {
    briefly "Data for filed state"
    described by "State data for a claim that has been filed but not yet assigned."
  }

  record AssignedStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    assignedAdjuster is AdjusterId with { briefly "Adjuster" described by "Assigned adjuster." }
    assignedAt is TimeStamp with { briefly "Assigned at" described by "When assigned." }
  } with {
    briefly "Data for assigned state"
    described by "State data for a claim that has been assigned to an adjuster."
  }

  record InvestigationStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    assignedAdjuster is AdjusterId with { briefly "Adjuster" described by "Assigned adjuster." }
    investigationHistory is many InvestigationNotes with { briefly "Notes" described by "Investigation notes." }
    coverageAnalysis is optional CoverageAnalysis with { briefly "Coverage" described by "Coverage analysis." }
  } with {
    briefly "Data for investigation state"
    described by "State data for a claim under active investigation."
  }

  record ReservedStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    assignedAdjuster is AdjusterId with { briefly "Adjuster" described by "Assigned adjuster." }
    investigationHistory is many InvestigationNotes with { briefly "Notes" described by "Investigation notes." }
    coverageAnalysis is CoverageAnalysis with { briefly "Coverage" described by "Coverage analysis." }
    currentReserve is ReserveInfo with { briefly "Reserve" described by "Current reserve amounts." }
  } with {
    briefly "Data for reserved state"
    described by "State data for a claim with established reserves."
  }

  record ApprovedStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    coverageAnalysis is CoverageAnalysis with { briefly "Coverage" described by "Coverage analysis." }
    currentReserve is ReserveInfo with { briefly "Reserve" described by "Reserve amounts." }
    approvedAmount is Decimal(12, 2) with { briefly "Approved" described by "Approved amount." }
    approvedBy is String(1, 100) with { briefly "By" described by "Who approved." }
    approvedAt is TimeStamp with { briefly "At" described by "When approved." }
  } with {
    briefly "Data for approved state"
    described by "State data for an approved claim awaiting payment."
  }

  record PaidStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    coverageAnalysis is CoverageAnalysis with { briefly "Coverage" described by "Coverage analysis." }
    payments is many PaymentInfo with { briefly "Payments" described by "Payment records." }
    totalPaid is Decimal(12, 2) with { briefly "Total paid" described by "Total amount paid." }
  } with {
    briefly "Data for paid state"
    described by "State data for a claim with issued payments."
  }

  record DeniedStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    coverageAnalysis is optional CoverageAnalysis with { briefly "Coverage" described by "Coverage analysis." }
    denialReason is DenialReason with { briefly "Reason" described by "Denial reason." }
    denialNotes is String(1, 2000) with { briefly "Notes" described by "Denial notes." }
    deniedBy is String(1, 100) with { briefly "By" described by "Who denied." }
    deniedAt is TimeStamp with { briefly "At" described by "When denied." }
  } with {
    briefly "Data for denied state"
    described by "State data for a denied claim."
  }

  record ClosedStateData is {
    claimId is ClaimId with { briefly "Claim ID" described by "Claim identifier." }
    claimInfo is ClaimInfo with { briefly "Claim info" described by "Core claim details." }
    finalStatus is ClaimStatus with { briefly "Status" described by "Final claim status." }
    totalPaid is Decimal(12, 2) with { briefly "Paid" described by "Total paid amount." }
    closedAt is TimeStamp with { briefly "At" described by "When closed." }
    closureNotes is String(1, 2000) with { briefly "Notes" described by "Closure notes." }
  } with {
    briefly "Data for closed state"
    described by "State data for a closed claim."
  }

  // States

  state FiledState of Claim.FiledStateData with {
    briefly "Claim has been filed and awaits assignment"
    described by "Initial state after FNOL. Claim is in queue for adjuster assignment."
  }

  state AssignedState of Claim.AssignedStateData with {
    briefly "Claim has been assigned to an adjuster"
    described by "Adjuster has been assigned and claim is ready for investigation."
  }

  state InvestigationState of Claim.InvestigationStateData with {
    briefly "Claim is under active investigation"
    described by "Investigation in progress with findings being documented."
  }

  state ReservedState of Claim.ReservedStateData with {
    briefly "Financial reserves have been established"
    described by "Reserves are set based on investigation. Ready for decision."
  }

  state ApprovedState of Claim.ApprovedStateData with {
    briefly "Claim has been approved for payment"
    described by "Settlement approved and awaiting payment processing."
  }

  state PaidState of Claim.PaidStateData with {
    briefly "Payment has been issued"
    described by "Payment processed. May have additional payments or be ready for closure."
  }

  state DeniedState of Claim.DeniedStateData with {
    briefly "Claim has been denied"
    described by "Claim not covered or invalid. Ready for closure or appeal."
  }

  state ClosedState of Claim.ClosedStateData with {
    briefly "Claim is closed and finalized"
    described by "All processing complete. Retained for history and potential reopening."
  }

  // Handler

  handler ClaimHandler is {
    on command FileClaim {
      morph entity Claim to state Claim.FiledState with command FileClaim
      tell event ClaimFiled to entity Claim
    }

    on command AssignAdjuster {
      morph entity Claim to state Claim.AssignedState with command AssignAdjuster
      tell event AdjusterAssigned to entity Claim
    }

    on command InvestigateClaim {
      morph entity Claim to state Claim.InvestigationState with command InvestigateClaim
      tell event InvestigationUpdated to entity Claim
    }

    on command SetReserve {
      morph entity Claim to state Claim.ReservedState with command SetReserve
      tell event ReserveEstablished to entity Claim
    }

    on command ApproveClaim {
      morph entity Claim to state Claim.ApprovedState with command ApproveClaim
      tell event ClaimApproved to entity Claim
    }

    on command IssuePay {
      morph entity Claim to state Claim.PaidState with command IssuePay
      tell event PaymentIssued to entity Claim
    }

    on command DenyClaim {
      morph entity Claim to state Claim.DeniedState with command DenyClaim
      tell event ClaimDenied to entity Claim
    }

    on command CloseClaim {
      morph entity Claim to state Claim.ClosedState with command CloseClaim
      tell event ClaimClosed to entity Claim
    }
  } with {
    briefly "Command handler for Claim entity"
    described by {
      | Processes all commands against the Claim aggregate,
      | enforcing business rules and emitting domain events.
    }
  }

} with {
  option aggregate
  option event-sourced
  briefly "Core claim aggregate managing the claims lifecycle"
  described by {
    | The Claim entity is the primary aggregate in the claims processing
    | domain. It maintains the complete state of a claim through its
    | lifecycle from filing through closure. As an event-sourced aggregate,
    | all state changes are captured as domain events enabling full
    | audit trails and event-driven integration.
  }
}
