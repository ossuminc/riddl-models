// Claim Entity - Core aggregate for claims processing
entity Claim is {
  // Commands
  command FileClaim is  {
    claimInfo: ClaimInfo with {
      briefly "Claim information"
      described as {
        |Core claim details from first notice of loss.
      }
    }
  } with {
    briefly "Submit a new claim for processing"
    described as {
      | Initiates a new claim based on first notice of loss information.
      | Validates required fields and creates the claim in Filed status.
    }
  }
  command AssignAdjuster is  {
    adjusterId: AdjusterId with {
      briefly "Adjuster identifier"
      described as {
        |The adjuster being assigned to this claim.
      }
    }
    assignmentNotes: String(1,1000) with {
      briefly "Assignment notes"
      described as {
        |Notes about the assignment reason or special instructions.
      }
    }
  } with {
    briefly "Assign an adjuster to investigate the claim"
    described as {
      | Assigns a specific adjuster to handle the claim investigation.
      | May be based on workload, expertise, or geographic location.
    }
  }
  command InvestigateClaim is  {
    investigationNotes: InvestigationNotes with {
      briefly "Investigation notes"
      described as {
        |Notes documenting investigation activities.
      }
    }
    preliminaryCoverageAnalysis: CoverageAnalysis? with {
      briefly "Coverage analysis"
      described as {
        |Results of coverage analysis if completed.
      }
    }
  } with {
    briefly "Record investigation findings"
    described as {
      | Documents investigation activities and findings. May include
      | partial or complete coverage analysis results.
    }
  }
  command SetReserve is  {
    reserveInfo: ReserveInfo with {
      briefly "Reserve information"
      described as {
        |The reserve amounts being established.
      }
    }
  } with {
    briefly "Establish or update claim reserves"
    described as {
      | Sets the financial reserve estimate for the claim. Reserves
      | may be updated multiple times as investigation progresses.
    }
  }
  command ApproveClaim is  {
    approvedAmount: Decimal(12,2) with {
      briefly "Approved amount"
      described as {
        |The settlement amount approved for payment.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Name or ID of the person approving the claim.
      }
    }
    approvalNotes: String(1,2000) with {
      briefly "Approval notes"
      described as {
        |Notes documenting the approval decision.
      }
    }
  } with {
    briefly "Approve the claim for payment"
    described as {
      | Final approval of the claim settlement amount. Triggers
      | the payment process and updates claim status.
    }
  }
  command IssuePay is  {
    paymentInfo: PaymentInfo with {
      briefly "Payment information"
      described as {
        |Details of the payment being issued.
      }
    }
  } with {
    briefly "Issue payment for an approved claim"
    described as {
      | Records that payment has been issued for the claim.
      | Coordinates with external PaymentService for actual disbursement.
    }
  }
  command DenyClaim is  {
    denialReason: DenialReason with {
      briefly "Denial reason"
      described as {
        |The reason for denying the claim.
      }
    }
    denialNotes: String(1,2000) with {
      briefly "Denial notes"
      described as {
        |Detailed explanation of the denial.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Name or ID of the person denying the claim.
      }
    }
  } with {
    briefly "Deny the claim"
    described as {
      | Formally denies the claim with documented reasoning.
      | Triggers policyholder notification process.
    }
  }
  command CloseClaim is  {
    closureNotes: String(1,2000) with {
      briefly "Closure notes"
      described as {
        |Notes documenting the claim closure.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Name or ID of the person closing the claim.
      }
    }
  } with {
    briefly "Close the claim after final disposition"
    described as {
      | Closes the claim after all processing is complete.
      | Applicable after payment or denial has been finalized.
    }
  }
  // Events
  event ClaimFiled is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The unique identifier assigned to the new claim.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim information"
      described as {
        |Core details of the filed claim.
      }
    }
    filedAt: TimeStamp with {
      briefly "Filed timestamp"
      described as {
        |When the claim was filed.
      }
    }
  } with {
    briefly "A new claim has been filed"
    described as {
      | Records that a claim has been successfully filed and
      | entered into the system for processing.
    }
  }
  event AdjusterAssigned is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim to which the adjuster was assigned.
      }
    }
    adjusterId: AdjusterId with {
      briefly "Adjuster identifier"
      described as {
        |The adjuster assigned to the claim.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned timestamp"
      described as {
        |When the adjuster was assigned.
      }
    }
    assignmentNotes: String(1,1000) with {
      briefly "Assignment notes"
      described as {
        |Notes about the assignment.
      }
    }
  } with {
    briefly "An adjuster has been assigned to the claim"
    described as {
      | Records adjuster assignment for workload tracking
      | and investigation accountability.
    }
  }
  event InvestigationUpdated is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim being investigated.
      }
    }
    investigationNotes: InvestigationNotes with {
      briefly "Investigation notes"
      described as {
        |The notes being added.
      }
    }
    preliminaryCoverageAnalysis: CoverageAnalysis? with {
      briefly "Coverage analysis"
      described as {
        |Coverage analysis if updated.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated timestamp"
      described as {
        |When the investigation was updated.
      }
    }
  } with {
    briefly "Investigation findings have been recorded"
    described as {
      | Documents investigation progress and findings for
      | audit trail and decision support.
    }
  }
  event ReserveEstablished is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim for which reserves were set.
      }
    }
    reserveInfo: ReserveInfo with {
      briefly "Reserve information"
      described as {
        |The reserve amounts established.
      }
    }
    establishedAt: TimeStamp with {
      briefly "Established timestamp"
      described as {
        |When the reserves were set.
      }
    }
  } with {
    briefly "Financial reserves have been set or updated"
    described as {
      | Records reserve establishment or change for financial
      | reporting and exposure tracking.
    }
  }
  event ClaimApproved is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim that was approved.
      }
    }
    approvedAmount: Decimal(12,2) with {
      briefly "Approved amount"
      described as {
        |The settlement amount approved.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Who approved the claim.
      }
    }
    approvalNotes: String(1,2000) with {
      briefly "Approval notes"
      described as {
        |Notes on the approval decision.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved timestamp"
      described as {
        |When the claim was approved.
      }
    }
  } with {
    briefly "The claim has been approved for payment"
    described as {
      | Records approval decision including amount and approver
      | for audit and payment processing.
    }
  }
  event PaymentIssued is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim for which payment was issued.
      }
    }
    paymentInfo: PaymentInfo with {
      briefly "Payment information"
      described as {
        |Details of the payment issued.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued timestamp"
      described as {
        |When the payment was issued.
      }
    }
  } with {
    briefly "Payment has been issued for the claim"
    described as {
      | Records payment details for financial reconciliation
      | and claim history.
    }
  }
  event ClaimDenied is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim that was denied.
      }
    }
    denialReason: DenialReason with {
      briefly "Denial reason"
      described as {
        |Why the claim was denied.
      }
    }
    denialNotes: String(1,2000) with {
      briefly "Denial notes"
      described as {
        |Detailed denial explanation.
      }
    }
    deniedBy: String(1,100) with {
      briefly "Denied by"
      described as {
        |Who denied the claim.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied timestamp"
      described as {
        |When the claim was denied.
      }
    }
  } with {
    briefly "The claim has been denied"
    described as {
      | Records denial decision with reasoning for compliance
      | reporting and potential appeals handling.
    }
  }
  event ClaimClosed is  {
    claimId: ClaimId with {
      briefly "Claim identifier"
      described as {
        |The claim that was closed.
      }
    }
    closureNotes: String(1,2000) with {
      briefly "Closure notes"
      described as {
        |Notes on the claim closure.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Who closed the claim.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed timestamp"
      described as {
        |When the claim was closed.
      }
    }
  } with {
    briefly "The claim has been closed"
    described as {
      | Records final closure of the claim for reporting
      | and historical analysis.
    }
  }
  // State Records
  record FiledStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    filedAt: TimeStamp with {
      briefly "Filed at"
      described as {
        |When filed.
      }
    }
  } with {
    briefly "Data for filed state"
    described as {
      |State data for a claim that has been filed but not yet assigned.
    }
  }
  record AssignedStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    assignedAdjuster: AdjusterId with {
      briefly "Adjuster"
      described as {
        |Assigned adjuster.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned at"
      described as {
        |When assigned.
      }
    }
  } with {
    briefly "Data for assigned state"
    described as {
      |State data for a claim that has been assigned to an adjuster.
    }
  }
  record InvestigationStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    assignedAdjuster: AdjusterId with {
      briefly "Adjuster"
      described as {
        |Assigned adjuster.
      }
    }
    investigationHistory: InvestigationNotes+ with {
      briefly "Notes"
      described as {
        |Investigation notes.
      }
    }
    preliminaryCoverageAnalysis: CoverageAnalysis? with {
      briefly "Coverage"
      described as {
        |Coverage analysis.
      }
    }
  } with {
    briefly "Data for investigation state"
    described as {
      |State data for a claim under active investigation.
    }
  }
  record ReservedStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    assignedAdjuster: AdjusterId with {
      briefly "Adjuster"
      described as {
        |Assigned adjuster.
      }
    }
    investigationHistory: InvestigationNotes+ with {
      briefly "Notes"
      described as {
        |Investigation notes.
      }
    }
    coverageAnalysis: CoverageAnalysis with {
      briefly "Coverage"
      described as {
        |Coverage analysis.
      }
    }
    currentReserve: ReserveInfo with {
      briefly "Reserve"
      described as {
        |Current reserve amounts.
      }
    }
  } with {
    briefly "Data for reserved state"
    described as {
      |State data for a claim with established reserves.
    }
  }
  record ApprovedStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    coverageAnalysis: CoverageAnalysis with {
      briefly "Coverage"
      described as {
        |Coverage analysis.
      }
    }
    currentReserve: ReserveInfo with {
      briefly "Reserve"
      described as {
        |Reserve amounts.
      }
    }
    approvedAmount: Decimal(12,2) with {
      briefly "Approved"
      described as {
        |Approved amount.
      }
    }
    approvedBy: String(1,100) with {
      briefly "By"
      described as {
        |Who approved.
      }
    }
    approvedAt: TimeStamp with {
      briefly "At"
      described as {
        |When approved.
      }
    }
  } with {
    briefly "Data for approved state"
    described as {
      |State data for an approved claim awaiting payment.
    }
  }
  record PaidStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    coverageAnalysis: CoverageAnalysis with {
      briefly "Coverage"
      described as {
        |Coverage analysis.
      }
    }
    payments: PaymentInfo+ with {
      briefly "Payments"
      described as {
        |Payment records.
      }
    }
    totalPaid: Decimal(12,2) with {
      briefly "Total paid"
      described as {
        |Total amount paid.
      }
    }
  } with {
    briefly "Data for paid state"
    described as {
      |State data for a claim with issued payments.
    }
  }
  record DeniedStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    preliminaryCoverageAnalysis: CoverageAnalysis? with {
      briefly "Coverage"
      described as {
        |Coverage analysis.
      }
    }
    denialReason: DenialReason with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    denialNotes: String(1,2000) with {
      briefly "Notes"
      described as {
        |Denial notes.
      }
    }
    deniedBy: String(1,100) with {
      briefly "By"
      described as {
        |Who denied.
      }
    }
    deniedAt: TimeStamp with {
      briefly "At"
      described as {
        |When denied.
      }
    }
  } with {
    briefly "Data for denied state"
    described as {
      |State data for a denied claim.
    }
  }
  record ClosedStateData is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    claimInfo: ClaimInfo with {
      briefly "Claim info"
      described as {
        |Core claim details.
      }
    }
    finalStatus: ClaimStatus with {
      briefly "Status"
      described as {
        |Final claim status.
      }
    }
    totalPaid: Decimal(12,2) with {
      briefly "Paid"
      described as {
        |Total paid amount.
      }
    }
    closedAt: TimeStamp with {
      briefly "At"
      described as {
        |When closed.
      }
    }
    closureNotes: String(1,2000) with {
      briefly "Notes"
      described as {
        |Closure notes.
      }
    }
  } with {
    briefly "Data for closed state"
    described as {
      |State data for a closed claim.
    }
  }
  // States
  state FiledState of type Claim.FiledStateData
  state AssignedState of type Claim.AssignedStateData
  state InvestigationState of type Claim.InvestigationStateData
  state ReservedState of type Claim.ReservedStateData
  state ApprovedState of type Claim.ApprovedStateData
  state PaidState of type Claim.PaidStateData
  state DeniedState of type Claim.DeniedStateData
  state ClosedState of type Claim.ClosedStateData
  // Handler
  handler ClaimHandler is {
    on command FileClaim is {
      morph entity Claim to state Claim.FiledState with command FileClaim
      tell event ClaimFiled to entity Claim
    }
    on command AssignAdjuster is {
      morph entity Claim to state Claim.AssignedState with command AssignAdjuster
      tell event AdjusterAssigned to entity Claim
    }
    on command InvestigateClaim is {
      morph entity Claim to state Claim.InvestigationState with command InvestigateClaim
      tell event InvestigationUpdated to entity Claim
    }
    on command SetReserve is {
      morph entity Claim to state Claim.ReservedState with command SetReserve
      tell event ReserveEstablished to entity Claim
    }
    on command ApproveClaim is {
      morph entity Claim to state Claim.ApprovedState with command ApproveClaim
      tell event ClaimApproved to entity Claim
    }
    on command IssuePay is {
      morph entity Claim to state Claim.PaidState with command IssuePay
      tell event PaymentIssued to entity Claim
    }
    on command DenyClaim is {
      morph entity Claim to state Claim.DeniedState with command DenyClaim
      tell event ClaimDenied to entity Claim
    }
    on command CloseClaim is {
      morph entity Claim to state Claim.ClosedState with command CloseClaim
      tell event ClaimClosed to entity Claim
    }
  } with {
    briefly "Command handler for Claim entity"
    described as {
      | Processes all commands against the Claim aggregate,
      | enforcing business rules and emitting domain events.
    }
  }
} with {
  option aggregate()
  option event-sourced()
  briefly "Core claim aggregate managing the claims lifecycle"
  described as {
    | The Claim entity is the primary aggregate in the claims processing
    | domain. It maintains the complete state of a claim through its
    | lifecycle from filing through closure. As an event-sourced aggregate,
    | all state changes are captured as domain events enabling full
    | audit trails and event-driven integration.
  }
}
