// Policy Administration - Policy Context
context PolicyContext is {
  include "types.riddl"
  include "Policy.riddl"
  // Repository for policy persistence
  repository PolicyRepository is {
    schema PolicyData is relational
      of policies as type Policy
        index on field Policy.policyId
        index on field Policy.details.policyNumber
        index on field Policy.details.insuredName

    handler PolicyPersistence is {
      on command Policy.IssuePolicy is {
        prompt "Store new policy record"
      }
      on command Policy.AddEndorsement is {
        prompt "Update policy with endorsement"
      }
      on command Policy.ProcessRenewal is {
        prompt "Store renewal and new policy term"
      }
      on command Policy.DeclineRenewal is {
        prompt "Mark policy for expiration"
      }
      on command Policy.CancelPolicy is {
        prompt "Update policy to cancelled status"
      }
      on command Policy.ReinstatPolicy is {
        prompt "Update policy to active status"
      }
      on command Policy.UpdateBilling is {
        prompt "Update billing schedule"
      }
      on command Policy.GenerateRenewalOffer is {
        prompt "Store renewal offer"
      }
    } with {
      briefly "Persists policy commands"
      described as {
        |Handles command-driven persistence for policies.
      }
    }
  } with {
    briefly "Policy data persistence"
    described as {
      | The PolicyRepository provides persistent storage for
      | policy records including endorsements and renewals.
    }
  }
  // Projector for policy metrics
  projector PolicyMetricsProjector is {
    record PolicyMetricsView is  {
      policyId: PolicyId with {
        briefly "Policy"
        described as {
          |Policy ID.
        }
      }
      policyNumber: String(1,20) with {
        briefly "Number"
        described as {
          |Policy number.
        }
      }
      insuredName: String(1,200) with {
        briefly "Insured"
        described as {
          |Insured name.
        }
      }
      status: PolicyStatus with {
        briefly "Status"
        described as {
          |Policy status.
        }
      }
      effectiveDate: Date with {
        briefly "Effective"
        described as {
          |Effective date.
        }
      }
      expirationDate: Date with {
        briefly "Expiration"
        described as {
          |Expiration date.
        }
      }
      totalPremium: Decimal(12,2) with {
        briefly "Premium"
        described as {
          |Total premium.
        }
      }
      endorsementCount: Integer with {
        briefly "Endorsements"
        described as {
          |Endorsement count.
        }
      }
      lastActivityDate: Date with {
        briefly "Last activity"
        described as {
          |Last activity date.
        }
      }
      renewalEligible: Boolean with {
        briefly "Renewal eligible"
        described as {
          |Is eligible for renewal.
        }
      }
    } with {
      briefly "Policy metrics view"
      described as {
        |Denormalized view for policy metrics.
      }
    }
    record PortfolioSummary is  {
      totalActivePolicies: Integer with {
        briefly "Active"
        described as {
          |Total active policies.
        }
      }
      totalWrittenPremium: Decimal(14,2) with {
        briefly "Written"
        described as {
          |Total written premium.
        }
      }
      policiesExpiringThisMonth: Integer with {
        briefly "Expiring"
        described as {
          |Policies expiring this month.
        }
      }
      averagePolicyAge: Decimal(5,2) with {
        briefly "Avg age"
        described as {
          |Average policy age in days.
        }
      }
      endorsementsThisMonth: Integer with {
        briefly "Endorsements"
        described as {
          |Endorsements this month.
        }
      }
      cancellationsThisMonth: Integer with {
        briefly "Cancellations"
        described as {
          |Cancellations this month.
        }
      }
      renewalRate: Decimal(5,4) with {
        briefly "Renewal rate"
        described as {
          |Renewal rate percentage.
        }
      }
    } with {
      briefly "Portfolio summary"
      described as {
        |Aggregated metrics across the policy portfolio.
      }
    }
    handler MetricsHandler is {
      on event Policy.PolicyIssued is {
        prompt "Update policy counts and premium totals"
      }
      on event Policy.EndorsementAdded is {
        prompt "Update endorsement counts"
      }
      on event Policy.RenewalProcessed is {
        prompt "Update renewal statistics"
      }
      on event Policy.PolicyCancelled is {
        prompt "Update cancellation counts"
      }
      on event Policy.PolicyReinstated is {
        prompt "Update reinstatement metrics"
      }
    } with {
      briefly "Maintains policy metrics"
      described as {
        |Projects events into metrics views.
      }
    }
  } with {
    briefly "Policy metrics projector"
    described as {
      | Maintains read-optimized views of policy data for
      | dashboards, reporting, and portfolio analysis.
    }
  }
} with {
  briefly "Bounded context for policy administration"
  described as {
    | The PolicyContext is the bounded context for policy
    | administration including the Policy aggregate, repository,
    | and projections for metrics.
  }
}
