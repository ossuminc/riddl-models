// Knowledge Management - KnowledgeItem Entity
entity KnowledgeItem is {
  // Commands
  command CreateItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |New item identifier.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Knowledge content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Item metadata.
      }
    }
  } with {
    briefly "Create item"
    described as {
      |Creates a new knowledge item.
    }
  }
  command UpdateItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item to update.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Updated content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Updated metadata.
      }
    }
  } with {
    briefly "Update item"
    described as {
      |Updates knowledge item.
    }
  }
  command SubmitForReview is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item to submit.
      }
    }
    reviewerId: AuthorId with {
      briefly "Reviewer"
      described as {
        |Requested reviewer.
      }
    }
  } with {
    briefly "Submit for review"
    described as {
      |Submits item for review.
    }
  }
  command ReviewItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item to review.
      }
    }
    review: ContentReview with {
      briefly "Review"
      described as {
        |Review details.
      }
    }
  } with {
    briefly "Review item"
    described as {
      |Reviews knowledge item.
    }
  }
  command PublishItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item to publish.
      }
    }
  } with {
    briefly "Publish item"
    described as {
      |Publishes knowledge item.
    }
  }
  command ArchiveItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item to archive.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
  } with {
    briefly "Archive item"
    described as {
      |Archives knowledge item.
    }
  }
  command AddComment is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item ID.
      }
    }
    comment: ContentComment with {
      briefly "Comment"
      described as {
        |Comment to add.
      }
    }
  } with {
    briefly "Add comment"
    described as {
      |Adds comment to item.
    }
  }
  command RateItem is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item ID.
      }
    }
    userId: AuthorId with {
      briefly "User"
      described as {
        |Rating user.
      }
    }
    rating: Natural with {
      briefly "Rating"
      described as {
        |Rating value (1-5).
      }
    }
  } with {
    briefly "Rate item"
    described as {
      |Rates knowledge item.
    }
  }
  command RecordView is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item ID.
      }
    }
    userId: AuthorId with {
      briefly "User"
      described as {
        |Viewing user.
      }
    }
  } with {
    briefly "Record view"
    described as {
      |Records item view.
    }
  }
  command AddToCollection is  {
    itemId: KnowledgeItemId with {
      briefly "Item ID"
      described as {
        |Item ID.
      }
    }
    collectionId: CollectionId with {
      briefly "Collection"
      described as {
        |Target collection.
      }
    }
  } with {
    briefly "Add to collection"
    described as {
      |Adds item to collection.
    }
  }
  // Events
  event ItemCreated is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Item content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Item metadata.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Item was created"
    described as {
      |Emitted when item is created.
    }
  }
  event ItemUpdated is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Updated content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Updated metadata.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Item was updated"
    described as {
      |Emitted when item is updated.
    }
  }
  event ItemSubmittedForReview is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    reviewerId: AuthorId with {
      briefly "Reviewer"
      described as {
        |Reviewer ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Item was submitted for review"
    described as {
      |Emitted when item enters review.
    }
  }
  event ItemReviewed is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    review: ContentReview with {
      briefly "Review"
      described as {
        |Review details.
      }
    }
    reviewedAt: TimeStamp with {
      briefly "Reviewed"
      described as {
        |Review time.
      }
    }
  } with {
    briefly "Item was reviewed"
    described as {
      |Emitted when item is reviewed.
    }
  }
  event ItemPublished is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    publishedAt: TimeStamp with {
      briefly "Published"
      described as {
        |Publication time.
      }
    }
  } with {
    briefly "Item was published"
    described as {
      |Emitted when item is published.
    }
  }
  event ItemArchived is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Item was archived"
    described as {
      |Emitted when item is archived.
    }
  }
  event CommentAdded is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    comment: ContentComment with {
      briefly "Comment"
      described as {
        |Added comment.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Comment was added"
    described as {
      |Emitted when comment is added.
    }
  }
  event ItemRated is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    userId: AuthorId with {
      briefly "User"
      described as {
        |Rating user.
      }
    }
    rating: Natural with {
      briefly "Rating"
      described as {
        |Rating value.
      }
    }
    ratedAt: TimeStamp with {
      briefly "Rated"
      described as {
        |Rating time.
      }
    }
  } with {
    briefly "Item was rated"
    described as {
      |Emitted when item is rated.
    }
  }
  event ViewRecorded is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    userId: AuthorId with {
      briefly "User"
      described as {
        |Viewing user.
      }
    }
    viewedAt: TimeStamp with {
      briefly "Viewed"
      described as {
        |View time.
      }
    }
  } with {
    briefly "View was recorded"
    described as {
      |Emitted when item is viewed.
    }
  }
  event AddedToCollection is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    collectionId: CollectionId with {
      briefly "Collection"
      described as {
        |Collection ID.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Item was added to collection"
    described as {
      |Emitted when item joins collection.
    }
  }
  // State Records
  record DraftItemData is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Item content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Item metadata.
      }
    }
    reviews: ContentReview+ with {
      briefly "Reviews"
      described as {
        |Review history.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Draft item data"
    described as {
      |State data for draft item.
    }
  }
  record PublishedItemData is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Item content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Item metadata.
      }
    }
    engagement: UserEngagement with {
      briefly "Engagement"
      described as {
        |Engagement metrics.
      }
    }
    comments: ContentComment+ with {
      briefly "Comments"
      described as {
        |Item comments.
      }
    }
    collections: CollectionId+ with {
      briefly "Collections"
      described as {
        |Containing collections.
      }
    }
    publishedAt: TimeStamp with {
      briefly "Published"
      described as {
        |Publication time.
      }
    }
  } with {
    briefly "Published item data"
    described as {
      |State data for published item.
    }
  }
  record ArchivedItemData is  {
    itemId: KnowledgeItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    content: KnowledgeContent with {
      briefly "Content"
      described as {
        |Item content.
      }
    }
    metadata: KnowledgeMetadata with {
      briefly "Metadata"
      described as {
        |Item metadata.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Archived item data"
    described as {
      |State data for archived item.
    }
  }
  // States
  state DraftState of type KnowledgeItem.DraftItemData
  state PublishedState of type KnowledgeItem.PublishedItemData
  state ArchivedState of type KnowledgeItem.ArchivedItemData
  // Handler
  handler KnowledgeItemHandler is {
    on command CreateItem is {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.DraftState with command CreateItem
      tell event ItemCreated to entity KnowledgeContext.KnowledgeItem
    }
    on command UpdateItem is {
      tell event ItemUpdated to entity KnowledgeContext.KnowledgeItem
    }
    on command SubmitForReview is {
      tell event ItemSubmittedForReview to entity KnowledgeContext.KnowledgeItem
    }
    on command ReviewItem is {
      tell event ItemReviewed to entity KnowledgeContext.KnowledgeItem
    }
    on command PublishItem is {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.PublishedState with command PublishItem
      tell event ItemPublished to entity KnowledgeContext.KnowledgeItem
    }
    on command ArchiveItem is {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.ArchivedState with command ArchiveItem
      tell event ItemArchived to entity KnowledgeContext.KnowledgeItem
    }
    on command AddComment is {
      tell event CommentAdded to entity KnowledgeContext.KnowledgeItem
    }
    on command RateItem is {
      tell event ItemRated to entity KnowledgeContext.KnowledgeItem
    }
    on command RecordView is {
      tell event ViewRecorded to entity KnowledgeContext.KnowledgeItem
    }
    on command AddToCollection is {
      tell event AddedToCollection to entity KnowledgeContext.KnowledgeItem
    }
  } with {
    briefly "Processes knowledge item commands"
    described as {
      | Handles knowledge item lifecycle including creation,
      | review, publication, and engagement tracking.
    }
  }
} with {
  briefly "KnowledgeItem aggregate"
  described as {
    | The KnowledgeItem entity manages knowledge content
    | including review, publication, and user engagement.
  }
}
