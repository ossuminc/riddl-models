// Knowledge Management - KnowledgeItem Entity

entity KnowledgeItem is {

  // Commands
  command CreateItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "New item identifier."
    }
    content is KnowledgeContent with {
      briefly "Content"
      described by "Knowledge content."
    }
    metadata is KnowledgeMetadata with {
      briefly "Metadata"
      described by "Item metadata."
    }
  } with {
    briefly "Create item"
    described by "Creates a new knowledge item."
  }

  command UpdateItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item to update."
    }
    content is KnowledgeContent with {
      briefly "Content"
      described by "Updated content."
    }
    metadata is KnowledgeMetadata with {
      briefly "Metadata"
      described by "Updated metadata."
    }
  } with {
    briefly "Update item"
    described by "Updates knowledge item."
  }

  command SubmitForReview is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item to submit."
    }
    reviewerId is AuthorId with {
      briefly "Reviewer"
      described by "Requested reviewer."
    }
  } with {
    briefly "Submit for review"
    described by "Submits item for review."
  }

  command ReviewItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item to review."
    }
    review is ContentReview with {
      briefly "Review"
      described by "Review details."
    }
  } with {
    briefly "Review item"
    described by "Reviews knowledge item."
  }

  command PublishItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item to publish."
    }
  } with {
    briefly "Publish item"
    described by "Publishes knowledge item."
  }

  command ArchiveItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item to archive."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Archive reason."
    }
  } with {
    briefly "Archive item"
    described by "Archives knowledge item."
  }

  command AddComment is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item ID."
    }
    comment is ContentComment with {
      briefly "Comment"
      described by "Comment to add."
    }
  } with {
    briefly "Add comment"
    described by "Adds comment to item."
  }

  command RateItem is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item ID."
    }
    userId is AuthorId with {
      briefly "User"
      described by "Rating user."
    }
    rating is Natural with {
      briefly "Rating"
      described by "Rating value (1-5)."
    }
  } with {
    briefly "Rate item"
    described by "Rates knowledge item."
  }

  command RecordView is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item ID."
    }
    userId is AuthorId with {
      briefly "User"
      described by "Viewing user."
    }
  } with {
    briefly "Record view"
    described by "Records item view."
  }

  command AddToCollection is {
    itemId is KnowledgeItemId with {
      briefly "Item ID"
      described by "Item ID."
    }
    collectionId is CollectionId with {
      briefly "Collection"
      described by "Target collection."
    }
  } with {
    briefly "Add to collection"
    described by "Adds item to collection."
  }

  // Events
  event ItemCreated is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    content is KnowledgeContent with { briefly "Content" described by "Item content." }
    metadata is KnowledgeMetadata with { briefly "Metadata" described by "Item metadata." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Item was created"
    described by "Emitted when item is created."
  }

  event ItemUpdated is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    content is KnowledgeContent with { briefly "Content" described by "Updated content." }
    metadata is KnowledgeMetadata with { briefly "Metadata" described by "Updated metadata." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Item was updated"
    described by "Emitted when item is updated."
  }

  event ItemSubmittedForReview is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    reviewerId is AuthorId with { briefly "Reviewer" described by "Reviewer ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Item was submitted for review"
    described by "Emitted when item enters review."
  }

  event ItemReviewed is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    review is ContentReview with { briefly "Review" described by "Review details." }
    reviewedAt is TimeStamp with { briefly "Reviewed" described by "Review time." }
  } with {
    briefly "Item was reviewed"
    described by "Emitted when item is reviewed."
  }

  event ItemPublished is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    publishedAt is TimeStamp with { briefly "Published" described by "Publication time." }
  } with {
    briefly "Item was published"
    described by "Emitted when item is published."
  }

  event ItemArchived is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    reason is optional String(1, 500) with { briefly "Reason" described by "Archive reason." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Item was archived"
    described by "Emitted when item is archived."
  }

  event CommentAdded is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    comment is ContentComment with { briefly "Comment" described by "Added comment." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Comment was added"
    described by "Emitted when comment is added."
  }

  event ItemRated is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    userId is AuthorId with { briefly "User" described by "Rating user." }
    rating is Natural with { briefly "Rating" described by "Rating value." }
    ratedAt is TimeStamp with { briefly "Rated" described by "Rating time." }
  } with {
    briefly "Item was rated"
    described by "Emitted when item is rated."
  }

  event ViewRecorded is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    userId is AuthorId with { briefly "User" described by "Viewing user." }
    viewedAt is TimeStamp with { briefly "Viewed" described by "View time." }
  } with {
    briefly "View was recorded"
    described by "Emitted when item is viewed."
  }

  event AddedToCollection is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    collectionId is CollectionId with { briefly "Collection" described by "Collection ID." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Item was added to collection"
    described by "Emitted when item joins collection."
  }

  // State Records
  record DraftItemData is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    content is KnowledgeContent with { briefly "Content" described by "Item content." }
    metadata is KnowledgeMetadata with { briefly "Metadata" described by "Item metadata." }
    reviews is many ContentReview with { briefly "Reviews" described by "Review history." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft item data"
    described by "State data for draft item."
  }

  record PublishedItemData is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    content is KnowledgeContent with { briefly "Content" described by "Item content." }
    metadata is KnowledgeMetadata with { briefly "Metadata" described by "Item metadata." }
    engagement is UserEngagement with { briefly "Engagement" described by "Engagement metrics." }
    comments is many ContentComment with { briefly "Comments" described by "Item comments." }
    collections is many CollectionId with { briefly "Collections" described by "Containing collections." }
    publishedAt is TimeStamp with { briefly "Published" described by "Publication time." }
  } with {
    briefly "Published item data"
    described by "State data for published item."
  }

  record ArchivedItemData is {
    itemId is KnowledgeItemId with { briefly "Item" described by "Item ID." }
    content is KnowledgeContent with { briefly "Content" described by "Item content." }
    metadata is KnowledgeMetadata with { briefly "Metadata" described by "Item metadata." }
    reason is optional String(1, 500) with { briefly "Reason" described by "Archive reason." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Archived item data"
    described by "State data for archived item."
  }

  // States
  state DraftState of KnowledgeItem.DraftItemData with {
    briefly "Item is draft"
    described by "Knowledge item in draft state."
  }

  state PublishedState of KnowledgeItem.PublishedItemData with {
    briefly "Item is published"
    described by "Knowledge item is published."
  }

  state ArchivedState of KnowledgeItem.ArchivedItemData with {
    briefly "Item is archived"
    described by "Knowledge item is archived."
  }

  // Handler
  handler KnowledgeItemHandler is {
    on command CreateItem {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.DraftState with command CreateItem
      tell event ItemCreated to entity KnowledgeContext.KnowledgeItem
    }

    on command UpdateItem {
      tell event ItemUpdated to entity KnowledgeContext.KnowledgeItem
    }

    on command SubmitForReview {
      tell event ItemSubmittedForReview to entity KnowledgeContext.KnowledgeItem
    }

    on command ReviewItem {
      tell event ItemReviewed to entity KnowledgeContext.KnowledgeItem
    }

    on command PublishItem {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.PublishedState with command PublishItem
      tell event ItemPublished to entity KnowledgeContext.KnowledgeItem
    }

    on command ArchiveItem {
      morph entity KnowledgeContext.KnowledgeItem to state KnowledgeContext.KnowledgeItem.ArchivedState with command ArchiveItem
      tell event ItemArchived to entity KnowledgeContext.KnowledgeItem
    }

    on command AddComment {
      tell event CommentAdded to entity KnowledgeContext.KnowledgeItem
    }

    on command RateItem {
      tell event ItemRated to entity KnowledgeContext.KnowledgeItem
    }

    on command RecordView {
      tell event ViewRecorded to entity KnowledgeContext.KnowledgeItem
    }

    on command AddToCollection {
      tell event AddedToCollection to entity KnowledgeContext.KnowledgeItem
    }
  } with {
    briefly "Processes knowledge item commands"
    described by {
      | Handles knowledge item lifecycle including creation,
      | review, publication, and engagement tracking.
    }
  }

} with {
  briefly "KnowledgeItem aggregate"
  described by {
    | The KnowledgeItem entity manages knowledge content
    | including review, publication, and user engagement.
  }
}
