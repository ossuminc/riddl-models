// Engagement Management - Engagement Entity

entity Engagement is {

  // Commands
  command CreateEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "New engagement identifier."
    }
    info is EngagementInfo with {
      briefly "Info"
      described by "Engagement information."
    }
    clientInfo is ClientInfo with {
      briefly "Client"
      described by "Client details."
    }
  } with {
    briefly "Create engagement"
    described by "Creates a new client engagement."
  }

  command UpdateEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement to update."
    }
    info is EngagementInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update engagement"
    described by "Updates engagement details."
  }

  command ApproveEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement to approve."
    }
    approvedBy is String(1, 200) with {
      briefly "Approved by"
      described by "Approver name."
    }
  } with {
    briefly "Approve engagement"
    described by "Approves engagement to proceed."
  }

  command StartEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement to start."
    }
  } with {
    briefly "Start engagement"
    described by "Begins active delivery."
  }

  command AssignTeamMember is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    assignment is TeamAssignment with {
      briefly "Assignment"
      described by "Team assignment."
    }
  } with {
    briefly "Assign team member"
    described by "Assigns consultant to engagement."
  }

  command RemoveTeamMember is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    consultantId is ConsultantId with {
      briefly "Consultant"
      described by "Consultant to remove."
    }
  } with {
    briefly "Remove team member"
    described by "Removes consultant from engagement."
  }

  command AddDeliverable is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    deliverable is Deliverable with {
      briefly "Deliverable"
      described by "Deliverable to add."
    }
  } with {
    briefly "Add deliverable"
    described by "Adds deliverable to engagement."
  }

  command UpdateDeliverableStatus is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    deliverableId is DeliverableId with {
      briefly "Deliverable ID"
      described by "Deliverable to update."
    }
    status is DeliverableStatus with {
      briefly "Status"
      described by "New status."
    }
  } with {
    briefly "Update deliverable"
    described by "Updates deliverable status."
  }

  command AddMilestone is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    milestone is Milestone with {
      briefly "Milestone"
      described by "Milestone to add."
    }
  } with {
    briefly "Add milestone"
    described by "Adds milestone to engagement."
  }

  command CompleteMilestone is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    milestoneId is MilestoneId with {
      briefly "Milestone ID"
      described by "Milestone to complete."
    }
  } with {
    briefly "Complete milestone"
    described by "Marks milestone as completed."
  }

  command RecordTime is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    entry is TimeEntry with {
      briefly "Entry"
      described by "Time entry."
    }
  } with {
    briefly "Record time"
    described by "Records consultant time."
  }

  command ApproveTimeEntry is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    entryId is UUID with {
      briefly "Entry ID"
      described by "Entry to approve."
    }
  } with {
    briefly "Approve time"
    described by "Approves time entry."
  }

  command PutOnHold is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Put on hold"
    described by "Puts engagement on hold."
  }

  command ResumeEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement to resume."
    }
  } with {
    briefly "Resume engagement"
    described by "Resumes held engagement."
  }

  command CompleteEngagement is {
    engagementId is EngagementId with {
      briefly "Engagement ID"
      described by "Engagement to complete."
    }
    summary is optional String(1, 2000) with {
      briefly "Summary"
      described by "Completion summary."
    }
  } with {
    briefly "Complete engagement"
    described by "Marks engagement as completed."
  }

  // Events
  event EngagementCreated is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    info is EngagementInfo with { briefly "Info" described by "Engagement info." }
    clientInfo is ClientInfo with { briefly "Client" described by "Client info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Engagement was created"
    described by "Emitted when engagement is created."
  }

  event EngagementUpdated is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    info is EngagementInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Engagement was updated"
    described by "Emitted when engagement is updated."
  }

  event EngagementApproved is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    approvedBy is String(1, 200) with { briefly "Approved by" described by "Approver." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Engagement was approved"
    described by "Emitted when engagement is approved."
  }

  event EngagementStarted is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Engagement was started"
    described by "Emitted when delivery begins."
  }

  event TeamMemberAssigned is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    assignment is TeamAssignment with { briefly "Assignment" described by "Team assignment." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Team member was assigned"
    described by "Emitted when consultant is assigned."
  }

  event TeamMemberRemoved is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    consultantId is ConsultantId with { briefly "Consultant" described by "Removed consultant." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Team member was removed"
    described by "Emitted when consultant is removed."
  }

  event DeliverableAdded is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    deliverable is Deliverable with { briefly "Deliverable" described by "Added deliverable." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Deliverable was added"
    described by "Emitted when deliverable is added."
  }

  event DeliverableStatusUpdated is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    deliverableId is DeliverableId with { briefly "Deliverable" described by "Deliverable ID." }
    status is DeliverableStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Deliverable status was updated"
    described by "Emitted when deliverable status changes."
  }

  event MilestoneAdded is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    milestone is Milestone with { briefly "Milestone" described by "Added milestone." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Milestone was added"
    described by "Emitted when milestone is added."
  }

  event MilestoneCompleted is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    milestoneId is MilestoneId with { briefly "Milestone" described by "Milestone ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Milestone was completed"
    described by "Emitted when milestone is completed."
  }

  event TimeRecorded is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    entry is TimeEntry with { briefly "Entry" described by "Time entry." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Time was recorded"
    described by "Emitted when time is logged."
  }

  event TimeEntryApproved is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    entryId is UUID with { briefly "Entry" described by "Entry ID." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Time entry was approved"
    described by "Emitted when time is approved."
  }

  event EngagementPutOnHold is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Engagement was put on hold"
    described by "Emitted when engagement is paused."
  }

  event EngagementResumed is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Engagement was resumed"
    described by "Emitted when engagement resumes."
  }

  event EngagementCompleted is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    summary is optional String(1, 2000) with { briefly "Summary" described by "Completion summary." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Engagement was completed"
    described by "Emitted when engagement finishes."
  }

  // State Records
  record ProposalStateData is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    info is EngagementInfo with { briefly "Info" described by "Engagement info." }
    clientInfo is ClientInfo with { briefly "Client" described by "Client info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Proposal state data"
    described by "State data for proposal stage."
  }

  record ActiveStateData is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    info is EngagementInfo with { briefly "Info" described by "Engagement info." }
    clientInfo is ClientInfo with { briefly "Client" described by "Client info." }
    team is many TeamAssignment with { briefly "Team" described by "Team assignments." }
    deliverables is many Deliverable with { briefly "Deliverables" described by "Deliverables." }
    milestones is many Milestone with { briefly "Milestones" described by "Milestones." }
    timeEntries is many TimeEntry with { briefly "Time" described by "Time entries." }
    financials is EngagementFinancials with { briefly "Financials" described by "Financial data." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Active state data"
    described by "State data for active engagement."
  }

  record CompletedStateData is {
    engagementId is EngagementId with { briefly "Engagement" described by "Engagement ID." }
    info is EngagementInfo with { briefly "Info" described by "Engagement info." }
    clientInfo is ClientInfo with { briefly "Client" described by "Client info." }
    financials is EngagementFinancials with { briefly "Financials" described by "Final financials." }
    summary is optional String(1, 2000) with { briefly "Summary" described by "Completion summary." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state data"
    described by "State data for completed engagement."
  }

  // States
  state ProposalState of Engagement.ProposalStateData with {
    briefly "Engagement is proposal"
    described by "Engagement is in proposal stage."
  }

  state ActiveState of Engagement.ActiveStateData with {
    briefly "Engagement is active"
    described by "Engagement is being delivered."
  }

  state CompletedState of Engagement.CompletedStateData with {
    briefly "Engagement is completed"
    described by "Engagement has finished."
  }

  // Handler
  handler EngagementHandler is {
    on command CreateEngagement {
      morph entity EngagementContext.Engagement to state EngagementContext.Engagement.ProposalState with command CreateEngagement
      tell event EngagementCreated to entity EngagementContext.Engagement
    }

    on command UpdateEngagement {
      tell event EngagementUpdated to entity EngagementContext.Engagement
    }

    on command ApproveEngagement {
      tell event EngagementApproved to entity EngagementContext.Engagement
    }

    on command StartEngagement {
      morph entity EngagementContext.Engagement to state EngagementContext.Engagement.ActiveState with command StartEngagement
      tell event EngagementStarted to entity EngagementContext.Engagement
    }

    on command AssignTeamMember {
      tell event TeamMemberAssigned to entity EngagementContext.Engagement
    }

    on command RemoveTeamMember {
      tell event TeamMemberRemoved to entity EngagementContext.Engagement
    }

    on command AddDeliverable {
      tell event DeliverableAdded to entity EngagementContext.Engagement
    }

    on command UpdateDeliverableStatus {
      tell event DeliverableStatusUpdated to entity EngagementContext.Engagement
    }

    on command AddMilestone {
      tell event MilestoneAdded to entity EngagementContext.Engagement
    }

    on command CompleteMilestone {
      tell event MilestoneCompleted to entity EngagementContext.Engagement
    }

    on command RecordTime {
      tell event TimeRecorded to entity EngagementContext.Engagement
    }

    on command ApproveTimeEntry {
      tell event TimeEntryApproved to entity EngagementContext.Engagement
    }

    on command PutOnHold {
      tell event EngagementPutOnHold to entity EngagementContext.Engagement
    }

    on command ResumeEngagement {
      tell event EngagementResumed to entity EngagementContext.Engagement
    }

    on command CompleteEngagement {
      morph entity EngagementContext.Engagement to state EngagementContext.Engagement.CompletedState with command CompleteEngagement
      tell event EngagementCompleted to entity EngagementContext.Engagement
    }
  } with {
    briefly "Processes engagement commands"
    described by {
      | Handles engagement lifecycle including staffing,
      | deliverables, milestones, and time tracking.
    }
  }

} with {
  briefly "Engagement aggregate"
  described by {
    | The Engagement entity manages client engagements
    | including team, deliverables, and financials.
  }
}
