// Design Review - Review Entity

entity Review is {

  // Commands
  command SubmitReview is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "New review identifier."
    }
    info is ReviewInfo with {
      briefly "Info"
      described by "Review information."
    }
    documents is many DesignDocument with {
      briefly "Documents"
      described by "Design documents."
    }
  } with {
    briefly "Submit review"
    described by "Submits a design for review."
  }

  command AssignReviewer is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    assignment is ReviewerAssignment with {
      briefly "Assignment"
      described by "Reviewer assignment."
    }
  } with {
    briefly "Assign reviewer"
    described by "Assigns a reviewer to the review."
  }

  command StartReview is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review to start."
    }
    startedBy is EngineerId with {
      briefly "Started by"
      described by "Initiating coordinator."
    }
  } with {
    briefly "Start review"
    described by "Begins the review process."
  }

  command AddComment is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    comment is ReviewComment with {
      briefly "Comment"
      described by "Review comment."
    }
  } with {
    briefly "Add comment"
    described by "Adds a reviewer comment."
  }

  command RespondToComment is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    commentId is UUID with {
      briefly "Comment ID"
      described by "Comment to respond to."
    }
    response is String(1, 2000) with {
      briefly "Response"
      described by "Engineer response."
    }
  } with {
    briefly "Respond to comment"
    described by "Responds to a review comment."
  }

  command ResolveComment is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    commentId is UUID with {
      briefly "Comment ID"
      described by "Comment to resolve."
    }
    status is CommentStatus with {
      briefly "Status"
      described by "Resolution status."
    }
  } with {
    briefly "Resolve comment"
    described by "Resolves a review comment."
  }

  command RecordDecision is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    decision is ReviewDecision with {
      briefly "Decision"
      described by "Review decision."
    }
  } with {
    briefly "Record decision"
    described by "Records a reviewer decision."
  }

  command RequestRevision is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    requestedBy is EngineerId with {
      briefly "Requested by"
      described by "Requesting reviewer."
    }
    reason is String(1, 2000) with {
      briefly "Reason"
      described by "Revision reason."
    }
  } with {
    briefly "Request revision"
    described by "Requests design revision."
  }

  command SubmitRevision is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review identifier."
    }
    newVersion is String(1, 50) with {
      briefly "Version"
      described by "New design version."
    }
    changes is String(1, 2000) with {
      briefly "Changes"
      described by "Changes made."
    }
    documents is many DesignDocument with {
      briefly "Documents"
      described by "Updated documents."
    }
  } with {
    briefly "Submit revision"
    described by "Submits revised design."
  }

  command FinalizeReview is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review to finalize."
    }
    finalizedBy is EngineerId with {
      briefly "Finalized by"
      described by "Finalizing coordinator."
    }
    outcome is ReviewOutcome with {
      briefly "Outcome"
      described by "Final outcome."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Review summary."
    }
  } with {
    briefly "Finalize review"
    described by "Completes the review process."
  }

  command CancelReview is {
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel review"
    described by "Cancels the design review."
  }

  // Events
  event ReviewSubmitted is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    info is ReviewInfo with { briefly "Info" described by "Review info." }
    documents is many DesignDocument with { briefly "Documents" described by "Design documents." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Review was submitted"
    described by "Emitted when review is submitted."
  }

  event ReviewerAssigned is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    assignment is ReviewerAssignment with { briefly "Assignment" described by "Reviewer assignment." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Reviewer was assigned"
    described by "Emitted when reviewer is assigned."
  }

  event ReviewStarted is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    startedBy is EngineerId with { briefly "Started by" described by "Initiator." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Review was started"
    described by "Emitted when review begins."
  }

  event CommentAdded is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    comment is ReviewComment with { briefly "Comment" described by "New comment." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Comment was added"
    described by "Emitted when comment is added."
  }

  event CommentResponded is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    commentId is UUID with { briefly "Comment" described by "Comment ID." }
    response is String(1, 2000) with { briefly "Response" described by "Response text." }
    respondedAt is TimeStamp with { briefly "Responded" described by "Response time." }
  } with {
    briefly "Comment was responded"
    described by "Emitted when comment receives response."
  }

  event CommentResolved is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    commentId is UUID with { briefly "Comment" described by "Comment ID." }
    status is CommentStatus with { briefly "Status" described by "Resolution status." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Comment was resolved"
    described by "Emitted when comment is resolved."
  }

  event DecisionRecorded is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    decision is ReviewDecision with { briefly "Decision" described by "Review decision." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Decision was recorded"
    described by "Emitted when decision is made."
  }

  event RevisionRequested is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    requestedBy is EngineerId with { briefly "Requested by" described by "Requester." }
    reason is String(1, 2000) with { briefly "Reason" described by "Revision reason." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Revision was requested"
    described by "Emitted when revision is requested."
  }

  event RevisionSubmitted is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    newVersion is String(1, 50) with { briefly "Version" described by "New version." }
    changes is String(1, 2000) with { briefly "Changes" described by "Changes made." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Revision was submitted"
    described by "Emitted when revision is submitted."
  }

  event ReviewFinalized is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    outcome is ReviewOutcome with { briefly "Outcome" described by "Final outcome." }
    summary is String(1, 2000) with { briefly "Summary" described by "Review summary." }
    finalizedAt is TimeStamp with { briefly "Finalized" described by "Finalization time." }
  } with {
    briefly "Review was finalized"
    described by "Emitted when review is completed."
  }

  event ReviewCancelled is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Review was cancelled"
    described by "Emitted when review is cancelled."
  }

  // State Records
  record DraftStateData is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    info is ReviewInfo with { briefly "Info" described by "Review info." }
    documents is many DesignDocument with { briefly "Documents" described by "Design documents." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft state data"
    described by "State data for draft review."
  }

  record ActiveStateData is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    info is ReviewInfo with { briefly "Info" described by "Review info." }
    reviewStatus is ReviewStatus with { briefly "Status" described by "Current status." }
    documents is many DesignDocument with { briefly "Documents" described by "Design documents." }
    reviewers is many ReviewerAssignment with { briefly "Reviewers" described by "Assigned reviewers." }
    comments is many ReviewComment with { briefly "Comments" described by "Review comments." }
    decisions is many ReviewDecision with { briefly "Decisions" described by "Review decisions." }
    revisionCount is Natural with { briefly "Revisions" described by "Revision count." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Active state data"
    described by "State data for active review."
  }

  record CompletedStateData is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    info is ReviewInfo with { briefly "Info" described by "Review info." }
    outcome is ReviewOutcome with { briefly "Outcome" described by "Final outcome." }
    summary is String(1, 2000) with { briefly "Summary" described by "Review summary." }
    comments is many ReviewComment with { briefly "Comments" described by "Review comments." }
    decisions is many ReviewDecision with { briefly "Decisions" described by "Review decisions." }
    finalizedAt is TimeStamp with { briefly "Finalized" described by "Finalization time." }
  } with {
    briefly "Completed state data"
    described by "State data for completed review."
  }

  record CancelledStateData is {
    reviewId is ReviewId with { briefly "Review" described by "Review ID." }
    info is ReviewInfo with { briefly "Info" described by "Review info." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Cancelled state data"
    described by "State data for cancelled review."
  }

  // States
  state DraftState of Review.DraftStateData with {
    briefly "Review in draft"
    described by "Review is being prepared."
  }

  state ActiveState of Review.ActiveStateData with {
    briefly "Review is active"
    described by "Review is under evaluation."
  }

  state CompletedState of Review.CompletedStateData with {
    briefly "Review is completed"
    described by "Review has been finalized."
  }

  state CancelledState of Review.CancelledStateData with {
    briefly "Review is cancelled"
    described by "Review has been cancelled."
  }

  // Handler
  handler ReviewHandler is {
    on command SubmitReview {
      morph entity ReviewContext.Review to state ReviewContext.Review.DraftState with command SubmitReview
      tell event ReviewSubmitted to entity ReviewContext.Review
    }

    on command AssignReviewer {
      tell event ReviewerAssigned to entity ReviewContext.Review
    }

    on command StartReview {
      morph entity ReviewContext.Review to state ReviewContext.Review.ActiveState with command StartReview
      tell event ReviewStarted to entity ReviewContext.Review
    }

    on command AddComment {
      tell event CommentAdded to entity ReviewContext.Review
    }

    on command RespondToComment {
      tell event CommentResponded to entity ReviewContext.Review
    }

    on command ResolveComment {
      tell event CommentResolved to entity ReviewContext.Review
    }

    on command RecordDecision {
      tell event DecisionRecorded to entity ReviewContext.Review
    }

    on command RequestRevision {
      tell event RevisionRequested to entity ReviewContext.Review
    }

    on command SubmitRevision {
      tell event RevisionSubmitted to entity ReviewContext.Review
    }

    on command FinalizeReview {
      morph entity ReviewContext.Review to state ReviewContext.Review.CompletedState with command FinalizeReview
      tell event ReviewFinalized to entity ReviewContext.Review
    }

    on command CancelReview {
      morph entity ReviewContext.Review to state ReviewContext.Review.CancelledState with command CancelReview
      tell event ReviewCancelled to entity ReviewContext.Review
    }
  } with {
    briefly "Processes review commands"
    described by {
      | Handles design review lifecycle including comments,
      | decisions, revisions, and finalization.
    }
  }

} with {
  briefly "Design review aggregate"
  described by {
    | The Review entity manages design review processes
    | including reviewer assignments, comments, and approvals.
  }
}
