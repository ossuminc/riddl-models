// Design Review - Review Entity
entity Review is {
  // Commands
  command SubmitReview is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |New review identifier.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review information.
      }
    }
    documents: DesignDocument+ with {
      briefly "Documents"
      described as {
        |Design documents.
      }
    }
  } with {
    briefly "Submit review"
    described as {
      |Submits a design for review.
    }
  }
  command AssignReviewer is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    assignment: ReviewerAssignment with {
      briefly "Assignment"
      described as {
        |Reviewer assignment.
      }
    }
  } with {
    briefly "Assign reviewer"
    described as {
      |Assigns a reviewer to the review.
    }
  }
  command StartReview is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review to start.
      }
    }
    startedBy: EngineerId with {
      briefly "Started by"
      described as {
        |Initiating coordinator.
      }
    }
  } with {
    briefly "Start review"
    described as {
      |Begins the review process.
    }
  }
  command AddComment is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    comment: ReviewComment with {
      briefly "Comment"
      described as {
        |Review comment.
      }
    }
  } with {
    briefly "Add comment"
    described as {
      |Adds a reviewer comment.
    }
  }
  command RespondToComment is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    commentId: UUID with {
      briefly "Comment ID"
      described as {
        |Comment to respond to.
      }
    }
    response: String(1,2000) with {
      briefly "Response"
      described as {
        |Engineer response.
      }
    }
  } with {
    briefly "Respond to comment"
    described as {
      |Responds to a review comment.
    }
  }
  command ResolveComment is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    commentId: UUID with {
      briefly "Comment ID"
      described as {
        |Comment to resolve.
      }
    }
    status: CommentStatus with {
      briefly "Status"
      described as {
        |Resolution status.
      }
    }
  } with {
    briefly "Resolve comment"
    described as {
      |Resolves a review comment.
    }
  }
  command RecordDecision is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    decision: ReviewDecision with {
      briefly "Decision"
      described as {
        |Review decision.
      }
    }
  } with {
    briefly "Record decision"
    described as {
      |Records a reviewer decision.
    }
  }
  command RequestRevision is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    requestedBy: EngineerId with {
      briefly "Requested by"
      described as {
        |Requesting reviewer.
      }
    }
    reason: String(1,2000) with {
      briefly "Reason"
      described as {
        |Revision reason.
      }
    }
  } with {
    briefly "Request revision"
    described as {
      |Requests design revision.
    }
  }
  command SubmitRevision is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review identifier.
      }
    }
    newVersion: String(1,50) with {
      briefly "Version"
      described as {
        |New design version.
      }
    }
    changes: String(1,2000) with {
      briefly "Changes"
      described as {
        |Changes made.
      }
    }
    documents: DesignDocument+ with {
      briefly "Documents"
      described as {
        |Updated documents.
      }
    }
  } with {
    briefly "Submit revision"
    described as {
      |Submits revised design.
    }
  }
  command FinalizeReview is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review to finalize.
      }
    }
    finalizedBy: EngineerId with {
      briefly "Finalized by"
      described as {
        |Finalizing coordinator.
      }
    }
    outcome: ReviewOutcome with {
      briefly "Outcome"
      described as {
        |Final outcome.
      }
    }
    summary: String(1,2000) with {
      briefly "Summary"
      described as {
        |Review summary.
      }
    }
  } with {
    briefly "Finalize review"
    described as {
      |Completes the review process.
    }
  }
  command CancelReview is  {
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review to cancel.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel review"
    described as {
      |Cancels the design review.
    }
  }
  // Events
  event ReviewSubmitted is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review info.
      }
    }
    documents: DesignDocument+ with {
      briefly "Documents"
      described as {
        |Design documents.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Review was submitted"
    described as {
      |Emitted when review is submitted.
    }
  }
  event ReviewerAssigned is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    assignment: ReviewerAssignment with {
      briefly "Assignment"
      described as {
        |Reviewer assignment.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Reviewer was assigned"
    described as {
      |Emitted when reviewer is assigned.
    }
  }
  event ReviewStarted is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    startedBy: EngineerId with {
      briefly "Started by"
      described as {
        |Initiator.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Review was started"
    described as {
      |Emitted when review begins.
    }
  }
  event CommentAdded is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    comment: ReviewComment with {
      briefly "Comment"
      described as {
        |New comment.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Comment was added"
    described as {
      |Emitted when comment is added.
    }
  }
  event CommentResponded is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    commentId: UUID with {
      briefly "Comment"
      described as {
        |Comment ID.
      }
    }
    response: String(1,2000) with {
      briefly "Response"
      described as {
        |Response text.
      }
    }
    respondedAt: TimeStamp with {
      briefly "Responded"
      described as {
        |Response time.
      }
    }
  } with {
    briefly "Comment was responded"
    described as {
      |Emitted when comment receives response.
    }
  }
  event CommentResolved is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    commentId: UUID with {
      briefly "Comment"
      described as {
        |Comment ID.
      }
    }
    status: CommentStatus with {
      briefly "Status"
      described as {
        |Resolution status.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Comment was resolved"
    described as {
      |Emitted when comment is resolved.
    }
  }
  event DecisionRecorded is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    decision: ReviewDecision with {
      briefly "Decision"
      described as {
        |Review decision.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Decision was recorded"
    described as {
      |Emitted when decision is made.
    }
  }
  event RevisionRequested is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    requestedBy: EngineerId with {
      briefly "Requested by"
      described as {
        |Requester.
      }
    }
    reason: String(1,2000) with {
      briefly "Reason"
      described as {
        |Revision reason.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Revision was requested"
    described as {
      |Emitted when revision is requested.
    }
  }
  event RevisionSubmitted is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    newVersion: String(1,50) with {
      briefly "Version"
      described as {
        |New version.
      }
    }
    changes: String(1,2000) with {
      briefly "Changes"
      described as {
        |Changes made.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Revision was submitted"
    described as {
      |Emitted when revision is submitted.
    }
  }
  event ReviewFinalized is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    outcome: ReviewOutcome with {
      briefly "Outcome"
      described as {
        |Final outcome.
      }
    }
    summary: String(1,2000) with {
      briefly "Summary"
      described as {
        |Review summary.
      }
    }
    finalizedAt: TimeStamp with {
      briefly "Finalized"
      described as {
        |Finalization time.
      }
    }
  } with {
    briefly "Review was finalized"
    described as {
      |Emitted when review is completed.
    }
  }
  event ReviewCancelled is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Review was cancelled"
    described as {
      |Emitted when review is cancelled.
    }
  }
  // State Records
  record DraftStateData is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review info.
      }
    }
    documents: DesignDocument+ with {
      briefly "Documents"
      described as {
        |Design documents.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Draft state data"
    described as {
      |State data for draft review.
    }
  }
  record ActiveStateData is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review info.
      }
    }
    reviewStatus: ReviewStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    documents: DesignDocument+ with {
      briefly "Documents"
      described as {
        |Design documents.
      }
    }
    reviewers: ReviewerAssignment+ with {
      briefly "Reviewers"
      described as {
        |Assigned reviewers.
      }
    }
    comments: ReviewComment+ with {
      briefly "Comments"
      described as {
        |Review comments.
      }
    }
    decisions: ReviewDecision+ with {
      briefly "Decisions"
      described as {
        |Review decisions.
      }
    }
    revisionCount: Natural with {
      briefly "Revisions"
      described as {
        |Revision count.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active review.
    }
  }
  record CompletedStateData is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review info.
      }
    }
    outcome: ReviewOutcome with {
      briefly "Outcome"
      described as {
        |Final outcome.
      }
    }
    summary: String(1,2000) with {
      briefly "Summary"
      described as {
        |Review summary.
      }
    }
    comments: ReviewComment+ with {
      briefly "Comments"
      described as {
        |Review comments.
      }
    }
    decisions: ReviewDecision+ with {
      briefly "Decisions"
      described as {
        |Review decisions.
      }
    }
    finalizedAt: TimeStamp with {
      briefly "Finalized"
      described as {
        |Finalization time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |State data for completed review.
    }
  }
  record CancelledStateData is  {
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review ID.
      }
    }
    info: ReviewInfo with {
      briefly "Info"
      described as {
        |Review info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancellation time.
      }
    }
  } with {
    briefly "Cancelled state data"
    described as {
      |State data for cancelled review.
    }
  }
  // States
  state DraftState of type Review.DraftStateData
  state ActiveState of type Review.ActiveStateData
  state CompletedState of type Review.CompletedStateData
  state CancelledState of type Review.CancelledStateData
  // Handler
  handler ReviewHandler is {
    on command SubmitReview is {
      morph entity ReviewContext.Review to state ReviewContext.Review.DraftState with command SubmitReview
      tell event ReviewSubmitted to entity ReviewContext.Review
    }
    on command AssignReviewer is {
      tell event ReviewerAssigned to entity ReviewContext.Review
    }
    on command StartReview is {
      morph entity ReviewContext.Review to state ReviewContext.Review.ActiveState with command StartReview
      tell event ReviewStarted to entity ReviewContext.Review
    }
    on command AddComment is {
      tell event CommentAdded to entity ReviewContext.Review
    }
    on command RespondToComment is {
      tell event CommentResponded to entity ReviewContext.Review
    }
    on command ResolveComment is {
      tell event CommentResolved to entity ReviewContext.Review
    }
    on command RecordDecision is {
      tell event DecisionRecorded to entity ReviewContext.Review
    }
    on command RequestRevision is {
      tell event RevisionRequested to entity ReviewContext.Review
    }
    on command SubmitRevision is {
      tell event RevisionSubmitted to entity ReviewContext.Review
    }
    on command FinalizeReview is {
      morph entity ReviewContext.Review to state ReviewContext.Review.CompletedState with command FinalizeReview
      tell event ReviewFinalized to entity ReviewContext.Review
    }
    on command CancelReview is {
      morph entity ReviewContext.Review to state ReviewContext.Review.CancelledState with command CancelReview
      tell event ReviewCancelled to entity ReviewContext.Review
    }
  } with {
    briefly "Processes review commands"
    described as {
      | Handles design review lifecycle including comments,
      | decisions, revisions, and finalization.
    }
  }
} with {
  briefly "Design review aggregate"
  described as {
    | The Review entity manages design review processes
    | including reviewer assignments, comments, and approvals.
  }
}
