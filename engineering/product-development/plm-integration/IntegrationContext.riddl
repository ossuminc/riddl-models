// PLM Integration - Integration Context

context IntegrationContext is {

  include "types.riddl"
  include "Integration.riddl"

  // Repository for integration persistence
  repository IntegrationRepository is {
    schema IntegrationData is relational
      of integrations as Integration
      index on field Integration.integrationId
      index on field Integration.config.sourceSystemId

    handler IntegrationPersistence is {
      on command Integration.CreateIntegration {
        prompt "Store integration config"
      }
      on command Integration.UpdateIntegration {
        prompt "Update integration config"
      }
      on command Integration.RegisterSystem {
        prompt "Store system record"
      }
      on command Integration.StartSyncJob {
        prompt "Store sync job"
      }
      on command Integration.CancelSyncJob {
        prompt "Update sync job status"
      }
      on command Integration.ProcessChangeEvent {
        prompt "Log change event"
      }
    } with {
      briefly "Persists integration commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Integration data persistence"
    described by {
      | The IntegrationRepository provides persistent storage for
      | integrations, sync jobs, and change events.
    }
  }

  // Projector for integration analytics
  projector IntegrationAnalytics is {
    updates repository IntegrationRepository

    record IntegrationStats is {
      integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
      totalSyncs is Natural with { briefly "Syncs" described by "Total sync jobs." }
      successfulSyncs is Natural with { briefly "Successful" described by "Successful syncs." }
      totalRecords is Natural with { briefly "Records" described by "Total records synced." }
      averageLatency is Duration with { briefly "Latency" described by "Average sync time." }
    } with {
      briefly "Integration statistics"
      described by "Integration performance metrics."
    }

    handler AnalyticsHandler is {
      on event Integration.SyncJobStarted {
        prompt "Track sync start"
      }
      on event Integration.SyncJobCompleted {
        prompt "Update sync metrics"
      }
      on event Integration.ConnectionTested {
        prompt "Update connection metrics"
      }
      on event Integration.ProductSynced {
        prompt "Update record counts"
      }
    } with {
      briefly "Maintains integration analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Integration analytics projections"
    described by "Maintains integration analytics data."
  }

} with {
  briefly "Bounded context for PLM integration"
  described by {
    | The IntegrationContext is the bounded context for PLM
    | data synchronization and system orchestration.
  }
}
