// PLM Integration - Integration Entity

entity Integration is {

  // Commands
  command CreateIntegration is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "New integration identifier."
    }
    config is IntegrationConfig with {
      briefly "Config"
      described by "Integration configuration."
    }
  } with {
    briefly "Create integration"
    described by "Creates a new PLM integration."
  }

  command UpdateIntegration is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration to update."
    }
    config is IntegrationConfig with {
      briefly "Config"
      described by "Updated configuration."
    }
  } with {
    briefly "Update integration"
    described by "Updates integration configuration."
  }

  command EnableIntegration is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration to enable."
    }
  } with {
    briefly "Enable integration"
    described by "Enables integration for syncing."
  }

  command DisableIntegration is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration to disable."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Disable reason."
    }
  } with {
    briefly "Disable integration"
    described by "Disables integration temporarily."
  }

  command RegisterSystem is {
    system is ConnectedSystem with {
      briefly "System"
      described by "System to register."
    }
  } with {
    briefly "Register system"
    described by "Registers connected system."
  }

  command TestConnection is {
    systemId is SystemId with {
      briefly "System ID"
      described by "System to test."
    }
  } with {
    briefly "Test connection"
    described by "Tests system connectivity."
  }

  command SyncProduct is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration ID."
    }
    productId is ProductId with {
      briefly "Product"
      described by "Product to sync."
    }
  } with {
    briefly "Sync product"
    described by "Synchronizes specific product."
  }

  command StartSyncJob is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration ID."
    }
    syncEntityTypes is many optional DataEntityType with {
      briefly "Entities"
      described by "Entity types to sync."
    }
  } with {
    briefly "Start sync job"
    described by "Starts synchronization job."
  }

  command CancelSyncJob is {
    jobId is SyncJobId with {
      briefly "Job ID"
      described by "Job to cancel."
    }
  } with {
    briefly "Cancel sync job"
    described by "Cancels running sync job."
  }

  command ProcessChangeEvent is {
    event is DataChangeEvent with {
      briefly "Event"
      described by "Change event to process."
    }
  } with {
    briefly "Process change"
    described by "Processes data change event."
  }

  command UpdateFieldMapping is {
    integrationId is IntegrationId with {
      briefly "Integration ID"
      described by "Integration ID."
    }
    mapping is FieldMapping with {
      briefly "Mapping"
      described by "Updated field mapping."
    }
  } with {
    briefly "Update mapping"
    described by "Updates field mapping."
  }

  // Events
  event IntegrationCreated is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    config is IntegrationConfig with { briefly "Config" described by "Configuration." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Integration was created"
    described by "Emitted when integration is created."
  }

  event IntegrationUpdated is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    config is IntegrationConfig with { briefly "Config" described by "Updated config." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Integration was updated"
    described by "Emitted when integration is updated."
  }

  event IntegrationEnabled is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    enabledAt is TimeStamp with { briefly "Enabled" described by "Enable time." }
  } with {
    briefly "Integration was enabled"
    described by "Emitted when integration is enabled."
  }

  event IntegrationDisabled is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    reason is optional String(1, 500) with { briefly "Reason" described by "Disable reason." }
    disabledAt is TimeStamp with { briefly "Disabled" described by "Disable time." }
  } with {
    briefly "Integration was disabled"
    described by "Emitted when integration is disabled."
  }

  event SystemRegistered is {
    system is ConnectedSystem with { briefly "System" described by "Registered system." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "System was registered"
    described by "Emitted when system is registered."
  }

  event ConnectionTested is {
    systemId is SystemId with { briefly "System" described by "System ID." }
    success is Boolean with { briefly "Success" described by "Test result." }
    latencyMs is Natural with { briefly "Latency" described by "Response latency." }
    testedAt is TimeStamp with { briefly "Tested" described by "Test time." }
  } with {
    briefly "Connection was tested"
    described by "Emitted when connection is tested."
  }

  event ProductSynced is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    productId is ProductId with { briefly "Product" described by "Product ID." }
    success is Boolean with { briefly "Success" described by "Sync result." }
    syncedAt is TimeStamp with { briefly "Synced" described by "Sync time." }
  } with {
    briefly "Product was synced"
    described by "Emitted when product is synchronized."
  }

  event SyncJobStarted is {
    job is SyncJob with { briefly "Job" described by "Started job." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Sync job was started"
    described by "Emitted when sync job begins."
  }

  event SyncJobCompleted is {
    jobId is SyncJobId with { briefly "Job" described by "Job ID." }
    status is SyncStatus with { briefly "Status" described by "Final status." }
    recordsProcessed is Natural with { briefly "Processed" described by "Records processed." }
    recordsFailed is Natural with { briefly "Failed" described by "Records failed." }
    jobCompletedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Sync job was completed"
    described by "Emitted when sync job finishes."
  }

  event SyncJobCancelled is {
    jobId is SyncJobId with { briefly "Job" described by "Job ID." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Sync job was cancelled"
    described by "Emitted when sync job is cancelled."
  }

  event ChangeEventProcessed is {
    event is DataChangeEvent with { briefly "Event" described by "Processed event." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Change event was processed"
    described by "Emitted when change is processed."
  }

  event FieldMappingUpdated is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    mapping is FieldMapping with { briefly "Mapping" described by "Updated mapping." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Field mapping was updated"
    described by "Emitted when mapping is updated."
  }

  // State Records
  record ConfiguredStateData is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    config is IntegrationConfig with { briefly "Config" described by "Configuration." }
    systems is many ConnectedSystem with { briefly "Systems" described by "Connected systems." }
    syncJobs is many SyncJob with { briefly "Jobs" described by "Sync job history." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Configured state data"
    described by "State data for configured integration."
  }

  record ActiveStateData is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    config is IntegrationConfig with { briefly "Config" described by "Configuration." }
    systems is many ConnectedSystem with { briefly "Systems" described by "Connected systems." }
    syncJobs is many SyncJob with { briefly "Jobs" described by "Sync job history." }
    lastSyncAt is optional TimeStamp with { briefly "Last sync" described by "Last sync time." }
    enabledAt is TimeStamp with { briefly "Enabled" described by "Enable time." }
  } with {
    briefly "Active state data"
    described by "State data for active integration."
  }

  record DisabledStateData is {
    integrationId is IntegrationId with { briefly "Integration" described by "Integration ID." }
    config is IntegrationConfig with { briefly "Config" described by "Configuration." }
    reason is optional String(1, 500) with { briefly "Reason" described by "Disable reason." }
    disabledAt is TimeStamp with { briefly "Disabled" described by "Disable time." }
  } with {
    briefly "Disabled state data"
    described by "State data for disabled integration."
  }

  // States
  state ConfiguredState of Integration.ConfiguredStateData with {
    briefly "Integration is configured"
    described by "Integration is set up but not active."
  }

  state ActiveState of Integration.ActiveStateData with {
    briefly "Integration is active"
    described by "Integration is actively syncing."
  }

  state DisabledState of Integration.DisabledStateData with {
    briefly "Integration is disabled"
    described by "Integration is temporarily disabled."
  }

  // Handler
  handler IntegrationHandler is {
    on command CreateIntegration {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.ConfiguredState with command CreateIntegration
      tell event IntegrationCreated to entity IntegrationContext.Integration
    }

    on command UpdateIntegration {
      tell event IntegrationUpdated to entity IntegrationContext.Integration
    }

    on command EnableIntegration {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.ActiveState with command EnableIntegration
      tell event IntegrationEnabled to entity IntegrationContext.Integration
    }

    on command DisableIntegration {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.DisabledState with command DisableIntegration
      tell event IntegrationDisabled to entity IntegrationContext.Integration
    }

    on command RegisterSystem {
      tell event SystemRegistered to entity IntegrationContext.Integration
    }

    on command TestConnection {
      tell event ConnectionTested to entity IntegrationContext.Integration
    }

    on command SyncProduct {
      tell event ProductSynced to entity IntegrationContext.Integration
    }

    on command StartSyncJob {
      tell event SyncJobStarted to entity IntegrationContext.Integration
    }

    on command CancelSyncJob {
      tell event SyncJobCancelled to entity IntegrationContext.Integration
    }

    on command ProcessChangeEvent {
      tell event ChangeEventProcessed to entity IntegrationContext.Integration
    }

    on command UpdateFieldMapping {
      tell event FieldMappingUpdated to entity IntegrationContext.Integration
    }
  } with {
    briefly "Processes integration commands"
    described by {
      | Handles integration lifecycle including configuration,
      | sync operations, and change event processing.
    }
  }

} with {
  briefly "Integration aggregate"
  described by {
    | The Integration entity manages PLM integrations
    | including data synchronization and transformations.
  }
}
