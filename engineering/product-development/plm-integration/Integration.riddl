// PLM Integration - Integration Entity
entity Integration is {
  // Commands
  command CreateIntegration is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |New integration identifier.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Integration configuration.
      }
    }
  } with {
    briefly "Create integration"
    described as {
      |Creates a new PLM integration.
    }
  }
  command UpdateIntegration is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration to update.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Updated configuration.
      }
    }
  } with {
    briefly "Update integration"
    described as {
      |Updates integration configuration.
    }
  }
  command EnableIntegration is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration to enable.
      }
    }
  } with {
    briefly "Enable integration"
    described as {
      |Enables integration for syncing.
    }
  }
  command DisableIntegration is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration to disable.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Disable reason.
      }
    }
  } with {
    briefly "Disable integration"
    described as {
      |Disables integration temporarily.
    }
  }
  command RegisterSystem is  {
    system: ConnectedSystem with {
      briefly "System"
      described as {
        |System to register.
      }
    }
  } with {
    briefly "Register system"
    described as {
      |Registers connected system.
    }
  }
  command TestConnection is  {
    systemId: SystemId with {
      briefly "System ID"
      described as {
        |System to test.
      }
    }
  } with {
    briefly "Test connection"
    described as {
      |Tests system connectivity.
    }
  }
  command SyncProduct is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration ID.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Product to sync.
      }
    }
  } with {
    briefly "Sync product"
    described as {
      |Synchronizes specific product.
    }
  }
  command StartSyncJob is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration ID.
      }
    }
    syncEntityTypes: DataEntityType* with {
      briefly "Entities"
      described as {
        |Entity types to sync.
      }
    }
  } with {
    briefly "Start sync job"
    described as {
      |Starts synchronization job.
    }
  }
  command CancelSyncJob is  {
    jobId: SyncJobId with {
      briefly "Job ID"
      described as {
        |Job to cancel.
      }
    }
  } with {
    briefly "Cancel sync job"
    described as {
      |Cancels running sync job.
    }
  }
  command ProcessChangeEvent is  {
    event: DataChangeEvent with {
      briefly "Event"
      described as {
        |Change event to process.
      }
    }
  } with {
    briefly "Process change"
    described as {
      |Processes data change event.
    }
  }
  command UpdateFieldMapping is  {
    integrationId: IntegrationId with {
      briefly "Integration ID"
      described as {
        |Integration ID.
      }
    }
    mapping: FieldMapping with {
      briefly "Mapping"
      described as {
        |Updated field mapping.
      }
    }
  } with {
    briefly "Update mapping"
    described as {
      |Updates field mapping.
    }
  }
  // Events
  event IntegrationCreated is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Configuration.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Integration was created"
    described as {
      |Emitted when integration is created.
    }
  }
  event IntegrationUpdated is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Updated config.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Integration was updated"
    described as {
      |Emitted when integration is updated.
    }
  }
  event IntegrationEnabled is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    enabledAt: TimeStamp with {
      briefly "Enabled"
      described as {
        |Enable time.
      }
    }
  } with {
    briefly "Integration was enabled"
    described as {
      |Emitted when integration is enabled.
    }
  }
  event IntegrationDisabled is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Disable reason.
      }
    }
    disabledAt: TimeStamp with {
      briefly "Disabled"
      described as {
        |Disable time.
      }
    }
  } with {
    briefly "Integration was disabled"
    described as {
      |Emitted when integration is disabled.
    }
  }
  event SystemRegistered is  {
    system: ConnectedSystem with {
      briefly "System"
      described as {
        |Registered system.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "System was registered"
    described as {
      |Emitted when system is registered.
    }
  }
  event ConnectionTested is  {
    systemId: SystemId with {
      briefly "System"
      described as {
        |System ID.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Test result.
      }
    }
    latencyMs: Natural with {
      briefly "Latency"
      described as {
        |Response latency.
      }
    }
    testedAt: TimeStamp with {
      briefly "Tested"
      described as {
        |Test time.
      }
    }
  } with {
    briefly "Connection was tested"
    described as {
      |Emitted when connection is tested.
    }
  }
  event ProductSynced is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    productId: ProductId with {
      briefly "Product"
      described as {
        |Product ID.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Sync result.
      }
    }
    syncedAt: TimeStamp with {
      briefly "Synced"
      described as {
        |Sync time.
      }
    }
  } with {
    briefly "Product was synced"
    described as {
      |Emitted when product is synchronized.
    }
  }
  event SyncJobStarted is  {
    job: SyncJob with {
      briefly "Job"
      described as {
        |Started job.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Sync job was started"
    described as {
      |Emitted when sync job begins.
    }
  }
  event SyncJobCompleted is  {
    jobId: SyncJobId with {
      briefly "Job"
      described as {
        |Job ID.
      }
    }
    status: SyncStatus with {
      briefly "Status"
      described as {
        |Final status.
      }
    }
    recordsProcessed: Natural with {
      briefly "Processed"
      described as {
        |Records processed.
      }
    }
    recordsFailed: Natural with {
      briefly "Failed"
      described as {
        |Records failed.
      }
    }
    jobCompletedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Sync job was completed"
    described as {
      |Emitted when sync job finishes.
    }
  }
  event SyncJobCancelled is  {
    jobId: SyncJobId with {
      briefly "Job"
      described as {
        |Job ID.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Sync job was cancelled"
    described as {
      |Emitted when sync job is cancelled.
    }
  }
  event ChangeEventProcessed is  {
    event: DataChangeEvent with {
      briefly "Event"
      described as {
        |Processed event.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Change event was processed"
    described as {
      |Emitted when change is processed.
    }
  }
  event FieldMappingUpdated is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    mapping: FieldMapping with {
      briefly "Mapping"
      described as {
        |Updated mapping.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Field mapping was updated"
    described as {
      |Emitted when mapping is updated.
    }
  }
  // State Records
  record ConfiguredStateData is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Configuration.
      }
    }
    systems: ConnectedSystem+ with {
      briefly "Systems"
      described as {
        |Connected systems.
      }
    }
    syncJobs: SyncJob+ with {
      briefly "Jobs"
      described as {
        |Sync job history.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Configured state data"
    described as {
      |State data for configured integration.
    }
  }
  record ActiveStateData is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Configuration.
      }
    }
    systems: ConnectedSystem+ with {
      briefly "Systems"
      described as {
        |Connected systems.
      }
    }
    syncJobs: SyncJob+ with {
      briefly "Jobs"
      described as {
        |Sync job history.
      }
    }
    lastSyncAt: TimeStamp? with {
      briefly "Last sync"
      described as {
        |Last sync time.
      }
    }
    enabledAt: TimeStamp with {
      briefly "Enabled"
      described as {
        |Enable time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      |State data for active integration.
    }
  }
  record DisabledStateData is  {
    integrationId: IntegrationId with {
      briefly "Integration"
      described as {
        |Integration ID.
      }
    }
    config: IntegrationConfig with {
      briefly "Config"
      described as {
        |Configuration.
      }
    }
    reason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Disable reason.
      }
    }
    disabledAt: TimeStamp with {
      briefly "Disabled"
      described as {
        |Disable time.
      }
    }
  } with {
    briefly "Disabled state data"
    described as {
      |State data for disabled integration.
    }
  }
  // States
  state ConfiguredState of type Integration.ConfiguredStateData
  state ActiveState of type Integration.ActiveStateData
  state DisabledState of type Integration.DisabledStateData
  // Handler
  handler IntegrationHandler is {
    on command CreateIntegration is {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.ConfiguredState with command CreateIntegration
      tell event IntegrationCreated to entity IntegrationContext.Integration
    }
    on command UpdateIntegration is {
      tell event IntegrationUpdated to entity IntegrationContext.Integration
    }
    on command EnableIntegration is {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.ActiveState with command EnableIntegration
      tell event IntegrationEnabled to entity IntegrationContext.Integration
    }
    on command DisableIntegration is {
      morph entity IntegrationContext.Integration to state IntegrationContext.Integration.DisabledState with command DisableIntegration
      tell event IntegrationDisabled to entity IntegrationContext.Integration
    }
    on command RegisterSystem is {
      tell event SystemRegistered to entity IntegrationContext.Integration
    }
    on command TestConnection is {
      tell event ConnectionTested to entity IntegrationContext.Integration
    }
    on command SyncProduct is {
      tell event ProductSynced to entity IntegrationContext.Integration
    }
    on command StartSyncJob is {
      tell event SyncJobStarted to entity IntegrationContext.Integration
    }
    on command CancelSyncJob is {
      tell event SyncJobCancelled to entity IntegrationContext.Integration
    }
    on command ProcessChangeEvent is {
      tell event ChangeEventProcessed to entity IntegrationContext.Integration
    }
    on command UpdateFieldMapping is {
      tell event FieldMappingUpdated to entity IntegrationContext.Integration
    }
  } with {
    briefly "Processes integration commands"
    described as {
      | Handles integration lifecycle including configuration,
      | sync operations, and change event processing.
    }
  }
} with {
  briefly "Integration aggregate"
  described as {
    | The Integration entity manages PLM integrations
    | including data synchronization and transformations.
  }
}
