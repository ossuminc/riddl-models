// Prototype Management - Prototype Entity

entity Prototype is {

  // Commands
  command CreatePrototype is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "New prototype identifier."
    }
    info is PrototypeInfo with {
      briefly "Info"
      described by "Prototype information."
    }
  } with {
    briefly "Create prototype"
    described by "Creates a new prototype."
  }

  command UpdatePrototype is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype to update."
    }
    info is PrototypeInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update prototype"
    described by "Updates prototype details."
  }

  command StartBuild is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    build is PrototypeBuild with {
      briefly "Build"
      described by "Build details."
    }
  } with {
    briefly "Start build"
    described by "Starts new prototype build."
  }

  command UpdateBuildStatus is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build to update."
    }
    status is BuildStatus with {
      briefly "Status"
      described by "New status."
    }
    notes is optional String(1, 1000) with {
      briefly "Notes"
      described by "Status notes."
    }
  } with {
    briefly "Update build"
    described by "Updates build status."
  }

  command ReceiveComponent is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    buildId is BuildId with {
      briefly "Build ID"
      described by "Build ID."
    }
    componentId is UUID with {
      briefly "Component"
      described by "Component received."
    }
  } with {
    briefly "Receive component"
    described by "Records component receipt."
  }

  command CreateTestPlan is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    plan is TestPlan with {
      briefly "Plan"
      described by "Test plan."
    }
  } with {
    briefly "Create test plan"
    described by "Creates prototype test plan."
  }

  command ExecuteTest is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    execution is TestExecution with {
      briefly "Execution"
      described by "Test execution."
    }
  } with {
    briefly "Execute test"
    described by "Starts test execution."
  }

  command RecordTestResult is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype ID."
    }
    testId is TestId with {
      briefly "Test ID"
      described by "Test ID."
    }
    result is TestResult with {
      briefly "Result"
      described by "Test result."
    }
  } with {
    briefly "Record result"
    described by "Records test result."
  }

  command ValidatePrototype is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype to validate."
    }
    validatedBy is EngineerId with {
      briefly "Validated by"
      described by "Validating engineer."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Validation summary."
    }
  } with {
    briefly "Validate prototype"
    described by "Marks prototype as validated."
  }

  command RetirePrototype is {
    prototypeId is PrototypeId with {
      briefly "Prototype ID"
      described by "Prototype to retire."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Retirement reason."
    }
  } with {
    briefly "Retire prototype"
    described by "Retires prototype from use."
  }

  // Events
  event PrototypeCreated is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    info is PrototypeInfo with { briefly "Info" described by "Prototype info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Prototype was created"
    described by "Emitted when prototype is created."
  }

  event PrototypeUpdated is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    info is PrototypeInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Prototype was updated"
    described by "Emitted when prototype is updated."
  }

  event BuildStarted is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    build is PrototypeBuild with { briefly "Build" described by "Started build." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Build was started"
    described by "Emitted when build begins."
  }

  event BuildStatusUpdated is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    status is BuildStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Build status was updated"
    described by "Emitted when build status changes."
  }

  event ComponentReceived is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    buildId is BuildId with { briefly "Build" described by "Build ID." }
    componentId is UUID with { briefly "Component" described by "Component ID." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Component was received"
    described by "Emitted when component arrives."
  }

  event TestPlanCreated is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    plan is TestPlan with { briefly "Plan" described by "Test plan." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Test plan was created"
    described by "Emitted when test plan is created."
  }

  event TestExecuted is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    execution is TestExecution with { briefly "Execution" described by "Test execution." }
    executedAt is TimeStamp with { briefly "Executed" described by "Execution time." }
  } with {
    briefly "Test was executed"
    described by "Emitted when test starts."
  }

  event TestResultRecorded is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    testId is TestId with { briefly "Test" described by "Test ID." }
    result is TestResult with { briefly "Result" described by "Test result." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Test result was recorded"
    described by "Emitted when result is logged."
  }

  event PrototypeValidated is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    validatedBy is EngineerId with { briefly "Validated by" described by "Validator." }
    summary is String(1, 2000) with { briefly "Summary" described by "Validation summary." }
    validatedAt is TimeStamp with { briefly "Validated" described by "Validation time." }
  } with {
    briefly "Prototype was validated"
    described by "Emitted when prototype is validated."
  }

  event PrototypeRetired is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Retirement reason." }
    retiredAt is TimeStamp with { briefly "Retired" described by "Retirement time." }
  } with {
    briefly "Prototype was retired"
    described by "Emitted when prototype is retired."
  }

  // State Records
  record DevelopmentStateData is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    info is PrototypeInfo with { briefly "Info" described by "Prototype info." }
    prototypeStatus is PrototypeStatus with { briefly "Status" described by "Current status." }
    builds is many PrototypeBuild with { briefly "Builds" described by "Build history." }
    currentTestPlan is optional TestPlan with { briefly "Test plan" described by "Test plan." }
    testExecutions is many TestExecution with { briefly "Tests" described by "Test executions." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Development state data"
    described by "State data for prototype in development."
  }

  record ValidatedStateData is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    info is PrototypeInfo with { briefly "Info" described by "Prototype info." }
    builds is many PrototypeBuild with { briefly "Builds" described by "Build history." }
    testPlan is TestPlan with { briefly "Test plan" described by "Test plan." }
    testExecutions is many TestExecution with { briefly "Tests" described by "Test history." }
    validationSummary is String(1, 2000) with { briefly "Summary" described by "Validation summary." }
    validatedAt is TimeStamp with { briefly "Validated" described by "Validation time." }
  } with {
    briefly "Validated state data"
    described by "State data for validated prototype."
  }

  record RetiredStateData is {
    prototypeId is PrototypeId with { briefly "Prototype" described by "Prototype ID." }
    info is PrototypeInfo with { briefly "Info" described by "Prototype info." }
    reason is String(1, 500) with { briefly "Reason" described by "Retirement reason." }
    retiredAt is TimeStamp with { briefly "Retired" described by "Retirement time." }
  } with {
    briefly "Retired state data"
    described by "State data for retired prototype."
  }

  // States
  state DevelopmentState of Prototype.DevelopmentStateData with {
    briefly "Prototype in development"
    described by "Prototype is being developed and tested."
  }

  state ValidatedState of Prototype.ValidatedStateData with {
    briefly "Prototype is validated"
    described by "Prototype has passed validation."
  }

  state RetiredState of Prototype.RetiredStateData with {
    briefly "Prototype is retired"
    described by "Prototype is no longer active."
  }

  // Handler
  handler PrototypeHandler is {
    on command CreatePrototype {
      morph entity PrototypeContext.Prototype to state PrototypeContext.Prototype.DevelopmentState with command CreatePrototype
      tell event PrototypeCreated to entity PrototypeContext.Prototype
    }

    on command UpdatePrototype {
      tell event PrototypeUpdated to entity PrototypeContext.Prototype
    }

    on command StartBuild {
      tell event BuildStarted to entity PrototypeContext.Prototype
    }

    on command UpdateBuildStatus {
      tell event BuildStatusUpdated to entity PrototypeContext.Prototype
    }

    on command ReceiveComponent {
      tell event ComponentReceived to entity PrototypeContext.Prototype
    }

    on command CreateTestPlan {
      tell event TestPlanCreated to entity PrototypeContext.Prototype
    }

    on command ExecuteTest {
      tell event TestExecuted to entity PrototypeContext.Prototype
    }

    on command RecordTestResult {
      tell event TestResultRecorded to entity PrototypeContext.Prototype
    }

    on command ValidatePrototype {
      morph entity PrototypeContext.Prototype to state PrototypeContext.Prototype.ValidatedState with command ValidatePrototype
      tell event PrototypeValidated to entity PrototypeContext.Prototype
    }

    on command RetirePrototype {
      morph entity PrototypeContext.Prototype to state PrototypeContext.Prototype.RetiredState with command RetirePrototype
      tell event PrototypeRetired to entity PrototypeContext.Prototype
    }
  } with {
    briefly "Processes prototype commands"
    described by {
      | Handles prototype lifecycle including builds,
      | testing, validation, and retirement.
    }
  }

} with {
  briefly "Prototype aggregate"
  described by {
    | The Prototype entity manages prototype development
    | including builds, components, and test validation.
  }
}
