// Prototype Management - Prototype Context

context PrototypeContext is {

  include "types.riddl"
  include "Prototype.riddl"

  // Repository for prototype persistence
  repository PrototypeRepository is {
    schema PrototypeData is relational
      of prototypes as Prototype
      index on field Prototype.prototypeId
      index on field Prototype.info.projectId

    handler PrototypePersistence is {
      on command Prototype.CreatePrototype {
        prompt "Store prototype record"
      }
      on command Prototype.UpdatePrototype {
        prompt "Update prototype info"
      }
      on command Prototype.StartBuild {
        prompt "Store build record"
      }
      on command Prototype.UpdateBuildStatus {
        prompt "Update build status"
      }
      on command Prototype.ReceiveComponent {
        prompt "Update component status"
      }
      on command Prototype.CreateTestPlan {
        prompt "Store test plan"
      }
      on command Prototype.ExecuteTest {
        prompt "Store test execution"
      }
      on command Prototype.RecordTestResult {
        prompt "Store test result"
      }
      on command Prototype.ValidatePrototype {
        prompt "Update validation status"
      }
    } with {
      briefly "Persists prototype commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Prototype data persistence"
    described by {
      | The PrototypeRepository provides persistent storage for
      | prototypes, builds, and test results.
    }
  }

  // Projector for prototype analytics
  projector PrototypeAnalytics is {
    updates repository PrototypeRepository

    record PrototypeStats is {
      projectId is ProjectId with { briefly "Project" described by "Project ID." }
      totalPrototypes is Natural with { briefly "Prototypes" described by "Total prototypes." }
      totalBuilds is Natural with { briefly "Builds" described by "Total builds." }
      testPassRate is Decimal(5, 2) with { briefly "Pass rate" described by "Test pass rate." }
      averageBuildTime is Duration with { briefly "Build time" described by "Average build time." }
    } with {
      briefly "Prototype statistics"
      described by "Project prototype metrics."
    }

    handler AnalyticsHandler is {
      on event Prototype.PrototypeCreated {
        prompt "Update prototype counts"
      }
      on event Prototype.BuildStarted {
        prompt "Update build counts"
      }
      on event Prototype.TestResultRecorded {
        prompt "Update test metrics"
      }
      on event Prototype.PrototypeValidated {
        prompt "Update validation metrics"
      }
    } with {
      briefly "Maintains prototype analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Prototype analytics projections"
    described by "Maintains prototype analytics data."
  }

} with {
  briefly "Bounded context for prototype management"
  described by {
    | The PrototypeContext is the bounded context for prototype
    | lifecycle, build tracking, and validation testing.
  }
}
