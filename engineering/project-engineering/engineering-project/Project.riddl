// Engineering Project - Project Entity

entity Project is {

  // Commands
  command CreateProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "New project identifier."
    }
    info is ProjectInfo with {
      briefly "Info"
      described by "Project information."
    }
    managerId is EngineerId with {
      briefly "Manager"
      described by "Project manager."
    }
  } with {
    briefly "Create project"
    described by "Creates a new engineering project."
  }

  command UpdateProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to update."
    }
    info is ProjectInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update project"
    described by "Updates project details."
  }

  command AddPhase is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    phase is ProjectPhase with {
      briefly "Phase"
      described by "New phase."
    }
  } with {
    briefly "Add phase"
    described by "Adds a project phase."
  }

  command UpdatePhase is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    phaseId is PhaseId with {
      briefly "Phase ID"
      described by "Phase to update."
    }
    status is TaskStatus with {
      briefly "Status"
      described by "New status."
    }
  } with {
    briefly "Update phase"
    described by "Updates phase status."
  }

  command AddTask is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    task is ProjectTask with {
      briefly "Task"
      described by "New task."
    }
  } with {
    briefly "Add task"
    described by "Adds a project task."
  }

  command UpdateTaskStatus is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    taskId is TaskId with {
      briefly "Task ID"
      described by "Task to update."
    }
    status is TaskStatus with {
      briefly "Status"
      described by "New status."
    }
  } with {
    briefly "Update task"
    described by "Updates task status."
  }

  command AssignResource is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    allocation is ResourceAllocation with {
      briefly "Allocation"
      described by "Resource allocation."
    }
  } with {
    briefly "Assign resource"
    described by "Allocates a resource."
  }

  command RecordTime is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    entry is TimeEntry with {
      briefly "Entry"
      described by "Time entry."
    }
  } with {
    briefly "Record time"
    described by "Records time spent."
  }

  command AddMilestone is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    phaseId is PhaseId with {
      briefly "Phase ID"
      described by "Parent phase."
    }
    milestone is ProjectMilestone with {
      briefly "Milestone"
      described by "New milestone."
    }
  } with {
    briefly "Add milestone"
    described by "Adds a project milestone."
  }

  command CompleteMilestone is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    milestoneId is MilestoneId with {
      briefly "Milestone ID"
      described by "Milestone to complete."
    }
  } with {
    briefly "Complete milestone"
    described by "Marks milestone as complete."
  }

  command AddRisk is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    risk is ProjectRisk with {
      briefly "Risk"
      described by "Project risk."
    }
  } with {
    briefly "Add risk"
    described by "Adds a project risk."
  }

  command UpdateRisk is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project identifier."
    }
    riskId is UUID with {
      briefly "Risk ID"
      described by "Risk to update."
    }
    status is String(1, 50) with {
      briefly "Status"
      described by "New risk status."
    }
  } with {
    briefly "Update risk"
    described by "Updates risk status."
  }

  command PlaceOnHold is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to hold."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Place on hold"
    described by "Places project on hold."
  }

  command ResumeProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to resume."
    }
  } with {
    briefly "Resume project"
    described by "Resumes project work."
  }

  command CompleteProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to complete."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Completion summary."
    }
  } with {
    briefly "Complete project"
    described by "Completes the project."
  }

  command CancelProject is {
    projectId is ProjectId with {
      briefly "Project ID"
      described by "Project to cancel."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel project"
    described by "Cancels the project."
  }

  // Events
  event ProjectCreated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    managerId is EngineerId with { briefly "Manager" described by "Project manager." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Project was created"
    described by "Emitted when project is created."
  }

  event ProjectUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Project was updated"
    described by "Emitted when project is updated."
  }

  event PhaseAdded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    phase is ProjectPhase with { briefly "Phase" described by "New phase." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Phase was added"
    described by "Emitted when phase is added."
  }

  event PhaseUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    phaseId is PhaseId with { briefly "Phase" described by "Phase ID." }
    status is TaskStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Phase was updated"
    described by "Emitted when phase is updated."
  }

  event TaskAdded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    task is ProjectTask with { briefly "Task" described by "New task." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Task was added"
    described by "Emitted when task is added."
  }

  event TaskStatusUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    taskId is TaskId with { briefly "Task" described by "Task ID." }
    status is TaskStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Task status was updated"
    described by "Emitted when task status changes."
  }

  event ResourceAssigned is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    allocation is ResourceAllocation with { briefly "Allocation" described by "Resource allocation." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Resource was assigned"
    described by "Emitted when resource is allocated."
  }

  event TimeRecorded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    entry is TimeEntry with { briefly "Entry" described by "Time entry." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Time was recorded"
    described by "Emitted when time is logged."
  }

  event MilestoneAdded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    phaseId is PhaseId with { briefly "Phase" described by "Phase ID." }
    milestone is ProjectMilestone with { briefly "Milestone" described by "New milestone." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Milestone was added"
    described by "Emitted when milestone is added."
  }

  event MilestoneCompleted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    milestoneId is MilestoneId with { briefly "Milestone" described by "Milestone ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Milestone was completed"
    described by "Emitted when milestone is achieved."
  }

  event RiskAdded is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    risk is ProjectRisk with { briefly "Risk" described by "Project risk." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Risk was added"
    described by "Emitted when risk is identified."
  }

  event RiskUpdated is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    riskId is UUID with { briefly "Risk" described by "Risk ID." }
    status is String(1, 50) with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Risk was updated"
    described by "Emitted when risk status changes."
  }

  event ProjectPlacedOnHold is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Project was placed on hold"
    described by "Emitted when project is paused."
  }

  event ProjectResumed is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Project was resumed"
    described by "Emitted when project resumes."
  }

  event ProjectCompleted is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    summary is String(1, 2000) with { briefly "Summary" described by "Completion summary." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Project was completed"
    described by "Emitted when project finishes."
  }

  event ProjectCancelled is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Project was cancelled"
    described by "Emitted when project is cancelled."
  }

  // State Records
  record PlanningStateData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    managerId is EngineerId with { briefly "Manager" described by "Project manager." }
    phases is many ProjectPhase with { briefly "Phases" described by "Project phases." }
    risks is many ProjectRisk with { briefly "Risks" described by "Project risks." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Planning state data"
    described by "State data for planning phase."
  }

  record ActiveStateData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    status is ProjectStatus with { briefly "Status" described by "Project status." }
    managerId is EngineerId with { briefly "Manager" described by "Project manager." }
    phases is many ProjectPhase with { briefly "Phases" described by "Project phases." }
    tasks is many ProjectTask with { briefly "Tasks" described by "Project tasks." }
    resources is many ResourceAllocation with { briefly "Resources" described by "Allocated resources." }
    timeEntries is many TimeEntry with { briefly "Time" described by "Time entries." }
    risks is many ProjectRisk with { briefly "Risks" described by "Project risks." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Active state data"
    described by "State data for active project."
  }

  record CompletedStateData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    summary is String(1, 2000) with { briefly "Summary" described by "Completion summary." }
    totalHours is Decimal(10, 2) with { briefly "Hours" described by "Total hours spent." }
    totalCost is Decimal(15, 2) with { briefly "Cost" described by "Total cost." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state data"
    described by "State data for completed project."
  }

  record CancelledStateData is {
    projectId is ProjectId with { briefly "Project" described by "Project ID." }
    info is ProjectInfo with { briefly "Info" described by "Project info." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Cancelled state data"
    described by "State data for cancelled project."
  }

  // States
  state PlanningState of Project.PlanningStateData with {
    briefly "Project in planning"
    described by "Project is being planned."
  }

  state ActiveState of Project.ActiveStateData with {
    briefly "Project is active"
    described by "Project is under execution."
  }

  state CompletedState of Project.CompletedStateData with {
    briefly "Project is completed"
    described by "Project has been delivered."
  }

  state CancelledState of Project.CancelledStateData with {
    briefly "Project is cancelled"
    described by "Project has been cancelled."
  }

  // Handler
  handler ProjectHandler is {
    on command CreateProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.PlanningState with command CreateProject
      tell event ProjectCreated to entity ProjectContext.Project
    }

    on command UpdateProject {
      tell event ProjectUpdated to entity ProjectContext.Project
    }

    on command AddPhase {
      tell event PhaseAdded to entity ProjectContext.Project
    }

    on command UpdatePhase {
      tell event PhaseUpdated to entity ProjectContext.Project
    }

    on command AddTask {
      morph entity ProjectContext.Project to state ProjectContext.Project.ActiveState with command AddTask
      tell event TaskAdded to entity ProjectContext.Project
    }

    on command UpdateTaskStatus {
      tell event TaskStatusUpdated to entity ProjectContext.Project
    }

    on command AssignResource {
      tell event ResourceAssigned to entity ProjectContext.Project
    }

    on command RecordTime {
      tell event TimeRecorded to entity ProjectContext.Project
    }

    on command AddMilestone {
      tell event MilestoneAdded to entity ProjectContext.Project
    }

    on command CompleteMilestone {
      tell event MilestoneCompleted to entity ProjectContext.Project
    }

    on command AddRisk {
      tell event RiskAdded to entity ProjectContext.Project
    }

    on command UpdateRisk {
      tell event RiskUpdated to entity ProjectContext.Project
    }

    on command PlaceOnHold {
      tell event ProjectPlacedOnHold to entity ProjectContext.Project
    }

    on command ResumeProject {
      tell event ProjectResumed to entity ProjectContext.Project
    }

    on command CompleteProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.CompletedState with command CompleteProject
      tell event ProjectCompleted to entity ProjectContext.Project
    }

    on command CancelProject {
      morph entity ProjectContext.Project to state ProjectContext.Project.CancelledState with command CancelProject
      tell event ProjectCancelled to entity ProjectContext.Project
    }
  } with {
    briefly "Processes project commands"
    described by {
      | Handles project lifecycle including phases, tasks,
      | resources, milestones, and completion.
    }
  }

} with {
  briefly "Engineering project aggregate"
  described by {
    | The Project entity manages engineering project execution
    | including phases, tasks, resources, and deliverables.
  }
}
