// Design Review - Design Review Context

context DesignReviewContext is {

  include "types.riddl"
  include "Submittal.riddl"

  // Repository for submittal persistence
  repository SubmittalRepository is {
    schema SubmittalData is relational
      of submittals as Submittal
      index on field Submittal.submittalId
      index on field Submittal.info.projectId

    handler SubmittalPersistence is {
      on event Submittal.SubmittalCreated {
        prompt "Store submittal record"
      }
      on event Submittal.SubmittalUpdated {
        prompt "Update submittal info"
      }
      on event Submittal.SubmittalSubmitted {
        prompt "Update submittal status to submitted"
      }
      on event Submittal.ReviewerAssigned {
        prompt "Store reviewer assignment"
      }
      on event Submittal.ReviewerRemoved {
        prompt "Remove reviewer assignment"
      }
      on event Submittal.CommentAdded {
        prompt "Store review comment"
      }
      on event Submittal.CommentResolved {
        prompt "Update comment resolution"
      }
      on event Submittal.RevisionSubmitted {
        prompt "Store revision record"
      }
      on event Submittal.ApprovalRecorded {
        prompt "Store approval record"
      }
      on event Submittal.SubmittalRejected {
        prompt "Update submittal to rejected"
      }
      on event Submittal.SubmittalWithdrawn {
        prompt "Update submittal to withdrawn"
      }
      on event Submittal.MilestoneAdded {
        prompt "Store milestone record"
      }
      on event Submittal.MilestoneSignedOff {
        prompt "Update milestone sign-off"
      }
    } with {
      briefly "Persists submittal events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Submittal data persistence"
    described by {
      | The SubmittalRepository provides persistent storage for
      | design submittals, reviews, comments, and approvals.
    }
  }

  // Projector for review analytics
  projector ReviewAnalytics is {
    updates repository SubmittalRepository

    record ReviewStats is {
      projectId is UUID with { briefly "Project" described by "Project ID." }
      totalSubmittals is Natural with { briefly "Submittals" described by "Total submittals." }
      pendingReviews is Natural with { briefly "Pending" described by "Pending reviews." }
      approvalRate is Decimal(5, 2) with { briefly "Approval rate" described by "Approval percentage." }
      averageReviewDuration is Duration with { briefly "Duration" described by "Average review time." }
      openComments is Natural with { briefly "Open comments" described by "Unresolved comments." }
    } with {
      briefly "Review statistics"
      described by "Project review metrics."
    }

    handler AnalyticsHandler is {
      on event Submittal.SubmittalCreated {
        prompt "Update submittal counts"
      }
      on event Submittal.SubmittalSubmitted {
        prompt "Update pending review counts"
      }
      on event Submittal.CommentAdded {
        prompt "Update comment metrics"
      }
      on event Submittal.CommentResolved {
        prompt "Update resolved comment metrics"
      }
      on event Submittal.ApprovalRecorded {
        prompt "Update approval metrics"
      }
      on event Submittal.SubmittalRejected {
        prompt "Update rejection metrics"
      }
    } with {
      briefly "Maintains review analytics"
      described by "Projects events into review analytics views."
    }
  } with {
    briefly "Review analytics projections"
    described by "Maintains design review analytics data."
  }

} with {
  briefly "Bounded context for design reviews"
  described by {
    | The DesignReviewContext is the bounded context for design
    | submittal management, review routing, and approval tracking.
  }
}
