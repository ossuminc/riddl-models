// Design Review - Submittal Entity
entity Submittal is {
  // Commands
  command CreateSubmittal is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |New submittal identifier.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal information.
      }
    }
  } with {
    briefly "Create submittal"
    described as {
      |Creates a new design submittal.
    }
  }
  command UpdateSubmittal is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal to update.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Updated information.
      }
    }
  } with {
    briefly "Update submittal"
    described as {
      |Updates submittal details.
    }
  }
  command SubmitForReview is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal to submit.
      }
    }
  } with {
    briefly "Submit for review"
    described as {
      |Submits the design for review.
    }
  }
  command AssignReviewer is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    assignment: ReviewAssignment with {
      briefly "Assignment"
      described as {
        |Reviewer assignment.
      }
    }
  } with {
    briefly "Assign reviewer"
    described as {
      |Assigns a reviewer to the submittal.
    }
  }
  command RemoveReviewer is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    reviewId: ReviewId with {
      briefly "Review ID"
      described as {
        |Review assignment to remove.
      }
    }
  } with {
    briefly "Remove reviewer"
    described as {
      |Removes a reviewer from the submittal.
    }
  }
  command AddComment is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    comment: ReviewComment with {
      briefly "Comment"
      described as {
        |Review comment.
      }
    }
  } with {
    briefly "Add comment"
    described as {
      |Adds a review comment to the submittal.
    }
  }
  command ResolveComment is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    commentId: CommentId with {
      briefly "Comment ID"
      described as {
        |Comment to resolve.
      }
    }
    resolution: String(1,2000) with {
      briefly "Resolution"
      described as {
        |Resolution description.
      }
    }
    status: CommentStatus with {
      briefly "Status"
      described as {
        |Resolution status.
      }
    }
  } with {
    briefly "Resolve comment"
    described as {
      |Resolves a review comment.
    }
  }
  command SubmitRevision is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    revision: RevisionInfo with {
      briefly "Revision"
      described as {
        |New revision.
      }
    }
  } with {
    briefly "Submit revision"
    described as {
      |Submits a revised version of the design.
    }
  }
  command RecordApproval is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    approval: ApprovalRecord with {
      briefly "Approval"
      described as {
        |Approval record.
      }
    }
  } with {
    briefly "Record approval"
    described as {
      |Records an approval decision.
    }
  }
  command RejectSubmittal is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal to reject.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: ReviewerId with {
      briefly "Rejected by"
      described as {
        |Person rejecting the submittal.
      }
    }
  } with {
    briefly "Reject submittal"
    described as {
      |Rejects the design submittal.
    }
  }
  command WithdrawSubmittal is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal to withdraw.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
  } with {
    briefly "Withdraw submittal"
    described as {
      |Withdraws the submittal from review.
    }
  }
  command AddMilestone is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    milestone: DesignMilestone with {
      briefly "Milestone"
      described as {
        |Design milestone.
      }
    }
  } with {
    briefly "Add milestone"
    described as {
      |Adds a design milestone.
    }
  }
  command SignOffMilestone is  {
    submittalId: SubmittalId with {
      briefly "Submittal ID"
      described as {
        |Submittal identifier.
      }
    }
    milestoneId: MilestoneId with {
      briefly "Milestone ID"
      described as {
        |Milestone to sign off.
      }
    }
    signedOffBy: ReviewerId with {
      briefly "Signed off by"
      described as {
        |Person signing off.
      }
    }
  } with {
    briefly "Sign off milestone"
    described as {
      |Signs off on a design milestone.
    }
  }
  // Events
  event SubmittalCreated is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Submittal was created"
    described as {
      |Emitted when a new submittal is created.
    }
  }
  event SubmittalUpdated is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Updated info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Submittal was updated"
    described as {
      |Emitted when submittal details change.
    }
  }
  event SubmittalSubmitted is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Submittal was submitted for review"
    described as {
      |Emitted when a submittal enters the review process.
    }
  }
  event ReviewerAssigned is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    assignment: ReviewAssignment with {
      briefly "Assignment"
      described as {
        |Reviewer assignment.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Reviewer was assigned"
    described as {
      |Emitted when a reviewer is assigned.
    }
  }
  event ReviewerRemoved is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    reviewId: ReviewId with {
      briefly "Review"
      described as {
        |Review assignment removed.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Reviewer was removed"
    described as {
      |Emitted when a reviewer is removed.
    }
  }
  event CommentAdded is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    comment: ReviewComment with {
      briefly "Comment"
      described as {
        |Review comment.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Comment was added"
    described as {
      |Emitted when a review comment is added.
    }
  }
  event CommentResolved is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    commentId: CommentId with {
      briefly "Comment"
      described as {
        |Comment ID.
      }
    }
    resolution: String(1,2000) with {
      briefly "Resolution"
      described as {
        |Resolution text.
      }
    }
    status: CommentStatus with {
      briefly "Status"
      described as {
        |Resolution status.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Comment was resolved"
    described as {
      |Emitted when a review comment is resolved.
    }
  }
  event RevisionSubmitted is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    revision: RevisionInfo with {
      briefly "Revision"
      described as {
        |Revision details.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Revision was submitted"
    described as {
      |Emitted when a new revision is submitted.
    }
  }
  event ApprovalRecorded is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    approval: ApprovalRecord with {
      briefly "Approval"
      described as {
        |Approval record.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Approval was recorded"
    described as {
      |Emitted when an approval decision is recorded.
    }
  }
  event SubmittalRejected is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: ReviewerId with {
      briefly "Rejected by"
      described as {
        |Person who rejected.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Submittal was rejected"
    described as {
      |Emitted when a submittal is rejected.
    }
  }
  event SubmittalWithdrawn is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Submittal was withdrawn"
    described as {
      |Emitted when a submittal is withdrawn.
    }
  }
  event MilestoneAdded is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    milestone: DesignMilestone with {
      briefly "Milestone"
      described as {
        |Design milestone.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Milestone was added"
    described as {
      |Emitted when a design milestone is added.
    }
  }
  event MilestoneSignedOff is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    milestoneId: MilestoneId with {
      briefly "Milestone"
      described as {
        |Milestone ID.
      }
    }
    signedOffBy: ReviewerId with {
      briefly "Signed off by"
      described as {
        |Person who signed off.
      }
    }
    signedOffAt: TimeStamp with {
      briefly "Signed off"
      described as {
        |Sign-off time.
      }
    }
  } with {
    briefly "Milestone was signed off"
    described as {
      |Emitted when a design milestone is signed off.
    }
  }
  // State Records
  record DraftStateData is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    milestones: DesignMilestone+ with {
      briefly "Milestones"
      described as {
        |Design milestones.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Draft state data"
    described as {
      |State data for a submittal in draft.
    }
  }
  record InReviewStateData is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    submittalStatus: SubmittalStatus with {
      briefly "Status"
      described as {
        |Submittal status.
      }
    }
    reviews: ReviewAssignment+ with {
      briefly "Reviews"
      described as {
        |Reviewer assignments.
      }
    }
    comments: ReviewComment+ with {
      briefly "Comments"
      described as {
        |Review comments.
      }
    }
    revisions: RevisionInfo+ with {
      briefly "Revisions"
      described as {
        |Submitted revisions.
      }
    }
    milestones: DesignMilestone+ with {
      briefly "Milestones"
      described as {
        |Design milestones.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "In-review state data"
    described as {
      |State data for a submittal under review.
    }
  }
  record ApprovedStateData is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    approvals: ApprovalRecord+ with {
      briefly "Approvals"
      described as {
        |Approval records.
      }
    }
    revisions: RevisionInfo+ with {
      briefly "Revisions"
      described as {
        |Revision history.
      }
    }
    milestones: DesignMilestone+ with {
      briefly "Milestones"
      described as {
        |Design milestones.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Approved state data"
    described as {
      |State data for an approved submittal.
    }
  }
  record RejectedStateData is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: ReviewerId with {
      briefly "Rejected by"
      described as {
        |Person who rejected.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Rejected state data"
    described as {
      |State data for a rejected submittal.
    }
  }
  record WithdrawnStateData is  {
    submittalId: SubmittalId with {
      briefly "Submittal"
      described as {
        |Submittal ID.
      }
    }
    info: SubmittalInfo with {
      briefly "Info"
      described as {
        |Submittal info.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Withdrawn state data"
    described as {
      |State data for a withdrawn submittal.
    }
  }
  // States
  state DraftState of type Submittal.DraftStateData
  state InReviewState of type Submittal.InReviewStateData
  state ApprovedState of type Submittal.ApprovedStateData
  state RejectedState of type Submittal.RejectedStateData
  state WithdrawnState of type Submittal.WithdrawnStateData
  // Handler
  handler SubmittalHandler is {
    on command CreateSubmittal is {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.DraftState with command CreateSubmittal
      tell event SubmittalCreated to entity DesignReviewContext.Submittal
    }
    on command UpdateSubmittal is {
      tell event SubmittalUpdated to entity DesignReviewContext.Submittal
    }
    on command SubmitForReview is {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.InReviewState with command SubmitForReview
      tell event SubmittalSubmitted to entity DesignReviewContext.Submittal
    }
    on command AssignReviewer is {
      tell event ReviewerAssigned to entity DesignReviewContext.Submittal
    }
    on command RemoveReviewer is {
      tell event ReviewerRemoved to entity DesignReviewContext.Submittal
    }
    on command AddComment is {
      tell event CommentAdded to entity DesignReviewContext.Submittal
    }
    on command ResolveComment is {
      tell event CommentResolved to entity DesignReviewContext.Submittal
    }
    on command SubmitRevision is {
      tell event RevisionSubmitted to entity DesignReviewContext.Submittal
    }
    on command RecordApproval is {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.ApprovedState with command RecordApproval
      tell event ApprovalRecorded to entity DesignReviewContext.Submittal
    }
    on command RejectSubmittal is {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.RejectedState with command RejectSubmittal
      tell event SubmittalRejected to entity DesignReviewContext.Submittal
    }
    on command WithdrawSubmittal is {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.WithdrawnState with command WithdrawSubmittal
      tell event SubmittalWithdrawn to entity DesignReviewContext.Submittal
    }
    on command AddMilestone is {
      tell event MilestoneAdded to entity DesignReviewContext.Submittal
    }
    on command SignOffMilestone is {
      tell event MilestoneSignedOff to entity DesignReviewContext.Submittal
    }
  } with {
    briefly "Processes submittal commands"
    described as {
      | Handles the submittal lifecycle including creation,
      | review, revision, approval, and milestone sign-off.
    }
  }
} with {
  briefly "Design submittal aggregate"
  described as {
    | The Submittal entity manages design documents through
    | the review process including comments, revisions, and approvals.
  }
}
