// Design Review - Submittal Entity

entity Submittal is {

  // Commands
  command CreateSubmittal is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "New submittal identifier."
    }
    info is SubmittalInfo with {
      briefly "Info"
      described by "Submittal information."
    }
  } with {
    briefly "Create submittal"
    described by "Creates a new design submittal."
  }

  command UpdateSubmittal is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal to update."
    }
    info is SubmittalInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update submittal"
    described by "Updates submittal details."
  }

  command SubmitForReview is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal to submit."
    }
  } with {
    briefly "Submit for review"
    described by "Submits the design for review."
  }

  command AssignReviewer is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    assignment is ReviewAssignment with {
      briefly "Assignment"
      described by "Reviewer assignment."
    }
  } with {
    briefly "Assign reviewer"
    described by "Assigns a reviewer to the submittal."
  }

  command RemoveReviewer is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    reviewId is ReviewId with {
      briefly "Review ID"
      described by "Review assignment to remove."
    }
  } with {
    briefly "Remove reviewer"
    described by "Removes a reviewer from the submittal."
  }

  command AddComment is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    comment is ReviewComment with {
      briefly "Comment"
      described by "Review comment."
    }
  } with {
    briefly "Add comment"
    described by "Adds a review comment to the submittal."
  }

  command ResolveComment is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    commentId is CommentId with {
      briefly "Comment ID"
      described by "Comment to resolve."
    }
    resolution is String(1, 2000) with {
      briefly "Resolution"
      described by "Resolution description."
    }
    status is CommentStatus with {
      briefly "Status"
      described by "Resolution status."
    }
  } with {
    briefly "Resolve comment"
    described by "Resolves a review comment."
  }

  command SubmitRevision is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    revision is RevisionInfo with {
      briefly "Revision"
      described by "New revision."
    }
  } with {
    briefly "Submit revision"
    described by "Submits a revised version of the design."
  }

  command RecordApproval is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    approval is ApprovalRecord with {
      briefly "Approval"
      described by "Approval record."
    }
  } with {
    briefly "Record approval"
    described by "Records an approval decision."
  }

  command RejectSubmittal is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal to reject."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Rejection reason."
    }
    rejectedBy is ReviewerId with {
      briefly "Rejected by"
      described by "Person rejecting the submittal."
    }
  } with {
    briefly "Reject submittal"
    described by "Rejects the design submittal."
  }

  command WithdrawSubmittal is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal to withdraw."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Withdrawal reason."
    }
  } with {
    briefly "Withdraw submittal"
    described by "Withdraws the submittal from review."
  }

  command AddMilestone is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    milestone is DesignMilestone with {
      briefly "Milestone"
      described by "Design milestone."
    }
  } with {
    briefly "Add milestone"
    described by "Adds a design milestone."
  }

  command SignOffMilestone is {
    submittalId is SubmittalId with {
      briefly "Submittal ID"
      described by "Submittal identifier."
    }
    milestoneId is MilestoneId with {
      briefly "Milestone ID"
      described by "Milestone to sign off."
    }
    signedOffBy is ReviewerId with {
      briefly "Signed off by"
      described by "Person signing off."
    }
  } with {
    briefly "Sign off milestone"
    described by "Signs off on a design milestone."
  }

  // Events
  event SubmittalCreated is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Submittal was created"
    described by "Emitted when a new submittal is created."
  }

  event SubmittalUpdated is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Submittal was updated"
    described by "Emitted when submittal details change."
  }

  event SubmittalSubmitted is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Submittal was submitted for review"
    described by "Emitted when a submittal enters the review process."
  }

  event ReviewerAssigned is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    assignment is ReviewAssignment with { briefly "Assignment" described by "Reviewer assignment." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Reviewer was assigned"
    described by "Emitted when a reviewer is assigned."
  }

  event ReviewerRemoved is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    reviewId is ReviewId with { briefly "Review" described by "Review assignment removed." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Reviewer was removed"
    described by "Emitted when a reviewer is removed."
  }

  event CommentAdded is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    comment is ReviewComment with { briefly "Comment" described by "Review comment." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Comment was added"
    described by "Emitted when a review comment is added."
  }

  event CommentResolved is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    commentId is CommentId with { briefly "Comment" described by "Comment ID." }
    resolution is String(1, 2000) with { briefly "Resolution" described by "Resolution text." }
    status is CommentStatus with { briefly "Status" described by "Resolution status." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Comment was resolved"
    described by "Emitted when a review comment is resolved."
  }

  event RevisionSubmitted is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    revision is RevisionInfo with { briefly "Revision" described by "Revision details." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Revision was submitted"
    described by "Emitted when a new revision is submitted."
  }

  event ApprovalRecorded is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    approval is ApprovalRecord with { briefly "Approval" described by "Approval record." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Approval was recorded"
    described by "Emitted when an approval decision is recorded."
  }

  event SubmittalRejected is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Rejection reason." }
    rejectedBy is ReviewerId with { briefly "Rejected by" described by "Person who rejected." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Submittal was rejected"
    described by "Emitted when a submittal is rejected."
  }

  event SubmittalWithdrawn is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Submittal was withdrawn"
    described by "Emitted when a submittal is withdrawn."
  }

  event MilestoneAdded is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    milestone is DesignMilestone with { briefly "Milestone" described by "Design milestone." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Milestone was added"
    described by "Emitted when a design milestone is added."
  }

  event MilestoneSignedOff is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    milestoneId is MilestoneId with { briefly "Milestone" described by "Milestone ID." }
    signedOffBy is ReviewerId with { briefly "Signed off by" described by "Person who signed off." }
    signedOffAt is TimeStamp with { briefly "Signed off" described by "Sign-off time." }
  } with {
    briefly "Milestone was signed off"
    described by "Emitted when a design milestone is signed off."
  }

  // State Records
  record DraftStateData is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    milestones is many DesignMilestone with { briefly "Milestones" described by "Design milestones." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft state data"
    described by "State data for a submittal in draft."
  }

  record InReviewStateData is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    submittalStatus is SubmittalStatus with { briefly "Status" described by "Submittal status." }
    reviews is many ReviewAssignment with { briefly "Reviews" described by "Reviewer assignments." }
    comments is many ReviewComment with { briefly "Comments" described by "Review comments." }
    revisions is many RevisionInfo with { briefly "Revisions" described by "Submitted revisions." }
    milestones is many DesignMilestone with { briefly "Milestones" described by "Design milestones." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "In-review state data"
    described by "State data for a submittal under review."
  }

  record ApprovedStateData is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    approvals is many ApprovalRecord with { briefly "Approvals" described by "Approval records." }
    revisions is many RevisionInfo with { briefly "Revisions" described by "Revision history." }
    milestones is many DesignMilestone with { briefly "Milestones" described by "Design milestones." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Approved state data"
    described by "State data for an approved submittal."
  }

  record RejectedStateData is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    reason is String(1, 1000) with { briefly "Reason" described by "Rejection reason." }
    rejectedBy is ReviewerId with { briefly "Rejected by" described by "Person who rejected." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Rejected state data"
    described by "State data for a rejected submittal."
  }

  record WithdrawnStateData is {
    submittalId is SubmittalId with { briefly "Submittal" described by "Submittal ID." }
    info is SubmittalInfo with { briefly "Info" described by "Submittal info." }
    reason is String(1, 500) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Withdrawn state data"
    described by "State data for a withdrawn submittal."
  }

  // States
  state DraftState of Submittal.DraftStateData with {
    briefly "Submittal in draft"
    described by "Submittal is being prepared."
  }

  state InReviewState of Submittal.InReviewStateData with {
    briefly "Submittal in review"
    described by "Submittal is under active review."
  }

  state ApprovedState of Submittal.ApprovedStateData with {
    briefly "Submittal approved"
    described by "Submittal has been approved."
  }

  state RejectedState of Submittal.RejectedStateData with {
    briefly "Submittal rejected"
    described by "Submittal has been rejected."
  }

  state WithdrawnState of Submittal.WithdrawnStateData with {
    briefly "Submittal withdrawn"
    described by "Submittal has been withdrawn."
  }

  // Handler
  handler SubmittalHandler is {
    on command CreateSubmittal {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.DraftState with command CreateSubmittal
      tell event SubmittalCreated to entity DesignReviewContext.Submittal
    }

    on command UpdateSubmittal {
      tell event SubmittalUpdated to entity DesignReviewContext.Submittal
    }

    on command SubmitForReview {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.InReviewState with command SubmitForReview
      tell event SubmittalSubmitted to entity DesignReviewContext.Submittal
    }

    on command AssignReviewer {
      tell event ReviewerAssigned to entity DesignReviewContext.Submittal
    }

    on command RemoveReviewer {
      tell event ReviewerRemoved to entity DesignReviewContext.Submittal
    }

    on command AddComment {
      tell event CommentAdded to entity DesignReviewContext.Submittal
    }

    on command ResolveComment {
      tell event CommentResolved to entity DesignReviewContext.Submittal
    }

    on command SubmitRevision {
      tell event RevisionSubmitted to entity DesignReviewContext.Submittal
    }

    on command RecordApproval {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.ApprovedState with command RecordApproval
      tell event ApprovalRecorded to entity DesignReviewContext.Submittal
    }

    on command RejectSubmittal {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.RejectedState with command RejectSubmittal
      tell event SubmittalRejected to entity DesignReviewContext.Submittal
    }

    on command WithdrawSubmittal {
      morph entity DesignReviewContext.Submittal to state DesignReviewContext.Submittal.WithdrawnState with command WithdrawSubmittal
      tell event SubmittalWithdrawn to entity DesignReviewContext.Submittal
    }

    on command AddMilestone {
      tell event MilestoneAdded to entity DesignReviewContext.Submittal
    }

    on command SignOffMilestone {
      tell event MilestoneSignedOff to entity DesignReviewContext.Submittal
    }
  } with {
    briefly "Processes submittal commands"
    described by {
      | Handles the submittal lifecycle including creation,
      | review, revision, approval, and milestone sign-off.
    }
  }

} with {
  briefly "Design submittal aggregate"
  described by {
    | The Submittal entity manages design documents through
    | the review process including comments, revisions, and approvals.
  }
}
