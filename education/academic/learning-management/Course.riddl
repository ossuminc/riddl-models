// Learning Management - Course Entity

entity Course is {

  // Commands
  command CreateCourse is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "New course identifier."
    }
    info is CourseInfo with {
      briefly "Info"
      described by "Course information."
    }
    instructorId is InstructorId with {
      briefly "Instructor"
      described by "Course instructor."
    }
  } with {
    briefly "Create course"
    described by "Creates a new course in draft state."
  }

  command UpdateCourse is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course to update."
    }
    info is CourseInfo with {
      briefly "Info"
      described by "Updated information."
    }
  } with {
    briefly "Update course"
    described by "Updates course information."
  }

  command AddModule is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    module is CourseModule with {
      briefly "Module"
      described by "Module to add."
    }
  } with {
    briefly "Add module"
    described by "Adds a module to the course."
  }

  command UpdateModule is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    module is CourseModule with {
      briefly "Module"
      described by "Updated module."
    }
  } with {
    briefly "Update module"
    described by "Updates an existing module."
  }

  command RemoveModule is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    moduleId is ModuleId with {
      briefly "Module ID"
      described by "Module to remove."
    }
  } with {
    briefly "Remove module"
    described by "Removes a module from course."
  }

  command AddContent is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    moduleId is ModuleId with {
      briefly "Module ID"
      described by "Target module."
    }
    content is ContentItem with {
      briefly "Content"
      described by "Content to add."
    }
  } with {
    briefly "Add content"
    described by "Adds content to a module."
  }

  command PublishCourse is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course to publish."
    }
  } with {
    briefly "Publish course"
    described by "Makes course available to learners."
  }

  command ArchiveCourse is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course to archive."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Archive reason."
    }
  } with {
    briefly "Archive course"
    described by "Archives course from active catalog."
  }

  command EnrollLearner is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    learnerId is LearnerId with {
      briefly "Learner ID"
      described by "Learner to enroll."
    }
  } with {
    briefly "Enroll learner"
    described by "Enrolls a learner in the course."
  }

  command RecordProgress is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    learnerId is LearnerId with {
      briefly "Learner ID"
      described by "Learner ID."
    }
    contentId is ContentId with {
      briefly "Content ID"
      described by "Content completed."
    }
    progress is ContentProgress with {
      briefly "Progress"
      described by "Progress details."
    }
  } with {
    briefly "Record progress"
    described by "Records learner progress on content."
  }

  command SubmitAssessment is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    attempt is AssessmentAttempt with {
      briefly "Attempt"
      described by "Assessment attempt."
    }
  } with {
    briefly "Submit assessment"
    described by "Submits assessment for grading."
  }

  command GradeAssessment is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    attemptId is UUID with {
      briefly "Attempt ID"
      described by "Attempt to grade."
    }
    score is Decimal(5, 2) with {
      briefly "Score"
      described by "Achieved score."
    }
    feedback is optional String(1, 2000) with {
      briefly "Feedback"
      described by "Instructor feedback."
    }
  } with {
    briefly "Grade assessment"
    described by "Grades an assessment attempt."
  }

  command CompleteCourse is {
    courseId is CourseId with {
      briefly "Course ID"
      described by "Course ID."
    }
    learnerId is LearnerId with {
      briefly "Learner ID"
      described by "Learner completing."
    }
  } with {
    briefly "Complete course"
    described by "Marks learner as course complete."
  }

  // Events
  event CourseCreated is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    info is CourseInfo with { briefly "Info" described by "Course info." }
    instructorId is InstructorId with { briefly "Instructor" described by "Instructor." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Course was created"
    described by "Emitted when course is created."
  }

  event CourseUpdated is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    info is CourseInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Course was updated"
    described by "Emitted when course is updated."
  }

  event ModuleAdded is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    module is CourseModule with { briefly "Module" described by "Added module." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Module was added"
    described by "Emitted when module is added."
  }

  event ModuleUpdated is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    module is CourseModule with { briefly "Module" described by "Updated module." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Module was updated"
    described by "Emitted when module is updated."
  }

  event ModuleRemoved is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    moduleId is ModuleId with { briefly "Module" described by "Removed module." }
    removedAt is TimeStamp with { briefly "Removed" described by "Remove time." }
  } with {
    briefly "Module was removed"
    described by "Emitted when module is removed."
  }

  event ContentAdded is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    moduleId is ModuleId with { briefly "Module" described by "Module ID." }
    content is ContentItem with { briefly "Content" described by "Added content." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Content was added"
    described by "Emitted when content is added."
  }

  event CoursePublished is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    publishedAt is TimeStamp with { briefly "Published" described by "Publish time." }
  } with {
    briefly "Course was published"
    described by "Emitted when course is published."
  }

  event CourseArchived is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Archive reason." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Course was archived"
    described by "Emitted when course is archived."
  }

  event LearnerEnrolled is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    learnerId is LearnerId with { briefly "Learner" described by "Learner ID." }
    enrollmentId is EnrollmentId with { briefly "Enrollment" described by "Enrollment ID." }
    enrolledAt is TimeStamp with { briefly "Enrolled" described by "Enrollment time." }
  } with {
    briefly "Learner was enrolled"
    described by "Emitted when learner enrolls."
  }

  event ProgressRecorded is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    learnerId is LearnerId with { briefly "Learner" described by "Learner ID." }
    contentId is ContentId with { briefly "Content" described by "Content ID." }
    progress is ContentProgress with { briefly "Progress" described by "Progress data." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Progress was recorded"
    described by "Emitted when progress is tracked."
  }

  event AssessmentSubmitted is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    attempt is AssessmentAttempt with { briefly "Attempt" described by "Submitted attempt." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Assessment was submitted"
    described by "Emitted when assessment is submitted."
  }

  event AssessmentGraded is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    attemptId is UUID with { briefly "Attempt" described by "Attempt ID." }
    score is Decimal(5, 2) with { briefly "Score" described by "Score achieved." }
    passed is Boolean with { briefly "Passed" described by "Whether passed." }
    gradedAt is TimeStamp with { briefly "Graded" described by "Grade time." }
  } with {
    briefly "Assessment was graded"
    described by "Emitted when assessment is graded."
  }

  event CourseCompleted is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    learnerId is LearnerId with { briefly "Learner" described by "Learner ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Course was completed"
    described by "Emitted when learner completes course."
  }

  // State Records
  record DraftCourseData is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    info is CourseInfo with { briefly "Info" described by "Course info." }
    instructorId is InstructorId with { briefly "Instructor" described by "Instructor." }
    modules is many CourseModule with { briefly "Modules" described by "Course modules." }
    assessments is many Assessment with { briefly "Assessments" described by "Assessments." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Draft course data"
    described by "State data for draft course."
  }

  record PublishedCourseData is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    info is CourseInfo with { briefly "Info" described by "Course info." }
    instructorId is InstructorId with { briefly "Instructor" described by "Instructor." }
    modules is many CourseModule with { briefly "Modules" described by "Course modules." }
    assessments is many Assessment with { briefly "Assessments" described by "Assessments." }
    enrollments is many Enrollment with { briefly "Enrollments" described by "Enrollments." }
    publishedAt is TimeStamp with { briefly "Published" described by "Publish time." }
  } with {
    briefly "Published course data"
    described by "State data for published course."
  }

  record ArchivedCourseData is {
    courseId is CourseId with { briefly "Course" described by "Course ID." }
    info is CourseInfo with { briefly "Info" described by "Course info." }
    reason is String(1, 500) with { briefly "Reason" described by "Archive reason." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Archived course data"
    described by "State data for archived course."
  }

  // States
  state DraftState of Course.DraftCourseData with {
    briefly "Course is draft"
    described by "Course is being authored."
  }

  state PublishedState of Course.PublishedCourseData with {
    briefly "Course is published"
    described by "Course is available to learners."
  }

  state ArchivedState of Course.ArchivedCourseData with {
    briefly "Course is archived"
    described by "Course is no longer available."
  }

  // Handler
  handler CourseHandler is {
    on command CreateCourse {
      morph entity LearningContext.Course to state LearningContext.Course.DraftState with command CreateCourse
      tell event CourseCreated to entity LearningContext.Course
    }

    on command UpdateCourse {
      tell event CourseUpdated to entity LearningContext.Course
    }

    on command AddModule {
      tell event ModuleAdded to entity LearningContext.Course
    }

    on command UpdateModule {
      tell event ModuleUpdated to entity LearningContext.Course
    }

    on command RemoveModule {
      tell event ModuleRemoved to entity LearningContext.Course
    }

    on command AddContent {
      tell event ContentAdded to entity LearningContext.Course
    }

    on command PublishCourse {
      morph entity LearningContext.Course to state LearningContext.Course.PublishedState with command PublishCourse
      tell event CoursePublished to entity LearningContext.Course
    }

    on command ArchiveCourse {
      morph entity LearningContext.Course to state LearningContext.Course.ArchivedState with command ArchiveCourse
      tell event CourseArchived to entity LearningContext.Course
    }

    on command EnrollLearner {
      tell event LearnerEnrolled to entity LearningContext.Course
    }

    on command RecordProgress {
      tell event ProgressRecorded to entity LearningContext.Course
    }

    on command SubmitAssessment {
      tell event AssessmentSubmitted to entity LearningContext.Course
    }

    on command GradeAssessment {
      tell event AssessmentGraded to entity LearningContext.Course
    }

    on command CompleteCourse {
      tell event CourseCompleted to entity LearningContext.Course
    }
  } with {
    briefly "Processes course commands"
    described by {
      | Handles course lifecycle including authoring,
      | publishing, enrollment, and progress tracking.
    }
  }

} with {
  briefly "Course aggregate"
  described by {
    | The Course entity manages online courses
    | including modules, content, and learner progress.
  }
}
