// Claims Adjudication - Claim Entity

entity Claim is {

  // Commands
  command SubmitClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "New claim identifier."
    }
    member is MemberInfo with {
      briefly "Member"
      described by "Insured member."
    }
    provider is ProviderInfo with {
      briefly "Provider"
      described by "Billing provider."
    }
    header is ClaimHeader with {
      briefly "Header"
      described by "Claim header."
    }
    serviceLines is many ServiceLine with {
      briefly "Lines"
      described by "Service lines."
    }
  } with {
    briefly "Submit claim"
    described by "Submits a new claim."
  }

  command AdjudicateClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
  } with {
    briefly "Adjudicate claim"
    described by "Processes claim for payment."
  }

  command PendClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    reason is PendReason with {
      briefly "Reason"
      described by "Pend reason."
    }
    notes is String(1, 500) with {
      briefly "Notes"
      described by "Pend notes."
    }
  } with {
    briefly "Pend claim"
    described by "Pends claim for additional review."
  }

  command ResolvePend is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    resolution is String(1, 500) with {
      briefly "Resolution"
      described by "Pend resolution."
    }
  } with {
    briefly "Resolve pend"
    described by "Resolves pended claim."
  }

  command ApproveClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    payment is PaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Approve claim"
    described by "Approves claim for payment."
  }

  command DenyClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    denialReason is DenialReason with {
      briefly "Reason"
      described by "Denial reason."
    }
    explanation is String(1, 500) with {
      briefly "Explanation"
      described by "Denial explanation."
    }
  } with {
    briefly "Deny claim"
    described by "Denies the claim."
  }

  command PayClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    checkNumber is String(1, 30) with {
      briefly "Check"
      described by "Payment check number."
    }
    paidDate is Date with {
      briefly "Paid date"
      described by "Payment date."
    }
  } with {
    briefly "Pay claim"
    described by "Issues payment for claim."
  }

  command AppealClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    appeal is AppealInfo with {
      briefly "Appeal"
      described by "Appeal information."
    }
  } with {
    briefly "Appeal claim"
    described by "Appeals denied claim."
  }

  command ResolveAppeal is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    upheld is Boolean with {
      briefly "Upheld"
      described by "Is denial upheld."
    }
    resolution is String(1, 500) with {
      briefly "Resolution"
      described by "Appeal resolution."
    }
  } with {
    briefly "Resolve appeal"
    described by "Resolves claim appeal."
  }

  command VoidClaim is {
    claimId is ClaimId with {
      briefly "Claim ID"
      described by "Claim identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Void reason."
    }
  } with {
    briefly "Void claim"
    described by "Voids the claim."
  }

  // Events
  event ClaimSubmitted is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    member is MemberInfo with { briefly "Member" described by "Member info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    header is ClaimHeader with { briefly "Header" described by "Claim header." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Claim submitted"
    described by "Emitted when claim is submitted."
  }

  event ClaimAdjudicated is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    adjudicatedAt is TimeStamp with { briefly "Adjudicated" described by "Adjudication time." }
  } with {
    briefly "Claim adjudicated"
    described by "Emitted when claim is processed."
  }

  event ClaimPended is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    reason is PendReason with { briefly "Reason" described by "Pend reason." }
    notes is String(1, 500) with { briefly "Notes" described by "Pend notes." }
    pendedAt is TimeStamp with { briefly "Pended" described by "Pend time." }
  } with {
    briefly "Claim pended"
    described by "Emitted when claim is pended."
  }

  event PendResolved is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    resolution is String(1, 500) with { briefly "Resolution" described by "Resolution." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Pend resolved"
    described by "Emitted when pend is resolved."
  }

  event ClaimApproved is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment details." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Claim approved"
    described by "Emitted when claim is approved."
  }

  event ClaimDenied is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    denialReason is DenialReason with { briefly "Reason" described by "Denial reason." }
    explanation is String(1, 500) with { briefly "Explanation" described by "Explanation." }
    deniedAt is TimeStamp with { briefly "Denied" described by "Denial time." }
  } with {
    briefly "Claim denied"
    described by "Emitted when claim is denied."
  }

  event ClaimPaid is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    checkNumber is String(1, 30) with { briefly "Check" described by "Check number." }
    paidAmount is Decimal(12, 2) with { briefly "Amount" described by "Paid amount." }
    paidAt is TimeStamp with { briefly "Paid" described by "Payment time." }
  } with {
    briefly "Claim paid"
    described by "Emitted when payment is issued."
  }

  event ClaimAppealed is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    appeal is AppealInfo with { briefly "Appeal" described by "Appeal info." }
  } with {
    briefly "Claim appealed"
    described by "Emitted when claim is appealed."
  }

  event AppealResolved is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    upheld is Boolean with { briefly "Upheld" described by "Was denial upheld." }
    resolution is String(1, 500) with { briefly "Resolution" described by "Resolution." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Appeal resolved"
    described by "Emitted when appeal is resolved."
  }

  event ClaimVoided is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Void reason." }
    voidedAt is TimeStamp with { briefly "Voided" described by "Void time." }
  } with {
    briefly "Claim voided"
    described by "Emitted when claim is voided."
  }

  // State Records
  record ReceivedStateData is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    member is MemberInfo with { briefly "Member" described by "Member info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    header is ClaimHeader with { briefly "Header" described by "Claim header." }
    serviceLines is many ServiceLine with { briefly "Lines" described by "Service lines." }
    status is ClaimStatus with { briefly "Status" described by "Claim status." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Received state"
    described by "State for received claim."
  }

  record ProcessedStateData is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    member is MemberInfo with { briefly "Member" described by "Member info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    header is ClaimHeader with { briefly "Header" described by "Claim header." }
    serviceLines is many ServiceLine with { briefly "Lines" described by "Service lines." }
    payment is optional PaymentInfo with { briefly "Payment" described by "Payment if approved." }
    denialReason is optional DenialReason with { briefly "Denial" described by "Denial if denied." }
    status is ClaimStatus with { briefly "Status" described by "Claim status." }
    processedAt is TimeStamp with { briefly "Processed" described by "Processing time." }
  } with {
    briefly "Processed state"
    described by "State for processed claim."
  }

  record ClosedStateData is {
    claimId is ClaimId with { briefly "Claim" described by "Claim ID." }
    finalStatus is ClaimStatus with { briefly "Status" described by "Final status." }
    payment is optional PaymentInfo with { briefly "Payment" described by "Final payment." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed state"
    described by "State for closed claim."
  }

  // States
  state ReceivedState of Claim.ReceivedStateData with {
    briefly "Claim received"
    described by "Claim awaiting processing."
  }

  state ProcessedState of Claim.ProcessedStateData with {
    briefly "Claim processed"
    described by "Claim has been adjudicated."
  }

  state ClosedState of Claim.ClosedStateData with {
    briefly "Claim closed"
    described by "Claim is finalized."
  }

  // Handler
  handler ClaimHandler is {
    on command SubmitClaim {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ReceivedState with command SubmitClaim
      tell event ClaimSubmitted to entity ClaimContext.Claim
    }

    on command AdjudicateClaim {
      tell event ClaimAdjudicated to entity ClaimContext.Claim
    }

    on command PendClaim {
      tell event ClaimPended to entity ClaimContext.Claim
    }

    on command ResolvePend {
      tell event PendResolved to entity ClaimContext.Claim
    }

    on command ApproveClaim {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ProcessedState with command ApproveClaim
      tell event ClaimApproved to entity ClaimContext.Claim
    }

    on command DenyClaim {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ProcessedState with command DenyClaim
      tell event ClaimDenied to entity ClaimContext.Claim
    }

    on command PayClaim {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ClosedState with command PayClaim
      tell event ClaimPaid to entity ClaimContext.Claim
    }

    on command AppealClaim {
      tell event ClaimAppealed to entity ClaimContext.Claim
    }

    on command ResolveAppeal {
      tell event AppealResolved to entity ClaimContext.Claim
    }

    on command VoidClaim {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ClosedState with command VoidClaim
      tell event ClaimVoided to entity ClaimContext.Claim
    }
  } with {
    briefly "Processes claim commands"
    described by {
      | Handles claim lifecycle from submission through
      | adjudication, payment, and appeals.
    }
  }

} with {
  briefly "Claim aggregate"
  described by {
    | The Claim entity manages insurance claims including
    | adjudication, payment, denials, and appeals.
  }
}
