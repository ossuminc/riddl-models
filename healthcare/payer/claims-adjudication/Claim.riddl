// Claims Adjudication - Claim Entity
entity Claim is {
  // Commands
  command SubmitClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |New claim identifier.
      }
    }
    member: MemberInfo with {
      briefly "Member"
      described as {
        |Insured member.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Billing provider.
      }
    }
    header: ClaimHeader with {
      briefly "Header"
      described as {
        |Claim header.
      }
    }
    serviceLines: ServiceLine+ with {
      briefly "Lines"
      described as {
        |Service lines.
      }
    }
  } with {
    briefly "Submit claim"
    described as {
      |Submits a new claim.
    }
  }
  command AdjudicateClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
  } with {
    briefly "Adjudicate claim"
    described as {
      |Processes claim for payment.
    }
  }
  command PendClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    reason: PendReason with {
      briefly "Reason"
      described as {
        |Pend reason.
      }
    }
    notes: String(1,500) with {
      briefly "Notes"
      described as {
        |Pend notes.
      }
    }
  } with {
    briefly "Pend claim"
    described as {
      |Pends claim for additional review.
    }
  }
  command ResolvePend is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |Pend resolution.
      }
    }
  } with {
    briefly "Resolve pend"
    described as {
      |Resolves pended claim.
    }
  }
  command ApproveClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
  } with {
    briefly "Approve claim"
    described as {
      |Approves claim for payment.
    }
  }
  command DenyClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    denialReason: DenialReason with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    explanation: String(1,500) with {
      briefly "Explanation"
      described as {
        |Denial explanation.
      }
    }
  } with {
    briefly "Deny claim"
    described as {
      |Denies the claim.
    }
  }
  command PayClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    checkNumber: String(1,30) with {
      briefly "Check"
      described as {
        |Payment check number.
      }
    }
    paidDate: Date with {
      briefly "Paid date"
      described as {
        |Payment date.
      }
    }
  } with {
    briefly "Pay claim"
    described as {
      |Issues payment for claim.
    }
  }
  command AppealClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    appeal: AppealInfo with {
      briefly "Appeal"
      described as {
        |Appeal information.
      }
    }
  } with {
    briefly "Appeal claim"
    described as {
      |Appeals denied claim.
    }
  }
  command ResolveAppeal is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    upheld: Boolean with {
      briefly "Upheld"
      described as {
        |Is denial upheld.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |Appeal resolution.
      }
    }
  } with {
    briefly "Resolve appeal"
    described as {
      |Resolves claim appeal.
    }
  }
  command VoidClaim is  {
    claimId: ClaimId with {
      briefly "Claim ID"
      described as {
        |Claim identifier.
      }
    }
    voidReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
  } with {
    briefly "Void claim"
    described as {
      |Voids the claim.
    }
  }
  // Events
  event ClaimSubmitted is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    member: MemberInfo with {
      briefly "Member"
      described as {
        |Member info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    header: ClaimHeader with {
      briefly "Header"
      described as {
        |Claim header.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Claim submitted"
    described as {
      |Emitted when claim is submitted.
    }
  }
  event ClaimAdjudicated is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    adjudicatedAt: TimeStamp with {
      briefly "Adjudicated"
      described as {
        |Adjudication time.
      }
    }
  } with {
    briefly "Claim adjudicated"
    described as {
      |Emitted when claim is processed.
    }
  }
  event ClaimPended is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    reason: PendReason with {
      briefly "Reason"
      described as {
        |Pend reason.
      }
    }
    notes: String(1,500) with {
      briefly "Notes"
      described as {
        |Pend notes.
      }
    }
    pendedAt: TimeStamp with {
      briefly "Pended"
      described as {
        |Pend time.
      }
    }
  } with {
    briefly "Claim pended"
    described as {
      |Emitted when claim is pended.
    }
  }
  event PendResolved is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Pend resolved"
    described as {
      |Emitted when pend is resolved.
    }
  }
  event ClaimApproved is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Claim approved"
    described as {
      |Emitted when claim is approved.
    }
  }
  event ClaimDenied is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    denialReason: DenialReason with {
      briefly "Reason"
      described as {
        |Denial reason.
      }
    }
    explanation: String(1,500) with {
      briefly "Explanation"
      described as {
        |Explanation.
      }
    }
    deniedAt: TimeStamp with {
      briefly "Denied"
      described as {
        |Denial time.
      }
    }
  } with {
    briefly "Claim denied"
    described as {
      |Emitted when claim is denied.
    }
  }
  event ClaimPaid is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    checkNumber: String(1,30) with {
      briefly "Check"
      described as {
        |Check number.
      }
    }
    paidAmount: Decimal(12,2) with {
      briefly "Amount"
      described as {
        |Paid amount.
      }
    }
    paidAt: TimeStamp with {
      briefly "Paid"
      described as {
        |Payment time.
      }
    }
  } with {
    briefly "Claim paid"
    described as {
      |Emitted when payment is issued.
    }
  }
  event ClaimAppealed is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    appeal: AppealInfo with {
      briefly "Appeal"
      described as {
        |Appeal info.
      }
    }
  } with {
    briefly "Claim appealed"
    described as {
      |Emitted when claim is appealed.
    }
  }
  event AppealResolved is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    upheld: Boolean with {
      briefly "Upheld"
      described as {
        |Was denial upheld.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Appeal resolved"
    described as {
      |Emitted when appeal is resolved.
    }
  }
  event ClaimVoided is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    voidReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Void reason.
      }
    }
    voidedAt: TimeStamp with {
      briefly "Voided"
      described as {
        |Void time.
      }
    }
  } with {
    briefly "Claim voided"
    described as {
      |Emitted when claim is voided.
    }
  }
  // State Records
  record ReceivedStateData is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    member: MemberInfo with {
      briefly "Member"
      described as {
        |Member info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    header: ClaimHeader with {
      briefly "Header"
      described as {
        |Claim header.
      }
    }
    serviceLines: ServiceLine+ with {
      briefly "Lines"
      described as {
        |Service lines.
      }
    }
    status: ClaimStatus with {
      briefly "Status"
      described as {
        |Claim status.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Received state"
    described as {
      |State for received claim.
    }
  }
  record ProcessedStateData is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    member: MemberInfo with {
      briefly "Member"
      described as {
        |Member info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    header: ClaimHeader with {
      briefly "Header"
      described as {
        |Claim header.
      }
    }
    serviceLines: ServiceLine+ with {
      briefly "Lines"
      described as {
        |Service lines.
      }
    }
    payment: PaymentInfo? with {
      briefly "Payment"
      described as {
        |Payment if approved.
      }
    }
    denialReason: DenialReason? with {
      briefly "Denial"
      described as {
        |Denial if denied.
      }
    }
    status: ClaimStatus with {
      briefly "Status"
      described as {
        |Claim status.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Processing time.
      }
    }
  } with {
    briefly "Processed state"
    described as {
      |State for processed claim.
    }
  }
  record ClosedStateData is  {
    claimId: ClaimId with {
      briefly "Claim"
      described as {
        |Claim ID.
      }
    }
    finalStatus: ClaimStatus with {
      briefly "Status"
      described as {
        |Final status.
      }
    }
    payment: PaymentInfo? with {
      briefly "Payment"
      described as {
        |Final payment.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed state"
    described as {
      |State for closed claim.
    }
  }
  // States
  state ReceivedState of type Claim.ReceivedStateData
  state ProcessedState of type Claim.ProcessedStateData
  state ClosedState of type Claim.ClosedStateData
  // Handler
  handler ClaimHandler is {
    on command SubmitClaim is {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ReceivedState with command SubmitClaim
      tell event ClaimSubmitted to entity ClaimContext.Claim
    }
    on command AdjudicateClaim is {
      tell event ClaimAdjudicated to entity ClaimContext.Claim
    }
    on command PendClaim is {
      tell event ClaimPended to entity ClaimContext.Claim
    }
    on command ResolvePend is {
      tell event PendResolved to entity ClaimContext.Claim
    }
    on command ApproveClaim is {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ProcessedState with command ApproveClaim
      tell event ClaimApproved to entity ClaimContext.Claim
    }
    on command DenyClaim is {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ProcessedState with command DenyClaim
      tell event ClaimDenied to entity ClaimContext.Claim
    }
    on command PayClaim is {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ClosedState with command PayClaim
      tell event ClaimPaid to entity ClaimContext.Claim
    }
    on command AppealClaim is {
      tell event ClaimAppealed to entity ClaimContext.Claim
    }
    on command ResolveAppeal is {
      tell event AppealResolved to entity ClaimContext.Claim
    }
    on command VoidClaim is {
      morph entity ClaimContext.Claim to state ClaimContext.Claim.ClosedState with command VoidClaim
      tell event ClaimVoided to entity ClaimContext.Claim
    }
  } with {
    briefly "Processes claim commands"
    described as {
      | Handles claim lifecycle from submission through
      | adjudication, payment, and appeals.
    }
  }
} with {
  briefly "Claim aggregate"
  described as {
    | The Claim entity manages insurance claims including
    | adjudication, payment, denials, and appeals.
  }
}
