// Enrollment Entity for Member Enrollment Domain
entity Enrollment is {
  // Commands
  command InitiateEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Unique identifier for this enrollment.
      }
    }
    memberInfo: MemberInfo with {
      briefly "Member information"
      described as {
        |Personal and contact information for the member.
      }
    }
    enrollmentPeriod: EnrollmentPeriod with {
      briefly "Enrollment period"
      described as {
        |Type of enrollment window.
      }
    }
    qualifyingEvent: QualifyingEvent? with {
      briefly "Qualifying event"
      described as {
        |Life event for special enrollment, if applicable.
      }
    }
    requestedEffectiveDate: Date with {
      briefly "Requested effective date"
      described as {
        |Date member wants coverage to begin.
      }
    }
    brokerAgentId: String(1,50)? with {
      briefly "Broker agent ID"
      described as {
        |ID of broker submitting enrollment, if any.
      }
    }
  } with {
    briefly "Start a new enrollment application"
    described as {
      | Begins the enrollment process by capturing member information
      | and enrollment period details. Validates basic eligibility
      | requirements before proceeding.
    }
  }
  command SelectPlan is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The enrollment to update with plan selection.
      }
    }
    planSelection: PlanSelection with {
      briefly "Plan selection"
      described as {
        |Details of the selected health plan.
      }
    }
  } with {
    briefly "Choose a health plan product"
    described as {
      | Records the member's plan selection including metal tier,
      | premium, and cost-sharing parameters. Validates plan is
      | available in member's service area.
    }
  }
  command VerifyEligibility is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The enrollment to verify eligibility for.
      }
    }
    eligibilityInfo: EligibilityInfo with {
      briefly "Eligibility information"
      described as {
        |Results of eligibility verification.
      }
    }
  } with {
    briefly "Confirm member eligibility for enrollment"
    described as {
      | Validates member eligibility through exchange integration,
      | employer verification, or qualifying event documentation.
      | Determines subsidy eligibility if applicable.
    }
  }
  command ConfirmEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The enrollment to confirm.
      }
    }
    confirmedBy: String(1,100) with {
      briefly "Confirmed by"
      described as {
        |User or system confirming the enrollment.
      }
    }
    confirmationDate: DateTime with {
      briefly "Confirmation date"
      described as {
        |When the enrollment was confirmed.
      }
    }
  } with {
    briefly "Finalize the enrollment and activate coverage"
    described as {
      | Completes the enrollment process, generates member ID cards,
      | and activates coverage effective on the specified date.
      | Triggers welcome communications to member.
    }
  }
  command TerminateCoverage is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The enrollment to terminate.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |Date coverage will end.
      }
    }
    reason: TerminationReason with {
      briefly "Termination reason"
      described as {
        |Why coverage is being terminated.
      }
    }
    requestedBy: String(1,100) with {
      briefly "Requested by"
      described as {
        |Person or system requesting termination.
      }
    }
  } with {
    briefly "End coverage for an enrollment"
    described as {
      | Terminates active coverage for the specified reason.
      | Handles retroactive terminations and refund calculations
      | according to regulatory requirements.
    }
  }
  command TransferEnrollment is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The enrollment to transfer.
      }
    }
    transferInfo: TransferInfo with {
      briefly "Transfer information"
      described as {
        |Details for the plan-to-plan transfer.
      }
    }
  } with {
    briefly "Transfer member to a different plan"
    described as {
      | Moves a member from one plan to another while maintaining
      | continuity of coverage. Handles accumulator transfers and
      | prorated premium adjustments.
    }
  }
  // Events
  event EnrollmentInitiated is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Identifier of the initiated enrollment.
      }
    }
    memberInfo: MemberInfo with {
      briefly "Member information"
      described as {
        |Member data captured at initiation.
      }
    }
    enrollmentPeriod: EnrollmentPeriod with {
      briefly "Enrollment period"
      described as {
        |Type of enrollment period.
      }
    }
    qualifyingEvent: QualifyingEvent? with {
      briefly "Qualifying event"
      described as {
        |Life event if special enrollment.
      }
    }
    requestedEffectiveDate: Date with {
      briefly "Requested effective date"
      described as {
        |Requested coverage start date.
      }
    }
    initiatedAt: DateTime with {
      briefly "Initiated at"
      described as {
        |Timestamp of initiation.
      }
    }
  } with {
    briefly "Enrollment application started"
    described as {
      | Records that a new enrollment has been initiated with
      | member information and period details captured.
    }
  }
  event PlanSelected is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment for which plan was selected.
      }
    }
    planSelection: PlanSelection with {
      briefly "Plan selection"
      described as {
        |The plan that was selected.
      }
    }
    selectedAt: DateTime with {
      briefly "Selected at"
      described as {
        |Timestamp of plan selection.
      }
    }
  } with {
    briefly "Member selected a health plan"
    described as {
      | Records the plan choice made by the member including
      | all coverage and cost parameters.
    }
  }
  event EligibilityVerified is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment for which eligibility was verified.
      }
    }
    eligibilityInfo: EligibilityInfo with {
      briefly "Eligibility information"
      described as {
        |Verification results.
      }
    }
    verifiedAt: DateTime with {
      briefly "Verified at"
      described as {
        |Timestamp of verification.
      }
    }
  } with {
    briefly "Member eligibility confirmed"
    described as {
      | Records successful eligibility verification including
      | subsidy determination if applicable.
    }
  }
  event EnrollmentConfirmed is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The confirmed enrollment.
      }
    }
    memberId: MemberId with {
      briefly "Member ID"
      described as {
        |Assigned member identifier.
      }
    }
    coverageStartDate: Date with {
      briefly "Coverage start date"
      described as {
        |When coverage becomes effective.
      }
    }
    confirmedBy: String(1,100) with {
      briefly "Confirmed by"
      described as {
        |Who confirmed the enrollment.
      }
    }
    confirmedAt: DateTime with {
      briefly "Confirmed at"
      described as {
        |Timestamp of confirmation.
      }
    }
  } with {
    briefly "Enrollment finalized and coverage activated"
    described as {
      | Records completion of enrollment with assigned member ID
      | and coverage effective date.
    }
  }
  event CoverageTerminated is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The terminated enrollment.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |Date coverage ended.
      }
    }
    reason: TerminationReason with {
      briefly "Reason"
      described as {
        |Why coverage was terminated.
      }
    }
    terminatedAt: DateTime with {
      briefly "Terminated at"
      described as {
        |Timestamp of termination processing.
      }
    }
  } with {
    briefly "Coverage ended for enrollment"
    described as {
      | Records termination of coverage with reason and effective
      | date for audit and regulatory reporting.
    }
  }
  event EnrollmentTransferred is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |The source enrollment.
      }
    }
    transferInfo: TransferInfo with {
      briefly "Transfer information"
      described as {
        |Details of the transfer.
      }
    }
    newEnrollmentId: EnrollmentId with {
      briefly "New enrollment ID"
      described as {
        |Enrollment ID for the new plan.
      }
    }
    transferredAt: DateTime with {
      briefly "Transferred at"
      described as {
        |Timestamp of transfer.
      }
    }
  } with {
    briefly "Member transferred to new plan"
    described as {
      | Records plan transfer with details on source and target
      | plans, accumulator handling, and effective dates.
    }
  }
  // State Records
  record InitiatedStateData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    memberInfo: MemberInfo with {
      briefly "Member info"
      described as {
        |Member information.
      }
    }
    enrollmentPeriod: EnrollmentPeriod with {
      briefly "Period"
      described as {
        |Enrollment period.
      }
    }
    qualifyingEvent: QualifyingEvent? with {
      briefly "Event"
      described as {
        |Qualifying event.
      }
    }
    requestedEffectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Requested start date.
      }
    }
    initiatedAt: DateTime with {
      briefly "Initiated at"
      described as {
        |When initiated.
      }
    }
  } with {
    briefly "Data for initiated enrollment state"
    described as {
      |State data for an enrollment that has been started.
    }
  }
  record PlanSelectedStateData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    memberInfo: MemberInfo with {
      briefly "Member info"
      described as {
        |Member information.
      }
    }
    planSelection: PlanSelection with {
      briefly "Plan"
      described as {
        |Selected plan.
      }
    }
    enrollmentPeriod: EnrollmentPeriod with {
      briefly "Period"
      described as {
        |Enrollment period.
      }
    }
    qualifyingEvent: QualifyingEvent? with {
      briefly "Event"
      described as {
        |Qualifying event.
      }
    }
    requestedEffectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Requested start date.
      }
    }
  } with {
    briefly "Data for plan selected state"
    described as {
      |State data after plan selection.
    }
  }
  record EligibilityVerifiedStateData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    memberInfo: MemberInfo with {
      briefly "Member info"
      described as {
        |Member information.
      }
    }
    planSelection: PlanSelection with {
      briefly "Plan"
      described as {
        |Selected plan.
      }
    }
    eligibilityInfo: EligibilityInfo with {
      briefly "Eligibility"
      described as {
        |Verification results.
      }
    }
    requestedEffectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Requested start date.
      }
    }
  } with {
    briefly "Data for eligibility verified state"
    described as {
      |State data after eligibility confirmation.
    }
  }
  record ActiveStateData is  {
    coverageInfo: CoverageInfo with {
      briefly "Coverage"
      described as {
        |Active coverage details.
      }
    }
  } with {
    briefly "Data for active coverage state"
    described as {
      |State data for active member coverage.
    }
  }
  record TerminatedStateData is  {
    enrollmentId: EnrollmentId with {
      briefly "Enrollment ID"
      described as {
        |Enrollment identifier.
      }
    }
    memberId: MemberId with {
      briefly "Member ID"
      described as {
        |Member identifier.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |When coverage ended.
      }
    }
    reason: TerminationReason with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    finalCoverageInfo: CoverageInfo with {
      briefly "Final coverage"
      described as {
        |Coverage at termination.
      }
    }
  } with {
    briefly "Data for terminated state"
    described as {
      |State data for terminated enrollment.
    }
  }
  // States
  state InitiatedState of type Enrollment.InitiatedStateData
  state PlanSelectedState of type Enrollment.PlanSelectedStateData
  state EligibilityVerifiedState of type Enrollment.EligibilityVerifiedStateData
  state ActiveState of type Enrollment.ActiveStateData
  state TerminatedState of type Enrollment.TerminatedStateData
  // Handler
  handler EnrollmentHandler is {
    on command InitiateEnrollment is {
      morph entity Enrollment to state Enrollment.InitiatedState with command InitiateEnrollment
      tell event EnrollmentInitiated to entity Enrollment
    }
    on command SelectPlan is {
      morph entity Enrollment to state Enrollment.PlanSelectedState with command SelectPlan
      tell event PlanSelected to entity Enrollment
    }
    on command VerifyEligibility is {
      morph entity Enrollment to state Enrollment.EligibilityVerifiedState with command VerifyEligibility
      tell event EligibilityVerified to entity Enrollment
    }
    on command ConfirmEnrollment is {
      morph entity Enrollment to state Enrollment.ActiveState with command ConfirmEnrollment
      tell event EnrollmentConfirmed to entity Enrollment
    }
    on command TerminateCoverage is {
      morph entity Enrollment to state Enrollment.TerminatedState with command TerminateCoverage
      tell event CoverageTerminated to entity Enrollment
    }
    on command TransferEnrollment is {
      tell event EnrollmentTransferred to entity Enrollment
    }
  } with {
    briefly "Primary command handler for enrollment entity"
    described as {
      | Handles all enrollment lifecycle commands and routes to
      | appropriate state transitions with corresponding events.
    }
  }
} with {
  briefly "Health plan enrollment aggregate"
  described as {
    | Manages the complete lifecycle of a member enrollment from
    | initial application through plan selection, eligibility
    | verification, confirmation, and eventual termination or transfer.
    | Implements event sourcing for full audit trail compliance.
  }
}
