// Enrollment Entity for Member Enrollment Domain

entity Enrollment is {

  // Commands
  command InitiateEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Unique identifier for this enrollment."
    }
    memberInfo is MemberInfo with {
      briefly "Member information"
      described by "Personal and contact information for the member."
    }
    enrollmentPeriod is EnrollmentPeriod with {
      briefly "Enrollment period"
      described by "Type of enrollment window."
    }
    qualifyingEvent is optional QualifyingEvent with {
      briefly "Qualifying event"
      described by "Life event for special enrollment, if applicable."
    }
    requestedEffectiveDate is Date with {
      briefly "Requested effective date"
      described by "Date member wants coverage to begin."
    }
    brokerAgentId is optional String(1, 50) with {
      briefly "Broker agent ID"
      described by "ID of broker submitting enrollment, if any."
    }
  } with {
    briefly "Start a new enrollment application"
    described by {
      | Begins the enrollment process by capturing member information
      | and enrollment period details. Validates basic eligibility
      | requirements before proceeding.
    }
  }

  command SelectPlan is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The enrollment to update with plan selection."
    }
    planSelection is PlanSelection with {
      briefly "Plan selection"
      described by "Details of the selected health plan."
    }
  } with {
    briefly "Choose a health plan product"
    described by {
      | Records the member's plan selection including metal tier,
      | premium, and cost-sharing parameters. Validates plan is
      | available in member's service area.
    }
  }

  command VerifyEligibility is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The enrollment to verify eligibility for."
    }
    eligibilityInfo is EligibilityInfo with {
      briefly "Eligibility information"
      described by "Results of eligibility verification."
    }
  } with {
    briefly "Confirm member eligibility for enrollment"
    described by {
      | Validates member eligibility through exchange integration,
      | employer verification, or qualifying event documentation.
      | Determines subsidy eligibility if applicable.
    }
  }

  command ConfirmEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The enrollment to confirm."
    }
    confirmedBy is String(1, 100) with {
      briefly "Confirmed by"
      described by "User or system confirming the enrollment."
    }
    confirmationDate is DateTime with {
      briefly "Confirmation date"
      described by "When the enrollment was confirmed."
    }
  } with {
    briefly "Finalize the enrollment and activate coverage"
    described by {
      | Completes the enrollment process, generates member ID cards,
      | and activates coverage effective on the specified date.
      | Triggers welcome communications to member.
    }
  }

  command TerminateCoverage is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The enrollment to terminate."
    }
    terminationDate is Date with {
      briefly "Termination date"
      described by "Date coverage will end."
    }
    reason is TerminationReason with {
      briefly "Termination reason"
      described by "Why coverage is being terminated."
    }
    requestedBy is String(1, 100) with {
      briefly "Requested by"
      described by "Person or system requesting termination."
    }
  } with {
    briefly "End coverage for an enrollment"
    described by {
      | Terminates active coverage for the specified reason.
      | Handles retroactive terminations and refund calculations
      | according to regulatory requirements.
    }
  }

  command TransferEnrollment is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The enrollment to transfer."
    }
    transferInfo is TransferInfo with {
      briefly "Transfer information"
      described by "Details for the plan-to-plan transfer."
    }
  } with {
    briefly "Transfer member to a different plan"
    described by {
      | Moves a member from one plan to another while maintaining
      | continuity of coverage. Handles accumulator transfers and
      | prorated premium adjustments.
    }
  }

  // Events
  event EnrollmentInitiated is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Identifier of the initiated enrollment."
    }
    memberInfo is MemberInfo with {
      briefly "Member information"
      described by "Member data captured at initiation."
    }
    enrollmentPeriod is EnrollmentPeriod with {
      briefly "Enrollment period"
      described by "Type of enrollment period."
    }
    qualifyingEvent is optional QualifyingEvent with {
      briefly "Qualifying event"
      described by "Life event if special enrollment."
    }
    requestedEffectiveDate is Date with {
      briefly "Requested effective date"
      described by "Requested coverage start date."
    }
    initiatedAt is DateTime with {
      briefly "Initiated at"
      described by "Timestamp of initiation."
    }
  } with {
    briefly "Enrollment application started"
    described by {
      | Records that a new enrollment has been initiated with
      | member information and period details captured.
    }
  }

  event PlanSelected is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment for which plan was selected."
    }
    planSelection is PlanSelection with {
      briefly "Plan selection"
      described by "The plan that was selected."
    }
    selectedAt is DateTime with {
      briefly "Selected at"
      described by "Timestamp of plan selection."
    }
  } with {
    briefly "Member selected a health plan"
    described by {
      | Records the plan choice made by the member including
      | all coverage and cost parameters.
    }
  }

  event EligibilityVerified is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "Enrollment for which eligibility was verified."
    }
    eligibilityInfo is EligibilityInfo with {
      briefly "Eligibility information"
      described by "Verification results."
    }
    verifiedAt is DateTime with {
      briefly "Verified at"
      described by "Timestamp of verification."
    }
  } with {
    briefly "Member eligibility confirmed"
    described by {
      | Records successful eligibility verification including
      | subsidy determination if applicable.
    }
  }

  event EnrollmentConfirmed is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The confirmed enrollment."
    }
    memberId is MemberId with {
      briefly "Member ID"
      described by "Assigned member identifier."
    }
    coverageStartDate is Date with {
      briefly "Coverage start date"
      described by "When coverage becomes effective."
    }
    confirmedBy is String(1, 100) with {
      briefly "Confirmed by"
      described by "Who confirmed the enrollment."
    }
    confirmedAt is DateTime with {
      briefly "Confirmed at"
      described by "Timestamp of confirmation."
    }
  } with {
    briefly "Enrollment finalized and coverage activated"
    described by {
      | Records completion of enrollment with assigned member ID
      | and coverage effective date.
    }
  }

  event CoverageTerminated is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The terminated enrollment."
    }
    terminationDate is Date with {
      briefly "Termination date"
      described by "Date coverage ended."
    }
    reason is TerminationReason with {
      briefly "Reason"
      described by "Why coverage was terminated."
    }
    terminatedAt is DateTime with {
      briefly "Terminated at"
      described by "Timestamp of termination processing."
    }
  } with {
    briefly "Coverage ended for enrollment"
    described by {
      | Records termination of coverage with reason and effective
      | date for audit and regulatory reporting.
    }
  }

  event EnrollmentTransferred is {
    enrollmentId is EnrollmentId with {
      briefly "Enrollment ID"
      described by "The source enrollment."
    }
    transferInfo is TransferInfo with {
      briefly "Transfer information"
      described by "Details of the transfer."
    }
    newEnrollmentId is EnrollmentId with {
      briefly "New enrollment ID"
      described by "Enrollment ID for the new plan."
    }
    transferredAt is DateTime with {
      briefly "Transferred at"
      described by "Timestamp of transfer."
    }
  } with {
    briefly "Member transferred to new plan"
    described by {
      | Records plan transfer with details on source and target
      | plans, accumulator handling, and effective dates.
    }
  }

  // State Records
  record InitiatedStateData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment ID" described by "Enrollment identifier." }
    memberInfo is MemberInfo with { briefly "Member info" described by "Member information." }
    enrollmentPeriod is EnrollmentPeriod with { briefly "Period" described by "Enrollment period." }
    qualifyingEvent is optional QualifyingEvent with { briefly "Event" described by "Qualifying event." }
    requestedEffectiveDate is Date with { briefly "Effective date" described by "Requested start date." }
    initiatedAt is DateTime with { briefly "Initiated at" described by "When initiated." }
  } with {
    briefly "Data for initiated enrollment state"
    described by "State data for an enrollment that has been started."
  }

  record PlanSelectedStateData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment ID" described by "Enrollment identifier." }
    memberInfo is MemberInfo with { briefly "Member info" described by "Member information." }
    planSelection is PlanSelection with { briefly "Plan" described by "Selected plan." }
    enrollmentPeriod is EnrollmentPeriod with { briefly "Period" described by "Enrollment period." }
    qualifyingEvent is optional QualifyingEvent with { briefly "Event" described by "Qualifying event." }
    requestedEffectiveDate is Date with { briefly "Effective date" described by "Requested start date." }
  } with {
    briefly "Data for plan selected state"
    described by "State data after plan selection."
  }

  record EligibilityVerifiedStateData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment ID" described by "Enrollment identifier." }
    memberInfo is MemberInfo with { briefly "Member info" described by "Member information." }
    planSelection is PlanSelection with { briefly "Plan" described by "Selected plan." }
    eligibilityInfo is EligibilityInfo with { briefly "Eligibility" described by "Verification results." }
    requestedEffectiveDate is Date with { briefly "Effective date" described by "Requested start date." }
  } with {
    briefly "Data for eligibility verified state"
    described by "State data after eligibility confirmation."
  }

  record ActiveStateData is {
    coverageInfo is CoverageInfo with { briefly "Coverage" described by "Active coverage details." }
  } with {
    briefly "Data for active coverage state"
    described by "State data for active member coverage."
  }

  record TerminatedStateData is {
    enrollmentId is EnrollmentId with { briefly "Enrollment ID" described by "Enrollment identifier." }
    memberId is MemberId with { briefly "Member ID" described by "Member identifier." }
    terminationDate is Date with { briefly "Termination date" described by "When coverage ended." }
    reason is TerminationReason with { briefly "Reason" described by "Termination reason." }
    finalCoverageInfo is CoverageInfo with { briefly "Final coverage" described by "Coverage at termination." }
  } with {
    briefly "Data for terminated state"
    described by "State data for terminated enrollment."
  }

  // States
  state InitiatedState of Enrollment.InitiatedStateData with {
    briefly "Enrollment has been started"
    described by {
      | Initial state after enrollment initiation. Member information
      | captured, awaiting plan selection.
    }
  }

  state PlanSelectedState of Enrollment.PlanSelectedStateData with {
    briefly "Plan has been selected"
    described by {
      | Plan selection recorded, awaiting eligibility verification
      | before enrollment can be confirmed.
    }
  }

  state EligibilityVerifiedState of Enrollment.EligibilityVerifiedStateData with {
    briefly "Eligibility has been verified"
    described by {
      | Eligibility confirmed, enrollment ready for final
      | confirmation and coverage activation.
    }
  }

  state ActiveState of Enrollment.ActiveStateData with {
    briefly "Coverage is active"
    described by {
      | Member has active coverage. Can process terminations
      | and plan transfers.
    }
  }

  state TerminatedState of Enrollment.TerminatedStateData with {
    briefly "Coverage has been terminated"
    described by {
      | Final state for terminated enrollments. No further
      | transactions allowed except audit queries.
    }
  }

  // Handler
  handler EnrollmentHandler is {
    on command InitiateEnrollment {
      morph entity Enrollment to state Enrollment.InitiatedState with command InitiateEnrollment
      tell event EnrollmentInitiated to entity Enrollment
    }

    on command SelectPlan {
      morph entity Enrollment to state Enrollment.PlanSelectedState with command SelectPlan
      tell event PlanSelected to entity Enrollment
    }

    on command VerifyEligibility {
      morph entity Enrollment to state Enrollment.EligibilityVerifiedState with command VerifyEligibility
      tell event EligibilityVerified to entity Enrollment
    }

    on command ConfirmEnrollment {
      morph entity Enrollment to state Enrollment.ActiveState with command ConfirmEnrollment
      tell event EnrollmentConfirmed to entity Enrollment
    }

    on command TerminateCoverage {
      morph entity Enrollment to state Enrollment.TerminatedState with command TerminateCoverage
      tell event CoverageTerminated to entity Enrollment
    }

    on command TransferEnrollment {
      tell event EnrollmentTransferred to entity Enrollment
    }
  } with {
    briefly "Primary command handler for enrollment entity"
    described by {
      | Handles all enrollment lifecycle commands and routes to
      | appropriate state transitions with corresponding events.
    }
  }

} with {
  briefly "Health plan enrollment aggregate"
  described by {
    | Manages the complete lifecycle of a member enrollment from
    | initial application through plan selection, eligibility
    | verification, confirmation, and eventual termination or transfer.
    | Implements event sourcing for full audit trail compliance.
  }
}
