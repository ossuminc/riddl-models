// Lab Orders - External Contexts

// Laboratory Instrument Interface
context LaboratoryInstrumentInterface is {

  command SendToAnalyzer is {
    specimenId is SpecimenId with { briefly "Specimen" described by "Specimen ID." }
    testCode is String(1, 20) with { briefly "Test" described by "Test code to run." }
    targetAnalyzerId is String(1, 50) with { briefly "Analyzer" described by "Target analyzer." }
  } with {
    briefly "Send to analyzer"
    described by "Sends specimen to laboratory analyzer."
  }

  command RequestAnalyzerResult is {
    requestedAnalyzerId is String(1, 50) with { briefly "Analyzer" described by "Analyzer ID." }
    specimenId is SpecimenId with { briefly "Specimen" described by "Specimen ID." }
    testCode is String(1, 20) with { briefly "Test" described by "Test code." }
  } with {
    briefly "Request result"
    described by "Requests result from analyzer."
  }

  event AnalyzerResultReceived is {
    specimenId is SpecimenId with { briefly "Specimen" described by "Specimen ID." }
    testCode is String(1, 20) with { briefly "Test" described by "Test code." }
    resultValue is String(1, 500) with { briefly "Value" described by "Result value." }
    resultUnit is optional String(1, 50) with { briefly "Unit" described by "Unit of measurement." }
    sourceAnalyzerId is String(1, 50) with { briefly "Analyzer" described by "Source analyzer." }
    resultReceivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Result received"
    described by "Emitted when analyzer returns result."
  }

  event AnalyzerError is {
    errorAnalyzerId is String(1, 50) with { briefly "Analyzer" described by "Analyzer ID." }
    specimenId is SpecimenId with { briefly "Specimen" described by "Specimen ID." }
    errorCode is String(1, 20) with { briefly "Error code" described by "Error code." }
    errorMessage is String(1, 500) with { briefly "Message" described by "Error description." }
    occurredAt is TimeStamp with { briefly "Occurred" described by "Error time." }
  } with {
    briefly "Analyzer error"
    described by "Emitted when analyzer reports an error."
  }

} with {
  option is external
  briefly "External laboratory instruments"
  described by "Interface to laboratory analyzers and instruments via LIS middleware."
}

// EHR Integration
context EHRIntegration is {

  command SubmitLabOrder is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
  } with {
    briefly "Submit order"
    described by "Submits lab order from EHR to LIS."
  }

  command DeliverResult is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    results is many TestResult with { briefly "Results" described by "Test results." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Deliver result"
    described by "Delivers verified results to EHR."
  }

  event OrderReceived is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    ehrReceivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
    acknowledgementId is String(1, 50) with { briefly "Ack" described by "EHR acknowledgement." }
  } with {
    briefly "Order received"
    described by "Emitted when EHR acknowledges order receipt."
  }

  event ResultDelivered is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    ehrDocumentId is String(1, 50) with { briefly "Document" described by "EHR document ID." }
  } with {
    briefly "Result delivered"
    described by "Emitted when result is filed in EHR."
  }

  query GetPatientOrders is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    fromDate is optional Date with { briefly "From" described by "Start date filter." }
    toDate is optional Date with { briefly "To" described by "End date filter." }
  } with {
    briefly "Get patient orders"
    described by "Retrieves patient's lab order history."
  }

  result PatientOrderHistory is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    orders is many LabOrderId with { briefly "Orders" described by "Order IDs." }
  } with {
    briefly "Order history"
    described by "Patient's lab order history."
  }

} with {
  option is external
  briefly "External EHR integration"
  described by "Integration with Electronic Health Record for order entry and result delivery."
}

// Physician Notification Service
context PhysicianNotificationService is {

  command SendCriticalAlert is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    criticalValue is CriticalValue with { briefly "Critical" described by "Critical value details." }
    targetProvider is OrderingProviderInfo with { briefly "Provider" described by "Provider to notify." }
  } with {
    briefly "Send critical alert"
    described by "Sends immediate notification for critical value."
  }

  command SendResultNotification is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    providerId is ProviderId with { briefly "Provider" described by "Provider ID." }
    testName is String(1, 200) with { briefly "Test" described by "Test name." }
    resultSummary is String(1, 500) with { briefly "Summary" described by "Result summary." }
  } with {
    briefly "Send notification"
    described by "Sends routine result notification."
  }

  command RecordReadBack is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    resultId is ResultId with { briefly "Result" described by "Result ID." }
    confirmedBy is String(1, 200) with { briefly "Confirmed by" described by "Person confirming." }
    confirmedAt is TimeStamp with { briefly "Confirmed at" described by "Confirmation time." }
  } with {
    briefly "Record read-back"
    described by "Records read-back confirmation for critical value."
  }

  event CriticalAlertSent is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    alertId is UUID with { briefly "Alert" described by "Alert ID." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
    channel is String(1, 50) with { briefly "Channel" described by "Notification channel (page, call, SMS)." }
  } with {
    briefly "Alert sent"
    described by "Emitted when critical alert is dispatched."
  }

  event CriticalAlertAcknowledged is {
    alertId is UUID with { briefly "Alert" described by "Alert ID." }
    acknowledgedBy is ProviderId with { briefly "Acknowledged by" described by "Provider acknowledging." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "Acknowledgement time." }
  } with {
    briefly "Alert acknowledged"
    described by "Emitted when provider acknowledges critical alert."
  }

  event ReadBackRecorded is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    resultId is ResultId with { briefly "Result" described by "Result ID." }
    confirmedBy is String(1, 200) with { briefly "Confirmed by" described by "Confirming person." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Read-back recorded"
    described by "Emitted when read-back is documented."
  }

} with {
  option is external
  briefly "External physician notification"
  described by "Service for alerting physicians about critical values and results."
}

// Insurance Verification Service
context InsuranceVerification is {

  command VerifyLabCoverage is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    testCodes is many String(1, 20) with { briefly "Tests" described by "Test codes to verify." }
    insuranceId is String(1, 50) with { briefly "Insurance" described by "Insurance ID." }
  } with {
    briefly "Verify coverage"
    described by "Verifies insurance coverage for lab tests."
  }

  event CoverageVerified is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    coveredTests is many String(1, 20) with { briefly "Covered" described by "Covered test codes." }
    uncoveredTests is many optional String(1, 20) with { briefly "Uncovered" described by "Tests not covered." }
    priorAuthRequired is many optional String(1, 20) with { briefly "Prior auth" described by "Tests needing prior auth." }
    coverageVerifiedAt is TimeStamp with { briefly "Verified" described by "Verification time." }
  } with {
    briefly "Coverage verified"
    described by "Emitted when coverage verification completes."
  }

} with {
  option is external
  briefly "External insurance verification"
  described by "Service for verifying lab test insurance coverage."
}

// Billing Integration
context LabBillingService is {

  command SubmitLabCharge is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    testCodes is many String(1, 20) with { briefly "Tests" described by "Billable test codes." }
    billingDiagnosisCodes is many String(1, 10) with { briefly "Diagnoses" described by "Supporting diagnosis codes." }
    performedAt is TimeStamp with { briefly "Performed" described by "Service date." }
  } with {
    briefly "Submit charge"
    described by "Submits lab charges to billing."
  }

  event ChargeSubmitted is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    chargeId is UUID with { briefly "Charge" described by "Charge ID." }
    totalAmount is Decimal(10, 2) with { briefly "Amount" described by "Total charge amount." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submit time." }
  } with {
    briefly "Charge submitted"
    described by "Emitted when lab charges are submitted."
  }

} with {
  option is external
  briefly "External lab billing"
  described by "Integration with billing system for lab charges."
}
