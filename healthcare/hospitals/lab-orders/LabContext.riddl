// Lab Orders - Lab Context

context LabContext is {

  include "types.riddl"
  include "LabOrder.riddl"

  // Repository for lab order persistence
  repository LabOrderRepository is {
    schema LabOrderData is relational
      of labOrders as LabOrder
      index on field LabOrder.orderId
      index on field LabOrder.patient.patientId
      index on field LabOrder.specimen.specimenId

    handler LabOrderPersistence is {
      on command LabOrder.PlaceLabOrder {
        prompt "Store new lab order"
      }
      on command LabContext.LabOrder.CollectSpecimen {
        prompt "Store specimen collection details"
      }
      on command LabOrder.ReceiveSpecimen {
        prompt "Update specimen receipt in lab"
      }
      on command LabOrder.StartTesting {
        prompt "Record testing start time"
      }
      on command LabOrder.RecordResult {
        prompt "Store test result"
      }
      on command LabOrder.VerifyResult {
        prompt "Update result verification status"
      }
      on command LabOrder.ReportCriticalValue {
        prompt "Store critical value notification"
      }
      on command LabOrder.CancelOrder {
        prompt "Update order to cancelled status"
      }
    } with {
      briefly "Persists lab order events"
      described by "Handles command-driven persistence for laboratory orders."
    }
  } with {
    briefly "Lab order data persistence"
    described by {
      | The LabOrderRepository provides persistent storage for
      | laboratory orders, specimens, and test results.
    }
  }

  // Repository for specimen tracking
  repository SpecimenRepository is {
    schema SpecimenData is relational
      of specimens as SpecimenInfo
      index on field SpecimenInfo.specimenId
      index on field SpecimenInfo.collectedAt

    handler SpecimenPersistence is {
      on command LabContext.LabOrder.CollectSpecimen {
        prompt "Store specimen record"
      }
      on command LabOrder.ReceiveSpecimen {
        prompt "Update specimen receipt status"
      }
    } with {
      briefly "Persists specimen data"
      described by "Handles specimen tracking persistence."
    }
  } with {
    briefly "Specimen data persistence"
    described by "Repository for tracking specimen lifecycle."
  }

  // Repository for test results
  repository ResultRepository is {
    schema ResultData is relational
      of results as TestResult
      index on field TestResult.resultId
      index on field TestResult.testId
      index on field TestResult.performedAt

    handler ResultPersistence is {
      on command LabOrder.RecordResult {
        prompt "Store test result"
      }
      on command LabOrder.VerifyResult {
        prompt "Update verification status"
      }
    } with {
      briefly "Persists result data"
      described by "Handles test result persistence."
    }
  } with {
    briefly "Result data persistence"
    described by "Repository for storing and querying test results."
  }

  // Projector for turnaround time analytics
  projector TurnaroundTimeAnalytics is {
    updates repository LabOrderRepository

    record TATMetrics is {
      testCode is String(1, 20) with { briefly "Test" described by "Test code." }
      avgCollectionToReceipt is Duration with { briefly "Collect-to-receipt" described by "Average time from collection to lab receipt." }
      avgReceiptToResult is Duration with { briefly "Receipt-to-result" described by "Average time from receipt to result." }
      avgResultToVerify is Duration with { briefly "Result-to-verify" described by "Average time from result to verification." }
      totalTAT is Duration with { briefly "Total TAT" described by "Total turnaround time." }
      percentOnTarget is Decimal(5, 2) with { briefly "On target %" described by "Percentage meeting TAT target." }
      sampleSize is Natural with { briefly "Sample size" described by "Number of orders in calculation." }
      calculatedAt is TimeStamp with { briefly "Calculated" described by "Calculation timestamp." }
    } with {
      briefly "TAT metrics"
      described by "Turnaround time performance metrics."
    }

    handler TATHandler is {
      on event LabOrder.LabOrderPlaced {
        prompt "Initialize TAT tracking for order"
      }
      on event LabOrder.SpecimenCollected {
        prompt "Record collection timestamp for TAT"
      }
      on event LabOrder.SpecimenReceived {
        prompt "Calculate collection-to-receipt TAT"
      }
      on event LabOrder.ResultRecorded {
        prompt "Calculate receipt-to-result TAT"
      }
      on event LabOrder.ResultVerified {
        prompt "Calculate result-to-verify TAT and total TAT"
      }
    } with {
      briefly "Maintains TAT analytics"
      described by "Projects events into turnaround time metrics."
    }
  } with {
    briefly "Turnaround time projections"
    described by "Maintains laboratory turnaround time analytics."
  }

  // Projector for volume metrics
  projector VolumeAnalytics is {
    updates repository LabOrderRepository

    record VolumeMetrics is {
      period is String(1, 20) with { briefly "Period" described by "Time period (hourly, daily, weekly)." }
      periodStart is TimeStamp with { briefly "Start" described by "Period start time." }
      totalOrders is Natural with { briefly "Total orders" described by "Orders placed." }
      totalSpecimens is Natural with { briefly "Total specimens" described by "Specimens collected." }
      totalResults is Natural with { briefly "Total results" described by "Results recorded." }
      ordersByPriority is many String(1, 100) with { briefly "By priority" described by "Counts by priority." }
      ordersByDepartment is many String(1, 100) with { briefly "By department" described by "Counts by ordering department." }
      testsByType is many String(1, 100) with { briefly "By test type" described by "Counts by test code." }
      cancelRate is Decimal(5, 4) with { briefly "Cancel rate" described by "Order cancellation rate." }
    } with {
      briefly "Volume metrics"
      described by "Laboratory volume and workload metrics."
    }

    handler VolumeHandler is {
      on event LabOrder.LabOrderPlaced {
        prompt "Increment order counts"
      }
      on event LabOrder.SpecimenCollected {
        prompt "Increment specimen counts"
      }
      on event LabOrder.ResultRecorded {
        prompt "Increment result counts"
      }
      on event LabOrder.OrderCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains volume analytics"
      described by "Projects events into volume metrics."
    }
  } with {
    briefly "Volume projections"
    described by "Maintains laboratory volume and workload analytics."
  }

  // Projector for critical value tracking
  projector CriticalValueTracking is {
    updates repository ResultRepository

    record CriticalValueMetrics is {
      period is String(1, 20) with { briefly "Period" described by "Time period." }
      periodStart is TimeStamp with { briefly "Start" described by "Period start." }
      totalCriticals is Natural with { briefly "Total criticals" described by "Critical values reported." }
      avgNotificationTime is Duration with { briefly "Avg notification" described by "Average time to notify provider." }
      readBackRate is Decimal(5, 4) with { briefly "Read-back rate" described by "Read-back confirmation rate." }
      criticalsByTest is many String(1, 100) with { briefly "By test" described by "Criticals by test type." }
      criticalsByUnit is many String(1, 100) with { briefly "By unit" described by "Criticals by nursing unit." }
    } with {
      briefly "Critical value metrics"
      described by "Critical value reporting performance metrics."
    }

    handler CriticalValueHandler is {
      on event LabOrder.CriticalValueReported {
        prompt "Track critical value and notification time"
      }
    } with {
      briefly "Maintains critical value analytics"
      described by "Projects events into critical value tracking metrics."
    }
  } with {
    briefly "Critical value projections"
    described by "Maintains critical value reporting analytics and compliance metrics."
  }

} with {
  briefly "Bounded context for laboratory orders"
  described by {
    | The LabContext is the bounded context for laboratory
    | order management, specimen tracking, result processing,
    | and analytics including TAT and critical value monitoring.
  }
}
