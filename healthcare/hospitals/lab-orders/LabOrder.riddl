// Lab Orders - LabOrder Entity

entity LabOrder is {

  // Commands
  command PlaceLabOrder is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "New lab order identifier."
    }
    patient is PatientInfo with {
      briefly "Patient"
      described by "Patient information."
    }
    orderingProvider is OrderingProviderInfo with {
      briefly "Provider"
      described by "Ordering physician."
    }
    facilityId is FacilityId with {
      briefly "Facility"
      described by "Healthcare facility."
    }
    orderDetails is OrderDetails with {
      briefly "Details"
      described by "Order specifications."
    }
    orderedAt is TimeStamp with {
      briefly "Ordered at"
      described by "Order placement time."
    }
  } with {
    briefly "Place lab order"
    described by "Creates a new laboratory order."
  }

  command CollectSpecimen is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    specimen is SpecimenInfo with {
      briefly "Specimen"
      described by "Collected specimen details."
    }
  } with {
    briefly "Collect specimen"
    described by "Records specimen collection for an order."
  }

  command ReceiveSpecimen is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    specimenId is SpecimenId with {
      briefly "Specimen ID"
      described by "Specimen identifier."
    }
    receivedBy is ProviderId with {
      briefly "Received by"
      described by "Lab staff receiving specimen."
    }
    receivedAt is TimeStamp with {
      briefly "Received at"
      described by "Receipt timestamp."
    }
    specimenCondition is String(1, 200) with {
      briefly "Condition"
      described by "Specimen condition at receipt."
    }
  } with {
    briefly "Receive specimen"
    described by "Records specimen receipt in laboratory."
  }

  command StartTesting is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    testId is TestId with {
      briefly "Test ID"
      described by "Test being started."
    }
    startedBy is ProviderId with {
      briefly "Started by"
      described by "Technician starting test."
    }
    startedAt is TimeStamp with {
      briefly "Started at"
      described by "Testing start time."
    }
    analyzerId is optional String(1, 50) with {
      briefly "Analyzer"
      described by "Instrument identifier."
    }
  } with {
    briefly "Start testing"
    described by "Begins laboratory testing for an order."
  }

  command RecordResult is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    result is TestResult with {
      briefly "Result"
      described by "Test result data."
    }
  } with {
    briefly "Record result"
    described by "Records test result for an order."
  }

  command VerifyResult is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    resultId is ResultId with {
      briefly "Result ID"
      described by "Result to verify."
    }
    verifiedBy is ProviderId with {
      briefly "Verified by"
      described by "Pathologist verifying result."
    }
    verifiedAt is TimeStamp with {
      briefly "Verified at"
      described by "Verification timestamp."
    }
    comments is optional String(1, 500) with {
      briefly "Comments"
      described by "Pathologist comments."
    }
  } with {
    briefly "Verify result"
    described by "Pathologist verification and release of result."
  }

  command ReportCriticalValue is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    criticalValue is CriticalValue with {
      briefly "Critical"
      described by "Critical value details."
    }
  } with {
    briefly "Report critical value"
    described by "Reports a life-threatening critical result."
  }

  command CancelOrder is {
    orderId is LabOrderId with {
      briefly "Order ID"
      described by "Lab order identifier."
    }
    cancelledBy is ProviderId with {
      briefly "Cancelled by"
      described by "Person cancelling order."
    }
    cancelledAt is TimeStamp with {
      briefly "Cancelled at"
      described by "Cancellation timestamp."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel order"
    described by "Cancels a laboratory order."
  }

  // Events
  event LabOrderPlaced is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
  } with {
    briefly "Lab order placed"
    described by "Emitted when a laboratory order is created."
  }

  event SpecimenCollected is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    specimen is SpecimenInfo with { briefly "Specimen" described by "Specimen details." }
  } with {
    briefly "Specimen collected"
    described by "Emitted when specimen is collected from patient."
  }

  event SpecimenReceived is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    specimenId is SpecimenId with { briefly "Specimen" described by "Specimen ID." }
    receivedBy is ProviderId with { briefly "Received by" described by "Receiving staff." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
    specimenCondition is String(1, 200) with { briefly "Condition" described by "Specimen condition." }
  } with {
    briefly "Specimen received"
    described by "Emitted when specimen arrives in laboratory."
  }

  event TestingStarted is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    testId is TestId with { briefly "Test" described by "Test ID." }
    startedBy is ProviderId with { briefly "Started by" described by "Technician." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    analyzerId is optional String(1, 50) with { briefly "Analyzer" described by "Instrument." }
  } with {
    briefly "Testing started"
    described by "Emitted when laboratory testing begins."
  }

  event ResultRecorded is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    result is TestResult with { briefly "Result" described by "Test result." }
  } with {
    briefly "Result recorded"
    described by "Emitted when test result is recorded."
  }

  event ResultVerified is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    resultId is ResultId with { briefly "Result" described by "Result ID." }
    verifiedBy is ProviderId with { briefly "Verified by" described by "Pathologist." }
    verifiedAt is TimeStamp with { briefly "Verified" described by "Verification time." }
    comments is optional String(1, 500) with { briefly "Comments" described by "Pathologist notes." }
  } with {
    briefly "Result verified"
    described by "Emitted when pathologist verifies result."
  }

  event CriticalValueReported is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    criticalValue is CriticalValue with { briefly "Critical" described by "Critical value." }
  } with {
    briefly "Critical value reported"
    described by "Emitted when critical value is reported."
  }

  event OrderCancelled is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    cancelledBy is ProviderId with { briefly "Cancelled by" described by "Cancelling person." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
  } with {
    briefly "Order cancelled"
    described by "Emitted when lab order is cancelled."
  }

  // State Records
  record OrderedStateData is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
  } with {
    briefly "Ordered state data"
    described by "Data for newly placed order."
  }

  record CollectionStateData is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    specimen is SpecimenInfo with { briefly "Specimen" described by "Collected specimen." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
  } with {
    briefly "Collection state data"
    described by "Data for order with collected specimen."
  }

  record TestingStateData is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    specimen is SpecimenInfo with { briefly "Specimen" described by "Specimen info." }
    receivedAt is TimeStamp with { briefly "Received" described by "Lab receipt time." }
    testingStartedAt is optional TimeStamp with { briefly "Testing started" described by "Testing start time." }
    pendingResults is many optional TestResult with { briefly "Pending" described by "Results awaiting verification." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
  } with {
    briefly "Testing state data"
    described by "Data for order in laboratory processing."
  }

  record ResultedStateData is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    specimen is SpecimenInfo with { briefly "Specimen" described by "Specimen info." }
    results is many TestResult with { briefly "Results" described by "Verified results." }
    criticalValues is many optional CriticalValue with { briefly "Criticals" described by "Critical values reported." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Resulted state data"
    described by "Data for completed order with verified results."
  }

  record CancelledStateData is {
    orderId is LabOrderId with { briefly "Order" described by "Order ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    orderingProvider is OrderingProviderInfo with { briefly "Provider" described by "Ordering provider." }
    orderDetails is OrderDetails with { briefly "Details" described by "Order details." }
    cancelledBy is ProviderId with { briefly "Cancelled by" described by "Cancelling person." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
  } with {
    briefly "Cancelled state data"
    described by "Data for cancelled order."
  }

  // States
  state OrderedState of LabOrder.OrderedStateData with {
    briefly "Order placed"
    described by "Lab order has been placed, awaiting collection."
  }

  state CollectionState of LabOrder.CollectionStateData with {
    briefly "Specimen collected"
    described by "Specimen collected, awaiting lab receipt."
  }

  state TestingState of LabOrder.TestingStateData with {
    briefly "In testing"
    described by "Specimen in laboratory, testing in progress."
  }

  state ResultedState of LabOrder.ResultedStateData with {
    briefly "Results verified"
    described by "All results verified and released."
  }

  state CancelledState of LabOrder.CancelledStateData with {
    briefly "Order cancelled"
    described by "Lab order has been cancelled."
  }

  // Handler
  handler LabOrderHandler is {
    on command PlaceLabOrder {
      morph entity LabContext.LabOrder to state LabContext.LabOrder.OrderedState with command PlaceLabOrder
      tell event LabOrderPlaced to entity LabContext.LabOrder
    }

    on command LabContext.LabOrder.CollectSpecimen {
      morph entity LabContext.LabOrder to state LabContext.LabOrder.CollectionState with command LabContext.LabOrder.CollectSpecimen
      tell event SpecimenCollected to entity LabContext.LabOrder
    }

    on command ReceiveSpecimen {
      morph entity LabContext.LabOrder to state LabContext.LabOrder.TestingState with command ReceiveSpecimen
      tell event SpecimenReceived to entity LabContext.LabOrder
    }

    on command StartTesting {
      tell event TestingStarted to entity LabContext.LabOrder
    }

    on command RecordResult {
      tell event ResultRecorded to entity LabContext.LabOrder
    }

    on command VerifyResult {
      morph entity LabContext.LabOrder to state LabContext.LabOrder.ResultedState with command VerifyResult
      tell event ResultVerified to entity LabContext.LabOrder
    }

    on command ReportCriticalValue {
      tell event CriticalValueReported to entity LabContext.LabOrder
      tell command PhysicianNotificationService.SendCriticalAlert to context PhysicianNotificationService
    }

    on command CancelOrder {
      morph entity LabContext.LabOrder to state LabContext.LabOrder.CancelledState with command CancelOrder
      tell event OrderCancelled to entity LabContext.LabOrder
    }
  } with {
    briefly "Processes lab order commands"
    described by {
      | Handles laboratory order lifecycle from placement through
      | specimen collection, testing, result recording, verification,
      | critical value reporting, and cancellation.
    }
  }

} with {
  briefly "Lab order aggregate"
  described by {
    | The LabOrder entity manages laboratory orders including
    | specimen tracking, result recording, and critical value
    | notifications throughout the testing lifecycle.
  }
}
