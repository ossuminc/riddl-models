// Hospital Admission/Discharge - Admission Entity
entity Admission is {
  // Commands
  command CreateAdmission is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |New admission identifier.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient being admitted.
      }
    }
    admissionType: AdmissionType with {
      briefly "Type"
      described as {
        |Type of admission.
      }
    }
    admittingPhysicianId: PhysicianId with {
      briefly "Admitting physician"
      described as {
        |Physician ordering admission.
      }
    }
    attendingPhysicianId: PhysicianId with {
      briefly "Attending physician"
      described as {
        |Primary responsible physician.
      }
    }
    admitDiagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Primary admission diagnosis.
      }
    }
    expectedLOS: Natural? with {
      briefly "Expected LOS"
      described as {
        |Expected length of stay in days.
      }
    }
  } with {
    briefly "Create admission"
    described as {
      |Initiates a new patient admission.
    }
  }
  command AssignBed is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    bedId: BedId with {
      briefly "Bed"
      described as {
        |Bed to assign.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Hospital unit.
      }
    }
    unitName: String(1,100) with {
      briefly "Unit name"
      described as {
        |Name of unit.
      }
    }
    roomNumber: String(1,20) with {
      briefly "Room"
      described as {
        |Room number.
      }
    }
    bedNumber: String(1,10) with {
      briefly "Bed number"
      described as {
        |Bed within room.
      }
    }
    accommodationType: AccommodationType with {
      briefly "Accommodation"
      described as {
        |Type of accommodation.
      }
    }
  } with {
    briefly "Assign bed"
    described as {
      |Assigns patient to a specific bed.
    }
  }
  command RequestTransfer is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    toUnitId: UnitId with {
      briefly "To unit"
      described as {
        |Destination unit.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Transfer reason.
      }
    }
    priority: String(1,20) with {
      briefly "Priority"
      described as {
        |Transfer priority.
      }
    }
    requestedBy: PhysicianId with {
      briefly "Requested by"
      described as {
        |Requesting physician.
      }
    }
  } with {
    briefly "Request transfer"
    described as {
      |Requests patient transfer to another unit.
    }
  }
  command TransferPatient is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    newBedId: BedId with {
      briefly "New bed"
      described as {
        |New bed assignment.
      }
    }
    newUnitId: UnitId with {
      briefly "New unit"
      described as {
        |New hospital unit.
      }
    }
    newUnitName: String(1,100) with {
      briefly "Unit name"
      described as {
        |Name of new unit.
      }
    }
    newRoomNumber: String(1,20) with {
      briefly "Room"
      described as {
        |New room number.
      }
    }
    newBedNumber: String(1,10) with {
      briefly "Bed"
      described as {
        |New bed number.
      }
    }
    accommodationType: AccommodationType with {
      briefly "Accommodation"
      described as {
        |Accommodation type.
      }
    }
    transferReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Transfer reason.
      }
    }
  } with {
    briefly "Transfer patient"
    described as {
      |Executes patient transfer to new bed.
    }
  }
  command UpdateCondition is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    condition: PatientCondition with {
      briefly "Condition"
      described as {
        |Updated patient condition.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Condition notes.
      }
    }
  } with {
    briefly "Update condition"
    described as {
      |Updates patient condition assessment.
    }
  }
  command InitiateDischarge is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    orderedBy: PhysicianId with {
      briefly "Ordered by"
      described as {
        |Discharging physician.
      }
    }
    disposition: DischargeDisposition with {
      briefly "Disposition"
      described as {
        |Discharge destination.
      }
    }
    dischargeDiagnoses: String(1,500)+ with {
      briefly "Diagnoses"
      described as {
        |Discharge diagnoses.
      }
    }
    dischargeInstructions: String(1,5000) with {
      briefly "Instructions"
      described as {
        |Discharge instructions.
      }
    }
    followUpRequired: Boolean with {
      briefly "Follow-up"
      described as {
        |Follow-up needed.
      }
    }
    followUpDays: Natural? with {
      briefly "Follow-up days"
      described as {
        |Days to follow-up.
      }
    }
  } with {
    briefly "Initiate discharge"
    described as {
      |Begins the discharge process.
    }
  }
  command CompleteDischarge is  {
    admissionId: AdmissionId with {
      briefly "Admission ID"
      described as {
        |Admission identifier.
      }
    }
    medicationsReconciled: Boolean with {
      briefly "Meds reconciled"
      described as {
        |Medications have been reconciled.
      }
    }
    dischargeEducationComplete: Boolean with {
      briefly "Education complete"
      described as {
        |Discharge teaching completed.
      }
    }
    transportArranged: Boolean with {
      briefly "Transport"
      described as {
        |Transportation arranged.
      }
    }
  } with {
    briefly "Complete discharge"
    described as {
      |Finalizes discharge and releases bed.
    }
  }
  // Events
  event AdmissionCreated is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    admissionType: AdmissionType with {
      briefly "Type"
      described as {
        |Admission type.
      }
    }
    admittingPhysicianId: PhysicianId with {
      briefly "Admitting"
      described as {
        |Admitting physician.
      }
    }
    attendingPhysicianId: PhysicianId with {
      briefly "Attending"
      described as {
        |Attending physician.
      }
    }
    admitDiagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Admit diagnosis.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Admission created"
    described as {
      |Emitted when admission record is created.
    }
  }
  event BedAssigned is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    bedAssignment: BedAssignment with {
      briefly "Bed"
      described as {
        |Bed assignment.
      }
    }
  } with {
    briefly "Bed assigned"
    described as {
      |Emitted when patient is assigned to a bed.
    }
  }
  event TransferRequested is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    transferRequest: TransferRequest with {
      briefly "Request"
      described as {
        |Transfer request.
      }
    }
  } with {
    briefly "Transfer requested"
    described as {
      |Emitted when transfer is requested.
    }
  }
  event PatientTransferred is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    previousBed: BedAssignment with {
      briefly "Previous"
      described as {
        |Previous bed.
      }
    }
    newBed: BedAssignment with {
      briefly "New"
      described as {
        |New bed.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Transfer reason.
      }
    }
    transferredAt: TimeStamp with {
      briefly "Transferred"
      described as {
        |Transfer time.
      }
    }
  } with {
    briefly "Patient transferred"
    described as {
      |Emitted when patient is transferred.
    }
  }
  event ConditionUpdated is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    previousCondition: PatientCondition with {
      briefly "Previous"
      described as {
        |Previous condition.
      }
    }
    newCondition: PatientCondition with {
      briefly "New"
      described as {
        |New condition.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Condition notes.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Condition updated"
    described as {
      |Emitted when patient condition changes.
    }
  }
  event DischargeInitiated is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    dischargeOrder: DischargeOrder with {
      briefly "Order"
      described as {
        |Discharge order.
      }
    }
  } with {
    briefly "Discharge initiated"
    described as {
      |Emitted when discharge process begins.
    }
  }
  event DischargeCompleted is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    disposition: DischargeDisposition with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    lengthOfStay: LengthOfStay with {
      briefly "LOS"
      described as {
        |Length of stay.
      }
    }
    bedReleased: BedId with {
      briefly "Bed released"
      described as {
        |Bed now available.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Discharge completed"
    described as {
      |Emitted when patient is discharged and bed released.
    }
  }
  // State Records
  record PendingStateData is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    admissionType: AdmissionType with {
      briefly "Type"
      described as {
        |Admission type.
      }
    }
    admittingPhysicianId: PhysicianId with {
      briefly "Admitting"
      described as {
        |Admitting physician.
      }
    }
    attendingPhysicianId: PhysicianId with {
      briefly "Attending"
      described as {
        |Attending physician.
      }
    }
    admitDiagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Admit diagnosis.
      }
    }
    expectedLOS: Natural? with {
      briefly "Expected LOS"
      described as {
        |Expected stay.
      }
    }
    status: AdmissionStatus with {
      briefly "Status"
      described as {
        |Admission status.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Pending state data"
    described as {
      |State for admission awaiting bed assignment.
    }
  }
  record AdmittedStateData is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    admissionType: AdmissionType with {
      briefly "Type"
      described as {
        |Admission type.
      }
    }
    admittingPhysicianId: PhysicianId with {
      briefly "Admitting"
      described as {
        |Admitting physician.
      }
    }
    attendingPhysicianId: PhysicianId with {
      briefly "Attending"
      described as {
        |Attending physician.
      }
    }
    admitDiagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Admit diagnosis.
      }
    }
    currentBed: BedAssignment with {
      briefly "Current bed"
      described as {
        |Current bed assignment.
      }
    }
    condition: PatientCondition with {
      briefly "Condition"
      described as {
        |Patient condition.
      }
    }
    transferHistory: TransferHistory* with {
      briefly "Transfers"
      described as {
        |Transfer history.
      }
    }
    pendingTransfer: TransferRequest? with {
      briefly "Pending transfer"
      described as {
        |Pending transfer request.
      }
    }
    expectedLOS: Natural? with {
      briefly "Expected LOS"
      described as {
        |Expected stay.
      }
    }
    status: AdmissionStatus with {
      briefly "Status"
      described as {
        |Admission status.
      }
    }
    admittedAt: TimeStamp with {
      briefly "Admitted"
      described as {
        |Admission time.
      }
    }
  } with {
    briefly "Admitted state data"
    described as {
      |State for patient currently in hospital.
    }
  }
  record TransferringStateData is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    currentBed: BedAssignment with {
      briefly "Current bed"
      described as {
        |Current location.
      }
    }
    targetBed: BedAssignment with {
      briefly "Target bed"
      described as {
        |Destination bed.
      }
    }
    transferRequest: TransferRequest with {
      briefly "Request"
      described as {
        |Transfer request.
      }
    }
    transferHistory: TransferHistory* with {
      briefly "History"
      described as {
        |Previous transfers.
      }
    }
    status: AdmissionStatus with {
      briefly "Status"
      described as {
        |Admission status.
      }
    }
    transferStartedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Transfer start time.
      }
    }
  } with {
    briefly "Transferring state data"
    described as {
      |State for patient being transferred.
    }
  }
  record DischargedStateData is  {
    admissionId: AdmissionId with {
      briefly "Admission"
      described as {
        |Admission ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    admissionType: AdmissionType with {
      briefly "Type"
      described as {
        |Admission type.
      }
    }
    admitDiagnosis: String(1,500) with {
      briefly "Admit diagnosis"
      described as {
        |Admission diagnosis.
      }
    }
    dischargeOrder: DischargeOrder with {
      briefly "Discharge order"
      described as {
        |Discharge details.
      }
    }
    lengthOfStay: LengthOfStay with {
      briefly "LOS"
      described as {
        |Length of stay.
      }
    }
    transferHistory: TransferHistory* with {
      briefly "Transfers"
      described as {
        |Transfer history.
      }
    }
    status: AdmissionStatus with {
      briefly "Status"
      described as {
        |Final status.
      }
    }
    dischargedAt: TimeStamp with {
      briefly "Discharged"
      described as {
        |Discharge time.
      }
    }
  } with {
    briefly "Discharged state data"
    described as {
      |State for completed admission.
    }
  }
  // States
  state PendingState of type Admission.PendingStateData
  state AdmittedState of type Admission.AdmittedStateData
  state TransferringState of type Admission.TransferringStateData
  state DischargedState of type Admission.DischargedStateData
  // Handler
  handler AdmissionHandler is {
    on command CreateAdmission is {
      morph entity AdmissionContext.Admission to state AdmissionContext.Admission.PendingState with command CreateAdmission
      tell event AdmissionCreated to entity AdmissionContext.Admission
    }
    on command AssignBed is {
      morph entity AdmissionContext.Admission to state AdmissionContext.Admission.AdmittedState with command AssignBed
      tell event BedAssigned to entity AdmissionContext.Admission
    }
    on command RequestTransfer is {
      tell event TransferRequested to entity AdmissionContext.Admission
    }
    on command Admission.TransferPatient is {
      morph entity AdmissionContext.Admission to state AdmissionContext.Admission.TransferringState with command Admission.TransferPatient
      tell event PatientTransferred to entity AdmissionContext.Admission
      morph entity AdmissionContext.Admission to state AdmissionContext.Admission.AdmittedState with command Admission.TransferPatient
    }
    on command UpdateCondition is {
      tell event ConditionUpdated to entity AdmissionContext.Admission
    }
    on command InitiateDischarge is {
      tell event DischargeInitiated to entity AdmissionContext.Admission
    }
    on command CompleteDischarge is {
      morph entity AdmissionContext.Admission to state AdmissionContext.Admission.DischargedState with command CompleteDischarge
      tell event DischargeCompleted to entity AdmissionContext.Admission
    }
  } with {
    briefly "Processes admission commands"
    described as {
      | Handles the complete admission lifecycle including
      | creation, bed assignment, transfers, and discharge.
    }
  }
} with {
  briefly "Admission aggregate"
  described as {
    | The Admission entity manages a patient's hospital stay
    | from initial admission through discharge.
  }
}
