// NurseShift Entity
// Core entity managing nursing shift lifecycle, patient assignments, and tasks
entity NurseShift is {
  // ==========================================================================
  // Commands
  // ==========================================================================
  command StartShift is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Identifier for the shift.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse ID"
      described as {
        |Nurse starting the shift.
      }
    }
    unitId: UnitId with {
      briefly "Unit ID"
      described as {
        |Nursing unit.
      }
    }
    scheduledStart: TimeStamp with {
      briefly "Scheduled start"
      described as {
        |Scheduled shift start time.
      }
    }
    shiftType: String with {
      briefly "Shift type"
      described as {
        |Day, evening, or night shift.
      }
    }
  } with {
    briefly "Begin a nursing shift"
    described as {
      | Initiates a new shift for a nurse on a specific unit.
      | Validates that the nurse is scheduled and the unit is staffed appropriately.
    }
  }
  command AssignPatients is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Target shift.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse ID"
      described as {
        |Nurse receiving assignment.
      }
    }
    patientIds: PatientId+ with {
      briefly "Patient IDs"
      described as {
        |Patients being assigned.
      }
    }
    assignedBy: NurseId with {
      briefly "Assigned by"
      described as {
        |Charge nurse making assignment.
      }
    }
    acuityScore: Number with {
      briefly "Acuity score"
      described as {
        |Combined patient acuity.
      }
    }
  } with {
    briefly "Assign patients to a nurse for this shift"
    described as {
      |Creates formal patient assignments for the shift.
    }
  }
  command CreateTask is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Target shift.
      }
    }
    taskId: TaskId with {
      briefly "Task ID"
      described as {
        |New task identifier.
      }
    }
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Task patient.
      }
    }
    taskType: String with {
      briefly "Task type"
      described as {
        |Category of task.
      }
    }
    description: String with {
      briefly "Description"
      described as {
        |Task details.
      }
    }
    priority: TaskPriority with {
      briefly "Priority"
      described as {
        |Task priority.
      }
    }
    dueTime: TimeStamp? with {
      briefly "Due time"
      described as {
        |Target completion time.
      }
    }
  } with {
    briefly "Create a new nursing task"
    described as {
      |Adds a task to the nurse's worklist for this shift.
    }
  }
  command CompleteTask is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Target shift.
      }
    }
    taskId: TaskId with {
      briefly "Task ID"
      described as {
        |Task to complete.
      }
    }
    completedBy: NurseId with {
      briefly "Completed by"
      described as {
        |Completing nurse.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed at"
      described as {
        |Completion time.
      }
    }
    notes: String? with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
  } with {
    briefly "Mark a task as completed"
    described as {
      |Records task completion with timestamp and any relevant notes.
    }
  }
  command DocumentAssessment is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Target shift.
      }
    }
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Assessed patient.
      }
    }
    assessmentType: AssessmentType with {
      briefly "Assessment type"
      described as {
        |Type of assessment.
      }
    }
    findings: String with {
      briefly "Findings"
      described as {
        |Assessment findings.
      }
    }
    abnormalFindings: String? with {
      briefly "Abnormal findings"
      described as {
        |Notable abnormalities.
      }
    }
    interventions: String? with {
      briefly "Interventions"
      described as {
        |Actions taken.
      }
    }
    followUpRequired: Boolean with {
      briefly "Follow-up required"
      described as {
        |Whether follow-up needed.
      }
    }
    followUpNotes: String? with {
      briefly "Follow-up notes"
      described as {
        |Follow-up details.
      }
    }
  } with {
    briefly "Document a nursing assessment"
    described as {
      |Records assessment findings in the patient's chart.
    }
  }
  command RecordVitals is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Target shift.
      }
    }
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient measured.
      }
    }
    temperature: Number? with {
      briefly "Temperature"
      described as {
        |Body temperature.
      }
    }
    temperatureUnit: String? with {
      briefly "Temperature unit"
      described as {
        |F or C.
      }
    }
    heartRate: Number? with {
      briefly "Heart rate"
      described as {
        |Beats per minute.
      }
    }
    respiratoryRate: Number? with {
      briefly "Respiratory rate"
      described as {
        |Breaths per minute.
      }
    }
    bloodPressureSystolic: Number? with {
      briefly "Systolic BP"
      described as {
        |Systolic blood pressure.
      }
    }
    bloodPressureDiastolic: Number? with {
      briefly "Diastolic BP"
      described as {
        |Diastolic blood pressure.
      }
    }
    oxygenSaturation: Number? with {
      briefly "O2 saturation"
      described as {
        |Oxygen saturation.
      }
    }
    painLevel: Number? with {
      briefly "Pain level"
      described as {
        |Pain scale 0-10.
      }
    }
    supplementalOxygen: Boolean? with {
      briefly "Supplemental O2"
      described as {
        |On oxygen flag.
      }
    }
    oxygenFlowRate: Number? with {
      briefly "O2 flow rate"
      described as {
        |Liters per minute.
      }
    }
  } with {
    briefly "Record patient vital signs"
    described as {
      |Documents vital signs measurement at current time.
    }
  }
  command InitiateHandoff is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Outgoing shift.
      }
    }
    incomingNurseId: NurseId with {
      briefly "Incoming nurse"
      described as {
        |Nurse receiving handoff.
      }
    }
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient being handed off.
      }
    }
    situation: String with {
      briefly "Situation"
      described as {
        |Current patient situation.
      }
    }
    background: String with {
      briefly "Background"
      described as {
        |Relevant history.
      }
    }
    assessment: String with {
      briefly "Assessment"
      described as {
        |Nursing assessment.
      }
    }
    recommendation: String with {
      briefly "Recommendation"
      described as {
        |Recommended actions.
      }
    }
  } with {
    briefly "Begin SBAR handoff to incoming nurse"
    described as {
      |Starts the formal handoff process using SBAR format.
    }
  }
  command CompleteHandoff is  {
    shiftId: ShiftId with {
      briefly "Shift ID"
      described as {
        |Outgoing shift.
      }
    }
    reportId: UUID with {
      briefly "Report ID"
      described as {
        |Handoff report identifier.
      }
    }
    acknowledgedBy: NurseId with {
      briefly "Acknowledged by"
      described as {
        |Incoming nurse.
      }
    }
    acceptedTasks: TaskId* with {
      briefly "Accepted tasks"
      described as {
        |Tasks being transferred.
      }
    }
  } with {
    briefly "Complete handoff with incoming nurse acknowledgment"
    described as {
      |Finalizes the handoff when the incoming nurse acknowledges receipt.
    }
  }
  // ==========================================================================
  // Events
  // ==========================================================================
  event ShiftStarted is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    shiftType: String with {
      briefly "Type"
      described as {
        |Shift type.
      }
    }
  } with {
    briefly "Nursing shift has begun"
    described as {
      |Records the official start of a nursing shift.
    }
  }
  event PatientsAssigned is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    assignmentId: AssignmentId with {
      briefly "Assignment"
      described as {
        |Assignment ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    patientIds: PatientId+ with {
      briefly "Patients"
      described as {
        |Patient IDs.
      }
    }
    assignedBy: NurseId with {
      briefly "By"
      described as {
        |Charge nurse.
      }
    }
    assignedAt: TimeStamp with {
      briefly "At"
      described as {
        |Assignment time.
      }
    }
    acuityScore: Number with {
      briefly "Acuity"
      described as {
        |Total acuity.
      }
    }
  } with {
    briefly "Patients have been assigned to nurse"
    described as {
      |Records patient assignments for the shift.
    }
  }
  event TaskCreated is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    taskId: TaskId with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    taskType: String with {
      briefly "Type"
      described as {
        |Task type.
      }
    }
    description: String with {
      briefly "Description"
      described as {
        |Task details.
      }
    }
    priority: TaskPriority with {
      briefly "Priority"
      described as {
        |Task priority.
      }
    }
    dueTime: TimeStamp? with {
      briefly "Due"
      described as {
        |Due time.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "New nursing task has been created"
    described as {
      |Records creation of a task in the nurse's worklist.
    }
  }
  event TaskCompleted is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    taskId: TaskId with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    completedBy: NurseId with {
      briefly "By"
      described as {
        |Completing nurse.
      }
    }
    completedAt: TimeStamp with {
      briefly "At"
      described as {
        |Completion time.
      }
    }
    notes: String? with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
  } with {
    briefly "Nursing task has been completed"
    described as {
      |Records successful completion of a nursing task.
    }
  }
  event AssessmentDocumented is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    assessmentId: UUID with {
      briefly "Assessment"
      described as {
        |Assessment ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    assessmentType: AssessmentType with {
      briefly "Type"
      described as {
        |Assessment type.
      }
    }
    performedAt: TimeStamp with {
      briefly "At"
      described as {
        |Assessment time.
      }
    }
    abnormalFindings: String? with {
      briefly "Abnormals"
      described as {
        |Abnormal findings.
      }
    }
    followUpRequired: Boolean with {
      briefly "Follow-up"
      described as {
        |Follow-up needed.
      }
    }
  } with {
    briefly "Nursing assessment has been documented"
    described as {
      |Records completion of a nursing assessment.
    }
  }
  event VitalsRecorded is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    vitalsRecordId: UUID with {
      briefly "Record"
      described as {
        |Vitals record ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    recordedAt: TimeStamp with {
      briefly "At"
      described as {
        |Record time.
      }
    }
    heartRate: Number? with {
      briefly "HR"
      described as {
        |Heart rate.
      }
    }
    bloodPressureSystolic: Number? with {
      briefly "SBP"
      described as {
        |Systolic BP.
      }
    }
    bloodPressureDiastolic: Number? with {
      briefly "DBP"
      described as {
        |Diastolic BP.
      }
    }
    oxygenSaturation: Number? with {
      briefly "SpO2"
      described as {
        |O2 saturation.
      }
    }
    painLevel: Number? with {
      briefly "Pain"
      described as {
        |Pain level.
      }
    }
  } with {
    briefly "Vital signs have been recorded"
    described as {
      |Records a vital signs measurement event.
    }
  }
  event HandoffInitiated is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    reportId: UUID with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    outgoingNurseId: NurseId with {
      briefly "Outgoing"
      described as {
        |Outgoing nurse.
      }
    }
    incomingNurseId: NurseId with {
      briefly "Incoming"
      described as {
        |Incoming nurse.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "At"
      described as {
        |Initiation time.
      }
    }
    pendingTaskCount: Number with {
      briefly "Tasks"
      described as {
        |Pending task count.
      }
    }
  } with {
    briefly "Shift handoff has been initiated"
    described as {
      |Records the start of the SBAR handoff process.
    }
  }
  event HandoffCompleted is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    reportId: UUID with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    acknowledgedBy: NurseId with {
      briefly "By"
      described as {
        |Acknowledging nurse.
      }
    }
    completedAt: TimeStamp with {
      briefly "At"
      described as {
        |Completion time.
      }
    }
    tasksTransferred: Number with {
      briefly "Tasks"
      described as {
        |Tasks transferred.
      }
    }
  } with {
    briefly "Shift handoff has been completed"
    described as {
      |Records successful completion and acknowledgment of handoff.
    }
  }
  // ==========================================================================
  // State Data Records
  // ==========================================================================
  record ActiveStateData is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    shiftType: String with {
      briefly "Type"
      described as {
        |Shift type.
      }
    }
    assignments: NurseAssignment* with {
      briefly "Assignments"
      described as {
        |Patient assignments.
      }
    }
    tasks: NursingTask* with {
      briefly "Tasks"
      described as {
        |Nursing tasks.
      }
    }
    assessments: PatientAssessment* with {
      briefly "Assessments"
      described as {
        |Patient assessments.
      }
    }
    vitals: VitalSigns* with {
      briefly "Vitals"
      described as {
        |Vital signs records.
      }
    }
    tasksCompleted: Number with {
      briefly "Completed"
      described as {
        |Tasks completed count.
      }
    }
    tasksDeferred: Number with {
      briefly "Deferred"
      described as {
        |Tasks deferred count.
      }
    }
  } with {
    briefly "Active shift state data"
    described as {
      |Data for shift in active progress.
    }
  }
  record HandoffStateData is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    shiftType: String with {
      briefly "Type"
      described as {
        |Shift type.
      }
    }
    assignments: NurseAssignment* with {
      briefly "Assignments"
      described as {
        |Patient assignments.
      }
    }
    tasks: NursingTask* with {
      briefly "Tasks"
      described as {
        |Nursing tasks.
      }
    }
    assessments: PatientAssessment* with {
      briefly "Assessments"
      described as {
        |Patient assessments.
      }
    }
    vitals: VitalSigns* with {
      briefly "Vitals"
      described as {
        |Vital signs records.
      }
    }
    tasksCompleted: Number with {
      briefly "Completed"
      described as {
        |Tasks completed count.
      }
    }
    tasksDeferred: Number with {
      briefly "Deferred"
      described as {
        |Tasks deferred count.
      }
    }
    handoffReports: HandoffReport* with {
      briefly "Reports"
      described as {
        |Handoff reports.
      }
    }
    pendingHandoffs: Number with {
      briefly "Pending"
      described as {
        |Pending handoff count.
      }
    }
  } with {
    briefly "Handoff state data"
    described as {
      |Data for shift in handoff transition.
    }
  }
  record CompletedStateData is  {
    shiftId: ShiftId with {
      briefly "Shift"
      described as {
        |Shift ID.
      }
    }
    nurseId: NurseId with {
      briefly "Nurse"
      described as {
        |Nurse ID.
      }
    }
    unitId: UnitId with {
      briefly "Unit"
      described as {
        |Unit ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
    shiftType: String with {
      briefly "Type"
      described as {
        |Shift type.
      }
    }
    summary: ShiftSummary with {
      briefly "Summary"
      described as {
        |Shift summary.
      }
    }
  } with {
    briefly "Completed shift state data"
    described as {
      |Data for completed shift.
    }
  }
  // ==========================================================================
  // States
  // ==========================================================================
  state ActiveState of type NurseShift.ActiveStateData
  state HandoffState of type NurseShift.HandoffStateData
  state CompletedState of type NurseShift.CompletedStateData
  // ==========================================================================
  // Handler
  // ==========================================================================
  handler NurseShiftHandler is {
    on command StartShift is {
      morph entity NursingContext.NurseShift to state NursingContext.NurseShift.ActiveState with command StartShift
      tell event ShiftStarted to entity NursingContext.NurseShift
    }
    on command AssignPatients is {
      tell event PatientsAssigned to entity NursingContext.NurseShift
    }
    on command CreateTask is {
      tell event TaskCreated to entity NursingContext.NurseShift
    }
    on command CompleteTask is {
      tell event TaskCompleted to entity NursingContext.NurseShift
    }
    on command DocumentAssessment is {
      tell event AssessmentDocumented to entity NursingContext.NurseShift
    }
    on command RecordVitals is {
      tell event VitalsRecorded to entity NursingContext.NurseShift
    }
    on command InitiateHandoff is {
      morph entity NursingContext.NurseShift to state NursingContext.NurseShift.HandoffState with command InitiateHandoff
      tell event HandoffInitiated to entity NursingContext.NurseShift
    }
    on command CompleteHandoff is {
      morph entity NursingContext.NurseShift to state NursingContext.NurseShift.CompletedState with command CompleteHandoff
      tell event HandoffCompleted to entity NursingContext.NurseShift
    }
  } with {
    briefly "Handles NurseShift commands"
    described as {
      | Processes all nursing care activities during the shift including
      | patient assignments, task management, clinical documentation,
      | and shift handoffs.
    }
  }
} with {
  briefly "Manages a nurse's shift lifecycle and patient care activities"
  described as {
    | The NurseShift entity is the core aggregate for nursing workflow.
    | It tracks the complete lifecycle from shift start through handoff completion.
    | All patient care activities (tasks, assessments, vitals) are recorded.
    | Supports SBAR-formatted handoffs for safe care transitions.
  }
}
