// NursingContext - Bounded Context for Nursing Workflow
// Contains repository and projectors for nursing operations

context NursingContext is {

  include "types.riddl"
  include "NurseShift.riddl"

  // ==========================================================================
  // Repository
  // ==========================================================================

  repository NursingRepository is {

    // Assignment queries
    handler AssignmentQueries is {
      on query GetAssignmentsByShift {
        ???
      } with {
        briefly "Retrieve all assignments for a shift"
        described by "Returns all patient assignments for a specific shift."
      }

      on query GetAssignmentsByNurse {
        ???
      } with {
        briefly "Retrieve all assignments for a nurse"
        described by "Returns current and historical assignments for a nurse."
      }

      on query GetAssignmentsByUnit {
        ???
      } with {
        briefly "Retrieve all assignments for a unit"
        described by "Returns all active assignments on a nursing unit."
      }
    } with {
      briefly "Handles assignment-related queries"
      described by "Provides read access to nurse-patient assignment data."
    }

    // Task queries
    handler TaskQueries is {
      on query GetTasksByShift {
        ???
      } with {
        briefly "Retrieve all tasks for a shift"
        described by "Returns the complete task list for a shift."
      }

      on query GetPendingTasks {
        ???
      } with {
        briefly "Retrieve pending tasks for a nurse"
        described by "Returns tasks not yet completed, sorted by priority."
      }

      on query GetOverdueTasks {
        ???
      } with {
        briefly "Retrieve overdue tasks"
        described by "Returns tasks past their due time for escalation."
      }

      on query GetTasksByPatient {
        ???
      } with {
        briefly "Retrieve tasks for a patient"
        described by "Returns all tasks for a specific patient across shifts."
      }
    } with {
      briefly "Handles task-related queries"
      described by "Provides read access to nursing task data."
    }

    // Shift queries
    handler ShiftQueries is {
      on query GetActiveShifts {
        ???
      } with {
        briefly "Retrieve all active shifts"
        described by "Returns shifts currently in progress on a unit."
      }

      on query GetShiftSummary {
        ???
      } with {
        briefly "Retrieve shift summary"
        described by "Returns aggregated metrics for a completed shift."
      }

      on query GetHandoffReports {
        ???
      } with {
        briefly "Retrieve handoff reports"
        described by "Returns SBAR handoff reports for a shift or patient."
      }
    } with {
      briefly "Handles shift-related queries"
      described by "Provides read access to shift and handoff data."
    }

    // Define queries
    query GetAssignmentsByShift is { shiftId is ShiftId with { briefly "Shift" described by "Shift ID." } } with {
      briefly "Query for assignments by shift"
      described by "Retrieves all assignments associated with a shift."
    }

    query GetAssignmentsByNurse is { nurseId is NurseId with { briefly "Nurse" described by "Nurse ID." } } with {
      briefly "Query for assignments by nurse"
      described by "Retrieves all assignments for a specific nurse."
    }

    query GetAssignmentsByUnit is { unitId is UnitId with { briefly "Unit" described by "Unit ID." } } with {
      briefly "Query for assignments by unit"
      described by "Retrieves all active assignments on a unit."
    }

    query GetTasksByShift is { shiftId is ShiftId with { briefly "Shift" described by "Shift ID." } } with {
      briefly "Query for tasks by shift"
      described by "Retrieves all tasks for a specific shift."
    }

    query GetPendingTasks is { nurseId is NurseId with { briefly "Nurse" described by "Nurse ID." } } with {
      briefly "Query for pending tasks"
      described by "Retrieves incomplete tasks for a nurse."
    }

    query GetOverdueTasks is { unitId is UnitId with { briefly "Unit" described by "Unit ID." } } with {
      briefly "Query for overdue tasks"
      described by "Retrieves tasks past due time for escalation."
    }

    query GetTasksByPatient is { patientId is PatientId with { briefly "Patient" described by "Patient ID." } } with {
      briefly "Query for tasks by patient"
      described by "Retrieves all tasks for a patient."
    }

    query GetActiveShifts is { unitId is UnitId with { briefly "Unit" described by "Unit ID." } } with {
      briefly "Query for active shifts"
      described by "Retrieves currently active shifts on a unit."
    }

    query GetShiftSummary is { shiftId is ShiftId with { briefly "Shift" described by "Shift ID." } } with {
      briefly "Query for shift summary"
      described by "Retrieves summary metrics for a shift."
    }

    query GetHandoffReports is { shiftId is ShiftId with { briefly "Shift" described by "Shift ID." } } with {
      briefly "Query for handoff reports"
      described by "Retrieves SBAR handoff reports."
    }

    // Results
    result AssignmentList is { assignments is many optional NurseAssignment with { briefly "Assignments" described by "Assignment list." } } with {
      briefly "List of nurse assignments"
      described by "Contains assignment records matching query criteria."
    }

    result TaskList is { tasks is many optional NursingTask with { briefly "Tasks" described by "Task list." } } with {
      briefly "List of nursing tasks"
      described by "Contains task records matching query criteria."
    }

    result ShiftList is { shifts is many optional ShiftSummary with { briefly "Shifts" described by "Shift list." } } with {
      briefly "List of shift summaries"
      described by "Contains shift summary records."
    }

    result HandoffReportList is { reports is many optional HandoffReport with { briefly "Reports" described by "Report list." } } with {
      briefly "List of handoff reports"
      described by "Contains SBAR handoff reports."
    }

  } with {
    briefly "Persistence and query repository for nursing data"
    described by {
      | Provides storage and retrieval for all nursing workflow data.
      | Supports queries for assignments, tasks, shifts, and handoffs.
      | Enables reporting and analytics on nursing operations.
    }
  }

  // ==========================================================================
  // Projectors
  // ==========================================================================

  projector NursePatientRatioProjector is {

    record NursePatientRatio is {
      unitId is UnitId with { briefly "Unit" described by "Unit ID." }
      shiftDate is Date with { briefly "Date" described by "Shift date." }
      shiftType is String with { briefly "Type" described by "Shift type." }
      averageRatio is Number with { briefly "Average" described by "Average ratio." }
      maxRatio is Number with { briefly "Max" described by "Maximum ratio." }
      minRatio is Number with { briefly "Min" described by "Minimum ratio." }
      totalNurses is Number with { briefly "Nurses" described by "Total nurses." }
      totalPatients is Number with { briefly "Patients" described by "Total patients." }
      acuityAdjustedRatio is Number with { briefly "Adjusted" described by "Acuity-adjusted ratio." }
    } with {
      briefly "Nurse-to-patient ratio metrics"
      described by "Aggregates staffing ratios for compliance and planning."
    }

    handler RatioProjectionHandler is {
      on event PatientsAssigned {
        ???
      } with {
        briefly "Update ratios on assignment"
        described by "Recalculates unit ratios when assignments change."
      }

      on event ShiftStarted {
        ???
      } with {
        briefly "Update ratios on shift start"
        described by "Adds nurse to active count for ratio calculation."
      }

      on event HandoffCompleted {
        ???
      } with {
        briefly "Update ratios on shift end"
        described by "Removes nurse from active count."
      }
    } with {
      briefly "Maintains nurse-patient ratio projections"
      described by "Processes events to keep ratio metrics current."
    }

  } with {
    briefly "Projects nurse-to-patient staffing ratios"
    described by {
      | Maintains real-time and historical nurse-patient ratios by unit.
      | Supports regulatory compliance monitoring and staffing decisions.
      | Includes acuity-adjusted ratios for workload analysis.
    }
  }

  projector TaskCompletionProjector is {

    record TaskCompletionMetrics is {
      unitId is UnitId with { briefly "Unit" described by "Unit ID." }
      shiftDate is Date with { briefly "Date" described by "Shift date." }
      shiftType is String with { briefly "Type" described by "Shift type." }
      totalTasks is Number with { briefly "Total" described by "Total tasks." }
      completedOnTime is Number with { briefly "On time" described by "Completed on time." }
      completedLate is Number with { briefly "Late" described by "Completed late." }
      deferred is Number with { briefly "Deferred" described by "Deferred count." }
      cancelled is Number with { briefly "Cancelled" described by "Cancelled count." }
      completionRate is Number with { briefly "Rate" described by "Completion rate." }
      onTimeRate is Number with { briefly "On time rate" described by "On-time rate." }
      averageCompletionTime is Duration with { briefly "Avg time" described by "Average completion time." }
    } with {
      briefly "Task completion performance metrics"
      described by "Tracks task completion rates and timeliness."
    }

    handler TaskMetricsHandler is {
      on event TaskCreated {
        ???
      } with {
        briefly "Track new tasks"
        described by "Increments total task count."
      }

      on event TaskCompleted {
        ???
      } with {
        briefly "Track completed tasks"
        described by "Updates completion counts and calculates rates."
      }
    } with {
      briefly "Maintains task completion projections"
      described by "Processes task events to maintain metrics."
    }

  } with {
    briefly "Projects task completion rates and performance"
    described by {
      | Tracks task completion metrics for quality improvement.
      | Identifies patterns in task deferral and late completion.
      | Supports nursing leadership dashboards and reporting.
    }
  }

  projector HandoffMetricsProjector is {

    record HandoffMetrics is {
      unitId is UnitId with { briefly "Unit" described by "Unit ID." }
      shiftDate is Date with { briefly "Date" described by "Shift date." }
      totalHandoffs is Number with { briefly "Total" described by "Total handoffs." }
      acknowledgedOnTime is Number with { briefly "On time" described by "Acknowledged on time." }
      averageHandoffDuration is Duration with { briefly "Avg duration" described by "Average handoff duration." }
      tasksTransferred is Number with { briefly "Transferred" described by "Tasks transferred." }
      incompleteHandoffs is Number with { briefly "Incomplete" described by "Incomplete handoffs." }
    } with {
      briefly "Shift handoff quality metrics"
      described by "Tracks handoff completion and quality indicators."
    }

    handler HandoffMetricsHandler is {
      on event HandoffInitiated {
        ???
      } with {
        briefly "Track handoff initiation"
        described by "Records handoff start for duration tracking."
      }

      on event HandoffCompleted {
        ???
      } with {
        briefly "Track handoff completion"
        described by "Updates completion metrics and durations."
      }
    } with {
      briefly "Maintains handoff quality projections"
      described by "Processes handoff events to maintain metrics."
    }

  } with {
    briefly "Projects handoff quality and compliance metrics"
    described by {
      | Monitors shift handoff quality for patient safety.
      | Tracks SBAR compliance and acknowledgment rates.
      | Identifies units with handoff process issues.
    }
  }

} with {
  briefly "Bounded context for nursing workflow operations"
  described by {
    | NursingContext encapsulates all nursing workflow functionality.
    | Contains the NurseShift aggregate and supporting infrastructure.
    | Provides repositories for persistence and projectors for analytics.
    | Integrates with external systems for patient data and orders.
  }
}
