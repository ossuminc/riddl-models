// Supply Order entity for managing the procurement lifecycle

entity SupplyOrder is {

  // ==========================================================================
  // Commands
  // ==========================================================================

  command CreateRequisition is {
    requisitionId is String,
    requestedBy is String,
    requestDate is DateTime,
    items is PurchaseOrderLine+,
    justification is String,
    urgency is String
  } with {
    briefly "Create a new supply requisition"
    described by {
      | Initiates a new requisition for supplies. The requisition must include
      | at least one line item and justification for the request. Urgency can
      | be routine, urgent, or emergency which affects approval routing.
    }
  }

  command ApproveRequisition is {
    requisitionId is String,
    approvedBy is String,
    approvalDate is DateTime,
    approvalNotes is String
  } with {
    briefly "Approve a pending requisition"
    described by {
      | Approves a requisition that is pending approval. Only authorized
      | approvers can approve requisitions. Approval moves the requisition
      | to the approved state where it can be converted to a purchase order.
    }
  }

  command PlaceOrder is {
    purchaseOrderId is PurchaseOrderId,
    requisitionId is String,
    vendorId is String,
    expectedDeliveryDate is Date,
    shippingMethod is String,
    specialInstructions is String
  } with {
    briefly "Convert approved requisition to purchase order"
    described by {
      | Creates a purchase order from an approved requisition and sends
      | it to the specified vendor. The buyer selects the vendor based
      | on pricing, availability, and contract terms.
    }
  }

  command ReceiveShipment is {
    receiptId is ReceiptId,
    purchaseOrderId is PurchaseOrderId,
    receiptDate is DateTime,
    receivedBy is String,
    lines is ReceiptLine+,
    vendorPackingSlip is String,
    discrepancyNotes is String
  } with {
    briefly "Record receipt of a vendor shipment"
    described by {
      | Records the receipt of goods from a vendor. The storekeeper verifies
      | quantities against the purchase order and records any discrepancies.
      | Lot numbers and expiration dates are captured for tracked items.
    }
  }

  command IssueSupplies is {
    issueId is String,
    requestId is String,
    itemId is ItemId,
    quantityIssued is Integer,
    issuedBy is String,
    lotNumber is String,
    departmentCharged is String
  } with {
    briefly "Issue supplies to a requesting department"
    described by {
      | Records the issuance of supplies to a clinical department. The
      | storekeeper picks items (using FEFO for expiration-tracked items),
      | delivers them, and records the transaction for inventory and
      | cost accounting.
    }
  }

  // ==========================================================================
  // Events
  // ==========================================================================

  event RequisitionCreated is {
    requisitionId is String,
    requestedBy is String,
    requestDate is DateTime,
    items is PurchaseOrderLine+,
    justification is String,
    urgency is String
  } with {
    briefly "A new requisition has been created"
    described by {
      | Indicates that a new requisition has been entered into the system
      | and is awaiting approval. The requisition contains the requested
      | items and justification for the purchase.
    }
  }

  event RequisitionApproved is {
    requisitionId is String,
    approvedBy is String,
    approvalDate is DateTime,
    approvalNotes is String
  } with {
    briefly "A requisition has been approved"
    described by {
      | Indicates that a requisition has been approved by an authorized
      | approver and is now ready to be converted to a purchase order.
    }
  }

  event OrderPlaced is {
    purchaseOrderId is PurchaseOrderId,
    requisitionId is String,
    vendorId is String,
    orderDate is Date,
    expectedDeliveryDate is Date,
    totalAmount is Decimal(12, 2)
  } with {
    briefly "A purchase order has been placed with a vendor"
    described by {
      | Indicates that a purchase order has been created and transmitted
      | to the vendor. The order is now in the procurement pipeline awaiting
      | shipment.
    }
  }

  event ShipmentReceived is {
    receiptId is ReceiptId,
    purchaseOrderId is PurchaseOrderId,
    receiptDate is DateTime,
    receivedBy is String,
    linesReceived is Integer,
    totalQuantityReceived is Integer,
    hasDiscrepancies is Boolean
  } with {
    briefly "A shipment has been received from a vendor"
    described by {
      | Indicates that a shipment has arrived and been processed. The event
      | summarizes what was received and flags if there were any discrepancies
      | requiring follow-up with the vendor.
    }
  }

  event SuppliesIssued is {
    issueId is String,
    requestId is String,
    itemId is ItemId,
    quantityIssued is Integer,
    issueDate is DateTime,
    departmentCharged is String,
    costCharged is Decimal(12, 2)
  } with {
    briefly "Supplies have been issued to a department"
    described by {
      | Indicates that supplies have been picked, delivered, and recorded
      | as issued to a clinical department. The cost has been charged to
      | the department's supply budget.
    }
  }

  // ==========================================================================
  // State Data Types
  // ==========================================================================

  record DraftStateData is {
    requisitionId is String,
    requestedBy is String,
    requestDate is DateTime,
    items is PurchaseOrderLine*,
    justification is String,
    urgency is String
  } with {
    briefly "Data for draft requisition state"
    described by "Contains requisition data while in draft mode."
  }

  record PendingApprovalStateData is {
    requisitionId is String,
    requestedBy is String,
    requestDate is DateTime,
    items is PurchaseOrderLine+,
    justification is String,
    urgency is String,
    submittedDate is DateTime
  } with {
    briefly "Data for pending approval state"
    described by "Contains requisition data awaiting management approval."
  }

  record ApprovedStateData is {
    requisitionId is String,
    requestedBy is String,
    items is PurchaseOrderLine+,
    approvedBy is String,
    approvalDate is DateTime,
    approvalNotes is String
  } with {
    briefly "Data for approved requisition state"
    described by "Contains approved requisition ready for ordering."
  }

  record OrderedStateData is {
    purchaseOrderId is PurchaseOrderId,
    requisitionId is String,
    vendorId is String,
    orderDate is Date,
    expectedDeliveryDate is Date,
    lines is PurchaseOrderLine+,
    totalAmount is Decimal(12, 2)
  } with {
    briefly "Data for ordered state"
    described by "Contains purchase order information after vendor submission."
  }

  record PartiallyReceivedStateData is {
    purchaseOrderId is PurchaseOrderId,
    vendorId is String,
    lines is PurchaseOrderLine+,
    receipts is Receipt*,
    totalOrdered is Integer,
    totalReceived is Integer
  } with {
    briefly "Data for partially received state"
    described by "Contains order data with partial receipt information."
  }

  record FullyReceivedStateData is {
    purchaseOrderId is PurchaseOrderId,
    vendorId is String,
    lines is PurchaseOrderLine+,
    receipts is Receipt+,
    completionDate is DateTime
  } with {
    briefly "Data for fully received state"
    described by "Contains complete receipt information."
  }

  record ClosedStateData is {
    purchaseOrderId is PurchaseOrderId,
    closedDate is DateTime,
    closedBy is String,
    finalAmount is Decimal(12, 2)
  } with {
    briefly "Data for closed order state"
    described by "Contains final reconciled order information."
  }

  // ==========================================================================
  // States
  // ==========================================================================

  state DraftState of SupplyOrder.DraftStateData with {
    briefly "Requisition is in draft, not yet submitted"
    described by {
      | The initial state when a requisition is being created. The requisition
      | can be modified freely in this state before submission for approval.
    }
  }

  state PendingApprovalState of SupplyOrder.PendingApprovalStateData with {
    briefly "Requisition awaiting management approval"
    described by {
      | The requisition has been submitted and is awaiting approval from
      | an authorized approver. No modifications are allowed in this state.
    }
  }

  state ApprovedState of SupplyOrder.ApprovedStateData with {
    briefly "Requisition approved, ready for ordering"
    described by {
      | The requisition has been approved and is ready to be converted
      | to a purchase order by the procurement team.
    }
  }

  state OrderedState of SupplyOrder.OrderedStateData with {
    briefly "Purchase order placed with vendor"
    described by {
      | A purchase order has been created and sent to the vendor. The order
      | is now in transit and awaiting delivery.
    }
  }

  state PartiallyReceivedState of SupplyOrder.PartiallyReceivedStateData with {
    briefly "Some items received, more expected"
    described by {
      | Some line items from the purchase order have been received, but
      | the order is not yet complete. Additional shipments are expected.
    }
  }

  state FullyReceivedState of SupplyOrder.FullyReceivedStateData with {
    briefly "All ordered items have been received"
    described by {
      | All items from the purchase order have been received. The order
      | is ready for financial reconciliation and closure.
    }
  }

  state ClosedState of SupplyOrder.ClosedStateData with {
    briefly "Order completed and closed"
    described by {
      | The order has been fully processed, reconciled with finance,
      | and closed. No further activity is expected on this order.
    }
  }

  // ==========================================================================
  // Handler
  // ==========================================================================

  handler SupplyOrderHandler is {
    on command CreateRequisition is {
      tell event RequisitionCreated to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.PendingApprovalState
        with command CreateRequisition
    }
    on command ApproveRequisition is {
      tell event RequisitionApproved to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.ApprovedState
        with command ApproveRequisition
    }
    on command PlaceOrder is {
      tell event OrderPlaced to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.OrderedState
        with command PlaceOrder
    }
    on command ReceiveShipment is {
      tell event ShipmentReceived to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.FullyReceivedState
        with command ReceiveShipment
    }
    on command IssueSupplies is {
      tell event SuppliesIssued to entity SupplyOrder
      prompt "Supplies issued to department"
    }
    on other is {
      error "Unknown command received"
    }
  } with {
    briefly "Command handler for supply order lifecycle"
    described by {
      | Handles all commands related to the supply order lifecycle,
      | from requisition creation through receipt and issuance. Each
      | command is validated before processing and appropriate events
      | are emitted for downstream consumers.
    }
  }

} with {
  option is aggregate
  option is event-sourced
  briefly "Entity managing the supply order procurement lifecycle"
  described by {
    | The SupplyOrder entity is the aggregate root for the procurement
    | process. It manages the complete lifecycle from requisition creation
    | through approval, ordering, receipt, and closure. The entity is
    | event-sourced, maintaining a complete audit trail of all supply
    | chain activities for compliance and analysis.
  }
}
