// Supply Order entity for managing the procurement lifecycle
entity SupplyOrder is {
  // ==========================================================================
  // Commands
  // ==========================================================================
  command CreateRequisition is  {
    requisitionId: String
    requestedBy: String
    requestDate: DateTime
    items: PurchaseOrderLine+
    justification: String
    urgency: String
  } with {
    briefly "Create a new supply requisition"
    described as {
      | Initiates a new requisition for supplies. The requisition must include
      | at least one line item and justification for the request. Urgency can
      | be routine, urgent, or emergency which affects approval routing.
    }
  }
  command ApproveRequisition is  {
    requisitionId: String
    approvedBy: String
    approvalDate: DateTime
    approvalNotes: String
  } with {
    briefly "Approve a pending requisition"
    described as {
      | Approves a requisition that is pending approval. Only authorized
      | approvers can approve requisitions. Approval moves the requisition
      | to the approved state where it can be converted to a purchase order.
    }
  }
  command PlaceOrder is  {
    purchaseOrderId: PurchaseOrderId
    requisitionId: String
    vendorId: String
    expectedDeliveryDate: Date
    shippingMethod: String
    specialInstructions: String
  } with {
    briefly "Convert approved requisition to purchase order"
    described as {
      | Creates a purchase order from an approved requisition and sends
      | it to the specified vendor. The buyer selects the vendor based
      | on pricing, availability, and contract terms.
    }
  }
  command ReceiveShipment is  {
    receiptId: ReceiptId
    purchaseOrderId: PurchaseOrderId
    receiptDate: DateTime
    receivedBy: String
    lines: ReceiptLine+
    vendorPackingSlip: String
    discrepancyNotes: String
  } with {
    briefly "Record receipt of a vendor shipment"
    described as {
      | Records the receipt of goods from a vendor. The storekeeper verifies
      | quantities against the purchase order and records any discrepancies.
      | Lot numbers and expiration dates are captured for tracked items.
    }
  }
  command IssueSupplies is  {
    issueId: String
    requestId: String
    itemId: ItemId
    quantityIssued: Integer
    issuedBy: String
    lotNumber: String
    departmentCharged: String
  } with {
    briefly "Issue supplies to a requesting department"
    described as {
      | Records the issuance of supplies to a clinical department. The
      | storekeeper picks items (using FEFO for expiration-tracked items),
      | delivers them, and records the transaction for inventory and
      | cost accounting.
    }
  }
  // ==========================================================================
  // Events
  // ==========================================================================
  event RequisitionCreated is  {
    requisitionId: String
    requestedBy: String
    requestDate: DateTime
    items: PurchaseOrderLine+
    justification: String
    urgency: String
  } with {
    briefly "A new requisition has been created"
    described as {
      | Indicates that a new requisition has been entered into the system
      | and is awaiting approval. The requisition contains the requested
      | items and justification for the purchase.
    }
  }
  event RequisitionApproved is  {
    requisitionId: String
    approvedBy: String
    approvalDate: DateTime
    approvalNotes: String
  } with {
    briefly "A requisition has been approved"
    described as {
      | Indicates that a requisition has been approved by an authorized
      | approver and is now ready to be converted to a purchase order.
    }
  }
  event OrderPlaced is  {
    purchaseOrderId: PurchaseOrderId
    requisitionId: String
    vendorId: String
    orderDate: Date
    expectedDeliveryDate: Date
    totalAmount: Decimal(12,2)
  } with {
    briefly "A purchase order has been placed with a vendor"
    described as {
      | Indicates that a purchase order has been created and transmitted
      | to the vendor. The order is now in the procurement pipeline awaiting
      | shipment.
    }
  }
  event ShipmentReceived is  {
    receiptId: ReceiptId
    purchaseOrderId: PurchaseOrderId
    receiptDate: DateTime
    receivedBy: String
    linesReceived: Integer
    totalQuantityReceived: Integer
    hasDiscrepancies: Boolean
  } with {
    briefly "A shipment has been received from a vendor"
    described as {
      | Indicates that a shipment has arrived and been processed. The event
      | summarizes what was received and flags if there were any discrepancies
      | requiring follow-up with the vendor.
    }
  }
  event SuppliesIssued is  {
    issueId: String
    requestId: String
    itemId: ItemId
    quantityIssued: Integer
    issueDate: DateTime
    departmentCharged: String
    costCharged: Decimal(12,2)
  } with {
    briefly "Supplies have been issued to a department"
    described as {
      | Indicates that supplies have been picked, delivered, and recorded
      | as issued to a clinical department. The cost has been charged to
      | the department's supply budget.
    }
  }
  // ==========================================================================
  // State Data Types
  // ==========================================================================
  record DraftStateData is  {
    requisitionId: String
    requestedBy: String
    requestDate: DateTime
    items: PurchaseOrderLine*
    justification: String
    urgency: String
  } with {
    briefly "Data for draft requisition state"
    described as {
      |Contains requisition data while in draft mode.
    }
  }
  record PendingApprovalStateData is  {
    requisitionId: String
    requestedBy: String
    requestDate: DateTime
    items: PurchaseOrderLine+
    justification: String
    urgency: String
    submittedDate: DateTime
  } with {
    briefly "Data for pending approval state"
    described as {
      |Contains requisition data awaiting management approval.
    }
  }
  record ApprovedStateData is  {
    requisitionId: String
    requestedBy: String
    items: PurchaseOrderLine+
    approvedBy: String
    approvalDate: DateTime
    approvalNotes: String
  } with {
    briefly "Data for approved requisition state"
    described as {
      |Contains approved requisition ready for ordering.
    }
  }
  record OrderedStateData is  {
    purchaseOrderId: PurchaseOrderId
    requisitionId: String
    vendorId: String
    orderDate: Date
    expectedDeliveryDate: Date
    lines: PurchaseOrderLine+
    totalAmount: Decimal(12,2)
  } with {
    briefly "Data for ordered state"
    described as {
      |Contains purchase order information after vendor submission.
    }
  }
  record PartiallyReceivedStateData is  {
    purchaseOrderId: PurchaseOrderId
    vendorId: String
    lines: PurchaseOrderLine+
    receipts: Receipt*
    totalOrdered: Integer
    totalReceived: Integer
  } with {
    briefly "Data for partially received state"
    described as {
      |Contains order data with partial receipt information.
    }
  }
  record FullyReceivedStateData is  {
    purchaseOrderId: PurchaseOrderId
    vendorId: String
    lines: PurchaseOrderLine+
    receipts: Receipt+
    completionDate: DateTime
  } with {
    briefly "Data for fully received state"
    described as {
      |Contains complete receipt information.
    }
  }
  record ClosedStateData is  {
    purchaseOrderId: PurchaseOrderId
    closedDate: DateTime
    closedBy: String
    finalAmount: Decimal(12,2)
  } with {
    briefly "Data for closed order state"
    described as {
      |Contains final reconciled order information.
    }
  }
  // ==========================================================================
  // States
  // ==========================================================================
  state DraftState of type SupplyOrder.DraftStateData
  state PendingApprovalState of type SupplyOrder.PendingApprovalStateData
  state ApprovedState of type SupplyOrder.ApprovedStateData
  state OrderedState of type SupplyOrder.OrderedStateData
  state PartiallyReceivedState of type SupplyOrder.PartiallyReceivedStateData
  state FullyReceivedState of type SupplyOrder.FullyReceivedStateData
  state ClosedState of type SupplyOrder.ClosedStateData
  // ==========================================================================
  // Handler
  // ==========================================================================
  handler SupplyOrderHandler is {
    on command CreateRequisition is {
      tell event RequisitionCreated to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.PendingApprovalState with command CreateRequisition
    }
    on command ApproveRequisition is {
      tell event RequisitionApproved to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.ApprovedState with command ApproveRequisition
    }
    on command PlaceOrder is {
      tell event OrderPlaced to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.OrderedState with command PlaceOrder
    }
    on command ReceiveShipment is {
      tell event ShipmentReceived to entity SupplyOrder
      morph entity SupplyOrder to state SupplyOrder.FullyReceivedState with command ReceiveShipment
    }
    on command IssueSupplies is {
      tell event SuppliesIssued to entity SupplyOrder
      prompt "Supplies issued to department"
    }
    on other is {
      error "Unknown command received"
    }
  } with {
    briefly "Command handler for supply order lifecycle"
    described as {
      | Handles all commands related to the supply order lifecycle,
      | from requisition creation through receipt and issuance. Each
      | command is validated before processing and appropriate events
      | are emitted for downstream consumers.
    }
  }
} with {
  option aggregate()
  option event-sourced()
  briefly "Entity managing the supply order procurement lifecycle"
  described as {
    | The SupplyOrder entity is the aggregate root for the procurement
    | process. It manages the complete lifecycle from requisition creation
    | through approval, ordering, receipt, and closure. The entity is
    | event-sourced, maintaining a complete audit trail of all supply
    | chain activities for compliance and analysis.
  }
}
