// ImagingExam Entity
// Core entity managing the lifecycle of an imaging examination

entity ImagingExam is {

  // ==========================================================================
  // Commands
  // ==========================================================================

  command OrderExam is {
    examId is ExamId,
    patientId is PatientId,
    orderingPhysicianId is PhysicianId,
    examCode is String,
    examDescription is String,
    modalityType is ModalityType,
    priority is ExamPriority,
    clinicalIndication is String,
    relevantHistory is String,
    specialInstructions is String?
  } with {
    briefly "Order a new imaging examination"
    described by {
      | Initiates the radiology workflow by creating a new imaging
      | order with clinical context and priority.
    }
  }

  command ScheduleExam is {
    examId is ExamId,
    scheduledDateTime is TimeStamp,
    modalityId is ModalityId,
    roomLocation is String,
    scheduledDuration is Duration,
    protocol is ExamProtocol
  } with {
    briefly "Schedule the examination appointment"
    described by {
      | Assigns a specific date, time, modality, and protocol to the
      | ordered examination.
    }
  }

  command CheckInPatient is {
    examId is ExamId,
    checkedInAt is TimeStamp,
    verifiedIdentity is Boolean,
    consentObtained is Boolean,
    screeningCompleted is Boolean
  } with {
    briefly "Check in patient for their scheduled exam"
    described by {
      | Records patient arrival and completion of pre-exam safety
      | screening and consent processes.
    }
  }

  command StartAcquisition is {
    examId is ExamId,
    technicianId is TechnicianId,
    modalityId is ModalityId,
    startedAt is TimeStamp
  } with {
    briefly "Begin image acquisition"
    described by {
      | Marks the start of the imaging procedure when the technician
      | begins acquiring images.
    }
  }

  command CompleteAcquisition is {
    examId is ExamId,
    studyInfo is StudyInfo,
    completedAt is TimeStamp,
    technicianNotes is String?
  } with {
    briefly "Complete image acquisition"
    described by {
      | Records completion of imaging with DICOM study metadata and
      | technician notes about the examination.
    }
  }

  command CreateDraftReport is {
    examId is ExamId,
    radiologistId is PhysicianId,
    findings is String,
    impression is String,
    recommendations is String?,
    comparisonStudies is StudyId*
  } with {
    briefly "Create initial draft report"
    described by {
      | Radiologist creates the preliminary interpretation of the
      | imaging study.
    }
  }

  command FinalizeReport is {
    examId is ExamId,
    reportId is ReportId,
    radiologistId is PhysicianId,
    signedAt is TimeStamp
  } with {
    briefly "Sign and finalize the radiology report"
    described by {
      | Radiologist electronically signs the report, making it
      | available to ordering physicians.
    }
  }

  command AddAddendum is {
    examId is ExamId,
    reportId is ReportId,
    radiologistId is PhysicianId,
    addendumText is String,
    addendumReason is String
  } with {
    briefly "Add an addendum to a finalized report"
    described by {
      | Allows radiologist to add supplementary information to a
      | finalized report without modifying the original interpretation.
    }
  }

  command ReportCriticalFinding is {
    examId is ExamId,
    finding is CriticalFinding
  } with {
    briefly "Report a critical finding requiring immediate communication"
    described by {
      | Initiates the critical finding communication workflow per
      | ACR guidelines for urgent results.
    }
  }

  // ==========================================================================
  // Events
  // ==========================================================================

  event ExamOrdered is {
    examId is ExamId,
    order is ImagingOrder,
    orderedAt is TimeStamp
  } with {
    briefly "Imaging examination has been ordered"
    described by {
      | Records the creation of a new imaging order, capturing all
      | clinical context and priority information.
    }
  }

  event ExamScheduled is {
    examId is ExamId,
    scheduledDateTime is TimeStamp,
    modalityId is ModalityId,
    roomLocation is String,
    protocol is ExamProtocol,
    scheduledBy is String
  } with {
    briefly "Examination has been scheduled"
    described by {
      | Records the appointment details including time, location,
      | and selected imaging protocol.
    }
  }

  event PatientCheckedIn is {
    examId is ExamId,
    checkedInAt is TimeStamp,
    screeningCompleted is Boolean
  } with {
    briefly "Patient has checked in for examination"
    described by {
      | Records patient arrival and completion of safety screening
      | procedures.
    }
  }

  event AcquisitionStarted is {
    examId is ExamId,
    technicianId is TechnicianId,
    modalityId is ModalityId,
    startedAt is TimeStamp
  } with {
    briefly "Image acquisition has begun"
    described by "Records the start of the imaging procedure."
  }

  event AcquisitionCompleted is {
    examId is ExamId,
    studyInfo is StudyInfo,
    completedAt is TimeStamp,
    technicianNotes is String?
  } with {
    briefly "Image acquisition has completed"
    described by {
      | Records successful completion of imaging with all DICOM
      | study metadata.
    }
  }

  event DraftReportCreated is {
    examId is ExamId,
    reportId is ReportId,
    radiologistId is PhysicianId,
    findings is String,
    impression is String,
    recommendations is String?,
    createdAt is TimeStamp
  } with {
    briefly "Draft radiology report has been created"
    described by {
      | Records the preliminary interpretation awaiting final
      | signature.
    }
  }

  event ReportFinalized is {
    examId is ExamId,
    reportId is ReportId,
    radiologistId is PhysicianId,
    signedAt is TimeStamp
  } with {
    briefly "Radiology report has been finalized"
    described by {
      | Records the electronic signature and finalization of the
      | radiology report.
    }
  }

  event AddendumAdded is {
    examId is ExamId,
    reportId is ReportId,
    radiologistId is PhysicianId,
    addendumText is String,
    addendumReason is String,
    addedAt is TimeStamp
  } with {
    briefly "Addendum has been added to report"
    described by {
      | Records the addition of supplementary information to a
      | finalized report.
    }
  }

  event CriticalFindingReported is {
    examId is ExamId,
    finding is CriticalFinding,
    reportedAt is TimeStamp
  } with {
    briefly "Critical finding has been reported"
    described by {
      | Records identification of a critical finding requiring
      | immediate physician notification.
    }
  }

  // ==========================================================================
  // State Data Types
  // ==========================================================================

  record OrderedStateData is {
    examId is ExamId,
    order is ImagingOrder,
    orderedAt is TimeStamp
  } with {
    briefly "Data for ordered state"
    described by "Contains the original imaging order information."
  }

  record ScheduledStateData is {
    examId is ExamId,
    order is ImagingOrder,
    scheduledDateTime is TimeStamp,
    modalityId is ModalityId,
    roomLocation is String,
    protocol is ExamProtocol
  } with {
    briefly "Data for scheduled state"
    described by "Contains order and scheduling information."
  }

  record AcquisitionStateData is {
    examId is ExamId,
    order is ImagingOrder,
    scheduledDateTime is TimeStamp,
    modalityId is ModalityId,
    checkedInAt is TimeStamp,
    technicianId is TechnicianId?,
    acquisitionStartedAt is TimeStamp?
  } with {
    briefly "Data for acquisition state"
    described by "Contains order, schedule, and acquisition progress information."
  }

  record InterpretationStateData is {
    examId is ExamId,
    order is ImagingOrder,
    studyInfo is StudyInfo,
    completedAt is TimeStamp,
    draftReport is RadiologyReport?
  } with {
    briefly "Data for interpretation state"
    described by "Contains study information awaiting interpretation."
  }

  record FinalizedStateData is {
    examId is ExamId,
    order is ImagingOrder,
    studyInfo is StudyInfo,
    report is RadiologyReport,
    finalizedAt is TimeStamp,
    addendums is RadiologyReport*
  } with {
    briefly "Data for finalized state"
    described by "Contains complete exam record with finalized report."
  }

  // ==========================================================================
  // States
  // ==========================================================================

  state OrderedState of ImagingExam.OrderedStateData with {
    briefly "Examination has been ordered but not yet scheduled"
    described by {
      | Initial state after an imaging order is placed. The exam
      | awaits scheduling on an appropriate modality.
    }
  }

  state ScheduledState of ImagingExam.ScheduledStateData with {
    briefly "Examination has been scheduled"
    described by {
      | Exam has an assigned appointment time and modality. Patient
      | is expected to arrive at scheduled time.
    }
  }

  state AcquisitionState of ImagingExam.AcquisitionStateData with {
    briefly "Image acquisition in progress"
    described by {
      | Patient has checked in and imaging is being performed. Images
      | are being acquired and will be sent to PACS.
    }
  }

  state InterpretationState of ImagingExam.InterpretationStateData with {
    briefly "Awaiting radiologist interpretation"
    described by {
      | Images have been acquired and are available in PACS for
      | radiologist review and interpretation.
    }
  }

  state FinalizedState of ImagingExam.FinalizedStateData with {
    briefly "Report has been finalized"
    described by {
      | Radiologist has signed the report and it has been distributed
      | to ordering physicians. Only addendums can be added.
    }
  }

  // ==========================================================================
  // Handler
  // ==========================================================================

  handler ImagingExamHandler is {
    on command OrderExam is {
      tell event ExamOrdered to entity ImagingExam
      morph entity ImagingExam to state ImagingExam.OrderedState
        with command OrderExam
    }
    on command ScheduleExam is {
      tell event ExamScheduled to entity ImagingExam
      morph entity ImagingExam to state ImagingExam.ScheduledState
        with command ScheduleExam
    }
    on command CheckInPatient is {
      tell event PatientCheckedIn to entity ImagingExam
      morph entity ImagingExam to state ImagingExam.AcquisitionState
        with command CheckInPatient
    }
    on command StartAcquisition is {
      tell event AcquisitionStarted to entity ImagingExam
      prompt "Begin image acquisition"
    }
    on command CompleteAcquisition is {
      tell event AcquisitionCompleted to entity ImagingExam
      morph entity ImagingExam to state ImagingExam.InterpretationState
        with command CompleteAcquisition
    }
    on command CreateDraftReport is {
      tell event DraftReportCreated to entity ImagingExam
      prompt "Draft report created, awaiting signature"
    }
    on command FinalizeReport is {
      tell event ReportFinalized to entity ImagingExam
      morph entity ImagingExam to state ImagingExam.FinalizedState
        with command FinalizeReport
    }
    on command AddAddendum is {
      tell event AddendumAdded to entity ImagingExam
      prompt "Addendum added to finalized report"
    }
    on command ReportCriticalFinding is {
      tell event CriticalFindingReported to entity ImagingExam
      prompt "Critical finding communication initiated"
    }
    on other is {
      error "Unknown command received"
    }
  } with {
    briefly "Main command handler for imaging exams"
    described by {
      | Processes all commands for the ImagingExam entity, managing
      | state transitions and emitting events for each workflow step.
    }
  }

} with {
  option is aggregate
  option is event-sourced
  briefly "Imaging examination aggregate"
  described by {
    | The ImagingExam entity manages the complete lifecycle of a radiology
    | examination from initial order through final report. It coordinates
    | scheduling, patient workflow, image acquisition, and interpretation
    | while ensuring proper state transitions and audit trail.
  }
}
