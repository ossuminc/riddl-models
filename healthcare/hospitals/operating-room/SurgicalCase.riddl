// Operating Room Management - Surgical Case Entity
entity SurgicalCase is {
  // Commands
  command ScheduleCase is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |New surgical case identifier.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient undergoing surgery.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Primary surgeon"
      described as {
        |Lead surgeon for the procedure.
      }
    }
    procedureId: ProcedureId with {
      briefly "Procedure"
      described as {
        |Surgical procedure to perform.
      }
    }
    procedureName: String(1,500) with {
      briefly "Procedure name"
      described as {
        |Description of surgery.
      }
    }
    diagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Indication for surgery.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Case urgency level.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Requested surgery date.
      }
    }
    scheduledStartTime: Time with {
      briefly "Start time"
      described as {
        |Requested start time.
      }
    }
    estimatedDuration: Duration with {
      briefly "Duration"
      described as {
        |Expected procedure length.
      }
    }
    anesthesiaType: AnesthesiaType with {
      briefly "Anesthesia"
      described as {
        |Type of anesthesia required.
      }
    }
    roomId: RoomId with {
      briefly "Room"
      described as {
        |Assigned operating room.
      }
    }
    roomName: String(1,50) with {
      briefly "Room name"
      described as {
        |Operating room name.
      }
    }
  } with {
    briefly "Schedule surgical case"
    described as {
      |Creates a new scheduled surgical case.
    }
  }
  command ConfirmCase is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    anesthesiologistId: AnesthesiologistId with {
      briefly "Anesthesiologist"
      described as {
        |Assigned anesthesiologist.
      }
    }
    surgicalTeam: SurgicalTeam with {
      briefly "Team"
      described as {
        |Assigned surgical team.
      }
    }
    preferenceCard: PreferenceCard with {
      briefly "Preference card"
      described as {
        |Surgeon's preference card for this procedure.
      }
    }
  } with {
    briefly "Confirm surgical case"
    described as {
      |Confirms case with team and resource assignments.
    }
  }
  command StartPreOp is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    preOpArrivalTime: TimeStamp with {
      briefly "Arrival time"
      described as {
        |When patient arrived in pre-op.
      }
    }
    preOpBayNumber: String(1,20) with {
      briefly "Bay number"
      described as {
        |Pre-op holding bay assignment.
      }
    }
  } with {
    briefly "Start pre-operative process"
    described as {
      |Records patient arrival in pre-op holding.
    }
  }
  command BringToOR is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    inRoomTime: TimeStamp with {
      briefly "In room time"
      described as {
        |When patient entered the OR.
      }
    }
    roomReadyConfirmed: Boolean with {
      briefly "Room ready"
      described as {
        |Confirmation that room is set up.
      }
    }
  } with {
    briefly "Bring patient to OR"
    described as {
      |Records patient entry into the operating room.
    }
  }
  command StartSurgery is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    anesthesiaStartTime: TimeStamp with {
      briefly "Anesthesia start"
      described as {
        |When anesthesia began.
      }
    }
    procedureStartTime: TimeStamp with {
      briefly "Procedure start"
      described as {
        |When incision/procedure began.
      }
    }
    timeoutCompleted: Boolean with {
      briefly "Timeout"
      described as {
        |Surgical safety timeout completed.
      }
    }
  } with {
    briefly "Start surgery"
    described as {
      |Records the start of the surgical procedure.
    }
  }
  command CompleteSurgery is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    procedureEndTime: TimeStamp with {
      briefly "Procedure end"
      described as {
        |When procedure completed.
      }
    }
    anesthesiaEndTime: TimeStamp with {
      briefly "Anesthesia end"
      described as {
        |When anesthesia concluded.
      }
    }
    proceduresPerformed: String(1,500)+ with {
      briefly "Procedures"
      described as {
        |Procedures actually performed.
      }
    }
    complications: String(1,2000)? with {
      briefly "Complications"
      described as {
        |Any intraoperative complications.
      }
    }
    estimatedBloodLoss: Natural? with {
      briefly "EBL"
      described as {
        |Estimated blood loss in mL.
      }
    }
  } with {
    briefly "Complete surgery"
    described as {
      |Records completion of the surgical procedure.
    }
  }
  command MoveToRecovery is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    outOfRoomTime: TimeStamp with {
      briefly "Out of room"
      described as {
        |When patient left OR.
      }
    }
    pacuArrivalTime: TimeStamp with {
      briefly "PACU arrival"
      described as {
        |When patient arrived in PACU.
      }
    }
    pacuBayNumber: String(1,20) with {
      briefly "PACU bay"
      described as {
        |PACU bay assignment.
      }
    }
  } with {
    briefly "Move to recovery"
    described as {
      |Records patient transfer from OR to PACU.
    }
  }
  command DischargeFromPACU is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    pacuDischargeTime: TimeStamp with {
      briefly "Discharge time"
      described as {
        |When patient was discharged from PACU.
      }
    }
    aldeeteScore: Natural with {
      briefly "Aldrete score"
      described as {
        |Discharge readiness score.
      }
    }
    disposition: String(1,100) with {
      briefly "Disposition"
      described as {
        |Where patient is going.
      }
    }
    dischargeInstructions: String(1,2000)? with {
      briefly "Instructions"
      described as {
        |Post-op care instructions.
      }
    }
  } with {
    briefly "Discharge from PACU"
    described as {
      |Records patient discharge from post-anesthesia care.
    }
  }
  command CancelCase is  {
    caseId: CaseId with {
      briefly "Case ID"
      described as {
        |Surgical case identifier.
      }
    }
    cancellationReason: CancellationReason with {
      briefly "Reason"
      described as {
        |Why case was cancelled.
      }
    }
    cancellationDetails: String(1,1000)? with {
      briefly "Details"
      described as {
        |Additional cancellation information.
      }
    }
    cancelledBy: UUID with {
      briefly "Cancelled by"
      described as {
        |Person who cancelled the case.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled at"
      described as {
        |When cancellation occurred.
      }
    }
    rescheduleRequested: Boolean with {
      briefly "Reschedule"
      described as {
        |Whether rescheduling is requested.
      }
    }
  } with {
    briefly "Cancel surgical case"
    described as {
      |Cancels a scheduled surgical case.
    }
  }
  // Events
  event CaseScheduled is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    procedureName: String(1,500) with {
      briefly "Procedure"
      described as {
        |Procedure name.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Surgery date.
      }
    }
    scheduledStartTime: Time with {
      briefly "Time"
      described as {
        |Start time.
      }
    }
    roomId: RoomId with {
      briefly "Room"
      described as {
        |Assigned room.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Case priority.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |When case was scheduled.
      }
    }
  } with {
    briefly "Case scheduled"
    described as {
      |Emitted when a surgical case is scheduled.
    }
  }
  event CaseConfirmed is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    anesthesiologistId: AnesthesiologistId with {
      briefly "Anesthesiologist"
      described as {
        |Assigned anesthesiologist.
      }
    }
    surgicalTeam: SurgicalTeam with {
      briefly "Team"
      described as {
        |Surgical team.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Case confirmed"
    described as {
      |Emitted when case is confirmed with team assignments.
    }
  }
  event PreOpStarted is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    preOpArrivalTime: TimeStamp with {
      briefly "Arrival"
      described as {
        |Pre-op arrival time.
      }
    }
    preOpBayNumber: String(1,20) with {
      briefly "Bay"
      described as {
        |Pre-op bay.
      }
    }
  } with {
    briefly "Pre-op started"
    described as {
      |Emitted when patient arrives in pre-op holding.
    }
  }
  event PatientInOR is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    roomId: RoomId with {
      briefly "Room"
      described as {
        |Operating room.
      }
    }
    inRoomTime: TimeStamp with {
      briefly "In room"
      described as {
        |Time entered OR.
      }
    }
  } with {
    briefly "Patient in OR"
    described as {
      |Emitted when patient enters the operating room.
    }
  }
  event SurgeryStarted is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    procedureStartTime: TimeStamp with {
      briefly "Start"
      described as {
        |Procedure start time.
      }
    }
    anesthesiaStartTime: TimeStamp with {
      briefly "Anesthesia"
      described as {
        |Anesthesia start.
      }
    }
  } with {
    briefly "Surgery started"
    described as {
      |Emitted when surgical procedure begins.
    }
  }
  event SurgeryCompleted is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    procedureEndTime: TimeStamp with {
      briefly "End"
      described as {
        |Procedure end time.
      }
    }
    proceduresPerformed: String(1,500)+ with {
      briefly "Procedures"
      described as {
        |Procedures done.
      }
    }
    complications: String(1,2000)? with {
      briefly "Complications"
      described as {
        |Any complications.
      }
    }
    estimatedBloodLoss: Natural? with {
      briefly "EBL"
      described as {
        |Blood loss mL.
      }
    }
  } with {
    briefly "Surgery completed"
    described as {
      |Emitted when surgical procedure is completed.
    }
  }
  event InRecovery is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    pacuArrivalTime: TimeStamp with {
      briefly "Arrival"
      described as {
        |PACU arrival time.
      }
    }
    pacuBayNumber: String(1,20) with {
      briefly "Bay"
      described as {
        |PACU bay.
      }
    }
  } with {
    briefly "In recovery"
    described as {
      |Emitted when patient arrives in PACU.
    }
  }
  event DischargedFromPACU is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    pacuDischargeTime: TimeStamp with {
      briefly "Discharge"
      described as {
        |Discharge time.
      }
    }
    disposition: String(1,100) with {
      briefly "Disposition"
      described as {
        |Discharge destination.
      }
    }
    aldeeteScore: Natural with {
      briefly "Aldrete"
      described as {
        |Discharge score.
      }
    }
  } with {
    briefly "Discharged from PACU"
    described as {
      |Emitted when patient is discharged from recovery.
    }
  }
  event CaseCancelled is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    cancellationReason: CancellationReason with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    cancellationDetails: String(1,1000)? with {
      briefly "Details"
      described as {
        |Additional details.
      }
    }
    cancelledBy: UUID with {
      briefly "Cancelled by"
      described as {
        |Who cancelled.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled at"
      described as {
        |Cancellation time.
      }
    }
    rescheduleRequested: Boolean with {
      briefly "Reschedule"
      described as {
        |Rescheduling requested.
      }
    }
  } with {
    briefly "Case cancelled"
    described as {
      |Emitted when a surgical case is cancelled.
    }
  }
  // State Records
  record ScheduledStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    procedureId: ProcedureId with {
      briefly "Procedure ID"
      described as {
        |Procedure identifier.
      }
    }
    procedureName: String(1,500) with {
      briefly "Procedure"
      described as {
        |Procedure name.
      }
    }
    diagnosis: String(1,500) with {
      briefly "Diagnosis"
      described as {
        |Surgical indication.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Case priority.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Surgery date.
      }
    }
    scheduledStartTime: Time with {
      briefly "Time"
      described as {
        |Start time.
      }
    }
    estimatedDuration: Duration with {
      briefly "Duration"
      described as {
        |Expected duration.
      }
    }
    anesthesiaType: AnesthesiaType with {
      briefly "Anesthesia"
      described as {
        |Anesthesia type.
      }
    }
    roomAssignment: RoomAssignment with {
      briefly "Room"
      described as {
        |Room assignment.
      }
    }
    surgicalTeam: SurgicalTeam? with {
      briefly "Team"
      described as {
        |Surgical team.
      }
    }
    preferenceCard: PreferenceCard? with {
      briefly "Preferences"
      described as {
        |Surgeon preferences.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |When scheduled.
      }
    }
  } with {
    briefly "Scheduled state data"
    described as {
      |State for a scheduled surgical case awaiting day of surgery.
    }
  }
  record PreOpStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    procedureName: String(1,500) with {
      briefly "Procedure"
      described as {
        |Procedure name.
      }
    }
    priority: CasePriority with {
      briefly "Priority"
      described as {
        |Case priority.
      }
    }
    anesthesiaType: AnesthesiaType with {
      briefly "Anesthesia"
      described as {
        |Anesthesia type.
      }
    }
    roomAssignment: RoomAssignment with {
      briefly "Room"
      described as {
        |Room assignment.
      }
    }
    surgicalTeam: SurgicalTeam with {
      briefly "Team"
      described as {
        |Surgical team.
      }
    }
    preferenceCard: PreferenceCard with {
      briefly "Preferences"
      described as {
        |Surgeon preferences.
      }
    }
    caseTiming: CaseTiming with {
      briefly "Timing"
      described as {
        |Case timing data.
      }
    }
    preOpBayNumber: String(1,20) with {
      briefly "Bay"
      described as {
        |Pre-op bay.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
  } with {
    briefly "Pre-op state data"
    described as {
      |State for a case in pre-operative holding.
    }
  }
  record InSurgeryStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    procedureName: String(1,500) with {
      briefly "Procedure"
      described as {
        |Procedure name.
      }
    }
    anesthesiaType: AnesthesiaType with {
      briefly "Anesthesia"
      described as {
        |Anesthesia type.
      }
    }
    roomAssignment: RoomAssignment with {
      briefly "Room"
      described as {
        |Room assignment.
      }
    }
    surgicalTeam: SurgicalTeam with {
      briefly "Team"
      described as {
        |Surgical team.
      }
    }
    caseTiming: CaseTiming with {
      briefly "Timing"
      described as {
        |Case timing data.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
  } with {
    briefly "In-surgery state data"
    described as {
      |State for a case actively in the operating room.
    }
  }
  record RecoveryStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    proceduresPerformed: String(1,500)+ with {
      briefly "Procedures"
      described as {
        |Procedures performed.
      }
    }
    caseTiming: CaseTiming with {
      briefly "Timing"
      described as {
        |Case timing data.
      }
    }
    pacuBayNumber: String(1,20) with {
      briefly "Bay"
      described as {
        |PACU bay.
      }
    }
    complications: String(1,2000)? with {
      briefly "Complications"
      described as {
        |Any complications.
      }
    }
    estimatedBloodLoss: Natural? with {
      briefly "EBL"
      described as {
        |Blood loss mL.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
  } with {
    briefly "Recovery state data"
    described as {
      |State for a case in post-anesthesia recovery.
    }
  }
  record CompletedStateData is  {
    caseId: CaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    primarySurgeonId: SurgeonId with {
      briefly "Surgeon"
      described as {
        |Primary surgeon.
      }
    }
    proceduresPerformed: String(1,500)+ with {
      briefly "Procedures"
      described as {
        |Procedures performed.
      }
    }
    caseTiming: CaseTiming with {
      briefly "Timing"
      described as {
        |Complete timing data.
      }
    }
    complications: String(1,2000)? with {
      briefly "Complications"
      described as {
        |Any complications.
      }
    }
    estimatedBloodLoss: Natural? with {
      briefly "EBL"
      described as {
        |Blood loss mL.
      }
    }
    disposition: String(1,100) with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    aldeeteScore: Natural with {
      briefly "Aldrete"
      described as {
        |Discharge score.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state data"
    described as {
      |State for a fully completed surgical case.
    }
  }
  // States
  state ScheduledState of type SurgicalCase.ScheduledStateData
  state PreOpState of type SurgicalCase.PreOpStateData
  state InSurgeryState of type SurgicalCase.InSurgeryStateData
  state RecoveryState of type SurgicalCase.RecoveryStateData
  state CompletedState of type SurgicalCase.CompletedStateData
  // Handler
  handler SurgicalCaseHandler is {
    on command ScheduleCase is {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.ScheduledState with command ScheduleCase
      tell event CaseScheduled to entity ORContext.SurgicalCase
    }
    on command ConfirmCase is {
      tell event CaseConfirmed to entity ORContext.SurgicalCase
    }
    on command StartPreOp is {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.PreOpState with command StartPreOp
      tell event PreOpStarted to entity ORContext.SurgicalCase
    }
    on command BringToOR is {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.InSurgeryState with command BringToOR
      tell event PatientInOR to entity ORContext.SurgicalCase
    }
    on command StartSurgery is {
      tell event SurgeryStarted to entity ORContext.SurgicalCase
    }
    on command CompleteSurgery is {
      tell event SurgeryCompleted to entity ORContext.SurgicalCase
    }
    on command MoveToRecovery is {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.RecoveryState with command MoveToRecovery
      tell event InRecovery to entity ORContext.SurgicalCase
    }
    on command DischargeFromPACU is {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.CompletedState with command DischargeFromPACU
      tell event DischargedFromPACU to entity ORContext.SurgicalCase
    }
    on command CancelCase is {
      tell event CaseCancelled to entity ORContext.SurgicalCase
    }
  } with {
    briefly "Processes surgical case commands"
    described as {
      | Handles the complete surgical case lifecycle from scheduling
      | through surgery completion and PACU discharge.
    }
  }
} with {
  briefly "Surgical case aggregate"
  described as {
    | The SurgicalCase entity manages a surgical procedure
    | from scheduling through post-operative recovery.
  }
}
