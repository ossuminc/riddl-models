// Operating Room Management - Surgical Case Entity

entity SurgicalCase is {

  // Commands
  command ScheduleCase is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "New surgical case identifier."
    }
    patientId is PatientId with {
      briefly "Patient"
      described by "Patient undergoing surgery."
    }
    primarySurgeonId is SurgeonId with {
      briefly "Primary surgeon"
      described by "Lead surgeon for the procedure."
    }
    procedureId is ProcedureId with {
      briefly "Procedure"
      described by "Surgical procedure to perform."
    }
    procedureName is String(1, 500) with {
      briefly "Procedure name"
      described by "Description of surgery."
    }
    diagnosis is String(1, 500) with {
      briefly "Diagnosis"
      described by "Indication for surgery."
    }
    priority is CasePriority with {
      briefly "Priority"
      described by "Case urgency level."
    }
    scheduledDate is Date with {
      briefly "Date"
      described by "Requested surgery date."
    }
    scheduledStartTime is Time with {
      briefly "Start time"
      described by "Requested start time."
    }
    estimatedDuration is Duration with {
      briefly "Duration"
      described by "Expected procedure length."
    }
    anesthesiaType is AnesthesiaType with {
      briefly "Anesthesia"
      described by "Type of anesthesia required."
    }
    roomId is RoomId with {
      briefly "Room"
      described by "Assigned operating room."
    }
    roomName is String(1, 50) with {
      briefly "Room name"
      described by "Operating room name."
    }
  } with {
    briefly "Schedule surgical case"
    described by "Creates a new scheduled surgical case."
  }

  command ConfirmCase is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    anesthesiologistId is AnesthesiologistId with {
      briefly "Anesthesiologist"
      described by "Assigned anesthesiologist."
    }
    surgicalTeam is SurgicalTeam with {
      briefly "Team"
      described by "Assigned surgical team."
    }
    preferenceCard is PreferenceCard with {
      briefly "Preference card"
      described by "Surgeon's preference card for this procedure."
    }
  } with {
    briefly "Confirm surgical case"
    described by "Confirms case with team and resource assignments."
  }

  command StartPreOp is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    preOpArrivalTime is TimeStamp with {
      briefly "Arrival time"
      described by "When patient arrived in pre-op."
    }
    preOpBayNumber is String(1, 20) with {
      briefly "Bay number"
      described by "Pre-op holding bay assignment."
    }
  } with {
    briefly "Start pre-operative process"
    described by "Records patient arrival in pre-op holding."
  }

  command BringToOR is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    inRoomTime is TimeStamp with {
      briefly "In room time"
      described by "When patient entered the OR."
    }
    roomReadyConfirmed is Boolean with {
      briefly "Room ready"
      described by "Confirmation that room is set up."
    }
  } with {
    briefly "Bring patient to OR"
    described by "Records patient entry into the operating room."
  }

  command StartSurgery is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    anesthesiaStartTime is TimeStamp with {
      briefly "Anesthesia start"
      described by "When anesthesia began."
    }
    procedureStartTime is TimeStamp with {
      briefly "Procedure start"
      described by "When incision/procedure began."
    }
    timeoutCompleted is Boolean with {
      briefly "Timeout"
      described by "Surgical safety timeout completed."
    }
  } with {
    briefly "Start surgery"
    described by "Records the start of the surgical procedure."
  }

  command CompleteSurgery is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    procedureEndTime is TimeStamp with {
      briefly "Procedure end"
      described by "When procedure completed."
    }
    anesthesiaEndTime is TimeStamp with {
      briefly "Anesthesia end"
      described by "When anesthesia concluded."
    }
    proceduresPerformed is many String(1, 500) with {
      briefly "Procedures"
      described by "Procedures actually performed."
    }
    complications is optional String(1, 2000) with {
      briefly "Complications"
      described by "Any intraoperative complications."
    }
    estimatedBloodLoss is optional Natural with {
      briefly "EBL"
      described by "Estimated blood loss in mL."
    }
  } with {
    briefly "Complete surgery"
    described by "Records completion of the surgical procedure."
  }

  command MoveToRecovery is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    outOfRoomTime is TimeStamp with {
      briefly "Out of room"
      described by "When patient left OR."
    }
    pacuArrivalTime is TimeStamp with {
      briefly "PACU arrival"
      described by "When patient arrived in PACU."
    }
    pacuBayNumber is String(1, 20) with {
      briefly "PACU bay"
      described by "PACU bay assignment."
    }
  } with {
    briefly "Move to recovery"
    described by "Records patient transfer from OR to PACU."
  }

  command DischargeFromPACU is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    pacuDischargeTime is TimeStamp with {
      briefly "Discharge time"
      described by "When patient was discharged from PACU."
    }
    aldeeteScore is Natural with {
      briefly "Aldrete score"
      described by "Discharge readiness score."
    }
    disposition is String(1, 100) with {
      briefly "Disposition"
      described by "Where patient is going."
    }
    dischargeInstructions is optional String(1, 2000) with {
      briefly "Instructions"
      described by "Post-op care instructions."
    }
  } with {
    briefly "Discharge from PACU"
    described by "Records patient discharge from post-anesthesia care."
  }

  command CancelCase is {
    caseId is CaseId with {
      briefly "Case ID"
      described by "Surgical case identifier."
    }
    cancellationReason is CancellationReason with {
      briefly "Reason"
      described by "Why case was cancelled."
    }
    cancellationDetails is optional String(1, 1000) with {
      briefly "Details"
      described by "Additional cancellation information."
    }
    cancelledBy is UUID with {
      briefly "Cancelled by"
      described by "Person who cancelled the case."
    }
    cancelledAt is TimeStamp with {
      briefly "Cancelled at"
      described by "When cancellation occurred."
    }
    rescheduleRequested is Boolean with {
      briefly "Reschedule"
      described by "Whether rescheduling is requested."
    }
  } with {
    briefly "Cancel surgical case"
    described by "Cancels a scheduled surgical case."
  }

  // Events
  event CaseScheduled is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    procedureName is String(1, 500) with { briefly "Procedure" described by "Procedure name." }
    scheduledDate is Date with { briefly "Date" described by "Surgery date." }
    scheduledStartTime is Time with { briefly "Time" described by "Start time." }
    roomId is RoomId with { briefly "Room" described by "Assigned room." }
    priority is CasePriority with { briefly "Priority" described by "Case priority." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "When case was scheduled." }
  } with {
    briefly "Case scheduled"
    described by "Emitted when a surgical case is scheduled."
  }

  event CaseConfirmed is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    anesthesiologistId is AnesthesiologistId with { briefly "Anesthesiologist" described by "Assigned anesthesiologist." }
    surgicalTeam is SurgicalTeam with { briefly "Team" described by "Surgical team." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Case confirmed"
    described by "Emitted when case is confirmed with team assignments."
  }

  event PreOpStarted is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    preOpArrivalTime is TimeStamp with { briefly "Arrival" described by "Pre-op arrival time." }
    preOpBayNumber is String(1, 20) with { briefly "Bay" described by "Pre-op bay." }
  } with {
    briefly "Pre-op started"
    described by "Emitted when patient arrives in pre-op holding."
  }

  event PatientInOR is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    roomId is RoomId with { briefly "Room" described by "Operating room." }
    inRoomTime is TimeStamp with { briefly "In room" described by "Time entered OR." }
  } with {
    briefly "Patient in OR"
    described by "Emitted when patient enters the operating room."
  }

  event SurgeryStarted is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    procedureStartTime is TimeStamp with { briefly "Start" described by "Procedure start time." }
    anesthesiaStartTime is TimeStamp with { briefly "Anesthesia" described by "Anesthesia start." }
  } with {
    briefly "Surgery started"
    described by "Emitted when surgical procedure begins."
  }

  event SurgeryCompleted is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    procedureEndTime is TimeStamp with { briefly "End" described by "Procedure end time." }
    proceduresPerformed is many String(1, 500) with { briefly "Procedures" described by "Procedures done." }
    complications is optional String(1, 2000) with { briefly "Complications" described by "Any complications." }
    estimatedBloodLoss is optional Natural with { briefly "EBL" described by "Blood loss mL." }
  } with {
    briefly "Surgery completed"
    described by "Emitted when surgical procedure is completed."
  }

  event InRecovery is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    pacuArrivalTime is TimeStamp with { briefly "Arrival" described by "PACU arrival time." }
    pacuBayNumber is String(1, 20) with { briefly "Bay" described by "PACU bay." }
  } with {
    briefly "In recovery"
    described by "Emitted when patient arrives in PACU."
  }

  event DischargedFromPACU is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    pacuDischargeTime is TimeStamp with { briefly "Discharge" described by "Discharge time." }
    disposition is String(1, 100) with { briefly "Disposition" described by "Discharge destination." }
    aldeeteScore is Natural with { briefly "Aldrete" described by "Discharge score." }
  } with {
    briefly "Discharged from PACU"
    described by "Emitted when patient is discharged from recovery."
  }

  event CaseCancelled is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    cancellationReason is CancellationReason with { briefly "Reason" described by "Cancellation reason." }
    cancellationDetails is optional String(1, 1000) with { briefly "Details" described by "Additional details." }
    cancelledBy is UUID with { briefly "Cancelled by" described by "Who cancelled." }
    cancelledAt is TimeStamp with { briefly "Cancelled at" described by "Cancellation time." }
    rescheduleRequested is Boolean with { briefly "Reschedule" described by "Rescheduling requested." }
  } with {
    briefly "Case cancelled"
    described by "Emitted when a surgical case is cancelled."
  }

  // State Records
  record ScheduledStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    procedureId is ProcedureId with { briefly "Procedure ID" described by "Procedure identifier." }
    procedureName is String(1, 500) with { briefly "Procedure" described by "Procedure name." }
    diagnosis is String(1, 500) with { briefly "Diagnosis" described by "Surgical indication." }
    priority is CasePriority with { briefly "Priority" described by "Case priority." }
    scheduledDate is Date with { briefly "Date" described by "Surgery date." }
    scheduledStartTime is Time with { briefly "Time" described by "Start time." }
    estimatedDuration is Duration with { briefly "Duration" described by "Expected duration." }
    anesthesiaType is AnesthesiaType with { briefly "Anesthesia" described by "Anesthesia type." }
    roomAssignment is RoomAssignment with { briefly "Room" described by "Room assignment." }
    surgicalTeam is optional SurgicalTeam with { briefly "Team" described by "Surgical team." }
    preferenceCard is optional PreferenceCard with { briefly "Preferences" described by "Surgeon preferences." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "When scheduled." }
  } with {
    briefly "Scheduled state data"
    described by "State for a scheduled surgical case awaiting day of surgery."
  }

  record PreOpStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    procedureName is String(1, 500) with { briefly "Procedure" described by "Procedure name." }
    priority is CasePriority with { briefly "Priority" described by "Case priority." }
    anesthesiaType is AnesthesiaType with { briefly "Anesthesia" described by "Anesthesia type." }
    roomAssignment is RoomAssignment with { briefly "Room" described by "Room assignment." }
    surgicalTeam is SurgicalTeam with { briefly "Team" described by "Surgical team." }
    preferenceCard is PreferenceCard with { briefly "Preferences" described by "Surgeon preferences." }
    caseTiming is CaseTiming with { briefly "Timing" described by "Case timing data." }
    preOpBayNumber is String(1, 20) with { briefly "Bay" described by "Pre-op bay." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
  } with {
    briefly "Pre-op state data"
    described by "State for a case in pre-operative holding."
  }

  record InSurgeryStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    procedureName is String(1, 500) with { briefly "Procedure" described by "Procedure name." }
    anesthesiaType is AnesthesiaType with { briefly "Anesthesia" described by "Anesthesia type." }
    roomAssignment is RoomAssignment with { briefly "Room" described by "Room assignment." }
    surgicalTeam is SurgicalTeam with { briefly "Team" described by "Surgical team." }
    caseTiming is CaseTiming with { briefly "Timing" described by "Case timing data." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
  } with {
    briefly "In-surgery state data"
    described by "State for a case actively in the operating room."
  }

  record RecoveryStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    proceduresPerformed is many String(1, 500) with { briefly "Procedures" described by "Procedures performed." }
    caseTiming is CaseTiming with { briefly "Timing" described by "Case timing data." }
    pacuBayNumber is String(1, 20) with { briefly "Bay" described by "PACU bay." }
    complications is optional String(1, 2000) with { briefly "Complications" described by "Any complications." }
    estimatedBloodLoss is optional Natural with { briefly "EBL" described by "Blood loss mL." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
  } with {
    briefly "Recovery state data"
    described by "State for a case in post-anesthesia recovery."
  }

  record CompletedStateData is {
    caseId is CaseId with { briefly "Case" described by "Case ID." }
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    primarySurgeonId is SurgeonId with { briefly "Surgeon" described by "Primary surgeon." }
    proceduresPerformed is many String(1, 500) with { briefly "Procedures" described by "Procedures performed." }
    caseTiming is CaseTiming with { briefly "Timing" described by "Complete timing data." }
    complications is optional String(1, 2000) with { briefly "Complications" described by "Any complications." }
    estimatedBloodLoss is optional Natural with { briefly "EBL" described by "Blood loss mL." }
    disposition is String(1, 100) with { briefly "Disposition" described by "Final disposition." }
    aldeeteScore is Natural with { briefly "Aldrete" described by "Discharge score." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state data"
    described by "State for a fully completed surgical case."
  }

  // States
  state ScheduledState of SurgicalCase.ScheduledStateData with {
    briefly "Case scheduled"
    described by "Surgical case is scheduled and awaiting day of surgery."
  }

  state PreOpState of SurgicalCase.PreOpStateData with {
    briefly "Patient in pre-op"
    described by "Patient has arrived in pre-operative holding."
  }

  state InSurgeryState of SurgicalCase.InSurgeryStateData with {
    briefly "In surgery"
    described by "Patient is in the operating room for surgery."
  }

  state RecoveryState of SurgicalCase.RecoveryStateData with {
    briefly "In recovery"
    described by "Patient is recovering in PACU."
  }

  state CompletedState of SurgicalCase.CompletedStateData with {
    briefly "Case completed"
    described by "Surgical case has been completed and patient discharged from PACU."
  }

  // Handler
  handler SurgicalCaseHandler is {
    on command ScheduleCase {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.ScheduledState with command ScheduleCase
      tell event CaseScheduled to entity ORContext.SurgicalCase
    }

    on command ConfirmCase {
      tell event CaseConfirmed to entity ORContext.SurgicalCase
    }

    on command StartPreOp {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.PreOpState with command StartPreOp
      tell event PreOpStarted to entity ORContext.SurgicalCase
    }

    on command BringToOR {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.InSurgeryState with command BringToOR
      tell event PatientInOR to entity ORContext.SurgicalCase
    }

    on command StartSurgery {
      tell event SurgeryStarted to entity ORContext.SurgicalCase
    }

    on command CompleteSurgery {
      tell event SurgeryCompleted to entity ORContext.SurgicalCase
    }

    on command MoveToRecovery {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.RecoveryState with command MoveToRecovery
      tell event InRecovery to entity ORContext.SurgicalCase
    }

    on command DischargeFromPACU {
      morph entity ORContext.SurgicalCase to state ORContext.SurgicalCase.CompletedState with command DischargeFromPACU
      tell event DischargedFromPACU to entity ORContext.SurgicalCase
    }

    on command CancelCase {
      tell event CaseCancelled to entity ORContext.SurgicalCase
    }
  } with {
    briefly "Processes surgical case commands"
    described by {
      | Handles the complete surgical case lifecycle from scheduling
      | through surgery completion and PACU discharge.
    }
  }

} with {
  briefly "Surgical case aggregate"
  described by {
    | The SurgicalCase entity manages a surgical procedure
    | from scheduling through post-operative recovery.
  }
}
