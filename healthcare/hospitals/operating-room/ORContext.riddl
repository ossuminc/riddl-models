// Operating Room Management - OR Context
context ORContext is {
  include "types.riddl"
  include "SurgicalCase.riddl"
  // Repository for surgical case persistence
  repository SurgicalCaseRepository is {
    schema SurgicalCaseData is relational
      of cases as type SurgicalCase
        index on field SurgicalCase.caseId
        index on field SurgicalCase.patientId
        index on field SurgicalCase.primarySurgeonId

    handler SurgicalCasePersistence is {
      on command SurgicalCase.ScheduleCase is {
        prompt "Store new surgical case record"
      }
      on command SurgicalCase.ConfirmCase is {
        prompt "Update case with team and preference card"
      }
      on command SurgicalCase.StartPreOp is {
        prompt "Update case with pre-op arrival time"
      }
      on command SurgicalCase.BringToOR is {
        prompt "Update case with in-room time"
      }
      on command SurgicalCase.StartSurgery is {
        prompt "Update case with procedure start time"
      }
      on command SurgicalCase.CompleteSurgery is {
        prompt "Update case with procedure end and outcomes"
      }
      on command SurgicalCase.MoveToRecovery is {
        prompt "Update case with PACU arrival time"
      }
      on command SurgicalCase.DischargeFromPACU is {
        prompt "Update case to completed status"
      }
      on command SurgicalCase.CancelCase is {
        prompt "Update case to cancelled status"
      }
    } with {
      briefly "Persists surgical case events"
      described as {
        |Handles command-driven persistence for surgical cases.
      }
    }
  } with {
    briefly "Surgical case persistence"
    described as {
      | The SurgicalCaseRepository provides persistent storage for
      | surgical case records and timing milestones.
    }
  }
  // Repository for OR schedule
  repository ORScheduleRepository is {
    schema ORScheduleData is relational
      of schedules as type RoomAssignment
        index on field RoomAssignment.roomId
        index on field RoomAssignment.assignedDate
        index on field RoomAssignment.caseId

    handler SchedulePersistence is {
      on command SurgicalCase.ScheduleCase is {
        prompt "Create room assignment for scheduled case"
      }
      on command SurgicalCase.CancelCase is {
        prompt "Remove room assignment for cancelled case"
      }
    } with {
      briefly "Persists OR schedule"
      described as {
        |Maintains operating room schedule assignments.
      }
    }
  } with {
    briefly "OR schedule persistence"
    described as {
      | The ORScheduleRepository tracks room assignments and
      | the daily operating room schedule.
    }
  }
  // Projector for OR utilization metrics
  projector ORUtilizationProjector is {
    record UtilizationStats is  {
      roomId: RoomId with {
        briefly "Room"
        described as {
          |Operating room.
        }
      }
      roomName: String(1,50) with {
        briefly "Name"
        described as {
          |Room name.
        }
      }
      periodDate: Date with {
        briefly "Date"
        described as {
          |Statistics date.
        }
      }
      scheduledMinutes: Natural with {
        briefly "Scheduled"
        described as {
          |Total scheduled minutes.
        }
      }
      actualMinutes: Natural with {
        briefly "Actual"
        described as {
          |Actual utilized minutes.
        }
      }
      availableMinutes: Natural with {
        briefly "Available"
        described as {
          |Total available minutes.
        }
      }
      utilizationRate: Decimal(5,4) with {
        briefly "Rate"
        described as {
          |Utilization percentage.
        }
      }
      casesScheduled: Natural with {
        briefly "Cases scheduled"
        described as {
          |Number of cases scheduled.
        }
      }
      casesCompleted: Natural with {
        briefly "Cases completed"
        described as {
          |Number of cases completed.
        }
      }
      casesCancelled: Natural with {
        briefly "Cancelled"
        described as {
          |Number cancelled same day.
        }
      }
    } with {
      briefly "Utilization statistics"
      described as {
        |Operating room utilization metrics by room and date.
      }
    }
    handler UtilizationHandler is {
      on event SurgicalCase.CaseScheduled is {
        prompt "Update scheduled minutes for room"
      }
      on event SurgicalCase.SurgeryCompleted is {
        prompt "Update actual minutes and cases completed"
      }
      on event SurgicalCase.CaseCancelled is {
        prompt "Update cancellation count if same day"
      }
    } with {
      briefly "Maintains utilization metrics"
      described as {
        |Projects case events into utilization statistics.
      }
    }
  } with {
    briefly "OR utilization projections"
    described as {
      |Maintains real-time operating room utilization analytics.
    }
  }
  // Projector for case duration analytics
  projector CaseDurationProjector is {
    record DurationStats is  {
      procedureId: ProcedureId with {
        briefly "Procedure"
        described as {
          |Procedure type.
        }
      }
      procedureName: String(1,500) with {
        briefly "Name"
        described as {
          |Procedure name.
        }
      }
      surgeonId: SurgeonId? with {
        briefly "Surgeon"
        described as {
          |Surgeon filter.
        }
      }
      averageDuration: Duration with {
        briefly "Avg duration"
        described as {
          |Average procedure time.
        }
      }
      medianDuration: Duration with {
        briefly "Median"
        described as {
          |Median procedure time.
        }
      }
      minDuration: Duration with {
        briefly "Min"
        described as {
          |Shortest procedure.
        }
      }
      maxDuration: Duration with {
        briefly "Max"
        described as {
          |Longest procedure.
        }
      }
      standardDeviation: Decimal(8,2) with {
        briefly "Std dev"
        described as {
          |Duration variability.
        }
      }
      caseCount: Natural with {
        briefly "Cases"
        described as {
          |Number of cases analyzed.
        }
      }
      periodStart: Date with {
        briefly "Start"
        described as {
          |Analysis period start.
        }
      }
      periodEnd: Date with {
        briefly "End"
        described as {
          |Analysis period end.
        }
      }
    } with {
      briefly "Duration statistics"
      described as {
        |Surgical procedure duration analytics.
      }
    }
    handler DurationHandler is {
      on event SurgicalCase.SurgeryCompleted is {
        prompt "Update duration statistics for procedure and surgeon"
      }
    } with {
      briefly "Maintains duration metrics"
      described as {
        |Projects surgery completion into duration analytics.
      }
    }
  } with {
    briefly "Case duration projections"
    described as {
      |Maintains surgical procedure duration analytics for scheduling accuracy.
    }
  }
  // Projector for turnover time analytics
  projector TurnoverTimeProjector is {
    record TurnoverStats is  {
      roomId: RoomId with {
        briefly "Room"
        described as {
          |Operating room.
        }
      }
      periodDate: Date with {
        briefly "Date"
        described as {
          |Statistics date.
        }
      }
      averageTurnoverMinutes: Natural with {
        briefly "Avg turnover"
        described as {
          |Average turnover time.
        }
      }
      medianTurnoverMinutes: Natural with {
        briefly "Median"
        described as {
          |Median turnover time.
        }
      }
      targetTurnoverMinutes: Natural with {
        briefly "Target"
        described as {
          |Target turnover time.
        }
      }
      turnoversOnTarget: Natural with {
        briefly "On target"
        described as {
          |Turnovers meeting target.
        }
      }
      turnoversDelayed: Natural with {
        briefly "Delayed"
        described as {
          |Turnovers exceeding target.
        }
      }
      totalTurnovers: Natural with {
        briefly "Total"
        described as {
          |Total turnovers.
        }
      }
      delayMinutesTotal: Natural with {
        briefly "Delay total"
        described as {
          |Total delay minutes.
        }
      }
      commonDelayReasons: String(1,200)+ with {
        briefly "Delay reasons"
        described as {
          |Most common delay causes.
        }
      }
    } with {
      briefly "Turnover statistics"
      described as {
        |Room turnover time metrics.
      }
    }
    handler TurnoverHandler is {
      on event SurgicalCase.PatientInOR is {
        prompt "Calculate turnover time from previous case"
      }
      on event SurgicalCase.SurgeryCompleted is {
        prompt "Record case end for next turnover calculation"
      }
    } with {
      briefly "Maintains turnover metrics"
      described as {
        |Projects case events into turnover analytics.
      }
    }
  } with {
    briefly "Turnover time projections"
    described as {
      |Maintains room turnover time analytics for efficiency improvement.
    }
  }
  // Projector for cancellation analytics
  projector CancellationRateProjector is {
    record CancellationStats is  {
      periodStart: Date with {
        briefly "Start"
        described as {
          |Period start date.
        }
      }
      periodEnd: Date with {
        briefly "End"
        described as {
          |Period end date.
        }
      }
      totalScheduled: Natural with {
        briefly "Scheduled"
        described as {
          |Total cases scheduled.
        }
      }
      totalCancelled: Natural with {
        briefly "Cancelled"
        described as {
          |Total cancellations.
        }
      }
      cancellationRate: Decimal(5,4) with {
        briefly "Rate"
        described as {
          |Cancellation percentage.
        }
      }
      sameDayCancellations: Natural with {
        briefly "Same day"
        described as {
          |Same-day cancellations.
        }
      }
      byReason: String(1,200)+ with {
        briefly "By reason"
        described as {
          |Cancellations by reason.
        }
      }
      bySurgeon: String(1,200)+ with {
        briefly "By surgeon"
        described as {
          |Cancellations by surgeon.
        }
      }
      byServiceLine: String(1,200)+ with {
        briefly "By service"
        described as {
          |Cancellations by service line.
        }
      }
      preventableCancellations: Natural with {
        briefly "Preventable"
        described as {
          |Potentially preventable cancellations.
        }
      }
    } with {
      briefly "Cancellation statistics"
      described as {
        |Surgical case cancellation analytics.
      }
    }
    handler CancellationHandler is {
      on event SurgicalCase.CaseScheduled is {
        prompt "Increment scheduled cases count"
      }
      on event SurgicalCase.CaseCancelled is {
        prompt "Update cancellation statistics by reason and timing"
      }
    } with {
      briefly "Maintains cancellation metrics"
      described as {
        |Projects cancellation events into analytics.
      }
    }
  } with {
    briefly "Cancellation rate projections"
    described as {
      |Maintains surgical cancellation analytics for quality improvement.
    }
  }
  // Projector for first case on-time starts
  projector FirstCaseStartProjector is {
    record FirstCaseStats is  {
      roomId: RoomId with {
        briefly "Room"
        described as {
          |Operating room.
        }
      }
      periodDate: Date with {
        briefly "Date"
        described as {
          |Statistics date.
        }
      }
      scheduledStartTime: Time with {
        briefly "Scheduled"
        described as {
          |Scheduled start time.
        }
      }
      actualStartTime: Time with {
        briefly "Actual"
        described as {
          |Actual start time.
        }
      }
      delayMinutes: Integer with {
        briefly "Delay"
        described as {
          |Minutes delayed (negative is early).
        }
      }
      onTimeStart: Boolean with {
        briefly "On time"
        described as {
          |Started within 5 minutes of scheduled.
        }
      }
      delayReason: String(1,500)? with {
        briefly "Reason"
        described as {
          |Cause of delay if any.
        }
      }
    } with {
      briefly "First case start statistics"
      described as {
        |First case on-time start metrics.
      }
    }
    handler FirstCaseHandler is {
      on event SurgicalCase.SurgeryStarted is {
        prompt "Compare actual start to scheduled for first case of day"
      }
    } with {
      briefly "Maintains first case metrics"
      described as {
        |Projects surgery starts into first case analytics.
      }
    }
  } with {
    briefly "First case on-time projections"
    described as {
      |Maintains first case on-time start analytics.
    }
  }
} with {
  briefly "Bounded context for operating room management"
  described as {
    | The ORContext is the bounded context for surgical case
    | scheduling, perioperative workflow, and OR analytics.
  }
}
