// Clinical Encounter - Encounter Context

context EncounterContext is {

  include "types.riddl"
  include "Encounter.riddl"

  // Repository for encounter persistence
  repository EncounterRepository is {
    schema EncounterData is relational
      of encounters as Encounter
      index on field Encounter.encounterId
      index on field Encounter.patient.patientId

    handler EncounterPersistence is {
      on command Encounter.StartEncounter {
        prompt "Store new encounter"
      }
      on command Encounter.RecordVitals {
        prompt "Store vital signs"
      }
      on command Encounter.RecordChiefComplaint {
        prompt "Store chief complaint"
      }
      on command Encounter.AddClinicalNote {
        prompt "Store clinical note"
      }
      on command Encounter.AddDiagnosis {
        prompt "Store diagnosis"
      }
      on command Encounter.RecordProcedure {
        prompt "Store procedure"
      }
      on command Encounter.PlaceOrder {
        prompt "Store order"
      }
      on command Encounter.SignNote {
        prompt "Update note signature"
      }
      on command Encounter.CompleteEncounter {
        prompt "Update encounter to complete"
      }
      on command Encounter.CancelEncounter {
        prompt "Update encounter to canceled"
      }
    } with {
      briefly "Persists encounter commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Encounter data persistence"
    described by {
      | The EncounterRepository provides persistent storage for
      | clinical encounters and documentation.
    }
  }

  // Projector for encounter analytics
  projector EncounterAnalytics is {
    updates repository EncounterRepository

    record EncounterStats is {
      totalEncounters is Natural with { briefly "Total" described by "Total encounters." }
      avgDuration is Duration with { briefly "Avg duration" described by "Average encounter length." }
      encountersByType is many String(1, 100) with { briefly "By type" described by "Counts by type." }
      completionRate is Decimal(5, 4) with { briefly "Completion" described by "Completion rate." }
      avgDiagnoses is Decimal(4, 2) with { briefly "Avg diagnoses" described by "Average diagnoses per visit." }
    } with {
      briefly "Encounter statistics"
      described by "Clinical encounter metrics."
    }

    handler AnalyticsHandler is {
      on event Encounter.EncounterStarted {
        prompt "Update encounter counts"
      }
      on event Encounter.EncounterCompleted {
        prompt "Update completion metrics"
      }
      on event Encounter.DiagnosisAdded {
        prompt "Update diagnosis metrics"
      }
    } with {
      briefly "Maintains encounter analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Encounter analytics projections"
    described by "Maintains clinical encounter analytics data."
  }

} with {
  briefly "Bounded context for clinical encounters"
  described by {
    | The EncounterContext is the bounded context for
    | clinical visit documentation and management.
  }
}
