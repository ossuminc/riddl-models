// Clinical Encounter - Encounter Entity

entity Encounter is {

  // Commands
  command StartEncounter is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "New encounter identifier."
    }
    patient is PatientInfo with {
      briefly "Patient"
      described by "Patient information."
    }
    provider is ProviderInfo with {
      briefly "Provider"
      described by "Treating provider."
    }
    facilityId is FacilityId with {
      briefly "Facility"
      described by "Healthcare facility."
    }
    encounterType is EncounterType with {
      briefly "Type"
      described by "Encounter type."
    }
    visitReason is VisitReason with {
      briefly "Reason"
      described by "Visit reason."
    }
  } with {
    briefly "Start encounter"
    described by "Begins a clinical encounter."
  }

  command RecordVitals is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    vitals is VitalSigns with {
      briefly "Vitals"
      described by "Vital signs."
    }
  } with {
    briefly "Record vitals"
    described by "Records patient vital signs."
  }

  command RecordChiefComplaint is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    complaint is ChiefComplaint with {
      briefly "Complaint"
      described by "Chief complaint."
    }
  } with {
    briefly "Record complaint"
    described by "Records chief complaint."
  }

  command AddClinicalNote is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    note is ClinicalNote with {
      briefly "Note"
      described by "Clinical note."
    }
  } with {
    briefly "Add note"
    described by "Adds clinical documentation."
  }

  command AddDiagnosis is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    diagnosis is Diagnosis with {
      briefly "Diagnosis"
      described by "Clinical diagnosis."
    }
  } with {
    briefly "Add diagnosis"
    described by "Records a diagnosis."
  }

  command RecordProcedure is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    encounterProcedure is EncounterProcedure with {
      briefly "Procedure"
      described by "Procedure performed."
    }
  } with {
    briefly "Record procedure"
    described by "Records a procedure."
  }

  command PlaceOrder is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    order is EncounterOrder with {
      briefly "Order"
      described by "Clinical order."
    }
  } with {
    briefly "Place order"
    described by "Places a clinical order."
  }

  command SignNote is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    noteType is String(1, 50) with {
      briefly "Note type"
      described by "Type of note to sign."
    }
    signedBy is ProviderId with {
      briefly "Signed by"
      described by "Signing provider."
    }
  } with {
    briefly "Sign note"
    described by "Signs clinical documentation."
  }

  command CompleteEncounter is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    disposition is DispositionInfo with {
      briefly "Disposition"
      described by "Patient disposition."
    }
  } with {
    briefly "Complete encounter"
    described by "Completes the encounter."
  }

  command CancelEncounter is {
    encounterId is EncounterId with {
      briefly "Encounter ID"
      described by "Encounter identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel encounter"
    described by "Cancels the encounter."
  }

  // Events
  event EncounterStarted is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    encounterType is EncounterType with { briefly "Type" described by "Encounter type." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Encounter started"
    described by "Emitted when encounter begins."
  }

  event VitalsRecorded is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    vitals is VitalSigns with { briefly "Vitals" described by "Vital signs." }
  } with {
    briefly "Vitals recorded"
    described by "Emitted when vitals are recorded."
  }

  event ChiefComplaintRecorded is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    complaint is ChiefComplaint with { briefly "Complaint" described by "Chief complaint." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Complaint recorded"
    described by "Emitted when complaint is recorded."
  }

  event ClinicalNoteAdded is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    note is ClinicalNote with { briefly "Note" described by "Clinical note." }
  } with {
    briefly "Note added"
    described by "Emitted when note is added."
  }

  event DiagnosisAdded is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    diagnosis is Diagnosis with { briefly "Diagnosis" described by "Added diagnosis." }
  } with {
    briefly "Diagnosis added"
    described by "Emitted when diagnosis is recorded."
  }

  event ProcedureRecorded is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    encounterProcedure is EncounterProcedure with { briefly "Procedure" described by "Procedure performed." }
  } with {
    briefly "Procedure recorded"
    described by "Emitted when procedure is documented."
  }

  event OrderPlaced is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    order is EncounterOrder with { briefly "Order" described by "Placed order." }
  } with {
    briefly "Order placed"
    described by "Emitted when order is placed."
  }

  event NoteSigned is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    noteType is String(1, 50) with { briefly "Note type" described by "Signed note type." }
    signedBy is ProviderId with { briefly "Signed by" described by "Signing provider." }
    signedAt is TimeStamp with { briefly "Signed" described by "Signature time." }
  } with {
    briefly "Note signed"
    described by "Emitted when note is signed."
  }

  event EncounterCompleted is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    disposition is DispositionInfo with { briefly "Disposition" described by "Final disposition." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Encounter completed"
    described by "Emitted when encounter ends."
  }

  event EncounterCanceled is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Cancel reason." }
    canceledAt is TimeStamp with { briefly "Canceled" described by "Cancel time." }
  } with {
    briefly "Encounter canceled"
    described by "Emitted when encounter is canceled."
  }

  // State Records
  record InProgressStateData is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    facilityId is FacilityId with { briefly "Facility" described by "Facility ID." }
    encounterType is EncounterType with { briefly "Type" described by "Encounter type." }
    visitReason is VisitReason with { briefly "Reason" described by "Visit reason." }
    vitals is optional VitalSigns with { briefly "Vitals" described by "Vital signs." }
    chiefComplaint is optional ChiefComplaint with { briefly "Complaint" described by "Chief complaint." }
    notes is many optional ClinicalNote with { briefly "Notes" described by "Clinical notes." }
    diagnoses is many optional Diagnosis with { briefly "Diagnoses" described by "Diagnoses." }
    procedures is many optional EncounterProcedure with { briefly "Procedures" described by "Procedures." }
    orders is many optional EncounterOrder with { briefly "Orders" described by "Orders placed." }
    status is EncounterStatus with { briefly "Status" described by "Encounter status." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "In progress state"
    described by "State for active encounter."
  }

  record CompletedStateData is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    provider is ProviderInfo with { briefly "Provider" described by "Provider info." }
    encounterType is EncounterType with { briefly "Type" described by "Encounter type." }
    vitals is optional VitalSigns with { briefly "Vitals" described by "Final vitals." }
    diagnoses is many Diagnosis with { briefly "Diagnoses" described by "Final diagnoses." }
    procedures is many optional EncounterProcedure with { briefly "Procedures" described by "Procedures." }
    disposition is DispositionInfo with { briefly "Disposition" described by "Disposition." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state"
    described by "State for completed encounter."
  }

  record CanceledStateData is {
    encounterId is EncounterId with { briefly "Encounter" described by "Encounter ID." }
    patient is PatientInfo with { briefly "Patient" described by "Patient info." }
    reason is String(1, 200) with { briefly "Reason" described by "Cancel reason." }
    canceledAt is TimeStamp with { briefly "Canceled" described by "Cancel time." }
  } with {
    briefly "Canceled state"
    described by "State for canceled encounter."
  }

  // States
  state InProgressState of Encounter.InProgressStateData with {
    briefly "Encounter in progress"
    described by "Active clinical encounter."
  }

  state CompletedState of Encounter.CompletedStateData with {
    briefly "Encounter completed"
    described by "Finished clinical encounter."
  }

  state CanceledState of Encounter.CanceledStateData with {
    briefly "Encounter canceled"
    described by "Canceled clinical encounter."
  }

  // Handler
  handler EncounterHandler is {
    on command StartEncounter {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.InProgressState with command StartEncounter
      tell event EncounterStarted to entity EncounterContext.Encounter
    }

    on command RecordVitals {
      tell event VitalsRecorded to entity EncounterContext.Encounter
    }

    on command RecordChiefComplaint {
      tell event ChiefComplaintRecorded to entity EncounterContext.Encounter
    }

    on command AddClinicalNote {
      tell event ClinicalNoteAdded to entity EncounterContext.Encounter
    }

    on command AddDiagnosis {
      tell event DiagnosisAdded to entity EncounterContext.Encounter
    }

    on command RecordProcedure {
      tell event ProcedureRecorded to entity EncounterContext.Encounter
    }

    on command PlaceOrder {
      tell event OrderPlaced to entity EncounterContext.Encounter
    }

    on command SignNote {
      tell event NoteSigned to entity EncounterContext.Encounter
    }

    on command CompleteEncounter {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.CompletedState with command CompleteEncounter
      tell event EncounterCompleted to entity EncounterContext.Encounter
    }

    on command CancelEncounter {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.CanceledState with command CancelEncounter
      tell event EncounterCanceled to entity EncounterContext.Encounter
    }
  } with {
    briefly "Processes encounter commands"
    described by {
      | Handles clinical encounter lifecycle from start
      | through documentation, orders, and completion.
    }
  }

} with {
  briefly "Encounter aggregate"
  described by {
    | The Encounter entity manages clinical encounters
    | including documentation, diagnoses, and orders.
  }
}
