// Clinical Encounter - Encounter Entity
entity Encounter is {
  // Commands
  command StartEncounter is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |New encounter identifier.
      }
    }
    patient: PatientInfo with {
      briefly "Patient"
      described as {
        |Patient information.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Treating provider.
      }
    }
    facilityId: FacilityId with {
      briefly "Facility"
      described as {
        |Healthcare facility.
      }
    }
    encounterType: EncounterType with {
      briefly "Type"
      described as {
        |Encounter type.
      }
    }
    visitReason: VisitReason with {
      briefly "Reason"
      described as {
        |Visit reason.
      }
    }
  } with {
    briefly "Start encounter"
    described as {
      |Begins a clinical encounter.
    }
  }
  command RecordVitals is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    vitals: VitalSigns with {
      briefly "Vitals"
      described as {
        |Vital signs.
      }
    }
  } with {
    briefly "Record vitals"
    described as {
      |Records patient vital signs.
    }
  }
  command RecordChiefComplaint is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    complaint: ChiefComplaint with {
      briefly "Complaint"
      described as {
        |Chief complaint.
      }
    }
  } with {
    briefly "Record complaint"
    described as {
      |Records chief complaint.
    }
  }
  command AddClinicalNote is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    note: ClinicalNote with {
      briefly "Note"
      described as {
        |Clinical note.
      }
    }
  } with {
    briefly "Add note"
    described as {
      |Adds clinical documentation.
    }
  }
  command AddDiagnosis is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    diagnosis: Diagnosis with {
      briefly "Diagnosis"
      described as {
        |Clinical diagnosis.
      }
    }
  } with {
    briefly "Add diagnosis"
    described as {
      |Records a diagnosis.
    }
  }
  command RecordProcedure is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    encounterProcedure: EncounterProcedure with {
      briefly "Procedure"
      described as {
        |Procedure performed.
      }
    }
  } with {
    briefly "Record procedure"
    described as {
      |Records a procedure.
    }
  }
  command PlaceOrder is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    order: EncounterOrder with {
      briefly "Order"
      described as {
        |Clinical order.
      }
    }
  } with {
    briefly "Place order"
    described as {
      |Places a clinical order.
    }
  }
  command SignNote is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    noteType: String(1,50) with {
      briefly "Note type"
      described as {
        |Type of note to sign.
      }
    }
    signedBy: ProviderId with {
      briefly "Signed by"
      described as {
        |Signing provider.
      }
    }
  } with {
    briefly "Sign note"
    described as {
      |Signs clinical documentation.
    }
  }
  command CompleteEncounter is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    disposition: DispositionInfo with {
      briefly "Disposition"
      described as {
        |Patient disposition.
      }
    }
  } with {
    briefly "Complete encounter"
    described as {
      |Completes the encounter.
    }
  }
  command CancelEncounter is  {
    encounterId: EncounterId with {
      briefly "Encounter ID"
      described as {
        |Encounter identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel encounter"
    described as {
      |Cancels the encounter.
    }
  }
  // Events
  event EncounterStarted is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    patient: PatientInfo with {
      briefly "Patient"
      described as {
        |Patient info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    facilityId: FacilityId with {
      briefly "Facility"
      described as {
        |Facility ID.
      }
    }
    encounterType: EncounterType with {
      briefly "Type"
      described as {
        |Encounter type.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Encounter started"
    described as {
      |Emitted when encounter begins.
    }
  }
  event VitalsRecorded is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    vitals: VitalSigns with {
      briefly "Vitals"
      described as {
        |Vital signs.
      }
    }
  } with {
    briefly "Vitals recorded"
    described as {
      |Emitted when vitals are recorded.
    }
  }
  event ChiefComplaintRecorded is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    complaint: ChiefComplaint with {
      briefly "Complaint"
      described as {
        |Chief complaint.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Complaint recorded"
    described as {
      |Emitted when complaint is recorded.
    }
  }
  event ClinicalNoteAdded is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    note: ClinicalNote with {
      briefly "Note"
      described as {
        |Clinical note.
      }
    }
  } with {
    briefly "Note added"
    described as {
      |Emitted when note is added.
    }
  }
  event DiagnosisAdded is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    diagnosis: Diagnosis with {
      briefly "Diagnosis"
      described as {
        |Added diagnosis.
      }
    }
  } with {
    briefly "Diagnosis added"
    described as {
      |Emitted when diagnosis is recorded.
    }
  }
  event ProcedureRecorded is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    encounterProcedure: EncounterProcedure with {
      briefly "Procedure"
      described as {
        |Procedure performed.
      }
    }
  } with {
    briefly "Procedure recorded"
    described as {
      |Emitted when procedure is documented.
    }
  }
  event OrderPlaced is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    order: EncounterOrder with {
      briefly "Order"
      described as {
        |Placed order.
      }
    }
  } with {
    briefly "Order placed"
    described as {
      |Emitted when order is placed.
    }
  }
  event NoteSigned is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    noteType: String(1,50) with {
      briefly "Note type"
      described as {
        |Signed note type.
      }
    }
    signedBy: ProviderId with {
      briefly "Signed by"
      described as {
        |Signing provider.
      }
    }
    signatureTime: TimeStamp with {
      briefly "Signed"
      described as {
        |Signature time.
      }
    }
  } with {
    briefly "Note signed"
    described as {
      |Emitted when note is signed.
    }
  }
  event EncounterCompleted is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    disposition: DispositionInfo with {
      briefly "Disposition"
      described as {
        |Final disposition.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Encounter completed"
    described as {
      |Emitted when encounter ends.
    }
  }
  event EncounterCanceled is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    canceledAt: TimeStamp with {
      briefly "Canceled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Encounter canceled"
    described as {
      |Emitted when encounter is canceled.
    }
  }
  // State Records
  record InProgressStateData is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    patient: PatientInfo with {
      briefly "Patient"
      described as {
        |Patient info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    facilityId: FacilityId with {
      briefly "Facility"
      described as {
        |Facility ID.
      }
    }
    encounterType: EncounterType with {
      briefly "Type"
      described as {
        |Encounter type.
      }
    }
    visitReason: VisitReason with {
      briefly "Reason"
      described as {
        |Visit reason.
      }
    }
    recordedVitals: VitalSigns? with {
      briefly "Vitals"
      described as {
        |Vital signs.
      }
    }
    chiefComplaint: ChiefComplaint? with {
      briefly "Complaint"
      described as {
        |Chief complaint.
      }
    }
    notes: ClinicalNote* with {
      briefly "Notes"
      described as {
        |Clinical notes.
      }
    }
    encounterDiagnoses: Diagnosis* with {
      briefly "Diagnoses"
      described as {
        |Diagnoses.
      }
    }
    encounterProcedures: EncounterProcedure* with {
      briefly "Procedures"
      described as {
        |Procedures.
      }
    }
    orders: EncounterOrder* with {
      briefly "Orders"
      described as {
        |Orders placed.
      }
    }
    status: EncounterStatus with {
      briefly "Status"
      described as {
        |Encounter status.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "In progress state"
    described as {
      |State for active encounter.
    }
  }
  record CompletedStateData is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    patient: PatientInfo with {
      briefly "Patient"
      described as {
        |Patient info.
      }
    }
    provider: ProviderInfo with {
      briefly "Provider"
      described as {
        |Provider info.
      }
    }
    encounterType: EncounterType with {
      briefly "Type"
      described as {
        |Encounter type.
      }
    }
    finalVitals: VitalSigns? with {
      briefly "Vitals"
      described as {
        |Final vitals.
      }
    }
    finalDiagnoses: Diagnosis+ with {
      briefly "Diagnoses"
      described as {
        |Final diagnoses.
      }
    }
    completedProcedures: EncounterProcedure* with {
      briefly "Procedures"
      described as {
        |Procedures.
      }
    }
    disposition: DispositionInfo with {
      briefly "Disposition"
      described as {
        |Disposition.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |State for completed encounter.
    }
  }
  record CanceledStateData is  {
    encounterId: EncounterId with {
      briefly "Encounter"
      described as {
        |Encounter ID.
      }
    }
    patient: PatientInfo with {
      briefly "Patient"
      described as {
        |Patient info.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    canceledAt: TimeStamp with {
      briefly "Canceled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Canceled state"
    described as {
      |State for canceled encounter.
    }
  }
  // States
  state InProgressState of type Encounter.InProgressStateData
  state CompletedState of type Encounter.CompletedStateData
  state CanceledState of type Encounter.CanceledStateData
  // Handler
  handler EncounterHandler is {
    on command StartEncounter is {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.InProgressState with command StartEncounter
      tell event EncounterStarted to entity EncounterContext.Encounter
    }
    on command RecordVitals is {
      tell event VitalsRecorded to entity EncounterContext.Encounter
    }
    on command RecordChiefComplaint is {
      tell event ChiefComplaintRecorded to entity EncounterContext.Encounter
    }
    on command AddClinicalNote is {
      tell event ClinicalNoteAdded to entity EncounterContext.Encounter
    }
    on command AddDiagnosis is {
      tell event DiagnosisAdded to entity EncounterContext.Encounter
    }
    on command RecordProcedure is {
      tell event ProcedureRecorded to entity EncounterContext.Encounter
    }
    on command PlaceOrder is {
      tell event OrderPlaced to entity EncounterContext.Encounter
    }
    on command SignNote is {
      tell event NoteSigned to entity EncounterContext.Encounter
    }
    on command CompleteEncounter is {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.CompletedState with command CompleteEncounter
      tell event EncounterCompleted to entity EncounterContext.Encounter
    }
    on command CancelEncounter is {
      morph entity EncounterContext.Encounter to state EncounterContext.Encounter.CanceledState with command CancelEncounter
      tell event EncounterCanceled to entity EncounterContext.Encounter
    }
  } with {
    briefly "Processes encounter commands"
    described as {
      | Handles clinical encounter lifecycle from start
      | through documentation, orders, and completion.
    }
  }
} with {
  briefly "Encounter aggregate"
  described as {
    | The Encounter entity manages clinical encounters
    | including documentation, diagnoses, and orders.
  }
}
