// Care Coordination - Care Plan Entity
entity CarePlan is {
  // Commands
  command CreateCarePlan is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |New care plan identifier.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient identifier.
      }
    }
    conditions: Condition+ with {
      briefly "Conditions"
      described as {
        |Patient conditions.
      }
    }
    createdBy: ProviderId with {
      briefly "Created by"
      described as {
        |Creating provider.
      }
    }
  } with {
    briefly "Create care plan"
    described as {
      |Creates a new care plan.
    }
  }
  command AddCareTeamMember is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    member: CareTeamMember with {
      briefly "Member"
      described as {
        |Team member to add.
      }
    }
  } with {
    briefly "Add team member"
    described as {
      |Adds care team member.
    }
  }
  command RemoveCareTeamMember is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    providerId: ProviderId with {
      briefly "Provider"
      described as {
        |Member to remove.
      }
    }
  } with {
    briefly "Remove team member"
    described as {
      |Removes care team member.
    }
  }
  command AddGoal is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    goal: CareGoal with {
      briefly "Goal"
      described as {
        |Care goal.
      }
    }
  } with {
    briefly "Add goal"
    described as {
      |Adds a care goal.
    }
  }
  command UpdateGoalStatus is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    goalId: GoalId with {
      briefly "Goal"
      described as {
        |Goal identifier.
      }
    }
    goalStatus: GoalStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    progress: String(1,1000)? with {
      briefly "Progress"
      described as {
        |Progress notes.
      }
    }
  } with {
    briefly "Update goal"
    described as {
      |Updates goal status.
    }
  }
  command AddTask is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    task: CareTask with {
      briefly "Task"
      described as {
        |Care task.
      }
    }
  } with {
    briefly "Add task"
    described as {
      |Adds a care task.
    }
  }
  command CompleteTask is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    taskId: TaskId with {
      briefly "Task"
      described as {
        |Task identifier.
      }
    }
    completedBy: ProviderId with {
      briefly "Completed by"
      described as {
        |Completing provider.
      }
    }
  } with {
    briefly "Complete task"
    described as {
      |Marks task as complete.
    }
  }
  command CreateReferral is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    referral: Referral with {
      briefly "Referral"
      described as {
        |Referral details.
      }
    }
  } with {
    briefly "Create referral"
    described as {
      |Creates a referral.
    }
  }
  command UpdateReferralStatus is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    referralId: ReferralId with {
      briefly "Referral"
      described as {
        |Referral identifier.
      }
    }
    referralStatus: ReferralStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
  } with {
    briefly "Update referral"
    described as {
      |Updates referral status.
    }
  }
  command ActivateCarePlan is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
  } with {
    briefly "Activate plan"
    described as {
      |Activates the care plan.
    }
  }
  command CompleteCarePlan is  {
    carePlanId: CarePlanId with {
      briefly "Plan ID"
      described as {
        |Care plan identifier.
      }
    }
    outcome: String(1,500) with {
      briefly "Outcome"
      described as {
        |Plan outcome.
      }
    }
  } with {
    briefly "Complete plan"
    described as {
      |Completes the care plan.
    }
  }
  // Events
  event CarePlanCreated is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    conditions: Condition+ with {
      briefly "Conditions"
      described as {
        |Patient conditions.
      }
    }
    createdBy: ProviderId with {
      briefly "Created by"
      described as {
        |Creator.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Plan created"
    described as {
      |Emitted when plan is created.
    }
  }
  event CareTeamMemberAdded is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    member: CareTeamMember with {
      briefly "Member"
      described as {
        |Added member.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Member added"
    described as {
      |Emitted when team member is added.
    }
  }
  event CareTeamMemberRemoved is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    providerId: ProviderId with {
      briefly "Provider"
      described as {
        |Removed member.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Member removed"
    described as {
      |Emitted when team member is removed.
    }
  }
  event GoalAdded is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    goal: CareGoal with {
      briefly "Goal"
      described as {
        |Added goal.
      }
    }
  } with {
    briefly "Goal added"
    described as {
      |Emitted when goal is added.
    }
  }
  event GoalStatusUpdated is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    goalId: GoalId with {
      briefly "Goal"
      described as {
        |Goal ID.
      }
    }
    goalStatus: GoalStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    progress: String(1,1000)? with {
      briefly "Progress"
      described as {
        |Progress notes.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Goal updated"
    described as {
      |Emitted when goal status changes.
    }
  }
  event TaskAdded is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    task: CareTask with {
      briefly "Task"
      described as {
        |Added task.
      }
    }
  } with {
    briefly "Task added"
    described as {
      |Emitted when task is added.
    }
  }
  event TaskCompleted is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    taskId: TaskId with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    completedBy: ProviderId with {
      briefly "Completed by"
      described as {
        |Completer.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Task completed"
    described as {
      |Emitted when task is completed.
    }
  }
  event ReferralCreated is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    referral: Referral with {
      briefly "Referral"
      described as {
        |Created referral.
      }
    }
  } with {
    briefly "Referral created"
    described as {
      |Emitted when referral is created.
    }
  }
  event ReferralStatusUpdated is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    referralId: ReferralId with {
      briefly "Referral"
      described as {
        |Referral ID.
      }
    }
    referralStatus: ReferralStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Referral updated"
    described as {
      |Emitted when referral status changes.
    }
  }
  event CarePlanActivated is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Plan activated"
    described as {
      |Emitted when plan is activated.
    }
  }
  event CarePlanCompleted is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    outcome: String(1,500) with {
      briefly "Outcome"
      described as {
        |Plan outcome.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Plan completed"
    described as {
      |Emitted when plan is completed.
    }
  }
  // State Records
  record DraftStateData is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    conditions: Condition+ with {
      briefly "Conditions"
      described as {
        |Patient conditions.
      }
    }
    draftCareTeam: CareTeamMember* with {
      briefly "Team"
      described as {
        |Care team.
      }
    }
    draftGoals: CareGoal* with {
      briefly "Goals"
      described as {
        |Care goals.
      }
    }
    tasks: CareTask* with {
      briefly "Tasks"
      described as {
        |Care tasks.
      }
    }
    referrals: Referral* with {
      briefly "Referrals"
      described as {
        |Referrals.
      }
    }
    planStatus: CarePlanStatus with {
      briefly "Status"
      described as {
        |Plan status.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Draft state"
    described as {
      |State for draft plan.
    }
  }
  record ActiveStateData is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    conditions: Condition+ with {
      briefly "Conditions"
      described as {
        |Patient conditions.
      }
    }
    activeCareTeam: CareTeamMember+ with {
      briefly "Team"
      described as {
        |Care team.
      }
    }
    activeGoals: CareGoal+ with {
      briefly "Goals"
      described as {
        |Care goals.
      }
    }
    tasks: CareTask* with {
      briefly "Tasks"
      described as {
        |Care tasks.
      }
    }
    referrals: Referral* with {
      briefly "Referrals"
      described as {
        |Referrals.
      }
    }
    planStatus: CarePlanStatus with {
      briefly "Status"
      described as {
        |Plan status.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active plan.
    }
  }
  record CompletedStateData is  {
    carePlanId: CarePlanId with {
      briefly "Plan"
      described as {
        |Plan ID.
      }
    }
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    outcome: String(1,500) with {
      briefly "Outcome"
      described as {
        |Plan outcome.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |State for completed plan.
    }
  }
  // States
  state DraftState of type CarePlan.DraftStateData
  state ActiveState of type CarePlan.ActiveStateData
  state CompletedState of type CarePlan.CompletedStateData
  // Handler
  handler CarePlanHandler is {
    on command CreateCarePlan is {
      morph entity CarePlanContext.CarePlan to state CarePlanContext.CarePlan.DraftState with command CreateCarePlan
      tell event CarePlanCreated to entity CarePlanContext.CarePlan
    }
    on command AddCareTeamMember is {
      tell event CareTeamMemberAdded to entity CarePlanContext.CarePlan
    }
    on command RemoveCareTeamMember is {
      tell event CareTeamMemberRemoved to entity CarePlanContext.CarePlan
    }
    on command AddGoal is {
      tell event GoalAdded to entity CarePlanContext.CarePlan
    }
    on command UpdateGoalStatus is {
      tell event GoalStatusUpdated to entity CarePlanContext.CarePlan
    }
    on command AddTask is {
      tell event TaskAdded to entity CarePlanContext.CarePlan
    }
    on command CompleteTask is {
      tell event TaskCompleted to entity CarePlanContext.CarePlan
    }
    on command CreateReferral is {
      tell event ReferralCreated to entity CarePlanContext.CarePlan
    }
    on command UpdateReferralStatus is {
      tell event ReferralStatusUpdated to entity CarePlanContext.CarePlan
    }
    on command ActivateCarePlan is {
      morph entity CarePlanContext.CarePlan to state CarePlanContext.CarePlan.ActiveState with command ActivateCarePlan
      tell event CarePlanActivated to entity CarePlanContext.CarePlan
    }
    on command CompleteCarePlan is {
      morph entity CarePlanContext.CarePlan to state CarePlanContext.CarePlan.CompletedState with command CompleteCarePlan
      tell event CarePlanCompleted to entity CarePlanContext.CarePlan
    }
  } with {
    briefly "Processes care plan commands"
    described as {
      | Handles care plan lifecycle including team
      | management, goals, tasks, and referrals.
    }
  }
} with {
  briefly "Care plan aggregate"
  described as {
    | The CarePlan entity manages coordinated care
    | including care teams, goals, tasks, and referrals.
  }
}
