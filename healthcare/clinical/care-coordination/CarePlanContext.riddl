// Care Coordination - Care Plan Context
context CarePlanContext is {
  include "types.riddl"
  include "CarePlan.riddl"
  // Repository for care plan persistence
  repository CarePlanRepository is {
    schema CarePlanData is relational
      of carePlans as type CarePlan
        index on field CarePlan.carePlanId
        index on field CarePlan.patientId

    handler CarePlanPersistence is {
      on command CarePlan.CreateCarePlan is {
        prompt "Store new care plan"
      }
      on command CarePlan.AddCareTeamMember is {
        prompt "Store team member"
      }
      on command CarePlan.RemoveCareTeamMember is {
        prompt "Remove team member"
      }
      on command CarePlan.AddGoal is {
        prompt "Store care goal"
      }
      on command CarePlan.UpdateGoalStatus is {
        prompt "Update goal status"
      }
      on command CarePlan.AddTask is {
        prompt "Store care task"
      }
      on command CarePlan.CompleteTask is {
        prompt "Update task to complete"
      }
      on command CarePlan.CreateReferral is {
        prompt "Store referral"
      }
      on command CarePlan.UpdateReferralStatus is {
        prompt "Update referral status"
      }
      on command CarePlan.ActivateCarePlan is {
        prompt "Update plan to active"
      }
      on command CarePlan.CompleteCarePlan is {
        prompt "Update plan to complete"
      }
    } with {
      briefly "Persists care plan events"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Care plan data persistence"
    described as {
      | The CarePlanRepository provides persistent storage for
      | care plans, goals, tasks, and referrals.
    }
  }
  // Projector for care coordination analytics
  projector CareCoordinationAnalytics is {
    record CoordinationStats is  {
      activePlans: Natural with {
        briefly "Active"
        described as {
          |Active care plans.
        }
      }
      goalsAchieved: Natural with {
        briefly "Goals"
        described as {
          |Goals achieved.
        }
      }
      pendingReferrals: Natural with {
        briefly "Referrals"
        described as {
          |Pending referrals.
        }
      }
      overdueTasks: Natural with {
        briefly "Overdue"
        described as {
          |Overdue tasks.
        }
      }
      avgPlanDuration: Duration with {
        briefly "Avg duration"
        described as {
          |Average plan duration.
        }
      }
    } with {
      briefly "Coordination statistics"
      described as {
        |Care coordination metrics.
      }
    }
    handler AnalyticsHandler is {
      on event CarePlan.CarePlanCreated is {
        prompt "Update plan counts"
      }
      on event CarePlan.GoalStatusUpdated is {
        prompt "Update goal metrics"
      }
      on event CarePlan.ReferralCreated is {
        prompt "Update referral counts"
      }
      on event CarePlan.CarePlanCompleted is {
        prompt "Update completion metrics"
      }
    } with {
      briefly "Maintains coordination analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Coordination analytics projections"
    described as {
      |Maintains care coordination analytics data.
    }
  }
} with {
  briefly "Bounded context for care coordination"
  described as {
    | The CarePlanContext is the bounded context for
    | care plans, referrals, and team coordination.
  }
}
