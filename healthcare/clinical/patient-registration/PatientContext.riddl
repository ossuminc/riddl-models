// Patient Registration - Patient Context

context PatientContext is {

  include "types.riddl"
  include "Patient.riddl"

  // Repository for patient persistence
  repository PatientRepository is {
    schema PatientData is relational
      of patients as Patient
      index on field Patient.patientId
      index on field Patient.mrn
      index on field Patient.demographics.lastName

    handler PatientPersistence is {
      on command Patient.RegisterPatient {
        prompt "Store new patient record"
      }
      on command Patient.UpdateDemographics {
        prompt "Update demographics"
      }
      on command Patient.UpdateAddress {
        prompt "Update address"
      }
      on command Patient.UpdateContact {
        prompt "Update contact info"
      }
      on command Patient.AddEmergencyContact {
        prompt "Store emergency contact"
      }
      on command Patient.AddInsurance {
        prompt "Store insurance"
      }
      on command Patient.UpdateInsurance {
        prompt "Update insurance"
      }
      on command Patient.RecordConsent {
        prompt "Store consent"
      }
      on command Patient.DeactivatePatient {
        prompt "Update patient to inactive"
      }
      on command Patient.ReactivatePatient {
        prompt "Update patient to active"
      }
      on command Patient.MergePatients {
        prompt "Merge patient records"
      }
    } with {
      briefly "Persists patient commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Patient data persistence"
    described by {
      | The PatientRepository provides persistent storage for
      | patient records and demographics.
    }
  }

  // Projector for patient analytics
  projector PatientAnalytics is {
    updates repository PatientRepository

    record PatientStats is {
      totalPatients is Natural with { briefly "Total" described by "Total patients." }
      activePatients is Natural with { briefly "Active" described by "Active patients." }
      newRegistrations is Natural with { briefly "New" described by "New registrations today." }
      insuranceCoverage is Decimal(5, 4) with { briefly "Insured" described by "Percent with insurance." }
      avgAge is Decimal(5, 2) with { briefly "Avg age" described by "Average patient age." }
    } with {
      briefly "Patient statistics"
      described by "Patient registration metrics."
    }

    handler AnalyticsHandler is {
      on event Patient.PatientRegistered {
        prompt "Update registration counts"
      }
      on event Patient.PatientDeactivated {
        prompt "Update active counts"
      }
      on event Patient.InsuranceAdded {
        prompt "Update insurance metrics"
      }
    } with {
      briefly "Maintains patient analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Patient analytics projections"
    described by "Maintains patient registration analytics data."
  }

} with {
  briefly "Bounded context for patient registration"
  described by {
    | The PatientContext is the bounded context for
    | patient demographics and registration management.
  }
}
