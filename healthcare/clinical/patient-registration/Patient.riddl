// Patient Registration - Patient Entity

entity Patient is {

  // Commands
  command RegisterPatient is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "New patient identifier."
    }
    demographics is Demographics with {
      briefly "Demographics"
      described by "Patient demographics."
    }
    address is AddressInfo with {
      briefly "Address"
      described by "Patient address."
    }
    contact is ContactInfo with {
      briefly "Contact"
      described by "Contact information."
    }
  } with {
    briefly "Register patient"
    described by "Registers a new patient."
  }

  command UpdateDemographics is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    demographics is Demographics with {
      briefly "Demographics"
      described by "Updated demographics."
    }
  } with {
    briefly "Update demographics"
    described by "Updates patient demographics."
  }

  command UpdateAddress is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    address is AddressInfo with {
      briefly "Address"
      described by "Updated address."
    }
  } with {
    briefly "Update address"
    described by "Updates patient address."
  }

  command UpdateContact is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    contact is ContactInfo with {
      briefly "Contact"
      described by "Updated contact info."
    }
  } with {
    briefly "Update contact"
    described by "Updates contact information."
  }

  command AddEmergencyContact is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    emergencyContact is EmergencyContact with {
      briefly "Emergency"
      described by "Emergency contact."
    }
  } with {
    briefly "Add emergency contact"
    described by "Adds emergency contact."
  }

  command AddInsurance is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    insurance is InsuranceCoverage with {
      briefly "Insurance"
      described by "Insurance coverage."
    }
  } with {
    briefly "Add insurance"
    described by "Adds insurance coverage."
  }

  command UpdateInsurance is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    insuranceId is InsuranceId with {
      briefly "Insurance ID"
      described by "Insurance to update."
    }
    insurance is InsuranceCoverage with {
      briefly "Insurance"
      described by "Updated insurance."
    }
  } with {
    briefly "Update insurance"
    described by "Updates insurance coverage."
  }

  command RecordConsent is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    consent is Consent with {
      briefly "Consent"
      described by "Patient consent."
    }
  } with {
    briefly "Record consent"
    described by "Records patient consent."
  }

  command DeactivatePatient is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Deactivation reason."
    }
  } with {
    briefly "Deactivate patient"
    described by "Deactivates patient record."
  }

  command ReactivatePatient is {
    patientId is PatientId with {
      briefly "Patient ID"
      described by "Patient identifier."
    }
  } with {
    briefly "Reactivate patient"
    described by "Reactivates patient record."
  }

  command MergePatients is {
    survivingPatientId is PatientId with {
      briefly "Surviving"
      described by "Patient to keep."
    }
    mergedPatientId is PatientId with {
      briefly "Merged"
      described by "Patient to merge."
    }
    mergedBy is String(1, 100) with {
      briefly "Merged by"
      described by "Person performing merge."
    }
  } with {
    briefly "Merge patients"
    described by "Merges duplicate patient records."
  }

  // Events
  event PatientRegistered is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    mrn is MRN with { briefly "MRN" described by "Medical record number." }
    demographics is Demographics with { briefly "Demographics" described by "Patient demographics." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Patient registered"
    described by "Emitted when patient is registered."
  }

  event DemographicsUpdated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    demographics is Demographics with { briefly "Demographics" described by "Updated demographics." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Demographics updated"
    described by "Emitted when demographics change."
  }

  event AddressUpdated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    address is AddressInfo with { briefly "Address" described by "Updated address." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Address updated"
    described by "Emitted when address changes."
  }

  event ContactUpdated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    contact is ContactInfo with { briefly "Contact" described by "Updated contact." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Contact updated"
    described by "Emitted when contact info changes."
  }

  event EmergencyContactAdded is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    emergencyContact is EmergencyContact with { briefly "Emergency" described by "Emergency contact." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Emergency contact added"
    described by "Emitted when emergency contact is added."
  }

  event InsuranceAdded is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    insurance is InsuranceCoverage with { briefly "Insurance" described by "Added insurance." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Insurance added"
    described by "Emitted when insurance is added."
  }

  event InsuranceUpdated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    insuranceId is InsuranceId with { briefly "Insurance" described by "Insurance ID." }
    insurance is InsuranceCoverage with { briefly "Updated" described by "Updated insurance." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Insurance updated"
    described by "Emitted when insurance changes."
  }

  event ConsentRecorded is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    consent is Consent with { briefly "Consent" described by "Recorded consent." }
  } with {
    briefly "Consent recorded"
    described by "Emitted when consent is recorded."
  }

  event PatientDeactivated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Deactivation reason." }
    deactivatedAt is TimeStamp with { briefly "Deactivated" described by "Deactivation time." }
  } with {
    briefly "Patient deactivated"
    described by "Emitted when patient is deactivated."
  }

  event PatientReactivated is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Patient reactivated"
    described by "Emitted when patient is reactivated."
  }

  event PatientsMerged is {
    survivingPatientId is PatientId with { briefly "Surviving" described by "Surviving patient." }
    mergedPatientId is PatientId with { briefly "Merged" described by "Merged patient." }
    mergedBy is String(1, 100) with { briefly "Merged by" described by "Person who merged." }
    mergedAt is TimeStamp with { briefly "Merged" described by "Merge time." }
  } with {
    briefly "Patients merged"
    described by "Emitted when patients are merged."
  }

  // State Records
  record ActiveStateData is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    mrn is MRN with { briefly "MRN" described by "Medical record number." }
    demographics is Demographics with { briefly "Demographics" described by "Patient demographics." }
    addresses is many AddressInfo with { briefly "Addresses" described by "Patient addresses." }
    contact is ContactInfo with { briefly "Contact" described by "Contact info." }
    emergencyContacts is many optional EmergencyContact with { briefly "Emergency" described by "Emergency contacts." }
    insurances is many optional InsuranceCoverage with { briefly "Insurances" described by "Insurance coverages." }
    consents is many optional Consent with { briefly "Consents" described by "Patient consents." }
    status is PatientStatus with { briefly "Status" described by "Patient status." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active state"
    described by "State for active patient."
  }

  record InactiveStateData is {
    patientId is PatientId with { briefly "Patient" described by "Patient ID." }
    mrn is MRN with { briefly "MRN" described by "Medical record number." }
    demographics is Demographics with { briefly "Demographics" described by "Patient demographics." }
    deactivationReason is String(1, 200) with { briefly "Reason" described by "Deactivation reason." }
    deactivatedAt is TimeStamp with { briefly "Deactivated" described by "Deactivation time." }
  } with {
    briefly "Inactive state"
    described by "State for inactive patient."
  }

  // States
  state ActiveState of Patient.ActiveStateData with {
    briefly "Patient active"
    described by "Active patient record."
  }

  state InactiveState of Patient.InactiveStateData with {
    briefly "Patient inactive"
    described by "Inactive patient record."
  }

  // Handler
  handler PatientHandler is {
    on command RegisterPatient {
      morph entity PatientContext.Patient to state PatientContext.Patient.ActiveState with command RegisterPatient
      tell event PatientRegistered to entity PatientContext.Patient
    }

    on command UpdateDemographics {
      tell event DemographicsUpdated to entity PatientContext.Patient
    }

    on command UpdateAddress {
      tell event AddressUpdated to entity PatientContext.Patient
    }

    on command UpdateContact {
      tell event ContactUpdated to entity PatientContext.Patient
    }

    on command AddEmergencyContact {
      tell event EmergencyContactAdded to entity PatientContext.Patient
    }

    on command AddInsurance {
      tell event InsuranceAdded to entity PatientContext.Patient
    }

    on command UpdateInsurance {
      tell event InsuranceUpdated to entity PatientContext.Patient
    }

    on command RecordConsent {
      tell event ConsentRecorded to entity PatientContext.Patient
    }

    on command DeactivatePatient {
      morph entity PatientContext.Patient to state PatientContext.Patient.InactiveState with command DeactivatePatient
      tell event PatientDeactivated to entity PatientContext.Patient
    }

    on command ReactivatePatient {
      morph entity PatientContext.Patient to state PatientContext.Patient.ActiveState with command ReactivatePatient
      tell event PatientReactivated to entity PatientContext.Patient
    }

    on command MergePatients {
      tell event PatientsMerged to entity PatientContext.Patient
    }
  } with {
    briefly "Processes patient commands"
    described by {
      | Handles patient lifecycle from registration
      | through updates and status changes.
    }
  }

} with {
  briefly "Patient aggregate"
  described by {
    | The Patient entity manages patient records including
    | demographics, contact info, and insurance.
  }
}
