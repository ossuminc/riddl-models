// Patient Registration - Patient Entity
entity Patient is {
  // Commands
  command RegisterPatient is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |New patient identifier.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Patient demographics.
      }
    }
    address: AddressInfo with {
      briefly "Address"
      described as {
        |Patient address.
      }
    }
    contact: ContactInfo with {
      briefly "Contact"
      described as {
        |Contact information.
      }
    }
  } with {
    briefly "Register patient"
    described as {
      |Registers a new patient.
    }
  }
  command UpdateDemographics is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Updated demographics.
      }
    }
  } with {
    briefly "Update demographics"
    described as {
      |Updates patient demographics.
    }
  }
  command UpdateAddress is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    address: AddressInfo with {
      briefly "Address"
      described as {
        |Updated address.
      }
    }
  } with {
    briefly "Update address"
    described as {
      |Updates patient address.
    }
  }
  command UpdateContact is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    contact: ContactInfo with {
      briefly "Contact"
      described as {
        |Updated contact info.
      }
    }
  } with {
    briefly "Update contact"
    described as {
      |Updates contact information.
    }
  }
  command AddEmergencyContact is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    emergencyContact: EmergencyContact with {
      briefly "Emergency"
      described as {
        |Emergency contact.
      }
    }
  } with {
    briefly "Add emergency contact"
    described as {
      |Adds emergency contact.
    }
  }
  command AddInsurance is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    insurance: InsuranceCoverage with {
      briefly "Insurance"
      described as {
        |Insurance coverage.
      }
    }
  } with {
    briefly "Add insurance"
    described as {
      |Adds insurance coverage.
    }
  }
  command UpdateInsurance is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    insuranceId: InsuranceId with {
      briefly "Insurance ID"
      described as {
        |Insurance to update.
      }
    }
    insurance: InsuranceCoverage with {
      briefly "Insurance"
      described as {
        |Updated insurance.
      }
    }
  } with {
    briefly "Update insurance"
    described as {
      |Updates insurance coverage.
    }
  }
  command RecordConsent is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    consent: Consent with {
      briefly "Consent"
      described as {
        |Patient consent.
      }
    }
  } with {
    briefly "Record consent"
    described as {
      |Records patient consent.
    }
  }
  command DeactivatePatient is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
  } with {
    briefly "Deactivate patient"
    described as {
      |Deactivates patient record.
    }
  }
  command ReactivatePatient is  {
    patientId: PatientId with {
      briefly "Patient ID"
      described as {
        |Patient identifier.
      }
    }
  } with {
    briefly "Reactivate patient"
    described as {
      |Reactivates patient record.
    }
  }
  command MergePatients is  {
    survivingPatientId: PatientId with {
      briefly "Surviving"
      described as {
        |Patient to keep.
      }
    }
    mergedPatientId: PatientId with {
      briefly "Merged"
      described as {
        |Patient to merge.
      }
    }
    mergedBy: String(1,100) with {
      briefly "Merged by"
      described as {
        |Person performing merge.
      }
    }
  } with {
    briefly "Merge patients"
    described as {
      |Merges duplicate patient records.
    }
  }
  // Events
  event PatientRegistered is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    mrn: MRN with {
      briefly "MRN"
      described as {
        |Medical record number.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Patient demographics.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Patient registered"
    described as {
      |Emitted when patient is registered.
    }
  }
  event DemographicsUpdated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Updated demographics.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Demographics updated"
    described as {
      |Emitted when demographics change.
    }
  }
  event AddressUpdated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    address: AddressInfo with {
      briefly "Address"
      described as {
        |Updated address.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Address updated"
    described as {
      |Emitted when address changes.
    }
  }
  event ContactUpdated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    contact: ContactInfo with {
      briefly "Contact"
      described as {
        |Updated contact.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Contact updated"
    described as {
      |Emitted when contact info changes.
    }
  }
  event EmergencyContactAdded is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    emergencyContact: EmergencyContact with {
      briefly "Emergency"
      described as {
        |Emergency contact.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Emergency contact added"
    described as {
      |Emitted when emergency contact is added.
    }
  }
  event InsuranceAdded is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    insurance: InsuranceCoverage with {
      briefly "Insurance"
      described as {
        |Added insurance.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Insurance added"
    described as {
      |Emitted when insurance is added.
    }
  }
  event InsuranceUpdated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    insuranceId: InsuranceId with {
      briefly "Insurance"
      described as {
        |Insurance ID.
      }
    }
    insurance: InsuranceCoverage with {
      briefly "Updated"
      described as {
        |Updated insurance.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Insurance updated"
    described as {
      |Emitted when insurance changes.
    }
  }
  event ConsentRecorded is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    consent: Consent with {
      briefly "Consent"
      described as {
        |Recorded consent.
      }
    }
  } with {
    briefly "Consent recorded"
    described as {
      |Emitted when consent is recorded.
    }
  }
  event PatientDeactivated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
    deactivatedAt: TimeStamp with {
      briefly "Deactivated"
      described as {
        |Deactivation time.
      }
    }
  } with {
    briefly "Patient deactivated"
    described as {
      |Emitted when patient is deactivated.
    }
  }
  event PatientReactivated is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated"
      described as {
        |Reactivation time.
      }
    }
  } with {
    briefly "Patient reactivated"
    described as {
      |Emitted when patient is reactivated.
    }
  }
  event PatientsMerged is  {
    survivingPatientId: PatientId with {
      briefly "Surviving"
      described as {
        |Surviving patient.
      }
    }
    mergedPatientId: PatientId with {
      briefly "Merged"
      described as {
        |Merged patient.
      }
    }
    mergedBy: String(1,100) with {
      briefly "Merged by"
      described as {
        |Person who merged.
      }
    }
    mergedAt: TimeStamp with {
      briefly "Merged"
      described as {
        |Merge time.
      }
    }
  } with {
    briefly "Patients merged"
    described as {
      |Emitted when patients are merged.
    }
  }
  // State Records
  record ActiveStateData is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    mrn: MRN with {
      briefly "MRN"
      described as {
        |Medical record number.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Patient demographics.
      }
    }
    addresses: AddressInfo+ with {
      briefly "Addresses"
      described as {
        |Patient addresses.
      }
    }
    contact: ContactInfo with {
      briefly "Contact"
      described as {
        |Contact info.
      }
    }
    emergencyContacts: EmergencyContact* with {
      briefly "Emergency"
      described as {
        |Emergency contacts.
      }
    }
    insurances: InsuranceCoverage* with {
      briefly "Insurances"
      described as {
        |Insurance coverages.
      }
    }
    consents: Consent* with {
      briefly "Consents"
      described as {
        |Patient consents.
      }
    }
    status: PatientStatus with {
      briefly "Status"
      described as {
        |Patient status.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active patient.
    }
  }
  record InactiveStateData is  {
    patientId: PatientId with {
      briefly "Patient"
      described as {
        |Patient ID.
      }
    }
    mrn: MRN with {
      briefly "MRN"
      described as {
        |Medical record number.
      }
    }
    demographics: Demographics with {
      briefly "Demographics"
      described as {
        |Patient demographics.
      }
    }
    deactivationReason: String(1,200) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
    deactivatedAt: TimeStamp with {
      briefly "Deactivated"
      described as {
        |Deactivation time.
      }
    }
  } with {
    briefly "Inactive state"
    described as {
      |State for inactive patient.
    }
  }
  // States
  state ActiveState of type Patient.ActiveStateData
  state InactiveState of type Patient.InactiveStateData
  // Handler
  handler PatientHandler is {
    on command RegisterPatient is {
      morph entity PatientContext.Patient to state PatientContext.Patient.ActiveState with command RegisterPatient
      tell event PatientRegistered to entity PatientContext.Patient
    }
    on command UpdateDemographics is {
      tell event DemographicsUpdated to entity PatientContext.Patient
    }
    on command UpdateAddress is {
      tell event AddressUpdated to entity PatientContext.Patient
    }
    on command UpdateContact is {
      tell event ContactUpdated to entity PatientContext.Patient
    }
    on command AddEmergencyContact is {
      tell event EmergencyContactAdded to entity PatientContext.Patient
    }
    on command AddInsurance is {
      tell event InsuranceAdded to entity PatientContext.Patient
    }
    on command UpdateInsurance is {
      tell event InsuranceUpdated to entity PatientContext.Patient
    }
    on command RecordConsent is {
      tell event ConsentRecorded to entity PatientContext.Patient
    }
    on command DeactivatePatient is {
      morph entity PatientContext.Patient to state PatientContext.Patient.InactiveState with command DeactivatePatient
      tell event PatientDeactivated to entity PatientContext.Patient
    }
    on command ReactivatePatient is {
      morph entity PatientContext.Patient to state PatientContext.Patient.ActiveState with command ReactivatePatient
      tell event PatientReactivated to entity PatientContext.Patient
    }
    on command MergePatients is {
      tell event PatientsMerged to entity PatientContext.Patient
    }
  } with {
    briefly "Processes patient commands"
    described as {
      | Handles patient lifecycle from registration
      | through updates and status changes.
    }
  }
} with {
  briefly "Patient aggregate"
  described as {
    | The Patient entity manages patient records including
    | demographics, contact info, and insurance.
  }
}
