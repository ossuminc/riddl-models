// Fleet Management - Vehicle Entity
entity Vehicle is {
  // Commands
  command RegisterVehicle is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |New vehicle identifier.
      }
    }
    vehicleInfo: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle information.
      }
    }
    initialOdometer: Natural with {
      briefly "Odometer"
      described as {
        |Current odometer reading.
      }
    }
  } with {
    briefly "Register vehicle"
    described as {
      |Registers a new vehicle in fleet.
    }
  }
  command UpdateLocation is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    location: GpsLocation with {
      briefly "Location"
      described as {
        |GPS location.
      }
    }
  } with {
    briefly "Update location"
    described as {
      |Updates vehicle GPS location.
    }
  }
  command UpdateOdometer is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    odometer: Odometer with {
      briefly "Odometer"
      described as {
        |Odometer reading.
      }
    }
  } with {
    briefly "Update odometer"
    described as {
      |Updates odometer reading.
    }
  }
  command UpdateFuelLevel is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    fuelLevel: FuelLevel with {
      briefly "Fuel"
      described as {
        |Fuel level.
      }
    }
  } with {
    briefly "Update fuel level"
    described as {
      |Updates fuel level.
    }
  }
  command AssignDriver is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Driver information.
      }
    }
  } with {
    briefly "Assign driver"
    described as {
      |Assigns driver to vehicle.
    }
  }
  command UnassignDriver is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    updatedReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Unassignment reason.
      }
    }
  } with {
    briefly "Unassign driver"
    described as {
      |Removes driver assignment.
    }
  }
  command StartTrip is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    tripId: TripId with {
      briefly "Trip"
      described as {
        |Trip identifier.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Trip driver.
      }
    }
    startLocation: GpsLocation with {
      briefly "Start"
      described as {
        |Start location.
      }
    }
    startOdometer: Natural with {
      briefly "Odometer"
      described as {
        |Starting odometer.
      }
    }
    purpose: String(1,500)? with {
      briefly "Purpose"
      described as {
        |Trip purpose.
      }
    }
  } with {
    briefly "Start trip"
    described as {
      |Starts a new trip.
    }
  }
  command EndTrip is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    tripId: TripId with {
      briefly "Trip"
      described as {
        |Trip identifier.
      }
    }
    endLocation: GpsLocation with {
      briefly "End"
      described as {
        |End location.
      }
    }
    endOdometer: Natural with {
      briefly "Odometer"
      described as {
        |Ending odometer.
      }
    }
  } with {
    briefly "End trip"
    described as {
      |Ends the current trip.
    }
  }
  command ScheduleMaintenance is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    maintenance: MaintenanceRecord with {
      briefly "Maintenance"
      described as {
        |Maintenance details.
      }
    }
  } with {
    briefly "Schedule maintenance"
    described as {
      |Schedules maintenance.
    }
  }
  command StartMaintenance is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    maintenanceId: MaintenanceId with {
      briefly "Maintenance"
      described as {
        |Maintenance identifier.
      }
    }
    technician: String(1,200) with {
      briefly "Technician"
      described as {
        |Assigned technician.
      }
    }
  } with {
    briefly "Start maintenance"
    described as {
      |Starts maintenance work.
    }
  }
  command CompleteMaintenance is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    maintenanceId: MaintenanceId with {
      briefly "Maintenance"
      described as {
        |Maintenance identifier.
      }
    }
    cost: Decimal(10,2) with {
      briefly "Cost"
      described as {
        |Total cost.
      }
    }
    notes: String(1,2000)? with {
      briefly "Notes"
      described as {
        |Completion notes.
      }
    }
  } with {
    briefly "Complete maintenance"
    described as {
      |Completes maintenance.
    }
  }
  command RaiseAlert is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    alert: Alert with {
      briefly "Alert"
      described as {
        |Alert details.
      }
    }
  } with {
    briefly "Raise alert"
    described as {
      |Raises vehicle alert.
    }
  }
  command AcknowledgeAlert is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    alertId: UUID with {
      briefly "Alert"
      described as {
        |Alert identifier.
      }
    }
    acknowledgedBy: String(1,200) with {
      briefly "Acknowledged by"
      described as {
        |Person acknowledging.
      }
    }
  } with {
    briefly "Acknowledge alert"
    described as {
      |Acknowledges alert.
    }
  }
  command DecommissionVehicle is  {
    vehicleId: VehicleId with {
      briefly "Vehicle ID"
      described as {
        |Vehicle identifier.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Decommission reason.
      }
    }
    decommissionedBy: String(1,200) with {
      briefly "Decommissioned by"
      described as {
        |Person decommissioning.
      }
    }
  } with {
    briefly "Decommission vehicle"
    described as {
      |Removes vehicle from fleet.
    }
  }
  // Events
  event VehicleRegistered is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    vehicleInfo: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle info.
      }
    }
    initialOdometer: Natural with {
      briefly "Odometer"
      described as {
        |Initial odometer.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Vehicle registered"
    described as {
      |Emitted when vehicle is registered.
    }
  }
  event LocationUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    location: GpsLocation with {
      briefly "Location"
      described as {
        |GPS location.
      }
    }
  } with {
    briefly "Location updated"
    described as {
      |Emitted when location updates.
    }
  }
  event OdometerUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    odometer: Odometer with {
      briefly "Odometer"
      described as {
        |New reading.
      }
    }
  } with {
    briefly "Odometer updated"
    described as {
      |Emitted when odometer updates.
    }
  }
  event FuelLevelUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    fuelLevel: FuelLevel with {
      briefly "Fuel"
      described as {
        |Fuel level.
      }
    }
  } with {
    briefly "Fuel level updated"
    described as {
      |Emitted when fuel level updates.
    }
  }
  event DriverAssigned is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Driver assigned"
    described as {
      |Emitted when driver is assigned.
    }
  }
  event DriverUnassigned is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    updatedReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Unassignment reason.
      }
    }
    unassignedAt: TimeStamp with {
      briefly "Unassigned"
      described as {
        |Unassignment time.
      }
    }
  } with {
    briefly "Driver unassigned"
    described as {
      |Emitted when driver is unassigned.
    }
  }
  event TripStarted is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    trip: TripRecord with {
      briefly "Trip"
      described as {
        |Trip record.
      }
    }
  } with {
    briefly "Trip started"
    described as {
      |Emitted when trip starts.
    }
  }
  event TripEnded is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    tripId: TripId with {
      briefly "Trip"
      described as {
        |Trip ID.
      }
    }
    endLocation: GpsLocation with {
      briefly "End"
      described as {
        |End location.
      }
    }
    endOdometer: Natural with {
      briefly "Odometer"
      described as {
        |End odometer.
      }
    }
    endedAt: TimeStamp with {
      briefly "Ended"
      described as {
        |End time.
      }
    }
  } with {
    briefly "Trip ended"
    described as {
      |Emitted when trip ends.
    }
  }
  event MaintenanceScheduled is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    maintenance: MaintenanceRecord with {
      briefly "Maintenance"
      described as {
        |Maintenance record.
      }
    }
  } with {
    briefly "Maintenance scheduled"
    described as {
      |Emitted when maintenance is scheduled.
    }
  }
  event MaintenanceStarted is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    maintenanceId: MaintenanceId with {
      briefly "Maintenance"
      described as {
        |Maintenance ID.
      }
    }
    technician: String(1,200) with {
      briefly "Technician"
      described as {
        |Technician.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Maintenance started"
    described as {
      |Emitted when maintenance starts.
    }
  }
  event MaintenanceCompleted is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    maintenanceId: MaintenanceId with {
      briefly "Maintenance"
      described as {
        |Maintenance ID.
      }
    }
    cost: Decimal(10,2) with {
      briefly "Cost"
      described as {
        |Total cost.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Maintenance completed"
    described as {
      |Emitted when maintenance completes.
    }
  }
  event AlertRaised is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    alert: Alert with {
      briefly "Alert"
      described as {
        |Alert details.
      }
    }
  } with {
    briefly "Alert raised"
    described as {
      |Emitted when alert is raised.
    }
  }
  event AlertAcknowledged is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    alertId: UUID with {
      briefly "Alert"
      described as {
        |Alert ID.
      }
    }
    acknowledgedBy: String(1,200) with {
      briefly "Acknowledged by"
      described as {
        |Person.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |Acknowledgment time.
      }
    }
  } with {
    briefly "Alert acknowledged"
    described as {
      |Emitted when alert is acknowledged.
    }
  }
  event VehicleDecommissioned is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Decommission reason.
      }
    }
    decommissionedAt: TimeStamp with {
      briefly "Decommissioned"
      described as {
        |Decommission time.
      }
    }
  } with {
    briefly "Vehicle decommissioned"
    described as {
      |Emitted when vehicle is decommissioned.
    }
  }
  // State Records
  record ActiveStateData is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    vehicleInfo: VehicleInfo with {
      briefly "Vehicle"
      described as {
        |Vehicle info.
      }
    }
    status: VehicleStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    currentLocation: GpsLocation? with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    currentOdometer: Odometer with {
      briefly "Odometer"
      described as {
        |Current odometer.
      }
    }
    currentFuelLevel: FuelLevel? with {
      briefly "Fuel"
      described as {
        |Current fuel.
      }
    }
    assignedDriver: DriverInfo? with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    currentTrip: TripRecord? with {
      briefly "Trip"
      described as {
        |Current trip.
      }
    }
    maintenanceHistory: MaintenanceRecord* with {
      briefly "Maintenance"
      described as {
        |Maintenance history.
      }
    }
    activeAlerts: Alert* with {
      briefly "Alerts"
      described as {
        |Active alerts.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active vehicle.
    }
  }
  // States
  state ActiveState of type Vehicle.ActiveStateData
  // Handler
  handler VehicleHandler is {
    on command RegisterVehicle is {
      morph entity VehicleContext.Vehicle to state VehicleContext.Vehicle.ActiveState with command RegisterVehicle
      tell event VehicleRegistered to entity VehicleContext.Vehicle
    }
    on command UpdateLocation is {
      tell event LocationUpdated to entity VehicleContext.Vehicle
    }
    on command UpdateOdometer is {
      tell event OdometerUpdated to entity VehicleContext.Vehicle
    }
    on command UpdateFuelLevel is {
      tell event FuelLevelUpdated to entity VehicleContext.Vehicle
    }
    on command AssignDriver is {
      tell event DriverAssigned to entity VehicleContext.Vehicle
    }
    on command UnassignDriver is {
      tell event DriverUnassigned to entity VehicleContext.Vehicle
    }
    on command StartTrip is {
      tell event TripStarted to entity VehicleContext.Vehicle
    }
    on command EndTrip is {
      tell event TripEnded to entity VehicleContext.Vehicle
    }
    on command ScheduleMaintenance is {
      tell event MaintenanceScheduled to entity VehicleContext.Vehicle
    }
    on command StartMaintenance is {
      tell event MaintenanceStarted to entity VehicleContext.Vehicle
    }
    on command CompleteMaintenance is {
      tell event MaintenanceCompleted to entity VehicleContext.Vehicle
    }
    on command RaiseAlert is {
      tell event AlertRaised to entity VehicleContext.Vehicle
    }
    on command AcknowledgeAlert is {
      tell event AlertAcknowledged to entity VehicleContext.Vehicle
    }
    on command DecommissionVehicle is {
      tell event VehicleDecommissioned to entity VehicleContext.Vehicle
    }
  } with {
    briefly "Processes vehicle commands"
    described as {
      | Handles vehicle lifecycle from registration
      | through tracking and maintenance.
    }
  }
} with {
  briefly "Vehicle aggregate"
  described as {
    | The Vehicle entity manages fleet vehicles
    | and their operational state.
  }
}
