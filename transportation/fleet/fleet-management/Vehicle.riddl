// Fleet Management - Vehicle Entity

entity Vehicle is {

  // Commands
  command RegisterVehicle is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "New vehicle identifier."
    }
    vehicleInfo is VehicleInfo with {
      briefly "Vehicle"
      described by "Vehicle information."
    }
    initialOdometer is Natural with {
      briefly "Odometer"
      described by "Current odometer reading."
    }
  } with {
    briefly "Register vehicle"
    described by "Registers a new vehicle in fleet."
  }

  command UpdateLocation is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    location is GpsLocation with {
      briefly "Location"
      described by "GPS location."
    }
  } with {
    briefly "Update location"
    described by "Updates vehicle GPS location."
  }

  command UpdateOdometer is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    odometer is Odometer with {
      briefly "Odometer"
      described by "Odometer reading."
    }
  } with {
    briefly "Update odometer"
    described by "Updates odometer reading."
  }

  command UpdateFuelLevel is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    fuelLevel is FuelLevel with {
      briefly "Fuel"
      described by "Fuel level."
    }
  } with {
    briefly "Update fuel level"
    described by "Updates fuel level."
  }

  command AssignDriver is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    driver is DriverInfo with {
      briefly "Driver"
      described by "Driver information."
    }
  } with {
    briefly "Assign driver"
    described by "Assigns driver to vehicle."
  }

  command UnassignDriver is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    updatedReason is optional String(1, 500) with {
      briefly "Reason"
      described by "Unassignment reason."
    }
  } with {
    briefly "Unassign driver"
    described by "Removes driver assignment."
  }

  command StartTrip is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    tripId is TripId with {
      briefly "Trip"
      described by "Trip identifier."
    }
    driver is DriverInfo with {
      briefly "Driver"
      described by "Trip driver."
    }
    startLocation is GpsLocation with {
      briefly "Start"
      described by "Start location."
    }
    startOdometer is Natural with {
      briefly "Odometer"
      described by "Starting odometer."
    }
    purpose is optional String(1, 500) with {
      briefly "Purpose"
      described by "Trip purpose."
    }
  } with {
    briefly "Start trip"
    described by "Starts a new trip."
  }

  command EndTrip is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    tripId is TripId with {
      briefly "Trip"
      described by "Trip identifier."
    }
    endLocation is GpsLocation with {
      briefly "End"
      described by "End location."
    }
    endOdometer is Natural with {
      briefly "Odometer"
      described by "Ending odometer."
    }
  } with {
    briefly "End trip"
    described by "Ends the current trip."
  }

  command ScheduleMaintenance is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    maintenance is MaintenanceRecord with {
      briefly "Maintenance"
      described by "Maintenance details."
    }
  } with {
    briefly "Schedule maintenance"
    described by "Schedules maintenance."
  }

  command StartMaintenance is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    maintenanceId is MaintenanceId with {
      briefly "Maintenance"
      described by "Maintenance identifier."
    }
    technician is String(1, 200) with {
      briefly "Technician"
      described by "Assigned technician."
    }
  } with {
    briefly "Start maintenance"
    described by "Starts maintenance work."
  }

  command CompleteMaintenance is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    maintenanceId is MaintenanceId with {
      briefly "Maintenance"
      described by "Maintenance identifier."
    }
    cost is Decimal(10, 2) with {
      briefly "Cost"
      described by "Total cost."
    }
    notes is optional String(1, 2000) with {
      briefly "Notes"
      described by "Completion notes."
    }
  } with {
    briefly "Complete maintenance"
    described by "Completes maintenance."
  }

  command RaiseAlert is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    alert is Alert with {
      briefly "Alert"
      described by "Alert details."
    }
  } with {
    briefly "Raise alert"
    described by "Raises vehicle alert."
  }

  command AcknowledgeAlert is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    alertId is UUID with {
      briefly "Alert"
      described by "Alert identifier."
    }
    acknowledgedBy is String(1, 200) with {
      briefly "Acknowledged by"
      described by "Person acknowledging."
    }
  } with {
    briefly "Acknowledge alert"
    described by "Acknowledges alert."
  }

  command DecommissionVehicle is {
    vehicleId is VehicleId with {
      briefly "Vehicle ID"
      described by "Vehicle identifier."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Decommission reason."
    }
    decommissionedBy is String(1, 200) with {
      briefly "Decommissioned by"
      described by "Person decommissioning."
    }
  } with {
    briefly "Decommission vehicle"
    described by "Removes vehicle from fleet."
  }

  // Events
  event VehicleRegistered is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    vehicleInfo is VehicleInfo with { briefly "Vehicle" described by "Vehicle info." }
    initialOdometer is Natural with { briefly "Odometer" described by "Initial odometer." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Vehicle registered"
    described by "Emitted when vehicle is registered."
  }

  event LocationUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    location is GpsLocation with { briefly "Location" described by "GPS location." }
  } with {
    briefly "Location updated"
    described by "Emitted when location updates."
  }

  event OdometerUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    odometer is Odometer with { briefly "Odometer" described by "New reading." }
  } with {
    briefly "Odometer updated"
    described by "Emitted when odometer updates."
  }

  event FuelLevelUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    fuelLevel is FuelLevel with { briefly "Fuel" described by "Fuel level." }
  } with {
    briefly "Fuel level updated"
    described by "Emitted when fuel level updates."
  }

  event DriverAssigned is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    driver is DriverInfo with { briefly "Driver" described by "Assigned driver." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Driver assigned"
    described by "Emitted when driver is assigned."
  }

  event DriverUnassigned is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    updatedReason is optional String(1, 500) with { briefly "Reason" described by "Unassignment reason." }
    unassignedAt is TimeStamp with { briefly "Unassigned" described by "Unassignment time." }
  } with {
    briefly "Driver unassigned"
    described by "Emitted when driver is unassigned."
  }

  event TripStarted is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    trip is TripRecord with { briefly "Trip" described by "Trip record." }
  } with {
    briefly "Trip started"
    described by "Emitted when trip starts."
  }

  event TripEnded is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    tripId is TripId with { briefly "Trip" described by "Trip ID." }
    endLocation is GpsLocation with { briefly "End" described by "End location." }
    endOdometer is Natural with { briefly "Odometer" described by "End odometer." }
    endedAt is TimeStamp with { briefly "Ended" described by "End time." }
  } with {
    briefly "Trip ended"
    described by "Emitted when trip ends."
  }

  event MaintenanceScheduled is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    maintenance is MaintenanceRecord with { briefly "Maintenance" described by "Maintenance record." }
  } with {
    briefly "Maintenance scheduled"
    described by "Emitted when maintenance is scheduled."
  }

  event MaintenanceStarted is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    maintenanceId is MaintenanceId with { briefly "Maintenance" described by "Maintenance ID." }
    technician is String(1, 200) with { briefly "Technician" described by "Technician." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Maintenance started"
    described by "Emitted when maintenance starts."
  }

  event MaintenanceCompleted is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    maintenanceId is MaintenanceId with { briefly "Maintenance" described by "Maintenance ID." }
    cost is Decimal(10, 2) with { briefly "Cost" described by "Total cost." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Maintenance completed"
    described by "Emitted when maintenance completes."
  }

  event AlertRaised is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    alert is Alert with { briefly "Alert" described by "Alert details." }
  } with {
    briefly "Alert raised"
    described by "Emitted when alert is raised."
  }

  event AlertAcknowledged is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    alertId is UUID with { briefly "Alert" described by "Alert ID." }
    acknowledgedBy is String(1, 200) with { briefly "Acknowledged by" described by "Person." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "Acknowledgment time." }
  } with {
    briefly "Alert acknowledged"
    described by "Emitted when alert is acknowledged."
  }

  event VehicleDecommissioned is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Decommission reason." }
    decommissionedAt is TimeStamp with { briefly "Decommissioned" described by "Decommission time." }
  } with {
    briefly "Vehicle decommissioned"
    described by "Emitted when vehicle is decommissioned."
  }

  // State Records
  record ActiveStateData is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    vehicleInfo is VehicleInfo with { briefly "Vehicle" described by "Vehicle info." }
    status is VehicleStatus with { briefly "Status" described by "Current status." }
    currentLocation is optional GpsLocation with { briefly "Location" described by "Current location." }
    currentOdometer is Odometer with { briefly "Odometer" described by "Current odometer." }
    currentFuelLevel is optional FuelLevel with { briefly "Fuel" described by "Current fuel." }
    assignedDriver is optional DriverInfo with { briefly "Driver" described by "Assigned driver." }
    currentTrip is optional TripRecord with { briefly "Trip" described by "Current trip." }
    maintenanceHistory is many optional MaintenanceRecord with { briefly "Maintenance" described by "Maintenance history." }
    activeAlerts is many optional Alert with { briefly "Alerts" described by "Active alerts." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active state"
    described by "State for active vehicle."
  }

  // States
  state ActiveState of Vehicle.ActiveStateData with {
    briefly "Vehicle active"
    described by "Vehicle is in fleet."
  }

  // Handler
  handler VehicleHandler is {
    on command RegisterVehicle {
      morph entity VehicleContext.Vehicle to state VehicleContext.Vehicle.ActiveState with command RegisterVehicle
      tell event VehicleRegistered to entity VehicleContext.Vehicle
    }

    on command UpdateLocation {
      tell event LocationUpdated to entity VehicleContext.Vehicle
    }

    on command UpdateOdometer {
      tell event OdometerUpdated to entity VehicleContext.Vehicle
    }

    on command UpdateFuelLevel {
      tell event FuelLevelUpdated to entity VehicleContext.Vehicle
    }

    on command AssignDriver {
      tell event DriverAssigned to entity VehicleContext.Vehicle
    }

    on command UnassignDriver {
      tell event DriverUnassigned to entity VehicleContext.Vehicle
    }

    on command StartTrip {
      tell event TripStarted to entity VehicleContext.Vehicle
    }

    on command EndTrip {
      tell event TripEnded to entity VehicleContext.Vehicle
    }

    on command ScheduleMaintenance {
      tell event MaintenanceScheduled to entity VehicleContext.Vehicle
    }

    on command StartMaintenance {
      tell event MaintenanceStarted to entity VehicleContext.Vehicle
    }

    on command CompleteMaintenance {
      tell event MaintenanceCompleted to entity VehicleContext.Vehicle
    }

    on command RaiseAlert {
      tell event AlertRaised to entity VehicleContext.Vehicle
    }

    on command AcknowledgeAlert {
      tell event AlertAcknowledged to entity VehicleContext.Vehicle
    }

    on command DecommissionVehicle {
      tell event VehicleDecommissioned to entity VehicleContext.Vehicle
    }
  } with {
    briefly "Processes vehicle commands"
    described by {
      | Handles vehicle lifecycle from registration
      | through tracking and maintenance.
    }
  }

} with {
  briefly "Vehicle aggregate"
  described by {
    | The Vehicle entity manages fleet vehicles
    | and their operational state.
  }
}
