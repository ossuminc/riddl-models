// Route Optimization - Route Context

context RouteContext is {

  include "types.riddl"
  include "Route.riddl"

  // Repository for route persistence
  repository RouteRepository is {
    schema RouteData is relational
      of routes as Route
      index on field Route.routeId
      index on field Route.scheduledDate
      index on field Route.driver.driverId
      index on field Route.status

    handler RoutePersistence is {
      on command Route.CreateRoute {
        prompt "Store new route"
      }
      on command Route.AddStop {
        prompt "Add stop to route"
      }
      on command Route.RemoveStop {
        prompt "Remove stop from route"
      }
      on command Route.OptimizeRoute {
        prompt "Update route optimization"
      }
      on command Route.ReorderStops {
        prompt "Update stop sequence"
      }
      on command Route.AssignDriver {
        prompt "Store driver assignment"
      }
      on command Route.StartRoute {
        prompt "Update to in progress"
      }
      on command Route.ArriveAtStop {
        prompt "Update stop arrival"
      }
      on command Route.CompleteStop {
        prompt "Update stop completion"
      }
      on command Route.SkipStop {
        prompt "Update stop to skipped"
      }
      on command Route.RecordDeliveryFailure {
        prompt "Update stop to failed"
      }
      on command Route.CompleteRoute {
        prompt "Update to completed"
      }
      on command Route.CancelRoute {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists route commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Route data persistence"
    described by {
      | The RouteRepository provides persistent storage for
      | routes and related data.
    }
  }

  // Projector for route analytics
  projector RouteAnalytics is {
    updates repository RouteRepository

    record RouteStats is {
      totalRoutes is Natural with { briefly "Total" described by "Total routes." }
      completedRoutes is Natural with { briefly "Completed" described by "Completed routes." }
      onTimeDeliveries is Natural with { briefly "On time" described by "On-time deliveries." }
      lateDeliveries is Natural with { briefly "Late" described by "Late deliveries." }
      failedDeliveries is Natural with { briefly "Failed" described by "Failed deliveries." }
      aggregateDistance is Decimal(12, 2) with { briefly "Distance" described by "Total fleet distance." }
      avgOptimizationSavings is Decimal(5, 2) with { briefly "Savings" described by "Avg optimization savings." }
    } with {
      briefly "Route statistics"
      described by "Route operational metrics."
    }

    handler AnalyticsHandler is {
      on event Route.RouteCreated {
        prompt "Update route counts"
      }
      on event Route.RouteOptimized {
        prompt "Update optimization metrics"
      }
      on event Route.StopCompleted {
        prompt "Update delivery metrics"
      }
      on event Route.DeliveryFailed {
        prompt "Update failure metrics"
      }
      on event Route.RouteCompleted {
        prompt "Update completion metrics"
      }
    } with {
      briefly "Maintains route analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Route analytics projections"
    described by "Maintains route operational analytics data."
  }

} with {
  briefly "Bounded context for route optimization"
  described by {
    | The RouteContext is the bounded context for
    | delivery route planning and execution.
  }
}
