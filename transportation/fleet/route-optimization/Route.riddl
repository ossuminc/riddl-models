// Route Optimization - Route Entity

entity Route is {

  // Commands
  command CreateRoute is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "New route identifier."
    }
    name is String(1, 100) with {
      briefly "Name"
      described by "Route name."
    }
    scheduledDate is Date with {
      briefly "Date"
      described by "Scheduled date."
    }
    stops is many DeliveryStop with {
      briefly "Stops"
      described by "Delivery stops."
    }
    startLocation is Address with {
      briefly "Start"
      described by "Starting location."
    }
    endLocation is optional Address with {
      briefly "End"
      described by "Ending location."
    }
  } with {
    briefly "Create route"
    described by "Creates a new delivery route."
  }

  command AddStop is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    stop is DeliveryStop with {
      briefly "Stop"
      described by "Stop to add."
    }
  } with {
    briefly "Add stop"
    described by "Adds stop to route."
  }

  command RemoveStop is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    stopId is StopId with {
      briefly "Stop"
      described by "Stop to remove."
    }
  } with {
    briefly "Remove stop"
    described by "Removes stop from route."
  }

  command OptimizeRoute is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    strategy is OptimizationStrategy with {
      briefly "Strategy"
      described by "Optimization strategy."
    }
  } with {
    briefly "Optimize route"
    described by "Optimizes stop sequence."
  }

  command ReorderStops is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    newSequence is many StopId with {
      briefly "Sequence"
      described by "New stop sequence."
    }
  } with {
    briefly "Reorder stops"
    described by "Manually reorders stops."
  }

  command AssignDriver is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    driver is DriverInfo with {
      briefly "Driver"
      described by "Driver to assign."
    }
  } with {
    briefly "Assign driver"
    described by "Assigns driver to route."
  }

  command StartRoute is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    startedAt is TimeStamp with {
      briefly "Started"
      described by "Start time."
    }
    startOdometer is Natural with {
      briefly "Odometer"
      described by "Starting odometer."
    }
  } with {
    briefly "Start route"
    described by "Starts route execution."
  }

  command ArriveAtStop is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    stopId is StopId with {
      briefly "Stop"
      described by "Stop arrived at."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
    currentLocation is GpsLocation with {
      briefly "Location"
      described by "Current GPS location."
    }
  } with {
    briefly "Arrive at stop"
    described by "Records arrival at stop."
  }

  command CompleteStop is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    completion is StopCompletion with {
      briefly "Completion"
      described by "Stop completion details."
    }
  } with {
    briefly "Complete stop"
    described by "Completes delivery at stop."
  }

  command SkipStop is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    stopId is StopId with {
      briefly "Stop"
      described by "Stop to skip."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Skip reason."
    }
  } with {
    briefly "Skip stop"
    described by "Skips a stop."
  }

  command RecordDeliveryFailure is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    stopId is StopId with {
      briefly "Stop"
      described by "Failed stop."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Failure reason."
    }
  } with {
    briefly "Record failure"
    described by "Records delivery failure."
  }

  command CompleteRoute is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
    endOdometer is Natural with {
      briefly "Odometer"
      described by "Ending odometer."
    }
  } with {
    briefly "Complete route"
    described by "Completes the route."
  }

  command CancelRoute is {
    routeId is RouteId with {
      briefly "Route ID"
      described by "Route identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel route"
    described by "Cancels the route."
  }

  // Events
  event RouteCreated is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    name is String(1, 100) with { briefly "Name" described by "Route name." }
    scheduledDate is Date with { briefly "Date" described by "Scheduled date." }
    stops is many DeliveryStop with { briefly "Stops" described by "Delivery stops." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Route created"
    described by "Emitted when route is created."
  }

  event StopAdded is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    stop is DeliveryStop with { briefly "Stop" described by "Added stop." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Stop added"
    described by "Emitted when stop is added."
  }

  event StopRemoved is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    stopId is StopId with { briefly "Stop" described by "Removed stop." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Stop removed"
    described by "Emitted when stop is removed."
  }

  event RouteOptimized is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    result is OptimizationResult with { briefly "Result" described by "Optimization result." }
    optimizedAt is TimeStamp with { briefly "Optimized" described by "Optimization time." }
  } with {
    briefly "Route optimized"
    described by "Emitted when route is optimized."
  }

  event StopsReordered is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    newSequence is many StopId with { briefly "Sequence" described by "New sequence." }
    reorderedAt is TimeStamp with { briefly "Reordered" described by "Reorder time." }
  } with {
    briefly "Stops reordered"
    described by "Emitted when stops are reordered."
  }

  event DriverAssigned is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    driver is DriverInfo with { briefly "Driver" described by "Assigned driver." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Driver assigned"
    described by "Emitted when driver is assigned."
  }

  event RouteStarted is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    startOdometer is Natural with { briefly "Odometer" described by "Start odometer." }
  } with {
    briefly "Route started"
    described by "Emitted when route starts."
  }

  event ArrivedAtStop is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    stopId is StopId with { briefly "Stop" described by "Stop ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Arrived at stop"
    described by "Emitted when arriving at stop."
  }

  event StopCompleted is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    completion is StopCompletion with { briefly "Completion" described by "Completion details." }
  } with {
    briefly "Stop completed"
    described by "Emitted when stop is completed."
  }

  event StopSkipped is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    stopId is StopId with { briefly "Stop" described by "Skipped stop." }
    reason is String(1, 500) with { briefly "Reason" described by "Skip reason." }
    skippedAt is TimeStamp with { briefly "Skipped" described by "Skip time." }
  } with {
    briefly "Stop skipped"
    described by "Emitted when stop is skipped."
  }

  event DeliveryFailed is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    stopId is StopId with { briefly "Stop" described by "Failed stop." }
    reason is String(1, 500) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Delivery failed"
    described by "Emitted when delivery fails."
  }

  event RouteCompleted is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    metrics is RouteMetrics with { briefly "Metrics" described by "Route metrics." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
    endOdometer is Natural with { briefly "Odometer" described by "End odometer." }
  } with {
    briefly "Route completed"
    described by "Emitted when route completes."
  }

  event RouteCancelled is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancellation reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancellation time." }
  } with {
    briefly "Route cancelled"
    described by "Emitted when route is cancelled."
  }

  // State Records
  record ActiveStateData is {
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    name is String(1, 100) with { briefly "Name" described by "Route name." }
    scheduledDate is Date with { briefly "Date" described by "Scheduled date." }
    stops is many DeliveryStop with { briefly "Stops" described by "Delivery stops." }
    routeSegments is many optional RouteSegment with { briefly "Segments" described by "Route segments." }
    startLocation is Address with { briefly "Start" described by "Start location." }
    endLocation is optional Address with { briefly "End" described by "End location." }
    assignedDriver is optional DriverInfo with { briefly "Driver" described by "Assigned driver." }
    status is RouteStatus with { briefly "Status" described by "Route status." }
    currentMetrics is optional RouteMetrics with { briefly "Metrics" described by "Route metrics." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active route."
  }

  // States
  state ActiveState of Route.ActiveStateData with {
    briefly "Route active"
    described by "Route is active."
  }

  // Handler
  handler RouteHandler is {
    on command CreateRoute {
      morph entity RouteContext.Route to state RouteContext.Route.ActiveState with command CreateRoute
      tell event RouteCreated to entity RouteContext.Route
    }

    on command AddStop {
      tell event StopAdded to entity RouteContext.Route
    }

    on command RemoveStop {
      tell event StopRemoved to entity RouteContext.Route
    }

    on command OptimizeRoute {
      tell event RouteOptimized to entity RouteContext.Route
    }

    on command ReorderStops {
      tell event StopsReordered to entity RouteContext.Route
    }

    on command AssignDriver {
      tell event DriverAssigned to entity RouteContext.Route
    }

    on command StartRoute {
      tell event RouteStarted to entity RouteContext.Route
    }

    on command ArriveAtStop {
      tell event ArrivedAtStop to entity RouteContext.Route
    }

    on command CompleteStop {
      tell event StopCompleted to entity RouteContext.Route
    }

    on command SkipStop {
      tell event StopSkipped to entity RouteContext.Route
    }

    on command RecordDeliveryFailure {
      tell event DeliveryFailed to entity RouteContext.Route
    }

    on command CompleteRoute {
      tell event RouteCompleted to entity RouteContext.Route
    }

    on command CancelRoute {
      tell event RouteCancelled to entity RouteContext.Route
    }
  } with {
    briefly "Processes route commands"
    described by {
      | Handles route lifecycle from creation
      | through execution and completion.
    }
  }

} with {
  briefly "Route aggregate"
  described by {
    | The Route entity manages delivery routes
    | and their execution.
  }
}
