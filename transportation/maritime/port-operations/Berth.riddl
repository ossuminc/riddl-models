// Port Operations - Berth Entity
entity Berth is {
  // Commands
  command CreateBerth is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |New berth identifier.
      }
    }
    details: BerthDetails with {
      briefly "Details"
      described as {
        |Berth details.
      }
    }
  } with {
    briefly "Create berth"
    described as {
      |Creates a new berth in the terminal.
    }
  }
  command UpdateBerthDetails is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    details: BerthDetails with {
      briefly "Details"
      described as {
        |Updated details.
      }
    }
  } with {
    briefly "Update berth details"
    described as {
      |Updates berth specifications.
    }
  }
  command RequestBerth is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    request: PortCallRequest with {
      briefly "Request"
      described as {
        |Port call request.
      }
    }
  } with {
    briefly "Request berth"
    described as {
      |Requests berth allocation for port call.
    }
  }
  command ConfirmBerthAssignment is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    assignment: BerthAssignment with {
      briefly "Assignment"
      described as {
        |Berth assignment details.
      }
    }
  } with {
    briefly "Confirm berth"
    described as {
      |Confirms berth assignment.
    }
  }
  command AssignPilot is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    pilotage: PilotageInfo with {
      briefly "Pilotage"
      described as {
        |Pilotage details.
      }
    }
  } with {
    briefly "Assign pilot"
    described as {
      |Assigns pilot for arrival.
    }
  }
  command OrderTugs is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    tugs: TugService with {
      briefly "Tugs"
      described as {
        |Tug service details.
      }
    }
  } with {
    briefly "Order tugs"
    described as {
      |Orders tug assistance.
    }
  }
  command RecordVesselArrival is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
    actualDraft: Decimal(4,2) with {
      briefly "Draft"
      described as {
        |Actual draft.
      }
    }
  } with {
    briefly "Record arrival"
    described as {
      |Records vessel arrival.
    }
  }
  command RecordMooring is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    mooring: MooringOperation with {
      briefly "Mooring"
      described as {
        |Mooring details.
      }
    }
  } with {
    briefly "Record mooring"
    described as {
      |Records mooring completion.
    }
  }
  command StartCargoOperations is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    operation: CargoOperation with {
      briefly "Operation"
      described as {
        |Cargo operation details.
      }
    }
  } with {
    briefly "Start cargo operations"
    described as {
      |Starts cargo handling.
    }
  }
  command CompleteCargoOperations is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    completion: CargoOperation with {
      briefly "Completion"
      described as {
        |Completed operation.
      }
    }
  } with {
    briefly "Complete cargo operations"
    described as {
      |Completes cargo handling.
    }
  }
  command RecordVesselDeparture is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
    nextPort: String(1,200) with {
      briefly "Next port"
      described as {
        |Next destination.
      }
    }
  } with {
    briefly "Record departure"
    described as {
      |Records vessel departure.
    }
  }
  command GeneratePortCharges is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    charges: PortCharges with {
      briefly "Charges"
      described as {
        |Port charges.
      }
    }
  } with {
    briefly "Generate charges"
    described as {
      |Generates port call charges.
    }
  }
  command CancelPortCall is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel port call"
    described as {
      |Cancels scheduled port call.
    }
  }
  command SetBerthMaintenance is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Maintenance reason.
      }
    }
    fromDate: Date with {
      briefly "From"
      described as {
        |Maintenance start.
      }
    }
    toDate: Date with {
      briefly "To"
      described as {
        |Maintenance end.
      }
    }
  } with {
    briefly "Set maintenance"
    described as {
      |Schedules berth maintenance.
    }
  }
  // Events
  event BerthCreated is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    details: BerthDetails with {
      briefly "Details"
      described as {
        |Berth details.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Berth created"
    described as {
      |Emitted when berth is created.
    }
  }
  event BerthDetailsUpdated is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    details: BerthDetails with {
      briefly "Details"
      described as {
        |New details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Berth details updated"
    described as {
      |Emitted when details are updated.
    }
  }
  event BerthRequested is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    request: PortCallRequest with {
      briefly "Request"
      described as {
        |Port call request.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Berth requested"
    described as {
      |Emitted when berth is requested.
    }
  }
  event BerthAssignmentConfirmed is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    assignment: BerthAssignment with {
      briefly "Assignment"
      described as {
        |Assignment details.
      }
    }
    confirmedAt: TimeStamp with {
      briefly "Confirmed"
      described as {
        |Confirmation time.
      }
    }
  } with {
    briefly "Berth confirmed"
    described as {
      |Emitted when berth is confirmed.
    }
  }
  event PilotAssigned is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    pilotage: PilotageInfo with {
      briefly "Pilotage"
      described as {
        |Pilotage details.
      }
    }
  } with {
    briefly "Pilot assigned"
    described as {
      |Emitted when pilot is assigned.
    }
  }
  event TugsOrdered is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    tugs: TugService with {
      briefly "Tugs"
      described as {
        |Tug details.
      }
    }
    orderedAt: TimeStamp with {
      briefly "Ordered"
      described as {
        |Order time.
      }
    }
  } with {
    briefly "Tugs ordered"
    described as {
      |Emitted when tugs are ordered.
    }
  }
  event VesselArrived is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Vessel arrived"
    described as {
      |Emitted when vessel arrives.
    }
  }
  event MooringCompleted is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    mooring: MooringOperation with {
      briefly "Mooring"
      described as {
        |Mooring details.
      }
    }
  } with {
    briefly "Mooring completed"
    described as {
      |Emitted when mooring is done.
    }
  }
  event CargoOperationsStarted is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    operation: CargoOperation with {
      briefly "Operation"
      described as {
        |Cargo operation.
      }
    }
  } with {
    briefly "Cargo operations started"
    described as {
      |Emitted when cargo handling starts.
    }
  }
  event CargoOperationsCompleted is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    operation: CargoOperation with {
      briefly "Operation"
      described as {
        |Cargo operation.
      }
    }
  } with {
    briefly "Cargo operations completed"
    described as {
      |Emitted when cargo handling completes.
    }
  }
  event VesselDeparted is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
    nextPort: String(1,200) with {
      briefly "Next port"
      described as {
        |Next destination.
      }
    }
  } with {
    briefly "Vessel departed"
    described as {
      |Emitted when vessel departs.
    }
  }
  event PortChargesGenerated is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    charges: PortCharges with {
      briefly "Charges"
      described as {
        |Port charges.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Port charges generated"
    described as {
      |Emitted when charges are calculated.
    }
  }
  event PortCallCancelled is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    portCallId: PortCallId with {
      briefly "Port call"
      described as {
        |Port call ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Port call cancelled"
    described as {
      |Emitted when port call is cancelled.
    }
  }
  event BerthMaintenanceScheduled is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Maintenance reason.
      }
    }
    fromDate: Date with {
      briefly "From"
      described as {
        |Start date.
      }
    }
    toDate: Date with {
      briefly "To"
      described as {
        |End date.
      }
    }
  } with {
    briefly "Maintenance scheduled"
    described as {
      |Emitted when maintenance is scheduled.
    }
  }
  // State Records
  record ActiveStateData is  {
    berthId: BerthId with {
      briefly "Berth"
      described as {
        |Berth ID.
      }
    }
    details: BerthDetails with {
      briefly "Details"
      described as {
        |Berth details.
      }
    }
    status: BerthStatus with {
      briefly "Status"
      described as {
        |Berth status.
      }
    }
    currentPortCall: PortCallRequest? with {
      briefly "Current"
      described as {
        |Current port call.
      }
    }
    currentAssignment: BerthAssignment? with {
      briefly "Assignment"
      described as {
        |Current assignment.
      }
    }
    cargoOperations: CargoOperation* with {
      briefly "Cargo"
      described as {
        |Cargo operations.
      }
    }
    pendingCharges: PortCharges? with {
      briefly "Charges"
      described as {
        |Pending charges.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active berth.
    }
  }
  // States
  state ActiveState of type Berth.ActiveStateData
  // Handler
  handler BerthHandler is {
    on command CreateBerth is {
      morph entity BerthContext.Berth to state BerthContext.Berth.ActiveState with command CreateBerth
      tell event BerthCreated to entity BerthContext.Berth
    }
    on command UpdateBerthDetails is {
      tell event BerthDetailsUpdated to entity BerthContext.Berth
    }
    on command RequestBerth is {
      tell event BerthRequested to entity BerthContext.Berth
    }
    on command ConfirmBerthAssignment is {
      tell event BerthAssignmentConfirmed to entity BerthContext.Berth
    }
    on command AssignPilot is {
      tell event PilotAssigned to entity BerthContext.Berth
    }
    on command BerthContext.Berth.OrderTugs is {
      tell event TugsOrdered to entity BerthContext.Berth
    }
    on command RecordVesselArrival is {
      tell event VesselArrived to entity BerthContext.Berth
    }
    on command RecordMooring is {
      tell event MooringCompleted to entity BerthContext.Berth
    }
    on command StartCargoOperations is {
      tell event CargoOperationsStarted to entity BerthContext.Berth
    }
    on command CompleteCargoOperations is {
      tell event CargoOperationsCompleted to entity BerthContext.Berth
    }
    on command RecordVesselDeparture is {
      tell event VesselDeparted to entity BerthContext.Berth
    }
    on command GeneratePortCharges is {
      tell event PortChargesGenerated to entity BerthContext.Berth
    }
    on command CancelPortCall is {
      tell event PortCallCancelled to entity BerthContext.Berth
    }
    on command SetBerthMaintenance is {
      tell event BerthMaintenanceScheduled to entity BerthContext.Berth
    }
  } with {
    briefly "Processes berth commands"
    described as {
      | Handles berth lifecycle from creation
      | through port calls and maintenance.
    }
  }
} with {
  briefly "Berth aggregate"
  described as {
    | The Berth entity manages port berths
    | and vessel port calls.
  }
}
