// Port Operations - Berth Entity

entity Berth is {

  // Commands
  command CreateBerth is {
    berthId is BerthId with {
      briefly "Berth"
      described by "New berth identifier."
    }
    details is BerthDetails with {
      briefly "Details"
      described by "Berth details."
    }
  } with {
    briefly "Create berth"
    described by "Creates a new berth in the terminal."
  }

  command UpdateBerthDetails is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    details is BerthDetails with {
      briefly "Details"
      described by "Updated details."
    }
  } with {
    briefly "Update berth details"
    described by "Updates berth specifications."
  }

  command RequestBerth is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    request is PortCallRequest with {
      briefly "Request"
      described by "Port call request."
    }
  } with {
    briefly "Request berth"
    described by "Requests berth allocation for port call."
  }

  command ConfirmBerthAssignment is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    assignment is BerthAssignment with {
      briefly "Assignment"
      described by "Berth assignment details."
    }
  } with {
    briefly "Confirm berth"
    described by "Confirms berth assignment."
  }

  command AssignPilot is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    pilotage is PilotageInfo with {
      briefly "Pilotage"
      described by "Pilotage details."
    }
  } with {
    briefly "Assign pilot"
    described by "Assigns pilot for arrival."
  }

  command OrderTugs is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    tugs is TugService with {
      briefly "Tugs"
      described by "Tug service details."
    }
  } with {
    briefly "Order tugs"
    described by "Orders tug assistance."
  }

  command RecordVesselArrival is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
    actualDraft is Decimal(4, 2) with {
      briefly "Draft"
      described by "Actual draft."
    }
  } with {
    briefly "Record arrival"
    described by "Records vessel arrival."
  }

  command RecordMooring is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    mooring is MooringOperation with {
      briefly "Mooring"
      described by "Mooring details."
    }
  } with {
    briefly "Record mooring"
    described by "Records mooring completion."
  }

  command StartCargoOperations is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    operation is CargoOperation with {
      briefly "Operation"
      described by "Cargo operation details."
    }
  } with {
    briefly "Start cargo operations"
    described by "Starts cargo handling."
  }

  command CompleteCargoOperations is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    completion is CargoOperation with {
      briefly "Completion"
      described by "Completed operation."
    }
  } with {
    briefly "Complete cargo operations"
    described by "Completes cargo handling."
  }

  command RecordVesselDeparture is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    departedAt is TimeStamp with {
      briefly "Departed"
      described by "Departure time."
    }
    nextPort is String(1, 200) with {
      briefly "Next port"
      described by "Next destination."
    }
  } with {
    briefly "Record departure"
    described by "Records vessel departure."
  }

  command GeneratePortCharges is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    charges is PortCharges with {
      briefly "Charges"
      described by "Port charges."
    }
  } with {
    briefly "Generate charges"
    described by "Generates port call charges."
  }

  command CancelPortCall is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel port call"
    described by "Cancels scheduled port call."
  }

  command SetBerthMaintenance is {
    berthId is BerthId with {
      briefly "Berth"
      described by "Berth identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Maintenance reason."
    }
    fromDate is Date with {
      briefly "From"
      described by "Maintenance start."
    }
    toDate is Date with {
      briefly "To"
      described by "Maintenance end."
    }
  } with {
    briefly "Set maintenance"
    described by "Schedules berth maintenance."
  }

  // Events
  event BerthCreated is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    details is BerthDetails with { briefly "Details" described by "Berth details." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Berth created"
    described by "Emitted when berth is created."
  }

  event BerthDetailsUpdated is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    details is BerthDetails with { briefly "Details" described by "New details." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Berth details updated"
    described by "Emitted when details are updated."
  }

  event BerthRequested is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    request is PortCallRequest with { briefly "Request" described by "Port call request." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Berth requested"
    described by "Emitted when berth is requested."
  }

  event BerthAssignmentConfirmed is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    assignment is BerthAssignment with { briefly "Assignment" described by "Assignment details." }
    confirmedAt is TimeStamp with { briefly "Confirmed" described by "Confirmation time." }
  } with {
    briefly "Berth confirmed"
    described by "Emitted when berth is confirmed."
  }

  event PilotAssigned is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    pilotage is PilotageInfo with { briefly "Pilotage" described by "Pilotage details." }
  } with {
    briefly "Pilot assigned"
    described by "Emitted when pilot is assigned."
  }

  event TugsOrdered is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    tugs is TugService with { briefly "Tugs" described by "Tug details." }
    orderedAt is TimeStamp with { briefly "Ordered" described by "Order time." }
  } with {
    briefly "Tugs ordered"
    described by "Emitted when tugs are ordered."
  }

  event VesselArrived is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Vessel arrived"
    described by "Emitted when vessel arrives."
  }

  event MooringCompleted is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    mooring is MooringOperation with { briefly "Mooring" described by "Mooring details." }
  } with {
    briefly "Mooring completed"
    described by "Emitted when mooring is done."
  }

  event CargoOperationsStarted is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    operation is CargoOperation with { briefly "Operation" described by "Cargo operation." }
  } with {
    briefly "Cargo operations started"
    described by "Emitted when cargo handling starts."
  }

  event CargoOperationsCompleted is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    operation is CargoOperation with { briefly "Operation" described by "Cargo operation." }
  } with {
    briefly "Cargo operations completed"
    described by "Emitted when cargo handling completes."
  }

  event VesselDeparted is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    departedAt is TimeStamp with { briefly "Departed" described by "Departure time." }
    nextPort is String(1, 200) with { briefly "Next port" described by "Next destination." }
  } with {
    briefly "Vessel departed"
    described by "Emitted when vessel departs."
  }

  event PortChargesGenerated is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    charges is PortCharges with { briefly "Charges" described by "Port charges." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Port charges generated"
    described by "Emitted when charges are calculated."
  }

  event PortCallCancelled is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Port call cancelled"
    described by "Emitted when port call is cancelled."
  }

  event BerthMaintenanceScheduled is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Maintenance reason." }
    fromDate is Date with { briefly "From" described by "Start date." }
    toDate is Date with { briefly "To" described by "End date." }
  } with {
    briefly "Maintenance scheduled"
    described by "Emitted when maintenance is scheduled."
  }

  // State Records
  record ActiveStateData is {
    berthId is BerthId with { briefly "Berth" described by "Berth ID." }
    details is BerthDetails with { briefly "Details" described by "Berth details." }
    status is BerthStatus with { briefly "Status" described by "Berth status." }
    currentPortCall is optional PortCallRequest with { briefly "Current" described by "Current port call." }
    currentAssignment is optional BerthAssignment with { briefly "Assignment" described by "Current assignment." }
    cargoOperations is many optional CargoOperation with { briefly "Cargo" described by "Cargo operations." }
    pendingCharges is optional PortCharges with { briefly "Charges" described by "Pending charges." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active berth."
  }

  // States
  state ActiveState of Berth.ActiveStateData with {
    briefly "Berth active"
    described by "Berth is operational."
  }

  // Handler
  handler BerthHandler is {
    on command CreateBerth {
      morph entity BerthContext.Berth to state BerthContext.Berth.ActiveState with command CreateBerth
      tell event BerthCreated to entity BerthContext.Berth
    }

    on command UpdateBerthDetails {
      tell event BerthDetailsUpdated to entity BerthContext.Berth
    }

    on command RequestBerth {
      tell event BerthRequested to entity BerthContext.Berth
    }

    on command ConfirmBerthAssignment {
      tell event BerthAssignmentConfirmed to entity BerthContext.Berth
    }

    on command AssignPilot {
      tell event PilotAssigned to entity BerthContext.Berth
    }

    on command OrderTugs {
      tell event TugsOrdered to entity BerthContext.Berth
    }

    on command RecordVesselArrival {
      tell event VesselArrived to entity BerthContext.Berth
    }

    on command RecordMooring {
      tell event MooringCompleted to entity BerthContext.Berth
    }

    on command StartCargoOperations {
      tell event CargoOperationsStarted to entity BerthContext.Berth
    }

    on command CompleteCargoOperations {
      tell event CargoOperationsCompleted to entity BerthContext.Berth
    }

    on command RecordVesselDeparture {
      tell event VesselDeparted to entity BerthContext.Berth
    }

    on command GeneratePortCharges {
      tell event PortChargesGenerated to entity BerthContext.Berth
    }

    on command CancelPortCall {
      tell event PortCallCancelled to entity BerthContext.Berth
    }

    on command SetBerthMaintenance {
      tell event BerthMaintenanceScheduled to entity BerthContext.Berth
    }
  } with {
    briefly "Processes berth commands"
    described by {
      | Handles berth lifecycle from creation
      | through port calls and maintenance.
    }
  }

} with {
  briefly "Berth aggregate"
  described by {
    | The Berth entity manages port berths
    | and vessel port calls.
  }
}
