// Vessel Management - Vessel Entity

entity Vessel is {

  // Commands
  command RegisterVessel is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "New vessel identifier."
    }
    specifications is VesselSpecifications with {
      briefly "Specs"
      described by "Vessel specifications."
    }
  } with {
    briefly "Register vessel"
    described by "Registers a new vessel in the fleet."
  }

  command UpdateSpecifications is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    specifications is VesselSpecifications with {
      briefly "Specs"
      described by "Updated specifications."
    }
  } with {
    briefly "Update specifications"
    described by "Updates vessel specifications."
  }

  command UpdatePosition is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    position is VesselPosition with {
      briefly "Position"
      described by "Current position."
    }
  } with {
    briefly "Update position"
    described by "Updates vessel position."
  }

  command CreateVoyage is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    voyage is VoyageDetails with {
      briefly "Voyage"
      described by "Voyage details."
    }
    portCalls is many PortCallInfo with {
      briefly "Port calls"
      described by "Scheduled port calls."
    }
  } with {
    briefly "Create voyage"
    described by "Creates a new voyage."
  }

  command UpdateVoyage is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    voyageId is VoyageId with {
      briefly "Voyage"
      described by "Voyage identifier."
    }
    updates is VoyageDetails with {
      briefly "Updates"
      described by "Voyage updates."
    }
  } with {
    briefly "Update voyage"
    described by "Updates voyage details."
  }

  command RecordPortArrival is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call ID."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
    position is GpsLocation with {
      briefly "Position"
      described by "Arrival position."
    }
  } with {
    briefly "Record port arrival"
    described by "Records arrival at port."
  }

  command RecordPortDeparture is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    portCallId is PortCallId with {
      briefly "Port call"
      described by "Port call ID."
    }
    departedAt is TimeStamp with {
      briefly "Departed"
      described by "Departure time."
    }
    nextPort is String(1, 200) with {
      briefly "Next"
      described by "Next destination."
    }
  } with {
    briefly "Record port departure"
    described by "Records departure from port."
  }

  command CompleteVoyage is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    voyageId is VoyageId with {
      briefly "Voyage"
      described by "Voyage identifier."
    }
    completedAt is Date with {
      briefly "Completed"
      described by "Completion date."
    }
  } with {
    briefly "Complete voyage"
    described by "Completes a voyage."
  }

  command AddCrewMember is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    crew is CrewMember with {
      briefly "Crew"
      described by "Crew member details."
    }
  } with {
    briefly "Add crew member"
    described by "Adds crew member to vessel."
  }

  command RemoveCrewMember is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    crewMemberId is CrewMemberId with {
      briefly "Crew"
      described by "Crew member ID."
    }
    signOffDate is Date with {
      briefly "Sign off"
      described by "Departure date."
    }
  } with {
    briefly "Remove crew member"
    described by "Removes crew member from vessel."
  }

  command AddCertificate is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    certificate is VesselCertificate with {
      briefly "Certificate"
      described by "Certificate details."
    }
  } with {
    briefly "Add certificate"
    described by "Adds vessel certificate."
  }

  command RenewCertificate is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    certificateId is CertificateId with {
      briefly "Certificate"
      described by "Certificate ID."
    }
    newExpiryDate is Date with {
      briefly "Expiry"
      described by "New expiry date."
    }
    newSurveyDate is optional Date with {
      briefly "Survey"
      described by "Next survey date."
    }
  } with {
    briefly "Renew certificate"
    described by "Renews vessel certificate."
  }

  command SubmitBunkerReport is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    report is BunkerReport with {
      briefly "Report"
      described by "Bunker report."
    }
  } with {
    briefly "Submit bunker report"
    described by "Submits fuel consumption report."
  }

  command RecordMaintenance is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    maintenance is MaintenanceRecord with {
      briefly "Maintenance"
      described by "Maintenance record."
    }
  } with {
    briefly "Record maintenance"
    described by "Records maintenance activity."
  }

  command SetVesselStatus is {
    vesselId is VesselId with {
      briefly "Vessel"
      described by "Vessel identifier."
    }
    status is VesselStatus with {
      briefly "Status"
      described by "New status."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Status change reason."
    }
  } with {
    briefly "Set vessel status"
    described by "Changes vessel operational status."
  }

  // Events
  event VesselRegistered is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    specifications is VesselSpecifications with { briefly "Specs" described by "Vessel specs." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Vessel registered"
    described by "Emitted when vessel is registered."
  }

  event SpecificationsUpdated is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    specifications is VesselSpecifications with { briefly "Specs" described by "New specs." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Specifications updated"
    described by "Emitted when specs are updated."
  }

  event PositionUpdated is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    position is VesselPosition with { briefly "Position" described by "New position." }
  } with {
    briefly "Position updated"
    described by "Emitted when position is updated."
  }

  event VoyageCreated is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    voyage is VoyageDetails with { briefly "Voyage" described by "Voyage details." }
    portCalls is many PortCallInfo with { briefly "Port calls" described by "Port calls." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Voyage created"
    described by "Emitted when voyage is created."
  }

  event VoyageUpdated is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    voyageId is VoyageId with { briefly "Voyage" described by "Voyage ID." }
    updates is VoyageDetails with { briefly "Updates" described by "Voyage updates." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Voyage updated"
    described by "Emitted when voyage is updated."
  }

  event PortArrivalRecorded is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Port arrival recorded"
    described by "Emitted when arriving at port."
  }

  event PortDepartureRecorded is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    portCallId is PortCallId with { briefly "Port call" described by "Port call ID." }
    departedAt is TimeStamp with { briefly "Departed" described by "Departure time." }
  } with {
    briefly "Port departure recorded"
    described by "Emitted when departing port."
  }

  event VoyageCompleted is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    voyageId is VoyageId with { briefly "Voyage" described by "Voyage ID." }
    completedAt is Date with { briefly "Completed" described by "Completion date." }
  } with {
    briefly "Voyage completed"
    described by "Emitted when voyage is completed."
  }

  event CrewMemberAdded is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    crew is CrewMember with { briefly "Crew" described by "Crew member." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Crew member added"
    described by "Emitted when crew joins."
  }

  event CrewMemberRemoved is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    crewMemberId is CrewMemberId with { briefly "Crew" described by "Crew member ID." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Crew member removed"
    described by "Emitted when crew departs."
  }

  event CertificateAdded is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    certificate is VesselCertificate with { briefly "Certificate" described by "Certificate." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Certificate added"
    described by "Emitted when certificate is added."
  }

  event CertificateRenewed is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    certificateId is CertificateId with { briefly "Certificate" described by "Certificate ID." }
    newExpiryDate is Date with { briefly "Expiry" described by "New expiry." }
    renewedAt is TimeStamp with { briefly "Renewed" described by "Renewal time." }
  } with {
    briefly "Certificate renewed"
    described by "Emitted when certificate is renewed."
  }

  event BunkerReportSubmitted is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    report is BunkerReport with { briefly "Report" described by "Bunker report." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Bunker report submitted"
    described by "Emitted when bunker report is filed."
  }

  event MaintenanceRecorded is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    maintenance is MaintenanceRecord with { briefly "Maintenance" described by "Maintenance record." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Maintenance recorded"
    described by "Emitted when maintenance is logged."
  }

  event VesselStatusChanged is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    previousStatus is VesselStatus with { briefly "Previous" described by "Previous status." }
    newStatus is VesselStatus with { briefly "New" described by "New status." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Vessel status changed"
    described by "Emitted when status changes."
  }

  // State Records
  record ActiveStateData is {
    vesselId is VesselId with { briefly "Vessel" described by "Vessel ID." }
    specifications is VesselSpecifications with { briefly "Specs" described by "Vessel specs." }
    status is VesselStatus with { briefly "Status" described by "Vessel status." }
    currentPosition is optional VesselPosition with { briefly "Position" described by "Current position." }
    currentVoyage is optional VoyageDetails with { briefly "Voyage" described by "Current voyage." }
    portCalls is many optional PortCallInfo with { briefly "Port calls" described by "Scheduled calls." }
    crew is many optional CrewMember with { briefly "Crew" described by "Current crew." }
    certificates is many optional VesselCertificate with { briefly "Certificates" described by "Valid certificates." }
    lastBunkerReport is optional BunkerReport with { briefly "Bunker" described by "Last bunker report." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active state"
    described by "State for active vessel."
  }

  // States
  state ActiveState of Vessel.ActiveStateData with {
    briefly "Vessel active"
    described by "Vessel is in fleet."
  }

  // Handler
  handler VesselHandler is {
    on command RegisterVessel {
      morph entity VesselContext.Vessel to state VesselContext.Vessel.ActiveState with command RegisterVessel
      tell event VesselRegistered to entity VesselContext.Vessel
    }

    on command UpdateSpecifications {
      tell event SpecificationsUpdated to entity VesselContext.Vessel
    }

    on command UpdatePosition {
      tell event PositionUpdated to entity VesselContext.Vessel
    }

    on command CreateVoyage {
      tell event VoyageCreated to entity VesselContext.Vessel
    }

    on command UpdateVoyage {
      tell event VoyageUpdated to entity VesselContext.Vessel
    }

    on command RecordPortArrival {
      tell event PortArrivalRecorded to entity VesselContext.Vessel
    }

    on command RecordPortDeparture {
      tell event PortDepartureRecorded to entity VesselContext.Vessel
    }

    on command CompleteVoyage {
      tell event VoyageCompleted to entity VesselContext.Vessel
    }

    on command AddCrewMember {
      tell event CrewMemberAdded to entity VesselContext.Vessel
    }

    on command RemoveCrewMember {
      tell event CrewMemberRemoved to entity VesselContext.Vessel
    }

    on command AddCertificate {
      tell event CertificateAdded to entity VesselContext.Vessel
    }

    on command RenewCertificate {
      tell event CertificateRenewed to entity VesselContext.Vessel
    }

    on command SubmitBunkerReport {
      tell event BunkerReportSubmitted to entity VesselContext.Vessel
    }

    on command RecordMaintenance {
      tell event MaintenanceRecorded to entity VesselContext.Vessel
    }

    on command SetVesselStatus {
      tell event VesselStatusChanged to entity VesselContext.Vessel
    }
  } with {
    briefly "Processes vessel commands"
    described by {
      | Handles vessel lifecycle from registration
      | through voyages and maintenance.
    }
  }

} with {
  briefly "Vessel aggregate"
  described by {
    | The Vessel entity manages ship fleet
    | and voyage operations.
  }
}
