// Customs Brokerage - Entry Entity

entity Entry is {

  // Commands
  command CreateEntry is {
    entryId is EntryId with {
      briefly "Entry"
      described by "New entry identifier."
    }
    entryType is EntryType with {
      briefly "Type"
      described by "Entry type."
    }
    importer is ImporterInfo with {
      briefly "Importer"
      described by "Importer details."
    }
    shipment is ShipmentInfo with {
      briefly "Shipment"
      described by "Shipment details."
    }
    lineItems is many LineItem with {
      briefly "Lines"
      described by "Entry line items."
    }
  } with {
    briefly "Create entry"
    described by "Creates a new customs entry."
  }

  command UpdateEntry is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    lineItems is many LineItem with {
      briefly "Lines"
      described by "Updated line items."
    }
  } with {
    briefly "Update entry"
    described by "Updates entry line items."
  }

  command AttachDocument is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    document is EntryDocument with {
      briefly "Document"
      described by "Document to attach."
    }
  } with {
    briefly "Attach document"
    described by "Attaches supporting document."
  }

  command SubmitEntry is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    submittedBy is BrokerId with {
      briefly "Broker"
      described by "Submitting broker."
    }
  } with {
    briefly "Submit entry"
    described by "Submits entry to CBP."
  }

  command RecordCBPResponse is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    response is CBPResponse with {
      briefly "Response"
      described by "CBP response."
    }
  } with {
    briefly "Record CBP response"
    described by "Records customs response."
  }

  command RequestRelease is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    releaseType is String(1, 50) with {
      briefly "Type"
      described by "Release type."
    }
  } with {
    briefly "Request release"
    described by "Requests cargo release."
  }

  command RecordRelease is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    releaseDate is Date with {
      briefly "Released"
      described by "Release date."
    }
    releaseNumber is String(1, 50) with {
      briefly "Number"
      described by "Release number."
    }
  } with {
    briefly "Record release"
    described by "Records cargo release."
  }

  command ProcessPayment is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    payment is DutyPayment with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Process payment"
    described by "Processes duty payment."
  }

  command RespondToInquiry is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    inquiryResponse is String(1, 2000) with {
      briefly "Response"
      described by "Response to customs inquiry."
    }
    supportingDocs is many optional EntryDocument with {
      briefly "Docs"
      described by "Supporting documents."
    }
  } with {
    briefly "Respond to inquiry"
    described by "Responds to CBP information request."
  }

  command RecordLiquidation is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    liquidation is LiquidationRecord with {
      briefly "Liquidation"
      described by "Liquidation details."
    }
  } with {
    briefly "Record liquidation"
    described by "Records entry liquidation."
  }

  command FileProtest is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    protestReason is String(1, 2000) with {
      briefly "Reason"
      described by "Protest reason."
    }
    requestedRelief is String(1, 1000) with {
      briefly "Relief"
      described by "Requested relief."
    }
  } with {
    briefly "File protest"
    described by "Files protest against liquidation."
  }

  command CancelEntry is {
    entryId is EntryId with {
      briefly "Entry"
      described by "Entry identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel entry"
    described by "Cancels customs entry."
  }

  // Events
  event EntryCreated is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    entryType is EntryType with { briefly "Type" described by "Entry type." }
    importer is ImporterInfo with { briefly "Importer" described by "Importer info." }
    shipment is ShipmentInfo with { briefly "Shipment" described by "Shipment info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Entry created"
    described by "Emitted when entry is created."
  }

  event EntryUpdated is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    lineItems is many LineItem with { briefly "Lines" described by "Updated lines." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Entry updated"
    described by "Emitted when entry is updated."
  }

  event DocumentAttached is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    document is EntryDocument with { briefly "Document" described by "Attached document." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Document attached"
    described by "Emitted when document is attached."
  }

  event EntrySubmitted is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    submittedBy is BrokerId with { briefly "Broker" described by "Submitting broker." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Entry submitted"
    described by "Emitted when entry is submitted."
  }

  event CBPResponseReceived is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    response is CBPResponse with { briefly "Response" described by "CBP response." }
  } with {
    briefly "CBP response received"
    described by "Emitted when CBP responds."
  }

  event ReleaseRequested is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    releaseType is String(1, 50) with { briefly "Type" described by "Release type." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Release requested"
    described by "Emitted when release is requested."
  }

  event CargoReleased is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    releaseDate is Date with { briefly "Released" described by "Release date." }
    releaseNumber is String(1, 50) with { briefly "Number" described by "Release number." }
  } with {
    briefly "Cargo released"
    described by "Emitted when cargo is released."
  }

  event PaymentProcessed is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    payment is DutyPayment with { briefly "Payment" described by "Payment details." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event InquiryResponseSubmitted is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    respondedAt is TimeStamp with { briefly "Responded" described by "Response time." }
  } with {
    briefly "Inquiry response submitted"
    described by "Emitted when inquiry is answered."
  }

  event EntryLiquidated is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    liquidation is LiquidationRecord with { briefly "Liquidation" described by "Liquidation record." }
  } with {
    briefly "Entry liquidated"
    described by "Emitted when entry is liquidated."
  }

  event ProtestFiled is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    protestReason is String(1, 2000) with { briefly "Reason" described by "Protest reason." }
    filedAt is TimeStamp with { briefly "Filed" described by "Filing time." }
  } with {
    briefly "Protest filed"
    described by "Emitted when protest is filed."
  }

  event EntryCancelled is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Entry cancelled"
    described by "Emitted when entry is cancelled."
  }

  // State Records
  record ActiveStateData is {
    entryId is EntryId with { briefly "Entry" described by "Entry ID." }
    entryType is EntryType with { briefly "Type" described by "Entry type." }
    assignedEntryNumber is optional String(1, 50) with { briefly "Number" described by "Entry number." }
    importer is ImporterInfo with { briefly "Importer" described by "Importer info." }
    shipment is ShipmentInfo with { briefly "Shipment" described by "Shipment info." }
    lineItems is many LineItem with { briefly "Lines" described by "Entry lines." }
    documents is many optional EntryDocument with { briefly "Documents" described by "Supporting docs." }
    status is EntryStatus with { briefly "Status" described by "Entry status." }
    cbpResponse is optional CBPResponse with { briefly "Response" described by "CBP response." }
    currentPayment is optional DutyPayment with { briefly "Payment" described by "Payment info." }
    currentLiquidation is optional LiquidationRecord with { briefly "Liquidation" described by "Liquidation record." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active entry."
  }

  // States
  state ActiveState of Entry.ActiveStateData with {
    briefly "Entry active"
    described by "Entry is being processed."
  }

  // Handler
  handler EntryHandler is {
    on command CreateEntry {
      morph entity EntryContext.Entry to state EntryContext.Entry.ActiveState with command CreateEntry
      tell event EntryCreated to entity EntryContext.Entry
    }

    on command UpdateEntry {
      tell event EntryUpdated to entity EntryContext.Entry
    }

    on command AttachDocument {
      tell event DocumentAttached to entity EntryContext.Entry
    }

    on command EntryContext.Entry.SubmitEntry {
      tell event EntrySubmitted to entity EntryContext.Entry
    }

    on command RecordCBPResponse {
      tell event CBPResponseReceived to entity EntryContext.Entry
    }

    on command RequestRelease {
      tell event ReleaseRequested to entity EntryContext.Entry
    }

    on command RecordRelease {
      tell event CargoReleased to entity EntryContext.Entry
    }

    on command ProcessPayment {
      tell event PaymentProcessed to entity EntryContext.Entry
    }

    on command RespondToInquiry {
      tell event InquiryResponseSubmitted to entity EntryContext.Entry
    }

    on command RecordLiquidation {
      tell event EntryLiquidated to entity EntryContext.Entry
    }

    on command FileProtest {
      tell event ProtestFiled to entity EntryContext.Entry
    }

    on command CancelEntry {
      tell event EntryCancelled to entity EntryContext.Entry
    }
  } with {
    briefly "Processes entry commands"
    described by {
      | Handles customs entry lifecycle from creation
      | through liquidation.
    }
  }

} with {
  briefly "Entry aggregate"
  described by {
    | The Entry entity manages customs entries
    | and clearance processing.
  }
}
