// Customs Brokerage - Entry Context
context EntryContext is {
  include "types.riddl"
  include "Entry.riddl"
  // Repository for entry persistence
  repository EntryRepository is {
    schema EntryData is relational
      of entries as type Entry
        index on field Entry.entryId
        index on field Entry.entryNumber
        index on field Entry.importer.importerId
        index on field Entry.shipment.masterBillNumber
        index on field Entry.status

    handler EntryPersistence is {
      on command Entry.CreateEntry is {
        prompt "Store new entry"
      }
      on command Entry.UpdateEntry is {
        prompt "Update entry lines"
      }
      on command Entry.AttachDocument is {
        prompt "Store document reference"
      }
      on command EntryContext.Entry.SubmitEntry is {
        prompt "Update to submitted"
      }
      on command Entry.RecordCBPResponse is {
        prompt "Store CBP response"
      }
      on command Entry.RequestRelease is {
        prompt "Store release request"
      }
      on command Entry.RecordRelease is {
        prompt "Update to released"
      }
      on command Entry.ProcessPayment is {
        prompt "Store payment record"
      }
      on command Entry.RespondToInquiry is {
        prompt "Store inquiry response"
      }
      on command Entry.RecordLiquidation is {
        prompt "Store liquidation"
      }
      on command Entry.FileProtest is {
        prompt "Store protest"
      }
      on command Entry.CancelEntry is {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists entry commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Entry data persistence"
    described as {
      | The EntryRepository provides persistent storage
      | for customs entries.
    }
  }
  // Projector for brokerage analytics
  projector BrokerageAnalytics is {
    record BrokerageStats is  {
      date: Date with {
        briefly "Date"
        described as {
          |Statistics date.
        }
      }
      entriesSubmitted: Natural with {
        briefly "Submitted"
        described as {
          |Entries submitted.
        }
      }
      entriesReleased: Natural with {
        briefly "Released"
        described as {
          |Entries released.
        }
      }
      entriesOnHold: Natural with {
        briefly "On hold"
        described as {
          |Entries on hold.
        }
      }
      totalDutyCollected: Decimal(14,2) with {
        briefly "Duty"
        described as {
          |Total duty.
        }
      }
      averageClearanceTime: Duration with {
        briefly "Clearance time"
        described as {
          |Avg clearance time.
        }
      }
      complianceRate: Decimal(5,2) with {
        briefly "Compliance"
        described as {
          |Compliance rate.
        }
      }
    } with {
      briefly "Brokerage statistics"
      described as {
        |Daily brokerage metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Entry.EntrySubmitted is {
        prompt "Update submission metrics"
      }
      on event Entry.CargoReleased is {
        prompt "Update release metrics"
      }
      on event Entry.PaymentProcessed is {
        prompt "Update duty metrics"
      }
      on event Entry.CBPResponseReceived is {
        prompt "Update hold metrics"
      }
    } with {
      briefly "Maintains brokerage analytics"
      described as {
        |Projects events into analytics views.
      }
    }
  } with {
    briefly "Brokerage analytics projections"
    described as {
      |Maintains customs clearance analytics.
    }
  }
} with {
  briefly "Bounded context for customs entries"
  described as {
    | The EntryContext is the bounded context for
    | customs entry processing.
  }
}
