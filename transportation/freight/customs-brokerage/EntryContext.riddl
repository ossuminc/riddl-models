// Customs Brokerage - Entry Context

context EntryContext is {

  include "types.riddl"
  include "Entry.riddl"

  // Repository for entry persistence
  repository EntryRepository is {
    schema EntryData is relational
      of entries as Entry
      index on field Entry.entryId
      index on field Entry.entryNumber
      index on field Entry.importer.importerId
      index on field Entry.shipment.masterBillNumber
      index on field Entry.status

    handler EntryPersistence is {
      on command Entry.CreateEntry {
        prompt "Store new entry"
      }
      on command Entry.UpdateEntry {
        prompt "Update entry lines"
      }
      on command Entry.AttachDocument {
        prompt "Store document reference"
      }
      on command EntryContext.Entry.SubmitEntry {
        prompt "Update to submitted"
      }
      on command Entry.RecordCBPResponse {
        prompt "Store CBP response"
      }
      on command Entry.RequestRelease {
        prompt "Store release request"
      }
      on command Entry.RecordRelease {
        prompt "Update to released"
      }
      on command Entry.ProcessPayment {
        prompt "Store payment record"
      }
      on command Entry.RespondToInquiry {
        prompt "Store inquiry response"
      }
      on command Entry.RecordLiquidation {
        prompt "Store liquidation"
      }
      on command Entry.FileProtest {
        prompt "Store protest"
      }
      on command Entry.CancelEntry {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists entry commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Entry data persistence"
    described by {
      | The EntryRepository provides persistent storage
      | for customs entries.
    }
  }

  // Projector for brokerage analytics
  projector BrokerageAnalytics is {
    updates repository EntryRepository

    record BrokerageStats is {
      date is Date with { briefly "Date" described by "Statistics date." }
      entriesSubmitted is Natural with { briefly "Submitted" described by "Entries submitted." }
      entriesReleased is Natural with { briefly "Released" described by "Entries released." }
      entriesOnHold is Natural with { briefly "On hold" described by "Entries on hold." }
      totalDutyCollected is Decimal(14, 2) with { briefly "Duty" described by "Total duty." }
      averageClearanceTime is Duration with { briefly "Clearance time" described by "Avg clearance time." }
      complianceRate is Decimal(5, 2) with { briefly "Compliance" described by "Compliance rate." }
    } with {
      briefly "Brokerage statistics"
      described by "Daily brokerage metrics."
    }

    handler AnalyticsHandler is {
      on event Entry.EntrySubmitted {
        prompt "Update submission metrics"
      }
      on event Entry.CargoReleased {
        prompt "Update release metrics"
      }
      on event Entry.PaymentProcessed {
        prompt "Update duty metrics"
      }
      on event Entry.CBPResponseReceived {
        prompt "Update hold metrics"
      }
    } with {
      briefly "Maintains brokerage analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Brokerage analytics projections"
    described by "Maintains customs clearance analytics."
  }

} with {
  briefly "Bounded context for customs entries"
  described by {
    | The EntryContext is the bounded context for
    | customs entry processing.
  }
}
