// Intermodal - Move Context

context MoveContext is {

  include "types.riddl"
  include "Move.riddl"

  // Repository for move persistence
  repository MoveRepository is {
    schema MoveData is relational
      of moves as Move
      index on field Move.moveId
      index on field Move.container.containerNumber
      index on field Move.railLeg.originTerminal.terminalId
      index on field Move.railLeg.destinationTerminal.terminalId
      index on field Move.status

    handler MovePersistence is {
      on command Move.CreateMove {
        prompt "Store new move"
      }
      on command Move.ScheduleOriginDray {
        prompt "Update origin dray schedule"
      }
      on command Move.RecordTerminalIngate {
        prompt "Store terminal ingate"
      }
      on command Move.AssignToTrain {
        prompt "Store train assignment"
      }
      on command Move.RecordTrainDeparture {
        prompt "Update to in transit"
      }
      on command Move.RecordTrainArrival {
        prompt "Update to at destination"
      }
      on command Move.RecordTerminalOutgate {
        prompt "Store terminal outgate"
      }
      on command Move.ScheduleDestinationDray {
        prompt "Update destination dray schedule"
      }
      on command Move.RecordDelivery {
        prompt "Update to delivered"
      }
      on command Move.RecordException {
        prompt "Store exception"
      }
      on command Move.CancelMove {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists move commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Move data persistence"
    described by {
      | The MoveRepository provides persistent storage
      | for intermodal moves.
    }
  }

  // Projector for intermodal analytics
  projector IntermodalAnalytics is {
    updates repository MoveRepository

    record IntermodalStats is {
      date is Date with { briefly "Date" described by "Statistics date." }
      movesBooked is Natural with { briefly "Booked" described by "Moves booked." }
      movesDelivered is Natural with { briefly "Delivered" described by "Moves delivered." }
      averageTransitDays is Decimal(5, 2) with { briefly "Transit" described by "Avg transit days." }
      onTimePerformance is Decimal(5, 2) with { briefly "OTP" described by "On-time percentage." }
      containerVolume is Natural with { briefly "Containers" described by "Container count." }
      exceptionRate is Decimal(5, 2) with { briefly "Exceptions" described by "Exception rate." }
    } with {
      briefly "Intermodal statistics"
      described by "Daily intermodal metrics."
    }

    handler AnalyticsHandler is {
      on event Move.MoveCreated {
        prompt "Update booking metrics"
      }
      on event Move.DeliveryRecorded {
        prompt "Update delivery metrics"
      }
      on event Move.ExceptionRecorded {
        prompt "Update exception metrics"
      }
    } with {
      briefly "Maintains intermodal analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Intermodal analytics projections"
    described by "Maintains intermodal operational analytics."
  }

} with {
  briefly "Bounded context for intermodal moves"
  described by {
    | The MoveContext is the bounded context for
    | intermodal transportation management.
  }
}
