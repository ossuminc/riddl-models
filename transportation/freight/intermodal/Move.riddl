// Intermodal - Move Entity
entity Move is {
  // Commands
  command CreateMove is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |New move identifier.
      }
    }
    container: ContainerInfo with {
      briefly "Container"
      described as {
        |Container details.
      }
    }
    originDray: DrayLeg with {
      briefly "Origin dray"
      described as {
        |Origin dray segment.
      }
    }
    railLeg: RailLeg with {
      briefly "Rail"
      described as {
        |Rail segment.
      }
    }
    destinationDray: DrayLeg with {
      briefly "Dest dray"
      described as {
        |Destination dray segment.
      }
    }
    shipperReference: String(1,100) with {
      briefly "Reference"
      described as {
        |Shipper reference number.
      }
    }
  } with {
    briefly "Create move"
    described as {
      |Creates a new intermodal move.
    }
  }
  command ScheduleOriginDray is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    carrier: String(1,200) with {
      briefly "Carrier"
      described as {
        |Dray carrier.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Pickup date.
      }
    }
    appointmentTime: TimeStamp? with {
      briefly "Appointment"
      described as {
        |Appointment time.
      }
    }
  } with {
    briefly "Schedule origin dray"
    described as {
      |Schedules origin pickup.
    }
  }
  command RecordTerminalIngate is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    terminal: TerminalInfo with {
      briefly "Terminal"
      described as {
        |Ingate terminal.
      }
    }
    ingatedAt: TimeStamp with {
      briefly "Ingated"
      described as {
        |Ingate time.
      }
    }
    sealIntact: Boolean with {
      briefly "Seal"
      described as {
        |Seal intact.
      }
    }
  } with {
    briefly "Record terminal ingate"
    described as {
      |Records container arrival at terminal.
    }
  }
  command AssignToTrain is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    trainId: TrainId with {
      briefly "Train"
      described as {
        |Train ID.
      }
    }
    trainSymbol: String(1,20) with {
      briefly "Symbol"
      described as {
        |Train symbol.
      }
    }
    carNumber: String(1,20) with {
      briefly "Car"
      described as {
        |Rail car number.
      }
    }
    carPosition: Natural with {
      briefly "Position"
      described as {
        |Car position.
      }
    }
  } with {
    briefly "Assign to train"
    described as {
      |Assigns container to train.
    }
  }
  command RecordTrainDeparture is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
  } with {
    briefly "Record train departure"
    described as {
      |Records train departure.
    }
  }
  command RecordTrainArrival is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
    terminal: TerminalInfo with {
      briefly "Terminal"
      described as {
        |Destination terminal.
      }
    }
  } with {
    briefly "Record train arrival"
    described as {
      |Records train arrival.
    }
  }
  command RecordTerminalOutgate is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    outgatedAt: TimeStamp with {
      briefly "Outgated"
      described as {
        |Outgate time.
      }
    }
    driverName: String(1,200) with {
      briefly "Driver"
      described as {
        |Pickup driver.
      }
    }
    tractorNumber: String(1,20) with {
      briefly "Tractor"
      described as {
        |Tractor number.
      }
    }
  } with {
    briefly "Record terminal outgate"
    described as {
      |Records container departure from terminal.
    }
  }
  command ScheduleDestinationDray is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    carrier: String(1,200) with {
      briefly "Carrier"
      described as {
        |Dray carrier.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Delivery date.
      }
    }
    appointmentTime: TimeStamp? with {
      briefly "Appointment"
      described as {
        |Delivery appointment.
      }
    }
  } with {
    briefly "Schedule destination dray"
    described as {
      |Schedules final delivery.
    }
  }
  command RecordDelivery is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    receivedBy: String(1,200) with {
      briefly "Received by"
      described as {
        |Person receiving.
      }
    }
    proofOfDelivery: String(1,500)? with {
      briefly "POD"
      described as {
        |Proof of delivery.
      }
    }
  } with {
    briefly "Record delivery"
    described as {
      |Records final delivery.
    }
  }
  command RecordException is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    exceptionType: String(1,100) with {
      briefly "Type"
      described as {
        |Exception type.
      }
    }
    description: String(1,500) with {
      briefly "Description"
      described as {
        |Exception details.
      }
    }
    occurredAt: TimeStamp with {
      briefly "Occurred"
      described as {
        |When occurred.
      }
    }
  } with {
    briefly "Record exception"
    described as {
      |Records move exception.
    }
  }
  command CancelMove is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel move"
    described as {
      |Cancels the intermodal move.
    }
  }
  // Events
  event MoveCreated is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    container: ContainerInfo with {
      briefly "Container"
      described as {
        |Container details.
      }
    }
    railLeg: RailLeg with {
      briefly "Rail"
      described as {
        |Rail segment.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Move created"
    described as {
      |Emitted when move is created.
    }
  }
  event OriginDrayScheduled is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    carrier: String(1,200) with {
      briefly "Carrier"
      described as {
        |Dray carrier.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Pickup date.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Schedule time.
      }
    }
  } with {
    briefly "Origin dray scheduled"
    described as {
      |Emitted when origin dray is scheduled.
    }
  }
  event TerminalIngateRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    terminal: TerminalInfo with {
      briefly "Terminal"
      described as {
        |Terminal.
      }
    }
    ingatedAt: TimeStamp with {
      briefly "Ingated"
      described as {
        |Ingate time.
      }
    }
  } with {
    briefly "Terminal ingate recorded"
    described as {
      |Emitted when container enters terminal.
    }
  }
  event AssignedToTrain is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    trainId: TrainId with {
      briefly "Train"
      described as {
        |Train ID.
      }
    }
    trainSymbol: String(1,20) with {
      briefly "Symbol"
      described as {
        |Train symbol.
      }
    }
    carNumber: String(1,20) with {
      briefly "Car"
      described as {
        |Car number.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Assigned to train"
    described as {
      |Emitted when assigned to train.
    }
  }
  event TrainDepartureRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
  } with {
    briefly "Train departure recorded"
    described as {
      |Emitted when train departs.
    }
  }
  event TrainArrivalRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
    terminal: TerminalInfo with {
      briefly "Terminal"
      described as {
        |Arrival terminal.
      }
    }
  } with {
    briefly "Train arrival recorded"
    described as {
      |Emitted when train arrives.
    }
  }
  event TerminalOutgateRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    outgatedAt: TimeStamp with {
      briefly "Outgated"
      described as {
        |Outgate time.
      }
    }
    driverName: String(1,200) with {
      briefly "Driver"
      described as {
        |Driver name.
      }
    }
  } with {
    briefly "Terminal outgate recorded"
    described as {
      |Emitted when container leaves terminal.
    }
  }
  event DestinationDrayScheduled is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    carrier: String(1,200) with {
      briefly "Carrier"
      described as {
        |Dray carrier.
      }
    }
    scheduledDate: Date with {
      briefly "Date"
      described as {
        |Delivery date.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Schedule time.
      }
    }
  } with {
    briefly "Destination dray scheduled"
    described as {
      |Emitted when delivery is scheduled.
    }
  }
  event DeliveryRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    receivedBy: String(1,200) with {
      briefly "Received by"
      described as {
        |Receiver.
      }
    }
  } with {
    briefly "Delivery recorded"
    described as {
      |Emitted when delivered.
    }
  }
  event ExceptionRecorded is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    exceptionType: String(1,100) with {
      briefly "Type"
      described as {
        |Exception type.
      }
    }
    description: String(1,500) with {
      briefly "Description"
      described as {
        |Details.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Exception recorded"
    described as {
      |Emitted when exception occurs.
    }
  }
  event MoveCancelled is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Move cancelled"
    described as {
      |Emitted when move is cancelled.
    }
  }
  // State Records
  record ActiveStateData is  {
    moveId: MoveId with {
      briefly "Move"
      described as {
        |Move ID.
      }
    }
    container: ContainerInfo with {
      briefly "Container"
      described as {
        |Container details.
      }
    }
    originDray: DrayLeg with {
      briefly "Origin dray"
      described as {
        |Origin dray.
      }
    }
    railLeg: RailLeg with {
      briefly "Rail"
      described as {
        |Rail segment.
      }
    }
    destinationDray: DrayLeg with {
      briefly "Dest dray"
      described as {
        |Destination dray.
      }
    }
    status: MoveStatus with {
      briefly "Status"
      described as {
        |Move status.
      }
    }
    terminalEvents: TerminalEvent* with {
      briefly "Events"
      described as {
        |Terminal events.
      }
    }
    exceptions: String(1,500)* with {
      briefly "Exceptions"
      described as {
        |Move exceptions.
      }
    }
    currentCharges: MoveCharges? with {
      briefly "Charges"
      described as {
        |Move charges.
      }
    }
    shipperReference: String(1,100) with {
      briefly "Reference"
      described as {
        |Shipper reference.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active move.
    }
  }
  // States
  state ActiveState of type Move.ActiveStateData
  // Handler
  handler MoveHandler is {
    on command CreateMove is {
      morph entity MoveContext.Move to state MoveContext.Move.ActiveState with command CreateMove
      tell event MoveCreated to entity MoveContext.Move
    }
    on command ScheduleOriginDray is {
      tell event OriginDrayScheduled to entity MoveContext.Move
    }
    on command RecordTerminalIngate is {
      tell event TerminalIngateRecorded to entity MoveContext.Move
    }
    on command AssignToTrain is {
      tell event AssignedToTrain to entity MoveContext.Move
    }
    on command RecordTrainDeparture is {
      tell event TrainDepartureRecorded to entity MoveContext.Move
    }
    on command RecordTrainArrival is {
      tell event TrainArrivalRecorded to entity MoveContext.Move
    }
    on command RecordTerminalOutgate is {
      tell event TerminalOutgateRecorded to entity MoveContext.Move
    }
    on command ScheduleDestinationDray is {
      tell event DestinationDrayScheduled to entity MoveContext.Move
    }
    on command RecordDelivery is {
      tell event DeliveryRecorded to entity MoveContext.Move
    }
    on command RecordException is {
      tell event ExceptionRecorded to entity MoveContext.Move
    }
    on command CancelMove is {
      tell event MoveCancelled to entity MoveContext.Move
    }
  } with {
    briefly "Processes move commands"
    described as {
      | Handles intermodal move lifecycle from creation
      | through delivery.
    }
  }
} with {
  briefly "Move aggregate"
  described as {
    | The Move entity manages intermodal moves
    | across rail and truck modes.
  }
}
