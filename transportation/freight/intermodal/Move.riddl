// Intermodal - Move Entity

entity Move is {

  // Commands
  command CreateMove is {
    moveId is MoveId with {
      briefly "Move"
      described by "New move identifier."
    }
    container is ContainerInfo with {
      briefly "Container"
      described by "Container details."
    }
    originDray is DrayLeg with {
      briefly "Origin dray"
      described by "Origin dray segment."
    }
    railLeg is RailLeg with {
      briefly "Rail"
      described by "Rail segment."
    }
    destinationDray is DrayLeg with {
      briefly "Dest dray"
      described by "Destination dray segment."
    }
    shipperReference is String(1, 100) with {
      briefly "Reference"
      described by "Shipper reference number."
    }
  } with {
    briefly "Create move"
    described by "Creates a new intermodal move."
  }

  command ScheduleOriginDray is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    carrier is String(1, 200) with {
      briefly "Carrier"
      described by "Dray carrier."
    }
    scheduledDate is Date with {
      briefly "Date"
      described by "Pickup date."
    }
    appointmentTime is optional TimeStamp with {
      briefly "Appointment"
      described by "Appointment time."
    }
  } with {
    briefly "Schedule origin dray"
    described by "Schedules origin pickup."
  }

  command RecordTerminalIngate is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    terminal is TerminalInfo with {
      briefly "Terminal"
      described by "Ingate terminal."
    }
    ingatedAt is TimeStamp with {
      briefly "Ingated"
      described by "Ingate time."
    }
    sealIntact is Boolean with {
      briefly "Seal"
      described by "Seal intact."
    }
  } with {
    briefly "Record terminal ingate"
    described by "Records container arrival at terminal."
  }

  command AssignToTrain is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    trainId is TrainId with {
      briefly "Train"
      described by "Train ID."
    }
    trainSymbol is String(1, 20) with {
      briefly "Symbol"
      described by "Train symbol."
    }
    carNumber is String(1, 20) with {
      briefly "Car"
      described by "Rail car number."
    }
    carPosition is Natural with {
      briefly "Position"
      described by "Car position."
    }
  } with {
    briefly "Assign to train"
    described by "Assigns container to train."
  }

  command RecordTrainDeparture is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    departedAt is TimeStamp with {
      briefly "Departed"
      described by "Departure time."
    }
  } with {
    briefly "Record train departure"
    described by "Records train departure."
  }

  command RecordTrainArrival is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
    terminal is TerminalInfo with {
      briefly "Terminal"
      described by "Destination terminal."
    }
  } with {
    briefly "Record train arrival"
    described by "Records train arrival."
  }

  command RecordTerminalOutgate is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    outgatedAt is TimeStamp with {
      briefly "Outgated"
      described by "Outgate time."
    }
    driverName is String(1, 200) with {
      briefly "Driver"
      described by "Pickup driver."
    }
    tractorNumber is String(1, 20) with {
      briefly "Tractor"
      described by "Tractor number."
    }
  } with {
    briefly "Record terminal outgate"
    described by "Records container departure from terminal."
  }

  command ScheduleDestinationDray is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    carrier is String(1, 200) with {
      briefly "Carrier"
      described by "Dray carrier."
    }
    scheduledDate is Date with {
      briefly "Date"
      described by "Delivery date."
    }
    appointmentTime is optional TimeStamp with {
      briefly "Appointment"
      described by "Delivery appointment."
    }
  } with {
    briefly "Schedule destination dray"
    described by "Schedules final delivery."
  }

  command RecordDelivery is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery time."
    }
    receivedBy is String(1, 200) with {
      briefly "Received by"
      described by "Person receiving."
    }
    proofOfDelivery is optional String(1, 500) with {
      briefly "POD"
      described by "Proof of delivery."
    }
  } with {
    briefly "Record delivery"
    described by "Records final delivery."
  }

  command RecordException is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    exceptionType is String(1, 100) with {
      briefly "Type"
      described by "Exception type."
    }
    description is String(1, 500) with {
      briefly "Description"
      described by "Exception details."
    }
    occurredAt is TimeStamp with {
      briefly "Occurred"
      described by "When occurred."
    }
  } with {
    briefly "Record exception"
    described by "Records move exception."
  }

  command CancelMove is {
    moveId is MoveId with {
      briefly "Move"
      described by "Move identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel move"
    described by "Cancels the intermodal move."
  }

  // Events
  event MoveCreated is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    container is ContainerInfo with { briefly "Container" described by "Container details." }
    railLeg is RailLeg with { briefly "Rail" described by "Rail segment." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Move created"
    described by "Emitted when move is created."
  }

  event OriginDrayScheduled is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    carrier is String(1, 200) with { briefly "Carrier" described by "Dray carrier." }
    scheduledDate is Date with { briefly "Date" described by "Pickup date." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Origin dray scheduled"
    described by "Emitted when origin dray is scheduled."
  }

  event TerminalIngateRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    terminal is TerminalInfo with { briefly "Terminal" described by "Terminal." }
    ingatedAt is TimeStamp with { briefly "Ingated" described by "Ingate time." }
  } with {
    briefly "Terminal ingate recorded"
    described by "Emitted when container enters terminal."
  }

  event AssignedToTrain is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    trainId is TrainId with { briefly "Train" described by "Train ID." }
    trainSymbol is String(1, 20) with { briefly "Symbol" described by "Train symbol." }
    carNumber is String(1, 20) with { briefly "Car" described by "Car number." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Assigned to train"
    described by "Emitted when assigned to train."
  }

  event TrainDepartureRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    departedAt is TimeStamp with { briefly "Departed" described by "Departure time." }
  } with {
    briefly "Train departure recorded"
    described by "Emitted when train departs."
  }

  event TrainArrivalRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
    terminal is TerminalInfo with { briefly "Terminal" described by "Arrival terminal." }
  } with {
    briefly "Train arrival recorded"
    described by "Emitted when train arrives."
  }

  event TerminalOutgateRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    outgatedAt is TimeStamp with { briefly "Outgated" described by "Outgate time." }
    driverName is String(1, 200) with { briefly "Driver" described by "Driver name." }
  } with {
    briefly "Terminal outgate recorded"
    described by "Emitted when container leaves terminal."
  }

  event DestinationDrayScheduled is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    carrier is String(1, 200) with { briefly "Carrier" described by "Dray carrier." }
    scheduledDate is Date with { briefly "Date" described by "Delivery date." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Destination dray scheduled"
    described by "Emitted when delivery is scheduled."
  }

  event DeliveryRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    receivedBy is String(1, 200) with { briefly "Received by" described by "Receiver." }
  } with {
    briefly "Delivery recorded"
    described by "Emitted when delivered."
  }

  event ExceptionRecorded is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    exceptionType is String(1, 100) with { briefly "Type" described by "Exception type." }
    description is String(1, 500) with { briefly "Description" described by "Details." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Exception recorded"
    described by "Emitted when exception occurs."
  }

  event MoveCancelled is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Move cancelled"
    described by "Emitted when move is cancelled."
  }

  // State Records
  record ActiveStateData is {
    moveId is MoveId with { briefly "Move" described by "Move ID." }
    container is ContainerInfo with { briefly "Container" described by "Container details." }
    originDray is DrayLeg with { briefly "Origin dray" described by "Origin dray." }
    railLeg is RailLeg with { briefly "Rail" described by "Rail segment." }
    destinationDray is DrayLeg with { briefly "Dest dray" described by "Destination dray." }
    status is MoveStatus with { briefly "Status" described by "Move status." }
    terminalEvents is many optional TerminalEvent with { briefly "Events" described by "Terminal events." }
    exceptions is many optional String(1, 500) with { briefly "Exceptions" described by "Move exceptions." }
    currentCharges is optional MoveCharges with { briefly "Charges" described by "Move charges." }
    shipperReference is String(1, 100) with { briefly "Reference" described by "Shipper reference." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active move."
  }

  // States
  state ActiveState of Move.ActiveStateData with {
    briefly "Move active"
    described by "Move is active."
  }

  // Handler
  handler MoveHandler is {
    on command CreateMove {
      morph entity MoveContext.Move to state MoveContext.Move.ActiveState with command CreateMove
      tell event MoveCreated to entity MoveContext.Move
    }

    on command ScheduleOriginDray {
      tell event OriginDrayScheduled to entity MoveContext.Move
    }

    on command RecordTerminalIngate {
      tell event TerminalIngateRecorded to entity MoveContext.Move
    }

    on command AssignToTrain {
      tell event AssignedToTrain to entity MoveContext.Move
    }

    on command RecordTrainDeparture {
      tell event TrainDepartureRecorded to entity MoveContext.Move
    }

    on command RecordTrainArrival {
      tell event TrainArrivalRecorded to entity MoveContext.Move
    }

    on command RecordTerminalOutgate {
      tell event TerminalOutgateRecorded to entity MoveContext.Move
    }

    on command ScheduleDestinationDray {
      tell event DestinationDrayScheduled to entity MoveContext.Move
    }

    on command RecordDelivery {
      tell event DeliveryRecorded to entity MoveContext.Move
    }

    on command RecordException {
      tell event ExceptionRecorded to entity MoveContext.Move
    }

    on command CancelMove {
      tell event MoveCancelled to entity MoveContext.Move
    }
  } with {
    briefly "Processes move commands"
    described by {
      | Handles intermodal move lifecycle from creation
      | through delivery.
    }
  }

} with {
  briefly "Move aggregate"
  described by {
    | The Move entity manages intermodal moves
    | across rail and truck modes.
  }
}
