// Freight Forwarding - Shipment Entity

entity Shipment is {

  // Commands
  command CreateShipment is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "New shipment identifier."
    }
    serviceType is ServiceType with {
      briefly "Service"
      described by "Service type."
    }
    incoterms is Incoterms with {
      briefly "Incoterms"
      described by "Trade terms."
    }
    parties is many ShipmentParty with {
      briefly "Parties"
      described by "Shipment parties."
    }
    cargo is many CargoDetails with {
      briefly "Cargo"
      described by "Cargo details."
    }
    route is RouteInfo with {
      briefly "Route"
      described by "Shipping route."
    }
  } with {
    briefly "Create shipment"
    described by "Creates a new shipment."
  }

  command AttachQuote is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    quote is RateQuote with {
      briefly "Quote"
      described by "Rate quote."
    }
  } with {
    briefly "Attach quote"
    described by "Attaches rate quote to shipment."
  }

  command BookCarrier is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    booking is CarrierBooking with {
      briefly "Booking"
      described by "Carrier booking."
    }
  } with {
    briefly "Book carrier"
    described by "Books with carrier."
  }

  command AssignContainers is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    containers is many ContainerInfo with {
      briefly "Containers"
      described by "Container details."
    }
  } with {
    briefly "Assign containers"
    described by "Assigns containers to shipment."
  }

  command UpdateContainerSeal is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    containerNumber is String(11, 11) with {
      briefly "Container"
      described by "Container number."
    }
    sealNumber is String(1, 50) with {
      briefly "Seal"
      described by "New seal number."
    }
  } with {
    briefly "Update container seal"
    described by "Updates container seal."
  }

  command SchedulePickup is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    pickupDate is Date with {
      briefly "Date"
      described by "Pickup date."
    }
    pickupAddress is Address with {
      briefly "Address"
      described by "Pickup address."
    }
    truckerName is String(1, 200) with {
      briefly "Trucker"
      described by "Trucking company."
    }
  } with {
    briefly "Schedule pickup"
    described by "Schedules cargo pickup."
  }

  command RecordMilestone is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    milestone is MilestoneEvent with {
      briefly "Milestone"
      described by "Tracking milestone."
    }
  } with {
    briefly "Record milestone"
    described by "Records tracking milestone."
  }

  command IssueDocument is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    document is DocumentInfo with {
      briefly "Document"
      described by "Document details."
    }
  } with {
    briefly "Issue document"
    described by "Issues shipping document."
  }

  command UpdateStatus is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    newStatus is ShipmentStatus with {
      briefly "Status"
      described by "New status."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Status change reason."
    }
  } with {
    briefly "Update status"
    described by "Updates shipment status."
  }

  command RecordDelivery is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery time."
    }
    receivedBy is String(1, 200) with {
      briefly "Received by"
      described by "Person who received."
    }
    proofOfDelivery is optional String(1, 500) with {
      briefly "POD"
      described by "Proof of delivery reference."
    }
  } with {
    briefly "Record delivery"
    described by "Records shipment delivery."
  }

  command CancelShipment is {
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel shipment"
    described by "Cancels the shipment."
  }

  // Events
  event ShipmentCreated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    serviceType is ServiceType with { briefly "Service" described by "Service type." }
    parties is many ShipmentParty with { briefly "Parties" described by "Shipment parties." }
    route is RouteInfo with { briefly "Route" described by "Shipping route." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Shipment created"
    described by "Emitted when shipment is created."
  }

  event QuoteAttached is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    quote is RateQuote with { briefly "Quote" described by "Rate quote." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Quote attached"
    described by "Emitted when quote is attached."
  }

  event CarrierBooked is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    booking is CarrierBooking with { briefly "Booking" described by "Carrier booking." }
    bookedAt is TimeStamp with { briefly "Booked" described by "Booking time." }
  } with {
    briefly "Carrier booked"
    described by "Emitted when carrier is booked."
  }

  event ContainersAssigned is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    containers is many ContainerInfo with { briefly "Containers" described by "Containers." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Containers assigned"
    described by "Emitted when containers are assigned."
  }

  event ContainerSealUpdated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    containerNumber is String(11, 11) with { briefly "Container" described by "Container." }
    sealNumber is String(1, 50) with { briefly "Seal" described by "New seal." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Container seal updated"
    described by "Emitted when seal is updated."
  }

  event PickupScheduled is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    pickupDate is Date with { briefly "Date" described by "Pickup date." }
    pickupAddress is Address with { briefly "Address" described by "Pickup address." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Pickup scheduled"
    described by "Emitted when pickup is scheduled."
  }

  event MilestoneRecorded is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    milestone is MilestoneEvent with { briefly "Milestone" described by "Milestone." }
  } with {
    briefly "Milestone recorded"
    described by "Emitted when milestone is recorded."
  }

  event DocumentIssued is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    document is DocumentInfo with { briefly "Document" described by "Document." }
    issuedAt is TimeStamp with { briefly "Issued" described by "Issue time." }
  } with {
    briefly "Document issued"
    described by "Emitted when document is issued."
  }

  event ShipmentStatusUpdated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    previousStatus is ShipmentStatus with { briefly "Previous" described by "Previous status." }
    newStatus is ShipmentStatus with { briefly "New" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Status updated"
    described by "Emitted when status changes."
  }

  event ShipmentDelivered is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    receivedBy is String(1, 200) with { briefly "Received by" described by "Receiver." }
  } with {
    briefly "Shipment delivered"
    described by "Emitted when shipment is delivered."
  }

  event ShipmentCancelled is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Shipment cancelled"
    described by "Emitted when shipment is cancelled."
  }

  // State Records
  record ActiveStateData is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    serviceType is ServiceType with { briefly "Service" described by "Service type." }
    incoterms is Incoterms with { briefly "Incoterms" described by "Trade terms." }
    parties is many ShipmentParty with { briefly "Parties" described by "Shipment parties." }
    cargo is many CargoDetails with { briefly "Cargo" described by "Cargo details." }
    route is RouteInfo with { briefly "Route" described by "Shipping route." }
    quote is optional RateQuote with { briefly "Quote" described by "Rate quote." }
    booking is optional CarrierBooking with { briefly "Booking" described by "Carrier booking." }
    containers is many optional ContainerInfo with { briefly "Containers" described by "Containers." }
    milestones is many optional MilestoneEvent with { briefly "Milestones" described by "Tracking milestones." }
    documents is many optional DocumentInfo with { briefly "Documents" described by "Shipping documents." }
    status is ShipmentStatus with { briefly "Status" described by "Shipment status." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active shipment."
  }

  // States
  state ActiveState of Shipment.ActiveStateData with {
    briefly "Shipment active"
    described by "Shipment is active."
  }

  // Handler
  handler ShipmentHandler is {
    on command CreateShipment {
      morph entity ShipmentContext.Shipment to state ShipmentContext.Shipment.ActiveState with command CreateShipment
      tell event ShipmentCreated to entity ShipmentContext.Shipment
    }

    on command AttachQuote {
      tell event QuoteAttached to entity ShipmentContext.Shipment
    }

    on command BookCarrier {
      tell event CarrierBooked to entity ShipmentContext.Shipment
    }

    on command AssignContainers {
      tell event ContainersAssigned to entity ShipmentContext.Shipment
    }

    on command UpdateContainerSeal {
      tell event ContainerSealUpdated to entity ShipmentContext.Shipment
    }

    on command SchedulePickup {
      tell event PickupScheduled to entity ShipmentContext.Shipment
    }

    on command RecordMilestone {
      tell event MilestoneRecorded to entity ShipmentContext.Shipment
    }

    on command IssueDocument {
      tell event DocumentIssued to entity ShipmentContext.Shipment
    }

    on command UpdateStatus {
      tell event ShipmentStatusUpdated to entity ShipmentContext.Shipment
    }

    on command RecordDelivery {
      tell event ShipmentDelivered to entity ShipmentContext.Shipment
    }

    on command CancelShipment {
      tell event ShipmentCancelled to entity ShipmentContext.Shipment
    }
  } with {
    briefly "Processes shipment commands"
    described by {
      | Handles shipment lifecycle from creation
      | through delivery.
    }
  }

} with {
  briefly "Shipment aggregate"
  described by {
    | The Shipment entity manages international
    | freight shipments.
  }
}
