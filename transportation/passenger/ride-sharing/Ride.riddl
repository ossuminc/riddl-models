// Ride Sharing - Ride Entity
entity Ride is {
  // Commands
  command RequestRide is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |New ride identifier.
      }
    }
    rider: RiderInfo with {
      briefly "Rider"
      described as {
        |Rider information.
      }
    }
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
    dropoff: LocationInfo with {
      briefly "Dropoff"
      described as {
        |Dropoff location.
      }
    }
    vehicleType: VehicleType with {
      briefly "Vehicle type"
      described as {
        |Requested vehicle type.
      }
    }
    fareEstimate: FareEstimate with {
      briefly "Estimate"
      described as {
        |Fare estimate.
      }
    }
  } with {
    briefly "Request ride"
    described as {
      |Requests a new ride.
    }
  }
  command AssignDriver is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    etaMinutes: Natural with {
      briefly "ETA"
      described as {
        |Estimated arrival time.
      }
    }
  } with {
    briefly "Assign driver"
    described as {
      |Assigns driver to ride.
    }
  }
  command DriverEnRoute is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    driverLocation: GeoLocation with {
      briefly "Location"
      described as {
        |Driver current location.
      }
    }
  } with {
    briefly "Driver en route"
    described as {
      |Driver heading to pickup.
    }
  }
  command DriverArrived is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Driver arrived"
    described as {
      |Driver arrived at pickup.
    }
  }
  command StartTrip is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
  } with {
    briefly "Start trip"
    described as {
      |Starts the trip.
    }
  }
  command UpdateLocation is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    location: GeoLocation with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
  } with {
    briefly "Update location"
    described as {
      |Updates vehicle location.
    }
  }
  command CompleteTrip is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    tripDetails: TripDetails with {
      briefly "Trip"
      described as {
        |Trip details.
      }
    }
    finalFare: FareEstimate with {
      briefly "Fare"
      described as {
        |Final fare.
      }
    }
  } with {
    briefly "Complete trip"
    described as {
      |Completes the trip.
    }
  }
  command ProcessPayment is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
  } with {
    briefly "Process payment"
    described as {
      |Processes ride payment.
    }
  }
  command RateRide is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    riderRating: RatingInfo? with {
      briefly "Rider rating"
      described as {
        |Driver's rating of rider.
      }
    }
    driverRating: RatingInfo? with {
      briefly "Driver rating"
      described as {
        |Rider's rating of driver.
      }
    }
  } with {
    briefly "Rate ride"
    described as {
      |Rates the ride.
    }
  }
  command CancelRide is  {
    rideId: RideId with {
      briefly "Ride ID"
      described as {
        |Ride identifier.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation details.
      }
    }
  } with {
    briefly "Cancel ride"
    described as {
      |Cancels the ride.
    }
  }
  // Events
  event RideRequested is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    rider: RiderInfo with {
      briefly "Rider"
      described as {
        |Rider info.
      }
    }
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
    dropoff: LocationInfo with {
      briefly "Dropoff"
      described as {
        |Dropoff location.
      }
    }
    vehicleType: VehicleType with {
      briefly "Type"
      described as {
        |Vehicle type.
      }
    }
    fareEstimate: FareEstimate with {
      briefly "Estimate"
      described as {
        |Fare estimate.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Ride requested"
    described as {
      |Emitted when ride is requested.
    }
  }
  event DriverAssigned is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    etaMinutes: Natural with {
      briefly "ETA"
      described as {
        |Arrival ETA.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Driver assigned"
    described as {
      |Emitted when driver is assigned.
    }
  }
  event DriverIsEnRoute is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driverLocation: GeoLocation with {
      briefly "Location"
      described as {
        |Driver location.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Driver en route"
    described as {
      |Emitted when driver starts heading to pickup.
    }
  }
  event DriverHasArrived is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    arrivedAt: TimeStamp with {
      briefly "Arrived"
      described as {
        |Arrival time.
      }
    }
  } with {
    briefly "Driver arrived"
    described as {
      |Emitted when driver arrives.
    }
  }
  event TripStarted is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Trip start time.
      }
    }
  } with {
    briefly "Trip started"
    described as {
      |Emitted when trip begins.
    }
  }
  event LocationUpdated is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    location: GeoLocation with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Location updated"
    described as {
      |Emitted when location updates.
    }
  }
  event TripCompleted is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    tripDetails: TripDetails with {
      briefly "Trip"
      described as {
        |Trip details.
      }
    }
    finalFare: FareEstimate with {
      briefly "Fare"
      described as {
        |Final fare.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Trip completed"
    described as {
      |Emitted when trip ends.
    }
  }
  event PaymentProcessed is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Payment processed"
    described as {
      |Emitted when payment is processed.
    }
  }
  event RideRated is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    riderRating: RatingInfo? with {
      briefly "Rider rating"
      described as {
        |Rider's rating.
      }
    }
    driverRating: RatingInfo? with {
      briefly "Driver rating"
      described as {
        |Driver's rating.
      }
    }
    ratedAt: TimeStamp with {
      briefly "Rated"
      described as {
        |Rating time.
      }
    }
  } with {
    briefly "Ride rated"
    described as {
      |Emitted when ride is rated.
    }
  }
  event RideCancelled is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    cancellation: CancellationInfo with {
      briefly "Cancellation"
      described as {
        |Cancellation info.
      }
    }
  } with {
    briefly "Ride cancelled"
    described as {
      |Emitted when ride is cancelled.
    }
  }
  // State Records
  record ActiveStateData is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    rider: RiderInfo with {
      briefly "Rider"
      described as {
        |Rider info.
      }
    }
    assignedDriver: DriverInfo? with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
    dropoff: LocationInfo with {
      briefly "Dropoff"
      described as {
        |Dropoff location.
      }
    }
    currentLocation: GeoLocation? with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    vehicleType: VehicleType with {
      briefly "Type"
      described as {
        |Vehicle type.
      }
    }
    fareEstimate: FareEstimate with {
      briefly "Estimate"
      described as {
        |Fare estimate.
      }
    }
    status: RideStatus with {
      briefly "Status"
      described as {
        |Ride status.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active ride.
    }
  }
  record CompletedStateData is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    rider: RiderInfo with {
      briefly "Rider"
      described as {
        |Rider info.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Driver info.
      }
    }
    tripDetails: TripDetails with {
      briefly "Trip"
      described as {
        |Trip details.
      }
    }
    finalFare: FareEstimate with {
      briefly "Fare"
      described as {
        |Final fare.
      }
    }
    payment: PaymentInfo with {
      briefly "Payment"
      described as {
        |Payment info.
      }
    }
    riderRating: RatingInfo? with {
      briefly "Rider rating"
      described as {
        |Rider's rating.
      }
    }
    driverRating: RatingInfo? with {
      briefly "Driver rating"
      described as {
        |Driver's rating.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |State for completed ride.
    }
  }
  // States
  state ActiveState of type Ride.ActiveStateData
  state CompletedState of type Ride.CompletedStateData
  // Handler
  handler RideHandler is {
    on command RequestRide is {
      morph entity RideContext.Ride to state RideContext.Ride.ActiveState with command RequestRide
      tell event RideRequested to entity RideContext.Ride
    }
    on command AssignDriver is {
      tell event DriverAssigned to entity RideContext.Ride
    }
    on command DriverEnRoute is {
      tell event DriverIsEnRoute to entity RideContext.Ride
    }
    on command DriverArrived is {
      tell event DriverHasArrived to entity RideContext.Ride
    }
    on command StartTrip is {
      tell event TripStarted to entity RideContext.Ride
    }
    on command UpdateLocation is {
      tell event LocationUpdated to entity RideContext.Ride
    }
    on command CompleteTrip is {
      tell event TripCompleted to entity RideContext.Ride
    }
    on command ProcessPayment is {
      morph entity RideContext.Ride to state RideContext.Ride.CompletedState with command ProcessPayment
      tell event PaymentProcessed to entity RideContext.Ride
    }
    on command RateRide is {
      tell event RideRated to entity RideContext.Ride
    }
    on command CancelRide is {
      tell event RideCancelled to entity RideContext.Ride
    }
  } with {
    briefly "Processes ride commands"
    described as {
      | Handles ride lifecycle from request
      | through matching, trip, and payment.
    }
  }
} with {
  briefly "Ride aggregate"
  described as {
    | The Ride entity manages ride requests
    | and trip lifecycle for ride-sharing.
  }
}
