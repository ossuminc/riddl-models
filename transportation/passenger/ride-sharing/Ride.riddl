// Ride Sharing - Ride Entity

entity Ride is {

  // Commands
  command RequestRide is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "New ride identifier."
    }
    rider is RiderInfo with {
      briefly "Rider"
      described by "Rider information."
    }
    pickup is LocationInfo with {
      briefly "Pickup"
      described by "Pickup location."
    }
    dropoff is LocationInfo with {
      briefly "Dropoff"
      described by "Dropoff location."
    }
    vehicleType is VehicleType with {
      briefly "Vehicle type"
      described by "Requested vehicle type."
    }
    fareEstimate is FareEstimate with {
      briefly "Estimate"
      described by "Fare estimate."
    }
  } with {
    briefly "Request ride"
    described by "Requests a new ride."
  }

  command AssignDriver is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    driver is DriverInfo with {
      briefly "Driver"
      described by "Assigned driver."
    }
    etaMinutes is Natural with {
      briefly "ETA"
      described by "Estimated arrival time."
    }
  } with {
    briefly "Assign driver"
    described by "Assigns driver to ride."
  }

  command DriverEnRoute is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    driverLocation is GeoLocation with {
      briefly "Location"
      described by "Driver current location."
    }
  } with {
    briefly "Driver en route"
    described by "Driver heading to pickup."
  }

  command DriverArrived is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    arrivedAt is TimeStamp with {
      briefly "Arrived"
      described by "Arrival time."
    }
  } with {
    briefly "Driver arrived"
    described by "Driver arrived at pickup."
  }

  command StartTrip is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
  } with {
    briefly "Start trip"
    described by "Starts the trip."
  }

  command UpdateLocation is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    location is GeoLocation with {
      briefly "Location"
      described by "Current location."
    }
  } with {
    briefly "Update location"
    described by "Updates vehicle location."
  }

  command CompleteTrip is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    tripDetails is TripDetails with {
      briefly "Trip"
      described by "Trip details."
    }
    finalFare is FareEstimate with {
      briefly "Fare"
      described by "Final fare."
    }
  } with {
    briefly "Complete trip"
    described by "Completes the trip."
  }

  command ProcessPayment is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    payment is PaymentInfo with {
      briefly "Payment"
      described by "Payment details."
    }
  } with {
    briefly "Process payment"
    described by "Processes ride payment."
  }

  command RateRide is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    riderRating is optional RatingInfo with {
      briefly "Rider rating"
      described by "Driver's rating of rider."
    }
    driverRating is optional RatingInfo with {
      briefly "Driver rating"
      described by "Rider's rating of driver."
    }
  } with {
    briefly "Rate ride"
    described by "Rates the ride."
  }

  command CancelRide is {
    rideId is RideId with {
      briefly "Ride ID"
      described by "Ride identifier."
    }
    cancellation is CancellationInfo with {
      briefly "Cancellation"
      described by "Cancellation details."
    }
  } with {
    briefly "Cancel ride"
    described by "Cancels the ride."
  }

  // Events
  event RideRequested is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    rider is RiderInfo with { briefly "Rider" described by "Rider info." }
    pickup is LocationInfo with { briefly "Pickup" described by "Pickup location." }
    dropoff is LocationInfo with { briefly "Dropoff" described by "Dropoff location." }
    vehicleType is VehicleType with { briefly "Type" described by "Vehicle type." }
    fareEstimate is FareEstimate with { briefly "Estimate" described by "Fare estimate." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Ride requested"
    described by "Emitted when ride is requested."
  }

  event DriverAssigned is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driver is DriverInfo with { briefly "Driver" described by "Assigned driver." }
    etaMinutes is Natural with { briefly "ETA" described by "Arrival ETA." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Driver assigned"
    described by "Emitted when driver is assigned."
  }

  event DriverIsEnRoute is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driverLocation is GeoLocation with { briefly "Location" described by "Driver location." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Driver en route"
    described by "Emitted when driver starts heading to pickup."
  }

  event DriverHasArrived is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    arrivedAt is TimeStamp with { briefly "Arrived" described by "Arrival time." }
  } with {
    briefly "Driver arrived"
    described by "Emitted when driver arrives."
  }

  event TripStarted is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Trip start time." }
  } with {
    briefly "Trip started"
    described by "Emitted when trip begins."
  }

  event LocationUpdated is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    location is GeoLocation with { briefly "Location" described by "Current location." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Location updated"
    described by "Emitted when location updates."
  }

  event TripCompleted is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    tripDetails is TripDetails with { briefly "Trip" described by "Trip details." }
    finalFare is FareEstimate with { briefly "Fare" described by "Final fare." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Trip completed"
    described by "Emitted when trip ends."
  }

  event PaymentProcessed is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment details." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Payment processed"
    described by "Emitted when payment is processed."
  }

  event RideRated is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    riderRating is optional RatingInfo with { briefly "Rider rating" described by "Rider's rating." }
    driverRating is optional RatingInfo with { briefly "Driver rating" described by "Driver's rating." }
    ratedAt is TimeStamp with { briefly "Rated" described by "Rating time." }
  } with {
    briefly "Ride rated"
    described by "Emitted when ride is rated."
  }

  event RideCancelled is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    cancellation is CancellationInfo with { briefly "Cancellation" described by "Cancellation info." }
  } with {
    briefly "Ride cancelled"
    described by "Emitted when ride is cancelled."
  }

  // State Records
  record ActiveStateData is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    rider is RiderInfo with { briefly "Rider" described by "Rider info." }
    driver is optional DriverInfo with { briefly "Driver" described by "Assigned driver." }
    pickup is LocationInfo with { briefly "Pickup" described by "Pickup location." }
    dropoff is LocationInfo with { briefly "Dropoff" described by "Dropoff location." }
    currentLocation is optional GeoLocation with { briefly "Location" described by "Current location." }
    vehicleType is VehicleType with { briefly "Type" described by "Vehicle type." }
    fareEstimate is FareEstimate with { briefly "Estimate" described by "Fare estimate." }
    status is RideStatus with { briefly "Status" described by "Ride status." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Active state"
    described by "State for active ride."
  }

  record CompletedStateData is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    rider is RiderInfo with { briefly "Rider" described by "Rider info." }
    driver is DriverInfo with { briefly "Driver" described by "Driver info." }
    tripDetails is TripDetails with { briefly "Trip" described by "Trip details." }
    finalFare is FareEstimate with { briefly "Fare" described by "Final fare." }
    payment is PaymentInfo with { briefly "Payment" described by "Payment info." }
    riderRating is optional RatingInfo with { briefly "Rider rating" described by "Rider's rating." }
    driverRating is optional RatingInfo with { briefly "Driver rating" described by "Driver's rating." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed state"
    described by "State for completed ride."
  }

  // States
  state ActiveState of Ride.ActiveStateData with {
    briefly "Ride active"
    described by "Ride is in progress."
  }

  state CompletedState of Ride.CompletedStateData with {
    briefly "Ride completed"
    described by "Ride has been completed."
  }

  // Handler
  handler RideHandler is {
    on command RequestRide {
      morph entity RideContext.Ride to state RideContext.Ride.ActiveState with command RequestRide
      tell event RideRequested to entity RideContext.Ride
    }

    on command AssignDriver {
      tell event DriverAssigned to entity RideContext.Ride
    }

    on command DriverEnRoute {
      tell event DriverIsEnRoute to entity RideContext.Ride
    }

    on command DriverArrived {
      tell event DriverHasArrived to entity RideContext.Ride
    }

    on command StartTrip {
      tell event TripStarted to entity RideContext.Ride
    }

    on command UpdateLocation {
      tell event LocationUpdated to entity RideContext.Ride
    }

    on command CompleteTrip {
      tell event TripCompleted to entity RideContext.Ride
    }

    on command ProcessPayment {
      morph entity RideContext.Ride to state RideContext.Ride.CompletedState with command ProcessPayment
      tell event PaymentProcessed to entity RideContext.Ride
    }

    on command RateRide {
      tell event RideRated to entity RideContext.Ride
    }

    on command CancelRide {
      tell event RideCancelled to entity RideContext.Ride
    }
  } with {
    briefly "Processes ride commands"
    described by {
      | Handles ride lifecycle from request
      | through matching, trip, and payment.
    }
  }

} with {
  briefly "Ride aggregate"
  described by {
    | The Ride entity manages ride requests
    | and trip lifecycle for ride-sharing.
  }
}
