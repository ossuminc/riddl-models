// Ride Sharing - External Contexts
// Driver Matching Service
context DriverMatchingService is {
  command FindAvailableDrivers is  {
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
    vehicleType: VehicleType with {
      briefly "Type"
      described as {
        |Requested vehicle type.
      }
    }
    radiusMiles: Decimal(5,2) with {
      briefly "Radius"
      described as {
        |Search radius.
      }
    }
  } with {
    briefly "Find drivers"
    described as {
      |Finds available drivers nearby.
    }
  }
  result AvailableDrivers is  {
    drivers: DriverInfo+ with {
      briefly "Drivers"
      described as {
        |Available drivers.
      }
    }
    driverEtaMinutes: Natural+ with {
      briefly "ETAs"
      described as {
        |Arrival estimates.
      }
    }
  } with {
    briefly "Available drivers"
    described as {
      |List of nearby available drivers.
    }
  }
  command DispatchDriver is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver to dispatch.
      }
    }
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
  } with {
    briefly "Dispatch driver"
    described as {
      |Dispatches driver to pickup.
    }
  }
  event DriverDispatched is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    dispatchedAt: TimeStamp with {
      briefly "Dispatched"
      described as {
        |Dispatch time.
      }
    }
  } with {
    briefly "Driver dispatched"
    described as {
      |Emitted when driver is dispatched.
    }
  }
} with {
  option external()
  briefly "External driver matching"
  described as {
    |External driver matching and dispatch service.
  }
}
// Fare Calculation Service
context FareCalculationService is {
  command CalculateFare is  {
    pickup: LocationInfo with {
      briefly "Pickup"
      described as {
        |Pickup location.
      }
    }
    dropoff: LocationInfo with {
      briefly "Dropoff"
      described as {
        |Dropoff location.
      }
    }
    vehicleType: VehicleType with {
      briefly "Type"
      described as {
        |Vehicle type.
      }
    }
    promoCode: String(1,50)? with {
      briefly "Promo"
      described as {
        |Promo code.
      }
    }
  } with {
    briefly "Calculate fare"
    described as {
      |Calculates fare estimate.
    }
  }
  result FareCalculation is  {
    fareEstimate: FareEstimate with {
      briefly "Estimate"
      described as {
        |Fare estimate.
      }
    }
    distanceMiles: Decimal(10,2) with {
      briefly "Distance"
      described as {
        |Estimated distance.
      }
    }
    durationMinutes: Natural with {
      briefly "Duration"
      described as {
        |Estimated duration.
      }
    }
  } with {
    briefly "Fare calculation"
    described as {
      |Calculated fare estimate.
    }
  }
  command CalculateFinalFare is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    tripDetails: TripDetails with {
      briefly "Trip"
      described as {
        |Actual trip details.
      }
    }
    vehicleType: VehicleType with {
      briefly "Type"
      described as {
        |Vehicle type.
      }
    }
  } with {
    briefly "Calculate final fare"
    described as {
      |Calculates final fare for completed trip.
    }
  }
  result FinalFare is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    fare: FareEstimate with {
      briefly "Fare"
      described as {
        |Final fare.
      }
    }
  } with {
    briefly "Final fare"
    described as {
      |Final calculated fare.
    }
  }
} with {
  option external()
  briefly "External fare calculation"
  described as {
    |External pricing and fare service.
  }
}
// Routing Service
context RoutingService is {
  query GetRoute is  {
    origin: GeoLocation with {
      briefly "Origin"
      described as {
        |Start point.
      }
    }
    destination: GeoLocation with {
      briefly "Destination"
      described as {
        |End point.
      }
    }
    avoidTolls: Boolean with {
      briefly "Avoid tolls"
      described as {
        |Whether to avoid tolls.
      }
    }
  } with {
    briefly "Get route"
    described as {
      |Retrieves optimal route.
    }
  }
  result RouteResult is  {
    waypoints: GeoLocation+ with {
      briefly "Waypoints"
      described as {
        |Route waypoints.
      }
    }
    distanceMiles: Decimal(10,2) with {
      briefly "Distance"
      described as {
        |Route distance.
      }
    }
    durationMinutes: Natural with {
      briefly "Duration"
      described as {
        |Route duration.
      }
    }
    tollAmount: Decimal(10,2) with {
      briefly "Tolls"
      described as {
        |Toll charges.
      }
    }
  } with {
    briefly "Route result"
    described as {
      |Calculated route.
    }
  }
  query GetETA is  {
    origin: GeoLocation with {
      briefly "Origin"
      described as {
        |Current location.
      }
    }
    destination: GeoLocation with {
      briefly "Destination"
      described as {
        |Target location.
      }
    }
  } with {
    briefly "Get ETA"
    described as {
      |Retrieves estimated arrival time.
    }
  }
  result ETAResult is  {
    etaMinutes: Natural with {
      briefly "ETA"
      described as {
        |Minutes to arrival.
      }
    }
    distanceMiles: Decimal(10,2) with {
      briefly "Distance"
      described as {
        |Distance remaining.
      }
    }
  } with {
    briefly "ETA result"
    described as {
      |Arrival time estimate.
    }
  }
} with {
  option external()
  briefly "External routing"
  described as {
    |External maps and routing service.
  }
}
// Payment Service
context PaymentService is {
  command ChargeRide is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    riderId: RiderId with {
      briefly "Rider"
      described as {
        |Rider ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Charge amount.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Currency code.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
  } with {
    briefly "Charge ride"
    described as {
      |Charges rider for ride.
    }
  }
  event RideCharged is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Charged amount.
      }
    }
    chargedAt: TimeStamp with {
      briefly "Charged"
      described as {
        |Charge time.
      }
    }
  } with {
    briefly "Ride charged"
    described as {
      |Emitted when payment succeeds.
    }
  }
  event ChargeFailed is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    errorCode: String(1,50) with {
      briefly "Error"
      described as {
        |Error code.
      }
    }
    errorMessage: String(1,500) with {
      briefly "Message"
      described as {
        |Error message.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Charge failed"
    described as {
      |Emitted when payment fails.
    }
  }
  command PayDriver is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    currency: String(3,3) with {
      briefly "Currency"
      described as {
        |Currency code.
      }
    }
  } with {
    briefly "Pay driver"
    described as {
      |Pays driver for ride.
    }
  }
  event DriverPaid is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    amount: Decimal(10,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    paidAt: TimeStamp with {
      briefly "Paid"
      described as {
        |Payment time.
      }
    }
  } with {
    briefly "Driver paid"
    described as {
      |Emitted when driver is paid.
    }
  }
} with {
  option external()
  briefly "External payment"
  described as {
    |External payment processing service.
  }
}
// Notification Service
context NotificationService is {
  command SendRiderNotification is  {
    riderId: RiderId with {
      briefly "Rider"
      described as {
        |Rider ID.
      }
    }
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    message: String(1,500) with {
      briefly "Message"
      described as {
        |Notification message.
      }
    }
  } with {
    briefly "Send rider notification"
    described as {
      |Sends notification to rider.
    }
  }
  event RiderNotified is  {
    riderId: RiderId with {
      briefly "Rider"
      described as {
        |Rider ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Rider notified"
    described as {
      |Emitted when rider is notified.
    }
  }
  command SendDriverNotification is  {
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    message: String(1,500) with {
      briefly "Message"
      described as {
        |Notification message.
      }
    }
  } with {
    briefly "Send driver notification"
    described as {
      |Sends notification to driver.
    }
  }
  event DriverNotified is  {
    driverId: DriverId with {
      briefly "Driver"
      described as {
        |Driver ID.
      }
    }
    notificationType: String(1,50) with {
      briefly "Type"
      described as {
        |Notification type.
      }
    }
    sentAt: TimeStamp with {
      briefly "Sent"
      described as {
        |Send time.
      }
    }
  } with {
    briefly "Driver notified"
    described as {
      |Emitted when driver is notified.
    }
  }
} with {
  option external()
  briefly "External notifications"
  described as {
    |External push notification service.
  }
}
// Safety Service
context SafetyService is {
  command ShareTripStatus is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    riderId: RiderId with {
      briefly "Rider"
      described as {
        |Rider ID.
      }
    }
    contacts: String(7,20)+ with {
      briefly "Contacts"
      described as {
        |Emergency contact phones.
      }
    }
  } with {
    briefly "Share trip"
    described as {
      |Shares trip status with contacts.
    }
  }
  event TripShared is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    sharedWith: String(7,20)+ with {
      briefly "Contacts"
      described as {
        |Shared with contacts.
      }
    }
    sharedAt: TimeStamp with {
      briefly "Shared"
      described as {
        |Share time.
      }
    }
  } with {
    briefly "Trip shared"
    described as {
      |Emitted when trip is shared.
    }
  }
  command ReportSafetyIncident is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    reportedBy: String(1,50) with {
      briefly "Reported by"
      described as {
        |Reporter (rider/driver).
      }
    }
    incidentType: String(1,100) with {
      briefly "Type"
      described as {
        |Incident type.
      }
    }
    description: String(1,2000) with {
      briefly "Description"
      described as {
        |Incident description.
      }
    }
  } with {
    briefly "Report incident"
    described as {
      |Reports safety incident.
    }
  }
  event IncidentReported is  {
    rideId: RideId with {
      briefly "Ride"
      described as {
        |Ride ID.
      }
    }
    incidentId: UUID with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    reportedAt: TimeStamp with {
      briefly "Reported"
      described as {
        |Report time.
      }
    }
  } with {
    briefly "Incident reported"
    described as {
      |Emitted when incident is reported.
    }
  }
} with {
  option external()
  briefly "External safety"
  described as {
    |External safety and emergency service.
  }
}
