// Ride Sharing - External Contexts

// Driver Matching Service
context DriverMatchingService is {

  command FindAvailableDrivers is {
    pickup is LocationInfo with { briefly "Pickup" described by "Pickup location." }
    vehicleType is VehicleType with { briefly "Type" described by "Requested vehicle type." }
    radiusMiles is Decimal(5, 2) with { briefly "Radius" described by "Search radius." }
  } with {
    briefly "Find drivers"
    described by "Finds available drivers nearby."
  }

  result AvailableDrivers is {
    drivers is many DriverInfo with { briefly "Drivers" described by "Available drivers." }
    driverEtaMinutes is many Natural with { briefly "ETAs" described by "Arrival estimates." }
  } with {
    briefly "Available drivers"
    described by "List of nearby available drivers."
  }

  command DispatchDriver is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driverId is DriverId with { briefly "Driver" described by "Driver to dispatch." }
    pickup is LocationInfo with { briefly "Pickup" described by "Pickup location." }
  } with {
    briefly "Dispatch driver"
    described by "Dispatches driver to pickup."
  }

  event DriverDispatched is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    dispatchedAt is TimeStamp with { briefly "Dispatched" described by "Dispatch time." }
  } with {
    briefly "Driver dispatched"
    described by "Emitted when driver is dispatched."
  }

} with {
  option is external
  briefly "External driver matching"
  described by "External driver matching and dispatch service."
}

// Fare Calculation Service
context FareCalculationService is {

  command CalculateFare is {
    pickup is LocationInfo with { briefly "Pickup" described by "Pickup location." }
    dropoff is LocationInfo with { briefly "Dropoff" described by "Dropoff location." }
    vehicleType is VehicleType with { briefly "Type" described by "Vehicle type." }
    promoCode is optional String(1, 50) with { briefly "Promo" described by "Promo code." }
  } with {
    briefly "Calculate fare"
    described by "Calculates fare estimate."
  }

  result FareCalculation is {
    fareEstimate is FareEstimate with { briefly "Estimate" described by "Fare estimate." }
    distanceMiles is Decimal(10, 2) with { briefly "Distance" described by "Estimated distance." }
    durationMinutes is Natural with { briefly "Duration" described by "Estimated duration." }
  } with {
    briefly "Fare calculation"
    described by "Calculated fare estimate."
  }

  command CalculateFinalFare is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    tripDetails is TripDetails with { briefly "Trip" described by "Actual trip details." }
    vehicleType is VehicleType with { briefly "Type" described by "Vehicle type." }
  } with {
    briefly "Calculate final fare"
    described by "Calculates final fare for completed trip."
  }

  result FinalFare is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    fare is FareEstimate with { briefly "Fare" described by "Final fare." }
  } with {
    briefly "Final fare"
    described by "Final calculated fare."
  }

} with {
  option is external
  briefly "External fare calculation"
  described by "External pricing and fare service."
}

// Routing Service
context RoutingService is {

  query GetRoute is {
    origin is GeoLocation with { briefly "Origin" described by "Start point." }
    destination is GeoLocation with { briefly "Destination" described by "End point." }
    avoidTolls is Boolean with { briefly "Avoid tolls" described by "Whether to avoid tolls." }
  } with {
    briefly "Get route"
    described by "Retrieves optimal route."
  }

  result RouteResult is {
    waypoints is many GeoLocation with { briefly "Waypoints" described by "Route waypoints." }
    distanceMiles is Decimal(10, 2) with { briefly "Distance" described by "Route distance." }
    durationMinutes is Natural with { briefly "Duration" described by "Route duration." }
    tollAmount is Decimal(10, 2) with { briefly "Tolls" described by "Toll charges." }
  } with {
    briefly "Route result"
    described by "Calculated route."
  }

  query GetETA is {
    origin is GeoLocation with { briefly "Origin" described by "Current location." }
    destination is GeoLocation with { briefly "Destination" described by "Target location." }
  } with {
    briefly "Get ETA"
    described by "Retrieves estimated arrival time."
  }

  result ETAResult is {
    etaMinutes is Natural with { briefly "ETA" described by "Minutes to arrival." }
    distanceMiles is Decimal(10, 2) with { briefly "Distance" described by "Distance remaining." }
  } with {
    briefly "ETA result"
    described by "Arrival time estimate."
  }

} with {
  option is external
  briefly "External routing"
  described by "External maps and routing service."
}

// Payment Service
context PaymentService is {

  command ChargeRide is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    riderId is RiderId with { briefly "Rider" described by "Rider ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Charge amount." }
    currency is String(3, 3) with { briefly "Currency" described by "Currency code." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
  } with {
    briefly "Charge ride"
    described by "Charges rider for ride."
  }

  event RideCharged is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Charged amount." }
    chargedAt is TimeStamp with { briefly "Charged" described by "Charge time." }
  } with {
    briefly "Ride charged"
    described by "Emitted when payment succeeds."
  }

  event ChargeFailed is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    errorCode is String(1, 50) with { briefly "Error" described by "Error code." }
    errorMessage is String(1, 500) with { briefly "Message" described by "Error message." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Charge failed"
    described by "Emitted when payment fails."
  }

  command PayDriver is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    currency is String(3, 3) with { briefly "Currency" described by "Currency code." }
  } with {
    briefly "Pay driver"
    described by "Pays driver for ride."
  }

  event DriverPaid is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    amount is Decimal(10, 2) with { briefly "Amount" described by "Payment amount." }
    paidAt is TimeStamp with { briefly "Paid" described by "Payment time." }
  } with {
    briefly "Driver paid"
    described by "Emitted when driver is paid."
  }

} with {
  option is external
  briefly "External payment"
  described by "External payment processing service."
}

// Notification Service
context NotificationService is {

  command SendRiderNotification is {
    riderId is RiderId with { briefly "Rider" described by "Rider ID." }
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    notificationType is String(1, 50) with { briefly "Type" described by "Notification type." }
    message is String(1, 500) with { briefly "Message" described by "Notification message." }
  } with {
    briefly "Send rider notification"
    described by "Sends notification to rider."
  }

  event RiderNotified is {
    riderId is RiderId with { briefly "Rider" described by "Rider ID." }
    notificationType is String(1, 50) with { briefly "Type" described by "Notification type." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Rider notified"
    described by "Emitted when rider is notified."
  }

  command SendDriverNotification is {
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    notificationType is String(1, 50) with { briefly "Type" described by "Notification type." }
    message is String(1, 500) with { briefly "Message" described by "Notification message." }
  } with {
    briefly "Send driver notification"
    described by "Sends notification to driver."
  }

  event DriverNotified is {
    driverId is DriverId with { briefly "Driver" described by "Driver ID." }
    notificationType is String(1, 50) with { briefly "Type" described by "Notification type." }
    sentAt is TimeStamp with { briefly "Sent" described by "Send time." }
  } with {
    briefly "Driver notified"
    described by "Emitted when driver is notified."
  }

} with {
  option is external
  briefly "External notifications"
  described by "External push notification service."
}

// Safety Service
context SafetyService is {

  command ShareTripStatus is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    riderId is RiderId with { briefly "Rider" described by "Rider ID." }
    contacts is many String(7, 20) with { briefly "Contacts" described by "Emergency contact phones." }
  } with {
    briefly "Share trip"
    described by "Shares trip status with contacts."
  }

  event TripShared is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    sharedWith is many String(7, 20) with { briefly "Contacts" described by "Shared with contacts." }
    sharedAt is TimeStamp with { briefly "Shared" described by "Share time." }
  } with {
    briefly "Trip shared"
    described by "Emitted when trip is shared."
  }

  command ReportSafetyIncident is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    reportedBy is String(1, 50) with { briefly "Reported by" described by "Reporter (rider/driver)." }
    incidentType is String(1, 100) with { briefly "Type" described by "Incident type." }
    description is String(1, 2000) with { briefly "Description" described by "Incident description." }
  } with {
    briefly "Report incident"
    described by "Reports safety incident."
  }

  event IncidentReported is {
    rideId is RideId with { briefly "Ride" described by "Ride ID." }
    incidentId is UUID with { briefly "Incident" described by "Incident ID." }
    reportedAt is TimeStamp with { briefly "Reported" described by "Report time." }
  } with {
    briefly "Incident reported"
    described by "Emitted when incident is reported."
  }

} with {
  option is external
  briefly "External safety"
  described by "External safety and emergency service."
}
