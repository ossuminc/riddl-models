// Ride Sharing - Ride Context

context RideContext is {

  include "types.riddl"
  include "Ride.riddl"

  // Repository for ride persistence
  repository RideRepository is {
    schema RideData is relational
      of rides as Ride
      index on field Ride.rideId
      index on field Ride.rider.riderId
      index on field Ride.status

    handler RidePersistence is {
      on event Ride.RideRequested {
        prompt "Store new ride request"
      }
      on event Ride.DriverAssigned {
        prompt "Update driver assignment"
      }
      on event Ride.DriverIsEnRoute {
        prompt "Update driver location"
      }
      on event Ride.DriverHasArrived {
        prompt "Update arrival status"
      }
      on event Ride.TripStarted {
        prompt "Update to in progress"
      }
      on event Ride.LocationUpdated {
        prompt "Store location update"
      }
      on event Ride.TripCompleted {
        prompt "Store trip completion"
      }
      on event Ride.PaymentProcessed {
        prompt "Store payment"
      }
      on event Ride.RideRated {
        prompt "Store ratings"
      }
      on event Ride.RideCancelled {
        prompt "Update to cancelled"
      }
    } with {
      briefly "Persists ride events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Ride data persistence"
    described by {
      | The RideRepository provides persistent storage for
      | rides, trips, and ratings.
    }
  }

  // Projector for ride analytics
  projector RideAnalytics is {
    updates repository RideRepository

    record RideStats is {
      activeRides is Natural with { briefly "Active" described by "Active rides." }
      ridesCompletedToday is Natural with { briefly "Completed" described by "Rides completed today." }
      averageFare is Decimal(10, 2) with { briefly "Avg fare" described by "Average fare." }
      averageRating is Decimal(2, 1) with { briefly "Avg rating" described by "Average driver rating." }
      cancellationRate is Decimal(5, 4) with { briefly "Cancellation" described by "Cancellation rate." }
      averageWaitTime is Natural with { briefly "Wait time" described by "Average wait time (min)." }
    } with {
      briefly "Ride statistics"
      described by "Ride-sharing metrics."
    }

    handler AnalyticsHandler is {
      on event Ride.RideRequested {
        prompt "Update request counts"
      }
      on event Ride.TripCompleted {
        prompt "Update completion metrics"
      }
      on event Ride.RideRated {
        prompt "Update rating metrics"
      }
      on event Ride.RideCancelled {
        prompt "Update cancellation metrics"
      }
    } with {
      briefly "Maintains ride analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Ride analytics projections"
    described by "Maintains ride-sharing analytics data."
  }

} with {
  briefly "Bounded context for ride sharing"
  described by {
    | The RideContext is the bounded context for
    | on-demand ride management.
  }
}
