// Transit Operations - Vehicle Entity

entity Vehicle is {

  // Commands
  command RegisterVehicle is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "New vehicle identifier."
    }
    info is VehicleInfo with {
      briefly "Info"
      described by "Vehicle details."
    }
  } with {
    briefly "Register vehicle"
    described by "Registers a new transit vehicle."
  }

  command UpdateVehicleInfo is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    info is VehicleInfo with {
      briefly "Info"
      described by "Updated info."
    }
  } with {
    briefly "Update vehicle info"
    described by "Updates vehicle details."
  }

  command AssignOperator is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    operator is OperatorInfo with {
      briefly "Operator"
      described by "Operator assignment."
    }
  } with {
    briefly "Assign operator"
    described by "Assigns operator to vehicle."
  }

  command AssignTrip is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    trip is TripAssignment with {
      briefly "Trip"
      described by "Trip assignment."
    }
  } with {
    briefly "Assign trip"
    described by "Assigns trip to vehicle."
  }

  command UpdateLocation is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    position is VehiclePosition with {
      briefly "Position"
      described by "Current position."
    }
  } with {
    briefly "Update location"
    described by "Updates vehicle position."
  }

  command RecordStopEvent is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    stopEvent is StopEvent with {
      briefly "Stop event"
      described by "Stop arrival/departure."
    }
  } with {
    briefly "Record stop event"
    described by "Records stop arrival or departure."
  }

  command UpdatePassengerLoad is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    load is PassengerLoad with {
      briefly "Load"
      described by "Passenger count."
    }
  } with {
    briefly "Update passenger load"
    described by "Updates current passenger count."
  }

  command ReportIncident is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    incident is ServiceIncident with {
      briefly "Incident"
      described by "Incident details."
    }
  } with {
    briefly "Report incident"
    described by "Reports a service incident."
  }

  command CompleteTrip is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    tripId is TripId with {
      briefly "Trip"
      described by "Trip ID."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
  } with {
    briefly "Complete trip"
    described by "Completes a scheduled trip."
  }

  command SetVehicleStatus is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    status is VehicleStatus with {
      briefly "Status"
      described by "New status."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Status change reason."
    }
  } with {
    briefly "Set vehicle status"
    described by "Changes vehicle status."
  }

  command PullFromService is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Pull reason."
    }
  } with {
    briefly "Pull from service"
    described by "Removes vehicle from service."
  }

  command ReturnToService is {
    vehicleId is VehicleId with {
      briefly "Vehicle"
      described by "Vehicle identifier."
    }
    clearedAt is TimeStamp with {
      briefly "Cleared"
      described by "Clearance time."
    }
  } with {
    briefly "Return to service"
    described by "Returns vehicle to service."
  }

  // Events
  event VehicleRegistered is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    info is VehicleInfo with { briefly "Info" described by "Vehicle info." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Vehicle registered"
    described by "Emitted when vehicle is registered."
  }

  event VehicleInfoUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    info is VehicleInfo with { briefly "Info" described by "Updated info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Vehicle info updated"
    described by "Emitted when info is updated."
  }

  event OperatorAssigned is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    operator is OperatorInfo with { briefly "Operator" described by "Operator." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Operator assigned"
    described by "Emitted when operator is assigned."
  }

  event TripAssigned is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    trip is TripAssignment with { briefly "Trip" described by "Trip assignment." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Trip assigned"
    described by "Emitted when trip is assigned."
  }

  event LocationUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    position is VehiclePosition with { briefly "Position" described by "Position." }
  } with {
    briefly "Location updated"
    described by "Emitted when position is updated."
  }

  event StopEventRecorded is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    stopEvent is StopEvent with { briefly "Stop event" described by "Stop event." }
  } with {
    briefly "Stop event recorded"
    described by "Emitted at stop arrival/departure."
  }

  event PassengerLoadUpdated is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    load is PassengerLoad with { briefly "Load" described by "Passenger load." }
  } with {
    briefly "Passenger load updated"
    described by "Emitted when count updates."
  }

  event IncidentReported is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    incident is ServiceIncident with { briefly "Incident" described by "Incident." }
  } with {
    briefly "Incident reported"
    described by "Emitted when incident occurs."
  }

  event TripCompleted is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    tripId is TripId with { briefly "Trip" described by "Trip ID." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Trip completed"
    described by "Emitted when trip is done."
  }

  event VehicleStatusChanged is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    previousStatus is VehicleStatus with { briefly "Previous" described by "Previous status." }
    newStatus is VehicleStatus with { briefly "New" described by "New status." }
    changedAt is TimeStamp with { briefly "Changed" described by "Change time." }
  } with {
    briefly "Vehicle status changed"
    described by "Emitted when status changes."
  }

  event VehiclePulledFromService is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Pull reason." }
    pulledAt is TimeStamp with { briefly "Pulled" described by "Pull time." }
  } with {
    briefly "Vehicle pulled from service"
    described by "Emitted when pulled from service."
  }

  event VehicleReturnedToService is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    returnedAt is TimeStamp with { briefly "Returned" described by "Return time." }
  } with {
    briefly "Vehicle returned to service"
    described by "Emitted when returned to service."
  }

  // State Records
  record ActiveStateData is {
    vehicleId is VehicleId with { briefly "Vehicle" described by "Vehicle ID." }
    info is VehicleInfo with { briefly "Info" described by "Vehicle info." }
    status is VehicleStatus with { briefly "Status" described by "Vehicle status." }
    currentOperator is optional OperatorInfo with { briefly "Operator" described by "Current operator." }
    currentTrip is optional TripAssignment with { briefly "Trip" described by "Current trip." }
    currentPosition is optional VehiclePosition with { briefly "Position" described by "Current position." }
    passengerLoad is optional PassengerLoad with { briefly "Load" described by "Passenger load." }
    stopEvents is many optional StopEvent with { briefly "Stops" described by "Today's stop events." }
    activeIncident is optional ServiceIncident with { briefly "Incident" described by "Active incident." }
    registeredAt is TimeStamp with { briefly "Registered" described by "Registration time." }
  } with {
    briefly "Active state"
    described by "State for active vehicle."
  }

  // States
  state ActiveState of Vehicle.ActiveStateData with {
    briefly "Vehicle active"
    described by "Vehicle is in fleet."
  }

  // Handler
  handler VehicleHandler is {
    on command RegisterVehicle {
      morph entity VehicleContext.Vehicle to state VehicleContext.Vehicle.ActiveState with command RegisterVehicle
      tell event VehicleRegistered to entity VehicleContext.Vehicle
    }

    on command UpdateVehicleInfo {
      tell event VehicleInfoUpdated to entity VehicleContext.Vehicle
    }

    on command AssignOperator {
      tell event OperatorAssigned to entity VehicleContext.Vehicle
    }

    on command AssignTrip {
      tell event TripAssigned to entity VehicleContext.Vehicle
    }

    on command UpdateLocation {
      tell event LocationUpdated to entity VehicleContext.Vehicle
    }

    on command RecordStopEvent {
      tell event StopEventRecorded to entity VehicleContext.Vehicle
    }

    on command UpdatePassengerLoad {
      tell event PassengerLoadUpdated to entity VehicleContext.Vehicle
    }

    on command ReportIncident {
      tell event IncidentReported to entity VehicleContext.Vehicle
    }

    on command CompleteTrip {
      tell event TripCompleted to entity VehicleContext.Vehicle
    }

    on command SetVehicleStatus {
      tell event VehicleStatusChanged to entity VehicleContext.Vehicle
    }

    on command PullFromService {
      tell event VehiclePulledFromService to entity VehicleContext.Vehicle
    }

    on command ReturnToService {
      tell event VehicleReturnedToService to entity VehicleContext.Vehicle
    }
  } with {
    briefly "Processes vehicle commands"
    described by {
      | Handles transit vehicle lifecycle from registration
      | through daily service operations.
    }
  }

} with {
  briefly "Vehicle aggregate"
  described by {
    | The Vehicle entity manages transit vehicles
    | and their daily operations.
  }
}
