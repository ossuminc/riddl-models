// Transit Operations - Vehicle Entity
entity Vehicle is {
  // Commands
  command RegisterVehicle is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |New vehicle identifier.
      }
    }
    info: VehicleInfo with {
      briefly "Info"
      described as {
        |Vehicle details.
      }
    }
  } with {
    briefly "Register vehicle"
    described as {
      |Registers a new transit vehicle.
    }
  }
  command UpdateVehicleInfo is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    info: VehicleInfo with {
      briefly "Info"
      described as {
        |Updated info.
      }
    }
  } with {
    briefly "Update vehicle info"
    described as {
      |Updates vehicle details.
    }
  }
  command AssignOperator is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    operator: OperatorInfo with {
      briefly "Operator"
      described as {
        |Operator assignment.
      }
    }
  } with {
    briefly "Assign operator"
    described as {
      |Assigns operator to vehicle.
    }
  }
  command AssignTrip is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    trip: TripAssignment with {
      briefly "Trip"
      described as {
        |Trip assignment.
      }
    }
  } with {
    briefly "Assign trip"
    described as {
      |Assigns trip to vehicle.
    }
  }
  command UpdateLocation is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    position: VehiclePosition with {
      briefly "Position"
      described as {
        |Current position.
      }
    }
  } with {
    briefly "Update location"
    described as {
      |Updates vehicle position.
    }
  }
  command RecordStopEvent is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    stopEvent: StopEvent with {
      briefly "Stop event"
      described as {
        |Stop arrival/departure.
      }
    }
  } with {
    briefly "Record stop event"
    described as {
      |Records stop arrival or departure.
    }
  }
  command UpdatePassengerLoad is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    load: PassengerLoad with {
      briefly "Load"
      described as {
        |Passenger count.
      }
    }
  } with {
    briefly "Update passenger load"
    described as {
      |Updates current passenger count.
    }
  }
  command ReportIncident is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    incident: ServiceIncident with {
      briefly "Incident"
      described as {
        |Incident details.
      }
    }
  } with {
    briefly "Report incident"
    described as {
      |Reports a service incident.
    }
  }
  command CompleteTrip is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    tripId: TripId with {
      briefly "Trip"
      described as {
        |Trip ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Complete trip"
    described as {
      |Completes a scheduled trip.
    }
  }
  command SetVehicleStatus is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    status: VehicleStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    updatedReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Status change reason.
      }
    }
  } with {
    briefly "Set vehicle status"
    described as {
      |Changes vehicle status.
    }
  }
  command PullFromService is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Pull reason.
      }
    }
  } with {
    briefly "Pull from service"
    described as {
      |Removes vehicle from service.
    }
  }
  command ReturnToService is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle identifier.
      }
    }
    clearedAt: TimeStamp with {
      briefly "Cleared"
      described as {
        |Clearance time.
      }
    }
  } with {
    briefly "Return to service"
    described as {
      |Returns vehicle to service.
    }
  }
  // Events
  event VehicleRegistered is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    info: VehicleInfo with {
      briefly "Info"
      described as {
        |Vehicle info.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Vehicle registered"
    described as {
      |Emitted when vehicle is registered.
    }
  }
  event VehicleInfoUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    info: VehicleInfo with {
      briefly "Info"
      described as {
        |Updated info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Vehicle info updated"
    described as {
      |Emitted when info is updated.
    }
  }
  event OperatorAssigned is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    operator: OperatorInfo with {
      briefly "Operator"
      described as {
        |Operator.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Operator assigned"
    described as {
      |Emitted when operator is assigned.
    }
  }
  event TripAssigned is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    trip: TripAssignment with {
      briefly "Trip"
      described as {
        |Trip assignment.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Trip assigned"
    described as {
      |Emitted when trip is assigned.
    }
  }
  event LocationUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    position: VehiclePosition with {
      briefly "Position"
      described as {
        |Position.
      }
    }
  } with {
    briefly "Location updated"
    described as {
      |Emitted when position is updated.
    }
  }
  event StopEventRecorded is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    stopEvent: StopEvent with {
      briefly "Stop event"
      described as {
        |Stop event.
      }
    }
  } with {
    briefly "Stop event recorded"
    described as {
      |Emitted at stop arrival/departure.
    }
  }
  event PassengerLoadUpdated is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    load: PassengerLoad with {
      briefly "Load"
      described as {
        |Passenger load.
      }
    }
  } with {
    briefly "Passenger load updated"
    described as {
      |Emitted when count updates.
    }
  }
  event IncidentReported is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    incident: ServiceIncident with {
      briefly "Incident"
      described as {
        |Incident.
      }
    }
  } with {
    briefly "Incident reported"
    described as {
      |Emitted when incident occurs.
    }
  }
  event TripCompleted is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    tripId: TripId with {
      briefly "Trip"
      described as {
        |Trip ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Trip completed"
    described as {
      |Emitted when trip is done.
    }
  }
  event VehicleStatusChanged is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    previousStatus: VehicleStatus with {
      briefly "Previous"
      described as {
        |Previous status.
      }
    }
    newStatus: VehicleStatus with {
      briefly "New"
      described as {
        |New status.
      }
    }
    changedAt: TimeStamp with {
      briefly "Changed"
      described as {
        |Change time.
      }
    }
  } with {
    briefly "Vehicle status changed"
    described as {
      |Emitted when status changes.
    }
  }
  event VehiclePulledFromService is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Pull reason.
      }
    }
    pulledAt: TimeStamp with {
      briefly "Pulled"
      described as {
        |Pull time.
      }
    }
  } with {
    briefly "Vehicle pulled from service"
    described as {
      |Emitted when pulled from service.
    }
  }
  event VehicleReturnedToService is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    returnedAt: TimeStamp with {
      briefly "Returned"
      described as {
        |Return time.
      }
    }
  } with {
    briefly "Vehicle returned to service"
    described as {
      |Emitted when returned to service.
    }
  }
  // State Records
  record ActiveStateData is  {
    vehicleId: VehicleId with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    info: VehicleInfo with {
      briefly "Info"
      described as {
        |Vehicle info.
      }
    }
    status: VehicleStatus with {
      briefly "Status"
      described as {
        |Vehicle status.
      }
    }
    currentOperator: OperatorInfo? with {
      briefly "Operator"
      described as {
        |Current operator.
      }
    }
    currentTrip: TripAssignment? with {
      briefly "Trip"
      described as {
        |Current trip.
      }
    }
    currentPosition: VehiclePosition? with {
      briefly "Position"
      described as {
        |Current position.
      }
    }
    passengerLoad: PassengerLoad? with {
      briefly "Load"
      described as {
        |Passenger load.
      }
    }
    stopEvents: StopEvent* with {
      briefly "Stops"
      described as {
        |Today's stop events.
      }
    }
    activeIncident: ServiceIncident? with {
      briefly "Incident"
      described as {
        |Active incident.
      }
    }
    registeredAt: TimeStamp with {
      briefly "Registered"
      described as {
        |Registration time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active vehicle.
    }
  }
  // States
  state ActiveState of type Vehicle.ActiveStateData
  // Handler
  handler VehicleHandler is {
    on command RegisterVehicle is {
      morph entity VehicleContext.Vehicle to state VehicleContext.Vehicle.ActiveState with command RegisterVehicle
      tell event VehicleRegistered to entity VehicleContext.Vehicle
    }
    on command UpdateVehicleInfo is {
      tell event VehicleInfoUpdated to entity VehicleContext.Vehicle
    }
    on command AssignOperator is {
      tell event OperatorAssigned to entity VehicleContext.Vehicle
    }
    on command AssignTrip is {
      tell event TripAssigned to entity VehicleContext.Vehicle
    }
    on command UpdateLocation is {
      tell event LocationUpdated to entity VehicleContext.Vehicle
    }
    on command RecordStopEvent is {
      tell event StopEventRecorded to entity VehicleContext.Vehicle
    }
    on command UpdatePassengerLoad is {
      tell event PassengerLoadUpdated to entity VehicleContext.Vehicle
    }
    on command ReportIncident is {
      tell event IncidentReported to entity VehicleContext.Vehicle
    }
    on command CompleteTrip is {
      tell event TripCompleted to entity VehicleContext.Vehicle
    }
    on command SetVehicleStatus is {
      tell event VehicleStatusChanged to entity VehicleContext.Vehicle
    }
    on command PullFromService is {
      tell event VehiclePulledFromService to entity VehicleContext.Vehicle
    }
    on command ReturnToService is {
      tell event VehicleReturnedToService to entity VehicleContext.Vehicle
    }
  } with {
    briefly "Processes vehicle commands"
    described as {
      | Handles transit vehicle lifecycle from registration
      | through daily service operations.
    }
  }
} with {
  briefly "Vehicle aggregate"
  described as {
    | The Vehicle entity manages transit vehicles
    | and their daily operations.
  }
}
