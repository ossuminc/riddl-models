// Portfolio Operations - Portfolio Ops Context

context PortfolioOpsContext is {

  include "types.riddl"
  include "PortfolioCompany.riddl"

  repository PortfolioRepository is {
    schema PortfolioData is relational
      of portfolioCompanies as PortfolioCompany
      index on field PortfolioCompany.companyId
      index on field PortfolioCompany.fundId
      index on field PortfolioCompany.status

    handler PortfolioPersistence is {
      on event PortfolioCompany.CompanyOnboarded {
        prompt "Store new portfolio company"
      }
      on event PortfolioCompany.FinancialsUpdated {
        prompt "Update financial metrics"
      }
      on event PortfolioCompany.InitiativeAdded {
        prompt "Store value creation initiative"
      }
      on event PortfolioCompany.InitiativeStatusUpdated {
        prompt "Update initiative status"
      }
      on event PortfolioCompany.BoardMeetingRecorded {
        prompt "Store board meeting record"
      }
      on event PortfolioCompany.ExitCompleted {
        prompt "Update company to exited status"
      }
    } with {
      briefly "Persists portfolio events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Portfolio data persistence"
    described by "Persistent storage for portfolio operations."
  }

  projector PortfolioMetrics is {
    updates repository PortfolioRepository

    record PortfolioPerformanceMetrics is {
      totalCompanies is Natural with { briefly "Total" described by "Total portfolio companies." }
      activeCompanies is Natural with { briefly "Active" described by "Active portfolio companies." }
      exitedCompanies is Natural with { briefly "Exited" described by "Exited companies." }
      averageMOIC is Decimal(5, 2) with { briefly "Avg MOIC" described by "Average multiple on invested capital." }
      totalInvestedCapital is Decimal(14, 2) with { briefly "Total invested" described by "Total capital invested." }
      initiativesOnTrack is Natural with { briefly "On track" described by "Initiatives on track." }
      initiativesAtRisk is Natural with { briefly "At risk" described by "Initiatives at risk." }
    } with {
      briefly "Portfolio performance metrics"
      described by "Aggregated portfolio performance indicators."
    }

    handler MetricsHandler is {
      on event PortfolioCompany.CompanyOnboarded {
        prompt "Increment total and active company counts"
      }
      on event PortfolioCompany.FinancialsUpdated {
        prompt "Recalculate portfolio financial metrics"
      }
      on event PortfolioCompany.InitiativeStatusUpdated {
        prompt "Update initiative tracking counts"
      }
      on event PortfolioCompany.ExitCompleted {
        prompt "Update exit metrics and calculate realized returns"
      }
      on event PortfolioCompany.CompanyWrittenOff {
        prompt "Decrement active company count"
      }
    } with {
      briefly "Maintains portfolio metrics"
      described by "Projects events into portfolio analytics."
    }
  } with {
    briefly "Portfolio metrics"
    described by "Portfolio performance analytics."
  }

} with {
  briefly "Bounded context for portfolio operations"
  described by "Private equity portfolio operations context."
}
