// Portfolio Operations - PortfolioCompany Entity
entity PortfolioCompany is {
  command OnboardCompany is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |New portfolio company identifier.
      }
    }
    companyName: String(3,200) with {
      briefly "Company name"
      described as {
        |Portfolio company name.
      }
    }
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Owning fund identifier.
      }
    }
    industry: IndustrySegment with {
      briefly "Industry"
      described as {
        |Industry segment.
      }
    }
    acquisitionDate: Date with {
      briefly "Acquisition date"
      described as {
        |Date of acquisition.
      }
    }
    investedCapital: Decimal(14,2) with {
      briefly "Invested capital"
      described as {
        |Total capital invested at acquisition.
      }
    }
    exitStrategy: ExitStrategy with {
      briefly "Exit strategy"
      described as {
        |Planned exit strategy.
      }
    }
  } with {
    briefly "Onboard company"
    described as {
      |Onboards a newly acquired portfolio company.
    }
  }
  command UpdateFinancials is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    metrics: FinancialMetrics with {
      briefly "Metrics"
      described as {
        |Updated financial metrics.
      }
    }
  } with {
    briefly "Update financials"
    described as {
      |Updates financial performance metrics.
    }
  }
  command RecordOperationalKPIs is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    kpis: OperationalKPI+ with {
      briefly "KPIs"
      described as {
        |Operational KPI measurements.
      }
    }
  } with {
    briefly "Record operational KPIs"
    described as {
      |Records operational performance indicators.
    }
  }
  command AddValueCreationInitiative is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    initiative: ValueCreationInitiative with {
      briefly "Initiative"
      described as {
        |Value creation initiative to add.
      }
    }
  } with {
    briefly "Add value creation initiative"
    described as {
      |Adds initiative to value creation plan.
    }
  }
  command UpdateInitiativeStatus is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    initiativeId: InitiativeId with {
      briefly "Initiative ID"
      described as {
        |Initiative identifier.
      }
    }
    newStatus: InitiativeStatus with {
      briefly "New status"
      described as {
        |Updated initiative status.
      }
    }
    actualImpact: Decimal(14,2)? with {
      briefly "Actual impact"
      described as {
        |Realized EBITDA impact if completed.
      }
    }
  } with {
    briefly "Update initiative status"
    described as {
      |Updates status of a value creation initiative.
    }
  }
  command RecordBoardMeeting is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    meeting: BoardMeeting with {
      briefly "Meeting"
      described as {
        |Board meeting details.
      }
    }
  } with {
    briefly "Record board meeting"
    described as {
      |Records a board governance meeting.
    }
  }
  command AppointDirector is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    director: BoardDirector with {
      briefly "Director"
      described as {
        |Director to appoint.
      }
    }
  } with {
    briefly "Appoint director"
    described as {
      |Appoints a director to the board.
    }
  }
  command AssessExitReadiness is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    readiness: ExitReadiness with {
      briefly "Readiness"
      described as {
        |Exit readiness assessment.
      }
    }
    assessmentNotes: String(3,1000) with {
      briefly "Notes"
      described as {
        |Assessment notes and rationale.
      }
    }
  } with {
    briefly "Assess exit readiness"
    described as {
      |Assesses readiness for exit.
    }
  }
  command InitiateExit is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    exitStrategy: ExitStrategy with {
      briefly "Exit strategy"
      described as {
        |Chosen exit strategy.
      }
    }
    targetDate: Date with {
      briefly "Target date"
      described as {
        |Target exit date.
      }
    }
  } with {
    briefly "Initiate exit"
    described as {
      |Begins exit process for portfolio company.
    }
  }
  command CompleteExit is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    exitDate: Date with {
      briefly "Exit date"
      described as {
        |Actual exit date.
      }
    }
    exitValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |Final exit valuation.
      }
    }
    realizedMultiple: Decimal(5,2) with {
      briefly "Realized MOIC"
      described as {
        |Final multiple on invested capital.
      }
    }
  } with {
    briefly "Complete exit"
    described as {
      |Records completed exit of portfolio company.
    }
  }
  command WriteOffCompany is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Company identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
  } with {
    briefly "Write off company"
    described as {
      |Marks portfolio company as written off.
    }
  }
  // Events
  event CompanyOnboarded is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    companyName: String(3,200) with {
      briefly "Name"
      described as {
        |Company name.
      }
    }
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    onboardedAt: TimeStamp with {
      briefly "Onboarded"
      described as {
        |Onboarding time.
      }
    }
  } with {
    briefly "Company onboarded"
    described as {
      |Emitted when a portfolio company is onboarded.
    }
  }
  event FinancialsUpdated is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    metrics: FinancialMetrics with {
      briefly "Metrics"
      described as {
        |Financial metrics.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Financials updated"
    described as {
      |Emitted when financial metrics are updated.
    }
  }
  event OperationalKPIsRecorded is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    kpiCount: Natural with {
      briefly "Count"
      described as {
        |Number of KPIs recorded.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Operational KPIs recorded"
    described as {
      |Emitted when operational KPIs are recorded.
    }
  }
  event InitiativeAdded is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    initiativeId: InitiativeId with {
      briefly "Initiative"
      described as {
        |Initiative ID.
      }
    }
    title: String(3,200) with {
      briefly "Title"
      described as {
        |Initiative title.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Initiative added"
    described as {
      |Emitted when a value creation initiative is added.
    }
  }
  event InitiativeStatusUpdated is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    initiativeId: InitiativeId with {
      briefly "Initiative"
      described as {
        |Initiative ID.
      }
    }
    newStatus: InitiativeStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Initiative status updated"
    described as {
      |Emitted when initiative status changes.
    }
  }
  event BoardMeetingRecorded is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    meetingId: BoardMeetingId with {
      briefly "Meeting"
      described as {
        |Meeting ID.
      }
    }
    meetingDate: Date with {
      briefly "Date"
      described as {
        |Meeting date.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Board meeting recorded"
    described as {
      |Emitted when a board meeting is recorded.
    }
  }
  event DirectorAppointed is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    directorName: String(3,100) with {
      briefly "Name"
      described as {
        |Director name.
      }
    }
    appointedAt: TimeStamp with {
      briefly "Appointed"
      described as {
        |Appointment time.
      }
    }
  } with {
    briefly "Director appointed"
    described as {
      |Emitted when a board director is appointed.
    }
  }
  event ExitReadinessAssessed is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    readiness: ExitReadiness with {
      briefly "Readiness"
      described as {
        |Readiness level.
      }
    }
    assessedAt: TimeStamp with {
      briefly "Assessed"
      described as {
        |Assessment time.
      }
    }
  } with {
    briefly "Exit readiness assessed"
    described as {
      |Emitted when exit readiness is assessed.
    }
  }
  event ExitInitiated is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    exitStrategy: ExitStrategy with {
      briefly "Strategy"
      described as {
        |Exit strategy.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Exit initiated"
    described as {
      |Emitted when exit process begins.
    }
  }
  event ExitCompleted is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    exitValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |Exit valuation.
      }
    }
    realizedMultiple: Decimal(5,2) with {
      briefly "MOIC"
      described as {
        |Realized multiple.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Exit completed"
    described as {
      |Emitted when exit is completed.
    }
  }
  event CompanyWrittenOff is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writtenOffAt: TimeStamp with {
      briefly "Written off"
      described as {
        |Write-off time.
      }
    }
  } with {
    briefly "Company written off"
    described as {
      |Emitted when portfolio company is written off.
    }
  }
  // States
  record ActiveStateData is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    companyName: String(3,200) with {
      briefly "Name"
      described as {
        |Company name.
      }
    }
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    industry: IndustrySegment with {
      briefly "Industry"
      described as {
        |Industry segment.
      }
    }
    status: CompanyStatus with {
      briefly "Status"
      described as {
        |Company status.
      }
    }
    acquisitionDate: Date with {
      briefly "Acquired"
      described as {
        |Acquisition date.
      }
    }
    investment: InvestmentSummary with {
      briefly "Investment"
      described as {
        |Investment summary.
      }
    }
    exitStrategy: ExitStrategy with {
      briefly "Exit strategy"
      described as {
        |Planned exit.
      }
    }
    exitReadiness: ExitReadiness with {
      briefly "Readiness"
      described as {
        |Exit readiness.
      }
    }
    latestFinancials: FinancialMetrics? with {
      briefly "Financials"
      described as {
        |Latest financials.
      }
    }
    operationalKPIs: OperationalKPI* with {
      briefly "KPIs"
      described as {
        |Operational KPIs.
      }
    }
    initiatives: ValueCreationInitiative* with {
      briefly "Initiatives"
      described as {
        |Value creation initiatives.
      }
    }
    boardDirectors: BoardDirector* with {
      briefly "Directors"
      described as {
        |Board directors.
      }
    }
    boardMeetings: BoardMeeting* with {
      briefly "Meetings"
      described as {
        |Board meetings.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Onboarding time.
      }
    }
  } with {
    briefly "Active company state"
    described as {
      |State for an active portfolio company.
    }
  }
  record ExitedStateData is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    companyName: String(3,200) with {
      briefly "Name"
      described as {
        |Company name.
      }
    }
    exitDate: Date with {
      briefly "Exit date"
      described as {
        |Date of exit.
      }
    }
    exitValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |Exit valuation.
      }
    }
    realizedMultiple: Decimal(5,2) with {
      briefly "MOIC"
      described as {
        |Realized multiple.
      }
    }
    exitStrategy: ExitStrategy with {
      briefly "Strategy"
      described as {
        |Exit strategy used.
      }
    }
  } with {
    briefly "Exited company state"
    described as {
      |State for an exited portfolio company.
    }
  }
  state ActiveState of type PortfolioCompany.ActiveStateData
  state ExitedState of type PortfolioCompany.ExitedStateData
  handler PortfolioCompanyHandler is {
    on command OnboardCompany is {
      morph entity PortfolioOpsContext.PortfolioCompany to state PortfolioOpsContext.PortfolioCompany.ActiveState with command OnboardCompany
      tell event CompanyOnboarded to entity PortfolioOpsContext.PortfolioCompany
    }
    on command UpdateFinancials is {
      tell event FinancialsUpdated to entity PortfolioOpsContext.PortfolioCompany
    }
    on command RecordOperationalKPIs is {
      tell event OperationalKPIsRecorded to entity PortfolioOpsContext.PortfolioCompany
    }
    on command AddValueCreationInitiative is {
      tell event InitiativeAdded to entity PortfolioOpsContext.PortfolioCompany
    }
    on command UpdateInitiativeStatus is {
      tell event InitiativeStatusUpdated to entity PortfolioOpsContext.PortfolioCompany
    }
    on command RecordBoardMeeting is {
      tell event BoardMeetingRecorded to entity PortfolioOpsContext.PortfolioCompany
    }
    on command AppointDirector is {
      tell event DirectorAppointed to entity PortfolioOpsContext.PortfolioCompany
    }
    on command AssessExitReadiness is {
      tell event ExitReadinessAssessed to entity PortfolioOpsContext.PortfolioCompany
    }
    on command InitiateExit is {
      tell event ExitInitiated to entity PortfolioOpsContext.PortfolioCompany
    }
    on command CompleteExit is {
      morph entity PortfolioOpsContext.PortfolioCompany to state PortfolioOpsContext.PortfolioCompany.ExitedState with command CompleteExit
      tell event ExitCompleted to entity PortfolioOpsContext.PortfolioCompany
    }
    on command WriteOffCompany is {
      tell event CompanyWrittenOff to entity PortfolioOpsContext.PortfolioCompany
    }
  } with {
    briefly "Processes portfolio company commands"
    described as {
      |Handles portfolio company lifecycle.
    }
  }
} with {
  briefly "PortfolioCompany aggregate"
  described as {
    |Manages PE portfolio company operations.
  }
}
