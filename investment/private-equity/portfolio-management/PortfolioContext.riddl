// Portfolio Management - Portfolio Context

context PortfolioContext is {

  include "types.riddl"
  include "PortfolioCompany.riddl"

  // Repository for portfolio company persistence
  repository PortfolioRepository is {
    schema PortfolioData is relational
      of portfolioCompanies as PortfolioCompany
      index on field PortfolioCompany.companyId
      index on field PortfolioCompany.investment.fundId
      index on field PortfolioCompany.status

    handler PortfolioPersistence is {
      on command PortfolioCompany.AcquireCompany {
        prompt "Store new portfolio company"
      }
      on command PortfolioCompany.UpdateCompanyInfo {
        prompt "Update company information"
      }
      on command PortfolioCompany.RecordFinancials {
        prompt "Store financial metrics"
      }
      on command PortfolioCompany.UpdateValuation {
        prompt "Store valuation update"
      }
      on command PortfolioCompany.MakeFollowOn {
        prompt "Store follow-on investment"
      }
      on command PortfolioCompany.AppointBoardMember {
        prompt "Store board member appointment"
      }
      on command PortfolioCompany.RemoveBoardMember {
        prompt "Remove board member"
      }
      on command PortfolioCompany.ExitInvestment {
        prompt "Update to exited status"
      }
      on command PortfolioCompany.WriteOffInvestment {
        prompt "Update to written off status"
      }
    } with {
      briefly "Persists portfolio company events"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Portfolio data persistence"
    described by {
      | The PortfolioRepository provides persistent storage for
      | portfolio companies, valuations, and financial data.
    }
  }

  // Projector for portfolio analytics
  projector PortfolioAnalytics is {
    updates repository PortfolioRepository

    record PortfolioSummary is {
      totalCompanies is Natural with { briefly "Companies" described by "Total portfolio companies." }
      activeCompanies is Natural with { briefly "Active" described by "Active companies." }
      totalInvested is MonetaryAmount with { briefly "Invested" described by "Total capital invested." }
      currentValue is MonetaryAmount with { briefly "Value" described by "Current portfolio value." }
      unrealizedGain is MonetaryAmount with { briefly "Unrealized" described by "Unrealized gain/loss." }
      grossMOIC is Decimal(6, 2) with { briefly "MOIC" described by "Gross multiple on invested capital." }
    } with {
      briefly "Portfolio summary"
      described by "Aggregate portfolio metrics."
    }

    record FundPerformance is {
      fundId is FundId with { briefly "Fund" described by "Fund identifier." }
      investedCapital is MonetaryAmount with { briefly "Invested" described by "Capital invested." }
      realizedValue is MonetaryAmount with { briefly "Realized" described by "Realized proceeds." }
      unrealizedValue is MonetaryAmount with { briefly "Unrealized" described by "Unrealized value." }
      totalValue is MonetaryAmount with { briefly "Total" described by "Total value." }
      grossMOIC is Decimal(6, 2) with { briefly "MOIC" described by "Gross multiple." }
      netIRR is Decimal(6, 2) with { briefly "IRR" described by "Net IRR." }
    } with {
      briefly "Fund performance"
      described by "Fund-level performance metrics."
    }

    record CompanyPerformance is {
      companyId is PortfolioCompanyId with { briefly "Company" described by "Company ID." }
      companyName is String(1, 200) with { briefly "Name" described by "Company name." }
      invested is MonetaryAmount with { briefly "Invested" described by "Capital invested." }
      currentValue is MonetaryAmount with { briefly "Value" described by "Current value." }
      moic is Decimal(6, 2) with { briefly "MOIC" described by "Return multiple." }
      holdingPeriod is Natural with { briefly "Holding" described by "Holding period in months." }
      lastRevenueGrowth is Decimal(6, 2) with { briefly "Growth" described by "Last revenue growth." }
    } with {
      briefly "Company performance"
      described by "Individual company performance."
    }

    handler AnalyticsHandler is {
      on event PortfolioCompany.CompanyAcquired {
        prompt "Update portfolio totals for new company"
      }
      on event PortfolioCompany.ValuationUpdated {
        prompt "Recalculate portfolio value and returns"
      }
      on event PortfolioCompany.FollowOnMade {
        prompt "Update invested capital totals"
      }
      on event PortfolioCompany.InvestmentExited {
        prompt "Calculate realized returns"
      }
      on event PortfolioCompany.FinancialsRecorded {
        prompt "Update company performance metrics"
      }
    } with {
      briefly "Maintains portfolio analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Portfolio analytics projections"
    described by "Maintains portfolio performance analytics."
  }

} with {
  briefly "Bounded context for portfolio management"
  described by {
    | The PortfolioContext is the bounded context for
    | private equity portfolio company management.
  }
}
