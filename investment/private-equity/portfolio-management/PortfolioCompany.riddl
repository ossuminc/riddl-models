// Portfolio Management - PortfolioCompany Entity
entity PortfolioCompany is {
  // Commands
  command AcquireCompany is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |New portfolio company identifier.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company information.
      }
    }
    investment: InvestmentInfo with {
      briefly "Investment"
      described as {
        |Investment details.
      }
    }
    initialValuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |Initial valuation.
      }
    }
  } with {
    briefly "Acquire portfolio company"
    described as {
      |Adds a new company to the portfolio.
    }
  }
  command UpdateCompanyInfo is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Updated company information.
      }
    }
  } with {
    briefly "Update company info"
    described as {
      |Updates portfolio company details.
    }
  }
  command RecordFinancials is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    metrics: FinancialMetrics with {
      briefly "Metrics"
      described as {
        |Financial metrics.
      }
    }
  } with {
    briefly "Record financials"
    described as {
      |Records financial performance metrics.
    }
  }
  command UpdateValuation is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    valuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |New valuation.
      }
    }
  } with {
    briefly "Update valuation"
    described as {
      |Records new portfolio company valuation.
    }
  }
  command MakeFollowOn is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    followOn: FollowOnInvestment with {
      briefly "Follow-on"
      described as {
        |Follow-on investment details.
      }
    }
  } with {
    briefly "Make follow-on investment"
    described as {
      |Records additional investment in company.
    }
  }
  command AppointBoardMember is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    member: BoardMember with {
      briefly "Member"
      described as {
        |Board member details.
      }
    }
  } with {
    briefly "Appoint board member"
    described as {
      |Appoints representative to board.
    }
  }
  command RemoveBoardMember is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    memberId: BoardMemberId with {
      briefly "Member ID"
      described as {
        |Board member to remove.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for removal.
      }
    }
  } with {
    briefly "Remove board member"
    described as {
      |Removes representative from board.
    }
  }
  command ExitInvestment is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    exitInfo: ExitInfo with {
      briefly "Exit info"
      described as {
        |Exit transaction details.
      }
    }
  } with {
    briefly "Exit investment"
    described as {
      |Records exit from portfolio company.
    }
  }
  command WriteOffInvestment is  {
    companyId: PortfolioCompanyId with {
      briefly "Company ID"
      described as {
        |Portfolio company identifier.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writeOffDate: Date with {
      briefly "Date"
      described as {
        |Write-off date.
      }
    }
  } with {
    briefly "Write off investment"
    described as {
      |Records investment write-off.
    }
  }
  // Events
  event CompanyAcquired is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    investment: InvestmentInfo with {
      briefly "Investment"
      described as {
        |Investment details.
      }
    }
    initialValuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |Initial valuation.
      }
    }
    acquiredAt: TimeStamp with {
      briefly "Acquired"
      described as {
        |Acquisition time.
      }
    }
  } with {
    briefly "Company acquired"
    described as {
      |Emitted when company is added to portfolio.
    }
  }
  event CompanyInfoUpdated is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Updated info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Company info updated"
    described as {
      |Emitted when company details are updated.
    }
  }
  event FinancialsRecorded is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    metrics: FinancialMetrics with {
      briefly "Metrics"
      described as {
        |Financial metrics.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Financials recorded"
    described as {
      |Emitted when financial metrics are recorded.
    }
  }
  event ValuationUpdated is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    valuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |New valuation.
      }
    }
    previousValue: MonetaryAmount with {
      briefly "Previous"
      described as {
        |Previous value.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Valuation updated"
    described as {
      |Emitted when valuation is updated.
    }
  }
  event FollowOnMade is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    followOn: FollowOnInvestment with {
      briefly "Follow-on"
      described as {
        |Investment details.
      }
    }
    newTotalInvested: MonetaryAmount with {
      briefly "Total"
      described as {
        |New total invested.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Follow-on investment made"
    described as {
      |Emitted when follow-on investment is made.
    }
  }
  event BoardMemberAppointed is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    member: BoardMember with {
      briefly "Member"
      described as {
        |Board member.
      }
    }
    appointedAt: TimeStamp with {
      briefly "Appointed"
      described as {
        |Appointment time.
      }
    }
  } with {
    briefly "Board member appointed"
    described as {
      |Emitted when board member is appointed.
    }
  }
  event BoardMemberRemoved is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    memberId: BoardMemberId with {
      briefly "Member"
      described as {
        |Member ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Removal reason.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Board member removed"
    described as {
      |Emitted when board member is removed.
    }
  }
  event InvestmentExited is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    exitInfo: ExitInfo with {
      briefly "Exit"
      described as {
        |Exit details.
      }
    }
    exitedAt: TimeStamp with {
      briefly "Exited"
      described as {
        |Exit time.
      }
    }
  } with {
    briefly "Investment exited"
    described as {
      |Emitted when investment is exited.
    }
  }
  event InvestmentWrittenOff is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writtenOffAt: TimeStamp with {
      briefly "Written off"
      described as {
        |Write-off time.
      }
    }
  } with {
    briefly "Investment written off"
    described as {
      |Emitted when investment is written off.
    }
  }
  // State Records
  record ActiveStateData is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    investment: InvestmentInfo with {
      briefly "Investment"
      described as {
        |Investment details.
      }
    }
    currentValuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |Current valuation.
      }
    }
    financialHistory: FinancialMetrics* with {
      briefly "Financials"
      described as {
        |Financial history.
      }
    }
    valuationHistory: ValuationInfo* with {
      briefly "Valuations"
      described as {
        |Valuation history.
      }
    }
    followOns: FollowOnInvestment* with {
      briefly "Follow-ons"
      described as {
        |Follow-on investments.
      }
    }
    boardMembers: BoardMember* with {
      briefly "Board"
      described as {
        |Board members.
      }
    }
    status: PortfolioStatus with {
      briefly "Status"
      described as {
        |Portfolio status.
      }
    }
    acquiredAt: TimeStamp with {
      briefly "Acquired"
      described as {
        |Acquisition time.
      }
    }
  } with {
    briefly "Active portfolio state"
    described as {
      |State for active portfolio company.
    }
  }
  record ExitedStateData is  {
    companyId: PortfolioCompanyId with {
      briefly "Company"
      described as {
        |Company ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    investment: InvestmentInfo with {
      briefly "Investment"
      described as {
        |Investment details.
      }
    }
    exitInfo: ExitInfo with {
      briefly "Exit"
      described as {
        |Exit details.
      }
    }
    finalValuation: ValuationInfo with {
      briefly "Valuation"
      described as {
        |Final valuation.
      }
    }
    acquiredAt: TimeStamp with {
      briefly "Acquired"
      described as {
        |Acquisition time.
      }
    }
    exitedAt: TimeStamp with {
      briefly "Exited"
      described as {
        |Exit time.
      }
    }
  } with {
    briefly "Exited portfolio state"
    described as {
      |State for exited portfolio company.
    }
  }
  // States
  state ActiveState of type PortfolioCompany.ActiveStateData
  state ExitedState of type PortfolioCompany.ExitedStateData
  // Handler
  handler PortfolioCompanyHandler is {
    on command AcquireCompany is {
      morph entity PortfolioContext.PortfolioCompany to state PortfolioContext.PortfolioCompany.ActiveState with command AcquireCompany
      tell event CompanyAcquired to entity PortfolioContext.PortfolioCompany
    }
    on command UpdateCompanyInfo is {
      tell event CompanyInfoUpdated to entity PortfolioContext.PortfolioCompany
    }
    on command RecordFinancials is {
      tell event FinancialsRecorded to entity PortfolioContext.PortfolioCompany
    }
    on command UpdateValuation is {
      tell event ValuationUpdated to entity PortfolioContext.PortfolioCompany
    }
    on command MakeFollowOn is {
      tell event FollowOnMade to entity PortfolioContext.PortfolioCompany
    }
    on command AppointBoardMember is {
      tell event BoardMemberAppointed to entity PortfolioContext.PortfolioCompany
    }
    on command RemoveBoardMember is {
      tell event BoardMemberRemoved to entity PortfolioContext.PortfolioCompany
    }
    on command ExitInvestment is {
      morph entity PortfolioContext.PortfolioCompany to state PortfolioContext.PortfolioCompany.ExitedState with command ExitInvestment
      tell event InvestmentExited to entity PortfolioContext.PortfolioCompany
    }
    on command WriteOffInvestment is {
      morph entity PortfolioContext.PortfolioCompany to state PortfolioContext.PortfolioCompany.ExitedState with command WriteOffInvestment
      tell event InvestmentWrittenOff to entity PortfolioContext.PortfolioCompany
    }
  } with {
    briefly "Processes portfolio company commands"
    described as {
      | Handles portfolio company lifecycle from acquisition
      | through value creation and exit.
    }
  }
} with {
  briefly "PortfolioCompany aggregate"
  described as {
    | The PortfolioCompany entity manages private equity
    | portfolio investments and value creation activities.
  }
}
