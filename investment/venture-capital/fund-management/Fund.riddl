// Fund Management - Fund Entity
entity Fund is {
  command CreateFund is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |New fund identifier.
      }
    }
    fundInfo: FundInfo with {
      briefly "Info"
      described as {
        |Fund information.
      }
    }
  } with {
    briefly "Create fund"
    described as {
      |Creates a new VC fund.
    }
  }
  command AddLPCommitment is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    commitment: LPCommitment with {
      briefly "Commitment"
      described as {
        |LP commitment.
      }
    }
  } with {
    briefly "Add LP commitment"
    described as {
      |Adds an LP commitment.
    }
  }
  command RecordFirstClose is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    closeDate: Date with {
      briefly "Close date"
      described as {
        |First close date.
      }
    }
    totalCommitments: Decimal(15,2) with {
      briefly "Commitments"
      described as {
        |Total committed.
      }
    }
  } with {
    briefly "Record first close"
    described as {
      |Records first close.
    }
  }
  command RecordFinalClose is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    closeDate: Date with {
      briefly "Close date"
      described as {
        |Final close date.
      }
    }
    totalCommitments: Decimal(15,2) with {
      briefly "Commitments"
      described as {
        |Final total committed.
      }
    }
  } with {
    briefly "Record final close"
    described as {
      |Records final close.
    }
  }
  command IssueCapitalCall is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    call: CapitalCall with {
      briefly "Call"
      described as {
        |Capital call details.
      }
    }
  } with {
    briefly "Issue capital call"
    described as {
      |Issues a capital call.
    }
  }
  command RecordCallPayment is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    callId: CapitalCallId with {
      briefly "Call"
      described as {
        |Capital call ID.
      }
    }
    lpId: LPId with {
      briefly "LP"
      described as {
        |LP identifier.
      }
    }
    amount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    paidAt: TimeStamp with {
      briefly "Paid"
      described as {
        |Payment time.
      }
    }
  } with {
    briefly "Record call payment"
    described as {
      |Records LP capital call payment.
    }
  }
  command IssueDistribution is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    distribution: Distribution with {
      briefly "Distribution"
      described as {
        |Distribution details.
      }
    }
  } with {
    briefly "Issue distribution"
    described as {
      |Issues distribution to LPs.
    }
  }
  command ChargeManagementFee is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    fee: ManagementFee with {
      briefly "Fee"
      described as {
        |Management fee.
      }
    }
  } with {
    briefly "Charge management fee"
    described as {
      |Charges management fee.
    }
  }
  command UpdateNAV is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    valuationDate: Date with {
      briefly "Date"
      described as {
        |Valuation date.
      }
    }
    nav: Decimal(15,2) with {
      briefly "NAV"
      described as {
        |Net asset value.
      }
    }
  } with {
    briefly "Update NAV"
    described as {
      |Updates fund NAV.
    }
  }
  command StartHarvestPeriod is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Harvest period start.
      }
    }
  } with {
    briefly "Start harvest period"
    described as {
      |Transitions to harvest period.
    }
  }
  command CloseFund is  {
    fundId: FundId with {
      briefly "Fund ID"
      described as {
        |Fund identifier.
      }
    }
    closeDate: Date with {
      briefly "Close date"
      described as {
        |Fund close date.
      }
    }
    finalMetrics: FundMetrics with {
      briefly "Metrics"
      described as {
        |Final performance metrics.
      }
    }
  } with {
    briefly "Close fund"
    described as {
      |Closes the fund.
    }
  }
  // Events
  event FundCreated is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Info"
      described as {
        |Fund info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Fund created"
    described as {
      |Emitted when fund is created.
    }
  }
  event LPCommitmentAdded is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    lpId: LPId with {
      briefly "LP"
      described as {
        |LP ID.
      }
    }
    commitmentAmount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Commitment.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "LP commitment added"
    described as {
      |Emitted when LP commits.
    }
  }
  event FirstCloseRecorded is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    closeDate: Date with {
      briefly "Date"
      described as {
        |Close date.
      }
    }
    totalCommitments: Decimal(15,2) with {
      briefly "Total"
      described as {
        |Total committed.
      }
    }
  } with {
    briefly "First close recorded"
    described as {
      |Emitted at first close.
    }
  }
  event FinalCloseRecorded is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    closeDate: Date with {
      briefly "Date"
      described as {
        |Close date.
      }
    }
    totalCommitments: Decimal(15,2) with {
      briefly "Total"
      described as {
        |Final committed.
      }
    }
  } with {
    briefly "Final close recorded"
    described as {
      |Emitted at final close.
    }
  }
  event CapitalCallIssued is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    call: CapitalCall with {
      briefly "Call"
      described as {
        |Capital call.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Capital call issued"
    described as {
      |Emitted when call issued.
    }
  }
  event CallPaymentReceived is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    callId: CapitalCallId with {
      briefly "Call"
      described as {
        |Call ID.
      }
    }
    lpId: LPId with {
      briefly "LP"
      described as {
        |LP ID.
      }
    }
    amount: Decimal(15,2) with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receive time.
      }
    }
  } with {
    briefly "Call payment received"
    described as {
      |Emitted when payment received.
    }
  }
  event DistributionIssued is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    distribution: Distribution with {
      briefly "Distribution"
      described as {
        |Distribution.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Distribution issued"
    described as {
      |Emitted when distribution issued.
    }
  }
  event ManagementFeeCharged is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    fee: ManagementFee with {
      briefly "Fee"
      described as {
        |Management fee.
      }
    }
    chargedAt: TimeStamp with {
      briefly "Charged"
      described as {
        |Charge time.
      }
    }
  } with {
    briefly "Management fee charged"
    described as {
      |Emitted when fee charged.
    }
  }
  event NAVUpdated is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    valuationDate: Date with {
      briefly "Date"
      described as {
        |Valuation date.
      }
    }
    nav: Decimal(15,2) with {
      briefly "NAV"
      described as {
        |New NAV.
      }
    }
  } with {
    briefly "NAV updated"
    described as {
      |Emitted when NAV updated.
    }
  }
  event HarvestPeriodStarted is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    startDate: Date with {
      briefly "Start"
      described as {
        |Start date.
      }
    }
  } with {
    briefly "Harvest period started"
    described as {
      |Emitted when harvest begins.
    }
  }
  event FundClosed is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    closeDate: Date with {
      briefly "Close"
      described as {
        |Close date.
      }
    }
    finalMetrics: FundMetrics with {
      briefly "Metrics"
      described as {
        |Final metrics.
      }
    }
  } with {
    briefly "Fund closed"
    described as {
      |Emitted when fund closes.
    }
  }
  // States
  record ActiveStateData is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Info"
      described as {
        |Fund info.
      }
    }
    status: FundStatus with {
      briefly "Status"
      described as {
        |Fund status.
      }
    }
    lpCommitments: LPCommitment* with {
      briefly "LPs"
      described as {
        |LP commitments.
      }
    }
    capitalCalls: CapitalCall* with {
      briefly "Calls"
      described as {
        |Capital calls.
      }
    }
    distributions: Distribution* with {
      briefly "Distributions"
      described as {
        |Distributions.
      }
    }
    currentMetrics: FundMetrics? with {
      briefly "Metrics"
      described as {
        |Current metrics.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active fund state"
    described as {
      |State for active fund.
    }
  }
  record ClosedStateData is  {
    fundId: FundId with {
      briefly "Fund"
      described as {
        |Fund ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Info"
      described as {
        |Fund info.
      }
    }
    finalMetrics: FundMetrics with {
      briefly "Metrics"
      described as {
        |Final metrics.
      }
    }
    closeDate: Date with {
      briefly "Closed"
      described as {
        |Close date.
      }
    }
  } with {
    briefly "Closed fund state"
    described as {
      |State for closed fund.
    }
  }
  state ActiveState of type Fund.ActiveStateData
  state ClosedState of type Fund.ClosedStateData
  handler FundHandler is {
    on command CreateFund is {
      morph entity FundContext.Fund to state FundContext.Fund.ActiveState with command CreateFund
      tell event FundCreated to entity FundContext.Fund
    }
    on command AddLPCommitment is {
      tell event LPCommitmentAdded to entity FundContext.Fund
    }
    on command RecordFirstClose is {
      tell event FirstCloseRecorded to entity FundContext.Fund
    }
    on command RecordFinalClose is {
      tell event FinalCloseRecorded to entity FundContext.Fund
    }
    on command IssueCapitalCall is {
      tell event CapitalCallIssued to entity FundContext.Fund
    }
    on command RecordCallPayment is {
      tell event CallPaymentReceived to entity FundContext.Fund
    }
    on command IssueDistribution is {
      tell event DistributionIssued to entity FundContext.Fund
    }
    on command ChargeManagementFee is {
      tell event ManagementFeeCharged to entity FundContext.Fund
    }
    on command UpdateNAV is {
      tell event NAVUpdated to entity FundContext.Fund
    }
    on command StartHarvestPeriod is {
      tell event HarvestPeriodStarted to entity FundContext.Fund
    }
    on command CloseFund is {
      morph entity FundContext.Fund to state FundContext.Fund.ClosedState with command CloseFund
      tell event FundClosed to entity FundContext.Fund
    }
  } with {
    briefly "Processes fund commands"
    described as {
      |Handles fund lifecycle.
    }
  }
} with {
  briefly "Fund aggregate"
  described as {
    |Manages VC fund operations.
  }
}
