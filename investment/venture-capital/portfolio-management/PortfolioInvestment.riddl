// Portfolio Management - PortfolioInvestment Entity
entity PortfolioInvestment is {
  command RecordInvestment is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |New investment identifier.
      }
    }
    companyInfo: CompanyInfo with {
      briefly "Company info"
      described as {
        |Portfolio company details.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Investment terms.
      }
    }
  } with {
    briefly "Record investment"
    described as {
      |Records a new portfolio investment.
    }
  }
  command AdvanceDueDiligence is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    findings: String(3,2000) with {
      briefly "Findings"
      described as {
        |Due diligence findings.
      }
    }
  } with {
    briefly "Advance due diligence"
    described as {
      |Records due diligence progress.
    }
  }
  command AddMilestone is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    milestone: MilestoneInfo with {
      briefly "Milestone"
      described as {
        |Milestone details.
      }
    }
  } with {
    briefly "Add milestone"
    described as {
      |Adds a milestone to the investment.
    }
  }
  command UpdateMilestone is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    milestoneId: MilestoneId with {
      briefly "Milestone ID"
      described as {
        |Milestone identifier.
      }
    }
    newStatus: MilestoneStatus with {
      briefly "Status"
      described as {
        |Updated milestone status.
      }
    }
    completedDate: Date? with {
      briefly "Completed"
      described as {
        |Completion date if achieved.
      }
    }
  } with {
    briefly "Update milestone"
    described as {
      |Updates a milestone status.
    }
  }
  command AssignBoardSeat is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    boardSeat: BoardSeatInfo with {
      briefly "Board seat"
      described as {
        |Board seat assignment.
      }
    }
  } with {
    briefly "Assign board seat"
    described as {
      |Assigns a board seat representative.
    }
  }
  command RemoveBoardSeat is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    seatId: BoardSeatId with {
      briefly "Seat ID"
      described as {
        |Board seat to remove.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Reason for removal.
      }
    }
  } with {
    briefly "Remove board seat"
    described as {
      |Removes a board seat assignment.
    }
  }
  command RecordFollowOn is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    followOn: FollowOnRound with {
      briefly "Follow-on"
      described as {
        |Follow-on round details.
      }
    }
  } with {
    briefly "Record follow-on"
    described as {
      |Records a follow-on funding round.
    }
  }
  command DeclineFollowOn is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    roundStage: InvestmentStage with {
      briefly "Stage"
      described as {
        |Round stage declined.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Reason for declining.
      }
    }
  } with {
    briefly "Decline follow-on"
    described as {
      |Declines participation in follow-on round.
    }
  }
  command RecordMetric is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    metric: PortfolioMetric with {
      briefly "Metric"
      described as {
        |Performance metric.
      }
    }
  } with {
    briefly "Record metric"
    described as {
      |Records a portfolio performance metric.
    }
  }
  command MarkDown is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    newValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |New marked-down valuation.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Reason for markdown.
      }
    }
  } with {
    briefly "Mark down"
    described as {
      |Marks down the investment valuation.
    }
  }
  command RecordExit is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    exitInfo: ExitDetails with {
      briefly "Exit"
      described as {
        |Exit details.
      }
    }
  } with {
    briefly "Record exit"
    described as {
      |Records the investment exit.
    }
  }
  command WriteOff is  {
    investmentId: InvestmentId with {
      briefly "Investment ID"
      described as {
        |Investment identifier.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writeOffDate: Date with {
      briefly "Date"
      described as {
        |Write-off date.
      }
    }
  } with {
    briefly "Write off"
    described as {
      |Writes off the investment as a loss.
    }
  }
  // Events
  event InvestmentRecorded is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    companyInfo: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Investment terms.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Investment recorded"
    described as {
      |Emitted when a new investment is recorded.
    }
  }
  event DueDiligenceAdvanced is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    findings: String(3,2000) with {
      briefly "Findings"
      described as {
        |DD findings.
      }
    }
    advancedAt: TimeStamp with {
      briefly "Advanced"
      described as {
        |Advancement time.
      }
    }
  } with {
    briefly "Due diligence advanced"
    described as {
      |Emitted when due diligence progresses.
    }
  }
  event MilestoneAdded is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    milestone: MilestoneInfo with {
      briefly "Milestone"
      described as {
        |Milestone details.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Addition time.
      }
    }
  } with {
    briefly "Milestone added"
    described as {
      |Emitted when a milestone is added.
    }
  }
  event MilestoneUpdated is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    milestoneId: MilestoneId with {
      briefly "Milestone"
      described as {
        |Milestone ID.
      }
    }
    newStatus: MilestoneStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Milestone updated"
    described as {
      |Emitted when a milestone is updated.
    }
  }
  event BoardSeatAssigned is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    boardSeat: BoardSeatInfo with {
      briefly "Seat"
      described as {
        |Board seat info.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Board seat assigned"
    described as {
      |Emitted when a board seat is assigned.
    }
  }
  event BoardSeatRemoved is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    seatId: BoardSeatId with {
      briefly "Seat"
      described as {
        |Board seat ID.
      }
    }
    removedAt: TimeStamp with {
      briefly "Removed"
      described as {
        |Removal time.
      }
    }
  } with {
    briefly "Board seat removed"
    described as {
      |Emitted when a board seat is removed.
    }
  }
  event FollowOnRecorded is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    followOn: FollowOnRound with {
      briefly "Follow-on"
      described as {
        |Follow-on details.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Follow-on recorded"
    described as {
      |Emitted when a follow-on round is recorded.
    }
  }
  event FollowOnDeclined is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    roundStage: InvestmentStage with {
      briefly "Stage"
      described as {
        |Round stage.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Decline reason.
      }
    }
    declinedAt: TimeStamp with {
      briefly "Declined"
      described as {
        |Decline time.
      }
    }
  } with {
    briefly "Follow-on declined"
    described as {
      |Emitted when follow-on participation is declined.
    }
  }
  event MetricRecorded is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    metric: PortfolioMetric with {
      briefly "Metric"
      described as {
        |Performance metric.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Metric recorded"
    described as {
      |Emitted when a performance metric is recorded.
    }
  }
  event InvestmentMarkedDown is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    newValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |New valuation.
      }
    }
    markedDownAt: TimeStamp with {
      briefly "Marked down"
      described as {
        |Markdown time.
      }
    }
  } with {
    briefly "Investment marked down"
    described as {
      |Emitted when investment is marked down.
    }
  }
  event ExitRecorded is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    exitInfo: ExitDetails with {
      briefly "Exit"
      described as {
        |Exit details.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Exit recorded"
    described as {
      |Emitted when an investment exit is recorded.
    }
  }
  event InvestmentWrittenOff is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writtenOffAt: TimeStamp with {
      briefly "Written off"
      described as {
        |Write-off time.
      }
    }
  } with {
    briefly "Investment written off"
    described as {
      |Emitted when an investment is written off.
    }
  }
  // States
  record ActiveInvestmentData is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    companyInfo: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Investment terms.
      }
    }
    investmentStatus: InvestmentStatus with {
      briefly "Status"
      described as {
        |Investment status.
      }
    }
    milestones: MilestoneInfo* with {
      briefly "Milestones"
      described as {
        |Company milestones.
      }
    }
    boardSeats: BoardSeatInfo* with {
      briefly "Board seats"
      described as {
        |Board seat assignments.
      }
    }
    followOnRounds: FollowOnRound* with {
      briefly "Follow-ons"
      described as {
        |Follow-on rounds.
      }
    }
    metrics: PortfolioMetric* with {
      briefly "Metrics"
      described as {
        |Performance metrics.
      }
    }
    currentValuation: Decimal(14,2) with {
      briefly "Valuation"
      described as {
        |Current valuation.
      }
    }
    totalInvested: Decimal(14,2) with {
      briefly "Total invested"
      described as {
        |Total amount invested.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active investment state"
    described as {
      |State for an active portfolio investment.
    }
  }
  record ExitedInvestmentData is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    companyInfo: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    exitInfo: ExitDetails with {
      briefly "Exit"
      described as {
        |Exit details.
      }
    }
    totalInvested: Decimal(14,2) with {
      briefly "Total invested"
      described as {
        |Total amount invested.
      }
    }
    exitedAt: TimeStamp with {
      briefly "Exited"
      described as {
        |Exit time.
      }
    }
  } with {
    briefly "Exited investment state"
    described as {
      |State for an exited portfolio investment.
    }
  }
  record WrittenOffData is  {
    investmentId: InvestmentId with {
      briefly "Investment"
      described as {
        |Investment ID.
      }
    }
    companyInfo: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    totalInvested: Decimal(14,2) with {
      briefly "Total invested"
      described as {
        |Total amount invested.
      }
    }
    reason: String(3,1000) with {
      briefly "Reason"
      described as {
        |Write-off reason.
      }
    }
    writtenOffAt: TimeStamp with {
      briefly "Written off"
      described as {
        |Write-off time.
      }
    }
  } with {
    briefly "Written-off state"
    described as {
      |State for a written-off investment.
    }
  }
  state ActiveInvestment of type PortfolioInvestment.ActiveInvestmentData
  state ExitedInvestment of type PortfolioInvestment.ExitedInvestmentData
  state WrittenOffInvestment of type PortfolioInvestment.WrittenOffData
  handler PortfolioInvestmentHandler is {
    on command RecordInvestment is {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.ActiveInvestment with command RecordInvestment
      tell event InvestmentRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AdvanceDueDiligence is {
      tell event DueDiligenceAdvanced to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AddMilestone is {
      tell event MilestoneAdded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command UpdateMilestone is {
      tell event MilestoneUpdated to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AssignBoardSeat is {
      tell event BoardSeatAssigned to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RemoveBoardSeat is {
      tell event BoardSeatRemoved to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordFollowOn is {
      tell event FollowOnRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command DeclineFollowOn is {
      tell event FollowOnDeclined to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordMetric is {
      tell event MetricRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command MarkDown is {
      tell event InvestmentMarkedDown to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordExit is {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.ExitedInvestment with command RecordExit
      tell event ExitRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command WriteOff is {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.WrittenOffInvestment with command WriteOff
      tell event InvestmentWrittenOff to entity VCPortfolioContext.PortfolioInvestment
    }
  } with {
    briefly "Processes portfolio investment commands"
    described as {
      |Handles portfolio investment lifecycle.
    }
  }
} with {
  briefly "PortfolioInvestment aggregate"
  described as {
    |Manages venture capital portfolio investments.
  }
}
