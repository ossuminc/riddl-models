// Portfolio Management - PortfolioInvestment Entity

entity PortfolioInvestment is {

  command RecordInvestment is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "New investment identifier."
    }
    companyInfo is CompanyInfo with {
      briefly "Company info"
      described by "Portfolio company details."
    }
    terms is InvestmentTerms with {
      briefly "Terms"
      described by "Investment terms."
    }
  } with {
    briefly "Record investment"
    described by "Records a new portfolio investment."
  }

  command AdvanceDueDiligence is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    findings is String(3, 2000) with {
      briefly "Findings"
      described by "Due diligence findings."
    }
  } with {
    briefly "Advance due diligence"
    described by "Records due diligence progress."
  }

  command AddMilestone is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    milestone is MilestoneInfo with {
      briefly "Milestone"
      described by "Milestone details."
    }
  } with {
    briefly "Add milestone"
    described by "Adds a milestone to the investment."
  }

  command UpdateMilestone is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    milestoneId is MilestoneId with {
      briefly "Milestone ID"
      described by "Milestone identifier."
    }
    newStatus is MilestoneStatus with {
      briefly "Status"
      described by "Updated milestone status."
    }
    completedDate is optional Date with {
      briefly "Completed"
      described by "Completion date if achieved."
    }
  } with {
    briefly "Update milestone"
    described by "Updates a milestone status."
  }

  command AssignBoardSeat is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    boardSeat is BoardSeatInfo with {
      briefly "Board seat"
      described by "Board seat assignment."
    }
  } with {
    briefly "Assign board seat"
    described by "Assigns a board seat representative."
  }

  command RemoveBoardSeat is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    seatId is BoardSeatId with {
      briefly "Seat ID"
      described by "Board seat to remove."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Reason for removal."
    }
  } with {
    briefly "Remove board seat"
    described by "Removes a board seat assignment."
  }

  command RecordFollowOn is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    followOn is FollowOnRound with {
      briefly "Follow-on"
      described by "Follow-on round details."
    }
  } with {
    briefly "Record follow-on"
    described by "Records a follow-on funding round."
  }

  command DeclineFollowOn is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    roundStage is InvestmentStage with {
      briefly "Stage"
      described by "Round stage declined."
    }
    reason is String(3, 1000) with {
      briefly "Reason"
      described by "Reason for declining."
    }
  } with {
    briefly "Decline follow-on"
    described by "Declines participation in follow-on round."
  }

  command RecordMetric is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    metric is PortfolioMetric with {
      briefly "Metric"
      described by "Performance metric."
    }
  } with {
    briefly "Record metric"
    described by "Records a portfolio performance metric."
  }

  command MarkDown is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    newValuation is Decimal(14, 2) with {
      briefly "Valuation"
      described by "New marked-down valuation."
    }
    reason is String(3, 1000) with {
      briefly "Reason"
      described by "Reason for markdown."
    }
  } with {
    briefly "Mark down"
    described by "Marks down the investment valuation."
  }

  command RecordExit is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    exitInfo is ExitDetails with {
      briefly "Exit"
      described by "Exit details."
    }
  } with {
    briefly "Record exit"
    described by "Records the investment exit."
  }

  command WriteOff is {
    investmentId is InvestmentId with {
      briefly "Investment ID"
      described by "Investment identifier."
    }
    reason is String(3, 1000) with {
      briefly "Reason"
      described by "Write-off reason."
    }
    writeOffDate is Date with {
      briefly "Date"
      described by "Write-off date."
    }
  } with {
    briefly "Write off"
    described by "Writes off the investment as a loss."
  }

  // Events
  event InvestmentRecorded is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    companyInfo is CompanyInfo with { briefly "Company" described by "Company info." }
    terms is InvestmentTerms with { briefly "Terms" described by "Investment terms." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Investment recorded"
    described by "Emitted when a new investment is recorded."
  }

  event DueDiligenceAdvanced is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    findings is String(3, 2000) with { briefly "Findings" described by "DD findings." }
    advancedAt is TimeStamp with { briefly "Advanced" described by "Advancement time." }
  } with {
    briefly "Due diligence advanced"
    described by "Emitted when due diligence progresses."
  }

  event MilestoneAdded is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    milestone is MilestoneInfo with { briefly "Milestone" described by "Milestone details." }
    addedAt is TimeStamp with { briefly "Added" described by "Addition time." }
  } with {
    briefly "Milestone added"
    described by "Emitted when a milestone is added."
  }

  event MilestoneUpdated is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    milestoneId is MilestoneId with { briefly "Milestone" described by "Milestone ID." }
    newStatus is MilestoneStatus with { briefly "Status" described by "New status." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Milestone updated"
    described by "Emitted when a milestone is updated."
  }

  event BoardSeatAssigned is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    boardSeat is BoardSeatInfo with { briefly "Seat" described by "Board seat info." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Board seat assigned"
    described by "Emitted when a board seat is assigned."
  }

  event BoardSeatRemoved is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    seatId is BoardSeatId with { briefly "Seat" described by "Board seat ID." }
    removedAt is TimeStamp with { briefly "Removed" described by "Removal time." }
  } with {
    briefly "Board seat removed"
    described by "Emitted when a board seat is removed."
  }

  event FollowOnRecorded is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    followOn is FollowOnRound with { briefly "Follow-on" described by "Follow-on details." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Follow-on recorded"
    described by "Emitted when a follow-on round is recorded."
  }

  event FollowOnDeclined is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    roundStage is InvestmentStage with { briefly "Stage" described by "Round stage." }
    reason is String(3, 1000) with { briefly "Reason" described by "Decline reason." }
    declinedAt is TimeStamp with { briefly "Declined" described by "Decline time." }
  } with {
    briefly "Follow-on declined"
    described by "Emitted when follow-on participation is declined."
  }

  event MetricRecorded is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    metric is PortfolioMetric with { briefly "Metric" described by "Performance metric." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Metric recorded"
    described by "Emitted when a performance metric is recorded."
  }

  event InvestmentMarkedDown is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    newValuation is Decimal(14, 2) with { briefly "Valuation" described by "New valuation." }
    markedDownAt is TimeStamp with { briefly "Marked down" described by "Markdown time." }
  } with {
    briefly "Investment marked down"
    described by "Emitted when investment is marked down."
  }

  event ExitRecorded is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    exitInfo is ExitDetails with { briefly "Exit" described by "Exit details." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Exit recorded"
    described by "Emitted when an investment exit is recorded."
  }

  event InvestmentWrittenOff is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    reason is String(3, 1000) with { briefly "Reason" described by "Write-off reason." }
    writtenOffAt is TimeStamp with { briefly "Written off" described by "Write-off time." }
  } with {
    briefly "Investment written off"
    described by "Emitted when an investment is written off."
  }

  // States
  record ActiveInvestmentData is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    companyInfo is CompanyInfo with { briefly "Company" described by "Company info." }
    terms is InvestmentTerms with { briefly "Terms" described by "Investment terms." }
    investmentStatus is InvestmentStatus with { briefly "Status" described by "Investment status." }
    milestones is many optional MilestoneInfo with { briefly "Milestones" described by "Company milestones." }
    boardSeats is many optional BoardSeatInfo with { briefly "Board seats" described by "Board seat assignments." }
    followOnRounds is many optional FollowOnRound with { briefly "Follow-ons" described by "Follow-on rounds." }
    metrics is many optional PortfolioMetric with { briefly "Metrics" described by "Performance metrics." }
    currentValuation is Decimal(14, 2) with { briefly "Valuation" described by "Current valuation." }
    totalInvested is Decimal(14, 2) with { briefly "Total invested" described by "Total amount invested." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active investment state"
    described by "State for an active portfolio investment."
  }

  record ExitedInvestmentData is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    companyInfo is CompanyInfo with { briefly "Company" described by "Company info." }
    exitInfo is ExitDetails with { briefly "Exit" described by "Exit details." }
    totalInvested is Decimal(14, 2) with { briefly "Total invested" described by "Total amount invested." }
    exitedAt is TimeStamp with { briefly "Exited" described by "Exit time." }
  } with {
    briefly "Exited investment state"
    described by "State for an exited portfolio investment."
  }

  record WrittenOffData is {
    investmentId is InvestmentId with { briefly "Investment" described by "Investment ID." }
    companyInfo is CompanyInfo with { briefly "Company" described by "Company info." }
    totalInvested is Decimal(14, 2) with { briefly "Total invested" described by "Total amount invested." }
    reason is String(3, 1000) with { briefly "Reason" described by "Write-off reason." }
    writtenOffAt is TimeStamp with { briefly "Written off" described by "Write-off time." }
  } with {
    briefly "Written-off state"
    described by "State for a written-off investment."
  }

  state ActiveInvestment of PortfolioInvestment.ActiveInvestmentData with {
    briefly "Investment active"
    described by "Portfolio investment is actively managed."
  }

  state ExitedInvestment of PortfolioInvestment.ExitedInvestmentData with {
    briefly "Investment exited"
    described by "Portfolio investment has been exited."
  }

  state WrittenOffInvestment of PortfolioInvestment.WrittenOffData with {
    briefly "Investment written off"
    described by "Portfolio investment has been written off."
  }

  handler PortfolioInvestmentHandler is {
    on command RecordInvestment {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.ActiveInvestment with command RecordInvestment
      tell event InvestmentRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AdvanceDueDiligence {
      tell event DueDiligenceAdvanced to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AddMilestone {
      tell event MilestoneAdded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command UpdateMilestone {
      tell event MilestoneUpdated to entity VCPortfolioContext.PortfolioInvestment
    }
    on command AssignBoardSeat {
      tell event BoardSeatAssigned to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RemoveBoardSeat {
      tell event BoardSeatRemoved to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordFollowOn {
      tell event FollowOnRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command DeclineFollowOn {
      tell event FollowOnDeclined to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordMetric {
      tell event MetricRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command MarkDown {
      tell event InvestmentMarkedDown to entity VCPortfolioContext.PortfolioInvestment
    }
    on command RecordExit {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.ExitedInvestment with command RecordExit
      tell event ExitRecorded to entity VCPortfolioContext.PortfolioInvestment
    }
    on command WriteOff {
      morph entity VCPortfolioContext.PortfolioInvestment to state VCPortfolioContext.PortfolioInvestment.WrittenOffInvestment with command WriteOff
      tell event InvestmentWrittenOff to entity VCPortfolioContext.PortfolioInvestment
    }
  } with {
    briefly "Processes portfolio investment commands"
    described by "Handles portfolio investment lifecycle."
  }

} with {
  briefly "PortfolioInvestment aggregate"
  described by "Manages venture capital portfolio investments."
}
