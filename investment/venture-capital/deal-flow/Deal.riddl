// Deal Flow - Deal Entity
entity Deal is {
  // Commands
  command CreateDeal is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |New deal identifier.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company information.
      }
    }
    founders: FounderInfo+ with {
      briefly "Founders"
      described as {
        |Founder information.
      }
    }
    round: RoundDetails with {
      briefly "Round"
      described as {
        |Round details.
      }
    }
    source: DealSource with {
      briefly "Source"
      described as {
        |Deal source.
      }
    }
    referredBy: String(1,200)? with {
      briefly "Referred by"
      described as {
        |Referral source.
      }
    }
    assignedTo: String(1,200) with {
      briefly "Assigned to"
      described as {
        |Team member assigned.
      }
    }
  } with {
    briefly "Create deal"
    described as {
      |Creates a new deal in pipeline.
    }
  }
  command UpdateMetrics is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    metrics: Metrics with {
      briefly "Metrics"
      described as {
        |Company metrics.
      }
    }
  } with {
    briefly "Update metrics"
    described as {
      |Updates company metrics.
    }
  }
  command AddNote is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    content: String(1,5000) with {
      briefly "Content"
      described as {
        |Note content.
      }
    }
    author: String(1,200) with {
      briefly "Author"
      described as {
        |Note author.
      }
    }
  } with {
    briefly "Add note"
    described as {
      |Adds note to deal.
    }
  }
  command RecordMeeting is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    meeting: MeetingRecord with {
      briefly "Meeting"
      described as {
        |Meeting record.
      }
    }
  } with {
    briefly "Record meeting"
    described as {
      |Records meeting with company.
    }
  }
  command AdvanceStage is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    newStage: DealStage with {
      briefly "Stage"
      described as {
        |New deal stage.
      }
    }
    advancementReason: String(1,1000)? with {
      briefly "Reason"
      described as {
        |Reason for advancement.
      }
    }
  } with {
    briefly "Advance stage"
    described as {
      |Advances deal to next stage.
    }
  }
  command SetPriority is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    priority: Priority with {
      briefly "Priority"
      described as {
        |Deal priority.
      }
    }
  } with {
    briefly "Set priority"
    described as {
      |Sets deal priority.
    }
  }
  command WriteThesis is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    thesis: InvestmentThesis with {
      briefly "Thesis"
      described as {
        |Investment thesis.
      }
    }
  } with {
    briefly "Write thesis"
    described as {
      |Documents investment thesis.
    }
  }
  command ProposeTerms is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Proposed terms.
      }
    }
  } with {
    briefly "Propose terms"
    described as {
      |Proposes investment terms.
    }
  }
  command IssueTermSheet is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Term sheet terms.
      }
    }
    expirationDate: Date with {
      briefly "Expiration"
      described as {
        |Term sheet expiration.
      }
    }
  } with {
    briefly "Issue term sheet"
    described as {
      |Issues term sheet.
    }
  }
  command RecordTermSheetResponse is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    accepted: Boolean with {
      briefly "Accepted"
      described as {
        |Whether accepted.
      }
    }
    feedback: String(1,2000)? with {
      briefly "Feedback"
      described as {
        |Response feedback.
      }
    }
  } with {
    briefly "Record response"
    described as {
      |Records term sheet response.
    }
  }
  command CloseDeal is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    finalTerms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Final terms.
      }
    }
    closingDate: Date with {
      briefly "Closing"
      described as {
        |Closing date.
      }
    }
  } with {
    briefly "Close deal"
    described as {
      |Closes the investment.
    }
  }
  command PassOnDeal is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    reason: String(1,2000) with {
      briefly "Reason"
      described as {
        |Pass reason.
      }
    }
    passedBy: String(1,200) with {
      briefly "Passed by"
      described as {
        |Who made decision.
      }
    }
  } with {
    briefly "Pass on deal"
    described as {
      |Passes on the opportunity.
    }
  }
  command MarkWithdrawn is  {
    dealId: DealId with {
      briefly "Deal ID"
      described as {
        |Deal identifier.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
  } with {
    briefly "Mark withdrawn"
    described as {
      |Marks deal as withdrawn.
    }
  }
  // Events
  event DealCreated is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    founders: FounderInfo+ with {
      briefly "Founders"
      described as {
        |Founder info.
      }
    }
    round: RoundDetails with {
      briefly "Round"
      described as {
        |Round details.
      }
    }
    source: DealSource with {
      briefly "Source"
      described as {
        |Deal source.
      }
    }
    assignedTo: String(1,200) with {
      briefly "Assigned"
      described as {
        |Assigned to.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Deal created"
    described as {
      |Emitted when deal is created.
    }
  }
  event MetricsUpdated is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    metrics: Metrics with {
      briefly "Metrics"
      described as {
        |Updated metrics.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Metrics updated"
    described as {
      |Emitted when metrics are updated.
    }
  }
  event NoteAdded is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    note: DealNote with {
      briefly "Note"
      described as {
        |Added note.
      }
    }
  } with {
    briefly "Note added"
    described as {
      |Emitted when note is added.
    }
  }
  event MeetingRecorded is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    meeting: MeetingRecord with {
      briefly "Meeting"
      described as {
        |Meeting record.
      }
    }
  } with {
    briefly "Meeting recorded"
    described as {
      |Emitted when meeting is recorded.
    }
  }
  event StageAdvanced is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    previousStage: DealStage with {
      briefly "Previous"
      described as {
        |Previous stage.
      }
    }
    newStage: DealStage with {
      briefly "New"
      described as {
        |New stage.
      }
    }
    advancedAt: TimeStamp with {
      briefly "Advanced"
      described as {
        |Advance time.
      }
    }
  } with {
    briefly "Stage advanced"
    described as {
      |Emitted when stage changes.
    }
  }
  event PrioritySet is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    priority: Priority with {
      briefly "Priority"
      described as {
        |New priority.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Priority set"
    described as {
      |Emitted when priority is set.
    }
  }
  event ThesisWritten is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    thesis: InvestmentThesis with {
      briefly "Thesis"
      described as {
        |Investment thesis.
      }
    }
    writtenAt: TimeStamp with {
      briefly "Written"
      described as {
        |Write time.
      }
    }
  } with {
    briefly "Thesis written"
    described as {
      |Emitted when thesis is written.
    }
  }
  event TermsProposed is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Proposed terms.
      }
    }
    proposedAt: TimeStamp with {
      briefly "Proposed"
      described as {
        |Proposal time.
      }
    }
  } with {
    briefly "Terms proposed"
    described as {
      |Emitted when terms are proposed.
    }
  }
  event TermSheetIssued is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    terms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Term sheet terms.
      }
    }
    expirationDate: Date with {
      briefly "Expiration"
      described as {
        |Expiration date.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Term sheet issued"
    described as {
      |Emitted when term sheet is issued.
    }
  }
  event TermSheetResponseReceived is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    accepted: Boolean with {
      briefly "Accepted"
      described as {
        |Whether accepted.
      }
    }
    feedback: String(1,2000)? with {
      briefly "Feedback"
      described as {
        |Response feedback.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Response time.
      }
    }
  } with {
    briefly "Term sheet response received"
    described as {
      |Emitted when response is received.
    }
  }
  event DealClosed is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    finalTerms: InvestmentTerms with {
      briefly "Terms"
      described as {
        |Final terms.
      }
    }
    closingDate: Date with {
      briefly "Closing"
      described as {
        |Closing date.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Deal closed"
    described as {
      |Emitted when deal closes.
    }
  }
  event DealPassed is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    reason: String(1,2000) with {
      briefly "Reason"
      described as {
        |Pass reason.
      }
    }
    passedBy: String(1,200) with {
      briefly "Passed by"
      described as {
        |Decision maker.
      }
    }
    passedAt: TimeStamp with {
      briefly "Passed"
      described as {
        |Pass time.
      }
    }
  } with {
    briefly "Deal passed"
    described as {
      |Emitted when deal is passed.
    }
  }
  event DealWithdrawn is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    reason: String(1,1000) with {
      briefly "Reason"
      described as {
        |Withdrawal reason.
      }
    }
    withdrawnAt: TimeStamp with {
      briefly "Withdrawn"
      described as {
        |Withdrawal time.
      }
    }
  } with {
    briefly "Deal withdrawn"
    described as {
      |Emitted when deal is withdrawn.
    }
  }
  // State Records
  record ActiveStateData is  {
    dealId: DealId with {
      briefly "Deal"
      described as {
        |Deal ID.
      }
    }
    company: CompanyInfo with {
      briefly "Company"
      described as {
        |Company info.
      }
    }
    founders: FounderInfo+ with {
      briefly "Founders"
      described as {
        |Founder info.
      }
    }
    round: RoundDetails with {
      briefly "Round"
      described as {
        |Round details.
      }
    }
    source: DealSource with {
      briefly "Source"
      described as {
        |Deal source.
      }
    }
    assignedTo: String(1,200) with {
      briefly "Assigned"
      described as {
        |Assigned to.
      }
    }
    stage: DealStage with {
      briefly "Stage"
      described as {
        |Current stage.
      }
    }
    priority: Priority with {
      briefly "Priority"
      described as {
        |Deal priority.
      }
    }
    currentMetrics: Metrics? with {
      briefly "Metrics"
      described as {
        |Company metrics.
      }
    }
    currentThesis: InvestmentThesis? with {
      briefly "Thesis"
      described as {
        |Investment thesis.
      }
    }
    proposedTerms: InvestmentTerms? with {
      briefly "Terms"
      described as {
        |Proposed terms.
      }
    }
    dealNotes: DealNote* with {
      briefly "Notes"
      described as {
        |Deal notes.
      }
    }
    meetings: MeetingRecord* with {
      briefly "Meetings"
      described as {
        |Meeting records.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active state"
    described as {
      |State for active deal.
    }
  }
  // States
  state ActiveState of type Deal.ActiveStateData
  // Handler
  handler DealHandler is {
    on command CreateDeal is {
      morph entity DealContext.Deal to state DealContext.Deal.ActiveState with command CreateDeal
      tell event DealCreated to entity DealContext.Deal
    }
    on command UpdateMetrics is {
      tell event MetricsUpdated to entity DealContext.Deal
    }
    on command AddNote is {
      tell event NoteAdded to entity DealContext.Deal
    }
    on command RecordMeeting is {
      tell event MeetingRecorded to entity DealContext.Deal
    }
    on command AdvanceStage is {
      tell event StageAdvanced to entity DealContext.Deal
    }
    on command SetPriority is {
      tell event PrioritySet to entity DealContext.Deal
    }
    on command WriteThesis is {
      tell event ThesisWritten to entity DealContext.Deal
    }
    on command ProposeTerms is {
      tell event TermsProposed to entity DealContext.Deal
    }
    on command IssueTermSheet is {
      tell event TermSheetIssued to entity DealContext.Deal
    }
    on command RecordTermSheetResponse is {
      tell event TermSheetResponseReceived to entity DealContext.Deal
    }
    on command CloseDeal is {
      tell event DealClosed to entity DealContext.Deal
    }
    on command PassOnDeal is {
      tell event DealPassed to entity DealContext.Deal
    }
    on command MarkWithdrawn is {
      tell event DealWithdrawn to entity DealContext.Deal
    }
  } with {
    briefly "Processes deal commands"
    described as {
      | Handles deal lifecycle from sourcing
      | through evaluation and investment.
    }
  }
} with {
  briefly "Deal aggregate"
  described as {
    | The Deal entity manages investment opportunities
    | through the evaluation pipeline.
  }
}
