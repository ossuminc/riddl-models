// Deal Flow - Deal Entity

entity Deal is {

  // Commands
  command CreateDeal is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "New deal identifier."
    }
    company is CompanyInfo with {
      briefly "Company"
      described by "Company information."
    }
    founders is many FounderInfo with {
      briefly "Founders"
      described by "Founder information."
    }
    round is RoundDetails with {
      briefly "Round"
      described by "Round details."
    }
    source is DealSource with {
      briefly "Source"
      described by "Deal source."
    }
    referredBy is optional String(1, 200) with {
      briefly "Referred by"
      described by "Referral source."
    }
    assignedTo is String(1, 200) with {
      briefly "Assigned to"
      described by "Team member assigned."
    }
  } with {
    briefly "Create deal"
    described by "Creates a new deal in pipeline."
  }

  command UpdateMetrics is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    metrics is Metrics with {
      briefly "Metrics"
      described by "Company metrics."
    }
  } with {
    briefly "Update metrics"
    described by "Updates company metrics."
  }

  command AddNote is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    content is String(1, 5000) with {
      briefly "Content"
      described by "Note content."
    }
    author is String(1, 200) with {
      briefly "Author"
      described by "Note author."
    }
  } with {
    briefly "Add note"
    described by "Adds note to deal."
  }

  command RecordMeeting is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    meeting is MeetingRecord with {
      briefly "Meeting"
      described by "Meeting record."
    }
  } with {
    briefly "Record meeting"
    described by "Records meeting with company."
  }

  command AdvanceStage is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    newStage is DealStage with {
      briefly "Stage"
      described by "New deal stage."
    }
    advancementReason is optional String(1, 1000) with {
      briefly "Reason"
      described by "Reason for advancement."
    }
  } with {
    briefly "Advance stage"
    described by "Advances deal to next stage."
  }

  command SetPriority is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    priority is Priority with {
      briefly "Priority"
      described by "Deal priority."
    }
  } with {
    briefly "Set priority"
    described by "Sets deal priority."
  }

  command WriteThesis is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    thesis is InvestmentThesis with {
      briefly "Thesis"
      described by "Investment thesis."
    }
  } with {
    briefly "Write thesis"
    described by "Documents investment thesis."
  }

  command ProposeTerms is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    terms is InvestmentTerms with {
      briefly "Terms"
      described by "Proposed terms."
    }
  } with {
    briefly "Propose terms"
    described by "Proposes investment terms."
  }

  command IssueTermSheet is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    terms is InvestmentTerms with {
      briefly "Terms"
      described by "Term sheet terms."
    }
    expirationDate is Date with {
      briefly "Expiration"
      described by "Term sheet expiration."
    }
  } with {
    briefly "Issue term sheet"
    described by "Issues term sheet."
  }

  command RecordTermSheetResponse is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    accepted is Boolean with {
      briefly "Accepted"
      described by "Whether accepted."
    }
    feedback is optional String(1, 2000) with {
      briefly "Feedback"
      described by "Response feedback."
    }
  } with {
    briefly "Record response"
    described by "Records term sheet response."
  }

  command CloseDeal is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    finalTerms is InvestmentTerms with {
      briefly "Terms"
      described by "Final terms."
    }
    closingDate is Date with {
      briefly "Closing"
      described by "Closing date."
    }
  } with {
    briefly "Close deal"
    described by "Closes the investment."
  }

  command PassOnDeal is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    reason is String(1, 2000) with {
      briefly "Reason"
      described by "Pass reason."
    }
    passedBy is String(1, 200) with {
      briefly "Passed by"
      described by "Who made decision."
    }
  } with {
    briefly "Pass on deal"
    described by "Passes on the opportunity."
  }

  command MarkWithdrawn is {
    dealId is DealId with {
      briefly "Deal ID"
      described by "Deal identifier."
    }
    reason is String(1, 1000) with {
      briefly "Reason"
      described by "Withdrawal reason."
    }
  } with {
    briefly "Mark withdrawn"
    described by "Marks deal as withdrawn."
  }

  // Events
  event DealCreated is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    company is CompanyInfo with { briefly "Company" described by "Company info." }
    founders is many FounderInfo with { briefly "Founders" described by "Founder info." }
    round is RoundDetails with { briefly "Round" described by "Round details." }
    source is DealSource with { briefly "Source" described by "Deal source." }
    assignedTo is String(1, 200) with { briefly "Assigned" described by "Assigned to." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Deal created"
    described by "Emitted when deal is created."
  }

  event MetricsUpdated is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    metrics is Metrics with { briefly "Metrics" described by "Updated metrics." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Metrics updated"
    described by "Emitted when metrics are updated."
  }

  event NoteAdded is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    note is DealNote with { briefly "Note" described by "Added note." }
  } with {
    briefly "Note added"
    described by "Emitted when note is added."
  }

  event MeetingRecorded is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    meeting is MeetingRecord with { briefly "Meeting" described by "Meeting record." }
  } with {
    briefly "Meeting recorded"
    described by "Emitted when meeting is recorded."
  }

  event StageAdvanced is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    previousStage is DealStage with { briefly "Previous" described by "Previous stage." }
    newStage is DealStage with { briefly "New" described by "New stage." }
    advancedAt is TimeStamp with { briefly "Advanced" described by "Advance time." }
  } with {
    briefly "Stage advanced"
    described by "Emitted when stage changes."
  }

  event PrioritySet is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    priority is Priority with { briefly "Priority" described by "New priority." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Priority set"
    described by "Emitted when priority is set."
  }

  event ThesisWritten is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    thesis is InvestmentThesis with { briefly "Thesis" described by "Investment thesis." }
    writtenAt is TimeStamp with { briefly "Written" described by "Write time." }
  } with {
    briefly "Thesis written"
    described by "Emitted when thesis is written."
  }

  event TermsProposed is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    terms is InvestmentTerms with { briefly "Terms" described by "Proposed terms." }
    proposedAt is TimeStamp with { briefly "Proposed" described by "Proposal time." }
  } with {
    briefly "Terms proposed"
    described by "Emitted when terms are proposed."
  }

  event TermSheetIssued is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    terms is InvestmentTerms with { briefly "Terms" described by "Term sheet terms." }
    expirationDate is Date with { briefly "Expiration" described by "Expiration date." }
    issuedAt is TimeStamp with { briefly "Issued" described by "Issue time." }
  } with {
    briefly "Term sheet issued"
    described by "Emitted when term sheet is issued."
  }

  event TermSheetResponseReceived is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    accepted is Boolean with { briefly "Accepted" described by "Whether accepted." }
    feedback is optional String(1, 2000) with { briefly "Feedback" described by "Response feedback." }
    receivedAt is TimeStamp with { briefly "Received" described by "Response time." }
  } with {
    briefly "Term sheet response received"
    described by "Emitted when response is received."
  }

  event DealClosed is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    finalTerms is InvestmentTerms with { briefly "Terms" described by "Final terms." }
    closingDate is Date with { briefly "Closing" described by "Closing date." }
    closedAt is TimeStamp with { briefly "Closed" described by "Close time." }
  } with {
    briefly "Deal closed"
    described by "Emitted when deal closes."
  }

  event DealPassed is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    reason is String(1, 2000) with { briefly "Reason" described by "Pass reason." }
    passedBy is String(1, 200) with { briefly "Passed by" described by "Decision maker." }
    passedAt is TimeStamp with { briefly "Passed" described by "Pass time." }
  } with {
    briefly "Deal passed"
    described by "Emitted when deal is passed."
  }

  event DealWithdrawn is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    reason is String(1, 1000) with { briefly "Reason" described by "Withdrawal reason." }
    withdrawnAt is TimeStamp with { briefly "Withdrawn" described by "Withdrawal time." }
  } with {
    briefly "Deal withdrawn"
    described by "Emitted when deal is withdrawn."
  }

  // State Records
  record ActiveStateData is {
    dealId is DealId with { briefly "Deal" described by "Deal ID." }
    company is CompanyInfo with { briefly "Company" described by "Company info." }
    founders is many FounderInfo with { briefly "Founders" described by "Founder info." }
    round is RoundDetails with { briefly "Round" described by "Round details." }
    source is DealSource with { briefly "Source" described by "Deal source." }
    assignedTo is String(1, 200) with { briefly "Assigned" described by "Assigned to." }
    stage is DealStage with { briefly "Stage" described by "Current stage." }
    priority is Priority with { briefly "Priority" described by "Deal priority." }
    currentMetrics is optional Metrics with { briefly "Metrics" described by "Company metrics." }
    currentThesis is optional InvestmentThesis with { briefly "Thesis" described by "Investment thesis." }
    proposedTerms is optional InvestmentTerms with { briefly "Terms" described by "Proposed terms." }
    dealNotes is many optional DealNote with { briefly "Notes" described by "Deal notes." }
    meetings is many optional MeetingRecord with { briefly "Meetings" described by "Meeting records." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active state"
    described by "State for active deal."
  }

  // States
  state ActiveState of Deal.ActiveStateData with {
    briefly "Deal active"
    described by "Deal is in pipeline."
  }

  // Handler
  handler DealHandler is {
    on command CreateDeal {
      morph entity DealContext.Deal to state DealContext.Deal.ActiveState with command CreateDeal
      tell event DealCreated to entity DealContext.Deal
    }

    on command UpdateMetrics {
      tell event MetricsUpdated to entity DealContext.Deal
    }

    on command AddNote {
      tell event NoteAdded to entity DealContext.Deal
    }

    on command RecordMeeting {
      tell event MeetingRecorded to entity DealContext.Deal
    }

    on command AdvanceStage {
      tell event StageAdvanced to entity DealContext.Deal
    }

    on command SetPriority {
      tell event PrioritySet to entity DealContext.Deal
    }

    on command WriteThesis {
      tell event ThesisWritten to entity DealContext.Deal
    }

    on command ProposeTerms {
      tell event TermsProposed to entity DealContext.Deal
    }

    on command IssueTermSheet {
      tell event TermSheetIssued to entity DealContext.Deal
    }

    on command RecordTermSheetResponse {
      tell event TermSheetResponseReceived to entity DealContext.Deal
    }

    on command CloseDeal {
      tell event DealClosed to entity DealContext.Deal
    }

    on command PassOnDeal {
      tell event DealPassed to entity DealContext.Deal
    }

    on command MarkWithdrawn {
      tell event DealWithdrawn to entity DealContext.Deal
    }
  } with {
    briefly "Processes deal commands"
    described by {
      | Handles deal lifecycle from sourcing
      | through evaluation and investment.
    }
  }

} with {
  briefly "Deal aggregate"
  described by {
    | The Deal entity manages investment opportunities
    | through the evaluation pipeline.
  }
}
