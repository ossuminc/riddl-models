// Deal Flow - Deal Context

context DealContext is {

  include "types.riddl"
  include "Deal.riddl"

  // Repository for deal persistence
  repository DealRepository is {
    schema DealData is relational
      of deals as Deal
      index on field Deal.dealId
      index on field Deal.company.companyId
      index on field Deal.stage
      index on field Deal.assignedTo

    handler DealPersistence is {
      on event Deal.DealCreated {
        prompt "Store new deal"
      }
      on event Deal.MetricsUpdated {
        prompt "Update deal metrics"
      }
      on event Deal.NoteAdded {
        prompt "Add note to deal"
      }
      on event Deal.MeetingRecorded {
        prompt "Store meeting record"
      }
      on event Deal.StageAdvanced {
        prompt "Update deal stage"
      }
      on event Deal.PrioritySet {
        prompt "Update deal priority"
      }
      on event Deal.ThesisWritten {
        prompt "Store investment thesis"
      }
      on event Deal.TermsProposed {
        prompt "Store proposed terms"
      }
      on event Deal.TermSheetIssued {
        prompt "Store term sheet"
      }
      on event Deal.TermSheetResponseReceived {
        prompt "Store term sheet response"
      }
      on event Deal.DealClosed {
        prompt "Update to invested"
      }
      on event Deal.DealPassed {
        prompt "Update to passed"
      }
      on event Deal.DealWithdrawn {
        prompt "Update to withdrawn"
      }
    } with {
      briefly "Persists deal events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Deal data persistence"
    described by {
      | The DealRepository provides persistent storage for
      | deals and related data.
    }
  }

  // Projector for deal flow analytics
  projector DealFlowAnalytics is {
    updates repository DealRepository

    record DealFlowStats is {
      totalDeals is Natural with { briefly "Total" described by "Total deals." }
      activeDeals is Natural with { briefly "Active" described by "Active deals." }
      closedDeals is Natural with { briefly "Closed" described by "Closed deals." }
      passedDeals is Natural with { briefly "Passed" described by "Passed deals." }
      totalDeployed is Decimal(12, 2) with { briefly "Deployed" described by "Capital deployed." }
      conversionRate is Decimal(5, 2) with { briefly "Conversion" described by "Conversion rate." }
      avgTimeToClose is Natural with { briefly "Time to close" described by "Average days to close." }
    } with {
      briefly "Deal flow statistics"
      described by "Deal pipeline metrics."
    }

    handler AnalyticsHandler is {
      on event Deal.DealCreated {
        prompt "Update deal counts"
      }
      on event Deal.StageAdvanced {
        prompt "Update stage metrics"
      }
      on event Deal.DealClosed {
        prompt "Update closed metrics and capital deployed"
      }
      on event Deal.DealPassed {
        prompt "Update passed metrics"
      }
    } with {
      briefly "Maintains deal flow analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Deal flow analytics projections"
    described by "Maintains deal pipeline analytics data."
  }

} with {
  briefly "Bounded context for deal flow"
  described by {
    | The DealContext is the bounded context for
    | venture capital deal sourcing and pipeline.
  }
}
