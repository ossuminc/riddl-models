// Deal Flow - Deal Context

context DealContext is {

  include "types.riddl"
  include "Deal.riddl"

  // Repository for deal persistence
  repository DealRepository is {
    schema DealData is relational
      of deals as Deal
      index on field Deal.dealId
      index on field Deal.company.companyId
      index on field Deal.stage
      index on field Deal.assignedTo

    handler DealPersistence is {
      on command Deal.CreateDeal {
        prompt "Store new deal"
      }
      on command Deal.UpdateMetrics {
        prompt "Update deal metrics"
      }
      on command Deal.AddNote {
        prompt "Add note to deal"
      }
      on command Deal.RecordMeeting {
        prompt "Store meeting record"
      }
      on command Deal.AdvanceStage {
        prompt "Update deal stage"
      }
      on command Deal.SetPriority {
        prompt "Update deal priority"
      }
      on command Deal.WriteThesis {
        prompt "Store investment thesis"
      }
      on command Deal.ProposeTerms {
        prompt "Store proposed terms"
      }
      on command Deal.IssueTermSheet {
        prompt "Store term sheet"
      }
      on command Deal.RecordTermSheetResponse {
        prompt "Store term sheet response"
      }
      on command Deal.CloseDeal {
        prompt "Update to invested"
      }
      on command Deal.PassOnDeal {
        prompt "Update to passed"
      }
      on command Deal.MarkWithdrawn {
        prompt "Update to withdrawn"
      }
    } with {
      briefly "Persists deal commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Deal data persistence"
    described by {
      | The DealRepository provides persistent storage for
      | deals and related data.
    }
  }

  // Projector for deal flow analytics
  projector DealFlowAnalytics is {
    updates repository DealRepository

    record DealFlowStats is {
      totalDeals is Natural with { briefly "Total" described by "Total deals." }
      activeDeals is Natural with { briefly "Active" described by "Active deals." }
      closedDeals is Natural with { briefly "Closed" described by "Closed deals." }
      passedDeals is Natural with { briefly "Passed" described by "Passed deals." }
      totalDeployed is Decimal(12, 2) with { briefly "Deployed" described by "Capital deployed." }
      conversionRate is Decimal(5, 2) with { briefly "Conversion" described by "Conversion rate." }
      avgTimeToClose is Natural with { briefly "Time to close" described by "Average days to close." }
    } with {
      briefly "Deal flow statistics"
      described by "Deal pipeline metrics."
    }

    handler AnalyticsHandler is {
      on event Deal.DealCreated {
        prompt "Update deal counts"
      }
      on event Deal.StageAdvanced {
        prompt "Update stage metrics"
      }
      on event Deal.DealClosed {
        prompt "Update closed metrics and capital deployed"
      }
      on event Deal.DealPassed {
        prompt "Update passed metrics"
      }
    } with {
      briefly "Maintains deal flow analytics"
      described by "Projects events into analytics views."
    }
  } with {
    briefly "Deal flow analytics projections"
    described by "Maintains deal pipeline analytics data."
  }

} with {
  briefly "Bounded context for deal flow"
  described by {
    | The DealContext is the bounded context for
    | venture capital deal sourcing and pipeline.
  }
}
