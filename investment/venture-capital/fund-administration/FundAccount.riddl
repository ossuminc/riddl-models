// Fund Administration - FundAccount Entity
entity FundAccount is {
  command CreateFundAccount is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |New fund account identifier.
      }
    }
    fundInfo: FundInfo with {
      briefly "Fund info"
      described as {
        |Venture capital fund details.
      }
    }
    partners: PartnerCommitment+ with {
      briefly "Partners"
      described as {
        |Initial limited partner commitments.
      }
    }
  } with {
    briefly "Create fund account"
    described as {
      |Creates a new fund account for administration.
    }
  }
  command IssueCapitalCall is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    callInfo: CapitalCallInfo with {
      briefly "Call info"
      described as {
        |Capital call details.
      }
    }
  } with {
    briefly "Issue capital call"
    described as {
      |Issues a capital call to limited partners.
    }
  }
  command RecordCallPayment is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    callId: TransactionId with {
      briefly "Call ID"
      described as {
        |Capital call identifier.
      }
    }
    partnerId: PartnerId with {
      briefly "Partner"
      described as {
        |Paying partner identifier.
      }
    }
    paymentAmount: MoneyAmount with {
      briefly "Amount"
      described as {
        |Payment amount received.
      }
    }
    paymentDate: Date with {
      briefly "Payment date"
      described as {
        |Date payment was received.
      }
    }
  } with {
    briefly "Record call payment"
    described as {
      |Records a capital call payment from an LP.
    }
  }
  command ProcessDistribution is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    distributionInfo: DistributionInfo with {
      briefly "Distribution"
      described as {
        |Distribution details.
      }
    }
  } with {
    briefly "Process distribution"
    described as {
      |Processes a distribution to limited partners.
    }
  }
  command CalculateNav is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    calculationDate: Date with {
      briefly "Date"
      described as {
        |NAV calculation date.
      }
    }
    totalAssets: MoneyAmount with {
      briefly "Assets"
      described as {
        |Total fund assets.
      }
    }
    totalLiabilities: MoneyAmount with {
      briefly "Liabilities"
      described as {
        |Total fund liabilities.
      }
    }
  } with {
    briefly "Calculate NAV"
    described as {
      |Calculates net asset value of the fund.
    }
  }
  command RecordTransaction is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    transaction: FundTransaction with {
      briefly "Transaction"
      described as {
        |Fund transaction details.
      }
    }
  } with {
    briefly "Record transaction"
    described as {
      |Records a fund accounting transaction.
    }
  }
  command GenerateLpReport is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    reportPeriod: ReportPeriod with {
      briefly "Period"
      described as {
        |Reporting period.
      }
    }
  } with {
    briefly "Generate LP report"
    described as {
      |Generates quarterly report for limited partners.
    }
  }
  command AdvanceFundStage is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    newStatus: FundStatus with {
      briefly "New status"
      described as {
        |New fund lifecycle status.
      }
    }
    effectiveDate: Date with {
      briefly "Effective date"
      described as {
        |Status change effective date.
      }
    }
  } with {
    briefly "Advance fund stage"
    described as {
      |Advances fund to next lifecycle stage.
    }
  }
  command TerminateFund is  {
    accountId: FundAccountId with {
      briefly "Account ID"
      described as {
        |Fund account identifier.
      }
    }
    terminationDate: Date with {
      briefly "Termination date"
      described as {
        |Fund termination date.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Reason for fund termination.
      }
    }
  } with {
    briefly "Terminate fund"
    described as {
      |Terminates the fund and initiates final distributions.
    }
  }
  // Events
  event FundAccountCreated is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Info"
      described as {
        |Fund info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Fund account created"
    described as {
      |Emitted when a fund account is created.
    }
  }
  event CapitalCallIssued is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    callInfo: CapitalCallInfo with {
      briefly "Call"
      described as {
        |Capital call details.
      }
    }
    issuedAt: TimeStamp with {
      briefly "Issued"
      described as {
        |Issue time.
      }
    }
  } with {
    briefly "Capital call issued"
    described as {
      |Emitted when a capital call is issued.
    }
  }
  event CallPaymentReceived is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    callId: TransactionId with {
      briefly "Call"
      described as {
        |Capital call ID.
      }
    }
    partnerId: PartnerId with {
      briefly "Partner"
      described as {
        |Partner ID.
      }
    }
    paymentAmount: MoneyAmount with {
      briefly "Amount"
      described as {
        |Payment amount.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Call payment received"
    described as {
      |Emitted when a capital call payment is received.
    }
  }
  event DistributionProcessed is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    distributionInfo: DistributionInfo with {
      briefly "Distribution"
      described as {
        |Distribution details.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Processing time.
      }
    }
  } with {
    briefly "Distribution processed"
    described as {
      |Emitted when a distribution is processed.
    }
  }
  event NavCalculated is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    navCalculation: NavCalculation with {
      briefly "NAV"
      described as {
        |NAV calculation.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "NAV calculated"
    described as {
      |Emitted when net asset value is calculated.
    }
  }
  event TransactionRecorded is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    transaction: FundTransaction with {
      briefly "Transaction"
      described as {
        |Transaction details.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Transaction recorded"
    described as {
      |Emitted when a fund transaction is recorded.
    }
  }
  event LpReportGenerated is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reportPeriod: ReportPeriod with {
      briefly "Period"
      described as {
        |Report period.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "LP report generated"
    described as {
      |Emitted when an LP report is generated.
    }
  }
  event FundStageAdvanced is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    newStatus: FundStatus with {
      briefly "Status"
      described as {
        |New fund status.
      }
    }
    advancedAt: TimeStamp with {
      briefly "Advanced"
      described as {
        |Advance time.
      }
    }
  } with {
    briefly "Fund stage advanced"
    described as {
      |Emitted when fund advances to a new lifecycle stage.
    }
  }
  event FundTerminated is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    terminationDate: Date with {
      briefly "Date"
      described as {
        |Termination date.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
    terminatedAt: TimeStamp with {
      briefly "Terminated"
      described as {
        |Termination time.
      }
    }
  } with {
    briefly "Fund terminated"
    described as {
      |Emitted when a fund is terminated.
    }
  }
  // States
  record ActiveStateData is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Fund"
      described as {
        |Fund info.
      }
    }
    fundStatus: FundStatus with {
      briefly "Status"
      described as {
        |Fund status.
      }
    }
    partners: PartnerCommitment+ with {
      briefly "Partners"
      described as {
        |LP commitments.
      }
    }
    capitalCalls: CapitalCallInfo* with {
      briefly "Calls"
      described as {
        |Capital calls.
      }
    }
    distributions: DistributionInfo* with {
      briefly "Distributions"
      described as {
        |Distributions.
      }
    }
    transactions: FundTransaction* with {
      briefly "Transactions"
      described as {
        |Fund transactions.
      }
    }
    latestNav: NavCalculation? with {
      briefly "NAV"
      described as {
        |Latest NAV calculation.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active fund state"
    described as {
      |State for an active fund account.
    }
  }
  record TerminatedStateData is  {
    accountId: FundAccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    fundInfo: FundInfo with {
      briefly "Fund"
      described as {
        |Fund info.
      }
    }
    terminationDate: Date with {
      briefly "Terminated"
      described as {
        |Termination date.
      }
    }
    finalNav: NavCalculation with {
      briefly "Final NAV"
      described as {
        |Final NAV calculation.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Termination reason.
      }
    }
  } with {
    briefly "Terminated fund state"
    described as {
      |State for a terminated fund account.
    }
  }
  state ActiveState of type FundAccount.ActiveStateData
  state TerminatedState of type FundAccount.TerminatedStateData
  handler FundAccountHandler is {
    on command CreateFundAccount is {
      morph entity FundAdminContext.FundAccount to state FundAdminContext.FundAccount.ActiveState with command CreateFundAccount
      tell event FundAccountCreated to entity FundAdminContext.FundAccount
    }
    on command IssueCapitalCall is {
      tell event CapitalCallIssued to entity FundAdminContext.FundAccount
    }
    on command RecordCallPayment is {
      tell event CallPaymentReceived to entity FundAdminContext.FundAccount
    }
    on command ProcessDistribution is {
      tell event DistributionProcessed to entity FundAdminContext.FundAccount
    }
    on command CalculateNav is {
      tell event NavCalculated to entity FundAdminContext.FundAccount
    }
    on command RecordTransaction is {
      tell event TransactionRecorded to entity FundAdminContext.FundAccount
    }
    on command GenerateLpReport is {
      tell event LpReportGenerated to entity FundAdminContext.FundAccount
    }
    on command AdvanceFundStage is {
      tell event FundStageAdvanced to entity FundAdminContext.FundAccount
    }
    on command TerminateFund is {
      morph entity FundAdminContext.FundAccount to state FundAdminContext.FundAccount.TerminatedState with command TerminateFund
      tell event FundTerminated to entity FundAdminContext.FundAccount
    }
  } with {
    briefly "Processes fund account commands"
    described as {
      |Handles fund account lifecycle operations.
    }
  }
} with {
  briefly "FundAccount aggregate"
  described as {
    |Manages venture capital fund accounts.
  }
}
