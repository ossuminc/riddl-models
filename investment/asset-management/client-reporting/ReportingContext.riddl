// Client Reporting - Reporting Context

context ReportingContext is {

  include "types.riddl"
  include "ClientReport.riddl"

  repository ReportingRepository is {
    schema ReportingData is relational
      of clientReports as ClientReport
      index on field ClientReport.reportId
      index on field ClientReport.request.clientId
      index on field ClientReport.status

    handler ReportingPersistence is {
      on command ClientReport.GenerateReport {
        prompt "Store new client report request"
      }
      on command ClientReport.AttachPortfolioData {
        prompt "Update report with portfolio data"
      }
      on command ClientReport.CalculatePerformance {
        prompt "Update report with performance metrics"
      }
      on command ClientReport.ApproveReport {
        prompt "Update report approval status"
      }
      on command ClientReport.DistributeReport {
        prompt "Update report to distributed"
      }
    } with {
      briefly "Persists reporting commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Reporting data persistence"
    described by "Persistent storage for client reports."
  }

  projector ReportingMetrics is {
    updates repository ReportingRepository

    record ClientReportMetrics is {
      reportsGenerated is Natural with { briefly "Generated" described by "Reports generated." }
      reportsDistributed is Natural with { briefly "Distributed" described by "Reports distributed." }
      reportsFailed is Natural with { briefly "Failed" described by "Reports failed." }
      averageProcessingTime is Decimal(8, 2) with { briefly "Avg time" described by "Average processing hours." }
    } with {
      briefly "Client report metrics"
      described by "Report processing metrics."
    }

    handler MetricsHandler is {
      on event ClientReport.ReportGenerated {
        prompt "Increment reports generated"
      }
      on event ClientReport.ReportDistributed {
        prompt "Increment reports distributed and calculate time"
      }
      on event ClientReport.ReportFailed {
        prompt "Increment reports failed"
      }
    } with {
      briefly "Maintains reporting metrics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Reporting metrics"
    described by "Client reporting analytics."
  }

} with {
  briefly "Bounded context for client reporting"
  described by "Investment client reporting context."
}
