// Client Reporting - ClientReport Entity
entity ClientReport is {
  command GenerateReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |New report identifier.
      }
    }
    request: ReportRequest with {
      briefly "Request"
      described as {
        |Report generation request.
      }
    }
  } with {
    briefly "Generate report"
    described as {
      |Initiates client report generation.
    }
  }
  command AttachPortfolioData is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    holdings: HoldingRecord+ with {
      briefly "Holdings"
      described as {
        |Portfolio holdings data.
      }
    }
    transactions: TransactionSummary with {
      briefly "Transactions"
      described as {
        |Transaction summary data.
      }
    }
  } with {
    briefly "Attach portfolio data"
    described as {
      |Attaches portfolio holdings and transactions to report.
    }
  }
  command CalculatePerformance is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    performance: PerformanceMetrics with {
      briefly "Performance"
      described as {
        |Calculated performance metrics.
      }
    }
  } with {
    briefly "Calculate performance"
    described as {
      |Attaches calculated performance metrics.
    }
  }
  command ComposeReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    disclosures: RegulatoryDisclosure+ with {
      briefly "Disclosures"
      described as {
        |Regulatory disclosures.
      }
    }
    commentary: String(1,10000)? with {
      briefly "Commentary"
      described as {
        |Portfolio manager commentary.
      }
    }
  } with {
    briefly "Compose report"
    described as {
      |Composes final report with disclosures and commentary.
    }
  }
  command ApproveReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    approvedBy: String(3,100) with {
      briefly "Approved by"
      described as {
        |Person approving the report.
      }
    }
  } with {
    briefly "Approve report"
    described as {
      |Approves report for distribution.
    }
  }
  command DistributeReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    deliveryMethod: DeliveryMethod with {
      briefly "Delivery"
      described as {
        |Delivery method for distribution.
      }
    }
  } with {
    briefly "Distribute report"
    described as {
      |Distributes approved report to client.
    }
  }
  command FailReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
  } with {
    briefly "Fail report"
    described as {
      |Marks report generation as failed.
    }
  }
  command ArchiveReport is  {
    reportId: ClientReportId with {
      briefly "Report ID"
      described as {
        |Report identifier.
      }
    }
  } with {
    briefly "Archive report"
    described as {
      |Archives a distributed report.
    }
  }
  // Events
  event ReportGenerated is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    request: ReportRequest with {
      briefly "Request"
      described as {
        |Report request.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Report generated"
    described as {
      |Emitted when report generation is initiated.
    }
  }
  event PortfolioDataAttached is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    holdingCount: Natural with {
      briefly "Holdings"
      described as {
        |Number of holdings.
      }
    }
    attachedAt: TimeStamp with {
      briefly "Attached"
      described as {
        |Attachment time.
      }
    }
  } with {
    briefly "Portfolio data attached"
    described as {
      |Emitted when portfolio data is attached to report.
    }
  }
  event PerformanceCalculated is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    totalReturn: Decimal(8,4) with {
      briefly "Return"
      described as {
        |Total return.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Performance calculated"
    described as {
      |Emitted when performance metrics are calculated.
    }
  }
  event ReportComposed is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    composedAt: TimeStamp with {
      briefly "Composed"
      described as {
        |Composition time.
      }
    }
  } with {
    briefly "Report composed"
    described as {
      |Emitted when report is fully composed.
    }
  }
  event ReportApproved is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    approvedBy: String(3,100) with {
      briefly "Approver"
      described as {
        |Person who approved.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Report approved"
    described as {
      |Emitted when report is approved for distribution.
    }
  }
  event ReportDistributed is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    deliveryMethod: DeliveryMethod with {
      briefly "Method"
      described as {
        |Delivery method used.
      }
    }
    distributedAt: TimeStamp with {
      briefly "Distributed"
      described as {
        |Distribution time.
      }
    }
  } with {
    briefly "Report distributed"
    described as {
      |Emitted when report is distributed to client.
    }
  }
  event ReportFailed is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Report failed"
    described as {
      |Emitted when report generation fails.
    }
  }
  event ReportArchived is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Report archived"
    described as {
      |Emitted when report is archived.
    }
  }
  // States
  record ActiveStateData is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    request: ReportRequest with {
      briefly "Request"
      described as {
        |Report request.
      }
    }
    status: ReportStatus with {
      briefly "Status"
      described as {
        |Report status.
      }
    }
    content: ReportContent? with {
      briefly "Content"
      described as {
        |Report content.
      }
    }
    reportApprovedBy: String(3,100)? with {
      briefly "Approver"
      described as {
        |Approver name.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active report state"
    described as {
      |State for report being processed.
    }
  }
  record CompletedStateData is  {
    reportId: ClientReportId with {
      briefly "Report"
      described as {
        |Report ID.
      }
    }
    deliveryMethod: DeliveryMethod with {
      briefly "Method"
      described as {
        |Delivery method.
      }
    }
    distributedAt: TimeStamp with {
      briefly "Distributed"
      described as {
        |Distribution time.
      }
    }
  } with {
    briefly "Completed report state"
    described as {
      |State for distributed report.
    }
  }
  state ActiveState of type ClientReport.ActiveStateData
  state CompletedState of type ClientReport.CompletedStateData
  handler ClientReportHandler is {
    on command GenerateReport is {
      morph entity ReportingContext.ClientReport to state ReportingContext.ClientReport.ActiveState with command GenerateReport
      tell event ReportGenerated to entity ReportingContext.ClientReport
    }
    on command AttachPortfolioData is {
      tell event PortfolioDataAttached to entity ReportingContext.ClientReport
    }
    on command CalculatePerformance is {
      tell event PerformanceCalculated to entity ReportingContext.ClientReport
    }
    on command ComposeReport is {
      tell event ReportComposed to entity ReportingContext.ClientReport
    }
    on command ApproveReport is {
      tell event ReportApproved to entity ReportingContext.ClientReport
    }
    on command DistributeReport is {
      morph entity ReportingContext.ClientReport to state ReportingContext.ClientReport.CompletedState with command DistributeReport
      tell event ReportDistributed to entity ReportingContext.ClientReport
    }
    on command FailReport is {
      tell event ReportFailed to entity ReportingContext.ClientReport
    }
    on command ArchiveReport is {
      tell event ReportArchived to entity ReportingContext.ClientReport
    }
  } with {
    briefly "Processes client report commands"
    described as {
      |Handles client report lifecycle.
    }
  }
} with {
  briefly "ClientReport aggregate"
  described as {
    |Manages investment client report generation and distribution.
  }
}
