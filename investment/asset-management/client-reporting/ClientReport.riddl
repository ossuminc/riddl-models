// Client Reporting - ClientReport Entity

entity ClientReport is {

  command GenerateReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "New report identifier."
    }
    request is ReportRequest with {
      briefly "Request"
      described by "Report generation request."
    }
  } with {
    briefly "Generate report"
    described by "Initiates client report generation."
  }

  command AttachPortfolioData is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    holdings is many HoldingRecord with {
      briefly "Holdings"
      described by "Portfolio holdings data."
    }
    transactions is TransactionSummary with {
      briefly "Transactions"
      described by "Transaction summary data."
    }
  } with {
    briefly "Attach portfolio data"
    described by "Attaches portfolio holdings and transactions to report."
  }

  command CalculatePerformance is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    performance is PerformanceMetrics with {
      briefly "Performance"
      described by "Calculated performance metrics."
    }
  } with {
    briefly "Calculate performance"
    described by "Attaches calculated performance metrics."
  }

  command ComposeReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    disclosures is many RegulatoryDisclosure with {
      briefly "Disclosures"
      described by "Regulatory disclosures."
    }
    commentary is optional String(1, 10000) with {
      briefly "Commentary"
      described by "Portfolio manager commentary."
    }
  } with {
    briefly "Compose report"
    described by "Composes final report with disclosures and commentary."
  }

  command ApproveReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    approvedBy is String(3, 100) with {
      briefly "Approved by"
      described by "Person approving the report."
    }
  } with {
    briefly "Approve report"
    described by "Approves report for distribution."
  }

  command DistributeReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    deliveryMethod is DeliveryMethod with {
      briefly "Delivery"
      described by "Delivery method for distribution."
    }
  } with {
    briefly "Distribute report"
    described by "Distributes approved report to client."
  }

  command FailReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Failure reason."
    }
  } with {
    briefly "Fail report"
    described by "Marks report generation as failed."
  }

  command ArchiveReport is {
    reportId is ClientReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
  } with {
    briefly "Archive report"
    described by "Archives a distributed report."
  }

  // Events
  event ReportGenerated is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    request is ReportRequest with { briefly "Request" described by "Report request." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Report generated"
    described by "Emitted when report generation is initiated."
  }

  event PortfolioDataAttached is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    holdingCount is Natural with { briefly "Holdings" described by "Number of holdings." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Portfolio data attached"
    described by "Emitted when portfolio data is attached to report."
  }

  event PerformanceCalculated is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    totalReturn is Decimal(8, 4) with { briefly "Return" described by "Total return." }
    calculatedAt is TimeStamp with { briefly "Calculated" described by "Calculation time." }
  } with {
    briefly "Performance calculated"
    described by "Emitted when performance metrics are calculated."
  }

  event ReportComposed is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    composedAt is TimeStamp with { briefly "Composed" described by "Composition time." }
  } with {
    briefly "Report composed"
    described by "Emitted when report is fully composed."
  }

  event ReportApproved is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    approvedBy is String(3, 100) with { briefly "Approver" described by "Person who approved." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Report approved"
    described by "Emitted when report is approved for distribution."
  }

  event ReportDistributed is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    deliveryMethod is DeliveryMethod with { briefly "Method" described by "Delivery method used." }
    distributedAt is TimeStamp with { briefly "Distributed" described by "Distribution time." }
  } with {
    briefly "Report distributed"
    described by "Emitted when report is distributed to client."
  }

  event ReportFailed is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Report failed"
    described by "Emitted when report generation fails."
  }

  event ReportArchived is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Report archived"
    described by "Emitted when report is archived."
  }

  // States
  record ActiveStateData is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    request is ReportRequest with { briefly "Request" described by "Report request." }
    status is ReportStatus with { briefly "Status" described by "Report status." }
    content is optional ReportContent with { briefly "Content" described by "Report content." }
    reportApprovedBy is optional String(3, 100) with { briefly "Approver" described by "Approver name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active report state"
    described by "State for report being processed."
  }

  record CompletedStateData is {
    reportId is ClientReportId with { briefly "Report" described by "Report ID." }
    deliveryMethod is DeliveryMethod with { briefly "Method" described by "Delivery method." }
    distributedAt is TimeStamp with { briefly "Distributed" described by "Distribution time." }
  } with {
    briefly "Completed report state"
    described by "State for distributed report."
  }

  state ActiveState of ClientReport.ActiveStateData with {
    briefly "Report active"
    described by "Client report is being processed."
  }

  state CompletedState of ClientReport.CompletedStateData with {
    briefly "Report completed"
    described by "Client report has been distributed."
  }

  handler ClientReportHandler is {
    on command GenerateReport {
      morph entity ReportingContext.ClientReport to state ReportingContext.ClientReport.ActiveState with command GenerateReport
      tell event ReportGenerated to entity ReportingContext.ClientReport
    }
    on command AttachPortfolioData {
      tell event PortfolioDataAttached to entity ReportingContext.ClientReport
    }
    on command CalculatePerformance {
      tell event PerformanceCalculated to entity ReportingContext.ClientReport
    }
    on command ComposeReport {
      tell event ReportComposed to entity ReportingContext.ClientReport
    }
    on command ApproveReport {
      tell event ReportApproved to entity ReportingContext.ClientReport
    }
    on command DistributeReport {
      morph entity ReportingContext.ClientReport to state ReportingContext.ClientReport.CompletedState with command DistributeReport
      tell event ReportDistributed to entity ReportingContext.ClientReport
    }
    on command FailReport {
      tell event ReportFailed to entity ReportingContext.ClientReport
    }
    on command ArchiveReport {
      tell event ReportArchived to entity ReportingContext.ClientReport
    }
  } with {
    briefly "Processes client report commands"
    described by "Handles client report lifecycle."
  }

} with {
  briefly "ClientReport aggregate"
  described by "Manages investment client report generation and distribution."
}
