// Fund Context
// Bounded context for fund accounting operations
context FundContext is {
  include "types.riddl"
  include "Fund.riddl"
  // === Repository ===
  repository FundRepository is {
    schema FundData is relational
      of fund as type FundInfo
      of holding as type HoldingRecord
      of investor as type InvestorAccount
      of nav as type NAVRecord
      of transaction as type TransactionRecord
        link fundHolding as field HoldingRecord.fundId to field FundInfo.fundId
        link fundInvestor as field InvestorAccount.fundId to field FundInfo.fundId
        link fundNav as field NAVRecord.fundId to field FundInfo.fundId
        link fundTransaction as field TransactionRecord.fundId to field FundInfo.fundId
        index on field FundInfo.fundId
        index on field NAVRecord.valuationDate
        index on field TransactionRecord.tradeDate
 with {
      briefly "Relational schema for fund data storage"
      described as {
        | Defines the relational structure for persisting fund
        | information, NAV history, transactions, holdings, and
        | investor accounts with appropriate relationships and
        | indexes for efficient querying.
      }
    }
    handler FundRepositoryHandler is {
      on command CreateFund is {
        prompt "Insert new fund record into database"
      } with {
        briefly "Persists new fund creation"
        described as {
          | Handles the persistence of a newly created fund.
        }
      }
      on command CalculateNAV is {
        prompt "Insert NAV record into database"
        prompt "Update fund's latest NAV reference"
      } with {
        briefly "Persists NAV calculation results"
        described as {
          | Stores the calculated NAV and updates the fund's
          | current NAV reference.
        }
      }
      on command RecordTransaction is {
        prompt "Insert transaction record into database"
      } with {
        briefly "Persists fund transactions"
        described as {
          | Stores transaction records for audit and reporting.
        }
      }
      on command UpdateHolding is {
        prompt "Update holding record in database"
      } with {
        briefly "Persists holding updates"
        described as {
          | Updates the stored holding position data.
        }
      }
      on command ProcessSubscription is {
        prompt "Insert or update investor account record"
        prompt "Insert subscription transaction record"
      } with {
        briefly "Persists subscription processing"
        described as {
          | Stores investor account updates and subscription
          | transaction details.
        }
      }
      on command ProcessRedemption is {
        prompt "Update investor account record"
        prompt "Insert redemption transaction record"
      } with {
        briefly "Persists redemption processing"
        described as {
          | Stores investor account updates and redemption
          | transaction details.
        }
      }
      on command SuspendFund is {
        prompt "Update fund status to Suspended"
        prompt "Record suspension reason and date"
      } with {
        briefly "Persists fund suspension"
        described as {
          | Updates fund status and records suspension details.
        }
      }
      on command ResumeFund is {
        prompt "Update fund status to Active"
        prompt "Record resumption date"
      } with {
        briefly "Persists fund resumption"
        described as {
          | Updates fund status to active.
        }
      }
    } with {
      briefly "Event handler for fund persistence"
      described as {
        | Handles persistence of all fund-related events to the
        | repository for durable storage and querying.
      }
    }
  } with {
    briefly "Repository for fund accounting data"
    described as {
      | The FundRepository provides persistent storage for all fund
      | accounting data including fund configuration, NAV history,
      | transactions, holdings, and investor accounts.
    }
  }
  // === Projector ===
  projector FundDashboardProjector is {
    record DashboardRecord is  {
      fundId: FundId with {
        briefly "Fund identifier"
        described as {
          |Fund this dashboard entry is for.
        }
      }
      fundName: String(1,200) with {
        briefly "Fund name"
        described as {
          |Display name of the fund.
        }
      }
      currentNAV: Money with {
        briefly "Current NAV"
        described as {
          |Latest net asset value.
        }
      }
      navPerShare: Price with {
        briefly "NAV per share"
        described as {
          |Latest NAV per share.
        }
      }
      totalAUM: Money with {
        briefly "Total AUM"
        described as {
          |Total assets under management.
        }
      }
      dailyChangePercent: Percentage with {
        briefly "Daily change"
        described as {
          |Daily NAV change percentage.
        }
      }
      ytdReturn: Percentage with {
        briefly "YTD return"
        described as {
          |Year-to-date return.
        }
      }
      investorCount: Natural with {
        briefly "Investor count"
        described as {
          |Number of investors.
        }
      }
      lastUpdated: TimeStamp with {
        briefly "Last updated"
        described as {
          |When dashboard was last refreshed.
        }
      }
    } with {
      briefly "Dashboard projection record"
      described as {
        |Core record for the fund dashboard projector.
      }
    }
    type DashboardSummary is {
      fundId: FundId
      fundName: String(1,200)
      currentNAV: Money
      navPerShare: Price
      totalAUM: Money
      dailyChange: Money
      dailyChangePercent: Percentage
      ytdReturn: Percentage
      investorCount: Natural
      lastUpdated: TimeStamp
    } with {
      briefly "Summary data for fund dashboard"
      described as {
        | Aggregated summary metrics for displaying on fund
        | dashboards and investor portals.
      }
    }
    type PerformanceChart is {
      fundId: FundId
      dataPoints: {
        date: Date
        navPerShare: Price
        cumulativeReturn: Percentage
      }
+
    } with {
      briefly "Time series data for performance charts"
      described as {
        | Historical NAV and return data formatted for chart
        | visualization.
      }
    }
    handler DashboardEventHandler is {
      on event NAVCalculated is {
        prompt "Update dashboard summary with new NAV"
        prompt "Calculate daily change from previous NAV"
        prompt "Append new data point to performance chart"
      } with {
        briefly "Updates dashboard on NAV calculation"
        described as {
          | Projects NAV calculations to dashboard summary and
          | performance chart data.
        }
      }
      on event SubscriptionProcessed is {
        prompt "Update total AUM in dashboard summary"
        prompt "Increment investor count if new investor"
      } with {
        briefly "Updates dashboard on subscription"
        described as {
          | Projects subscription events to update AUM and
          | investor metrics.
        }
      }
      on event RedemptionProcessed is {
        prompt "Update total AUM in dashboard summary"
        prompt "Update investor count if account closed"
      } with {
        briefly "Updates dashboard on redemption"
        described as {
          | Projects redemption events to update AUM metrics.
        }
      }
      on event FundCreated is {
        prompt "Initialize dashboard summary for new fund"
        prompt "Initialize empty performance chart"
      } with {
        briefly "Initializes dashboard for new fund"
        described as {
          | Creates initial dashboard projection entries for
          | a newly created fund.
        }
      }
      on event FundSuspended is {
        prompt "Update dashboard to show suspended status"
      } with {
        briefly "Updates dashboard on fund suspension"
        described as {
          | Projects fund suspension to dashboard display.
        }
      }
      on event FundResumed is {
        prompt "Update dashboard to show active status"
      } with {
        briefly "Updates dashboard on fund resumption"
        described as {
          | Projects fund resumption to dashboard display.
        }
      }
    } with {
      briefly "Event handler for dashboard projections"
      described as {
        | Handles events to maintain dashboard summary and
        | performance chart projections.
      }
    }
  } with {
    briefly "Projector for fund dashboard views"
    described as {
      | The FundDashboardProjector maintains read-optimized views
      | for fund dashboards including summary metrics and
      | performance charts for investor and manager portals.
    }
  }
  // === Reporting Projector ===
  projector RegulatoryReportingProjector is {
    record ReportingRecord is  {
      fundId: FundId with {
        briefly "Fund identifier"
        described as {
          |Fund this report covers.
        }
      }
      reportingPeriod: String(1,20) with {
        briefly "Reporting period"
        described as {
          |Period covered by the report.
        }
      }
      periodEndDate: Date with {
        briefly "Period end date"
        described as {
          |End date of the reporting period.
        }
      }
      totalAssets: Money with {
        briefly "Total assets"
        described as {
          |Total fund assets for the period.
        }
      }
      totalLiabilities: Money with {
        briefly "Total liabilities"
        described as {
          |Total fund liabilities for the period.
        }
      }
      netAssets: Money with {
        briefly "Net assets"
        described as {
          |Net fund assets.
        }
      }
      generatedAt: TimeStamp with {
        briefly "Generated at"
        described as {
          |When this report was generated.
        }
      }
    } with {
      briefly "Regulatory reporting projection record"
      described as {
        |Core record for the regulatory reporting projector.
      }
    }
    type RegulatoryReport is {
      fundId: FundId
      reportingPeriod: String(1,20)
      periodEndDate: Date
      totalAssets: Money
      totalLiabilities: Money
      netAssets: Money
      sharesOutstanding: Quantity
      subscriptions: Money
      redemptions: Money
      netFlow: Money
      managementFeesAccrued: Money
      performanceFeesAccrued: Money
      generatedAt: TimeStamp
    } with {
      briefly "Regulatory reporting data"
      described as {
        | Aggregated data for regulatory filings including
        | periodic reports to SEC, FINRA, and other regulators.
      }
    }
    handler ReportingEventHandler is {
      on event NAVCalculated is {
        prompt "Update period-end NAV figures for regulatory reports"
        prompt "Aggregate daily NAV data for period calculations"
      } with {
        briefly "Projects NAV data to regulatory reports"
        described as {
          | Accumulates NAV data for period-end regulatory reporting.
        }
      }
      on event TransactionRecorded is {
        prompt "Categorize transaction for regulatory reporting"
        prompt "Update period transaction totals"
      } with {
        briefly "Projects transactions to regulatory reports"
        described as {
          | Categorizes and aggregates transactions for regulatory
          | disclosure requirements.
        }
      }
      on event SubscriptionProcessed is {
        prompt "Add to period subscription total"
        prompt "Update net flow calculation"
      } with {
        briefly "Projects subscriptions to regulatory reports"
        described as {
          | Tracks subscription activity for regulatory reporting.
        }
      }
      on event RedemptionProcessed is {
        prompt "Add to period redemption total"
        prompt "Update net flow calculation"
      } with {
        briefly "Projects redemptions to regulatory reports"
        described as {
          | Tracks redemption activity for regulatory reporting.
        }
      }
    } with {
      briefly "Event handler for regulatory report projections"
      described as {
        | Handles events to maintain data required for regulatory
        | filings and compliance reporting.
      }
    }
  } with {
    briefly "Projector for regulatory reporting"
    described as {
      | The RegulatoryReportingProjector maintains data required
      | for regulatory filings including period-end reports,
      | transaction summaries, and compliance metrics.
    }
  }
} with {
  briefly "Bounded context for fund accounting"
  described as {
    | The FundContext is the primary bounded context for fund
    | accounting operations. It contains the Fund entity, repository
    | for persistence, and projectors for dashboard and regulatory
    | reporting views.
  }
}
