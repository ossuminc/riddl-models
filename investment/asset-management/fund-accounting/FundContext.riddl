// Fund Context
// Bounded context for fund accounting operations

context FundContext is {

  include "types.riddl"
  include "Fund.riddl"

  // === Repository ===

  repository FundRepository is {

    schema FundData is relational
      of fund as FundInfo
      of nav as NAVRecord
      of transaction as TransactionRecord
      of holding as HoldingRecord
      of investor as InvestorAccount
      link fundNav as field NAVRecord.fundId to field FundInfo.fundId
      link fundTransaction as field TransactionRecord.fundId to field FundInfo.fundId
      link fundHolding as field HoldingRecord.fundId to field FundInfo.fundId
      link fundInvestor as field InvestorAccount.fundId to field FundInfo.fundId
      index on field FundInfo.fundId
      index on field NAVRecord.valuationDate
      index on field TransactionRecord.tradeDate
    with {
      briefly "Relational schema for fund data storage"
      described by {
        | Defines the relational structure for persisting fund
        | information, NAV history, transactions, holdings, and
        | investor accounts with appropriate relationships and
        | indexes for efficient querying.
      }
    }

    handler FundRepositoryHandler is {
      on event FundCreated is {
        prompt "Insert new fund record into database"
      } with {
        briefly "Persists new fund creation"
        described by {
          | Handles the persistence of a newly created fund.
        }
      }

      on event NAVCalculated is {
        prompt "Insert NAV record into database"
        prompt "Update fund's latest NAV reference"
      } with {
        briefly "Persists NAV calculation results"
        described by {
          | Stores the calculated NAV and updates the fund's
          | current NAV reference.
        }
      }

      on event TransactionRecorded is {
        prompt "Insert transaction record into database"
      } with {
        briefly "Persists fund transactions"
        described by {
          | Stores transaction records for audit and reporting.
        }
      }

      on event HoldingUpdated is {
        prompt "Update holding record in database"
      } with {
        briefly "Persists holding updates"
        described by {
          | Updates the stored holding position data.
        }
      }

      on event SubscriptionProcessed is {
        prompt "Insert or update investor account record"
        prompt "Insert subscription transaction record"
      } with {
        briefly "Persists subscription processing"
        described by {
          | Stores investor account updates and subscription
          | transaction details.
        }
      }

      on event RedemptionProcessed is {
        prompt "Update investor account record"
        prompt "Insert redemption transaction record"
      } with {
        briefly "Persists redemption processing"
        described by {
          | Stores investor account updates and redemption
          | transaction details.
        }
      }

      on event FundSuspended is {
        prompt "Update fund status to Suspended"
        prompt "Record suspension reason and date"
      } with {
        briefly "Persists fund suspension"
        described by {
          | Updates fund status and records suspension details.
        }
      }

      on event FundResumed is {
        prompt "Update fund status to Active"
        prompt "Record resumption date"
      } with {
        briefly "Persists fund resumption"
        described by {
          | Updates fund status to active.
        }
      }
    } with {
      briefly "Event handler for fund persistence"
      described by {
        | Handles persistence of all fund-related events to the
        | repository for durable storage and querying.
      }
    }

  } with {
    briefly "Repository for fund accounting data"
    described by {
      | The FundRepository provides persistent storage for all fund
      | accounting data including fund configuration, NAV history,
      | transactions, holdings, and investor accounts.
    }
  }

  // === Projector ===

  projector FundDashboardProjector is {

    updates repository FundRepository

    type DashboardSummary is {
      fundId is FundId,
      fundName is String(1, 200),
      currentNAV is Money,
      navPerShare is Price,
      totalAUM is Money,
      dailyChange is Money,
      dailyChangePercent is Percentage,
      ytdReturn is Percentage,
      investorCount is Natural,
      lastUpdated is TimeStamp
    } with {
      briefly "Summary data for fund dashboard"
      described by {
        | Aggregated summary metrics for displaying on fund
        | dashboards and investor portals.
      }
    }

    type PerformanceChart is {
      fundId is FundId,
      dataPoints is many {
        date is Date,
        navPerShare is Price,
        cumulativeReturn is Percentage
      }
    } with {
      briefly "Time series data for performance charts"
      described by {
        | Historical NAV and return data formatted for chart
        | visualization.
      }
    }

    handler DashboardEventHandler is {
      on event NAVCalculated is {
        prompt "Update dashboard summary with new NAV"
        prompt "Calculate daily change from previous NAV"
        prompt "Append new data point to performance chart"
      } with {
        briefly "Updates dashboard on NAV calculation"
        described by {
          | Projects NAV calculations to dashboard summary and
          | performance chart data.
        }
      }

      on event SubscriptionProcessed is {
        prompt "Update total AUM in dashboard summary"
        prompt "Increment investor count if new investor"
      } with {
        briefly "Updates dashboard on subscription"
        described by {
          | Projects subscription events to update AUM and
          | investor metrics.
        }
      }

      on event RedemptionProcessed is {
        prompt "Update total AUM in dashboard summary"
        prompt "Update investor count if account closed"
      } with {
        briefly "Updates dashboard on redemption"
        described by {
          | Projects redemption events to update AUM metrics.
        }
      }

      on event FundCreated is {
        prompt "Initialize dashboard summary for new fund"
        prompt "Initialize empty performance chart"
      } with {
        briefly "Initializes dashboard for new fund"
        described by {
          | Creates initial dashboard projection entries for
          | a newly created fund.
        }
      }

      on event FundSuspended is {
        prompt "Update dashboard to show suspended status"
      } with {
        briefly "Updates dashboard on fund suspension"
        described by {
          | Projects fund suspension to dashboard display.
        }
      }

      on event FundResumed is {
        prompt "Update dashboard to show active status"
      } with {
        briefly "Updates dashboard on fund resumption"
        described by {
          | Projects fund resumption to dashboard display.
        }
      }
    } with {
      briefly "Event handler for dashboard projections"
      described by {
        | Handles events to maintain dashboard summary and
        | performance chart projections.
      }
    }

  } with {
    briefly "Projector for fund dashboard views"
    described by {
      | The FundDashboardProjector maintains read-optimized views
      | for fund dashboards including summary metrics and
      | performance charts for investor and manager portals.
    }
  }

  // === Reporting Projector ===

  projector RegulatoryReportingProjector is {

    updates repository FundRepository

    type RegulatoryReport is {
      fundId is FundId,
      reportingPeriod is String(1, 20),
      periodEndDate is Date,
      totalAssets is Money,
      totalLiabilities is Money,
      netAssets is Money,
      sharesOutstanding is Quantity,
      subscriptions is Money,
      redemptions is Money,
      netFlow is Money,
      managementFeesAccrued is Money,
      performanceFeesAccrued is Money,
      generatedAt is TimeStamp
    } with {
      briefly "Regulatory reporting data"
      described by {
        | Aggregated data for regulatory filings including
        | periodic reports to SEC, FINRA, and other regulators.
      }
    }

    handler ReportingEventHandler is {
      on event NAVCalculated is {
        prompt "Update period-end NAV figures for regulatory reports"
        prompt "Aggregate daily NAV data for period calculations"
      } with {
        briefly "Projects NAV data to regulatory reports"
        described by {
          | Accumulates NAV data for period-end regulatory reporting.
        }
      }

      on event TransactionRecorded is {
        prompt "Categorize transaction for regulatory reporting"
        prompt "Update period transaction totals"
      } with {
        briefly "Projects transactions to regulatory reports"
        described by {
          | Categorizes and aggregates transactions for regulatory
          | disclosure requirements.
        }
      }

      on event SubscriptionProcessed is {
        prompt "Add to period subscription total"
        prompt "Update net flow calculation"
      } with {
        briefly "Projects subscriptions to regulatory reports"
        described by {
          | Tracks subscription activity for regulatory reporting.
        }
      }

      on event RedemptionProcessed is {
        prompt "Add to period redemption total"
        prompt "Update net flow calculation"
      } with {
        briefly "Projects redemptions to regulatory reports"
        described by {
          | Tracks redemption activity for regulatory reporting.
        }
      }
    } with {
      briefly "Event handler for regulatory report projections"
      described by {
        | Handles events to maintain data required for regulatory
        | filings and compliance reporting.
      }
    }

  } with {
    briefly "Projector for regulatory reporting"
    described by {
      | The RegulatoryReportingProjector maintains data required
      | for regulatory filings including period-end reports,
      | transaction summaries, and compliance metrics.
    }
  }

} with {
  briefly "Bounded context for fund accounting"
  described by {
    | The FundContext is the primary bounded context for fund
    | accounting operations. It contains the Fund entity, repository
    | for persistence, and projectors for dashboard and regulatory
    | reporting views.
  }
}
