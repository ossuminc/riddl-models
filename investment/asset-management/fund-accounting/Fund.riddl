// Fund Entity
// Core entity representing an investment fund

entity Fund is {

  // === Commands ===

  command CreateFund is {
    fundId is FundId,
    name is String(1, 200),
    fundType is FundType,
    baseCurrency is Currency(USD),
    inceptionDate is Date,
    managementFeeRate is Percentage,
    performanceFeeRate is optional Percentage,
    minimumInvestment is Money
  } with {
    briefly "Create a new investment fund"
    described by {
      | Initializes a new fund with its core configuration including
      | name, type, fee structure, and minimum investment requirements.
      | The fund starts in Active status.
    }
  }

  command CalculateNAV is {
    fundId is FundId,
    valuationDate is Date,
    isOfficial is Boolean
  } with {
    briefly "Calculate the Net Asset Value for a fund"
    described by {
      | Triggers the NAV calculation process for the specified date.
      | Market data and holdings are used to compute total assets,
      | liabilities, and the resulting per-share NAV.
    }
  }

  command RecordTransaction is {
    transactionId is TransactionId,
    fundId is FundId,
    transactionType is TransactionType,
    tradeSecurityId is optional SecurityId,
    tradeQuantity is optional Quantity,
    tradePrice is optional Price,
    grossAmount is Money,
    fees is Money,
    tradeDate is Date,
    settlementDate is Date,
    description is String(0, 500)
  } with {
    briefly "Record a new fund transaction"
    described by {
      | Records a transaction affecting the fund such as security
      | purchases, sales, dividend receipts, or fee payments. The
      | transaction updates holdings and affects NAV calculation.
    }
  }

  command UpdateHolding is {
    holdingId is HoldingId,
    fundId is FundId,
    securityId is SecurityId,
    quantity is Quantity,
    marketValue is Money
  } with {
    briefly "Update a portfolio holding position"
    described by {
      | Updates the quantity or market value of an existing holding.
      | Used during position reconciliation and mark-to-market
      | processes.
    }
  }

  command ProcessSubscription is {
    accountId is InvestorAccountId,
    fundId is FundId,
    investorName is String(1, 200),
    subscriptionAmount is Money,
    subscriptionDate is Date
  } with {
    briefly "Process an investor subscription"
    described by {
      | Records a new investment into the fund. Calculates shares
      | issued based on current NAV and updates investor account
      | and fund shares outstanding.
    }
  }

  command ProcessRedemption is {
    accountId is InvestorAccountId,
    fundId is FundId,
    shares is Quantity,
    redemptionDate is Date
  } with {
    briefly "Process an investor redemption"
    described by {
      | Records a redemption from the fund. Calculates redemption
      | proceeds based on current NAV and updates investor account
      | and fund shares outstanding.
    }
  }

  command SuspendFund is {
    fundId is FundId,
    reason is String(1, 500),
    suspensionDate is Date
  } with {
    briefly "Suspend fund operations"
    described by {
      | Temporarily halts fund operations including subscriptions
      | and redemptions. Used during unusual market conditions or
      | significant events affecting the fund.
    }
  }

  command ResumeFund is {
    fundId is FundId,
    resumptionDate is Date
  } with {
    briefly "Resume suspended fund operations"
    described by {
      | Resumes normal fund operations after a suspension period.
      | The fund returns to Active status and accepts new transactions.
    }
  }

  // === Events ===

  event FundCreated is {
    fundId is FundId,
    name is String(1, 200),
    fundType is FundType,
    inceptionDate is Date,
    createdAt is TimeStamp
  } with {
    briefly "Fund has been created"
    described by {
      | Emitted when a new fund is successfully initialized and
      | ready for operations.
    }
  }

  event NAVCalculated is {
    navId is NAVId,
    fundId is FundId,
    valuationDate is Date,
    netAssetValue is Money,
    navPerShare is Price,
    sharesOutstanding is Quantity,
    isOfficial is Boolean,
    calculatedAt is TimeStamp
  } with {
    briefly "NAV calculation completed"
    described by {
      | Emitted when a NAV calculation completes successfully.
      | Contains the calculated values and whether this is the
      | official published NAV.
    }
  }

  event TransactionRecorded is {
    transactionId is TransactionId,
    fundId is FundId,
    transactionType is TransactionType,
    netAmount is Money,
    tradeDate is Date,
    recordedAt is TimeStamp
  } with {
    briefly "Transaction has been recorded"
    described by {
      | Emitted when a transaction is successfully recorded.
      | Triggers downstream processes such as holding updates
      | and NAV recalculation.
    }
  }

  event HoldingUpdated is {
    holdingId is HoldingId,
    fundId is FundId,
    securityId is SecurityId,
    quantity is Quantity,
    marketValue is Money,
    updatedAt is TimeStamp
  } with {
    briefly "Holding position has been updated"
    described by {
      | Emitted when a holding's quantity or value changes.
      | Triggers recalculation of portfolio allocations and
      | unrealized gains.
    }
  }

  event SubscriptionProcessed is {
    accountId is InvestorAccountId,
    fundId is FundId,
    investorName is String(1, 200),
    subscriptionAmount is Money,
    sharesIssued is Quantity,
    navPerShare is Price,
    processedAt is TimeStamp
  } with {
    briefly "Investor subscription has been processed"
    described by {
      | Emitted when an investor's subscription is processed and
      | shares are issued.
    }
  }

  event RedemptionProcessed is {
    accountId is InvestorAccountId,
    fundId is FundId,
    sharesRedeemed is Quantity,
    redemptionAmount is Money,
    navPerShare is Price,
    processedAt is TimeStamp
  } with {
    briefly "Investor redemption has been processed"
    described by {
      | Emitted when an investor's redemption is processed and
      | funds are distributed.
    }
  }

  event FundSuspended is {
    fundId is FundId,
    reason is String(1, 500),
    suspensionDate is Date,
    suspendedAt is TimeStamp
  } with {
    briefly "Fund operations have been suspended"
    described by {
      | Emitted when a fund enters suspended status. New
      | transactions are blocked until the fund is resumed.
    }
  }

  event FundResumed is {
    fundId is FundId,
    resumptionDate is Date,
    resumedAt is TimeStamp
  } with {
    briefly "Fund operations have resumed"
    described by {
      | Emitted when a suspended fund returns to active status.
    }
  }

  // === Queries ===

  query GetFundInfo is {
    fundId is FundId
  } with {
    briefly "Retrieve fund information"
    described by {
      | Queries the current fund configuration and status information.
    }
  }

  result FundInfoResult is {
    fundInfo is FundInfo
  } with {
    briefly "Fund information query result"
    described by {
      | Returns the fund's current configuration and status.
    }
  }

  query GetNAVHistory is {
    fundId is FundId,
    startDate is Date,
    endDate is Date
  } with {
    briefly "Retrieve NAV history for a date range"
    described by {
      | Queries historical NAV values for the specified period.
    }
  }

  result NAVHistoryResult is {
    navRecords is many NAVRecord
  } with {
    briefly "NAV history query result"
    described by {
      | Returns a list of NAV records for the requested date range.
    }
  }

  query GetHoldings is {
    fundId is FundId,
    asOfDate is Date
  } with {
    briefly "Retrieve fund holdings"
    described by {
      | Queries the fund's portfolio holdings as of a specific date.
    }
  }

  result HoldingsResult is {
    holdings is many HoldingRecord
  } with {
    briefly "Holdings query result"
    described by {
      | Returns the list of current portfolio holdings with
      | positions and valuations.
    }
  }

  query GetPerformance is {
    fundId is FundId,
    asOfDate is Date
  } with {
    briefly "Retrieve fund performance metrics"
    described by {
      | Queries calculated performance returns for various periods.
    }
  }

  result PerformanceResult is {
    performance is FundPerformance
  } with {
    briefly "Performance query result"
    described by {
      | Returns the fund's performance metrics for standard periods.
    }
  }

  // === States ===

  state ActiveFund of FundInfo with {
    briefly "Fund in active operational state"
    described by {
      | The fund is operating normally, accepting subscriptions and
      | redemptions, and calculating daily NAV values.
    }
  }

  state SuspendedFund of FundInfo with {
    briefly "Fund with suspended operations"
    described by {
      | The fund has temporarily suspended operations. No new
      | subscriptions or redemptions are processed while suspended.
    }
  }

  // === Handler ===

  handler FundCommandHandler is {
    on command CreateFund is {
      prompt "Validate fund configuration and initialize fund state"
      morph entity Fund to state ActiveFund with command CreateFund
      tell event FundCreated to entity Fund
    } with {
      briefly "Handles fund creation"
      described by {
        | Validates the fund configuration and creates a new fund
        | in active state.
      }
    }

    on command CalculateNAV is {
      prompt "Retrieve current holdings and market prices"
      prompt "Calculate total assets by summing holding market values"
      prompt "Calculate total liabilities including accrued fees"
      prompt "Compute net asset value and per-share NAV"
      tell event NAVCalculated to entity Fund
    } with {
      briefly "Handles NAV calculation requests"
      described by {
        | Processes the NAV calculation by aggregating holdings,
        | applying market prices, and computing the per-share value.
      }
    }

    on command RecordTransaction is {
      when "transactionType is Buy or Sell" then {
        prompt "Update security holding position"
        prompt "Calculate realized gain/loss for sells"
      } end
      prompt "Record transaction with pending status"
      prompt "Update fund cash position"
      tell event TransactionRecorded to entity Fund
    } with {
      briefly "Handles transaction recording"
      described by {
        | Records the transaction and updates affected holdings
        | and positions.
      }
    }

    on command UpdateHolding is {
      prompt "Recalculate holding cost basis and unrealized gain/loss"
      prompt "Update portfolio allocation percentages"
      tell event HoldingUpdated to entity Fund
    } with {
      briefly "Handles holding updates"
      described by {
        | Updates holding position and recalculates related metrics.
      }
    }

    on command ProcessSubscription is {
      prompt "Retrieve current NAV per share"
      prompt "Calculate shares to issue based on investment amount"
      prompt "Create or update investor account"
      prompt "Increase fund shares outstanding"
      tell event SubscriptionProcessed to entity Fund
    } with {
      briefly "Handles investor subscriptions"
      described by {
        | Processes new investments by calculating shares to issue
        | and updating investor accounts.
      }
    }

    on command ProcessRedemption is {
      prompt "Validate sufficient shares in investor account"
      prompt "Calculate redemption amount based on current NAV"
      prompt "Reduce investor account balance"
      prompt "Reduce fund shares outstanding"
      tell event RedemptionProcessed to entity Fund
    } with {
      briefly "Handles investor redemptions"
      described by {
        | Processes redemption requests by calculating proceeds
        | and updating accounts.
      }
    }

    on command SuspendFund is {
      morph entity Fund to state SuspendedFund with command SuspendFund
      tell event FundSuspended to entity Fund
    } with {
      briefly "Handles fund suspension"
      described by {
        | Transitions the fund to suspended state and blocks new
        | transactions.
      }
    }

    on command ResumeFund is {
      morph entity Fund to state ActiveFund with command ResumeFund
      tell event FundResumed to entity Fund
    } with {
      briefly "Handles fund resumption"
      described by {
        | Returns a suspended fund to active operational status.
      }
    }

    on query GetFundInfo is {
      prompt "Retrieve and return current fund information"
    } with {
      briefly "Handles fund info queries"
      described by {
        | Returns the current fund configuration and status.
      }
    }

    on query GetNAVHistory is {
      prompt "Retrieve NAV records for the specified date range"
    } with {
      briefly "Handles NAV history queries"
      described by {
        | Returns historical NAV values for reporting and analysis.
      }
    }

    on query GetHoldings is {
      prompt "Retrieve holdings as of the specified date"
    } with {
      briefly "Handles holdings queries"
      described by {
        | Returns the fund's portfolio positions.
      }
    }

    on query GetPerformance is {
      prompt "Calculate and return performance metrics"
    } with {
      briefly "Handles performance queries"
      described by {
        | Returns calculated performance returns for standard periods.
      }
    }
  } with {
    briefly "Primary command handler for Fund entity"
    described by {
      | Handles all commands and queries for fund operations including
      | NAV calculations, transaction processing, and investor account
      | management.
    }
  }

} with {
  briefly "Investment fund entity"
  described by {
    | The Fund entity represents an investment fund and manages its
    | lifecycle, holdings, transactions, and investor accounts. It
    | serves as the aggregate root for fund accounting operations.
  }
}
