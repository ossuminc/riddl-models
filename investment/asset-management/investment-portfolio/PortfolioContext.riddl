// Investment Portfolio - Portfolio Context

context PortfolioContext is {

  include "types.riddl"
  include "Portfolio.riddl"

  repository PortfolioRepository is {
    schema PortfolioData is relational
      of portfolios as Portfolio
      index on field Portfolio.portfolioId
      index on field Portfolio.accountId
      index on field Portfolio.status

    handler PortfolioPersistence is {
      on event Portfolio.PortfolioCreated {
        prompt "Store new portfolio"
      }
      on event Portfolio.AllocationsUpdated {
        prompt "Update allocation targets"
      }
      on event Portfolio.PortfolioRebalanced {
        prompt "Update holdings after rebalance"
      }
      on event Portfolio.TradeFilled {
        prompt "Update holdings with trade fill"
      }
      on event Portfolio.RiskAnalyzed {
        prompt "Store risk analysis results"
      }
      on event Portfolio.PortfolioClosed {
        prompt "Mark portfolio as closed"
      }
    } with {
      briefly "Persists portfolio events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Portfolio data persistence"
    described by "Persistent storage for portfolios."
  }

  projector PortfolioMetrics is {
    updates repository PortfolioRepository

    record PortfolioAnalytics is {
      totalPortfolios is Natural with { briefly "Total" described by "Total portfolios." }
      activePortfolios is Natural with { briefly "Active" described by "Active portfolios." }
      totalTradesExecuted is Natural with { briefly "Trades" described by "Total trades executed." }
      averageTrackingError is Decimal(8, 4) with { briefly "Avg tracking error" described by "Average tracking error." }
    } with {
      briefly "Portfolio analytics"
      described by "Aggregate portfolio metrics."
    }

    handler MetricsHandler is {
      on event Portfolio.PortfolioCreated {
        prompt "Increment total and active portfolios"
      }
      on event Portfolio.TradeExecuted {
        prompt "Increment trades executed"
      }
      on event Portfolio.BenchmarkCompared {
        prompt "Update average tracking error"
      }
      on event Portfolio.PortfolioClosed {
        prompt "Decrement active portfolios"
      }
    } with {
      briefly "Maintains portfolio metrics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Portfolio metrics"
    described by "Investment portfolio analytics."
  }

} with {
  briefly "Bounded context for portfolio management"
  described by "Investment portfolio management context."
}
