// Investment Portfolio - Portfolio Entity

entity Portfolio is {

  command CreatePortfolio is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "New portfolio identifier."
    }
    accountId is AccountId with {
      briefly "Account"
      described by "Investment account identifier."
    }
    portfolioName is String(3, 200) with {
      briefly "Name"
      described by "Portfolio name."
    }
    benchmarkId is BenchmarkId with {
      briefly "Benchmark"
      described by "Benchmark index identifier."
    }
    targets is many AllocationTarget with {
      briefly "Targets"
      described by "Target asset allocations."
    }
  } with {
    briefly "Create portfolio"
    described by "Creates a new investment portfolio."
  }

  command UpdateAllocations is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    targets is many AllocationTarget with {
      briefly "Targets"
      described by "Updated allocation targets."
    }
  } with {
    briefly "Update allocations"
    described by "Updates target asset allocations."
  }

  command RebalancePortfolio is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Reason for rebalancing."
    }
  } with {
    briefly "Rebalance portfolio"
    described by "Initiates portfolio rebalancing."
  }

  command ExecuteTrade is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    trade is TradeOrder with {
      briefly "Trade"
      described by "Trade order to execute."
    }
  } with {
    briefly "Execute trade"
    described by "Submits a trade for execution."
  }

  command RecordTradeFill is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    tradeId is TradeId with {
      briefly "Trade ID"
      described by "Trade identifier."
    }
    filledQuantity is Decimal(15, 4) with {
      briefly "Filled quantity"
      described by "Quantity filled."
    }
    filledPrice is Decimal(15, 4) with {
      briefly "Filled price"
      described by "Execution price."
    }
    filledAt is TimeStamp with {
      briefly "Filled at"
      described by "Fill timestamp."
    }
  } with {
    briefly "Record trade fill"
    described by "Records trade execution fill."
  }

  command AnalyzeRisk is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    asOfDate is Date with {
      briefly "As-of date"
      described by "Date for risk analysis."
    }
  } with {
    briefly "Analyze risk"
    described by "Triggers portfolio risk analysis."
  }

  command CompareBenchmark is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    periodStartDate is Date with {
      briefly "Period start"
      described by "Comparison period start."
    }
    periodEndDate is Date with {
      briefly "Period end"
      described by "Comparison period end."
    }
  } with {
    briefly "Compare benchmark"
    described by "Compares portfolio against benchmark."
  }

  command SuspendPortfolio is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Suspension reason."
    }
  } with {
    briefly "Suspend portfolio"
    described by "Suspends portfolio trading activity."
  }

  command ClosePortfolio is {
    portfolioId is PortfolioId with {
      briefly "Portfolio ID"
      described by "Portfolio identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Closure reason."
    }
  } with {
    briefly "Close portfolio"
    described by "Closes the investment portfolio."
  }

  // Events
  event PortfolioCreated is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    portfolioName is String(3, 200) with { briefly "Name" described by "Portfolio name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Portfolio created"
    described by "Emitted when a portfolio is created."
  }

  event AllocationsUpdated is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    targets is many AllocationTarget with { briefly "Targets" described by "New targets." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Allocations updated"
    described by "Emitted when allocation targets are updated."
  }

  event PortfolioRebalanced is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    tradesGenerated is Natural with { briefly "Trades" described by "Number of trades generated." }
    rebalancedAt is TimeStamp with { briefly "Rebalanced" described by "Rebalance time." }
  } with {
    briefly "Portfolio rebalanced"
    described by "Emitted when portfolio rebalancing completes."
  }

  event TradeExecuted is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    tradeId is TradeId with { briefly "Trade" described by "Trade ID." }
    action is TradeAction with { briefly "Action" described by "Trade action." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Trade executed"
    described by "Emitted when a trade is submitted for execution."
  }

  event TradeFilled is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    tradeId is TradeId with { briefly "Trade" described by "Trade ID." }
    filledQuantity is Decimal(15, 4) with { briefly "Quantity" described by "Filled quantity." }
    filledPrice is Decimal(15, 4) with { briefly "Price" described by "Fill price." }
    filledAt is TimeStamp with { briefly "Filled" described by "Fill time." }
  } with {
    briefly "Trade filled"
    described by "Emitted when a trade fill is recorded."
  }

  event RiskAnalyzed is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    metrics is RiskMetrics with { briefly "Metrics" described by "Risk metrics." }
    analyzedAt is TimeStamp with { briefly "Analyzed" described by "Analysis time." }
  } with {
    briefly "Risk analyzed"
    described by "Emitted when risk analysis completes."
  }

  event BenchmarkCompared is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    comparison is BenchmarkComparison with { briefly "Comparison" described by "Benchmark comparison." }
    comparedAt is TimeStamp with { briefly "Compared" described by "Comparison time." }
  } with {
    briefly "Benchmark compared"
    described by "Emitted when benchmark comparison completes."
  }

  event PortfolioSuspended is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Portfolio suspended"
    described by "Emitted when portfolio is suspended."
  }

  event PortfolioClosed is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Portfolio closed"
    described by "Emitted when portfolio is closed."
  }

  // States
  record ActiveStateData is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    portfolioName is String(3, 200) with { briefly "Name" described by "Portfolio name." }
    status is PortfolioStatus with { briefly "Status" described by "Portfolio status." }
    benchmarkId is BenchmarkId with { briefly "Benchmark" described by "Benchmark ID." }
    targets is many AllocationTarget with { briefly "Targets" described by "Allocation targets." }
    holdings is many optional Holding with { briefly "Holdings" described by "Current holdings." }
    pendingTrades is many optional TradeOrder with { briefly "Trades" described by "Pending trades." }
    riskMetrics is optional RiskMetrics with { briefly "Risk" described by "Latest risk metrics." }
    benchmarkComparison is optional BenchmarkComparison with { briefly "Benchmark" described by "Latest benchmark comparison." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active portfolio state"
    described by "State for an active investment portfolio."
  }

  record ClosedStateData is {
    portfolioId is PortfolioId with { briefly "Portfolio" described by "Portfolio ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed portfolio state"
    described by "State for a closed portfolio."
  }

  state ActiveState of Portfolio.ActiveStateData with {
    briefly "Portfolio active"
    described by "Portfolio is actively managed."
  }

  state ClosedState of Portfolio.ClosedStateData with {
    briefly "Portfolio closed"
    described by "Portfolio has been closed."
  }

  handler PortfolioHandler is {
    on command CreatePortfolio {
      morph entity PortfolioContext.Portfolio to state PortfolioContext.Portfolio.ActiveState with command CreatePortfolio
      tell event PortfolioCreated to entity PortfolioContext.Portfolio
    }
    on command UpdateAllocations {
      tell event AllocationsUpdated to entity PortfolioContext.Portfolio
    }
    on command RebalancePortfolio {
      tell event PortfolioRebalanced to entity PortfolioContext.Portfolio
    }
    on command ExecuteTrade {
      tell event TradeExecuted to entity PortfolioContext.Portfolio
    }
    on command RecordTradeFill {
      tell event TradeFilled to entity PortfolioContext.Portfolio
    }
    on command AnalyzeRisk {
      tell event RiskAnalyzed to entity PortfolioContext.Portfolio
    }
    on command CompareBenchmark {
      tell event BenchmarkCompared to entity PortfolioContext.Portfolio
    }
    on command SuspendPortfolio {
      tell event PortfolioSuspended to entity PortfolioContext.Portfolio
    }
    on command ClosePortfolio {
      morph entity PortfolioContext.Portfolio to state PortfolioContext.Portfolio.ClosedState with command ClosePortfolio
      tell event PortfolioClosed to entity PortfolioContext.Portfolio
    }
  } with {
    briefly "Processes portfolio commands"
    described by "Handles portfolio lifecycle and trading."
  }

} with {
  briefly "Portfolio aggregate"
  described by "Manages investment portfolios."
}
