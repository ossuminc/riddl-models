// External Contexts for Usage Billing Domain
// These represent external systems that the billing domain integrates with

context NetworkMediation is {

  type CDR is {
    recordId: String,
    msisdn: String,
    imsi: String,
    callType: String,
    startTime: DateTime,
    endTime: DateTime,
    duration: Integer,
    dataVolume: Integer,
    originatingCell: String,
    terminatingCell: String,
    networkId: String
  } briefly "Call Detail Record from network"
    described by "Raw usage record from network elements before rating."

  event CDRReceived is {
    cdr: CDR,
    receivedAt: DateTime
  } briefly "CDR received from network"
    described by "Indicates a new call detail record is available for processing."

  event CDRBatchReady is {
    batchId: String,
    recordCount: Integer,
    periodStart: DateTime,
    periodEnd: DateTime
  } briefly "Batch of CDRs ready for processing"
    described by "Indicates a batch of CDRs is ready for rating and billing."

} with {
  option is external
  briefly "External network mediation system"
  described by {
    | The Network Mediation context represents the external system that
    | collects raw Call Detail Records (CDRs) from network elements,
    | performs normalization and deduplication, and delivers them to
    | the billing system for rating and invoicing.
  }
}

context PaymentGateway is {

  type PaymentRequest is {
    transactionId: String,
    amount: MonetaryAmount,
    currency: String,
    customerId: String,
    paymentMethod: PaymentMethod,
    cardToken: String?,
    bankAccountToken: String?
  } briefly "Request to process a payment"
    described by "Contains all information needed to process a customer payment."

  type PaymentResponse is {
    transactionId: String,
    status: String,
    authorizationCode: String?,
    declineReason: String?,
    processedAt: DateTime
  } briefly "Response from payment processing"
    described by "Result of a payment processing attempt."

  event PaymentProcessed is {
    transactionId: String,
    accountId: String,
    amount: MonetaryAmount,
    status: String,
    processedAt: DateTime
  } briefly "Payment was processed"
    described by "Indicates a payment has been processed by the gateway."

  event PaymentFailed is {
    transactionId: String,
    accountId: String,
    amount: MonetaryAmount,
    reason: String,
    failedAt: DateTime
  } briefly "Payment processing failed"
    described by "Indicates a payment attempt was unsuccessful."

} with {
  option is external
  briefly "External payment processing gateway"
  described by {
    | The Payment Gateway context represents the external payment
    | processing system that handles credit card, debit card, ACH,
    | and other payment methods. It provides secure tokenization
    | and PCI-compliant transaction processing.
  }
}

context CustomerPortal is {

  type BillViewRequest is {
    accountId: AccountId,
    invoiceId: InvoiceId?
  } briefly "Request to view billing information"
    described by "Customer request to view their bill or invoice."

  type UsageViewRequest is {
    accountId: AccountId,
    startDate: Date,
    endDate: Date,
    usageType: UsageType?
  } briefly "Request to view usage details"
    described by "Customer request to view their usage history."

  event CustomerViewedBill is {
    accountId: AccountId,
    invoiceId: InvoiceId,
    viewedAt: DateTime
  } briefly "Customer viewed their bill"
    described by "Indicates a customer accessed their invoice in the portal."

  event CustomerInitiatedPayment is {
    accountId: AccountId,
    invoiceId: InvoiceId,
    amount: MonetaryAmount,
    paymentMethod: PaymentMethod
  } briefly "Customer initiated a payment"
    described by "Indicates a customer started the payment process in the portal."

  event CustomerDisputedCharge is {
    accountId: AccountId,
    invoiceId: InvoiceId,
    lineItemDescription: String,
    disputeReason: String,
    disputedAt: DateTime
  } briefly "Customer disputed a charge"
    described by "Indicates a customer raised a dispute about a bill item."

} with {
  option is external
  briefly "External customer self-service portal"
  described by {
    | The Customer Portal context represents the external self-service
    | web and mobile application where customers view bills, check
    | usage, make payments, and manage their account preferences.
  }
}

context RatingEngine is {

  type RatingRequest is {
    usageRecords: many UsageRecordId,
    ratePlanId: RatePlanId,
    effectiveDate: Date
  } briefly "Request to rate usage records"
    described by "Batch of usage records to be rated against a plan."

  type RatedUsage is {
    usageRecordId: UsageRecordId,
    baseRate: MonetaryAmount,
    discounts: MonetaryAmount,
    surcharges: MonetaryAmount,
    finalAmount: MonetaryAmount,
    ratingDetails: String
  } briefly "Usage record with calculated charges"
    described by "The result of applying rating rules to a usage record."

  event UsageRated is {
    usageRecordId: UsageRecordId,
    ratedUsage: RatedUsage,
    ratedAt: DateTime
  } briefly "Usage record was rated"
    described by "Indicates a usage record has been priced."

  event RatingError is {
    usageRecordId: UsageRecordId,
    errorCode: String,
    errorMessage: String,
    occurredAt: DateTime
  } briefly "Rating error occurred"
    described by "Indicates a usage record could not be rated."

} with {
  option is external
  briefly "External rating and pricing engine"
  described by {
    | The Rating Engine context represents the external system that
    | applies complex pricing rules, discount calculations, and
    | promotional offers to raw usage records. It supports tiered
    | pricing, bundle discounts, and time-of-day rate variations.
  }
}

context TaxCalculation is {

  type TaxRequest is {
    invoiceId: InvoiceId,
    lineItems: many InvoiceLineItem,
    serviceAddress: Address,
    billingAddress: Address
  } briefly "Request to calculate taxes"
    described by "Invoice details needed for tax calculation."

  type TaxResult is {
    invoiceId: InvoiceId,
    federalTax: MonetaryAmount,
    stateTax: MonetaryAmount,
    localTax: MonetaryAmount,
    regulatoryFees: MonetaryAmount,
    totalTax: MonetaryAmount,
    taxBreakdown: many TaxLineItem
  } briefly "Calculated tax amounts"
    described by "Result of tax calculation for an invoice."

  type TaxLineItem is {
    description: String,
    jurisdiction: String,
    rate: Decimal,
    amount: MonetaryAmount
  } briefly "Individual tax or fee line item"
    described by "A single tax or regulatory fee applied to the invoice."

  event TaxesCalculated is {
    invoiceId: InvoiceId,
    taxResult: TaxResult,
    calculatedAt: DateTime
  } briefly "Taxes were calculated"
    described by "Indicates taxes have been determined for an invoice."

} with {
  option is external
  briefly "External tax calculation service"
  described by {
    | The Tax Calculation context represents the external service that
    | calculates federal, state, and local taxes as well as regulatory
    | fees (USF, E911, etc.) based on service and billing addresses.
    | Telecommunications taxation is complex with jurisdiction-specific
    | rules that change frequently.
  }
}

context NotificationService is {

  type NotificationRequest is {
    recipientEmail: EmailAddress,
    recipientPhone: PhoneNumber?,
    templateId: String,
    templateData: String,
    priority: String
  } briefly "Request to send a notification"
    described by "Details for sending an email or SMS notification."

  event InvoiceEmailSent is {
    accountId: AccountId,
    invoiceId: InvoiceId,
    recipientEmail: EmailAddress,
    sentAt: DateTime
  } briefly "Invoice email was sent"
    described by "Indicates an invoice notification was delivered."

  event PaymentReminderSent is {
    accountId: AccountId,
    invoiceId: InvoiceId,
    reminderType: String,
    sentAt: DateTime
  } briefly "Payment reminder was sent"
    described by "Indicates a payment reminder notification was delivered."

  event SuspensionNoticeSent is {
    accountId: AccountId,
    suspensionDate: Date,
    sentAt: DateTime
  } briefly "Suspension notice was sent"
    described by "Indicates a suspension warning was delivered to customer."

} with {
  option is external
  briefly "External notification and messaging service"
  described by {
    | The Notification Service context represents the external system
    | that handles delivery of billing-related communications including
    | invoice notifications, payment reminders, suspension warnings,
    | and payment confirmations via email and SMS.
  }
}
