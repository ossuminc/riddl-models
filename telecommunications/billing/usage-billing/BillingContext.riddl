// Billing Context - Bounded Context for Usage Billing

context BillingContext is {

  include "BillingAccount.riddl"

  // === Event Union Type ===

  type AccountEvent is one of {
    BillingAccount.AccountCreated,
    BillingAccount.CustomerInfoUpdated,
    BillingAccount.RatePlanChanged,
    BillingAccount.UsageRecorded,
    BillingAccount.InvoiceGenerated,
    BillingAccount.PaymentApplied,
    BillingAccount.CreditApplied,
    BillingAccount.AccountSuspended,
    BillingAccount.AccountReactivated,
    BillingAccount.AccountClosed
  } with {
    briefly "Union of all account events"
    described by "All events that can be emitted by the BillingAccount entity."
  }

  // === Repository ===

  repository BillingAccountRepository is {

    query FindAccountById is {
      accountId is AccountId with { briefly "Account" described by "Account identifier." }
    } with {
      briefly "Find account by ID"
      described by "Retrieves a billing account by its unique identifier."
    }

    result AccountResult is {
      accountId is AccountId with { briefly "Account" described by "Account found." }
    } with {
      briefly "Account query result"
      described by "Returns the requested billing account."
    }

    query FindAccountsByStatus is {
      status is AccountStatus with { briefly "Status" described by "Account status." }
    } with {
      briefly "Find accounts by status"
      described by "Retrieves all accounts matching the specified status."
    }

    result AccountsResult is {
      accountIds is many AccountId with { briefly "Accounts" described by "Matching accounts." }
    } with {
      briefly "Multiple accounts result"
      described by "Returns a list of billing accounts."
    }

    query FindOverdueAccounts is {
      asOfDate is Date with { briefly "Date" described by "As of date." }
    } with {
      briefly "Find accounts with overdue invoices"
      described by "Retrieves accounts that have invoices past due date."
    }

    query FindAccountsByCustomer is {
      email is EmailAddress with { briefly "Email" described by "Customer email." }
    } with {
      briefly "Find accounts by customer email"
      described by "Retrieves accounts associated with a customer email address."
    }

    query GetUsageForPeriod is {
      accountId is AccountId with { briefly "Account" described by "Account identifier." }
      startDate is Date with { briefly "Start" described by "Period start." }
      endDate is Date with { briefly "End" described by "Period end." }
    } with {
      briefly "Get usage records for a billing period"
      described by "Retrieves all usage records for an account within a date range."
    }

    result UsageResult is {
      usageRecords is many UsageRecordId with { briefly "Records" described by "Usage records." }
    } with {
      briefly "Usage query result"
      described by "Returns usage records for the specified period."
    }

    query GetInvoiceHistory is {
      accountId is AccountId with { briefly "Account" described by "Account identifier." }
      limit is Integer with { briefly "Limit" described by "Max results." }
    } with {
      briefly "Get invoice history for account"
      described by "Retrieves recent invoices for the account."
    }

    result InvoiceHistoryResult is {
      invoices is many InvoiceId with { briefly "Invoices" described by "Invoice identifiers." }
    } with {
      briefly "Invoice history result"
      described by "Returns a list of invoice identifiers."
    }

    handler RepositoryHandler is {
      on query FindAccountById {
        ???
      }

      on query FindAccountsByStatus {
        ???
      }

      on query FindOverdueAccounts {
        ???
      }

      on query FindAccountsByCustomer {
        ???
      }

      on query GetUsageForPeriod {
        ???
      }

      on query GetInvoiceHistory {
        ???
      }
    } with {
      briefly "Query handler for billing account repository"
      described by "Handles all query operations for billing accounts."
    }

  } with {
    briefly "Repository for billing account persistence"
    described by {
      | Provides persistence and query capabilities for billing accounts.
      | Supports lookups by ID, status, customer, and date ranges for
      | usage and invoice retrieval.
    }
  }

  // === Projector for Read Models ===

  projector AccountSummaryProjector is {

    record AccountSummaryView is {
      accountId is AccountId with { briefly "Account" described by "Account identifier." }
      customerName is String with { briefly "Name" described by "Customer name." }
      customerEmail is EmailAddress with { briefly "Email" described by "Customer email." }
      ratePlanName is String with { briefly "Plan" described by "Rate plan name." }
      accountStatus is AccountStatus with { briefly "Status" described by "Account status." }
      currentBalance is MonetaryAmount with { briefly "Balance" described by "Current balance." }
      unbilledUsageAmount is MonetaryAmount with { briefly "Unbilled" described by "Unbilled usage." }
      lastPaymentDate is optional Date with { briefly "Last paid" described by "Last payment date." }
      lastPaymentAmount is optional MonetaryAmount with { briefly "Last amount" described by "Last payment." }
      lastInvoiceDate is optional Date with { briefly "Last invoice" described by "Last invoice date." }
      lastInvoiceAmount is optional MonetaryAmount with { briefly "Invoice amount" described by "Last invoice amount." }
      daysPastDue is Integer with { briefly "Past due" described by "Days past due." }
    } with {
      briefly "Denormalized account summary view"
      described by {
        | A read-optimized view of account status for dashboards and
        | customer service screens. Updated from account events.
      }
    }

    handler AccountSummaryHandler is {
      on event BillingAccount.AccountCreated {
        ???
      }

      on event BillingAccount.CustomerInfoUpdated {
        ???
      }

      on event BillingAccount.RatePlanChanged {
        ???
      }

      on event BillingAccount.UsageRecorded {
        ???
      }

      on event BillingAccount.InvoiceGenerated {
        ???
      }

      on event BillingAccount.PaymentApplied {
        ???
      }

      on event BillingAccount.CreditApplied {
        ???
      }

      on event BillingAccount.AccountSuspended {
        ???
      }

      on event BillingAccount.AccountReactivated {
        ???
      }

      on event BillingAccount.AccountClosed {
        ???
      }
    } with {
      briefly "Event handler for account summary projection"
      described by "Processes account events to maintain the summary read model."
    }

  } with {
    briefly "Projector for account summary read model"
    described by {
      | Maintains a denormalized, read-optimized view of account status.
      | This CQRS read model is updated from account events and provides
      | fast access for dashboards, reports, and customer service screens.
    }
  }

  // === Revenue Analytics Projector ===

  projector RevenueAnalyticsProjector is {

    record DailyRevenueView is {
      date is Date with { briefly "Date" described by "Revenue date." }
      totalInvoiced is MonetaryAmount with { briefly "Invoiced" described by "Total invoiced." }
      totalCollected is MonetaryAmount with { briefly "Collected" described by "Total collected." }
      invoiceCount is Integer with { briefly "Invoices" described by "Invoice count." }
      paymentCount is Integer with { briefly "Payments" described by "Payment count." }
      averageInvoiceAmount is MonetaryAmount with { briefly "Average" described by "Average invoice." }
      usageByType is many UsageTypeBreakdown with { briefly "Breakdown" described by "Usage breakdown." }
    } with {
      briefly "Daily revenue metrics"
      described by "Aggregated revenue data for a single day."
    }

    record UsageTypeBreakdown is {
      usageType is UsageType with { briefly "Type" described by "Usage type." }
      totalUsage is Number with { briefly "Usage" described by "Total usage." }
      totalRevenue is MonetaryAmount with { briefly "Revenue" described by "Total revenue." }
    } with {
      briefly "Usage breakdown by type"
      described by "Revenue and volume for a specific usage category."
    }

    handler RevenueHandler is {
      on event BillingAccount.InvoiceGenerated {
        ???
      }

      on event BillingAccount.PaymentApplied {
        ???
      }

      on event BillingAccount.UsageRecorded {
        ???
      }
    } with {
      briefly "Event handler for revenue analytics"
      described by "Processes billing events to maintain revenue metrics."
    }

  } with {
    briefly "Projector for revenue analytics read model"
    described by {
      | Maintains aggregated revenue metrics for business intelligence
      | and financial reporting. Tracks invoiced and collected revenue
      | with breakdowns by usage type.
    }
  }

} with {
  briefly "Bounded context for telecommunications usage billing"
  described by {
    | The BillingContext encapsulates all billing-related functionality
    | including account management, usage tracking, invoice generation,
    | and payment processing. It provides repositories for persistence
    | and projectors for read-optimized views supporting dashboards
    | and analytics.
  }
}
