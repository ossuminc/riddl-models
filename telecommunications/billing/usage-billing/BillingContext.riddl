// Billing Context - Bounded Context for Usage Billing

context BillingContext is {

  include "BillingAccount.riddl"

  // === Outlets for Event Streaming ===

  outlet AccountEvents is type AccountEvent
    briefly "Stream of account-related events"
    described by "Publishes events for account lifecycle and billing activities."

  type AccountEvent is one of {
    AccountCreated,
    CustomerInfoUpdated,
    RatePlanChanged,
    UsageRecorded,
    InvoiceGenerated,
    PaymentApplied,
    CreditApplied,
    AccountSuspended,
    AccountReactivated,
    AccountClosed
  } briefly "Union of all account events"
    described by "All events that can be emitted by the BillingAccount entity."

  // === Type Aliases for Entity References ===

  type UsageRecord is {
    recordId: UsageRecordId
  } briefly "Reference to a usage record"
    described by "Placeholder for usage record entity reference."

  type Invoice is {
    invoiceId: InvoiceId
  } briefly "Reference to an invoice"
    described by "Placeholder for invoice entity reference."

  // === Repository ===

  repository BillingAccountRepository is {

    query FindAccountById is {
      accountId: AccountId
    } briefly "Find account by ID"
      described by "Retrieves a billing account by its unique identifier."

    result AccountResult is {
      account: BillingAccount
    } briefly "Account query result"
      described by "Returns the requested billing account."

    query FindAccountsByStatus is {
      status: AccountStatus
    } briefly "Find accounts by status"
      described by "Retrieves all accounts matching the specified status."

    result AccountsResult is {
      accounts: many BillingAccount
    } briefly "Multiple accounts result"
      described by "Returns a list of billing accounts."

    query FindOverdueAccounts is {
      asOfDate: Date
    } briefly "Find accounts with overdue invoices"
      described by "Retrieves accounts that have invoices past due date."

    query FindAccountsByCustomer is {
      email: EmailAddress
    } briefly "Find accounts by customer email"
      described by "Retrieves accounts associated with a customer email address."

    query GetUsageForPeriod is {
      accountId: AccountId,
      startDate: Date,
      endDate: Date
    } briefly "Get usage records for a billing period"
      described by "Retrieves all usage records for an account within a date range."

    result UsageResult is {
      usageRecords: many UsageRecordId
    } briefly "Usage query result"
      described by "Returns usage records for the specified period."

    query GetInvoiceHistory is {
      accountId: AccountId,
      limit: Integer
    } briefly "Get invoice history for account"
      described by "Retrieves recent invoices for the account."

    result InvoiceHistoryResult is {
      invoices: many InvoiceId
    } briefly "Invoice history result"
      described by "Returns a list of invoice identifiers."

    handler RepositoryHandler is {
      on query FindAccountById {
        ???
      } briefly "Handle find by ID query"
        described by "Looks up account by primary key."

      on query FindAccountsByStatus {
        ???
      } briefly "Handle find by status query"
        described by "Searches accounts by status field."

      on query FindOverdueAccounts {
        ???
      } briefly "Handle overdue accounts query"
        described by "Finds accounts with past-due invoices."

      on query FindAccountsByCustomer {
        ???
      } briefly "Handle find by customer query"
        described by "Searches accounts by customer email."

      on query GetUsageForPeriod {
        ???
      } briefly "Handle usage period query"
        described by "Retrieves usage records within date range."

      on query GetInvoiceHistory {
        ???
      } briefly "Handle invoice history query"
        described by "Retrieves recent invoices for account."
    } briefly "Query handler for billing account repository"
      described by "Handles all query operations for billing accounts."

  } briefly "Repository for billing account persistence"
    described by {
      | Provides persistence and query capabilities for billing accounts.
      | Supports lookups by ID, status, customer, and date ranges for
      | usage and invoice retrieval.
    }

  // === Projector for Read Models ===

  projector AccountSummaryProjector is {

    record AccountSummaryView is {
      accountId: AccountId,
      customerName: String,
      customerEmail: EmailAddress,
      ratePlanName: String,
      accountStatus: AccountStatus,
      currentBalance: MonetaryAmount,
      unbilledUsageAmount: MonetaryAmount,
      lastPaymentDate: Date?,
      lastPaymentAmount: MonetaryAmount?,
      lastInvoiceDate: Date?,
      lastInvoiceAmount: MonetaryAmount?,
      daysPastDue: Integer
    } briefly "Denormalized account summary view"
      described by {
        | A read-optimized view of account status for dashboards and
        | customer service screens. Updated from account events.
      }

    handler AccountSummaryHandler is {
      on event AccountCreated {
        ???
      } briefly "Initialize summary on account creation"
        described by "Creates a new summary record when account is created."

      on event CustomerInfoUpdated {
        ???
      } briefly "Update customer info in summary"
        described by "Refreshes customer name and email in the summary."

      on event RatePlanChanged {
        ???
      } briefly "Update rate plan in summary"
        described by "Updates the rate plan name in the summary view."

      on event UsageRecorded {
        ???
      } briefly "Update unbilled usage total"
        described by "Increments the unbilled usage amount."

      on event InvoiceGenerated {
        ???
      } briefly "Update invoice info and balance"
        described by "Updates last invoice date/amount and resets unbilled usage."

      on event PaymentApplied {
        ???
      } briefly "Update payment info and balance"
        described by "Updates last payment date/amount and reduces balance."

      on event CreditApplied {
        ???
      } briefly "Update balance for credit"
        described by "Reduces account balance by credit amount."

      on event AccountSuspended {
        ???
      } briefly "Update status to suspended"
        described by "Changes account status in the summary view."

      on event AccountReactivated {
        ???
      } briefly "Update status to active"
        described by "Changes account status back to active."

      on event AccountClosed {
        ???
      } briefly "Update status to closed"
        described by "Changes account status to closed."
    } briefly "Event handler for account summary projection"
      described by "Processes account events to maintain the summary read model."

  } briefly "Projector for account summary read model"
    described by {
      | Maintains a denormalized, read-optimized view of account status.
      | This CQRS read model is updated from account events and provides
      | fast access for dashboards, reports, and customer service screens.
    }

  // === Revenue Analytics Projector ===

  projector RevenueAnalyticsProjector is {

    record DailyRevenueView is {
      date: Date,
      totalInvoiced: MonetaryAmount,
      totalCollected: MonetaryAmount,
      invoiceCount: Integer,
      paymentCount: Integer,
      averageInvoiceAmount: MonetaryAmount,
      usageByType: many UsageTypeBreakdown
    } briefly "Daily revenue metrics"
      described by "Aggregated revenue data for a single day."

    record UsageTypeBreakdown is {
      usageType: UsageType,
      totalUsage: Number,
      totalRevenue: MonetaryAmount
    } briefly "Usage breakdown by type"
      described by "Revenue and volume for a specific usage category."

    handler RevenueHandler is {
      on event InvoiceGenerated {
        ???
      } briefly "Track invoiced revenue"
        described by "Updates daily invoiced totals when invoices are generated."

      on event PaymentApplied {
        ???
      } briefly "Track collected revenue"
        described by "Updates daily collection totals when payments are received."

      on event UsageRecorded {
        ???
      } briefly "Track usage by type"
        described by "Updates usage volume and revenue breakdown by type."
    } briefly "Event handler for revenue analytics"
      described by "Processes billing events to maintain revenue metrics."

  } briefly "Projector for revenue analytics read model"
    described by {
      | Maintains aggregated revenue metrics for business intelligence
      | and financial reporting. Tracks invoiced and collected revenue
      | with breakdowns by usage type.
    }

} briefly "Bounded context for telecommunications usage billing"
  described by {
    | The BillingContext encapsulates all billing-related functionality
    | including account management, usage tracking, invoice generation,
    | and payment processing. It provides repositories for persistence
    | and projectors for read-optimized views supporting dashboards
    | and analytics.
  }
