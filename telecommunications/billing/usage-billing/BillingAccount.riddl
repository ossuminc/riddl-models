// Billing Account Entity for Usage Billing Domain
entity BillingAccount is {
  // === Commands ===
  command CreateAccount is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |Rate plan.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
  } with {
    briefly "Create a new billing account"
    described as {
      |Establishes a new customer billing account with initial settings.
    }
  }
  command UpdateCustomerInfo is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
  } with {
    briefly "Update customer contact information"
    described as {
      |Modifies the customer details associated with the account.
    }
  }
  command ChangeRatePlan is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    newRatePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |New rate plan.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Change the rate plan for the account"
    described as {
      |Switches the customer to a different pricing plan.
    }
  }
  command RecordUsage is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Usage record.
      }
    }
  } with {
    briefly "Record a usage event for the account"
    described as {
      |Adds a metered usage record to be rated and billed.
    }
  }
  command GenerateInvoice is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    billingPeriodStart: Date with {
      briefly "Start"
      described as {
        |Period start.
      }
    }
    billingPeriodEnd: Date with {
      briefly "End"
      described as {
        |Period end.
      }
    }
  } with {
    briefly "Generate an invoice for a billing period"
    described as {
      |Creates an invoice aggregating usage and charges for the period.
    }
  }
  command ApplyPayment is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    payment: PaymentRecord with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
  } with {
    briefly "Apply a payment to the account"
    described as {
      |Records a payment received against an outstanding invoice.
    }
  }
  command ApplyCredit is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    amount: MonetaryAmount with {
      briefly "Amount"
      described as {
        |Credit amount.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Credit reason.
      }
    }
    targetInvoiceId: InvoiceId? with {
      briefly "Invoice"
      described as {
        |Target invoice.
      }
    }
  } with {
    briefly "Apply a credit adjustment to the account"
    described as {
      |Adds a credit to the account balance, optionally against a specific invoice.
    }
  }
  command SuspendAccount is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
  } with {
    briefly "Suspend the billing account"
    described as {
      |Suspends the account, typically due to non-payment.
    }
  }
  command ReactivateAccount is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
  } with {
    briefly "Reactivate a suspended account"
    described as {
      |Restores an account to active status after issue resolution.
    }
  }
  command CloseAccount is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    finalBillDate: Date with {
      briefly "Final"
      described as {
        |Final bill date.
      }
    }
  } with {
    briefly "Close the billing account"
    described as {
      |Permanently closes the account and generates a final bill.
    }
  }
  // === Events ===
  event AccountCreated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |Rate plan.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Billing account was created"
    described as {
      |Indicates a new billing account has been established.
    }
  }
  event CustomerInfoUpdated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Customer information was updated"
    described as {
      |Indicates customer contact details have been modified.
    }
  }
  event RatePlanChanged is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    previousPlanId: RatePlanId with {
      briefly "Previous"
      described as {
        |Previous plan.
      }
    }
    newPlanId: RatePlanId with {
      briefly "New"
      described as {
        |New plan.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Rate plan was changed"
    described as {
      |Indicates the customer has been moved to a different pricing plan.
    }
  }
  event UsageRecorded is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Usage record.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Usage event was recorded"
    described as {
      |Indicates a metered usage event has been captured for billing.
    }
  }
  event InvoiceGenerated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    invoiceId: InvoiceId with {
      briefly "Invoice"
      described as {
        |Invoice identifier.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Invoice was generated"
    described as {
      |Indicates an invoice has been created for the billing period.
    }
  }
  event PaymentApplied is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    payment: PaymentRecord with {
      briefly "Payment"
      described as {
        |Payment details.
      }
    }
    newBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
  } with {
    briefly "Payment was applied"
    described as {
      |Indicates a payment has been received and applied to the account.
    }
  }
  event CreditApplied is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    amount: MonetaryAmount with {
      briefly "Amount"
      described as {
        |Credit amount.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Credit reason.
      }
    }
    targetInvoiceId: InvoiceId? with {
      briefly "Invoice"
      described as {
        |Target invoice.
      }
    }
    newBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |New balance.
      }
    }
  } with {
    briefly "Credit was applied"
    described as {
      |Indicates a credit adjustment has been made to the account.
    }
  }
  event AccountSuspended is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Account was suspended"
    described as {
      |Indicates the account has been suspended.
    }
  }
  event AccountReactivated is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    reactivatedAt: TimeStamp with {
      briefly "Reactivated"
      described as {
        |Reactivation time.
      }
    }
  } with {
    briefly "Account was reactivated"
    described as {
      |Indicates a suspended account has been restored to active status.
    }
  }
  event AccountClosed is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    reason: String with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
    finalBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |Final balance.
      }
    }
  } with {
    briefly "Account was closed"
    described as {
      |Indicates the account has been permanently closed.
    }
  }
  // === State Records ===
  record PendingActivationData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |Rate plan.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Pending activation state data"
    described as {
      |Initial state when account is created but not yet active.
    }
  }
  record ActiveData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |Rate plan.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    currentBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Active state data"
    described as {
      | The normal operating state where the customer can use services,
      | usage is being tracked, and invoices can be generated.
    }
  }
  record SuspendedData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Plan"
      described as {
        |Rate plan.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Method"
      described as {
        |Payment method.
      }
    }
    currentBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |Current balance.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
    suspensionReason: String with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
  } with {
    briefly "Suspended state data"
    described as {
      | The account is blocked from incurring new usage, typically due to
      | non-payment or policy violations. Existing balances remain due.
    }
  }
  record ClosedData is  {
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
    closureReason: String with {
      briefly "Reason"
      described as {
        |Closure reason.
      }
    }
    finalBalance: MonetaryAmount with {
      briefly "Balance"
      described as {
        |Final balance.
      }
    }
  } with {
    briefly "Closed state data"
    described as {
      |Terminal state after account closure with historical records retained.
    }
  }
  // === States ===
  state PendingActivation of type BillingAccount.PendingActivationData
  state ActiveState of type BillingAccount.ActiveData
  state SuspendedState of type BillingAccount.SuspendedData
  state ClosedState of type BillingAccount.ClosedData
  // === Handler ===
  handler BillingAccountHandler is {
    on command CreateAccount is {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.PendingActivation with command CreateAccount
      tell event AccountCreated to entity BillingContext.BillingAccount
    }
    on command UpdateCustomerInfo is {
      tell event CustomerInfoUpdated to entity BillingContext.BillingAccount
    }
    on command ChangeRatePlan is {
      tell event RatePlanChanged to entity BillingContext.BillingAccount
    }
    on command RecordUsage is {
      tell event UsageRecorded to entity BillingContext.BillingAccount
    }
    on command GenerateInvoice is {
      tell event InvoiceGenerated to entity BillingContext.BillingAccount
    }
    on command ApplyPayment is {
      tell event PaymentApplied to entity BillingContext.BillingAccount
    }
    on command ApplyCredit is {
      tell event CreditApplied to entity BillingContext.BillingAccount
    }
    on command SuspendAccount is {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.SuspendedState with command SuspendAccount
      tell event AccountSuspended to entity BillingContext.BillingAccount
    }
    on command ReactivateAccount is {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.ActiveState with command ReactivateAccount
      tell event AccountReactivated to entity BillingContext.BillingAccount
    }
    on command CloseAccount is {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.ClosedState with command CloseAccount
      tell event AccountClosed to entity BillingContext.BillingAccount
    }
  } with {
    briefly "Command handler for BillingAccount entity"
    described as {
      | Processes all commands for the BillingAccount entity, managing state
      | transitions and emitting appropriate events for downstream processing.
    }
  }
} with {
  option aggregate()
  option event-sourced()
  briefly "Billing account aggregate root"
  described as {
    | The BillingAccount entity is the aggregate root for customer billing.
    | It maintains account status, tracks unbilled usage, manages invoices,
    | and records payments. It follows event sourcing patterns for full
    | auditability of all billing activities.
  }
}
