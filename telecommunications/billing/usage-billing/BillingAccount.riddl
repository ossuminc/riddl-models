// Billing Account Entity for Usage Billing Domain

entity BillingAccount is {

  // === Commands ===

  command CreateAccount is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    ratePlanId is RatePlanId with { briefly "Plan" described by "Rate plan." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
  } with {
    briefly "Create a new billing account"
    described by "Establishes a new customer billing account with initial settings."
  }

  command UpdateCustomerInfo is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
  } with {
    briefly "Update customer contact information"
    described by "Modifies the customer details associated with the account."
  }

  command ChangeRatePlan is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    newRatePlanId is RatePlanId with { briefly "Plan" described by "New rate plan." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
  } with {
    briefly "Change the rate plan for the account"
    described by "Switches the customer to a different pricing plan."
  }

  command RecordUsage is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    usageRecordId is UsageRecordId with { briefly "Record" described by "Usage record." }
  } with {
    briefly "Record a usage event for the account"
    described by "Adds a metered usage record to be rated and billed."
  }

  command GenerateInvoice is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    billingPeriodStart is Date with { briefly "Start" described by "Period start." }
    billingPeriodEnd is Date with { briefly "End" described by "Period end." }
  } with {
    briefly "Generate an invoice for a billing period"
    described by "Creates an invoice aggregating usage and charges for the period."
  }

  command ApplyPayment is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    payment is PaymentRecord with { briefly "Payment" described by "Payment details." }
  } with {
    briefly "Apply a payment to the account"
    described by "Records a payment received against an outstanding invoice."
  }

  command ApplyCredit is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    amount is MonetaryAmount with { briefly "Amount" described by "Credit amount." }
    reason is String with { briefly "Reason" described by "Credit reason." }
    targetInvoiceId is optional InvoiceId with { briefly "Invoice" described by "Target invoice." }
  } with {
    briefly "Apply a credit adjustment to the account"
    described by "Adds a credit to the account balance, optionally against a specific invoice."
  }

  command SuspendAccount is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    reason is String with { briefly "Reason" described by "Suspension reason." }
  } with {
    briefly "Suspend the billing account"
    described by "Suspends the account, typically due to non-payment."
  }

  command ReactivateAccount is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
  } with {
    briefly "Reactivate a suspended account"
    described by "Restores an account to active status after issue resolution."
  }

  command CloseAccount is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    reason is String with { briefly "Reason" described by "Closure reason." }
    finalBillDate is Date with { briefly "Final" described by "Final bill date." }
  } with {
    briefly "Close the billing account"
    described by "Permanently closes the account and generates a final bill."
  }

  // === Events ===

  event AccountCreated is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    ratePlanId is RatePlanId with { briefly "Plan" described by "Rate plan." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Billing account was created"
    described by "Indicates a new billing account has been established."
  }

  event CustomerInfoUpdated is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Customer information was updated"
    described by "Indicates customer contact details have been modified."
  }

  event RatePlanChanged is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    previousPlanId is RatePlanId with { briefly "Previous" described by "Previous plan." }
    newPlanId is RatePlanId with { briefly "New" described by "New plan." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
  } with {
    briefly "Rate plan was changed"
    described by "Indicates the customer has been moved to a different pricing plan."
  }

  event UsageRecorded is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    usageRecordId is UsageRecordId with { briefly "Record" described by "Usage record." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Usage event was recorded"
    described by "Indicates a metered usage event has been captured for billing."
  }

  event InvoiceGenerated is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    invoiceId is InvoiceId with { briefly "Invoice" described by "Invoice identifier." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Invoice was generated"
    described by "Indicates an invoice has been created for the billing period."
  }

  event PaymentApplied is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    payment is PaymentRecord with { briefly "Payment" described by "Payment details." }
    newBalance is MonetaryAmount with { briefly "Balance" described by "New balance." }
  } with {
    briefly "Payment was applied"
    described by "Indicates a payment has been received and applied to the account."
  }

  event CreditApplied is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    amount is MonetaryAmount with { briefly "Amount" described by "Credit amount." }
    reason is String with { briefly "Reason" described by "Credit reason." }
    targetInvoiceId is optional InvoiceId with { briefly "Invoice" described by "Target invoice." }
    newBalance is MonetaryAmount with { briefly "Balance" described by "New balance." }
  } with {
    briefly "Credit was applied"
    described by "Indicates a credit adjustment has been made to the account."
  }

  event AccountSuspended is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    reason is String with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Account was suspended"
    described by "Indicates the account has been suspended."
  }

  event AccountReactivated is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    reactivatedAt is TimeStamp with { briefly "Reactivated" described by "Reactivation time." }
  } with {
    briefly "Account was reactivated"
    described by "Indicates a suspended account has been restored to active status."
  }

  event AccountClosed is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    reason is String with { briefly "Reason" described by "Closure reason." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
    finalBalance is MonetaryAmount with { briefly "Balance" described by "Final balance." }
  } with {
    briefly "Account was closed"
    described by "Indicates the account has been permanently closed."
  }

  // === State Records ===

  record PendingActivationData is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    ratePlanId is RatePlanId with { briefly "Plan" described by "Rate plan." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Pending activation state data"
    described by "Initial state when account is created but not yet active."
  }

  record ActiveData is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    ratePlanId is RatePlanId with { briefly "Plan" described by "Rate plan." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
    currentBalance is MonetaryAmount with { briefly "Balance" described by "Current balance." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Active state data"
    described by {
      | The normal operating state where the customer can use services,
      | usage is being tracked, and invoices can be generated.
    }
  }

  record SuspendedData is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    ratePlanId is RatePlanId with { briefly "Plan" described by "Rate plan." }
    paymentMethod is PaymentMethod with { briefly "Method" described by "Payment method." }
    currentBalance is MonetaryAmount with { briefly "Balance" described by "Current balance." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
    suspensionReason is String with { briefly "Reason" described by "Suspension reason." }
  } with {
    briefly "Suspended state data"
    described by {
      | The account is blocked from incurring new usage, typically due to
      | non-payment or policy violations. Existing balances remain due.
    }
  }

  record ClosedData is {
    accountId is AccountId with { briefly "Account" described by "Account identifier." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer info." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
    closureReason is String with { briefly "Reason" described by "Closure reason." }
    finalBalance is MonetaryAmount with { briefly "Balance" described by "Final balance." }
  } with {
    briefly "Closed state data"
    described by "Terminal state after account closure with historical records retained."
  }

  // === States ===

  state PendingActivation of BillingAccount.PendingActivationData with {
    briefly "Account pending activation"
    described by "Initial state when account is created but not yet active."
  }

  state ActiveState of BillingAccount.ActiveData with {
    briefly "Account is active and can incur usage"
    described by "The normal operating state for billing."
  }

  state SuspendedState of BillingAccount.SuspendedData with {
    briefly "Account is suspended"
    described by "Account blocked from incurring new usage."
  }

  state ClosedState of BillingAccount.ClosedData with {
    briefly "Account is permanently closed"
    described by "Terminal state after account closure."
  }

  // === Handler ===

  handler BillingAccountHandler is {
    on command CreateAccount {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.PendingActivation with command CreateAccount
      tell event AccountCreated to entity BillingContext.BillingAccount
    }

    on command UpdateCustomerInfo {
      tell event CustomerInfoUpdated to entity BillingContext.BillingAccount
    }

    on command ChangeRatePlan {
      tell event RatePlanChanged to entity BillingContext.BillingAccount
    }

    on command RecordUsage {
      tell event UsageRecorded to entity BillingContext.BillingAccount
    }

    on command GenerateInvoice {
      tell event InvoiceGenerated to entity BillingContext.BillingAccount
    }

    on command ApplyPayment {
      tell event PaymentApplied to entity BillingContext.BillingAccount
    }

    on command ApplyCredit {
      tell event CreditApplied to entity BillingContext.BillingAccount
    }

    on command SuspendAccount {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.SuspendedState with command SuspendAccount
      tell event AccountSuspended to entity BillingContext.BillingAccount
    }

    on command ReactivateAccount {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.ActiveState with command ReactivateAccount
      tell event AccountReactivated to entity BillingContext.BillingAccount
    }

    on command CloseAccount {
      morph entity BillingContext.BillingAccount to state BillingContext.BillingAccount.ClosedState with command CloseAccount
      tell event AccountClosed to entity BillingContext.BillingAccount
    }
  } with {
    briefly "Command handler for BillingAccount entity"
    described by {
      | Processes all commands for the BillingAccount entity, managing state
      | transitions and emitting appropriate events for downstream processing.
    }
  }

} with {
  option is aggregate
  option event-sourced
  briefly "Billing account aggregate root"
  described by {
    | The BillingAccount entity is the aggregate root for customer billing.
    | It maintains account status, tracks unbilled usage, manages invoices,
    | and records payments. It follows event sourcing patterns for full
    | auditability of all billing activities.
  }
}
