// Revenue Assurance - AuditCase Entity

entity AuditCase is {

  command OpenAuditCase is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "New audit case identifier."
    }
    caseInfo is AuditCaseInfo with {
      briefly "Case info"
      described by "Audit case details."
    }
  } with {
    briefly "Open audit case"
    described by "Opens a new audit case for investigation."
  }

  command ReconcileRecords is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    billingRecords is many BillingRecord with {
      briefly "Billing records"
      described by "Billing records to reconcile."
    }
    usageRecords is many UsageRecord with {
      briefly "Usage records"
      described by "Network usage records to reconcile."
    }
  } with {
    briefly "Reconcile records"
    described by "Reconciles billing records against network usage."
  }

  command RecordDiscrepancy is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    reconciliationResults is many ReconciliationResult with {
      briefly "Results"
      described by "Reconciliation results with discrepancies."
    }
    totalVariance is Decimal(12, 2) with {
      briefly "Total variance"
      described by "Total monetary variance found."
    }
  } with {
    briefly "Record discrepancy"
    described by "Records discrepancies found during reconciliation."
  }

  command EscalateCase is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    escalatedTo is String(1, 100) with {
      briefly "Escalated to"
      described by "Person or team to escalate to."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Reason for escalation."
    }
  } with {
    briefly "Escalate case"
    described by "Escalates audit case to management."
  }

  command ResolveCase is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    resolution is ResolutionDetails with {
      briefly "Resolution"
      described by "Resolution details."
    }
  } with {
    briefly "Resolve case"
    described by "Resolves an audit case with corrective action."
  }

  command CloseCase is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    closedBy is String(1, 100) with {
      briefly "Closed by"
      described by "Person closing the case."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Closing summary."
    }
  } with {
    briefly "Close case"
    described by "Closes a resolved audit case."
  }

  command CancelCase is {
    caseId is AuditCaseId with {
      briefly "Case ID"
      described by "Audit case identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel case"
    described by "Cancels an audit case."
  }

  // Events
  event AuditCaseOpened is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    caseInfo is AuditCaseInfo with { briefly "Info" described by "Case info." }
    openedAt is TimeStamp with { briefly "Opened" described by "Opening time." }
  } with {
    briefly "Audit case opened"
    described by "Emitted when an audit case is opened."
  }

  event RecordsReconciled is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    recordCount is Natural with { briefly "Count" described by "Records reconciled." }
    matchedCount is Natural with { briefly "Matched" described by "Records matched." }
    reconciledAt is TimeStamp with { briefly "Reconciled" described by "Reconciliation time." }
  } with {
    briefly "Records reconciled"
    described by "Emitted when billing and usage records are reconciled."
  }

  event DiscrepancyRecorded is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    totalVariance is Decimal(12, 2) with { briefly "Variance" described by "Total variance." }
    discrepancyCount is Natural with { briefly "Count" described by "Discrepancy count." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Recording time." }
  } with {
    briefly "Discrepancy recorded"
    described by "Emitted when discrepancies are recorded."
  }

  event CaseEscalated is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    escalatedTo is String(1, 100) with { briefly "To" described by "Escalation target." }
    escalatedAt is TimeStamp with { briefly "Escalated" described by "Escalation time." }
  } with {
    briefly "Case escalated"
    described by "Emitted when audit case is escalated."
  }

  event CaseResolved is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    resolution is ResolutionDetails with { briefly "Resolution" described by "Resolution details." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Case resolved"
    described by "Emitted when audit case is resolved."
  }

  event CaseClosed is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    closedBy is String(1, 100) with { briefly "By" described by "Person closing." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closing time." }
  } with {
    briefly "Case closed"
    described by "Emitted when audit case is closed."
  }

  event CaseCancelled is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Case cancelled"
    described by "Emitted when audit case is cancelled."
  }

  // States
  record ActiveCaseData is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    caseInfo is AuditCaseInfo with { briefly "Info" described by "Case info." }
    status is CaseStatus with { briefly "Status" described by "Case status." }
    updatedReconciliationResults is many optional ReconciliationResult with { briefly "Results" described by "Reconciliation results." }
    updatedTotalVariance is optional Decimal(12, 2) with { briefly "Variance" described by "Total variance found." }
    updatedEscalatedTo is optional String(1, 100) with { briefly "Escalated to" described by "Escalation target." }
    openedAt is TimeStamp with { briefly "Opened" described by "Opening time." }
  } with {
    briefly "Active case state"
    described by "State for an active audit case."
  }

  record ClosedCaseData is {
    caseId is AuditCaseId with { briefly "Case" described by "Case ID." }
    resolution is ResolutionDetails with { briefly "Resolution" described by "Resolution details." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closing time." }
  } with {
    briefly "Closed case state"
    described by "State for a closed audit case."
  }

  state ActiveCaseState of AuditCase.ActiveCaseData with {
    briefly "Case active"
    described by "Audit case is being investigated."
  }

  state ClosedCaseState of AuditCase.ClosedCaseData with {
    briefly "Case closed"
    described by "Audit case has been closed."
  }

  handler AuditCaseHandler is {
    on command OpenAuditCase {
      morph entity RevenueAssuranceContext.AuditCase to state RevenueAssuranceContext.AuditCase.ActiveCaseState with command OpenAuditCase
      tell event AuditCaseOpened to entity RevenueAssuranceContext.AuditCase
    }
    on command ReconcileRecords {
      tell event RecordsReconciled to entity RevenueAssuranceContext.AuditCase
    }
    on command RecordDiscrepancy {
      tell event DiscrepancyRecorded to entity RevenueAssuranceContext.AuditCase
    }
    on command EscalateCase {
      tell event CaseEscalated to entity RevenueAssuranceContext.AuditCase
    }
    on command ResolveCase {
      tell event CaseResolved to entity RevenueAssuranceContext.AuditCase
    }
    on command CloseCase {
      morph entity RevenueAssuranceContext.AuditCase to state RevenueAssuranceContext.AuditCase.ClosedCaseState with command CloseCase
      tell event CaseClosed to entity RevenueAssuranceContext.AuditCase
    }
    on command CancelCase {
      tell event CaseCancelled to entity RevenueAssuranceContext.AuditCase
    }
  } with {
    briefly "Processes audit case commands"
    described by "Handles audit case lifecycle."
  }

} with {
  briefly "AuditCase aggregate"
  described by "Manages revenue assurance audit cases."
}
