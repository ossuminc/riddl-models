// Revenue Assurance - AuditCase Entity
entity AuditCase is {
  command OpenAuditCase is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |New audit case identifier.
      }
    }
    caseInfo: AuditCaseInfo with {
      briefly "Case info"
      described as {
        |Audit case details.
      }
    }
  } with {
    briefly "Open audit case"
    described as {
      |Opens a new audit case for investigation.
    }
  }
  command ReconcileRecords is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    billingRecords: BillingRecord+ with {
      briefly "Billing records"
      described as {
        |Billing records to reconcile.
      }
    }
    usageRecords: UsageRecord+ with {
      briefly "Usage records"
      described as {
        |Network usage records to reconcile.
      }
    }
  } with {
    briefly "Reconcile records"
    described as {
      |Reconciles billing records against network usage.
    }
  }
  command RecordDiscrepancy is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    reconciliationResults: ReconciliationResult+ with {
      briefly "Results"
      described as {
        |Reconciliation results with discrepancies.
      }
    }
    totalVariance: Decimal(12,2) with {
      briefly "Total variance"
      described as {
        |Total monetary variance found.
      }
    }
  } with {
    briefly "Record discrepancy"
    described as {
      |Records discrepancies found during reconciliation.
    }
  }
  command EscalateCase is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    escalatedTo: String(1,100) with {
      briefly "Escalated to"
      described as {
        |Person or team to escalate to.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason for escalation.
      }
    }
  } with {
    briefly "Escalate case"
    described as {
      |Escalates audit case to management.
    }
  }
  command ResolveCase is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    resolution: ResolutionDetails with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
  } with {
    briefly "Resolve case"
    described as {
      |Resolves an audit case with corrective action.
    }
  }
  command CloseCase is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Person closing the case.
      }
    }
    summary: String(1,2000) with {
      briefly "Summary"
      described as {
        |Closing summary.
      }
    }
  } with {
    briefly "Close case"
    described as {
      |Closes a resolved audit case.
    }
  }
  command CancelCase is  {
    caseId: AuditCaseId with {
      briefly "Case ID"
      described as {
        |Audit case identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel case"
    described as {
      |Cancels an audit case.
    }
  }
  // Events
  event AuditCaseOpened is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    caseInfo: AuditCaseInfo with {
      briefly "Info"
      described as {
        |Case info.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Opening time.
      }
    }
  } with {
    briefly "Audit case opened"
    described as {
      |Emitted when an audit case is opened.
    }
  }
  event RecordsReconciled is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    recordCount: Natural with {
      briefly "Count"
      described as {
        |Records reconciled.
      }
    }
    matchedCount: Natural with {
      briefly "Matched"
      described as {
        |Records matched.
      }
    }
    reconciledAt: TimeStamp with {
      briefly "Reconciled"
      described as {
        |Reconciliation time.
      }
    }
  } with {
    briefly "Records reconciled"
    described as {
      |Emitted when billing and usage records are reconciled.
    }
  }
  event DiscrepancyRecorded is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    totalVariance: Decimal(12,2) with {
      briefly "Variance"
      described as {
        |Total variance.
      }
    }
    discrepancyCount: Natural with {
      briefly "Count"
      described as {
        |Discrepancy count.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Discrepancy recorded"
    described as {
      |Emitted when discrepancies are recorded.
    }
  }
  event CaseEscalated is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    escalatedTo: String(1,100) with {
      briefly "To"
      described as {
        |Escalation target.
      }
    }
    escalatedAt: TimeStamp with {
      briefly "Escalated"
      described as {
        |Escalation time.
      }
    }
  } with {
    briefly "Case escalated"
    described as {
      |Emitted when audit case is escalated.
    }
  }
  event CaseResolved is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    resolution: ResolutionDetails with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Case resolved"
    described as {
      |Emitted when audit case is resolved.
    }
  }
  event CaseClosed is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    closedBy: String(1,100) with {
      briefly "By"
      described as {
        |Person closing.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closing time.
      }
    }
  } with {
    briefly "Case closed"
    described as {
      |Emitted when audit case is closed.
    }
  }
  event CaseCancelled is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Case cancelled"
    described as {
      |Emitted when audit case is cancelled.
    }
  }
  // States
  record ActiveCaseData is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    caseInfo: AuditCaseInfo with {
      briefly "Info"
      described as {
        |Case info.
      }
    }
    status: CaseStatus with {
      briefly "Status"
      described as {
        |Case status.
      }
    }
    updatedReconciliationResults: ReconciliationResult* with {
      briefly "Results"
      described as {
        |Reconciliation results.
      }
    }
    updatedTotalVariance: Decimal(12,2)? with {
      briefly "Variance"
      described as {
        |Total variance found.
      }
    }
    updatedEscalatedTo: String(1,100)? with {
      briefly "Escalated to"
      described as {
        |Escalation target.
      }
    }
    openedAt: TimeStamp with {
      briefly "Opened"
      described as {
        |Opening time.
      }
    }
  } with {
    briefly "Active case state"
    described as {
      |State for an active audit case.
    }
  }
  record ClosedCaseData is  {
    caseId: AuditCaseId with {
      briefly "Case"
      described as {
        |Case ID.
      }
    }
    resolution: ResolutionDetails with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closing time.
      }
    }
  } with {
    briefly "Closed case state"
    described as {
      |State for a closed audit case.
    }
  }
  state ActiveCaseState of type AuditCase.ActiveCaseData
  state ClosedCaseState of type AuditCase.ClosedCaseData
  handler AuditCaseHandler is {
    on command OpenAuditCase is {
      morph entity RevenueAssuranceContext.AuditCase to state RevenueAssuranceContext.AuditCase.ActiveCaseState with command OpenAuditCase
      tell event AuditCaseOpened to entity RevenueAssuranceContext.AuditCase
    }
    on command ReconcileRecords is {
      tell event RecordsReconciled to entity RevenueAssuranceContext.AuditCase
    }
    on command RecordDiscrepancy is {
      tell event DiscrepancyRecorded to entity RevenueAssuranceContext.AuditCase
    }
    on command EscalateCase is {
      tell event CaseEscalated to entity RevenueAssuranceContext.AuditCase
    }
    on command ResolveCase is {
      tell event CaseResolved to entity RevenueAssuranceContext.AuditCase
    }
    on command CloseCase is {
      morph entity RevenueAssuranceContext.AuditCase to state RevenueAssuranceContext.AuditCase.ClosedCaseState with command CloseCase
      tell event CaseClosed to entity RevenueAssuranceContext.AuditCase
    }
    on command CancelCase is {
      tell event CaseCancelled to entity RevenueAssuranceContext.AuditCase
    }
  } with {
    briefly "Processes audit case commands"
    described as {
      |Handles audit case lifecycle.
    }
  }
} with {
  briefly "AuditCase aggregate"
  described as {
    |Manages revenue assurance audit cases.
  }
}
