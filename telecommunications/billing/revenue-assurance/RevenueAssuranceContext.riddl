// Revenue Assurance - Revenue Assurance Context

context RevenueAssuranceContext is {

  include "types.riddl"
  include "AuditCase.riddl"

  repository AuditCaseRepository is {
    schema AuditCaseData is relational
      of auditCases as AuditCase
      index on field AuditCase.caseId
      index on field AuditCase.caseInfo.customerId
      index on field AuditCase.status

    handler AuditCasePersistence is {
      on event AuditCase.AuditCaseOpened {
        prompt "Store new audit case"
      }
      on event AuditCase.RecordsReconciled {
        prompt "Update case with reconciliation results"
      }
      on event AuditCase.DiscrepancyRecorded {
        prompt "Store discrepancy details"
      }
      on event AuditCase.CaseEscalated {
        prompt "Update case escalation status"
      }
      on event AuditCase.CaseResolved {
        prompt "Update case with resolution"
      }
      on event AuditCase.CaseClosed {
        prompt "Update case to closed"
      }
    } with {
      briefly "Persists audit case events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Audit case data persistence"
    described by "Persistent storage for audit cases."
  }

  projector RevenueAssuranceMetrics is {
    updates repository AuditCaseRepository

    record LeakageMetrics is {
      casesOpened is Natural with { briefly "Opened" described by "Cases opened." }
      casesResolved is Natural with { briefly "Resolved" described by "Cases resolved." }
      casesEscalated is Natural with { briefly "Escalated" described by "Cases escalated." }
      totalVarianceDetected is Decimal(14, 2) with { briefly "Total variance" described by "Total variance detected." }
      totalRecoveredAmount is Decimal(14, 2) with { briefly "Recovered" described by "Total recovered amount." }
    } with {
      briefly "Leakage metrics"
      described by "Revenue leakage detection metrics."
    }

    handler MetricsHandler is {
      on event AuditCase.AuditCaseOpened {
        prompt "Increment cases opened"
      }
      on event AuditCase.DiscrepancyRecorded {
        prompt "Add to total variance detected"
      }
      on event AuditCase.CaseEscalated {
        prompt "Increment cases escalated"
      }
      on event AuditCase.CaseResolved {
        prompt "Increment cases resolved and update recovered amount"
      }
    } with {
      briefly "Maintains revenue assurance metrics"
      described by "Projects events into leakage metrics."
    }
  } with {
    briefly "Revenue assurance metrics"
    described by "Revenue leakage detection analytics."
  }

} with {
  briefly "Bounded context for revenue assurance"
  described by "Telecom revenue assurance and leakage detection context."
}
