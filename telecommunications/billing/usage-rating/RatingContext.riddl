// Usage Rating - Rating Context
context RatingContext is {
  include "types.riddl"
  include "UsageRecord.riddl"
  repository RatingRepository is {
    schema RatingData is relational
      of usageRecords as type UsageRecord
        index on field UsageRecord.usageRecordId
        index on field UsageRecord.accountId
        index on field UsageRecord.status

    handler RatingPersistence is {
      on command UsageRecord.SubmitUsageRecord is {
        prompt "Store new usage record"
      }
      on command UsageRecord.ValidateUsageRecord is {
        prompt "Update record to validated"
      }
      on command UsageRecord.ApplyRatePlan is {
        prompt "Store applied rate plan"
      }
      on command UsageRecord.CalculateCharges is {
        prompt "Store calculated charges"
      }
      on command UsageRecord.SubmitToBilling is {
        prompt "Update record to billed"
      }
    } with {
      briefly "Persists rating commands"
      described as {
        |Handles command-driven persistence for rating.
      }
    }
  } with {
    briefly "Rating data persistence"
    described as {
      |Persistent storage for usage rating.
    }
  }
  projector RatingMetrics is {
    record UsageMetrics is  {
      recordsReceived: Natural with {
        briefly "Received"
        described as {
          |Records received.
        }
      }
      recordsRated: Natural with {
        briefly "Rated"
        described as {
          |Records rated.
        }
      }
      recordsRejected: Natural with {
        briefly "Rejected"
        described as {
          |Records rejected.
        }
      }
      totalRevenue: Decimal(14,2) with {
        briefly "Revenue"
        described as {
          |Total rated revenue.
        }
      }
      averageChargeAmount: Decimal(10,2) with {
        briefly "Avg charge"
        described as {
          |Average charge amount.
        }
      }
    } with {
      briefly "Usage metrics"
      described as {
        |Usage rating processing metrics.
      }
    }
    handler MetricsHandler is {
      on event UsageRecord.UsageRecordSubmitted is {
        prompt "Increment records received"
      }
      on event UsageRecord.ChargesCalculated is {
        prompt "Increment records rated and accumulate revenue"
      }
      on event UsageRecord.UsageRecordRejected is {
        prompt "Increment records rejected"
      }
    } with {
      briefly "Maintains rating metrics"
      described as {
        |Projects events into rating metrics.
      }
    }
  } with {
    briefly "Rating metrics"
    described as {
      |Usage rating analytics and reporting.
    }
  }
} with {
  briefly "Bounded context for usage rating"
  described as {
    |Telecom usage rating and charge calculation context.
  }
}
