// Usage Rating - UsageRecord Entity

entity UsageRecord is {

  command SubmitUsageRecord is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "New usage record identifier."
    }
    accountId is AccountId with {
      briefly "Account"
      described by "Customer billing account."
    }
    cdr is CallDetailRecord with {
      briefly "CDR"
      described by "Call detail record to rate."
    }
  } with {
    briefly "Submit usage record"
    described by "Submits a CDR for rating."
  }

  command ValidateUsageRecord is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    validatedBy is String(3, 100) with {
      briefly "Validated by"
      described by "System or person validating."
    }
  } with {
    briefly "Validate usage record"
    described by "Validates a submitted usage record."
  }

  command ApplyRatePlan is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    ratePlan is RatePlanInfo with {
      briefly "Rate plan"
      described by "Rate plan to apply."
    }
  } with {
    briefly "Apply rate plan"
    described by "Applies a rate plan to the usage record."
  }

  command CalculateCharges is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    charges is many UsageCharge with {
      briefly "Charges"
      described by "Calculated usage charges."
    }
    totalAmount is Decimal(10, 2) with {
      briefly "Total"
      described by "Total charge amount."
    }
  } with {
    briefly "Calculate charges"
    described by "Records calculated charges for usage."
  }

  command SubmitToBilling is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    submittedAt is TimeStamp with {
      briefly "Submitted"
      described by "Submission time."
    }
  } with {
    briefly "Submit to billing"
    described by "Submits rated record to billing system."
  }

  command DisputeUsageRecord is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Dispute reason."
    }
  } with {
    briefly "Dispute usage record"
    described by "Marks a usage record as disputed."
  }

  command RejectUsageRecord is {
    usageRecordId is UsageRecordId with {
      briefly "Usage record ID"
      described by "Usage record identifier."
    }
    rejection is RejectionReason with {
      briefly "Rejection"
      described by "Rejection reason."
    }
  } with {
    briefly "Reject usage record"
    described by "Rejects an invalid usage record."
  }

  // Events
  event UsageRecordSubmitted is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Submission time." }
  } with {
    briefly "Usage record submitted"
    described by "Emitted when a CDR is submitted for rating."
  }

  event UsageRecordValidated is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    validatedAt is TimeStamp with { briefly "Validated" described by "Validation time." }
  } with {
    briefly "Usage record validated"
    described by "Emitted when a usage record passes validation."
  }

  event RatePlanApplied is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    ratePlanId is RatePlanId with { briefly "Rate plan" described by "Rate plan ID." }
    appliedAt is TimeStamp with { briefly "Applied" described by "Application time." }
  } with {
    briefly "Rate plan applied"
    described by "Emitted when a rate plan is resolved for usage."
  }

  event ChargesCalculated is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    totalAmount is Decimal(10, 2) with { briefly "Total" described by "Total charge." }
    chargeCount is Natural with { briefly "Count" described by "Number of charges." }
    calculatedAt is TimeStamp with { briefly "Calculated" described by "Calculation time." }
  } with {
    briefly "Charges calculated"
    described by "Emitted when usage charges are calculated."
  }

  event UsageRecordBilled is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Billing submission time." }
  } with {
    briefly "Usage record billed"
    described by "Emitted when rated record is sent to billing."
  }

  event UsageRecordDisputed is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Dispute reason." }
    disputedAt is TimeStamp with { briefly "Disputed" described by "Dispute time." }
  } with {
    briefly "Usage record disputed"
    described by "Emitted when a usage record is disputed."
  }

  event UsageRecordRejected is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    rejection is RejectionReason with { briefly "Rejection" described by "Rejection details." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Usage record rejected"
    described by "Emitted when a usage record is rejected."
  }

  // States
  record ActiveStateData is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    cdr is CallDetailRecord with { briefly "CDR" described by "Call detail record." }
    status is RatingStatus with { briefly "Status" described by "Rating status." }
    ratePlan is optional RatePlanInfo with { briefly "Rate plan" described by "Applied rate plan." }
    charges is many optional UsageCharge with { briefly "Charges" described by "Usage charges." }
    totalAmount is optional Decimal(10, 2) with { briefly "Total" described by "Total charge amount." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active usage record state"
    described by "State for a usage record being processed."
  }

  record CompletedStateData is {
    usageRecordId is UsageRecordId with { briefly "Record" described by "Record ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    totalAmount is Decimal(10, 2) with { briefly "Total" described by "Final charge amount." }
    submittedAt is TimeStamp with { briefly "Submitted" described by "Billing submission time." }
  } with {
    briefly "Completed usage record state"
    described by "State for a rated and billed usage record."
  }

  state ActiveState of UsageRecord.ActiveStateData with {
    briefly "Record active"
    described by "Usage record is being processed and rated."
  }

  state CompletedState of UsageRecord.CompletedStateData with {
    briefly "Record completed"
    described by "Usage record is rated and submitted to billing."
  }

  handler UsageRecordHandler is {
    on command SubmitUsageRecord {
      morph entity RatingContext.UsageRecord to state RatingContext.UsageRecord.ActiveState with command SubmitUsageRecord
      tell event UsageRecordSubmitted to entity RatingContext.UsageRecord
    }
    on command ValidateUsageRecord {
      tell event UsageRecordValidated to entity RatingContext.UsageRecord
    }
    on command ApplyRatePlan {
      tell event RatePlanApplied to entity RatingContext.UsageRecord
    }
    on command CalculateCharges {
      tell event ChargesCalculated to entity RatingContext.UsageRecord
    }
    on command SubmitToBilling {
      morph entity RatingContext.UsageRecord to state RatingContext.UsageRecord.CompletedState with command SubmitToBilling
      tell event UsageRecordBilled to entity RatingContext.UsageRecord
    }
    on command DisputeUsageRecord {
      tell event UsageRecordDisputed to entity RatingContext.UsageRecord
    }
    on command RejectUsageRecord {
      tell event UsageRecordRejected to entity RatingContext.UsageRecord
    }
  } with {
    briefly "Processes usage record commands"
    described by "Handles usage record rating lifecycle."
  }

} with {
  briefly "UsageRecord aggregate"
  described by "Manages telecom usage records through the rating process."
}
