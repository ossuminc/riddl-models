// Usage Rating - UsageRecord Entity
entity UsageRecord is {
  command SubmitUsageRecord is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |New usage record identifier.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Customer billing account.
      }
    }
    cdr: CallDetailRecord with {
      briefly "CDR"
      described as {
        |Call detail record to rate.
      }
    }
  } with {
    briefly "Submit usage record"
    described as {
      |Submits a CDR for rating.
    }
  }
  command ValidateUsageRecord is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    validatedBy: String(3,100) with {
      briefly "Validated by"
      described as {
        |System or person validating.
      }
    }
  } with {
    briefly "Validate usage record"
    described as {
      |Validates a submitted usage record.
    }
  }
  command ApplyRatePlan is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    ratePlan: RatePlanInfo with {
      briefly "Rate plan"
      described as {
        |Rate plan to apply.
      }
    }
  } with {
    briefly "Apply rate plan"
    described as {
      |Applies a rate plan to the usage record.
    }
  }
  command CalculateCharges is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    charges: UsageCharge+ with {
      briefly "Charges"
      described as {
        |Calculated usage charges.
      }
    }
    totalAmount: Decimal(10,2) with {
      briefly "Total"
      described as {
        |Total charge amount.
      }
    }
  } with {
    briefly "Calculate charges"
    described as {
      |Records calculated charges for usage.
    }
  }
  command SubmitToBilling is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Submit to billing"
    described as {
      |Submits rated record to billing system.
    }
  }
  command DisputeUsageRecord is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Dispute reason.
      }
    }
  } with {
    briefly "Dispute usage record"
    described as {
      |Marks a usage record as disputed.
    }
  }
  command RejectUsageRecord is  {
    usageRecordId: UsageRecordId with {
      briefly "Usage record ID"
      described as {
        |Usage record identifier.
      }
    }
    rejection: RejectionReason with {
      briefly "Rejection"
      described as {
        |Rejection reason.
      }
    }
  } with {
    briefly "Reject usage record"
    described as {
      |Rejects an invalid usage record.
    }
  }
  // Events
  event UsageRecordSubmitted is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Usage record submitted"
    described as {
      |Emitted when a CDR is submitted for rating.
    }
  }
  event UsageRecordValidated is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    validatedAt: TimeStamp with {
      briefly "Validated"
      described as {
        |Validation time.
      }
    }
  } with {
    briefly "Usage record validated"
    described as {
      |Emitted when a usage record passes validation.
    }
  }
  event RatePlanApplied is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    ratePlanId: RatePlanId with {
      briefly "Rate plan"
      described as {
        |Rate plan ID.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Rate plan applied"
    described as {
      |Emitted when a rate plan is resolved for usage.
    }
  }
  event ChargesCalculated is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    totalAmount: Decimal(10,2) with {
      briefly "Total"
      described as {
        |Total charge.
      }
    }
    chargeCount: Natural with {
      briefly "Count"
      described as {
        |Number of charges.
      }
    }
    calculatedAt: TimeStamp with {
      briefly "Calculated"
      described as {
        |Calculation time.
      }
    }
  } with {
    briefly "Charges calculated"
    described as {
      |Emitted when usage charges are calculated.
    }
  }
  event UsageRecordBilled is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Billing submission time.
      }
    }
  } with {
    briefly "Usage record billed"
    described as {
      |Emitted when rated record is sent to billing.
    }
  }
  event UsageRecordDisputed is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Dispute reason.
      }
    }
    disputedAt: TimeStamp with {
      briefly "Disputed"
      described as {
        |Dispute time.
      }
    }
  } with {
    briefly "Usage record disputed"
    described as {
      |Emitted when a usage record is disputed.
    }
  }
  event UsageRecordRejected is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    rejection: RejectionReason with {
      briefly "Rejection"
      described as {
        |Rejection details.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Usage record rejected"
    described as {
      |Emitted when a usage record is rejected.
    }
  }
  // States
  record ActiveStateData is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    cdr: CallDetailRecord with {
      briefly "CDR"
      described as {
        |Call detail record.
      }
    }
    status: RatingStatus with {
      briefly "Status"
      described as {
        |Rating status.
      }
    }
    updatedRatePlan: RatePlanInfo? with {
      briefly "Rate plan"
      described as {
        |Applied rate plan.
      }
    }
    updatedCharges: UsageCharge* with {
      briefly "Charges"
      described as {
        |Usage charges.
      }
    }
    updatedTotalAmount: Decimal(10,2)? with {
      briefly "Total"
      described as {
        |Total charge amount.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active usage record state"
    described as {
      |State for a usage record being processed.
    }
  }
  record CompletedStateData is  {
    usageRecordId: UsageRecordId with {
      briefly "Record"
      described as {
        |Record ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    totalAmount: Decimal(10,2) with {
      briefly "Total"
      described as {
        |Final charge amount.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Billing submission time.
      }
    }
  } with {
    briefly "Completed usage record state"
    described as {
      |State for a rated and billed usage record.
    }
  }
  state ActiveState of type UsageRecord.ActiveStateData
  state CompletedState of type UsageRecord.CompletedStateData
  handler UsageRecordHandler is {
    on command SubmitUsageRecord is {
      morph entity RatingContext.UsageRecord to state RatingContext.UsageRecord.ActiveState with command SubmitUsageRecord
      tell event UsageRecordSubmitted to entity RatingContext.UsageRecord
    }
    on command ValidateUsageRecord is {
      tell event UsageRecordValidated to entity RatingContext.UsageRecord
    }
    on command ApplyRatePlan is {
      tell event RatePlanApplied to entity RatingContext.UsageRecord
    }
    on command CalculateCharges is {
      tell event ChargesCalculated to entity RatingContext.UsageRecord
    }
    on command SubmitToBilling is {
      morph entity RatingContext.UsageRecord to state RatingContext.UsageRecord.CompletedState with command SubmitToBilling
      tell event UsageRecordBilled to entity RatingContext.UsageRecord
    }
    on command DisputeUsageRecord is {
      tell event UsageRecordDisputed to entity RatingContext.UsageRecord
    }
    on command RejectUsageRecord is {
      tell event UsageRecordRejected to entity RatingContext.UsageRecord
    }
  } with {
    briefly "Processes usage record commands"
    described as {
      |Handles usage record rating lifecycle.
    }
  }
} with {
  briefly "UsageRecord aggregate"
  described as {
    |Manages telecom usage records through the rating process.
  }
}
