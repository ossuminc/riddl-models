// Service Provisioning - ServiceOrder Entity
entity ServiceOrder is {
  command CreateOrder is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |New order identifier.
      }
    }
    orderInfo: ServiceOrderInfo with {
      briefly "Order info"
      described as {
        |Service order details.
      }
    }
    serviceSpec: ServiceSpec with {
      briefly "Service spec"
      described as {
        |Service specification.
      }
    }
  } with {
    briefly "Create order"
    described as {
      |Creates a service order.
    }
  }
  command ValidateOrder is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    validatedBy: String(1,100) with {
      briefly "Validated by"
      described as {
        |Person validating.
      }
    }
  } with {
    briefly "Validate order"
    described as {
      |Validates service order.
    }
  }
  command DesignService is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    resources: NetworkResource+ with {
      briefly "Resources"
      described as {
        |Network resources.
      }
    }
  } with {
    briefly "Design service"
    described as {
      |Designs service network resources.
    }
  }
  command ExecuteProvisioning is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    tasks: ProvisioningTask+ with {
      briefly "Tasks"
      described as {
        |Provisioning tasks.
      }
    }
  } with {
    briefly "Execute provisioning"
    described as {
      |Executes network provisioning.
    }
  }
  command RecordTaskCompletion is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    taskId: UUID with {
      briefly "Task ID"
      described as {
        |Task identifier.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Task succeeded.
      }
    }
    errorMessage: String(1,500)? with {
      briefly "Error"
      described as {
        |Error message if failed.
      }
    }
  } with {
    briefly "Record task completion"
    described as {
      |Records provisioning task completion.
    }
  }
  command TestService is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    testResults: TestResult+ with {
      briefly "Results"
      described as {
        |Test results.
      }
    }
  } with {
    briefly "Test service"
    described as {
      |Tests provisioned service.
    }
  }
  command ActivateService is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Activate service"
    described as {
      |Activates customer service.
    }
  }
  command FailOrder is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
  } with {
    briefly "Fail order"
    described as {
      |Marks order as failed.
    }
  }
  command CancelOrder is  {
    orderId: ServiceOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel order"
    described as {
      |Cancels service order.
    }
  }
  // Events
  event OrderCreated is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: ServiceOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Order created"
    described as {
      |Emitted when order is created.
    }
  }
  event OrderValidated is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    validatedAt: TimeStamp with {
      briefly "Validated"
      described as {
        |Validation time.
      }
    }
  } with {
    briefly "Order validated"
    described as {
      |Emitted when order is validated.
    }
  }
  event ServiceDesigned is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    resources: NetworkResource+ with {
      briefly "Resources"
      described as {
        |Network resources.
      }
    }
    designedAt: TimeStamp with {
      briefly "Designed"
      described as {
        |Design time.
      }
    }
  } with {
    briefly "Service designed"
    described as {
      |Emitted when service is designed.
    }
  }
  event ProvisioningStarted is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    taskCount: Natural with {
      briefly "Tasks"
      described as {
        |Task count.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
  } with {
    briefly "Provisioning started"
    described as {
      |Emitted when provisioning starts.
    }
  }
  event TaskCompleted is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    taskId: UUID with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    success: Boolean with {
      briefly "Success"
      described as {
        |Task success.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Task completed"
    described as {
      |Emitted when task completes.
    }
  }
  event ServiceTested is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    allPassed: Boolean with {
      briefly "All passed"
      described as {
        |All tests passed.
      }
    }
    testedAt: TimeStamp with {
      briefly "Tested"
      described as {
        |Test time.
      }
    }
  } with {
    briefly "Service tested"
    described as {
      |Emitted when service is tested.
    }
  }
  event ServiceActivated is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    serviceId: ServiceId with {
      briefly "Service"
      described as {
        |Service ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Service activated"
    described as {
      |Emitted when service is activated.
    }
  }
  event OrderFailed is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Order failed"
    described as {
      |Emitted when order fails.
    }
  }
  event OrderCancelled is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Order cancelled"
    described as {
      |Emitted when order is cancelled.
    }
  }
  // States
  record ActiveStateData is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: ServiceOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    serviceSpec: ServiceSpec with {
      briefly "Spec"
      described as {
        |Service spec.
      }
    }
    status: OrderStatus with {
      briefly "Status"
      described as {
        |Order status.
      }
    }
    allocatedResources: NetworkResource* with {
      briefly "Resources"
      described as {
        |Network resources.
      }
    }
    scheduledTasks: ProvisioningTask* with {
      briefly "Tasks"
      described as {
        |Provisioning tasks.
      }
    }
    completedTestResults: TestResult* with {
      briefly "Tests"
      described as {
        |Test results.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active order state"
    described as {
      |State for active service order.
    }
  }
  record CompletedStateData is  {
    orderId: ServiceOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    serviceId: ServiceId with {
      briefly "Service"
      described as {
        |Service ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Completed order state"
    described as {
      |State for completed order.
    }
  }
  state ActiveState of type ServiceOrder.ActiveStateData
  state CompletedState of type ServiceOrder.CompletedStateData
  handler ServiceOrderHandler is {
    on command CreateOrder is {
      morph entity ProvisioningContext.ServiceOrder to state ProvisioningContext.ServiceOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity ProvisioningContext.ServiceOrder
    }
    on command ValidateOrder is {
      tell event OrderValidated to entity ProvisioningContext.ServiceOrder
    }
    on command DesignService is {
      tell event ServiceDesigned to entity ProvisioningContext.ServiceOrder
    }
    on command ExecuteProvisioning is {
      tell event ProvisioningStarted to entity ProvisioningContext.ServiceOrder
    }
    on command RecordTaskCompletion is {
      tell event TaskCompleted to entity ProvisioningContext.ServiceOrder
    }
    on command TestService is {
      tell event ServiceTested to entity ProvisioningContext.ServiceOrder
    }
    on command ActivateService is {
      morph entity ProvisioningContext.ServiceOrder to state ProvisioningContext.ServiceOrder.CompletedState with command ActivateService
      tell event ServiceActivated to entity ProvisioningContext.ServiceOrder
    }
    on command FailOrder is {
      tell event OrderFailed to entity ProvisioningContext.ServiceOrder
    }
    on command CancelOrder is {
      tell event OrderCancelled to entity ProvisioningContext.ServiceOrder
    }
  } with {
    briefly "Processes service order commands"
    described as {
      |Handles service order lifecycle.
    }
  }
} with {
  briefly "ServiceOrder aggregate"
  described as {
    |Manages telecom service orders.
  }
}
