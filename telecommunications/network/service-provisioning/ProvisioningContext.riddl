// Service Provisioning - Provisioning Context

context ProvisioningContext is {

  include "types.riddl"
  include "ServiceOrder.riddl"

  repository ProvisioningRepository is {
    schema ProvisioningData is relational
      of serviceOrders as ServiceOrder
      index on field ServiceOrder.orderId
      index on field ServiceOrder.orderInfo.customerId
      index on field ServiceOrder.status

    handler ProvisioningPersistence is {
      on event ServiceOrder.OrderCreated {
        prompt "Store new service order"
      }
      on event ServiceOrder.OrderValidated {
        prompt "Update order to validated"
      }
      on event ServiceOrder.ServiceDesigned {
        prompt "Store service design"
      }
      on event ServiceOrder.TaskCompleted {
        prompt "Update task status"
      }
      on event ServiceOrder.ServiceActivated {
        prompt "Update order to activated"
      }
    } with {
      briefly "Persists provisioning events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Provisioning data persistence"
    described by "Persistent storage for provisioning."
  }

  projector ProvisioningMetrics is {
    updates repository ProvisioningRepository

    record OrderMetrics is {
      ordersReceived is Natural with { briefly "Received" described by "Orders received." }
      ordersActivated is Natural with { briefly "Activated" described by "Orders activated." }
      ordersFailed is Natural with { briefly "Failed" described by "Orders failed." }
      averageProvisioningTime is Decimal(8, 2) with { briefly "Avg time" described by "Average provisioning hours." }
    } with {
      briefly "Order metrics"
      described by "Order processing metrics."
    }

    handler MetricsHandler is {
      on event ServiceOrder.OrderCreated {
        prompt "Increment orders received"
      }
      on event ServiceOrder.ServiceActivated {
        prompt "Increment orders activated and calculate time"
      }
      on event ServiceOrder.OrderFailed {
        prompt "Increment orders failed"
      }
    } with {
      briefly "Maintains provisioning metrics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Provisioning metrics"
    described by "Service provisioning analytics."
  }

} with {
  briefly "Bounded context for service provisioning"
  described by "Telecom service provisioning context."
}
