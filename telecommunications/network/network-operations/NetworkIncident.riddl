// Network Operations - NetworkIncident Entity
entity NetworkIncident is {
  command CreateIncident is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |New incident identifier.
      }
    }
    incidentInfo: IncidentInfo with {
      briefly "Info"
      described as {
        |Incident details.
      }
    }
    affectedElements: NetworkElementId+ with {
      briefly "Elements"
      described as {
        |Affected network elements.
      }
    }
    affectedServices: AffectedService* with {
      briefly "Services"
      described as {
        |Affected services.
      }
    }
  } with {
    briefly "Create incident"
    described as {
      |Creates a new network incident.
    }
  }
  command AcknowledgeIncident is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    acknowledgedBy: OperatorId with {
      briefly "Acknowledged by"
      described as {
        |Operator acknowledging.
      }
    }
  } with {
    briefly "Acknowledge incident"
    described as {
      |Acknowledges a network incident.
    }
  }
  command StartInvestigation is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    assignedTo: OperatorId with {
      briefly "Assigned to"
      described as {
        |Operator investigating.
      }
    }
    diagnostics: DiagnosticResult* with {
      briefly "Diagnostics"
      described as {
        |Initial diagnostic results.
      }
    }
  } with {
    briefly "Start investigation"
    described as {
      |Begins incident investigation.
    }
  }
  command EscalateIncident is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    escalation: EscalationInfo with {
      briefly "Escalation"
      described as {
        |Escalation details.
      }
    }
  } with {
    briefly "Escalate incident"
    described as {
      |Escalates incident to higher tier.
    }
  }
  command BeginMitigation is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    mitigationPlan: String(3,2000) with {
      briefly "Plan"
      described as {
        |Mitigation plan description.
      }
    }
    mitigatedBy: OperatorId with {
      briefly "Mitigated by"
      described as {
        |Operator executing mitigation.
      }
    }
  } with {
    briefly "Begin mitigation"
    described as {
      |Starts mitigation actions.
    }
  }
  command ResolveIncident is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    resolutionInfo: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
  } with {
    briefly "Resolve incident"
    described as {
      |Resolves the network incident.
    }
  }
  command CloseIncident is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    closedBy: OperatorId with {
      briefly "Closed by"
      described as {
        |Operator closing incident.
      }
    }
    postMortem: String(3,5000)? with {
      briefly "Post-mortem"
      described as {
        |Post-mortem analysis.
      }
    }
  } with {
    briefly "Close incident"
    described as {
      |Closes a resolved incident.
    }
  }
  command AddTimelineEntry is  {
    incidentId: IncidentId with {
      briefly "Incident ID"
      described as {
        |Incident identifier.
      }
    }
    entry: TimelineEntry with {
      briefly "Entry"
      described as {
        |Timeline entry to add.
      }
    }
  } with {
    briefly "Add timeline entry"
    described as {
      |Adds an entry to the incident timeline.
    }
  }
  // Events
  event IncidentCreated is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    incidentInfo: IncidentInfo with {
      briefly "Info"
      described as {
        |Incident info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Incident created"
    described as {
      |Emitted when incident is created.
    }
  }
  event IncidentAcknowledged is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    acknowledgedBy: OperatorId with {
      briefly "Operator"
      described as {
        |Acknowledging operator.
      }
    }
    acknowledgedAt: TimeStamp with {
      briefly "Acknowledged"
      described as {
        |Acknowledgement time.
      }
    }
  } with {
    briefly "Incident acknowledged"
    described as {
      |Emitted when incident is acknowledged.
    }
  }
  event InvestigationStarted is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    assignedTo: OperatorId with {
      briefly "Assigned"
      described as {
        |Assigned operator.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Investigation start time.
      }
    }
  } with {
    briefly "Investigation started"
    described as {
      |Emitted when investigation begins.
    }
  }
  event IncidentEscalated is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    escalation: EscalationInfo with {
      briefly "Escalation"
      described as {
        |Escalation details.
      }
    }
  } with {
    briefly "Incident escalated"
    described as {
      |Emitted when incident is escalated.
    }
  }
  event MitigationStarted is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    mitigationPlan: String(3,2000) with {
      briefly "Plan"
      described as {
        |Mitigation plan.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Mitigation start time.
      }
    }
  } with {
    briefly "Mitigation started"
    described as {
      |Emitted when mitigation begins.
    }
  }
  event IncidentResolved is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    resolutionInfo: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
  } with {
    briefly "Incident resolved"
    described as {
      |Emitted when incident is resolved.
    }
  }
  event IncidentClosed is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    closedBy: OperatorId with {
      briefly "Closed by"
      described as {
        |Closing operator.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Incident closed"
    described as {
      |Emitted when incident is closed.
    }
  }
  event TimelineEntryAdded is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    entry: TimelineEntry with {
      briefly "Entry"
      described as {
        |Timeline entry.
      }
    }
  } with {
    briefly "Timeline entry added"
    described as {
      |Emitted when a timeline entry is added.
    }
  }
  // States
  record ActiveIncidentData is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    incidentInfo: IncidentInfo with {
      briefly "Info"
      described as {
        |Incident details.
      }
    }
    status: IncidentStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    affectedElements: NetworkElementId+ with {
      briefly "Elements"
      described as {
        |Affected elements.
      }
    }
    affectedServices: AffectedService* with {
      briefly "Services"
      described as {
        |Affected services.
      }
    }
    updatedAssignedTo: OperatorId? with {
      briefly "Assigned"
      described as {
        |Assigned operator.
      }
    }
    escalations: EscalationInfo* with {
      briefly "Escalations"
      described as {
        |Escalation history.
      }
    }
    diagnostics: DiagnosticResult* with {
      briefly "Diagnostics"
      described as {
        |Diagnostic results.
      }
    }
    timeline: TimelineEntry* with {
      briefly "Timeline"
      described as {
        |Incident timeline.
      }
    }
    updatedMitigationPlan: String(3,2000)? with {
      briefly "Plan"
      described as {
        |Mitigation plan.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active incident state"
    described as {
      |State for an active network incident.
    }
  }
  record ClosedIncidentData is  {
    incidentId: IncidentId with {
      briefly "Incident"
      described as {
        |Incident ID.
      }
    }
    incidentInfo: IncidentInfo with {
      briefly "Info"
      described as {
        |Incident details.
      }
    }
    resolutionInfo: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
    totalDuration: Duration with {
      briefly "Duration"
      described as {
        |Total incident duration.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Closure time.
      }
    }
  } with {
    briefly "Closed incident state"
    described as {
      |State for a closed incident.
    }
  }
  state ActiveIncidentState of type NetworkIncident.ActiveIncidentData
  state ClosedIncidentState of type NetworkIncident.ClosedIncidentData
  handler NetworkIncidentHandler is {
    on command CreateIncident is {
      morph entity OperationsContext.NetworkIncident to state OperationsContext.NetworkIncident.ActiveIncidentState with command CreateIncident
      tell event IncidentCreated to entity OperationsContext.NetworkIncident
    }
    on command AcknowledgeIncident is {
      tell event IncidentAcknowledged to entity OperationsContext.NetworkIncident
    }
    on command StartInvestigation is {
      tell event InvestigationStarted to entity OperationsContext.NetworkIncident
    }
    on command EscalateIncident is {
      tell event IncidentEscalated to entity OperationsContext.NetworkIncident
    }
    on command BeginMitigation is {
      tell event MitigationStarted to entity OperationsContext.NetworkIncident
    }
    on command ResolveIncident is {
      tell event IncidentResolved to entity OperationsContext.NetworkIncident
    }
    on command CloseIncident is {
      morph entity OperationsContext.NetworkIncident to state OperationsContext.NetworkIncident.ClosedIncidentState with command CloseIncident
      tell event IncidentClosed to entity OperationsContext.NetworkIncident
    }
    on command AddTimelineEntry is {
      tell event TimelineEntryAdded to entity OperationsContext.NetworkIncident
    }
  } with {
    briefly "Processes incident commands"
    described as {
      |Handles network incident lifecycle.
    }
  }
} with {
  briefly "NetworkIncident aggregate"
  described as {
    |Manages network incident lifecycle.
  }
}
