// Network Operations - NetworkIncident Entity

entity NetworkIncident is {

  command CreateIncident is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "New incident identifier."
    }
    incidentInfo is IncidentInfo with {
      briefly "Info"
      described by "Incident details."
    }
    affectedElements is many NetworkElementId with {
      briefly "Elements"
      described by "Affected network elements."
    }
    affectedServices is many optional AffectedService with {
      briefly "Services"
      described by "Affected services."
    }
  } with {
    briefly "Create incident"
    described by "Creates a new network incident."
  }

  command AcknowledgeIncident is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    acknowledgedBy is OperatorId with {
      briefly "Acknowledged by"
      described by "Operator acknowledging."
    }
  } with {
    briefly "Acknowledge incident"
    described by "Acknowledges a network incident."
  }

  command StartInvestigation is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    assignedTo is OperatorId with {
      briefly "Assigned to"
      described by "Operator investigating."
    }
    diagnostics is many optional DiagnosticResult with {
      briefly "Diagnostics"
      described by "Initial diagnostic results."
    }
  } with {
    briefly "Start investigation"
    described by "Begins incident investigation."
  }

  command EscalateIncident is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    escalation is EscalationInfo with {
      briefly "Escalation"
      described by "Escalation details."
    }
  } with {
    briefly "Escalate incident"
    described by "Escalates incident to higher tier."
  }

  command BeginMitigation is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    mitigationPlan is String(3, 2000) with {
      briefly "Plan"
      described by "Mitigation plan description."
    }
    mitigatedBy is OperatorId with {
      briefly "Mitigated by"
      described by "Operator executing mitigation."
    }
  } with {
    briefly "Begin mitigation"
    described by "Starts mitigation actions."
  }

  command ResolveIncident is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    resolutionInfo is ResolutionInfo with {
      briefly "Resolution"
      described by "Resolution details."
    }
  } with {
    briefly "Resolve incident"
    described by "Resolves the network incident."
  }

  command CloseIncident is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    closedBy is OperatorId with {
      briefly "Closed by"
      described by "Operator closing incident."
    }
    postMortem is optional String(3, 5000) with {
      briefly "Post-mortem"
      described by "Post-mortem analysis."
    }
  } with {
    briefly "Close incident"
    described by "Closes a resolved incident."
  }

  command AddTimelineEntry is {
    incidentId is IncidentId with {
      briefly "Incident ID"
      described by "Incident identifier."
    }
    entry is TimelineEntry with {
      briefly "Entry"
      described by "Timeline entry to add."
    }
  } with {
    briefly "Add timeline entry"
    described by "Adds an entry to the incident timeline."
  }

  // Events
  event IncidentCreated is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    incidentInfo is IncidentInfo with { briefly "Info" described by "Incident info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Incident created"
    described by "Emitted when incident is created."
  }

  event IncidentAcknowledged is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    acknowledgedBy is OperatorId with { briefly "Operator" described by "Acknowledging operator." }
    acknowledgedAt is TimeStamp with { briefly "Acknowledged" described by "Acknowledgement time." }
  } with {
    briefly "Incident acknowledged"
    described by "Emitted when incident is acknowledged."
  }

  event InvestigationStarted is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    assignedTo is OperatorId with { briefly "Assigned" described by "Assigned operator." }
    startedAt is TimeStamp with { briefly "Started" described by "Investigation start time." }
  } with {
    briefly "Investigation started"
    described by "Emitted when investigation begins."
  }

  event IncidentEscalated is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    escalation is EscalationInfo with { briefly "Escalation" described by "Escalation details." }
  } with {
    briefly "Incident escalated"
    described by "Emitted when incident is escalated."
  }

  event MitigationStarted is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    mitigationPlan is String(3, 2000) with { briefly "Plan" described by "Mitigation plan." }
    startedAt is TimeStamp with { briefly "Started" described by "Mitigation start time." }
  } with {
    briefly "Mitigation started"
    described by "Emitted when mitigation begins."
  }

  event IncidentResolved is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    resolutionInfo is ResolutionInfo with { briefly "Resolution" described by "Resolution details." }
  } with {
    briefly "Incident resolved"
    described by "Emitted when incident is resolved."
  }

  event IncidentClosed is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    closedBy is OperatorId with { briefly "Closed by" described by "Closing operator." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Incident closed"
    described by "Emitted when incident is closed."
  }

  event TimelineEntryAdded is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    entry is TimelineEntry with { briefly "Entry" described by "Timeline entry." }
  } with {
    briefly "Timeline entry added"
    described by "Emitted when a timeline entry is added."
  }

  // States
  record ActiveIncidentData is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    incidentInfo is IncidentInfo with { briefly "Info" described by "Incident details." }
    status is IncidentStatus with { briefly "Status" described by "Current status." }
    affectedElements is many NetworkElementId with { briefly "Elements" described by "Affected elements." }
    affectedServices is many optional AffectedService with { briefly "Services" described by "Affected services." }
    assignedTo is optional OperatorId with { briefly "Assigned" described by "Assigned operator." }
    escalations is many optional EscalationInfo with { briefly "Escalations" described by "Escalation history." }
    diagnostics is many optional DiagnosticResult with { briefly "Diagnostics" described by "Diagnostic results." }
    timeline is many optional TimelineEntry with { briefly "Timeline" described by "Incident timeline." }
    mitigationPlan is optional String(3, 2000) with { briefly "Plan" described by "Mitigation plan." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active incident state"
    described by "State for an active network incident."
  }

  record ClosedIncidentData is {
    incidentId is IncidentId with { briefly "Incident" described by "Incident ID." }
    incidentInfo is IncidentInfo with { briefly "Info" described by "Incident details." }
    resolutionInfo is ResolutionInfo with { briefly "Resolution" described by "Resolution details." }
    totalDuration is Duration with { briefly "Duration" described by "Total incident duration." }
    closedAt is TimeStamp with { briefly "Closed" described by "Closure time." }
  } with {
    briefly "Closed incident state"
    described by "State for a closed incident."
  }

  state ActiveIncidentState of NetworkIncident.ActiveIncidentData with {
    briefly "Incident active"
    described by "Network incident is being managed."
  }

  state ClosedIncidentState of NetworkIncident.ClosedIncidentData with {
    briefly "Incident closed"
    described by "Network incident has been closed."
  }

  handler NetworkIncidentHandler is {
    on command CreateIncident {
      morph entity OperationsContext.NetworkIncident to state OperationsContext.NetworkIncident.ActiveIncidentState with command CreateIncident
      tell event IncidentCreated to entity OperationsContext.NetworkIncident
    }
    on command AcknowledgeIncident {
      tell event IncidentAcknowledged to entity OperationsContext.NetworkIncident
    }
    on command StartInvestigation {
      tell event InvestigationStarted to entity OperationsContext.NetworkIncident
    }
    on command EscalateIncident {
      tell event IncidentEscalated to entity OperationsContext.NetworkIncident
    }
    on command BeginMitigation {
      tell event MitigationStarted to entity OperationsContext.NetworkIncident
    }
    on command ResolveIncident {
      tell event IncidentResolved to entity OperationsContext.NetworkIncident
    }
    on command CloseIncident {
      morph entity OperationsContext.NetworkIncident to state OperationsContext.NetworkIncident.ClosedIncidentState with command CloseIncident
      tell event IncidentClosed to entity OperationsContext.NetworkIncident
    }
    on command AddTimelineEntry {
      tell event TimelineEntryAdded to entity OperationsContext.NetworkIncident
    }
  } with {
    briefly "Processes incident commands"
    described by "Handles network incident lifecycle."
  }

} with {
  briefly "NetworkIncident aggregate"
  described by "Manages network incident lifecycle."
}
