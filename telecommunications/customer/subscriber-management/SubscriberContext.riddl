// Subscriber Management - Subscriber Context

context SubscriberContext is {

  include "types.riddl"
  include "Subscriber.riddl"

  repository SubscriberRepository is {
    schema SubscriberData is relational
      of subscribers as Subscriber
      index on field Subscriber.subscriberId
      index on field Subscriber.accountId
      index on field Subscriber.status
      index on field Subscriber.contactInfo.email

    handler SubscriberPersistence is {
      on event Subscriber.SubscriberCreated {
        prompt "Store new subscriber record"
      }
      on event Subscriber.ServiceLineAdded {
        prompt "Store service line"
      }
      on event Subscriber.ServiceActivated {
        prompt "Update line to active"
      }
      on event Subscriber.PlanChanged {
        prompt "Update service plan"
      }
      on event Subscriber.ServiceSuspended {
        prompt "Update subscriber to suspended"
      }
      on event Subscriber.AccountCancelled {
        prompt "Update subscriber to cancelled"
      }
    } with {
      briefly "Persists subscriber events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Subscriber data persistence"
    described by "Persistent storage for subscribers."
  }

  projector SubscriberAnalytics is {
    updates repository SubscriberRepository

    record SubscriberMetrics is {
      totalSubscribers is Natural with { briefly "Total" described by "Total subscribers." }
      activeSubscribers is Natural with { briefly "Active" described by "Active subscribers." }
      newSubscribersThisMonth is Natural with { briefly "New" described by "New this month." }
      churnedThisMonth is Natural with { briefly "Churned" described by "Churned this month." }
      averageRevenuePerUser is Decimal(8, 2) with { briefly "ARPU" described by "Average revenue per user." }
    } with {
      briefly "Subscriber metrics"
      described by "Subscriber analytics."
    }

    handler AnalyticsHandler is {
      on event Subscriber.SubscriberCreated {
        prompt "Increment total and new subscriber counts"
      }
      on event Subscriber.AccountCancelled {
        prompt "Decrement active and increment churned"
      }
      on event Subscriber.PlanChanged {
        prompt "Recalculate ARPU"
      }
    } with {
      briefly "Maintains subscriber analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Subscriber analytics"
    described by "Subscriber metrics and KPIs."
  }

} with {
  briefly "Bounded context for subscriber management"
  described by "Telecom subscriber account context."
}
