// Subscriber Management - Subscriber Entity

entity Subscriber is {

  command CreateSubscriber is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "New subscriber identifier."
    }
    accountId is AccountId with {
      briefly "Account"
      described by "Billing account ID."
    }
    accountType is AccountType with {
      briefly "Type"
      described by "Account type."
    }
    contactInfo is ContactInfo with {
      briefly "Contact"
      described by "Contact information."
    }
    paymentMethod is PaymentMethod with {
      briefly "Payment"
      described by "Payment method."
    }
  } with {
    briefly "Create subscriber"
    described by "Creates a new subscriber."
  }

  command AddServiceLine is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    serviceLine is ServiceLine with {
      briefly "Service line"
      described by "New service line."
    }
  } with {
    briefly "Add service line"
    described by "Adds a service line."
  }

  command ActivateService is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    lineId is ServiceLineId with {
      briefly "Line"
      described by "Service line ID."
    }
    activatedAt is TimeStamp with {
      briefly "Activated"
      described by "Activation time."
    }
  } with {
    briefly "Activate service"
    described by "Activates a service line."
  }

  command ChangePlan is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    lineId is ServiceLineId with {
      briefly "Line"
      described by "Service line ID."
    }
    newPlan is ServicePlan with {
      briefly "New plan"
      described by "New service plan."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Effective date."
    }
  } with {
    briefly "Change plan"
    described by "Changes service plan."
  }

  command AssignDevice is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    lineId is ServiceLineId with {
      briefly "Line"
      described by "Service line ID."
    }
    device is DeviceInfo with {
      briefly "Device"
      described by "Device information."
    }
  } with {
    briefly "Assign device"
    described by "Assigns device to line."
  }

  command UpdateContact is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    contactInfo is ContactInfo with {
      briefly "Contact"
      described by "Updated contact info."
    }
  } with {
    briefly "Update contact"
    described by "Updates contact information."
  }

  command SuspendService is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Suspension reason."
    }
    suspendedAt is TimeStamp with {
      briefly "Suspended"
      described by "Suspension time."
    }
  } with {
    briefly "Suspend service"
    described by "Suspends subscriber services."
  }

  command ResumeService is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    resumedAt is TimeStamp with {
      briefly "Resumed"
      described by "Resume time."
    }
  } with {
    briefly "Resume service"
    described by "Resumes suspended services."
  }

  command DisconnectService is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    lineId is ServiceLineId with {
      briefly "Line"
      described by "Service line ID."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Disconnect reason."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Effective date."
    }
  } with {
    briefly "Disconnect service"
    described by "Disconnects a service line."
  }

  command CancelAccount is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
    effectiveDate is Date with {
      briefly "Effective"
      described by "Effective date."
    }
  } with {
    briefly "Cancel account"
    described by "Cancels subscriber account."
  }

  command CreateSupportTicket is {
    subscriberId is SubscriberId with {
      briefly "Subscriber ID"
      described by "Subscriber identifier."
    }
    ticket is SupportTicket with {
      briefly "Ticket"
      described by "Support ticket."
    }
  } with {
    briefly "Create support ticket"
    described by "Creates a support ticket."
  }

  // Events
  event SubscriberCreated is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    accountType is AccountType with { briefly "Type" described by "Account type." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Subscriber created"
    described by "Emitted when subscriber is created."
  }

  event ServiceLineAdded is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    serviceLine is ServiceLine with { briefly "Line" described by "Service line." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Service line added"
    described by "Emitted when line is added."
  }

  event ServiceActivated is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    lineId is ServiceLineId with { briefly "Line" described by "Line ID." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Service activated"
    described by "Emitted when service activates."
  }

  event PlanChanged is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    lineId is ServiceLineId with { briefly "Line" described by "Line ID." }
    newPlan is ServicePlan with { briefly "Plan" described by "New plan." }
    effectiveDate is Date with { briefly "Effective" described by "Effective date." }
  } with {
    briefly "Plan changed"
    described by "Emitted when plan changes."
  }

  event DeviceAssigned is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    lineId is ServiceLineId with { briefly "Line" described by "Line ID." }
    device is DeviceInfo with { briefly "Device" described by "Device info." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Device assigned"
    described by "Emitted when device is assigned."
  }

  event ContactUpdated is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    contactInfo is ContactInfo with { briefly "Contact" described by "Contact info." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Contact updated"
    described by "Emitted when contact is updated."
  }

  event ServiceSuspended is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Suspension reason." }
    suspendedAt is TimeStamp with { briefly "Suspended" described by "Suspension time." }
  } with {
    briefly "Service suspended"
    described by "Emitted when suspended."
  }

  event ServiceResumed is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Service resumed"
    described by "Emitted when resumed."
  }

  event ServiceDisconnected is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    lineId is ServiceLineId with { briefly "Line" described by "Line ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Disconnect reason." }
    disconnectedAt is TimeStamp with { briefly "Disconnected" described by "Disconnect time." }
  } with {
    briefly "Service disconnected"
    described by "Emitted when line disconnected."
  }

  event AccountCancelled is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Account cancelled"
    described by "Emitted when account cancelled."
  }

  event SupportTicketCreated is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    ticket is SupportTicket with { briefly "Ticket" described by "Support ticket." }
  } with {
    briefly "Support ticket created"
    described by "Emitted when ticket created."
  }

  // States
  record ActiveStateData is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    accountType is AccountType with { briefly "Type" described by "Account type." }
    status is SubscriberStatus with { briefly "Status" described by "Subscriber status." }
    contactInfo is ContactInfo with { briefly "Contact" described by "Contact info." }
    paymentMethod is PaymentMethod with { briefly "Payment" described by "Payment method." }
    serviceLines is many optional ServiceLine with { briefly "Lines" described by "Service lines." }
    devices is many optional DeviceInfo with { briefly "Devices" described by "Devices." }
    tickets is many optional SupportTicket with { briefly "Tickets" described by "Support tickets." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active subscriber state"
    described by "State for active subscriber."
  }

  record CancelledStateData is {
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber ID." }
    accountId is AccountId with { briefly "Account" described by "Account ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Cancelled subscriber state"
    described by "State for cancelled subscriber."
  }

  state ActiveState of Subscriber.ActiveStateData with {
    briefly "Subscriber active"
    described by "Subscriber has active account."
  }

  state CancelledState of Subscriber.CancelledStateData with {
    briefly "Subscriber cancelled"
    described by "Subscriber account is cancelled."
  }

  handler SubscriberHandler is {
    on command CreateSubscriber {
      morph entity SubscriberContext.Subscriber to state SubscriberContext.Subscriber.ActiveState with command CreateSubscriber
      tell event SubscriberCreated to entity SubscriberContext.Subscriber
    }
    on command AddServiceLine {
      tell event ServiceLineAdded to entity SubscriberContext.Subscriber
    }
    on command ActivateService {
      tell event ServiceActivated to entity SubscriberContext.Subscriber
    }
    on command ChangePlan {
      tell event PlanChanged to entity SubscriberContext.Subscriber
    }
    on command AssignDevice {
      tell event DeviceAssigned to entity SubscriberContext.Subscriber
    }
    on command UpdateContact {
      tell event ContactUpdated to entity SubscriberContext.Subscriber
    }
    on command SuspendService {
      tell event ServiceSuspended to entity SubscriberContext.Subscriber
    }
    on command ResumeService {
      tell event ServiceResumed to entity SubscriberContext.Subscriber
    }
    on command DisconnectService {
      tell event ServiceDisconnected to entity SubscriberContext.Subscriber
    }
    on command CancelAccount {
      morph entity SubscriberContext.Subscriber to state SubscriberContext.Subscriber.CancelledState with command CancelAccount
      tell event AccountCancelled to entity SubscriberContext.Subscriber
    }
    on command CreateSupportTicket {
      tell event SupportTicketCreated to entity SubscriberContext.Subscriber
    }
  } with {
    briefly "Processes subscriber commands"
    described by "Handles subscriber lifecycle."
  }

} with {
  briefly "Subscriber aggregate"
  described by "Manages telecom subscribers."
}
