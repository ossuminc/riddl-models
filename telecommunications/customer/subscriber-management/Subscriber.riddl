// Subscriber Management - Subscriber Entity
entity Subscriber is {
  command CreateSubscriber is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |New subscriber identifier.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Billing account ID.
      }
    }
    accountType: AccountType with {
      briefly "Type"
      described as {
        |Account type.
      }
    }
    contactInfo: ContactInfo with {
      briefly "Contact"
      described as {
        |Contact information.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Payment"
      described as {
        |Payment method.
      }
    }
  } with {
    briefly "Create subscriber"
    described as {
      |Creates a new subscriber.
    }
  }
  command AddServiceLine is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    serviceLine: ServiceLine with {
      briefly "Service line"
      described as {
        |New service line.
      }
    }
  } with {
    briefly "Add service line"
    described as {
      |Adds a service line.
    }
  }
  command ActivateService is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Service line ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Activate service"
    described as {
      |Activates a service line.
    }
  }
  command ChangePlan is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Service line ID.
      }
    }
    newPlan: ServicePlan with {
      briefly "New plan"
      described as {
        |New service plan.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Change plan"
    described as {
      |Changes service plan.
    }
  }
  command AssignDevice is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Service line ID.
      }
    }
    device: DeviceInfo with {
      briefly "Device"
      described as {
        |Device information.
      }
    }
  } with {
    briefly "Assign device"
    described as {
      |Assigns device to line.
    }
  }
  command UpdateContact is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    contactInfo: ContactInfo with {
      briefly "Contact"
      described as {
        |Updated contact info.
      }
    }
  } with {
    briefly "Update contact"
    described as {
      |Updates contact information.
    }
  }
  command SuspendService is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Suspend service"
    described as {
      |Suspends subscriber services.
    }
  }
  command ResumeService is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Resume service"
    described as {
      |Resumes suspended services.
    }
  }
  command DisconnectService is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Service line ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Disconnect reason.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Disconnect service"
    described as {
      |Disconnects a service line.
    }
  }
  command CancelAccount is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Cancel account"
    described as {
      |Cancels subscriber account.
    }
  }
  command CreateSupportTicket is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber ID"
      described as {
        |Subscriber identifier.
      }
    }
    ticket: SupportTicket with {
      briefly "Ticket"
      described as {
        |Support ticket.
      }
    }
  } with {
    briefly "Create support ticket"
    described as {
      |Creates a support ticket.
    }
  }
  // Events
  event SubscriberCreated is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    accountType: AccountType with {
      briefly "Type"
      described as {
        |Account type.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Subscriber created"
    described as {
      |Emitted when subscriber is created.
    }
  }
  event ServiceLineAdded is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    serviceLine: ServiceLine with {
      briefly "Line"
      described as {
        |Service line.
      }
    }
    addedAt: TimeStamp with {
      briefly "Added"
      described as {
        |Add time.
      }
    }
  } with {
    briefly "Service line added"
    described as {
      |Emitted when line is added.
    }
  }
  event ServiceActivated is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Line ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Service activated"
    described as {
      |Emitted when service activates.
    }
  }
  event PlanChanged is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Line ID.
      }
    }
    newPlan: ServicePlan with {
      briefly "Plan"
      described as {
        |New plan.
      }
    }
    effectiveDate: Date with {
      briefly "Effective"
      described as {
        |Effective date.
      }
    }
  } with {
    briefly "Plan changed"
    described as {
      |Emitted when plan changes.
    }
  }
  event DeviceAssigned is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Line ID.
      }
    }
    device: DeviceInfo with {
      briefly "Device"
      described as {
        |Device info.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Device assigned"
    described as {
      |Emitted when device is assigned.
    }
  }
  event ContactUpdated is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    contactInfo: ContactInfo with {
      briefly "Contact"
      described as {
        |Contact info.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Contact updated"
    described as {
      |Emitted when contact is updated.
    }
  }
  event ServiceSuspended is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Suspension reason.
      }
    }
    suspendedAt: TimeStamp with {
      briefly "Suspended"
      described as {
        |Suspension time.
      }
    }
  } with {
    briefly "Service suspended"
    described as {
      |Emitted when suspended.
    }
  }
  event ServiceResumed is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Service resumed"
    described as {
      |Emitted when resumed.
    }
  }
  event ServiceDisconnected is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    lineId: ServiceLineId with {
      briefly "Line"
      described as {
        |Line ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Disconnect reason.
      }
    }
    disconnectedAt: TimeStamp with {
      briefly "Disconnected"
      described as {
        |Disconnect time.
      }
    }
  } with {
    briefly "Service disconnected"
    described as {
      |Emitted when line disconnected.
    }
  }
  event AccountCancelled is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Account cancelled"
    described as {
      |Emitted when account cancelled.
    }
  }
  event SupportTicketCreated is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    ticket: SupportTicket with {
      briefly "Ticket"
      described as {
        |Support ticket.
      }
    }
  } with {
    briefly "Support ticket created"
    described as {
      |Emitted when ticket created.
    }
  }
  // States
  record ActiveStateData is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    accountType: AccountType with {
      briefly "Type"
      described as {
        |Account type.
      }
    }
    status: SubscriberStatus with {
      briefly "Status"
      described as {
        |Subscriber status.
      }
    }
    contactInfo: ContactInfo with {
      briefly "Contact"
      described as {
        |Contact info.
      }
    }
    paymentMethod: PaymentMethod with {
      briefly "Payment"
      described as {
        |Payment method.
      }
    }
    serviceLines: ServiceLine* with {
      briefly "Lines"
      described as {
        |Service lines.
      }
    }
    devices: DeviceInfo* with {
      briefly "Devices"
      described as {
        |Devices.
      }
    }
    tickets: SupportTicket* with {
      briefly "Tickets"
      described as {
        |Support tickets.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active subscriber state"
    described as {
      |State for active subscriber.
    }
  }
  record CancelledStateData is  {
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    accountId: AccountId with {
      briefly "Account"
      described as {
        |Account ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Cancelled subscriber state"
    described as {
      |State for cancelled subscriber.
    }
  }
  state ActiveState of type Subscriber.ActiveStateData
  state CancelledState of type Subscriber.CancelledStateData
  handler SubscriberHandler is {
    on command CreateSubscriber is {
      morph entity SubscriberContext.Subscriber to state SubscriberContext.Subscriber.ActiveState with command CreateSubscriber
      tell event SubscriberCreated to entity SubscriberContext.Subscriber
    }
    on command AddServiceLine is {
      tell event ServiceLineAdded to entity SubscriberContext.Subscriber
    }
    on command ActivateService is {
      tell event ServiceActivated to entity SubscriberContext.Subscriber
    }
    on command ChangePlan is {
      tell event PlanChanged to entity SubscriberContext.Subscriber
    }
    on command AssignDevice is {
      tell event DeviceAssigned to entity SubscriberContext.Subscriber
    }
    on command UpdateContact is {
      tell event ContactUpdated to entity SubscriberContext.Subscriber
    }
    on command SuspendService is {
      tell event ServiceSuspended to entity SubscriberContext.Subscriber
    }
    on command ResumeService is {
      tell event ServiceResumed to entity SubscriberContext.Subscriber
    }
    on command DisconnectService is {
      tell event ServiceDisconnected to entity SubscriberContext.Subscriber
    }
    on command CancelAccount is {
      morph entity SubscriberContext.Subscriber to state SubscriberContext.Subscriber.CancelledState with command CancelAccount
      tell event AccountCancelled to entity SubscriberContext.Subscriber
    }
    on command CreateSupportTicket is {
      tell event SupportTicketCreated to entity SubscriberContext.Subscriber
    }
  } with {
    briefly "Processes subscriber commands"
    described as {
      |Handles subscriber lifecycle.
    }
  }
} with {
  briefly "Subscriber aggregate"
  described as {
    |Manages telecom subscribers.
  }
}
