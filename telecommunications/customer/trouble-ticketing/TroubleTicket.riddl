// Trouble Ticketing - Trouble Ticket Entity
entity TroubleTicket is {
  command CreateTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |New ticket identifier.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer information.
      }
    }
    issue: IssueDescription with {
      briefly "Issue"
      described as {
        |Issue description.
      }
    }
    priority: TicketPriority with {
      briefly "Priority"
      described as {
        |Issue priority.
      }
    }
  } with {
    briefly "Create ticket"
    described as {
      |Creates trouble ticket.
    }
  }
  command AssignTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    assignedTo: String(1,100) with {
      briefly "Assigned to"
      described as {
        |Assignee name.
      }
    }
    assignedGroup: String(1,100)? with {
      briefly "Group"
      described as {
        |Support group.
      }
    }
  } with {
    briefly "Assign ticket"
    described as {
      |Assigns ticket to agent.
    }
  }
  command AddDiagnostic is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    diagnostic: DiagnosticResult with {
      briefly "Diagnostic"
      described as {
        |Diagnostic result.
      }
    }
  } with {
    briefly "Add diagnostic"
    described as {
      |Records diagnostic test.
    }
  }
  command AddWorkNote is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    note: WorkNote with {
      briefly "Note"
      described as {
        |Work note.
      }
    }
  } with {
    briefly "Add work note"
    described as {
      |Adds work note.
    }
  }
  command DispatchTechnician is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    dispatch: DispatchInfo with {
      briefly "Dispatch"
      described as {
        |Dispatch information.
      }
    }
  } with {
    briefly "Dispatch technician"
    described as {
      |Schedules field visit.
    }
  }
  command UpdateDispatchStatus is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    dispatchId: UUID with {
      briefly "Dispatch"
      described as {
        |Dispatch ID.
      }
    }
    newStatus: String(1,20) with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    notes: String(1,1000)? with {
      briefly "Notes"
      described as {
        |Status notes.
      }
    }
  } with {
    briefly "Update dispatch status"
    described as {
      |Updates field visit status.
    }
  }
  command EscalateTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    escalation: EscalationInfo with {
      briefly "Escalation"
      described as {
        |Escalation details.
      }
    }
  } with {
    briefly "Escalate ticket"
    described as {
      |Escalates to higher tier.
    }
  }
  command UpdatePriority is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    newPriority: TicketPriority with {
      briefly "Priority"
      described as {
        |New priority.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Change reason.
      }
    }
  } with {
    briefly "Update priority"
    described as {
      |Changes ticket priority.
    }
  }
  command PendTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Pending reason.
      }
    }
    expectedResume: TimeStamp? with {
      briefly "Resume"
      described as {
        |Expected resume time.
      }
    }
  } with {
    briefly "Pend ticket"
    described as {
      |Puts ticket on hold.
    }
  }
  command ResolveTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    resolution: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution details.
      }
    }
  } with {
    briefly "Resolve ticket"
    described as {
      |Marks ticket resolved.
    }
  }
  command CloseTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Who closed.
      }
    }
    customerSatisfaction: Natural? with {
      briefly "CSAT"
      described as {
        |Customer satisfaction 1-5.
      }
    }
  } with {
    briefly "Close ticket"
    described as {
      |Closes ticket.
    }
  }
  command ReopenTicket is  {
    ticketId: TicketId with {
      briefly "Ticket ID"
      described as {
        |Ticket identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
  } with {
    briefly "Reopen ticket"
    described as {
      |Reopens closed ticket.
    }
  }
  // Events
  event TicketCreated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    issue: IssueDescription with {
      briefly "Issue"
      described as {
        |Issue details.
      }
    }
    priority: TicketPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Ticket created"
    described as {
      |Emitted when ticket created.
    }
  }
  event TicketAssigned is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    assignedTo: String(1,100) with {
      briefly "Assigned to"
      described as {
        |Assignee.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Ticket assigned"
    described as {
      |Emitted when assigned.
    }
  }
  event DiagnosticAdded is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    diagnostic: DiagnosticResult with {
      briefly "Diagnostic"
      described as {
        |Result.
      }
    }
  } with {
    briefly "Diagnostic added"
    described as {
      |Emitted when diagnostic recorded.
    }
  }
  event WorkNoteAdded is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    note: WorkNote with {
      briefly "Note"
      described as {
        |Work note.
      }
    }
  } with {
    briefly "Work note added"
    described as {
      |Emitted when note added.
    }
  }
  event TechnicianDispatched is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    dispatch: DispatchInfo with {
      briefly "Dispatch"
      described as {
        |Dispatch info.
      }
    }
  } with {
    briefly "Technician dispatched"
    described as {
      |Emitted when dispatch scheduled.
    }
  }
  event DispatchStatusUpdated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    dispatchId: UUID with {
      briefly "Dispatch"
      described as {
        |Dispatch ID.
      }
    }
    newStatus: String(1,20) with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Dispatch status updated"
    described as {
      |Emitted when dispatch updated.
    }
  }
  event TicketEscalated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    escalation: EscalationInfo with {
      briefly "Escalation"
      described as {
        |Escalation.
      }
    }
  } with {
    briefly "Ticket escalated"
    described as {
      |Emitted when escalated.
    }
  }
  event PriorityUpdated is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    newPriority: TicketPriority with {
      briefly "Priority"
      described as {
        |New priority.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Priority updated"
    described as {
      |Emitted when priority changed.
    }
  }
  event TicketPended is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Pending reason.
      }
    }
    pendedAt: TimeStamp with {
      briefly "Pended"
      described as {
        |Pend time.
      }
    }
  } with {
    briefly "Ticket pended"
    described as {
      |Emitted when put on hold.
    }
  }
  event TicketResolved is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    resolution: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
  } with {
    briefly "Ticket resolved"
    described as {
      |Emitted when resolved.
    }
  }
  event TicketClosed is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    closedBy: String(1,100) with {
      briefly "Closed by"
      described as {
        |Closer.
      }
    }
    customerSatisfaction: Natural? with {
      briefly "CSAT"
      described as {
        |Satisfaction.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Ticket closed"
    described as {
      |Emitted when closed.
    }
  }
  event TicketReopened is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reopen reason.
      }
    }
    reopenedAt: TimeStamp with {
      briefly "Reopened"
      described as {
        |Reopen time.
      }
    }
  } with {
    briefly "Ticket reopened"
    described as {
      |Emitted when reopened.
    }
  }
  // States
  record ActiveStateData is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    issue: IssueDescription with {
      briefly "Issue"
      described as {
        |Issue details.
      }
    }
    status: TicketStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    priority: TicketPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    updatedAssignedTo: String(1,100)? with {
      briefly "Assigned"
      described as {
        |Assignee.
      }
    }
    assignedGroup: String(1,100)? with {
      briefly "Group"
      described as {
        |Support group.
      }
    }
    diagnostics: DiagnosticResult* with {
      briefly "Diagnostics"
      described as {
        |Test results.
      }
    }
    workNotes: WorkNote* with {
      briefly "Notes"
      described as {
        |Work notes.
      }
    }
    updatedDispatch: DispatchInfo? with {
      briefly "Dispatch"
      described as {
        |Dispatch info.
      }
    }
    updatedEscalation: EscalationInfo? with {
      briefly "Escalation"
      described as {
        |Escalation.
      }
    }
    sla: SLAMetrics with {
      briefly "SLA"
      described as {
        |SLA metrics.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active ticket state"
    described as {
      |Open ticket data.
    }
  }
  record ClosedStateData is  {
    ticketId: TicketId with {
      briefly "Ticket"
      described as {
        |Ticket ID.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    resolution: ResolutionInfo with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
    sla: SLAMetrics with {
      briefly "SLA"
      described as {
        |Final SLA metrics.
      }
    }
    customerSatisfaction: Natural? with {
      briefly "CSAT"
      described as {
        |Satisfaction.
      }
    }
    closedAt: TimeStamp with {
      briefly "Closed"
      described as {
        |Close time.
      }
    }
  } with {
    briefly "Closed ticket state"
    described as {
      |Closed ticket data.
    }
  }
  state ActiveState of type TroubleTicket.ActiveStateData
  state ClosedState of type TroubleTicket.ClosedStateData
  handler TroubleTicketHandler is {
    on command CreateTicket is {
      morph entity TicketContext.TroubleTicket to state TicketContext.TroubleTicket.ActiveState with command CreateTicket
      tell event TicketCreated to entity TicketContext.TroubleTicket
    }
    on command AssignTicket is {
      tell event TicketAssigned to entity TicketContext.TroubleTicket
    }
    on command AddDiagnostic is {
      tell event DiagnosticAdded to entity TicketContext.TroubleTicket
    }
    on command AddWorkNote is {
      tell event WorkNoteAdded to entity TicketContext.TroubleTicket
    }
    on command DispatchTechnician is {
      tell event TechnicianDispatched to entity TicketContext.TroubleTicket
    }
    on command UpdateDispatchStatus is {
      tell event DispatchStatusUpdated to entity TicketContext.TroubleTicket
    }
    on command EscalateTicket is {
      tell event TicketEscalated to entity TicketContext.TroubleTicket
    }
    on command UpdatePriority is {
      tell event PriorityUpdated to entity TicketContext.TroubleTicket
    }
    on command PendTicket is {
      tell event TicketPended to entity TicketContext.TroubleTicket
    }
    on command ResolveTicket is {
      tell event TicketResolved to entity TicketContext.TroubleTicket
    }
    on command CloseTicket is {
      morph entity TicketContext.TroubleTicket to state TicketContext.TroubleTicket.ClosedState with command CloseTicket
      tell event TicketClosed to entity TicketContext.TroubleTicket
    }
    on command ReopenTicket is {
      tell event TicketReopened to entity TicketContext.TroubleTicket
    }
  } with {
    briefly "Processes ticket commands"
    described as {
      |Handles ticket lifecycle.
    }
  }
} with {
  briefly "Trouble ticket aggregate"
  described as {
    |Manages service trouble tickets.
  }
}
