// Trouble Ticketing - Ticket Context
context TicketContext is {
  include "types.riddl"
  include "TroubleTicket.riddl"
  repository TicketRepository is {
    schema TicketData is relational
      of tickets as type TroubleTicket
        index on field TroubleTicket.customer.accountNumber
        index on field TroubleTicket.status
        index on field TroubleTicket.priority
        index on field TroubleTicket.assignedTo

    handler TicketPersistence is {
      on command TroubleTicket.CreateTicket is {
        prompt "Store new ticket record"
      }
      on command TroubleTicket.AssignTicket is {
        prompt "Update ticket assignment"
      }
      on command TroubleTicket.AddDiagnostic is {
        prompt "Store diagnostic result"
      }
      on command TroubleTicket.AddWorkNote is {
        prompt "Store work note"
      }
      on command TroubleTicket.DispatchTechnician is {
        prompt "Store dispatch info"
      }
      on command TroubleTicket.EscalateTicket is {
        prompt "Update escalation status"
      }
      on command TroubleTicket.ResolveTicket is {
        prompt "Store resolution"
      }
      on command TroubleTicket.CloseTicket is {
        prompt "Archive ticket"
      }
    } with {
      briefly "Persists ticket commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Ticket data persistence"
    described as {
      |Persistent storage for tickets.
    }
  }
  projector TicketAnalytics is {
    record SupportMetrics is  {
      openTickets: Natural with {
        briefly "Open"
        described as {
          |Open tickets.
        }
      }
      resolvedToday: Natural with {
        briefly "Resolved"
        described as {
          |Resolved today.
        }
      }
      avgResolutionTime: Decimal(8,2) with {
        briefly "Avg time"
        described as {
          |Avg resolution hours.
        }
      }
      slaCompliance: Decimal(5,2) with {
        briefly "SLA"
        described as {
          |SLA compliance %.
        }
      }
      escalationRate: Decimal(5,2) with {
        briefly "Escalations"
        described as {
          |Escalation rate.
        }
      }
      avgCSAT: Decimal(3,2) with {
        briefly "CSAT"
        described as {
          |Avg satisfaction.
        }
      }
    } with {
      briefly "Support metrics"
      described as {
        |Customer support metrics.
      }
    }
    handler AnalyticsHandler is {
      on event TroubleTicket.TicketCreated is {
        prompt "Increment open count"
      }
      on event TroubleTicket.TicketResolved is {
        prompt "Track resolution time"
      }
      on event TroubleTicket.TicketEscalated is {
        prompt "Track escalation"
      }
      on event TroubleTicket.TicketClosed is {
        prompt "Update satisfaction metrics"
      }
    } with {
      briefly "Maintains support analytics"
      described as {
        |Projects events into metrics.
      }
    }
  } with {
    briefly "Ticket analytics"
    described as {
      |Support performance tracking.
    }
  }
} with {
  briefly "Bounded context for trouble ticketing"
  described as {
    |Customer support context.
  }
}
