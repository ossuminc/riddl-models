// Returns Processing - Returns Context

context ReturnsContext is {

  include "types.riddl"
  include "Return.riddl"

  repository ReturnsRepository is {
    schema ReturnsData is relational
      of returns as Return
      index on field Return.returnId
      index on field Return.orderId
      index on field Return.status
      index on field Return.rmaNumber

    handler ReturnsPersistence is {
      on event Return.ReturnRequested {
        prompt "Store new return record"
      }
      on event Return.ReturnAuthorized {
        prompt "Update return with RMA"
      }
      on event Return.ReturnReceived {
        prompt "Update return to received"
      }
      on event Return.ItemInspected {
        prompt "Store inspection result"
      }
      on event Return.RefundProcessed {
        prompt "Update return to completed"
      }
    } with {
      briefly "Persists return events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Returns data persistence"
    described by "Persistent storage for returns."
  }

  projector ReturnsAnalytics is {
    updates repository ReturnsRepository

    record ReturnsMetrics is {
      period is String(1, 20) with { briefly "Period" described by "Time period." }
      totalReturns is Natural with { briefly "Total" described by "Total returns." }
      totalRefunded is Decimal(15, 2) with { briefly "Refunded" described by "Total refunded." }
      approvalRate is Decimal(5, 2) with { briefly "Approval" described by "Approval rate pct." }
      avgProcessingDays is Decimal(5, 2) with { briefly "Avg days" described by "Avg processing days." }
      topReason is ReturnReason with { briefly "Top reason" described by "Most common reason." }
    } with {
      briefly "Returns metrics"
      described by "Return processing metrics."
    }

    handler AnalyticsHandler is {
      on event Return.ReturnRequested {
        prompt "Increment return count"
      }
      on event Return.RefundProcessed {
        prompt "Calculate processing time and totals"
      }
      on event Return.ReturnRejected {
        prompt "Update approval rate"
      }
    } with {
      briefly "Maintains returns analytics"
      described by "Projects events into analytics."
    }
  } with {
    briefly "Returns analytics"
    described by "Returns processing analysis."
  }

} with {
  briefly "Bounded context for returns processing"
  described by "Product returns management context."
}
