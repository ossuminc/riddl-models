// Returns Processing - Returns Context
context ReturnsContext is {
  include "types.riddl"
  include "Return.riddl"
  repository ReturnsRepository is {
    schema ReturnsData is relational
      of returns as type Return
        index on field Return.returnId
        index on field Return.orderId
        index on field Return.status
        index on field Return.rmaNumber

    handler ReturnsPersistence is {
      on command Return.RequestReturn is {
        prompt "Store new return record"
      }
      on command Return.AuthorizeReturn is {
        prompt "Update return with RMA"
      }
      on command Return.ReceiveReturn is {
        prompt "Update return to received"
      }
      on command Return.InspectItem is {
        prompt "Store inspection result"
      }
      on command Return.ProcessRefund is {
        prompt "Update return to completed"
      }
    } with {
      briefly "Persists return commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Returns data persistence"
    described as {
      |Persistent storage for returns.
    }
  }
  projector ReturnsAnalytics is {
    record ReturnsMetrics is  {
      period: String(1,20) with {
        briefly "Period"
        described as {
          |Time period.
        }
      }
      totalReturns: Natural with {
        briefly "Total"
        described as {
          |Total returns.
        }
      }
      totalRefunded: Decimal(15,2) with {
        briefly "Refunded"
        described as {
          |Total refunded.
        }
      }
      approvalRate: Decimal(5,2) with {
        briefly "Approval"
        described as {
          |Approval rate pct.
        }
      }
      avgProcessingDays: Decimal(5,2) with {
        briefly "Avg days"
        described as {
          |Avg processing days.
        }
      }
      topReason: ReturnReason with {
        briefly "Top reason"
        described as {
          |Most common reason.
        }
      }
    } with {
      briefly "Returns metrics"
      described as {
        |Return processing metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Return.ReturnRequested is {
        prompt "Increment return count"
      }
      on event Return.RefundProcessed is {
        prompt "Calculate processing time and totals"
      }
      on event Return.ReturnRejected is {
        prompt "Update approval rate"
      }
    } with {
      briefly "Maintains returns analytics"
      described as {
        |Projects events into analytics.
      }
    }
  } with {
    briefly "Returns analytics"
    described as {
      |Returns processing analysis.
    }
  }
} with {
  briefly "Bounded context for returns processing"
  described as {
    |Product returns management context.
  }
}
