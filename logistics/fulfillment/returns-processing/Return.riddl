// Returns Processing - Return Entity

entity Return is {

  command RequestReturn is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "New return identifier."
    }
    orderId is OrderId with {
      briefly "Order"
      described by "Original order ID."
    }
    customerId is UUID with {
      briefly "Customer"
      described by "Customer ID."
    }
    items is many ReturnItem with {
      briefly "Items"
      described by "Items to return."
    }
  } with {
    briefly "Request return"
    described by "Requests a return."
  }

  command AuthorizeReturn is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    rmaNumber is RMANumber with {
      briefly "RMA"
      described by "RMA number."
    }
    authorizedBy is String(1, 100) with {
      briefly "Authorized by"
      described by "Authorizer."
    }
  } with {
    briefly "Authorize return"
    described by "Authorizes the return."
  }

  command GenerateLabel is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    label is ReturnLabel with {
      briefly "Label"
      described by "Return label."
    }
  } with {
    briefly "Generate label"
    described by "Generates return shipping label."
  }

  command RecordShipment is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    tracking is ShipmentTracking with {
      briefly "Tracking"
      described by "Shipment tracking."
    }
  } with {
    briefly "Record shipment"
    described by "Records return shipment."
  }

  command ReceiveReturn is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    receivedAt is TimeStamp with {
      briefly "Received"
      described by "Receipt time."
    }
    receivedBy is String(1, 100) with {
      briefly "Received by"
      described by "Receiver."
    }
  } with {
    briefly "Receive return"
    described by "Records return receipt."
  }

  command InspectItem is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    sku is String(1, 50) with {
      briefly "SKU"
      described by "Item SKU."
    }
    inspection is InspectionResult with {
      briefly "Inspection"
      described by "Inspection result."
    }
  } with {
    briefly "Inspect item"
    described by "Records item inspection."
  }

  command ApproveReturn is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    refundInfo is RefundInfo with {
      briefly "Refund"
      described by "Refund details."
    }
    approvedBy is String(1, 100) with {
      briefly "Approved by"
      described by "Approver."
    }
  } with {
    briefly "Approve return"
    described by "Approves return for refund."
  }

  command RejectReturn is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    rejectionReason is String(1, 500) with {
      briefly "Reason"
      described by "Rejection reason."
    }
    rejectedBy is String(1, 100) with {
      briefly "Rejected by"
      described by "Rejecter."
    }
  } with {
    briefly "Reject return"
    described by "Rejects the return."
  }

  command ProcessRefund is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    transactionId is String(1, 100) with {
      briefly "Transaction"
      described by "Refund transaction ID."
    }
    processedAt is TimeStamp with {
      briefly "Processed"
      described by "Refund process time."
    }
  } with {
    briefly "Process refund"
    described by "Processes the refund."
  }

  command DisposeItem is {
    returnId is ReturnId with {
      briefly "Return ID"
      described by "Return identifier."
    }
    sku is String(1, 50) with {
      briefly "SKU"
      described by "Item SKU."
    }
    disposition is DispositionAction with {
      briefly "Disposition"
      described by "Disposition action."
    }
  } with {
    briefly "Dispose item"
    described by "Disposes of returned item."
  }

  // Events
  event ReturnRequested is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    itemCount is Natural with { briefly "Items" described by "Item count." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Return requested"
    described by "Emitted when return requested."
  }

  event ReturnAuthorized is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    rmaNumber is RMANumber with { briefly "RMA" described by "RMA number." }
    authorizedAt is TimeStamp with { briefly "Authorized" described by "Auth time." }
  } with {
    briefly "Return authorized"
    described by "Emitted when return authorized."
  }

  event LabelGenerated is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    label is ReturnLabel with { briefly "Label" described by "Return label." }
    generatedAt is TimeStamp with { briefly "Generated" described by "Generation time." }
  } with {
    briefly "Label generated"
    described by "Emitted when label generated."
  }

  event ShipmentRecorded is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    tracking is ShipmentTracking with { briefly "Tracking" described by "Tracking info." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Shipment recorded"
    described by "Emitted when shipment recorded."
  }

  event ReturnReceived is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Return received"
    described by "Emitted when return received."
  }

  event ItemInspected is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    sku is String(1, 50) with { briefly "SKU" described by "Item SKU." }
    inspection is InspectionResult with { briefly "Inspection" described by "Inspection." }
  } with {
    briefly "Item inspected"
    described by "Emitted when item inspected."
  }

  event ReturnApproved is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    refundInfo is RefundInfo with { briefly "Refund" described by "Refund info." }
    approvedAt is TimeStamp with { briefly "Approved" described by "Approval time." }
  } with {
    briefly "Return approved"
    described by "Emitted when return approved."
  }

  event ReturnRejected is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    rejectionReason is String(1, 500) with { briefly "Reason" described by "Rejection reason." }
    rejectedAt is TimeStamp with { briefly "Rejected" described by "Rejection time." }
  } with {
    briefly "Return rejected"
    described by "Emitted when return rejected."
  }

  event RefundProcessed is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    transactionId is String(1, 100) with { briefly "Transaction" described by "Transaction." }
    processedAt is TimeStamp with { briefly "Processed" described by "Process time." }
  } with {
    briefly "Refund processed"
    described by "Emitted when refund processed."
  }

  event ItemDisposed is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    sku is String(1, 50) with { briefly "SKU" described by "Item SKU." }
    disposition is DispositionAction with { briefly "Disposition" described by "Action." }
    disposedAt is TimeStamp with { briefly "Disposed" described by "Disposal time." }
  } with {
    briefly "Item disposed"
    described by "Emitted when item disposed."
  }

  // States
  record ActiveStateData is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    customerId is UUID with { briefly "Customer" described by "Customer ID." }
    status is ReturnStatus with { briefly "Status" described by "Return status." }
    items is many ReturnItem with { briefly "Items" described by "Return items." }
    assignedRmaNumber is optional RMANumber with { briefly "RMA" described by "RMA number." }
    returnTracking is optional ShipmentTracking with { briefly "Tracking" described by "Tracking." }
    inspections is many optional InspectionResult with { briefly "Inspections" described by "Inspections." }
    approvedRefundInfo is optional RefundInfo with { briefly "Refund" described by "Refund info." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Active return state"
    described by "State for active return."
  }

  record CompletedStateData is {
    returnId is ReturnId with { briefly "Return" described by "Return ID." }
    orderId is OrderId with { briefly "Order" described by "Order ID." }
    refundInfo is RefundInfo with { briefly "Refund" described by "Final refund." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed return state"
    described by "State for completed return."
  }

  state ActiveState of Return.ActiveStateData with {
    briefly "Return active"
    described by "Return is being processed."
  }

  state CompletedState of Return.CompletedStateData with {
    briefly "Return completed"
    described by "Return has been processed."
  }

  handler ReturnHandler is {
    on command RequestReturn {
      morph entity ReturnsContext.Return to state ReturnsContext.Return.ActiveState with command RequestReturn
      tell event ReturnRequested to entity ReturnsContext.Return
    }
    on command AuthorizeReturn {
      tell event ReturnAuthorized to entity ReturnsContext.Return
    }
    on command GenerateLabel {
      tell event LabelGenerated to entity ReturnsContext.Return
    }
    on command RecordShipment {
      tell event ShipmentRecorded to entity ReturnsContext.Return
    }
    on command ReceiveReturn {
      tell event ReturnReceived to entity ReturnsContext.Return
    }
    on command InspectItem {
      tell event ItemInspected to entity ReturnsContext.Return
    }
    on command ApproveReturn {
      tell event ReturnApproved to entity ReturnsContext.Return
    }
    on command RejectReturn {
      tell event ReturnRejected to entity ReturnsContext.Return
    }
    on command Return.ProcessRefund {
      morph entity ReturnsContext.Return to state ReturnsContext.Return.CompletedState with command Return.ProcessRefund
      tell event RefundProcessed to entity ReturnsContext.Return
    }
    on command DisposeItem {
      tell event ItemDisposed to entity ReturnsContext.Return
    }
  } with {
    briefly "Processes return commands"
    described by "Handles return lifecycle."
  }

} with {
  briefly "Return aggregate"
  described by "Manages product returns."
}
