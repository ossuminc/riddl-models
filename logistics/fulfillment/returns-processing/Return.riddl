// Returns Processing - Return Entity
entity Return is {
  command RequestReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |New return identifier.
      }
    }
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Original order ID.
      }
    }
    customerId: UUID with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    items: ReturnItem+ with {
      briefly "Items"
      described as {
        |Items to return.
      }
    }
  } with {
    briefly "Request return"
    described as {
      |Requests a return.
    }
  }
  command AuthorizeReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    rmaNumber: RMANumber with {
      briefly "RMA"
      described as {
        |RMA number.
      }
    }
    authorizedBy: String(1,100) with {
      briefly "Authorized by"
      described as {
        |Authorizer.
      }
    }
  } with {
    briefly "Authorize return"
    described as {
      |Authorizes the return.
    }
  }
  command GenerateLabel is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    label: ReturnLabel with {
      briefly "Label"
      described as {
        |Return label.
      }
    }
  } with {
    briefly "Generate label"
    described as {
      |Generates return shipping label.
    }
  }
  command RecordShipment is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    tracking: ShipmentTracking with {
      briefly "Tracking"
      described as {
        |Shipment tracking.
      }
    }
  } with {
    briefly "Record shipment"
    described as {
      |Records return shipment.
    }
  }
  command ReceiveReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
    receivedBy: String(1,100) with {
      briefly "Received by"
      described as {
        |Receiver.
      }
    }
  } with {
    briefly "Receive return"
    described as {
      |Records return receipt.
    }
  }
  command InspectItem is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Item SKU.
      }
    }
    inspection: InspectionResult with {
      briefly "Inspection"
      described as {
        |Inspection result.
      }
    }
  } with {
    briefly "Inspect item"
    described as {
      |Records item inspection.
    }
  }
  command ApproveReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Refund details.
      }
    }
    approvedBy: String(1,100) with {
      briefly "Approved by"
      described as {
        |Approver.
      }
    }
  } with {
    briefly "Approve return"
    described as {
      |Approves return for refund.
    }
  }
  command RejectReturn is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    rejectionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedBy: String(1,100) with {
      briefly "Rejected by"
      described as {
        |Rejecter.
      }
    }
  } with {
    briefly "Reject return"
    described as {
      |Rejects the return.
    }
  }
  command ProcessRefund is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Refund transaction ID.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Refund process time.
      }
    }
  } with {
    briefly "Process refund"
    described as {
      |Processes the refund.
    }
  }
  command DisposeItem is  {
    returnId: ReturnId with {
      briefly "Return ID"
      described as {
        |Return identifier.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Item SKU.
      }
    }
    disposition: DispositionAction with {
      briefly "Disposition"
      described as {
        |Disposition action.
      }
    }
  } with {
    briefly "Dispose item"
    described as {
      |Disposes of returned item.
    }
  }
  // Events
  event ReturnRequested is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    itemCount: Natural with {
      briefly "Items"
      described as {
        |Item count.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Return requested"
    described as {
      |Emitted when return requested.
    }
  }
  event ReturnAuthorized is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    rmaNumber: RMANumber with {
      briefly "RMA"
      described as {
        |RMA number.
      }
    }
    authorizedAt: TimeStamp with {
      briefly "Authorized"
      described as {
        |Auth time.
      }
    }
  } with {
    briefly "Return authorized"
    described as {
      |Emitted when return authorized.
    }
  }
  event LabelGenerated is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    label: ReturnLabel with {
      briefly "Label"
      described as {
        |Return label.
      }
    }
    generatedAt: TimeStamp with {
      briefly "Generated"
      described as {
        |Generation time.
      }
    }
  } with {
    briefly "Label generated"
    described as {
      |Emitted when label generated.
    }
  }
  event ShipmentRecorded is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    tracking: ShipmentTracking with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Shipment recorded"
    described as {
      |Emitted when shipment recorded.
    }
  }
  event ReturnReceived is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    receivedAt: TimeStamp with {
      briefly "Received"
      described as {
        |Receipt time.
      }
    }
  } with {
    briefly "Return received"
    described as {
      |Emitted when return received.
    }
  }
  event ItemInspected is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Item SKU.
      }
    }
    inspection: InspectionResult with {
      briefly "Inspection"
      described as {
        |Inspection.
      }
    }
  } with {
    briefly "Item inspected"
    described as {
      |Emitted when item inspected.
    }
  }
  event ReturnApproved is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Refund info.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Return approved"
    described as {
      |Emitted when return approved.
    }
  }
  event ReturnRejected is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    rejectionReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Rejection reason.
      }
    }
    rejectedAt: TimeStamp with {
      briefly "Rejected"
      described as {
        |Rejection time.
      }
    }
  } with {
    briefly "Return rejected"
    described as {
      |Emitted when return rejected.
    }
  }
  event RefundProcessed is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    transactionId: String(1,100) with {
      briefly "Transaction"
      described as {
        |Transaction.
      }
    }
    processedAt: TimeStamp with {
      briefly "Processed"
      described as {
        |Process time.
      }
    }
  } with {
    briefly "Refund processed"
    described as {
      |Emitted when refund processed.
    }
  }
  event ItemDisposed is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Item SKU.
      }
    }
    disposition: DispositionAction with {
      briefly "Disposition"
      described as {
        |Action.
      }
    }
    disposedAt: TimeStamp with {
      briefly "Disposed"
      described as {
        |Disposal time.
      }
    }
  } with {
    briefly "Item disposed"
    described as {
      |Emitted when item disposed.
    }
  }
  // States
  record ActiveStateData is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    customerId: UUID with {
      briefly "Customer"
      described as {
        |Customer ID.
      }
    }
    status: ReturnStatus with {
      briefly "Status"
      described as {
        |Return status.
      }
    }
    items: ReturnItem+ with {
      briefly "Items"
      described as {
        |Return items.
      }
    }
    assignedRmaNumber: RMANumber? with {
      briefly "RMA"
      described as {
        |RMA number.
      }
    }
    returnTracking: ShipmentTracking? with {
      briefly "Tracking"
      described as {
        |Tracking.
      }
    }
    inspections: InspectionResult* with {
      briefly "Inspections"
      described as {
        |Inspections.
      }
    }
    approvedRefundInfo: RefundInfo? with {
      briefly "Refund"
      described as {
        |Refund info.
      }
    }
    requestedAt: TimeStamp with {
      briefly "Requested"
      described as {
        |Request time.
      }
    }
  } with {
    briefly "Active return state"
    described as {
      |State for active return.
    }
  }
  record CompletedStateData is  {
    returnId: ReturnId with {
      briefly "Return"
      described as {
        |Return ID.
      }
    }
    orderId: OrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    refundInfo: RefundInfo with {
      briefly "Refund"
      described as {
        |Final refund.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed return state"
    described as {
      |State for completed return.
    }
  }
  state ActiveState of type Return.ActiveStateData
  state CompletedState of type Return.CompletedStateData
  handler ReturnHandler is {
    on command RequestReturn is {
      morph entity ReturnsContext.Return to state ReturnsContext.Return.ActiveState with command RequestReturn
      tell event ReturnRequested to entity ReturnsContext.Return
    }
    on command AuthorizeReturn is {
      tell event ReturnAuthorized to entity ReturnsContext.Return
    }
    on command GenerateLabel is {
      tell event LabelGenerated to entity ReturnsContext.Return
    }
    on command RecordShipment is {
      tell event ShipmentRecorded to entity ReturnsContext.Return
    }
    on command ReceiveReturn is {
      tell event ReturnReceived to entity ReturnsContext.Return
    }
    on command InspectItem is {
      tell event ItemInspected to entity ReturnsContext.Return
    }
    on command ApproveReturn is {
      tell event ReturnApproved to entity ReturnsContext.Return
    }
    on command RejectReturn is {
      tell event ReturnRejected to entity ReturnsContext.Return
    }
    on command Return.ProcessRefund is {
      morph entity ReturnsContext.Return to state ReturnsContext.Return.CompletedState with command Return.ProcessRefund
      tell event RefundProcessed to entity ReturnsContext.Return
    }
    on command DisposeItem is {
      tell event ItemDisposed to entity ReturnsContext.Return
    }
  } with {
    briefly "Processes return commands"
    described as {
      |Handles return lifecycle.
    }
  }
} with {
  briefly "Return aggregate"
  described as {
    |Manages product returns.
  }
}
