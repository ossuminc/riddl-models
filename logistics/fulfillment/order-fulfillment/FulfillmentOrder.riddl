// Order Fulfillment - FulfillmentOrder Entity

entity FulfillmentOrder is {

  command CreateFulfillmentOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "New fulfillment order identifier."
    }
    orderInfo is FulfillmentOrderInfo with {
      briefly "Order info"
      described by "Fulfillment order details."
    }
  } with {
    briefly "Create fulfillment order"
    described by "Creates a new fulfillment order."
  }

  command AllocateInventory is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    pickTasks is many PickTask with {
      briefly "Pick tasks"
      described by "Pick tasks with bin locations."
    }
  } with {
    briefly "Allocate inventory"
    described by "Allocates inventory and creates pick tasks."
  }

  command RecordPickCompletion is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    sku is String(1, 50) with {
      briefly "SKU"
      described by "Picked item SKU."
    }
    pickedQuantity is Natural with {
      briefly "Picked"
      described by "Quantity picked."
    }
    pickedBy is String(1, 100) with {
      briefly "Picked by"
      described by "Operator who picked item."
    }
  } with {
    briefly "Record pick completion"
    described by "Records completion of a pick task."
  }

  command PackOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    packages is many PackageInfo with {
      briefly "Packages"
      described by "Packed packages."
    }
    packedBy is String(1, 100) with {
      briefly "Packed by"
      described by "Operator who packed order."
    }
  } with {
    briefly "Pack order"
    described by "Records order packing completion."
  }

  command SelectCarrier is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    carrier is CarrierSelection with {
      briefly "Carrier"
      described by "Selected carrier details."
    }
  } with {
    briefly "Select carrier"
    described by "Selects shipping carrier for the order."
  }

  command CreateShippingLabel is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    tracking is TrackingInfo with {
      briefly "Tracking"
      described by "Tracking and label info."
    }
  } with {
    briefly "Create shipping label"
    described by "Creates shipping label and tracking number."
  }

  command ShipOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    shipmentId is ShipmentId with {
      briefly "Shipment"
      described by "Shipment identifier."
    }
    shippedAt is TimeStamp with {
      briefly "Shipped"
      described by "Shipment time."
    }
  } with {
    briefly "Ship order"
    described by "Marks order as shipped."
  }

  command UpdateShipmentStatus is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    currentLocation is String(1, 200) with {
      briefly "Location"
      described by "Current shipment location."
    }
    statusUpdate is String(1, 500) with {
      briefly "Update"
      described by "Status update details."
    }
    updatedAt is TimeStamp with {
      briefly "Updated"
      described by "Update time."
    }
  } with {
    briefly "Update shipment status"
    described by "Updates in-transit shipment status."
  }

  command ConfirmDelivery is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    confirmation is DeliveryConfirmation with {
      briefly "Confirmation"
      described by "Delivery confirmation details."
    }
  } with {
    briefly "Confirm delivery"
    described by "Confirms order delivery."
  }

  command FailDelivery is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Delivery failure reason."
    }
    failedAt is TimeStamp with {
      briefly "Failed at"
      described by "Failure time."
    }
  } with {
    briefly "Fail delivery"
    described by "Records a failed delivery attempt."
  }

  command CancelFulfillment is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel fulfillment"
    described by "Cancels a fulfillment order."
  }

  // Events
  event FulfillmentOrderCreated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    orderInfo is FulfillmentOrderInfo with { briefly "Info" described by "Order info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Fulfillment order created"
    described by "Emitted when fulfillment order is created."
  }

  event InventoryAllocated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    taskCount is Natural with { briefly "Tasks" described by "Number of pick tasks." }
    allocatedAt is TimeStamp with { briefly "Allocated" described by "Allocation time." }
  } with {
    briefly "Inventory allocated"
    described by "Emitted when inventory is allocated for picking."
  }

  event ItemPicked is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    sku is String(1, 50) with { briefly "SKU" described by "Picked item SKU." }
    pickedQuantity is Natural with { briefly "Picked" described by "Quantity picked." }
    pickedAt is TimeStamp with { briefly "Picked at" described by "Pick time." }
  } with {
    briefly "Item picked"
    described by "Emitted when an item is picked."
  }

  event OrderPacked is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    packageCount is Natural with { briefly "Packages" described by "Number of packages." }
    packedAt is TimeStamp with { briefly "Packed" described by "Pack time." }
  } with {
    briefly "Order packed"
    described by "Emitted when order is packed."
  }

  event CarrierSelected is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    carrier is CarrierSelection with { briefly "Carrier" described by "Carrier details." }
    selectedAt is TimeStamp with { briefly "Selected" described by "Selection time." }
  } with {
    briefly "Carrier selected"
    described by "Emitted when carrier is selected."
  }

  event ShippingLabelCreated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    tracking is TrackingInfo with { briefly "Tracking" described by "Tracking info." }
    createdAt is TimeStamp with { briefly "Created" described by "Label creation time." }
  } with {
    briefly "Shipping label created"
    described by "Emitted when shipping label is created."
  }

  event OrderShipped is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    shippedAt is TimeStamp with { briefly "Shipped" described by "Shipment time." }
  } with {
    briefly "Order shipped"
    described by "Emitted when order is shipped."
  }

  event ShipmentStatusUpdated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    currentLocation is String(1, 200) with { briefly "Location" described by "Current location." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Shipment status updated"
    described by "Emitted when shipment status changes."
  }

  event DeliveryConfirmed is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    confirmation is DeliveryConfirmation with { briefly "Confirmation" described by "Delivery confirmation." }
  } with {
    briefly "Delivery confirmed"
    described by "Emitted when delivery is confirmed."
  }

  event DeliveryFailed is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Delivery failed"
    described by "Emitted when delivery attempt fails."
  }

  event FulfillmentCancelled is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Fulfillment cancelled"
    described by "Emitted when fulfillment is cancelled."
  }

  // States
  record ActiveStateData is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    orderInfo is FulfillmentOrderInfo with { briefly "Info" described by "Order info." }
    status is FulfillmentStatus with { briefly "Status" described by "Fulfillment status." }
    pickTasks is many optional PickTask with { briefly "Picks" described by "Pick tasks." }
    packages is many optional PackageInfo with { briefly "Packages" described by "Package details." }
    carrier is optional CarrierSelection with { briefly "Carrier" described by "Selected carrier." }
    tracking is optional TrackingInfo with { briefly "Tracking" described by "Tracking info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active order state"
    described by "State for an active fulfillment order."
  }

  record DeliveredStateData is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    confirmation is DeliveryConfirmation with { briefly "Confirmation" described by "Delivery confirmation." }
  } with {
    briefly "Delivered order state"
    described by "State for a delivered fulfillment order."
  }

  state ActiveState of FulfillmentOrder.ActiveStateData with {
    briefly "Order active"
    described by "Fulfillment order is being processed."
  }

  state DeliveredState of FulfillmentOrder.DeliveredStateData with {
    briefly "Order delivered"
    described by "Fulfillment order has been delivered."
  }

  handler FulfillmentOrderHandler is {
    on command CreateFulfillmentOrder {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.ActiveState with command CreateFulfillmentOrder
      tell event FulfillmentOrderCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AllocateInventory {
      tell event InventoryAllocated to entity FulfillmentContext.FulfillmentOrder
    }
    on command RecordPickCompletion {
      tell event ItemPicked to entity FulfillmentContext.FulfillmentOrder
    }
    on command PackOrder {
      tell event OrderPacked to entity FulfillmentContext.FulfillmentOrder
    }
    on command SelectCarrier {
      tell event CarrierSelected to entity FulfillmentContext.FulfillmentOrder
    }
    on command CreateShippingLabel {
      tell event ShippingLabelCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command ShipOrder {
      tell event OrderShipped to entity FulfillmentContext.FulfillmentOrder
    }
    on command UpdateShipmentStatus {
      tell event ShipmentStatusUpdated to entity FulfillmentContext.FulfillmentOrder
    }
    on command ConfirmDelivery {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.DeliveredState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity FulfillmentContext.FulfillmentOrder
    }
    on command FailDelivery {
      tell event DeliveryFailed to entity FulfillmentContext.FulfillmentOrder
    }
    on command CancelFulfillment {
      tell event FulfillmentCancelled to entity FulfillmentContext.FulfillmentOrder
    }
  } with {
    briefly "Processes fulfillment order commands"
    described by "Handles fulfillment order lifecycle."
  }

} with {
  briefly "FulfillmentOrder aggregate"
  described by "Manages order fulfillment lifecycle."
}
