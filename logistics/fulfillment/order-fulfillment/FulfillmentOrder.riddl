// Order Fulfillment - FulfillmentOrder Entity
entity FulfillmentOrder is {
  command CreateFulfillmentOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |New fulfillment order identifier.
      }
    }
    orderInfo: FulfillmentOrderInfo with {
      briefly "Order info"
      described as {
        |Fulfillment order details.
      }
    }
  } with {
    briefly "Create fulfillment order"
    described as {
      |Creates a new fulfillment order.
    }
  }
  command AllocateInventory is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    pickTasks: PickTask+ with {
      briefly "Pick tasks"
      described as {
        |Pick tasks with bin locations.
      }
    }
  } with {
    briefly "Allocate inventory"
    described as {
      |Allocates inventory and creates pick tasks.
    }
  }
  command RecordPickCompletion is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Picked item SKU.
      }
    }
    pickedQuantity: Natural with {
      briefly "Picked"
      described as {
        |Quantity picked.
      }
    }
    pickedBy: String(1,100) with {
      briefly "Picked by"
      described as {
        |Operator who picked item.
      }
    }
  } with {
    briefly "Record pick completion"
    described as {
      |Records completion of a pick task.
    }
  }
  command PackOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    packages: PackageInfo+ with {
      briefly "Packages"
      described as {
        |Packed packages.
      }
    }
    packedBy: String(1,100) with {
      briefly "Packed by"
      described as {
        |Operator who packed order.
      }
    }
  } with {
    briefly "Pack order"
    described as {
      |Records order packing completion.
    }
  }
  command SelectCarrier is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    carrier: CarrierSelection with {
      briefly "Carrier"
      described as {
        |Selected carrier details.
      }
    }
  } with {
    briefly "Select carrier"
    described as {
      |Selects shipping carrier for the order.
    }
  }
  command CreateShippingLabel is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    tracking: TrackingInfo with {
      briefly "Tracking"
      described as {
        |Tracking and label info.
      }
    }
  } with {
    briefly "Create shipping label"
    described as {
      |Creates shipping label and tracking number.
    }
  }
  command ShipOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment identifier.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Shipment time.
      }
    }
  } with {
    briefly "Ship order"
    described as {
      |Marks order as shipped.
    }
  }
  command UpdateShipmentStatus is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    currentLocation: String(1,200) with {
      briefly "Location"
      described as {
        |Current shipment location.
      }
    }
    statusUpdate: String(1,500) with {
      briefly "Update"
      described as {
        |Status update details.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Update shipment status"
    described as {
      |Updates in-transit shipment status.
    }
  }
  command ConfirmDelivery is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    confirmation: DeliveryConfirmation with {
      briefly "Confirmation"
      described as {
        |Delivery confirmation details.
      }
    }
  } with {
    briefly "Confirm delivery"
    described as {
      |Confirms order delivery.
    }
  }
  command FailDelivery is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Delivery failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed at"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Fail delivery"
    described as {
      |Records a failed delivery attempt.
    }
  }
  command CancelFulfillment is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel fulfillment"
    described as {
      |Cancels a fulfillment order.
    }
  }
  // Events
  event FulfillmentOrderCreated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: FulfillmentOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Fulfillment order created"
    described as {
      |Emitted when fulfillment order is created.
    }
  }
  event InventoryAllocated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    taskCount: Natural with {
      briefly "Tasks"
      described as {
        |Number of pick tasks.
      }
    }
    allocatedAt: TimeStamp with {
      briefly "Allocated"
      described as {
        |Allocation time.
      }
    }
  } with {
    briefly "Inventory allocated"
    described as {
      |Emitted when inventory is allocated for picking.
    }
  }
  event ItemPicked is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    sku: String(1,50) with {
      briefly "SKU"
      described as {
        |Picked item SKU.
      }
    }
    pickedQuantity: Natural with {
      briefly "Picked"
      described as {
        |Quantity picked.
      }
    }
    pickedAt: TimeStamp with {
      briefly "Picked at"
      described as {
        |Pick time.
      }
    }
  } with {
    briefly "Item picked"
    described as {
      |Emitted when an item is picked.
    }
  }
  event OrderPacked is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    packageCount: Natural with {
      briefly "Packages"
      described as {
        |Number of packages.
      }
    }
    packedAt: TimeStamp with {
      briefly "Packed"
      described as {
        |Pack time.
      }
    }
  } with {
    briefly "Order packed"
    described as {
      |Emitted when order is packed.
    }
  }
  event CarrierSelected is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    carrier: CarrierSelection with {
      briefly "Carrier"
      described as {
        |Carrier details.
      }
    }
    selectedAt: TimeStamp with {
      briefly "Selected"
      described as {
        |Selection time.
      }
    }
  } with {
    briefly "Carrier selected"
    described as {
      |Emitted when carrier is selected.
    }
  }
  event ShippingLabelCreated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    tracking: TrackingInfo with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Label creation time.
      }
    }
  } with {
    briefly "Shipping label created"
    described as {
      |Emitted when shipping label is created.
    }
  }
  event OrderShipped is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    shippedAt: TimeStamp with {
      briefly "Shipped"
      described as {
        |Shipment time.
      }
    }
  } with {
    briefly "Order shipped"
    described as {
      |Emitted when order is shipped.
    }
  }
  event ShipmentStatusUpdated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    currentLocation: String(1,200) with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Shipment status updated"
    described as {
      |Emitted when shipment status changes.
    }
  }
  event DeliveryConfirmed is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    confirmation: DeliveryConfirmation with {
      briefly "Confirmation"
      described as {
        |Delivery confirmation.
      }
    }
  } with {
    briefly "Delivery confirmed"
    described as {
      |Emitted when delivery is confirmed.
    }
  }
  event DeliveryFailed is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Delivery failed"
    described as {
      |Emitted when delivery attempt fails.
    }
  }
  event FulfillmentCancelled is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Fulfillment cancelled"
    described as {
      |Emitted when fulfillment is cancelled.
    }
  }
  // States
  record ActiveStateData is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: FulfillmentOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    status: FulfillmentStatus with {
      briefly "Status"
      described as {
        |Fulfillment status.
      }
    }
    assignedPickTasks: PickTask* with {
      briefly "Picks"
      described as {
        |Pick tasks.
      }
    }
    packedPackages: PackageInfo* with {
      briefly "Packages"
      described as {
        |Package details.
      }
    }
    selectedCarrier: CarrierSelection? with {
      briefly "Carrier"
      described as {
        |Selected carrier.
      }
    }
    shipmentTracking: TrackingInfo? with {
      briefly "Tracking"
      described as {
        |Tracking info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active order state"
    described as {
      |State for an active fulfillment order.
    }
  }
  record DeliveredStateData is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    confirmation: DeliveryConfirmation with {
      briefly "Confirmation"
      described as {
        |Delivery confirmation.
      }
    }
  } with {
    briefly "Delivered order state"
    described as {
      |State for a delivered fulfillment order.
    }
  }
  state ActiveState of type FulfillmentOrder.ActiveStateData
  state DeliveredState of type FulfillmentOrder.DeliveredStateData
  handler FulfillmentOrderHandler is {
    on command CreateFulfillmentOrder is {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.ActiveState with command CreateFulfillmentOrder
      tell event FulfillmentOrderCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AllocateInventory is {
      tell event InventoryAllocated to entity FulfillmentContext.FulfillmentOrder
    }
    on command RecordPickCompletion is {
      tell event ItemPicked to entity FulfillmentContext.FulfillmentOrder
    }
    on command PackOrder is {
      tell event OrderPacked to entity FulfillmentContext.FulfillmentOrder
    }
    on command SelectCarrier is {
      tell event CarrierSelected to entity FulfillmentContext.FulfillmentOrder
    }
    on command CreateShippingLabel is {
      tell event ShippingLabelCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command ShipOrder is {
      tell event OrderShipped to entity FulfillmentContext.FulfillmentOrder
    }
    on command UpdateShipmentStatus is {
      tell event ShipmentStatusUpdated to entity FulfillmentContext.FulfillmentOrder
    }
    on command ConfirmDelivery is {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.DeliveredState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity FulfillmentContext.FulfillmentOrder
    }
    on command FailDelivery is {
      tell event DeliveryFailed to entity FulfillmentContext.FulfillmentOrder
    }
    on command CancelFulfillment is {
      tell event FulfillmentCancelled to entity FulfillmentContext.FulfillmentOrder
    }
  } with {
    briefly "Processes fulfillment order commands"
    described as {
      |Handles fulfillment order lifecycle.
    }
  }
} with {
  briefly "FulfillmentOrder aggregate"
  described as {
    |Manages order fulfillment lifecycle.
  }
}
