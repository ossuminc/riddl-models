// Order Fulfillment - Fulfillment Context
context FulfillmentContext is {
  include "types.riddl"
  include "FulfillmentOrder.riddl"
  repository FulfillmentRepository is {
    schema FulfillmentData is relational
      of fulfillmentOrders as type FulfillmentOrder
        index on field FulfillmentOrder.orderId
        index on field FulfillmentOrder.orderInfo.customerId
        index on field FulfillmentOrder.status

    handler FulfillmentPersistence is {
      on command FulfillmentOrder.CreateFulfillmentOrder is {
        prompt "Store new fulfillment order"
      }
      on command FulfillmentOrder.AllocateInventory is {
        prompt "Update order with pick tasks"
      }
      on command FulfillmentOrder.PackOrder is {
        prompt "Update order packing status"
      }
      on command FulfillmentOrder.ShipOrder is {
        prompt "Update order to shipped"
      }
      on command FulfillmentOrder.ConfirmDelivery is {
        prompt "Update order to delivered"
      }
    } with {
      briefly "Persists fulfillment commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Fulfillment data persistence"
    described as {
      |Persistent storage for fulfillment orders.
    }
  }
  projector FulfillmentMetrics is {
    record OrderMetrics is  {
      ordersReceived: Natural with {
        briefly "Received"
        described as {
          |Orders received.
        }
      }
      ordersShipped: Natural with {
        briefly "Shipped"
        described as {
          |Orders shipped.
        }
      }
      ordersDelivered: Natural with {
        briefly "Delivered"
        described as {
          |Orders delivered.
        }
      }
      ordersFailed: Natural with {
        briefly "Failed"
        described as {
          |Orders with failed delivery.
        }
      }
      averageFulfillmentTime: Decimal(8,2) with {
        briefly "Avg time"
        described as {
          |Average fulfillment hours.
        }
      }
    } with {
      briefly "Order metrics"
      described as {
        |Fulfillment processing metrics.
      }
    }
    handler MetricsHandler is {
      on event FulfillmentOrder.FulfillmentOrderCreated is {
        prompt "Increment orders received"
      }
      on event FulfillmentOrder.OrderShipped is {
        prompt "Increment orders shipped"
      }
      on event FulfillmentOrder.DeliveryConfirmed is {
        prompt "Increment orders delivered and calculate time"
      }
      on event FulfillmentOrder.DeliveryFailed is {
        prompt "Increment orders failed"
      }
    } with {
      briefly "Maintains fulfillment metrics"
      described as {
        |Projects events into metrics.
      }
    }
  } with {
    briefly "Fulfillment metrics"
    described as {
      |Order fulfillment analytics.
    }
  }
} with {
  briefly "Bounded context for order fulfillment"
  described as {
    |Order fulfillment operations context.
  }
}
