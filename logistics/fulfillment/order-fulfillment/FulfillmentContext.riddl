// Order Fulfillment - Fulfillment Context

context FulfillmentContext is {

  include "types.riddl"
  include "FulfillmentOrder.riddl"

  repository FulfillmentRepository is {
    schema FulfillmentData is relational
      of fulfillmentOrders as FulfillmentOrder
      index on field FulfillmentOrder.orderId
      index on field FulfillmentOrder.orderInfo.customerId
      index on field FulfillmentOrder.status

    handler FulfillmentPersistence is {
      on command FulfillmentOrder.CreateFulfillmentOrder {
        prompt "Store new fulfillment order"
      }
      on command FulfillmentOrder.AllocateInventory {
        prompt "Update order with pick tasks"
      }
      on command FulfillmentOrder.PackOrder {
        prompt "Update order packing status"
      }
      on command FulfillmentOrder.ShipOrder {
        prompt "Update order to shipped"
      }
      on command FulfillmentOrder.ConfirmDelivery {
        prompt "Update order to delivered"
      }
    } with {
      briefly "Persists fulfillment commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Fulfillment data persistence"
    described by "Persistent storage for fulfillment orders."
  }

  projector FulfillmentMetrics is {
    updates repository FulfillmentRepository

    record OrderMetrics is {
      ordersReceived is Natural with { briefly "Received" described by "Orders received." }
      ordersShipped is Natural with { briefly "Shipped" described by "Orders shipped." }
      ordersDelivered is Natural with { briefly "Delivered" described by "Orders delivered." }
      ordersFailed is Natural with { briefly "Failed" described by "Orders with failed delivery." }
      averageFulfillmentTime is Decimal(8, 2) with { briefly "Avg time" described by "Average fulfillment hours." }
    } with {
      briefly "Order metrics"
      described by "Fulfillment processing metrics."
    }

    handler MetricsHandler is {
      on event FulfillmentOrder.FulfillmentOrderCreated {
        prompt "Increment orders received"
      }
      on event FulfillmentOrder.OrderShipped {
        prompt "Increment orders shipped"
      }
      on event FulfillmentOrder.DeliveryConfirmed {
        prompt "Increment orders delivered and calculate time"
      }
      on event FulfillmentOrder.DeliveryFailed {
        prompt "Increment orders failed"
      }
    } with {
      briefly "Maintains fulfillment metrics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Fulfillment metrics"
    described by "Order fulfillment analytics."
  }

} with {
  briefly "Bounded context for order fulfillment"
  described by "Order fulfillment operations context."
}
