// Order Fulfillment - FulfillmentOrder Entity

entity FulfillmentOrder is {

  command CreateOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "New order identifier."
    }
    salesOrderId is SalesOrderId with {
      briefly "Sales order"
      described by "Originating sales order."
    }
    warehouseId is WarehouseId with {
      briefly "Warehouse"
      described by "Fulfillment warehouse."
    }
    lines is many OrderLine with {
      briefly "Lines"
      described by "Order lines."
    }
    shippingAddress is ShippingAddress with {
      briefly "Address"
      described by "Shipping address."
    }
    priority is ShipmentPriority with {
      briefly "Priority"
      described by "Shipment priority."
    }
  } with {
    briefly "Create order"
    described by "Creates a fulfillment order."
  }

  command AllocateInventory is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    allocations is many OrderLine with {
      briefly "Allocations"
      described by "Inventory allocations."
    }
  } with {
    briefly "Allocate inventory"
    described by "Allocates inventory to order."
  }

  command AssignPickTasks is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    tasks is many PickTask with {
      briefly "Tasks"
      described by "Pick tasks."
    }
  } with {
    briefly "Assign pick tasks"
    described by "Assigns picking tasks."
  }

  command RecordPick is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    taskId is UUID with {
      briefly "Task"
      described by "Pick task ID."
    }
    quantityPicked is Natural with {
      briefly "Picked"
      described by "Quantity picked."
    }
    pickerId is String(1, 50) with {
      briefly "Picker"
      described by "Picker ID."
    }
    pickedAt is TimeStamp with {
      briefly "Picked at"
      described by "Pick time."
    }
  } with {
    briefly "Record pick"
    described by "Records item pick completion."
  }

  command CompletePicking is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
  } with {
    briefly "Complete picking"
    described by "Marks picking as complete."
  }

  command PackOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    packingSlip is PackingSlip with {
      briefly "Packing slip"
      described by "Packing details."
    }
  } with {
    briefly "Pack order"
    described by "Packs order for shipment."
  }

  command ShipOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    shipment is ShipmentInfo with {
      briefly "Shipment"
      described by "Shipment details."
    }
  } with {
    briefly "Ship order"
    described by "Ships the order."
  }

  command ConfirmDelivery is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery time."
    }
    signedBy is optional String(1, 100) with {
      briefly "Signed by"
      described by "Signature name."
    }
  } with {
    briefly "Confirm delivery"
    described by "Confirms order delivery."
  }

  command PlaceOnHold is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Hold reason."
    }
  } with {
    briefly "Place on hold"
    described by "Places order on hold."
  }

  command CancelOrder is {
    orderId is FulfillmentOrderId with {
      briefly "Order ID"
      described by "Order identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancellation reason."
    }
  } with {
    briefly "Cancel order"
    described by "Cancels fulfillment order."
  }

  // Events
  event OrderCreated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    salesOrderId is SalesOrderId with { briefly "Sales order" described by "Sales order." }
    lineCount is Natural with { briefly "Lines" described by "Line count." }
    priority is ShipmentPriority with { briefly "Priority" described by "Priority." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Order created"
    described by "Emitted when order is created."
  }

  event InventoryAllocated is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    allocationStatus is AllocationStatus with { briefly "Status" described by "Allocation status." }
    allocatedAt is TimeStamp with { briefly "Allocated" described by "Allocation time." }
  } with {
    briefly "Inventory allocated"
    described by "Emitted when inventory is allocated."
  }

  event PickTasksAssigned is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    taskCount is Natural with { briefly "Tasks" described by "Task count." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Pick tasks assigned"
    described by "Emitted when pick tasks assigned."
  }

  event ItemPicked is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    taskId is UUID with { briefly "Task" described by "Task ID." }
    quantityPicked is Natural with { briefly "Picked" described by "Quantity." }
    pickedAt is TimeStamp with { briefly "Picked at" described by "Pick time." }
  } with {
    briefly "Item picked"
    described by "Emitted when item is picked."
  }

  event PickingCompleted is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    totalItemsPicked is Natural with { briefly "Total" described by "Total items." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Picking completed"
    described by "Emitted when picking completes."
  }

  event OrderPacked is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    packingSlip is PackingSlip with { briefly "Slip" described by "Packing slip." }
  } with {
    briefly "Order packed"
    described by "Emitted when order is packed."
  }

  event OrderShipped is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    shipment is ShipmentInfo with { briefly "Shipment" described by "Shipment info." }
  } with {
    briefly "Order shipped"
    described by "Emitted when order ships."
  }

  event DeliveryConfirmed is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Delivery confirmed"
    described by "Emitted when delivered."
  }

  event OrderPlacedOnHold is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Hold reason." }
    heldAt is TimeStamp with { briefly "Held" described by "Hold time." }
  } with {
    briefly "Order placed on hold"
    described by "Emitted when order held."
  }

  event OrderCancelled is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Order cancelled"
    described by "Emitted when order cancelled."
  }

  // States
  record ActiveStateData is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    salesOrderId is SalesOrderId with { briefly "Sales order" described by "Sales order." }
    warehouseId is WarehouseId with { briefly "Warehouse" described by "Warehouse." }
    status is OrderStatus with { briefly "Status" described by "Order status." }
    lines is many OrderLine with { briefly "Lines" described by "Order lines." }
    shippingAddress is ShippingAddress with { briefly "Address" described by "Ship address." }
    priority is ShipmentPriority with { briefly "Priority" described by "Priority." }
    pickTasks is many optional PickTask with { briefly "Tasks" described by "Pick tasks." }
    packingSlip is optional PackingSlip with { briefly "Packing" described by "Packing slip." }
    shipment is optional ShipmentInfo with { briefly "Shipment" described by "Shipment." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active order state"
    described by "State for active order."
  }

  record CompletedStateData is {
    orderId is FulfillmentOrderId with { briefly "Order" described by "Order ID." }
    shipment is ShipmentInfo with { briefly "Shipment" described by "Shipment info." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
  } with {
    briefly "Completed order state"
    described by "State for delivered order."
  }

  state ActiveState of FulfillmentOrder.ActiveStateData with {
    briefly "Order active"
    described by "Order is being processed."
  }

  state CompletedState of FulfillmentOrder.CompletedStateData with {
    briefly "Order completed"
    described by "Order has been delivered."
  }

  handler FulfillmentOrderHandler is {
    on command CreateOrder {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AllocateInventory {
      tell event InventoryAllocated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AssignPickTasks {
      tell event PickTasksAssigned to entity FulfillmentContext.FulfillmentOrder
    }
    on command RecordPick {
      tell event ItemPicked to entity FulfillmentContext.FulfillmentOrder
    }
    on command CompletePicking {
      tell event PickingCompleted to entity FulfillmentContext.FulfillmentOrder
    }
    on command PackOrder {
      tell event OrderPacked to entity FulfillmentContext.FulfillmentOrder
    }
    on command ShipOrder {
      tell event OrderShipped to entity FulfillmentContext.FulfillmentOrder
    }
    on command ConfirmDelivery {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.CompletedState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity FulfillmentContext.FulfillmentOrder
    }
    on command PlaceOnHold {
      tell event OrderPlacedOnHold to entity FulfillmentContext.FulfillmentOrder
    }
    on command CancelOrder {
      tell event OrderCancelled to entity FulfillmentContext.FulfillmentOrder
    }
  } with {
    briefly "Processes order commands"
    described by "Handles fulfillment order lifecycle."
  }

} with {
  briefly "FulfillmentOrder aggregate"
  described by "Manages fulfillment orders."
}
