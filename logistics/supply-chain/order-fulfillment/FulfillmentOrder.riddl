// Order Fulfillment - FulfillmentOrder Entity
entity FulfillmentOrder is {
  command CreateOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |New order identifier.
      }
    }
    salesOrderId: SalesOrderId with {
      briefly "Sales order"
      described as {
        |Originating sales order.
      }
    }
    warehouseId: WarehouseId with {
      briefly "Warehouse"
      described as {
        |Fulfillment warehouse.
      }
    }
    lines: OrderLine+ with {
      briefly "Lines"
      described as {
        |Order lines.
      }
    }
    shippingAddress: ShippingAddress with {
      briefly "Address"
      described as {
        |Shipping address.
      }
    }
    priority: ShipmentPriority with {
      briefly "Priority"
      described as {
        |Shipment priority.
      }
    }
  } with {
    briefly "Create order"
    described as {
      |Creates a fulfillment order.
    }
  }
  command AllocateInventory is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    allocations: OrderLine+ with {
      briefly "Allocations"
      described as {
        |Inventory allocations.
      }
    }
  } with {
    briefly "Allocate inventory"
    described as {
      |Allocates inventory to order.
    }
  }
  command AssignPickTasks is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    tasks: PickTask+ with {
      briefly "Tasks"
      described as {
        |Pick tasks.
      }
    }
  } with {
    briefly "Assign pick tasks"
    described as {
      |Assigns picking tasks.
    }
  }
  command RecordPick is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    taskId: UUID with {
      briefly "Task"
      described as {
        |Pick task ID.
      }
    }
    quantityPicked: Natural with {
      briefly "Picked"
      described as {
        |Quantity picked.
      }
    }
    pickerId: String(1,50) with {
      briefly "Picker"
      described as {
        |Picker ID.
      }
    }
    pickedAt: TimeStamp with {
      briefly "Picked at"
      described as {
        |Pick time.
      }
    }
  } with {
    briefly "Record pick"
    described as {
      |Records item pick completion.
    }
  }
  command CompletePicking is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Complete picking"
    described as {
      |Marks picking as complete.
    }
  }
  command PackOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    packingSlip: PackingSlip with {
      briefly "Packing slip"
      described as {
        |Packing details.
      }
    }
  } with {
    briefly "Pack order"
    described as {
      |Packs order for shipment.
    }
  }
  command ShipOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    shipment: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Shipment details.
      }
    }
  } with {
    briefly "Ship order"
    described as {
      |Ships the order.
    }
  }
  command ConfirmDelivery is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        |Signature name.
      }
    }
  } with {
    briefly "Confirm delivery"
    described as {
      |Confirms order delivery.
    }
  }
  command PlaceOnHold is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
  } with {
    briefly "Place on hold"
    described as {
      |Places order on hold.
    }
  }
  command CancelOrder is  {
    orderId: FulfillmentOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel order"
    described as {
      |Cancels fulfillment order.
    }
  }
  // Events
  event OrderCreated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    salesOrderId: SalesOrderId with {
      briefly "Sales order"
      described as {
        |Sales order.
      }
    }
    lineCount: Natural with {
      briefly "Lines"
      described as {
        |Line count.
      }
    }
    priority: ShipmentPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Order created"
    described as {
      |Emitted when order is created.
    }
  }
  event InventoryAllocated is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    allocationStatus: AllocationStatus with {
      briefly "Status"
      described as {
        |Allocation status.
      }
    }
    allocatedAt: TimeStamp with {
      briefly "Allocated"
      described as {
        |Allocation time.
      }
    }
  } with {
    briefly "Inventory allocated"
    described as {
      |Emitted when inventory is allocated.
    }
  }
  event PickTasksAssigned is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    taskCount: Natural with {
      briefly "Tasks"
      described as {
        |Task count.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Pick tasks assigned"
    described as {
      |Emitted when pick tasks assigned.
    }
  }
  event ItemPicked is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    taskId: UUID with {
      briefly "Task"
      described as {
        |Task ID.
      }
    }
    quantityPicked: Natural with {
      briefly "Picked"
      described as {
        |Quantity.
      }
    }
    pickedAt: TimeStamp with {
      briefly "Picked at"
      described as {
        |Pick time.
      }
    }
  } with {
    briefly "Item picked"
    described as {
      |Emitted when item is picked.
    }
  }
  event PickingCompleted is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    totalItemsPicked: Natural with {
      briefly "Total"
      described as {
        |Total items.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Picking completed"
    described as {
      |Emitted when picking completes.
    }
  }
  event OrderPacked is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    packingSlip: PackingSlip with {
      briefly "Slip"
      described as {
        |Packing slip.
      }
    }
  } with {
    briefly "Order packed"
    described as {
      |Emitted when order is packed.
    }
  }
  event OrderShipped is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    shipment: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Shipment info.
      }
    }
  } with {
    briefly "Order shipped"
    described as {
      |Emitted when order ships.
    }
  }
  event DeliveryConfirmed is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Delivery confirmed"
    described as {
      |Emitted when delivered.
    }
  }
  event OrderPlacedOnHold is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Hold reason.
      }
    }
    heldAt: TimeStamp with {
      briefly "Held"
      described as {
        |Hold time.
      }
    }
  } with {
    briefly "Order placed on hold"
    described as {
      |Emitted when order held.
    }
  }
  event OrderCancelled is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Order cancelled"
    described as {
      |Emitted when order cancelled.
    }
  }
  // States
  record ActiveStateData is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    salesOrderId: SalesOrderId with {
      briefly "Sales order"
      described as {
        |Sales order.
      }
    }
    warehouseId: WarehouseId with {
      briefly "Warehouse"
      described as {
        |Warehouse.
      }
    }
    status: OrderStatus with {
      briefly "Status"
      described as {
        |Order status.
      }
    }
    lines: OrderLine+ with {
      briefly "Lines"
      described as {
        |Order lines.
      }
    }
    shippingAddress: ShippingAddress with {
      briefly "Address"
      described as {
        |Ship address.
      }
    }
    priority: ShipmentPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    pickTasks: PickTask* with {
      briefly "Tasks"
      described as {
        |Pick tasks.
      }
    }
    currentPackingSlip: PackingSlip? with {
      briefly "Packing"
      described as {
        |Packing slip.
      }
    }
    currentShipment: ShipmentInfo? with {
      briefly "Shipment"
      described as {
        |Shipment.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active order state"
    described as {
      |State for active order.
    }
  }
  record CompletedStateData is  {
    orderId: FulfillmentOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    shipment: ShipmentInfo with {
      briefly "Shipment"
      described as {
        |Shipment info.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
  } with {
    briefly "Completed order state"
    described as {
      |State for delivered order.
    }
  }
  state ActiveState of type FulfillmentOrder.ActiveStateData
  state CompletedState of type FulfillmentOrder.CompletedStateData
  handler FulfillmentOrderHandler is {
    on command CreateOrder is {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.ActiveState with command CreateOrder
      tell event OrderCreated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AllocateInventory is {
      tell event InventoryAllocated to entity FulfillmentContext.FulfillmentOrder
    }
    on command AssignPickTasks is {
      tell event PickTasksAssigned to entity FulfillmentContext.FulfillmentOrder
    }
    on command RecordPick is {
      tell event ItemPicked to entity FulfillmentContext.FulfillmentOrder
    }
    on command CompletePicking is {
      tell event PickingCompleted to entity FulfillmentContext.FulfillmentOrder
    }
    on command PackOrder is {
      tell event OrderPacked to entity FulfillmentContext.FulfillmentOrder
    }
    on command ShipOrder is {
      tell event OrderShipped to entity FulfillmentContext.FulfillmentOrder
    }
    on command ConfirmDelivery is {
      morph entity FulfillmentContext.FulfillmentOrder to state FulfillmentContext.FulfillmentOrder.CompletedState with command ConfirmDelivery
      tell event DeliveryConfirmed to entity FulfillmentContext.FulfillmentOrder
    }
    on command PlaceOnHold is {
      tell event OrderPlacedOnHold to entity FulfillmentContext.FulfillmentOrder
    }
    on command CancelOrder is {
      tell event OrderCancelled to entity FulfillmentContext.FulfillmentOrder
    }
  } with {
    briefly "Processes order commands"
    described as {
      |Handles fulfillment order lifecycle.
    }
  }
} with {
  briefly "FulfillmentOrder aggregate"
  described as {
    |Manages fulfillment orders.
  }
}
