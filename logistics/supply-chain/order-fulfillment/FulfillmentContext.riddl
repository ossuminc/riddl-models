// Order Fulfillment - Fulfillment Context

context FulfillmentContext is {

  include "types.riddl"
  include "FulfillmentOrder.riddl"

  repository FulfillmentRepository is {
    schema FulfillmentData is relational
      of orders as FulfillmentOrder
      index on field FulfillmentOrder.orderId
      index on field FulfillmentOrder.salesOrderId
      index on field FulfillmentOrder.status
      index on field FulfillmentOrder.warehouseId

    handler FulfillmentPersistence is {
      on command FulfillmentOrder.CreateOrder {
        prompt "Store new fulfillment order"
      }
      on command FulfillmentOrder.AllocateInventory {
        prompt "Update order allocations"
      }
      on command FulfillmentOrder.RecordPick {
        prompt "Update pick task status"
      }
      on command FulfillmentOrder.PackOrder {
        prompt "Store packing slip"
      }
      on command FulfillmentOrder.ShipOrder {
        prompt "Store shipment info"
      }
      on command FulfillmentOrder.ConfirmDelivery {
        prompt "Update order to completed"
      }
    } with {
      briefly "Persists fulfillment commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Fulfillment data persistence"
    described by "Persistent storage for orders."
  }

  projector FulfillmentMetrics is {
    updates repository FulfillmentRepository

    record WarehouseMetrics is {
      warehouseId is WarehouseId with { briefly "Warehouse" described by "Warehouse ID." }
      ordersProcessed is Natural with { briefly "Processed" described by "Orders processed." }
      ordersShipped is Natural with { briefly "Shipped" described by "Orders shipped." }
      avgFulfillmentTime is Decimal(6, 2) with { briefly "Avg time" described by "Avg fulfillment hours." }
      onTimeRate is Decimal(5, 2) with { briefly "On time" described by "On-time percentage." }
      pickAccuracy is Decimal(5, 2) with { briefly "Accuracy" described by "Pick accuracy pct." }
    } with {
      briefly "Warehouse metrics"
      described by "Fulfillment metrics by warehouse."
    }

    handler MetricsHandler is {
      on event FulfillmentOrder.OrderCreated {
        prompt "Track order receipt"
      }
      on event FulfillmentOrder.OrderShipped {
        prompt "Calculate fulfillment time and update metrics"
      }
      on event FulfillmentOrder.DeliveryConfirmed {
        prompt "Update on-time delivery rate"
      }
    } with {
      briefly "Maintains fulfillment metrics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Fulfillment metrics"
    described by "Order fulfillment analytics."
  }

} with {
  briefly "Bounded context for order fulfillment"
  described by "Supply chain fulfillment context."
}
