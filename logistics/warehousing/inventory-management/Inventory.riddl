// Inventory Management - Inventory Entity

entity Inventory is {

  // Commands
  command InitializeInventory is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "New inventory identifier."
    }
    warehouseId is WarehouseId with {
      briefly "Warehouse"
      described by "Warehouse identifier."
    }
    product is ProductInfo with {
      briefly "Product"
      described by "Product information."
    }
    location is LocationInfo with {
      briefly "Location"
      described by "Storage location."
    }
  } with {
    briefly "Initialize inventory"
    described by "Initializes inventory record."
  }

  command ReceiveStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    receipt is ReceiptInfo with {
      briefly "Receipt"
      described by "Receipt information."
    }
  } with {
    briefly "Receive stock"
    described by "Receives stock into inventory."
  }

  command ReserveStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    reservation is ReservationInfo with {
      briefly "Reservation"
      described by "Reservation details."
    }
  } with {
    briefly "Reserve stock"
    described by "Reserves stock for order."
  }

  command ReleaseReservation is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    orderId is UUID with {
      briefly "Order"
      described by "Order ID to release."
    }
  } with {
    briefly "Release reservation"
    described by "Releases stock reservation."
  }

  command AllocateStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    orderId is UUID with {
      briefly "Order"
      described by "Order ID."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Quantity to allocate."
    }
  } with {
    briefly "Allocate stock"
    described by "Allocates reserved stock for picking."
  }

  command PickStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Quantity to pick."
    }
    pickedBy is String(1, 200) with {
      briefly "Picked by"
      described by "Person picking."
    }
  } with {
    briefly "Pick stock"
    described by "Picks stock from location."
  }

  command TransferStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    toLocation is LocationInfo with {
      briefly "To location"
      described by "Destination location."
    }
    quantity is Natural with {
      briefly "Quantity"
      described by "Quantity to transfer."
    }
    performedBy is String(1, 200) with {
      briefly "Performed by"
      described by "Person transferring."
    }
  } with {
    briefly "Transfer stock"
    described by "Transfers stock to new location."
  }

  command AdjustStock is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    quantity is Integer with {
      briefly "Quantity"
      described by "Adjustment quantity (positive or negative)."
    }
    reason is AdjustmentReason with {
      briefly "Reason"
      described by "Adjustment reason."
    }
    adjustedBy is String(1, 200) with {
      briefly "Adjusted by"
      described by "Person adjusting."
    }
  } with {
    briefly "Adjust stock"
    described by "Adjusts inventory quantity."
  }

  command CycleCount is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    countedQuantity is Natural with {
      briefly "Counted"
      described by "Physical count."
    }
    countedBy is String(1, 200) with {
      briefly "Counted by"
      described by "Person counting."
    }
  } with {
    briefly "Cycle count"
    described by "Records cycle count."
  }

  command RequestReplenishment is {
    inventoryId is InventoryId with {
      briefly "Inventory ID"
      described by "Inventory identifier."
    }
    request is ReplenishmentRequest with {
      briefly "Request"
      described by "Replenishment request."
    }
  } with {
    briefly "Request replenishment"
    described by "Requests location replenishment."
  }

  // Events
  event InventoryInitialized is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    warehouseId is WarehouseId with { briefly "Warehouse" described by "Warehouse ID." }
    product is ProductInfo with { briefly "Product" described by "Product info." }
    location is LocationInfo with { briefly "Location" described by "Location info." }
    initializedAt is TimeStamp with { briefly "Initialized" described by "Initialization time." }
  } with {
    briefly "Inventory initialized"
    described by "Emitted when inventory is initialized."
  }

  event StockReceived is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    receipt is ReceiptInfo with { briefly "Receipt" described by "Receipt info." }
    newLevel is StockLevel with { briefly "Level" described by "New stock level." }
    receivedAt is TimeStamp with { briefly "Received" described by "Receipt time." }
  } with {
    briefly "Stock received"
    described by "Emitted when stock is received."
  }

  event StockReserved is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    reservation is ReservationInfo with { briefly "Reservation" described by "Reservation info." }
    reservedAt is TimeStamp with { briefly "Reserved" described by "Reservation time." }
  } with {
    briefly "Stock reserved"
    described by "Emitted when stock is reserved."
  }

  event ReservationReleased is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    orderId is UUID with { briefly "Order" described by "Order ID." }
    releasedQuantity is Natural with { briefly "Quantity" described by "Released quantity." }
    releasedAt is TimeStamp with { briefly "Released" described by "Release time." }
  } with {
    briefly "Reservation released"
    described by "Emitted when reservation is released."
  }

  event StockAllocated is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    orderId is UUID with { briefly "Order" described by "Order ID." }
    allocatedQuantity is Natural with { briefly "Quantity" described by "Allocated quantity." }
    allocatedAt is TimeStamp with { briefly "Allocated" described by "Allocation time." }
  } with {
    briefly "Stock allocated"
    described by "Emitted when stock is allocated."
  }

  event StockPicked is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    pickedQuantity is Natural with { briefly "Quantity" described by "Picked quantity." }
    pickedBy is String(1, 200) with { briefly "Picked by" described by "Picker." }
    pickedAt is TimeStamp with { briefly "Picked" described by "Pick time." }
  } with {
    briefly "Stock picked"
    described by "Emitted when stock is picked."
  }

  event StockTransferred is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    fromLocation is LocationInfo with { briefly "From" described by "Source location." }
    toLocation is LocationInfo with { briefly "To" described by "Destination location." }
    quantity is Natural with { briefly "Quantity" described by "Transferred quantity." }
    transferredAt is TimeStamp with { briefly "Transferred" described by "Transfer time." }
  } with {
    briefly "Stock transferred"
    described by "Emitted when stock is transferred."
  }

  event StockAdjusted is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    adjustmentQuantity is Integer with { briefly "Adjustment" described by "Adjustment quantity." }
    reason is AdjustmentReason with { briefly "Reason" described by "Adjustment reason." }
    newLevel is StockLevel with { briefly "Level" described by "New stock level." }
    adjustedAt is TimeStamp with { briefly "Adjusted" described by "Adjustment time." }
  } with {
    briefly "Stock adjusted"
    described by "Emitted when stock is adjusted."
  }

  event CycleCountRecorded is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    systemQuantity is Natural with { briefly "System" described by "System quantity." }
    countedQuantity is Natural with { briefly "Counted" described by "Counted quantity." }
    variance is Integer with { briefly "Variance" described by "Count variance." }
    countedAt is TimeStamp with { briefly "Counted" described by "Count time." }
  } with {
    briefly "Cycle count recorded"
    described by "Emitted when cycle count is recorded."
  }

  event ReplenishmentRequested is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    request is ReplenishmentRequest with { briefly "Request" described by "Replenishment request." }
    requestedAt is TimeStamp with { briefly "Requested" described by "Request time." }
  } with {
    briefly "Replenishment requested"
    described by "Emitted when replenishment is requested."
  }

  // State Records
  record ActiveStateData is {
    inventoryId is InventoryId with { briefly "Inventory" described by "Inventory ID." }
    warehouseId is WarehouseId with { briefly "Warehouse" described by "Warehouse ID." }
    product is ProductInfo with { briefly "Product" described by "Product info." }
    location is LocationInfo with { briefly "Location" described by "Current location." }
    lot is optional LotInfo with { briefly "Lot" described by "Lot information." }
    stockLevel is StockLevel with { briefly "Level" described by "Current stock level." }
    status is InventoryStatus with { briefly "Status" described by "Inventory status." }
    reservations is many optional ReservationInfo with { briefly "Reservations" described by "Active reservations." }
    movements is many optional StockMovement with { briefly "Movements" described by "Recent movements." }
    initializedAt is TimeStamp with { briefly "Initialized" described by "Initialization time." }
  } with {
    briefly "Active state"
    described by "State for active inventory."
  }

  // States
  state ActiveState of Inventory.ActiveStateData with {
    briefly "Inventory active"
    described by "Inventory is being tracked."
  }

  // Handler
  handler InventoryHandler is {
    on command InitializeInventory {
      morph entity InventoryContext.Inventory to state InventoryContext.Inventory.ActiveState with command InitializeInventory
      tell event InventoryInitialized to entity InventoryContext.Inventory
    }

    on command ReceiveStock {
      tell event StockReceived to entity InventoryContext.Inventory
    }

    on command ReserveStock {
      tell event StockReserved to entity InventoryContext.Inventory
    }

    on command ReleaseReservation {
      tell event ReservationReleased to entity InventoryContext.Inventory
    }

    on command AllocateStock {
      tell event StockAllocated to entity InventoryContext.Inventory
    }

    on command PickStock {
      tell event StockPicked to entity InventoryContext.Inventory
    }

    on command TransferStock {
      tell event StockTransferred to entity InventoryContext.Inventory
    }

    on command AdjustStock {
      tell event StockAdjusted to entity InventoryContext.Inventory
    }

    on command CycleCount {
      tell event CycleCountRecorded to entity InventoryContext.Inventory
    }

    on command RequestReplenishment {
      tell event ReplenishmentRequested to entity InventoryContext.Inventory
    }
  } with {
    briefly "Processes inventory commands"
    described by {
      | Handles inventory lifecycle from receiving
      | through picking, transfers, and adjustments.
    }
  }

} with {
  briefly "Inventory aggregate"
  described by {
    | The Inventory entity manages warehouse inventory
    | tracking and stock level management.
  }
}
