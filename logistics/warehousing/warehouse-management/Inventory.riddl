// Inventory Entity - Manages inventory items at specific warehouse locations

entity Inventory is {

  // Commands
  command ReceiveInventory is {
    inventoryId: InventoryId,
    productId: ProductId,
    locationId: LocationId,
    quantity: Integer,
    unitOfMeasure: UnitOfMeasure,
    lotNumber: String(0, 50),
    expirationDate: Date?,
    shipmentId: ShipmentId,
    receivedBy: String(1, 100)
  } with {
    briefly "Receive new inventory into the warehouse"
    described by "Records the receipt of inventory from an inbound shipment into a specific location."
  }

  command AdjustInventory is {
    inventoryId: InventoryId,
    adjustmentQuantity: Integer,
    reason: String(1, 500),
    adjustedBy: String(1, 100)
  } with {
    briefly "Adjust inventory quantity"
    described by "Adjusts inventory quantity up or down to correct discrepancies found during counts."
  }

  command ReserveInventory is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50)
  } with {
    briefly "Reserve inventory for an order"
    described by "Reserves a quantity of inventory for a specific customer order, making it unavailable for other orders."
  }

  command ReleaseReservation is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50)
  } with {
    briefly "Release previously reserved inventory"
    described by "Releases reserved inventory back to available status when an order is cancelled or modified."
  }

  command TransferInventory is {
    inventoryId: InventoryId,
    fromLocationId: LocationId,
    toLocationId: LocationId,
    quantity: Integer,
    transferredBy: String(1, 100)
  } with {
    briefly "Transfer inventory between locations"
    described by "Moves inventory from one warehouse location to another for optimization or picking preparation."
  }

  command UpdateLocation is {
    inventoryId: InventoryId,
    newLocationId: LocationId,
    movedBy: String(1, 100)
  } with {
    briefly "Update the storage location of inventory"
    described by "Changes the recorded location of inventory after physical movement within the warehouse."
  }

  command ShipInventory is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50),
    shipmentId: ShipmentId,
    shippedBy: String(1, 100)
  } with {
    briefly "Ship inventory out of the warehouse"
    described by "Records the shipment of inventory out of the warehouse to fulfill a customer order."
  }

  command QuarantineInventory is {
    inventoryId: InventoryId,
    reason: String(1, 500),
    quarantinedBy: String(1, 100)
  } with {
    briefly "Place inventory in quarantine status"
    described by "Moves inventory to quarantine status for quality inspection or investigation."
  }

  command ReleaseFromQuarantine is {
    inventoryId: InventoryId,
    disposition: InventoryStatus,
    releasedBy: String(1, 100),
    notes: String(0, 500)
  } with {
    briefly "Release inventory from quarantine"
    described by "Releases inventory from quarantine, setting it to available, damaged, or other appropriate status."
  }

  // Events
  event InventoryReceived is {
    inventoryId: InventoryId,
    productId: ProductId,
    locationId: LocationId,
    quantity: Integer,
    unitOfMeasure: UnitOfMeasure,
    lotNumber: String(0, 50),
    expirationDate: Date?,
    shipmentId: ShipmentId,
    receivedBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was received into warehouse"
    described by "Indicates that new inventory has been received and recorded at a specific location."
  }

  event InventoryAdjusted is {
    inventoryId: InventoryId,
    previousQuantity: Integer,
    newQuantity: Integer,
    adjustmentQuantity: Integer,
    reason: String(1, 500),
    adjustedBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory quantity was adjusted"
    described by "Records an inventory adjustment with the before and after quantities and reason."
  }

  event InventoryReserved is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was reserved for an order"
    described by "Indicates that inventory has been reserved and is no longer available for other orders."
  }

  event ReservationReleased is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50),
    timestamp: TimeStamp
  } with {
    briefly "Inventory reservation was released"
    described by "Indicates that previously reserved inventory has been released back to available status."
  }


  event InventoryTransferred is {
    inventoryId: InventoryId,
    fromLocationId: LocationId,
    toLocationId: LocationId,
    quantity: Integer,
    transferredBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was transferred between locations"
    described by "Records the movement of inventory from one location to another within the warehouse."
  }

  event LocationUpdated is {
    inventoryId: InventoryId,
    previousLocationId: LocationId,
    newLocationId: LocationId,
    movedBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory location was updated"
    described by "Records a change in the storage location of an inventory record."
  }

  event InventoryShipped is {
    inventoryId: InventoryId,
    quantity: Integer,
    orderId: String(1, 50),
    shipmentId: ShipmentId,
    shippedBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was shipped from warehouse"
    described by "Indicates that inventory has left the warehouse as part of an outbound shipment."
  }

  event InventoryQuarantined is {
    inventoryId: InventoryId,
    reason: String(1, 500),
    quarantinedBy: String(1, 100),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was placed in quarantine"
    described by "Records that inventory has been placed in quarantine status for quality review."
  }

  event InventoryReleasedFromQuarantine is {
    inventoryId: InventoryId,
    disposition: InventoryStatus,
    releasedBy: String(1, 100),
    notes: String(0, 500),
    timestamp: TimeStamp
  } with {
    briefly "Inventory was released from quarantine"
    described by "Records the release of inventory from quarantine with its resulting status."
  }

  // State records
  record EmptyInventoryStateData is {
    inventoryId: InventoryId,
    createdAt: TimeStamp
  } with {
    briefly "Data for empty inventory state"
    described by "Minimal data for an inventory record awaiting its first receipt."
  }

  record ActiveInventoryStateData is {
    inventoryId: InventoryId,
    productId: ProductId,
    locationId: LocationId,
    quantity: Integer,
    reservedQuantity: Integer,
    unitOfMeasure: UnitOfMeasure,
    status: InventoryStatus,
    lotNumber: String(0, 50),
    expirationDate: Date?,
    lastUpdated: TimeStamp
  } with {
    briefly "Data for active inventory state"
    described by "Complete inventory record data for active inventory operations."
  }

  record QuarantineInventoryStateData is {
    inventoryId: InventoryId,
    productId: ProductId,
    locationId: LocationId,
    quantity: Integer,
    unitOfMeasure: UnitOfMeasure,
    quarantineReason: String(1, 500),
    quarantinedAt: TimeStamp,
    quarantinedBy: String(1, 100)
  } with {
    briefly "Data for quarantined inventory state"
    described by "Inventory record data including quarantine-specific information."
  }

  // States
  state EmptyInventoryState of Inventory.EmptyInventoryStateData with {
    briefly "State when no inventory exists at this location"
    described by "Represents an inventory record that has been created but has no quantity yet."
  }

  state ActiveInventoryState of Inventory.ActiveInventoryStateData with {
    briefly "State when inventory is actively managed"
    described by "Represents inventory that is available for normal warehouse operations."
  }

  state QuarantineInventoryState of Inventory.QuarantineInventoryStateData with {
    briefly "State when inventory is held in quarantine"
    described by "Represents inventory that is being held for quality inspection or investigation."
  }

  // Handler
  handler InventoryHandler is {
    on command ReceiveInventory {
      morph entity WarehouseContext.Inventory to state WarehouseContext.Inventory.ActiveInventoryState with command ReceiveInventory
      tell event InventoryReceived to entity WarehouseContext.Inventory
    }

    on command AdjustInventory {
      tell event InventoryAdjusted to entity WarehouseContext.Inventory
    }

    on command ReserveInventory {
      tell event InventoryReserved to entity WarehouseContext.Inventory
    }

    on command ReleaseReservation {
      tell event ReservationReleased to entity WarehouseContext.Inventory
    }

    on command TransferInventory {
      tell event InventoryTransferred to entity WarehouseContext.Inventory
    }

    on command UpdateLocation {
      tell event LocationUpdated to entity WarehouseContext.Inventory
    }

    on command ShipInventory {
      tell event InventoryShipped to entity WarehouseContext.Inventory
    }

    on command QuarantineInventory {
      morph entity WarehouseContext.Inventory to state WarehouseContext.Inventory.QuarantineInventoryState with command QuarantineInventory
      tell event InventoryQuarantined to entity WarehouseContext.Inventory
    }

    on command ReleaseFromQuarantine {
      morph entity WarehouseContext.Inventory to state WarehouseContext.Inventory.ActiveInventoryState with command ReleaseFromQuarantine
      tell event InventoryReleasedFromQuarantine to entity WarehouseContext.Inventory
    }
  } with {
    briefly "Processes inventory commands"
    described by {
      | Handles all inventory lifecycle commands including receiving,
      | adjustments, reservations, transfers, and quarantine management.
    }
  }

} with {
  option is event-sourced
  option is aggregate
  briefly "Manages inventory items at warehouse locations"
  described by {
    | The Inventory entity is the core aggregate for warehouse inventory management.
    | It tracks quantities, locations, and status of inventory items using event
    | sourcing to maintain a complete audit trail of all inventory movements and
    | changes. The entity supports reservation for orders, transfers between
    | locations, and quarantine handling for quality management.
  }
}
