// Inventory Control - InventoryItem Entity
entity InventoryItem is {
  command CreateInventoryItem is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |New item identifier.
      }
    }
    itemInfo: InventoryItemInfo with {
      briefly "Item info"
      described as {
        |Inventory item details.
      }
    }
    initialQty: Natural with {
      briefly "Initial qty"
      described as {
        |Initial quantity on hand.
      }
    }
  } with {
    briefly "Create inventory item"
    described as {
      |Creates a new inventory item record.
    }
  }
  command AdjustQuantity is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    newQty: Natural with {
      briefly "New quantity"
      described as {
        |New quantity value.
      }
    }
    reason: AdjustmentReason with {
      briefly "Reason"
      described as {
        |Adjustment reason.
      }
    }
    adjustedBy: String(1,100) with {
      briefly "Adjusted by"
      described as {
        |Person making adjustment.
      }
    }
    notes: String(1,500)? with {
      briefly "Notes"
      described as {
        |Adjustment notes.
      }
    }
  } with {
    briefly "Adjust quantity"
    described as {
      |Adjusts inventory quantity.
    }
  }
  command ReserveStock is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity to reserve.
      }
    }
    orderId: String(1,50) with {
      briefly "Order ID"
      described as {
        |Order requiring reservation.
      }
    }
  } with {
    briefly "Reserve stock"
    described as {
      |Reserves inventory for an order.
    }
  }
  command ReleaseReservation is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity to release.
      }
    }
    orderId: String(1,50) with {
      briefly "Order ID"
      described as {
        |Order releasing reservation.
      }
    }
  } with {
    briefly "Release reservation"
    described as {
      |Releases reserved inventory.
    }
  }
  command RecordCycleCount is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    countSessionId: CountSessionId with {
      briefly "Session"
      described as {
        |Count session identifier.
      }
    }
    countResult: CountResult with {
      briefly "Result"
      described as {
        |Count result.
      }
    }
  } with {
    briefly "Record cycle count"
    described as {
      |Records a cycle count result.
    }
  }
  command RelocateItem is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    newBinLocation: BinLocation with {
      briefly "New location"
      described as {
        |New bin location.
      }
    }
    movedBy: String(1,100) with {
      briefly "Moved by"
      described as {
        |Person relocating item.
      }
    }
  } with {
    briefly "Relocate item"
    described as {
      |Moves item to a new bin location.
    }
  }
  command TriggerReplenishment is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity to replenish.
      }
    }
    priority: ReplenishmentPriority with {
      briefly "Priority"
      described as {
        |Replenishment priority.
      }
    }
  } with {
    briefly "Trigger replenishment"
    described as {
      |Triggers replenishment request.
    }
  }
  command QuarantineStock is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    quantity: Natural with {
      briefly "Quantity"
      described as {
        |Quantity to quarantine.
      }
    }
    quarantineReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Quarantine reason.
      }
    }
  } with {
    briefly "Quarantine stock"
    described as {
      |Places stock in quarantine.
    }
  }
  command DeactivateItem is  {
    itemId: InventoryItemId with {
      briefly "Item ID"
      described as {
        |Item identifier.
      }
    }
    deactivationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
  } with {
    briefly "Deactivate item"
    described as {
      |Deactivates an inventory item.
    }
  }
  // Events
  event InventoryItemCreated is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    itemInfo: InventoryItemInfo with {
      briefly "Info"
      described as {
        |Item info.
      }
    }
    initialQty: Natural with {
      briefly "Qty"
      described as {
        |Initial quantity.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Inventory item created"
    described as {
      |Emitted when inventory item is created.
    }
  }
  event QuantityAdjusted is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    adjustment: AdjustmentRecord with {
      briefly "Adjustment"
      described as {
        |Adjustment details.
      }
    }
    adjustedAt: TimeStamp with {
      briefly "Adjusted"
      described as {
        |Adjustment time.
      }
    }
  } with {
    briefly "Quantity adjusted"
    described as {
      |Emitted when quantity is adjusted.
    }
  }
  event StockReserved is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    quantity: Natural with {
      briefly "Qty"
      described as {
        |Reserved quantity.
      }
    }
    orderId: String(1,50) with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reservedAt: TimeStamp with {
      briefly "Reserved"
      described as {
        |Reservation time.
      }
    }
  } with {
    briefly "Stock reserved"
    described as {
      |Emitted when stock is reserved.
    }
  }
  event ReservationReleased is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    quantity: Natural with {
      briefly "Qty"
      described as {
        |Released quantity.
      }
    }
    orderId: String(1,50) with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    releasedAt: TimeStamp with {
      briefly "Released"
      described as {
        |Release time.
      }
    }
  } with {
    briefly "Reservation released"
    described as {
      |Emitted when reservation is released.
    }
  }
  event CycleCountRecorded is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    countResult: CountResult with {
      briefly "Result"
      described as {
        |Count result.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Cycle count recorded"
    described as {
      |Emitted when cycle count is recorded.
    }
  }
  event ItemRelocated is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    oldBinLocation: BinLocation with {
      briefly "Old location"
      described as {
        |Previous location.
      }
    }
    newBinLocation: BinLocation with {
      briefly "New location"
      described as {
        |New location.
      }
    }
    relocatedAt: TimeStamp with {
      briefly "Relocated"
      described as {
        |Relocation time.
      }
    }
  } with {
    briefly "Item relocated"
    described as {
      |Emitted when item is relocated.
    }
  }
  event ReplenishmentTriggered is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    quantity: Natural with {
      briefly "Qty"
      described as {
        |Replenishment quantity.
      }
    }
    priority: ReplenishmentPriority with {
      briefly "Priority"
      described as {
        |Priority level.
      }
    }
    triggeredAt: TimeStamp with {
      briefly "Triggered"
      described as {
        |Trigger time.
      }
    }
  } with {
    briefly "Replenishment triggered"
    described as {
      |Emitted when replenishment is triggered.
    }
  }
  event StockQuarantined is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    quantity: Natural with {
      briefly "Qty"
      described as {
        |Quarantined quantity.
      }
    }
    quarantineReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Quarantine reason.
      }
    }
    quarantinedAt: TimeStamp with {
      briefly "Quarantined"
      described as {
        |Quarantine time.
      }
    }
  } with {
    briefly "Stock quarantined"
    described as {
      |Emitted when stock is quarantined.
    }
  }
  event ItemDeactivated is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    deactivationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
    deactivatedAt: TimeStamp with {
      briefly "Deactivated"
      described as {
        |Deactivation time.
      }
    }
  } with {
    briefly "Item deactivated"
    described as {
      |Emitted when item is deactivated.
    }
  }
  // States
  record ActiveItemData is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    itemInfo: InventoryItemInfo with {
      briefly "Info"
      described as {
        |Item info.
      }
    }
    quantities: QuantityOnHand with {
      briefly "Quantities"
      described as {
        |Quantity breakdown.
      }
    }
    status: ItemStatus with {
      briefly "Status"
      described as {
        |Item status.
      }
    }
    adjustments: AdjustmentRecord* with {
      briefly "Adjustments"
      described as {
        |Adjustment history.
      }
    }
    lastCountedAt: TimeStamp? with {
      briefly "Last counted"
      described as {
        |Last count time.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active item state"
    described as {
      |State for an active inventory item.
    }
  }
  record InactiveItemData is  {
    itemId: InventoryItemId with {
      briefly "Item"
      described as {
        |Item ID.
      }
    }
    deactivationReason: String(1,500) with {
      briefly "Reason"
      described as {
        |Deactivation reason.
      }
    }
    deactivatedAt: TimeStamp with {
      briefly "Deactivated"
      described as {
        |Deactivation time.
      }
    }
  } with {
    briefly "Inactive item state"
    described as {
      |State for a deactivated inventory item.
    }
  }
  state ActiveItem of type InventoryItem.ActiveItemData
  state InactiveItem of type InventoryItem.InactiveItemData
  handler InventoryItemHandler is {
    on command CreateInventoryItem is {
      morph entity InventoryControlContext.InventoryItem to state InventoryControlContext.InventoryItem.ActiveItem with command CreateInventoryItem
      tell event InventoryItemCreated to entity InventoryControlContext.InventoryItem
    }
    on command AdjustQuantity is {
      tell event QuantityAdjusted to entity InventoryControlContext.InventoryItem
    }
    on command ReserveStock is {
      tell event StockReserved to entity InventoryControlContext.InventoryItem
    }
    on command ReleaseReservation is {
      tell event ReservationReleased to entity InventoryControlContext.InventoryItem
    }
    on command RecordCycleCount is {
      tell event CycleCountRecorded to entity InventoryControlContext.InventoryItem
    }
    on command RelocateItem is {
      tell event ItemRelocated to entity InventoryControlContext.InventoryItem
    }
    on command TriggerReplenishment is {
      tell event ReplenishmentTriggered to entity InventoryControlContext.InventoryItem
    }
    on command QuarantineStock is {
      tell event StockQuarantined to entity InventoryControlContext.InventoryItem
    }
    on command DeactivateItem is {
      morph entity InventoryControlContext.InventoryItem to state InventoryControlContext.InventoryItem.InactiveItem with command DeactivateItem
      tell event ItemDeactivated to entity InventoryControlContext.InventoryItem
    }
  } with {
    briefly "Processes inventory item commands"
    described as {
      |Handles inventory item lifecycle.
    }
  }
} with {
  briefly "InventoryItem aggregate"
  described as {
    |Manages warehouse inventory items.
  }
}
