// Last Mile Delivery - Delivery Context
context DeliveryContext is {
  include "types.riddl"
  include "Delivery.riddl"
  repository DeliveryRepository is {
    schema DeliveryData is relational
      of deliveries as type Delivery
        index on field Delivery.packageInfo.trackingNumber
        index on field Delivery.status
        index on field Delivery.routeId
        index on field Delivery.address.postalCode

    handler DeliveryPersistence is {
      on command Delivery.CreateDelivery is {
        prompt "Store new delivery record"
      }
      on command Delivery.AssignToRoute is {
        prompt "Update route assignment"
      }
      on command Delivery.MarkOutForDelivery is {
        prompt "Update delivery status"
      }
      on command Delivery.UpdateETA is {
        prompt "Update estimated arrival"
      }
      on command Delivery.AttemptDelivery is {
        prompt "Store delivery attempt"
      }
      on command Delivery.CompleteDelivery is {
        prompt "Store proof of delivery"
      }
      on command Delivery.FailDelivery is {
        prompt "Update to failed status"
      }
      on command Delivery.RescheduleDelivery is {
        prompt "Update delivery schedule"
      }
    } with {
      briefly "Persists delivery commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Delivery data persistence"
    described as {
      |Persistent storage for deliveries.
    }
  }
  projector DeliveryAnalytics is {
    record DailyMetrics is  {
      totalDeliveries: Natural with {
        briefly "Total"
        described as {
          |Total deliveries.
        }
      }
      completed: Natural with {
        briefly "Completed"
        described as {
          |Completed.
        }
      }
      failed: Natural with {
        briefly "Failed"
        described as {
          |Failed.
        }
      }
      onTimeRate: Decimal(5,2) with {
        briefly "On-time"
        described as {
          |On-time rate.
        }
      }
      averageAttemptsPerDelivery: Decimal(3,2) with {
        briefly "Attempts"
        described as {
          |Avg attempts.
        }
      }
      firstAttemptSuccessRate: Decimal(5,2) with {
        briefly "First attempt"
        described as {
          |First attempt success.
        }
      }
    } with {
      briefly "Daily metrics"
      described as {
        |Daily delivery metrics.
      }
    }
    handler AnalyticsHandler is {
      on event Delivery.DeliveryCreated is {
        prompt "Increment delivery count"
      }
      on event Delivery.DeliveryCompleted is {
        prompt "Update completion metrics"
      }
      on event Delivery.DeliveryFailed is {
        prompt "Update failure metrics"
      }
      on event Delivery.DeliveryAttempted is {
        prompt "Track attempt statistics"
      }
    } with {
      briefly "Maintains delivery analytics"
      described as {
        |Projects events into metrics.
      }
    }
  } with {
    briefly "Delivery analytics"
    described as {
      |Delivery performance tracking.
    }
  }
} with {
  briefly "Bounded context for last mile delivery"
  described as {
    |Final delivery operations context.
  }
}
