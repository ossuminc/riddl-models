// Last Mile Delivery - Delivery Context

context DeliveryContext is {

  include "types.riddl"
  include "Delivery.riddl"

  repository DeliveryRepository is {
    schema DeliveryData is relational
      of deliveries as Delivery
      index on field Delivery.packageInfo.trackingNumber
      index on field Delivery.status
      index on field Delivery.routeId
      index on field Delivery.address.postalCode

    handler DeliveryPersistence is {
      on event Delivery.DeliveryCreated {
        prompt "Store new delivery record"
      }
      on event Delivery.AssignedToRoute {
        prompt "Update route assignment"
      }
      on event Delivery.MarkedOutForDelivery {
        prompt "Update delivery status"
      }
      on event Delivery.ETAUpdated {
        prompt "Update estimated arrival"
      }
      on event Delivery.DeliveryAttempted {
        prompt "Store delivery attempt"
      }
      on event Delivery.DeliveryCompleted {
        prompt "Store proof of delivery"
      }
      on event Delivery.DeliveryFailed {
        prompt "Update to failed status"
      }
      on event Delivery.DeliveryRescheduled {
        prompt "Update delivery schedule"
      }
    } with {
      briefly "Persists delivery events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Delivery data persistence"
    described by "Persistent storage for deliveries."
  }

  projector DeliveryAnalytics is {
    updates repository DeliveryRepository

    record DailyMetrics is {
      totalDeliveries is Natural with { briefly "Total" described by "Total deliveries." }
      completed is Natural with { briefly "Completed" described by "Completed." }
      failed is Natural with { briefly "Failed" described by "Failed." }
      onTimeRate is Decimal(5, 2) with { briefly "On-time" described by "On-time rate." }
      averageAttemptsPerDelivery is Decimal(3, 2) with { briefly "Attempts" described by "Avg attempts." }
      firstAttemptSuccessRate is Decimal(5, 2) with { briefly "First attempt" described by "First attempt success." }
    } with {
      briefly "Daily metrics"
      described by "Daily delivery metrics."
    }

    handler AnalyticsHandler is {
      on event Delivery.DeliveryCreated {
        prompt "Increment delivery count"
      }
      on event Delivery.DeliveryCompleted {
        prompt "Update completion metrics"
      }
      on event Delivery.DeliveryFailed {
        prompt "Update failure metrics"
      }
      on event Delivery.DeliveryAttempted {
        prompt "Track attempt statistics"
      }
    } with {
      briefly "Maintains delivery analytics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Delivery analytics"
    described by "Delivery performance tracking."
  }

} with {
  briefly "Bounded context for last mile delivery"
  described by "Final delivery operations context."
}
