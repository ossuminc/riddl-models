// Last Mile Delivery - Delivery Entity

entity Delivery is {

  command CreateDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "New delivery identifier."
    }
    packageInfo is PackageInfo with {
      briefly "Package"
      described by "Package details."
    }
    customer is CustomerInfo with {
      briefly "Customer"
      described by "Customer info."
    }
    address is Address with {
      briefly "Address"
      described by "Delivery address."
    }
    deliveryType is DeliveryType with {
      briefly "Type"
      described by "Delivery type."
    }
    priority is DeliveryPriority with {
      briefly "Priority"
      described by "Delivery priority."
    }
    requestedWindow is optional TimeWindow with {
      briefly "Window"
      described by "Requested delivery window."
    }
  } with {
    briefly "Create delivery"
    described by "Creates a new delivery."
  }

  command AssignToRoute is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    routeId is RouteId with {
      briefly "Route"
      described by "Route to assign to."
    }
    driver is DriverInfo with {
      briefly "Driver"
      described by "Assigned driver."
    }
    stopNumber is Natural with {
      briefly "Stop"
      described by "Stop number on route."
    }
    estimatedArrival is TimeStamp with {
      briefly "ETA"
      described by "Estimated arrival."
    }
  } with {
    briefly "Assign to route"
    described by "Assigns delivery to route."
  }

  command MarkOutForDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    departedAt is TimeStamp with {
      briefly "Departed"
      described by "Departure time."
    }
  } with {
    briefly "Mark out for delivery"
    described by "Driver departed with package."
  }

  command UpdateETA is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    newETA is TimeStamp with {
      briefly "ETA"
      described by "Updated arrival estimate."
    }
    reason is optional String(1, 200) with {
      briefly "Reason"
      described by "Reason for change."
    }
  } with {
    briefly "Update ETA"
    described by "Updates estimated arrival."
  }

  command AttemptDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    attempt is DeliveryAttempt with {
      briefly "Attempt"
      described by "Attempt details."
    }
  } with {
    briefly "Attempt delivery"
    described by "Records delivery attempt."
  }

  command CompleteDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    proof is ProofOfDelivery with {
      briefly "Proof"
      described by "Proof of delivery."
    }
  } with {
    briefly "Complete delivery"
    described by "Marks delivery as complete."
  }

  command FailDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Failure reason."
    }
    action is String(1, 50) with {
      briefly "Action"
      described by "Next action (retry, return)."
    }
  } with {
    briefly "Fail delivery"
    described by "Marks delivery as failed."
  }

  command RescheduleDelivery is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    newWindow is TimeWindow with {
      briefly "Window"
      described by "New delivery window."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Reschedule reason."
    }
  } with {
    briefly "Reschedule delivery"
    described by "Reschedules for later attempt."
  }

  command ReturnToSender is {
    deliveryId is DeliveryId with {
      briefly "Delivery ID"
      described by "Delivery identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Return reason."
    }
  } with {
    briefly "Return to sender"
    described by "Initiates return to sender."
  }

  // Events
  event DeliveryCreated is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    packageInfo is PackageInfo with { briefly "Package" described by "Package info." }
    address is Address with { briefly "Address" described by "Address." }
    priority is DeliveryPriority with { briefly "Priority" described by "Priority." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Delivery created"
    described by "Emitted when delivery created."
  }

  event AssignedToRoute is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    routeId is RouteId with { briefly "Route" described by "Route ID." }
    driver is DriverInfo with { briefly "Driver" described by "Driver info." }
    stopNumber is Natural with { briefly "Stop" described by "Stop number." }
    estimatedArrival is TimeStamp with { briefly "ETA" described by "ETA." }
    assignedAt is TimeStamp with { briefly "Assigned" described by "Assignment time." }
  } with {
    briefly "Assigned to route"
    described by "Emitted when assigned."
  }

  event MarkedOutForDelivery is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    departedAt is TimeStamp with { briefly "Departed" described by "Departure time." }
  } with {
    briefly "Out for delivery"
    described by "Emitted when driver departed."
  }

  event ETAUpdated is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    newETA is TimeStamp with { briefly "ETA" described by "New ETA." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "ETA updated"
    described by "Emitted when ETA changes."
  }

  event DeliveryAttempted is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    attempt is DeliveryAttempt with { briefly "Attempt" described by "Attempt info." }
  } with {
    briefly "Delivery attempted"
    described by "Emitted when attempt made."
  }

  event DeliveryCompleted is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    proof is ProofOfDelivery with { briefly "Proof" described by "POD." }
  } with {
    briefly "Delivery completed"
    described by "Emitted when delivered."
  }

  event DeliveryFailed is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Reason." }
    action is String(1, 50) with { briefly "Action" described by "Next action." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Delivery failed"
    described by "Emitted when delivery fails."
  }

  event DeliveryRescheduled is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    newWindow is TimeWindow with { briefly "Window" described by "New window." }
    rescheduledAt is TimeStamp with { briefly "Rescheduled" described by "Time." }
  } with {
    briefly "Delivery rescheduled"
    described by "Emitted when rescheduled."
  }

  event ReturnInitiated is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Return reason." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Time." }
  } with {
    briefly "Return initiated"
    described by "Emitted when return started."
  }

  // States
  record ActiveStateData is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    packageInfo is PackageInfo with { briefly "Package" described by "Package." }
    customer is CustomerInfo with { briefly "Customer" described by "Customer." }
    address is Address with { briefly "Address" described by "Address." }
    location is optional GeoLocation with { briefly "Location" described by "Geocoded address." }
    deliveryType is DeliveryType with { briefly "Type" described by "Delivery type." }
    priority is DeliveryPriority with { briefly "Priority" described by "Priority." }
    status is DeliveryStatus with { briefly "Status" described by "Status." }
    routeId is optional RouteId with { briefly "Route" described by "Assigned route." }
    driver is optional DriverInfo with { briefly "Driver" described by "Assigned driver." }
    stopNumber is optional Natural with { briefly "Stop" described by "Stop number." }
    estimatedArrival is optional TimeStamp with { briefly "ETA" described by "ETA." }
    requestedWindow is optional TimeWindow with { briefly "Window" described by "Requested window." }
    attempts is many optional DeliveryAttempt with { briefly "Attempts" described by "Attempts." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active delivery state"
    described by "In-progress delivery data."
  }

  record CompletedStateData is {
    deliveryId is DeliveryId with { briefly "Delivery" described by "Delivery ID." }
    packageId is String(1, 50) with { briefly "Package" described by "Package ID." }
    proof is ProofOfDelivery with { briefly "Proof" described by "POD." }
  } with {
    briefly "Completed state"
    described by "Completed delivery data."
  }

  state ActiveState of Delivery.ActiveStateData with {
    briefly "Delivery active"
    described by "Delivery is in progress."
  }

  state CompletedState of Delivery.CompletedStateData with {
    briefly "Delivery completed"
    described by "Delivery has been completed."
  }

  handler DeliveryHandler is {
    on command CreateDelivery {
      morph entity DeliveryContext.Delivery to state DeliveryContext.Delivery.ActiveState with command CreateDelivery
      tell event DeliveryCreated to entity DeliveryContext.Delivery
    }
    on command AssignToRoute {
      tell event AssignedToRoute to entity DeliveryContext.Delivery
    }
    on command MarkOutForDelivery {
      tell event MarkedOutForDelivery to entity DeliveryContext.Delivery
    }
    on command UpdateETA {
      tell event ETAUpdated to entity DeliveryContext.Delivery
    }
    on command AttemptDelivery {
      tell event DeliveryAttempted to entity DeliveryContext.Delivery
    }
    on command CompleteDelivery {
      morph entity DeliveryContext.Delivery to state DeliveryContext.Delivery.CompletedState with command CompleteDelivery
      tell event DeliveryCompleted to entity DeliveryContext.Delivery
    }
    on command FailDelivery {
      tell event DeliveryFailed to entity DeliveryContext.Delivery
    }
    on command RescheduleDelivery {
      tell event DeliveryRescheduled to entity DeliveryContext.Delivery
    }
    on command ReturnToSender {
      tell event ReturnInitiated to entity DeliveryContext.Delivery
    }
  } with {
    briefly "Processes delivery commands"
    described by "Handles delivery lifecycle."
  }

} with {
  briefly "Delivery aggregate"
  described by "Manages last mile deliveries."
}
