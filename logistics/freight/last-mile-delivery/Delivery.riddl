// Last Mile Delivery - Delivery Entity
entity Delivery is {
  command CreateDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |New delivery identifier.
      }
    }
    packageInfo: PackageInfo with {
      briefly "Package"
      described as {
        |Package details.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer info.
      }
    }
    address: Address with {
      briefly "Address"
      described as {
        |Delivery address.
      }
    }
    deliveryType: DeliveryType with {
      briefly "Type"
      described as {
        |Delivery type.
      }
    }
    priority: DeliveryPriority with {
      briefly "Priority"
      described as {
        |Delivery priority.
      }
    }
    requestedWindow: TimeWindow? with {
      briefly "Window"
      described as {
        |Requested delivery window.
      }
    }
  } with {
    briefly "Create delivery"
    described as {
      |Creates a new delivery.
    }
  }
  command AssignToRoute is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    routeId: RouteId with {
      briefly "Route"
      described as {
        |Route to assign to.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    stopNumber: Natural with {
      briefly "Stop"
      described as {
        |Stop number on route.
      }
    }
    estimatedArrival: TimeStamp with {
      briefly "ETA"
      described as {
        |Estimated arrival.
      }
    }
  } with {
    briefly "Assign to route"
    described as {
      |Assigns delivery to route.
    }
  }
  command MarkOutForDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
  } with {
    briefly "Mark out for delivery"
    described as {
      |Driver departed with package.
    }
  }
  command UpdateETA is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    newETA: TimeStamp with {
      briefly "ETA"
      described as {
        |Updated arrival estimate.
      }
    }
    etaChangeReason: String(1,200)? with {
      briefly "Reason"
      described as {
        |Reason for change.
      }
    }
  } with {
    briefly "Update ETA"
    described as {
      |Updates estimated arrival.
    }
  }
  command AttemptDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    attempt: DeliveryAttempt with {
      briefly "Attempt"
      described as {
        |Attempt details.
      }
    }
  } with {
    briefly "Attempt delivery"
    described as {
      |Records delivery attempt.
    }
  }
  command CompleteDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    proof: ProofOfDelivery with {
      briefly "Proof"
      described as {
        |Proof of delivery.
      }
    }
  } with {
    briefly "Complete delivery"
    described as {
      |Marks delivery as complete.
    }
  }
  command FailDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    action: String(1,50) with {
      briefly "Action"
      described as {
        |Next action (retry, return).
      }
    }
  } with {
    briefly "Fail delivery"
    described as {
      |Marks delivery as failed.
    }
  }
  command RescheduleDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    newWindow: TimeWindow with {
      briefly "Window"
      described as {
        |New delivery window.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Reschedule reason.
      }
    }
  } with {
    briefly "Reschedule delivery"
    described as {
      |Reschedules for later attempt.
    }
  }
  command ReturnToSender is  {
    deliveryId: DeliveryId with {
      briefly "Delivery ID"
      described as {
        |Delivery identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
  } with {
    briefly "Return to sender"
    described as {
      |Initiates return to sender.
    }
  }
  // Events
  event DeliveryCreated is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    packageInfo: PackageInfo with {
      briefly "Package"
      described as {
        |Package info.
      }
    }
    address: Address with {
      briefly "Address"
      described as {
        |Address.
      }
    }
    priority: DeliveryPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Delivery created"
    described as {
      |Emitted when delivery created.
    }
  }
  event AssignedToRoute is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    routeId: RouteId with {
      briefly "Route"
      described as {
        |Route ID.
      }
    }
    driver: DriverInfo with {
      briefly "Driver"
      described as {
        |Driver info.
      }
    }
    stopNumber: Natural with {
      briefly "Stop"
      described as {
        |Stop number.
      }
    }
    estimatedArrival: TimeStamp with {
      briefly "ETA"
      described as {
        |ETA.
      }
    }
    assignedAt: TimeStamp with {
      briefly "Assigned"
      described as {
        |Assignment time.
      }
    }
  } with {
    briefly "Assigned to route"
    described as {
      |Emitted when assigned.
    }
  }
  event MarkedOutForDelivery is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    departedAt: TimeStamp with {
      briefly "Departed"
      described as {
        |Departure time.
      }
    }
  } with {
    briefly "Out for delivery"
    described as {
      |Emitted when driver departed.
    }
  }
  event ETAUpdated is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    newETA: TimeStamp with {
      briefly "ETA"
      described as {
        |New ETA.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "ETA updated"
    described as {
      |Emitted when ETA changes.
    }
  }
  event DeliveryAttempted is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    attempt: DeliveryAttempt with {
      briefly "Attempt"
      described as {
        |Attempt info.
      }
    }
  } with {
    briefly "Delivery attempted"
    described as {
      |Emitted when attempt made.
    }
  }
  event DeliveryCompleted is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    proof: ProofOfDelivery with {
      briefly "Proof"
      described as {
        |POD.
      }
    }
  } with {
    briefly "Delivery completed"
    described as {
      |Emitted when delivered.
    }
  }
  event DeliveryFailed is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Reason.
      }
    }
    action: String(1,50) with {
      briefly "Action"
      described as {
        |Next action.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Delivery failed"
    described as {
      |Emitted when delivery fails.
    }
  }
  event DeliveryRescheduled is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    newWindow: TimeWindow with {
      briefly "Window"
      described as {
        |New window.
      }
    }
    rescheduledAt: TimeStamp with {
      briefly "Rescheduled"
      described as {
        |Time.
      }
    }
  } with {
    briefly "Delivery rescheduled"
    described as {
      |Emitted when rescheduled.
    }
  }
  event ReturnInitiated is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Time.
      }
    }
  } with {
    briefly "Return initiated"
    described as {
      |Emitted when return started.
    }
  }
  // States
  record ActiveStateData is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    packageInfo: PackageInfo with {
      briefly "Package"
      described as {
        |Package.
      }
    }
    customer: CustomerInfo with {
      briefly "Customer"
      described as {
        |Customer.
      }
    }
    address: Address with {
      briefly "Address"
      described as {
        |Address.
      }
    }
    geocodedLocation: GeoLocation? with {
      briefly "Location"
      described as {
        |Geocoded address.
      }
    }
    deliveryType: DeliveryType with {
      briefly "Type"
      described as {
        |Delivery type.
      }
    }
    priority: DeliveryPriority with {
      briefly "Priority"
      described as {
        |Priority.
      }
    }
    status: DeliveryStatus with {
      briefly "Status"
      described as {
        |Status.
      }
    }
    assignedRouteId: RouteId? with {
      briefly "Route"
      described as {
        |Assigned route.
      }
    }
    assignedDriver: DriverInfo? with {
      briefly "Driver"
      described as {
        |Assigned driver.
      }
    }
    assignedStopNumber: Natural? with {
      briefly "Stop"
      described as {
        |Stop number.
      }
    }
    currentETA: TimeStamp? with {
      briefly "ETA"
      described as {
        |ETA.
      }
    }
    requestedWindow: TimeWindow? with {
      briefly "Window"
      described as {
        |Requested window.
      }
    }
    attempts: DeliveryAttempt* with {
      briefly "Attempts"
      described as {
        |Attempts.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active delivery state"
    described as {
      |In-progress delivery data.
    }
  }
  record CompletedStateData is  {
    deliveryId: DeliveryId with {
      briefly "Delivery"
      described as {
        |Delivery ID.
      }
    }
    packageId: String(1,50) with {
      briefly "Package"
      described as {
        |Package ID.
      }
    }
    proof: ProofOfDelivery with {
      briefly "Proof"
      described as {
        |POD.
      }
    }
  } with {
    briefly "Completed state"
    described as {
      |Completed delivery data.
    }
  }
  state ActiveState of type Delivery.ActiveStateData
  state CompletedState of type Delivery.CompletedStateData
  handler DeliveryHandler is {
    on command CreateDelivery is {
      morph entity DeliveryContext.Delivery to state DeliveryContext.Delivery.ActiveState with command CreateDelivery
      tell event DeliveryCreated to entity DeliveryContext.Delivery
    }
    on command AssignToRoute is {
      tell event AssignedToRoute to entity DeliveryContext.Delivery
    }
    on command MarkOutForDelivery is {
      tell event MarkedOutForDelivery to entity DeliveryContext.Delivery
    }
    on command UpdateETA is {
      tell event ETAUpdated to entity DeliveryContext.Delivery
    }
    on command AttemptDelivery is {
      tell event DeliveryAttempted to entity DeliveryContext.Delivery
    }
    on command CompleteDelivery is {
      morph entity DeliveryContext.Delivery to state DeliveryContext.Delivery.CompletedState with command CompleteDelivery
      tell event DeliveryCompleted to entity DeliveryContext.Delivery
    }
    on command FailDelivery is {
      tell event DeliveryFailed to entity DeliveryContext.Delivery
    }
    on command RescheduleDelivery is {
      tell event DeliveryRescheduled to entity DeliveryContext.Delivery
    }
    on command ReturnToSender is {
      tell event ReturnInitiated to entity DeliveryContext.Delivery
    }
  } with {
    briefly "Processes delivery commands"
    described as {
      |Handles delivery lifecycle.
    }
  }
} with {
  briefly "Delivery aggregate"
  described as {
    |Manages last mile deliveries.
  }
}
