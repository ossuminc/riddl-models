// Shipment Tracking - Tracking Context

context TrackingContext is {

  include "types.riddl"
  include "Shipment.riddl"

  repository ShipmentRepository is {
    schema ShipmentData is relational
      of shipments as Shipment
      index on field Shipment.trackingNumber
      index on field Shipment.status
      index on field Shipment.consignee.address.postalCode

    handler ShipmentPersistence is {
      on command Shipment.CreateShipment {
        prompt "Store new shipment record"
      }
      on command Shipment.RecordPickup {
        prompt "Update shipment with pickup"
      }
      on command Shipment.AddTrackingEvent {
        prompt "Append tracking event"
      }
      on command Shipment.UpdateLocation {
        prompt "Update current location"
      }
      on command Shipment.UpdateETA {
        prompt "Update delivery window"
      }
      on command Shipment.RecordDelivery {
        prompt "Store delivery confirmation"
      }
      on command Shipment.ReportException {
        prompt "Store exception details"
      }
    } with {
      briefly "Persists shipment commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Shipment data persistence"
    described by "Persistent storage for shipments."
  }

  projector ShipmentAnalytics is {
    updates repository ShipmentRepository

    record DeliveryMetrics is {
      totalShipments is Natural with { briefly "Total" described by "Total shipments." }
      inTransit is Natural with { briefly "In transit" described by "Currently in transit." }
      deliveredToday is Natural with { briefly "Delivered" described by "Delivered today." }
      onTimeRate is Decimal(5, 2) with { briefly "On-time" described by "On-time delivery rate." }
      averageTransitDays is Decimal(5, 2) with { briefly "Transit time" described by "Average transit days." }
      exceptionRate is Decimal(5, 2) with { briefly "Exceptions" described by "Exception rate." }
    } with {
      briefly "Delivery metrics"
      described by "Delivery performance metrics."
    }

    handler AnalyticsHandler is {
      on event Shipment.ShipmentCreated {
        prompt "Increment shipment count"
      }
      on event Shipment.DeliveryRecorded {
        prompt "Update delivery statistics"
      }
      on event Shipment.ExceptionReported {
        prompt "Update exception rate"
      }
    } with {
      briefly "Maintains delivery analytics"
      described by "Projects events into metrics."
    }
  } with {
    briefly "Shipment analytics"
    described by "Delivery performance tracking."
  }

} with {
  briefly "Bounded context for shipment tracking"
  described by "Freight visibility context."
}
