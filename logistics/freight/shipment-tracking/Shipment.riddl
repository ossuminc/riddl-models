// Shipment Tracking - Shipment Entity
entity Shipment is {
  command CreateShipment is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |New shipment identifier.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Public tracking number.
      }
    }
    shipper: PartyInfo with {
      briefly "Shipper"
      described as {
        |Origin party.
      }
    }
    consignee: PartyInfo with {
      briefly "Consignee"
      described as {
        |Destination party.
      }
    }
    packages: PackageInfo+ with {
      briefly "Packages"
      described as {
        |Package details.
      }
    }
    serviceLevel: ServiceLevel with {
      briefly "Service"
      described as {
        |Service level.
      }
    }
    transportMode: TransportMode with {
      briefly "Mode"
      described as {
        |Transport mode.
      }
    }
  } with {
    briefly "Create shipment"
    described as {
      |Books a new shipment.
    }
  }
  command RecordPickup is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    pickedUpAt: TimeStamp with {
      briefly "Picked up"
      described as {
        |Pickup time.
      }
    }
    location: String(1,200) with {
      briefly "Location"
      described as {
        |Pickup location.
      }
    }
  } with {
    briefly "Record pickup"
    described as {
      |Records shipment pickup.
    }
  }
  command AddTrackingEvent is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    event: TrackingEvent with {
      briefly "Event"
      described as {
        |Tracking event.
      }
    }
  } with {
    briefly "Add tracking event"
    described as {
      |Records tracking milestone.
    }
  }
  command UpdateLocation is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    location: String(1,200) with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    geoLocation: GeoLocation? with {
      briefly "Coordinates"
      described as {
        |GPS coordinates.
      }
    }
    timestamp: TimeStamp with {
      briefly "Time"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Update location"
    described as {
      |Updates current location.
    }
  }
  command UpdateETA is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    deliveryWindow: DeliveryWindow with {
      briefly "Window"
      described as {
        |New delivery window.
      }
    }
    etaChangeReason: String(1,200)? with {
      briefly "Reason"
      described as {
        |Reason for change.
      }
    }
  } with {
    briefly "Update ETA"
    described as {
      |Updates estimated delivery.
    }
  }
  command MarkOutForDelivery is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    vehicleId: String(1,50) with {
      briefly "Vehicle"
      described as {
        |Delivery vehicle.
      }
    }
    driverName: String(1,100) with {
      briefly "Driver"
      described as {
        |Driver name.
      }
    }
  } with {
    briefly "Mark out for delivery"
    described as {
      |Shipment loaded for final delivery.
    }
  }
  command RecordDelivery is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed by"
      described as {
        |Recipient signature.
      }
    }
    proofOfDelivery: URL? with {
      briefly "POD"
      described as {
        |Proof of delivery image.
      }
    }
  } with {
    briefly "Record delivery"
    described as {
      |Confirms delivery completion.
    }
  }
  command ReportException is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    exception: ExceptionInfo with {
      briefly "Exception"
      described as {
        |Exception details.
      }
    }
  } with {
    briefly "Report exception"
    described as {
      |Reports delivery exception.
    }
  }
  command ResolveException is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |How resolved.
      }
    }
    newStatus: ShipmentStatus with {
      briefly "Status"
      described as {
        |Status after resolution.
      }
    }
  } with {
    briefly "Resolve exception"
    described as {
      |Resolves delivery exception.
    }
  }
  command InitiateReturn is  {
    shipmentId: ShipmentId with {
      briefly "Shipment ID"
      described as {
        |Shipment identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
  } with {
    briefly "Initiate return"
    described as {
      |Starts return to sender.
    }
  }
  // Events
  event ShipmentCreated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    shipper: PartyInfo with {
      briefly "Shipper"
      described as {
        |Shipper info.
      }
    }
    consignee: PartyInfo with {
      briefly "Consignee"
      described as {
        |Consignee info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Shipment created"
    described as {
      |Emitted when shipment booked.
    }
  }
  event PickupRecorded is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    pickedUpAt: TimeStamp with {
      briefly "Picked up"
      described as {
        |Pickup time.
      }
    }
    location: String(1,200) with {
      briefly "Location"
      described as {
        |Pickup location.
      }
    }
  } with {
    briefly "Pickup recorded"
    described as {
      |Emitted when picked up.
    }
  }
  event TrackingEventAdded is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    event: TrackingEvent with {
      briefly "Event"
      described as {
        |Tracking event.
      }
    }
  } with {
    briefly "Tracking event added"
    described as {
      |Emitted when milestone recorded.
    }
  }
  event LocationUpdated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    location: String(1,200) with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    geoLocation: GeoLocation? with {
      briefly "Coordinates"
      described as {
        |GPS.
      }
    }
    timestamp: TimeStamp with {
      briefly "Time"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Location updated"
    described as {
      |Emitted when location changes.
    }
  }
  event ETAUpdated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    deliveryWindow: DeliveryWindow with {
      briefly "Window"
      described as {
        |Delivery window.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "ETA updated"
    described as {
      |Emitted when ETA changes.
    }
  }
  event MarkedOutForDelivery is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    vehicleId: String(1,50) with {
      briefly "Vehicle"
      described as {
        |Vehicle ID.
      }
    }
    driverName: String(1,100) with {
      briefly "Driver"
      described as {
        |Driver.
      }
    }
    timestamp: TimeStamp with {
      briefly "Time"
      described as {
        |Event time.
      }
    }
  } with {
    briefly "Out for delivery"
    described as {
      |Emitted when out for delivery.
    }
  }
  event DeliveryRecorded is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed"
      described as {
        |Signature.
      }
    }
  } with {
    briefly "Delivery recorded"
    described as {
      |Emitted when delivered.
    }
  }
  event ExceptionReported is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    exception: ExceptionInfo with {
      briefly "Exception"
      described as {
        |Exception info.
      }
    }
  } with {
    briefly "Exception reported"
    described as {
      |Emitted when exception occurs.
    }
  }
  event ExceptionResolved is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    resolution: String(1,500) with {
      briefly "Resolution"
      described as {
        |Resolution.
      }
    }
    newStatus: ShipmentStatus with {
      briefly "Status"
      described as {
        |New status.
      }
    }
    resolvedAt: TimeStamp with {
      briefly "Resolved"
      described as {
        |Resolution time.
      }
    }
  } with {
    briefly "Exception resolved"
    described as {
      |Emitted when exception resolved.
    }
  }
  event ReturnInitiated is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Return reason.
      }
    }
    initiatedAt: TimeStamp with {
      briefly "Initiated"
      described as {
        |Initiation time.
      }
    }
  } with {
    briefly "Return initiated"
    described as {
      |Emitted when return started.
    }
  }
  // States
  record InTransitStateData is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    shipper: PartyInfo with {
      briefly "Shipper"
      described as {
        |Shipper info.
      }
    }
    consignee: PartyInfo with {
      briefly "Consignee"
      described as {
        |Consignee info.
      }
    }
    packages: PackageInfo+ with {
      briefly "Packages"
      described as {
        |Packages.
      }
    }
    serviceLevel: ServiceLevel with {
      briefly "Service"
      described as {
        |Service level.
      }
    }
    transportMode: TransportMode with {
      briefly "Mode"
      described as {
        |Transport mode.
      }
    }
    status: ShipmentStatus with {
      briefly "Status"
      described as {
        |Current status.
      }
    }
    currentLocation: String(1,200)? with {
      briefly "Location"
      described as {
        |Current location.
      }
    }
    currentGeoLocation: GeoLocation? with {
      briefly "Coordinates"
      described as {
        |GPS.
      }
    }
    currentDeliveryWindow: DeliveryWindow? with {
      briefly "ETA"
      described as {
        |Delivery window.
      }
    }
    trackingHistory: TrackingEvent+ with {
      briefly "History"
      described as {
        |Tracking events.
      }
    }
    currentException: ExceptionInfo? with {
      briefly "Exception"
      described as {
        |Active exception.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "In transit state"
    described as {
      |Active shipment data.
    }
  }
  record DeliveredStateData is  {
    shipmentId: ShipmentId with {
      briefly "Shipment"
      described as {
        |Shipment ID.
      }
    }
    trackingNumber: TrackingNumber with {
      briefly "Tracking"
      described as {
        |Tracking number.
      }
    }
    deliveredAt: TimeStamp with {
      briefly "Delivered"
      described as {
        |Delivery time.
      }
    }
    signedBy: String(1,100)? with {
      briefly "Signed"
      described as {
        |Signature.
      }
    }
    proofOfDelivery: URL? with {
      briefly "POD"
      described as {
        |Proof of delivery.
      }
    }
  } with {
    briefly "Delivered state"
    described as {
      |Completed delivery data.
    }
  }
  state InTransitState of type Shipment.InTransitStateData
  state DeliveredState of type Shipment.DeliveredStateData
  handler ShipmentHandler is {
    on command CreateShipment is {
      morph entity TrackingContext.Shipment to state TrackingContext.Shipment.InTransitState with command CreateShipment
      tell event ShipmentCreated to entity TrackingContext.Shipment
    }
    on command RecordPickup is {
      tell event PickupRecorded to entity TrackingContext.Shipment
    }
    on command AddTrackingEvent is {
      tell event TrackingEventAdded to entity TrackingContext.Shipment
    }
    on command UpdateLocation is {
      tell event LocationUpdated to entity TrackingContext.Shipment
    }
    on command UpdateETA is {
      tell event ETAUpdated to entity TrackingContext.Shipment
    }
    on command MarkOutForDelivery is {
      tell event MarkedOutForDelivery to entity TrackingContext.Shipment
    }
    on command RecordDelivery is {
      morph entity TrackingContext.Shipment to state TrackingContext.Shipment.DeliveredState with command RecordDelivery
      tell event DeliveryRecorded to entity TrackingContext.Shipment
    }
    on command ReportException is {
      tell event ExceptionReported to entity TrackingContext.Shipment
    }
    on command ResolveException is {
      tell event ExceptionResolved to entity TrackingContext.Shipment
    }
    on command InitiateReturn is {
      tell event ReturnInitiated to entity TrackingContext.Shipment
    }
  } with {
    briefly "Processes shipment commands"
    described as {
      |Handles shipment lifecycle.
    }
  }
} with {
  briefly "Shipment aggregate"
  described as {
    |Tracks freight shipments.
  }
}
