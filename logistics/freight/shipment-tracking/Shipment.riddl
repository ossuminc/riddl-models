// Shipment Tracking - Shipment Entity

entity Shipment is {

  command CreateShipment is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "New shipment identifier."
    }
    trackingNumber is TrackingNumber with {
      briefly "Tracking"
      described by "Public tracking number."
    }
    shipper is PartyInfo with {
      briefly "Shipper"
      described by "Origin party."
    }
    consignee is PartyInfo with {
      briefly "Consignee"
      described by "Destination party."
    }
    packages is many PackageInfo with {
      briefly "Packages"
      described by "Package details."
    }
    serviceLevel is ServiceLevel with {
      briefly "Service"
      described by "Service level."
    }
    transportMode is TransportMode with {
      briefly "Mode"
      described by "Transport mode."
    }
  } with {
    briefly "Create shipment"
    described by "Books a new shipment."
  }

  command RecordPickup is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    pickedUpAt is TimeStamp with {
      briefly "Picked up"
      described by "Pickup time."
    }
    location is String(1, 200) with {
      briefly "Location"
      described by "Pickup location."
    }
  } with {
    briefly "Record pickup"
    described by "Records shipment pickup."
  }

  command AddTrackingEvent is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    event is TrackingEvent with {
      briefly "Event"
      described by "Tracking event."
    }
  } with {
    briefly "Add tracking event"
    described by "Records tracking milestone."
  }

  command UpdateLocation is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    location is String(1, 200) with {
      briefly "Location"
      described by "Current location."
    }
    geoLocation is optional GeoLocation with {
      briefly "Coordinates"
      described by "GPS coordinates."
    }
    timestamp is TimeStamp with {
      briefly "Time"
      described by "Update time."
    }
  } with {
    briefly "Update location"
    described by "Updates current location."
  }

  command UpdateETA is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    deliveryWindow is DeliveryWindow with {
      briefly "Window"
      described by "New delivery window."
    }
    reason is optional String(1, 200) with {
      briefly "Reason"
      described by "Reason for change."
    }
  } with {
    briefly "Update ETA"
    described by "Updates estimated delivery."
  }

  command MarkOutForDelivery is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    vehicleId is String(1, 50) with {
      briefly "Vehicle"
      described by "Delivery vehicle."
    }
    driverName is String(1, 100) with {
      briefly "Driver"
      described by "Driver name."
    }
  } with {
    briefly "Mark out for delivery"
    described by "Shipment loaded for final delivery."
  }

  command RecordDelivery is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    deliveredAt is TimeStamp with {
      briefly "Delivered"
      described by "Delivery time."
    }
    signedBy is optional String(1, 100) with {
      briefly "Signed by"
      described by "Recipient signature."
    }
    proofOfDelivery is optional URL with {
      briefly "POD"
      described by "Proof of delivery image."
    }
  } with {
    briefly "Record delivery"
    described by "Confirms delivery completion."
  }

  command ReportException is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    exception is ExceptionInfo with {
      briefly "Exception"
      described by "Exception details."
    }
  } with {
    briefly "Report exception"
    described by "Reports delivery exception."
  }

  command ResolveException is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    resolution is String(1, 500) with {
      briefly "Resolution"
      described by "How resolved."
    }
    newStatus is ShipmentStatus with {
      briefly "Status"
      described by "Status after resolution."
    }
  } with {
    briefly "Resolve exception"
    described by "Resolves delivery exception."
  }

  command InitiateReturn is {
    shipmentId is ShipmentId with {
      briefly "Shipment ID"
      described by "Shipment identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Return reason."
    }
  } with {
    briefly "Initiate return"
    described by "Starts return to sender."
  }

  // Events
  event ShipmentCreated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    shipper is PartyInfo with { briefly "Shipper" described by "Shipper info." }
    consignee is PartyInfo with { briefly "Consignee" described by "Consignee info." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Shipment created"
    described by "Emitted when shipment booked."
  }

  event PickupRecorded is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    pickedUpAt is TimeStamp with { briefly "Picked up" described by "Pickup time." }
    location is String(1, 200) with { briefly "Location" described by "Pickup location." }
  } with {
    briefly "Pickup recorded"
    described by "Emitted when picked up."
  }

  event TrackingEventAdded is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    event is TrackingEvent with { briefly "Event" described by "Tracking event." }
  } with {
    briefly "Tracking event added"
    described by "Emitted when milestone recorded."
  }

  event LocationUpdated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    location is String(1, 200) with { briefly "Location" described by "Current location." }
    geoLocation is optional GeoLocation with { briefly "Coordinates" described by "GPS." }
    timestamp is TimeStamp with { briefly "Time" described by "Update time." }
  } with {
    briefly "Location updated"
    described by "Emitted when location changes."
  }

  event ETAUpdated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    deliveryWindow is DeliveryWindow with { briefly "Window" described by "Delivery window." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "ETA updated"
    described by "Emitted when ETA changes."
  }

  event MarkedOutForDelivery is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    vehicleId is String(1, 50) with { briefly "Vehicle" described by "Vehicle ID." }
    driverName is String(1, 100) with { briefly "Driver" described by "Driver." }
    timestamp is TimeStamp with { briefly "Time" described by "Event time." }
  } with {
    briefly "Out for delivery"
    described by "Emitted when out for delivery."
  }

  event DeliveryRecorded is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    signedBy is optional String(1, 100) with { briefly "Signed" described by "Signature." }
  } with {
    briefly "Delivery recorded"
    described by "Emitted when delivered."
  }

  event ExceptionReported is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    exception is ExceptionInfo with { briefly "Exception" described by "Exception info." }
  } with {
    briefly "Exception reported"
    described by "Emitted when exception occurs."
  }

  event ExceptionResolved is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    resolution is String(1, 500) with { briefly "Resolution" described by "Resolution." }
    newStatus is ShipmentStatus with { briefly "Status" described by "New status." }
    resolvedAt is TimeStamp with { briefly "Resolved" described by "Resolution time." }
  } with {
    briefly "Exception resolved"
    described by "Emitted when exception resolved."
  }

  event ReturnInitiated is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Return reason." }
    initiatedAt is TimeStamp with { briefly "Initiated" described by "Initiation time." }
  } with {
    briefly "Return initiated"
    described by "Emitted when return started."
  }

  // States
  record InTransitStateData is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    shipper is PartyInfo with { briefly "Shipper" described by "Shipper info." }
    consignee is PartyInfo with { briefly "Consignee" described by "Consignee info." }
    packages is many PackageInfo with { briefly "Packages" described by "Packages." }
    serviceLevel is ServiceLevel with { briefly "Service" described by "Service level." }
    transportMode is TransportMode with { briefly "Mode" described by "Transport mode." }
    status is ShipmentStatus with { briefly "Status" described by "Current status." }
    currentLocation is optional String(1, 200) with { briefly "Location" described by "Current location." }
    currentGeoLocation is optional GeoLocation with { briefly "Coordinates" described by "GPS." }
    deliveryWindow is optional DeliveryWindow with { briefly "ETA" described by "Delivery window." }
    trackingHistory is many TrackingEvent with { briefly "History" described by "Tracking events." }
    currentException is optional ExceptionInfo with { briefly "Exception" described by "Active exception." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "In transit state"
    described by "Active shipment data."
  }

  record DeliveredStateData is {
    shipmentId is ShipmentId with { briefly "Shipment" described by "Shipment ID." }
    trackingNumber is TrackingNumber with { briefly "Tracking" described by "Tracking number." }
    deliveredAt is TimeStamp with { briefly "Delivered" described by "Delivery time." }
    signedBy is optional String(1, 100) with { briefly "Signed" described by "Signature." }
    proofOfDelivery is optional URL with { briefly "POD" described by "Proof of delivery." }
  } with {
    briefly "Delivered state"
    described by "Completed delivery data."
  }

  state InTransitState of Shipment.InTransitStateData with {
    briefly "Shipment in transit"
    described by "Shipment is being tracked."
  }

  state DeliveredState of Shipment.DeliveredStateData with {
    briefly "Shipment delivered"
    described by "Shipment has been delivered."
  }

  handler ShipmentHandler is {
    on command CreateShipment {
      morph entity TrackingContext.Shipment to state TrackingContext.Shipment.InTransitState with command CreateShipment
      tell event ShipmentCreated to entity TrackingContext.Shipment
    }
    on command RecordPickup {
      tell event PickupRecorded to entity TrackingContext.Shipment
    }
    on command AddTrackingEvent {
      tell event TrackingEventAdded to entity TrackingContext.Shipment
    }
    on command UpdateLocation {
      tell event LocationUpdated to entity TrackingContext.Shipment
    }
    on command UpdateETA {
      tell event ETAUpdated to entity TrackingContext.Shipment
    }
    on command MarkOutForDelivery {
      tell event MarkedOutForDelivery to entity TrackingContext.Shipment
    }
    on command RecordDelivery {
      morph entity TrackingContext.Shipment to state TrackingContext.Shipment.DeliveredState with command RecordDelivery
      tell event DeliveryRecorded to entity TrackingContext.Shipment
    }
    on command ReportException {
      tell event ExceptionReported to entity TrackingContext.Shipment
    }
    on command ResolveException {
      tell event ExceptionResolved to entity TrackingContext.Shipment
    }
    on command InitiateReturn {
      tell event ReturnInitiated to entity TrackingContext.Shipment
    }
  } with {
    briefly "Processes shipment commands"
    described by "Handles shipment lifecycle."
  }

} with {
  briefly "Shipment aggregate"
  described by "Tracks freight shipments."
}
