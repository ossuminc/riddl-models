// Saga Example: Fund Transfer between Accounts

domain Banking is {
  context Transfers is {
    type AccountId is Id(Account)
    type TransferId is Id(Transfer)
    type ReservationId is Id(Reservation)
    type CreditId is Id(Credit)
    type Money is Decimal

    entity Account is { ??? }
    entity Reservation is { ??? }
    entity Credit is { ??? }
    entity Transfer is { ??? }

    saga TransferFunds is {
      briefly "Transfers funds between two accounts with compensation"

      input is {
        sourceAccountId: AccountId,
        targetAccountId: AccountId,
        amount: Money,
        reference: String
      }

      output is {
        success: Boolean,
        transferId: TransferId?,
        errorMessage: String?
      }

      // Step 1: Reserve funds from source
      step ReserveFunds is {
        briefly "Reserve funds in source account"
        from input obtain Transfers.TransferFunds.input.sourceAccountId
        from input obtain Transfers.TransferFunds.input.amount
        send command ReserveFunds to entity Account
        briefly "Undo: Release the reservation"
        reverted by {
          send command ReleaseReservation to entity Account
        }
      }

      // Step 2: Credit target account
      step CreditTarget is {
        briefly "Credit the target account"
        from input obtain Transfers.TransferFunds.input.targetAccountId
        from input obtain Transfers.TransferFunds.input.amount
        send command CreditAccount to entity Account
        briefly "Undo: Reverse the credit"
        reverted by {
          send command ReverseCreditAccount to entity Account
        }
      }

      // Step 3: Complete the transfer
      step CompleteTransfer is {
        briefly "Finalize the transfer and release reservation"
        send command CompleteReservation to entity Account
        reverted by { ??? }
      }
    }
  }
}