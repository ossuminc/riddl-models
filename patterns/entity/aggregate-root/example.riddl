// Aggregate Root Example: Shopping Cart with Line Items

domain Commerce is {
  context Shopping is {
    type ProductId is String

    entity Cart is {
      briefly "Shopping cart aggregate managing line items"

      type CartId is Id(Cart)
      type LineItemId is Id(LineItem)
      type LineItem is {
        id: LineItemId,
        productId: ProductId,
        quantity: Integer,
        unitPrice: Decimal
      }

      // Commands
      command AddLineItem is {
        cartId: CartId,
        item: LineItem
      }
      command UpdateQuantity is {
        cartId: CartId,
        lineItemId: LineItemId,
        newQuantity: Integer
      }
      command RemoveLineItem is {
        cartId: CartId,
        lineItemId: LineItemId
      }
      command ClearCart is {
        cartId: CartId
      }

      // Events
      event LineItemAdded is {
        cartId: CartId,
        item: LineItem
      }
      event QuantityUpdated is {
        cartId: CartId,
        lineItemId: LineItemId,
        oldQuantity: Integer,
        newQuantity: Integer
      }
      event LineItemRemoved is {
        cartId: CartId,
        lineItemId: LineItemId
      }
      event CartCleared is {
        cartId: CartId,
        itemCount: Integer
      }

      // State
      type CartState is {
        id: CartId,
        items: LineItem*,
        itemCount: Integer,
        subtotal: Decimal
      }

      state Active of Cart.CartState is {
        handler CartHandler is {
          on command AddLineItem {
            "Add item to cart if under limit"
            set field Cart.CartState.items to "state.items + @AddLineItem.item"
            set field Cart.CartState.itemCount to "state.itemCount + 1"
            send event Cart.LineItemAdded to outlet Cart.Events
          }
          on command UpdateQuantity {
            "Update quantity of existing item"
            send event Cart.QuantityUpdated to outlet Cart.Events
          }
          on command RemoveLineItem {
            "Remove item from cart"
            set field Cart.CartState.itemCount to "state.itemCount - 1"
            send event Cart.LineItemRemoved to outlet Cart.Events
          }
          on command ClearCart {
            "Clear all items from cart"
            set field Cart.CartState.items to "[]"
            set field Cart.CartState.itemCount to "0"
            send event Cart.CartCleared to outlet Cart.Events
          }
        }
      }

      outlet Events is event LineItemAdded | event QuantityUpdated |
        event LineItemRemoved | event CartCleared
    }
  }
}