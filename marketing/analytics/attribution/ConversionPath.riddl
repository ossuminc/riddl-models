// Marketing Attribution - ConversionPath Entity
entity ConversionPath is {
  command CreateConversionPath is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |New conversion path identifier.
      }
    }
    conversionInfo: ConversionInfo with {
      briefly "Conversion info"
      described as {
        |Conversion path details.
      }
    }
  } with {
    briefly "Create conversion path"
    described as {
      |Creates a new conversion path for tracking.
    }
  }
  command RecordTouchpoint is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |Conversion path identifier.
      }
    }
    touchpoint: TouchpointInfo with {
      briefly "Touchpoint"
      described as {
        |Touchpoint to record.
      }
    }
  } with {
    briefly "Record touchpoint"
    described as {
      |Records a customer touchpoint on the path.
    }
  }
  command RecordConversion is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |Conversion path identifier.
      }
    }
    convertedAt: TimeStamp with {
      briefly "Converted"
      described as {
        |Conversion time.
      }
    }
    actualValue: Decimal(12,2) with {
      briefly "Value"
      described as {
        |Actual conversion value.
      }
    }
  } with {
    briefly "Record conversion"
    described as {
      |Records that a conversion occurred.
    }
  }
  command ApplyAttributionModel is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |Conversion path identifier.
      }
    }
    modelType: AttributionModelType with {
      briefly "Model"
      described as {
        |Attribution model to apply.
      }
    }
  } with {
    briefly "Apply attribution model"
    described as {
      |Applies an attribution model to the touchpoints.
    }
  }
  command ExpirePath is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |Conversion path identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Expiration reason.
      }
    }
  } with {
    briefly "Expire path"
    described as {
      |Expires a conversion path past its lookback window.
    }
  }
  command CancelPath is  {
    conversionPathId: ConversionPathId with {
      briefly "Path ID"
      described as {
        |Conversion path identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel path"
    described as {
      |Cancels a conversion path.
    }
  }
  // Events
  event ConversionPathCreated is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    conversionInfo: ConversionInfo with {
      briefly "Info"
      described as {
        |Conversion info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Conversion path created"
    described as {
      |Emitted when a conversion path is created.
    }
  }
  event TouchpointRecorded is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    touchpoint: TouchpointInfo with {
      briefly "Touchpoint"
      described as {
        |Recorded touchpoint.
      }
    }
    touchpointCount: Natural with {
      briefly "Count"
      described as {
        |Total touchpoints.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Recording time.
      }
    }
  } with {
    briefly "Touchpoint recorded"
    described as {
      |Emitted when a touchpoint is recorded.
    }
  }
  event ConversionRecorded is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    actualValue: Decimal(12,2) with {
      briefly "Value"
      described as {
        |Conversion value.
      }
    }
    convertedAt: TimeStamp with {
      briefly "Converted"
      described as {
        |Conversion time.
      }
    }
  } with {
    briefly "Conversion recorded"
    described as {
      |Emitted when a conversion is recorded.
    }
  }
  event AttributionModelApplied is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    modelType: AttributionModelType with {
      briefly "Model"
      described as {
        |Model applied.
      }
    }
    results: AttributionResult+ with {
      briefly "Results"
      described as {
        |Attribution results.
      }
    }
    appliedAt: TimeStamp with {
      briefly "Applied"
      described as {
        |Application time.
      }
    }
  } with {
    briefly "Attribution model applied"
    described as {
      |Emitted when attribution model is applied.
    }
  }
  event PathExpired is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Expiration reason.
      }
    }
    expiredAt: TimeStamp with {
      briefly "Expired"
      described as {
        |Expiration time.
      }
    }
  } with {
    briefly "Path expired"
    described as {
      |Emitted when a conversion path expires.
    }
  }
  event PathCancelled is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Path cancelled"
    described as {
      |Emitted when a conversion path is cancelled.
    }
  }
  // States
  record TrackingStateData is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    conversionInfo: ConversionInfo with {
      briefly "Info"
      described as {
        |Conversion info.
      }
    }
    recordedTouchpoints: TouchpointInfo* with {
      briefly "Touchpoints"
      described as {
        |Recorded touchpoints.
      }
    }
    status: ConversionStatus with {
      briefly "Status"
      described as {
        |Path status.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Tracking state data"
    described as {
      |State for a conversion path being tracked.
    }
  }
  record AttributedStateData is  {
    conversionPathId: ConversionPathId with {
      briefly "Path"
      described as {
        |Path ID.
      }
    }
    conversionInfo: ConversionInfo with {
      briefly "Info"
      described as {
        |Conversion info.
      }
    }
    touchpoints: TouchpointInfo+ with {
      briefly "Touchpoints"
      described as {
        |All touchpoints.
      }
    }
    modelType: AttributionModelType with {
      briefly "Model"
      described as {
        |Model used.
      }
    }
    results: AttributionResult+ with {
      briefly "Results"
      described as {
        |Attribution results.
      }
    }
    convertedAt: TimeStamp with {
      briefly "Converted"
      described as {
        |Conversion time.
      }
    }
    attributedAt: TimeStamp with {
      briefly "Attributed"
      described as {
        |Attribution time.
      }
    }
  } with {
    briefly "Attributed state data"
    described as {
      |State for a fully attributed conversion.
    }
  }
  state TrackingState of type ConversionPath.TrackingStateData
  state AttributedState of type ConversionPath.AttributedStateData
  handler ConversionPathHandler is {
    on command CreateConversionPath is {
      morph entity AttributionContext.ConversionPath to state AttributionContext.ConversionPath.TrackingState with command CreateConversionPath
      tell event ConversionPathCreated to entity AttributionContext.ConversionPath
    }
    on command RecordTouchpoint is {
      tell event TouchpointRecorded to entity AttributionContext.ConversionPath
    }
    on command RecordConversion is {
      tell event ConversionRecorded to entity AttributionContext.ConversionPath
    }
    on command ApplyAttributionModel is {
      morph entity AttributionContext.ConversionPath to state AttributionContext.ConversionPath.AttributedState with command ApplyAttributionModel
      tell event AttributionModelApplied to entity AttributionContext.ConversionPath
    }
    on command ExpirePath is {
      tell event PathExpired to entity AttributionContext.ConversionPath
    }
    on command CancelPath is {
      tell event PathCancelled to entity AttributionContext.ConversionPath
    }
  } with {
    briefly "Processes conversion path commands"
    described as {
      |Handles conversion path lifecycle.
    }
  }
} with {
  briefly "ConversionPath aggregate"
  described as {
    |Manages customer conversion paths and attribution.
  }
}
