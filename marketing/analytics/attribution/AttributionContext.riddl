// Marketing Attribution - Attribution Context

context AttributionContext is {

  include "types.riddl"
  include "ConversionPath.riddl"

  repository AttributionRepository is {
    schema AttributionData is relational
      of conversionPaths as ConversionPath
      index on field ConversionPath.conversionPathId
      index on field ConversionPath.conversionInfo.customerId
      index on field ConversionPath.status

    handler AttributionPersistence is {
      on event ConversionPath.ConversionPathCreated {
        prompt "Store new conversion path"
      }
      on event ConversionPath.TouchpointRecorded {
        prompt "Store touchpoint on conversion path"
      }
      on event ConversionPath.ConversionRecorded {
        prompt "Update path to converted"
      }
      on event ConversionPath.AttributionModelApplied {
        prompt "Store attribution results"
      }
      on event ConversionPath.PathExpired {
        prompt "Update path to expired"
      }
    } with {
      briefly "Persists attribution events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Attribution data persistence"
    described by "Persistent storage for attribution data."
  }

  projector AttributionMetrics is {
    updates repository AttributionRepository

    record ChannelMetrics is {
      totalConversions is Natural with { briefly "Conversions" described by "Total conversions." }
      totalAttributedRevenue is Decimal(14, 2) with { briefly "Revenue" described by "Attributed revenue." }
      averageTouchpoints is Decimal(6, 2) with { briefly "Avg touchpoints" described by "Average touchpoints per path." }
      topChannel is ChannelType with { briefly "Top channel" described by "Highest performing channel." }
    } with {
      briefly "Channel metrics"
      described by "Attribution channel metrics."
    }

    handler MetricsHandler is {
      on event ConversionPath.ConversionPathCreated {
        prompt "Track new conversion path"
      }
      on event ConversionPath.TouchpointRecorded {
        prompt "Update touchpoint counts"
      }
      on event ConversionPath.AttributionModelApplied {
        prompt "Update channel revenue and conversion counts"
      }
    } with {
      briefly "Maintains attribution metrics"
      described by "Projects events into attribution metrics."
    }
  } with {
    briefly "Attribution metrics"
    described by "Marketing attribution analytics."
  }

} with {
  briefly "Bounded context for marketing attribution"
  described by "Marketing attribution analysis context."
}
