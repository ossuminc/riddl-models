// Marketing Attribution - Attribution Context
context AttributionContext is {
  include "types.riddl"
  include "ConversionPath.riddl"
  repository AttributionRepository is {
    schema AttributionData is relational
      of conversionPaths as type ConversionPath
        index on field ConversionPath.conversionPathId
        index on field ConversionPath.conversionInfo.customerId
        index on field ConversionPath.status

    handler AttributionPersistence is {
      on command ConversionPath.CreateConversionPath is {
        prompt "Store new conversion path"
      }
      on command ConversionPath.RecordTouchpoint is {
        prompt "Store touchpoint on conversion path"
      }
      on command ConversionPath.RecordConversion is {
        prompt "Update path to converted"
      }
      on command ConversionPath.ApplyAttributionModel is {
        prompt "Store attribution results"
      }
      on command ConversionPath.ExpirePath is {
        prompt "Update path to expired"
      }
    } with {
      briefly "Persists attribution commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Attribution data persistence"
    described as {
      |Persistent storage for attribution data.
    }
  }
  projector AttributionMetrics is {
    record ChannelMetrics is  {
      totalConversions: Natural with {
        briefly "Conversions"
        described as {
          |Total conversions.
        }
      }
      totalAttributedRevenue: Decimal(14,2) with {
        briefly "Revenue"
        described as {
          |Attributed revenue.
        }
      }
      averageTouchpoints: Decimal(6,2) with {
        briefly "Avg touchpoints"
        described as {
          |Average touchpoints per path.
        }
      }
      topChannel: ChannelType with {
        briefly "Top channel"
        described as {
          |Highest performing channel.
        }
      }
    } with {
      briefly "Channel metrics"
      described as {
        |Attribution channel metrics.
      }
    }
    handler MetricsHandler is {
      on event ConversionPath.ConversionPathCreated is {
        prompt "Track new conversion path"
      }
      on event ConversionPath.TouchpointRecorded is {
        prompt "Update touchpoint counts"
      }
      on event ConversionPath.AttributionModelApplied is {
        prompt "Update channel revenue and conversion counts"
      }
    } with {
      briefly "Maintains attribution metrics"
      described as {
        |Projects events into attribution metrics.
      }
    }
  } with {
    briefly "Attribution metrics"
    described as {
      |Marketing attribution analytics.
    }
  }
} with {
  briefly "Bounded context for marketing attribution"
  described as {
    |Marketing attribution analysis context.
  }
}
