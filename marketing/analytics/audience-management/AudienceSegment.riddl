// Audience Management - AudienceSegment Entity

entity AudienceSegment is {

  command CreateSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "New segment identifier."
    }
    segmentName is String(3, 200) with {
      briefly "Name"
      described by "Segment name."
    }
    segmentType is SegmentType with {
      briefly "Type"
      described by "Segment classification."
    }
    criteria is many SegmentCriteria with {
      briefly "Criteria"
      described by "Segmentation criteria."
    }
    createdBy is String(3, 100) with {
      briefly "Created by"
      described by "User creating the segment."
    }
  } with {
    briefly "Create segment"
    described by "Creates a new audience segment."
  }

  command UpdateCriteria is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    criteria is many SegmentCriteria with {
      briefly "Criteria"
      described by "Updated segmentation criteria."
    }
  } with {
    briefly "Update criteria"
    described by "Updates segment membership criteria."
  }

  command BuildSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    requestedBy is String(3, 100) with {
      briefly "Requested by"
      described by "User requesting build."
    }
  } with {
    briefly "Build segment"
    described by "Triggers audience member evaluation."
  }

  command AttachPersona is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    persona is PersonaProfile with {
      briefly "Persona"
      described by "Persona to attach."
    }
  } with {
    briefly "Attach persona"
    described by "Attaches a marketing persona to the segment."
  }

  command ActivateSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    channelType is ActivationChannel with {
      briefly "Channel"
      described by "Target activation channel."
    }
    campaignId is CampaignId with {
      briefly "Campaign"
      described by "Target campaign."
    }
  } with {
    briefly "Activate segment"
    described by "Pushes audience segment to a marketing channel."
  }

  command ConfigureLookalike is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    lookalikeConfig is LookalikeConfig with {
      briefly "Config"
      described by "Lookalike model configuration."
    }
  } with {
    briefly "Configure lookalike"
    described by "Sets up lookalike audience modeling."
  }

  command PauseSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Pause reason."
    }
  } with {
    briefly "Pause segment"
    described by "Pauses an active audience segment."
  }

  command ArchiveSegment is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Archive reason."
    }
  } with {
    briefly "Archive segment"
    described by "Archives an audience segment."
  }

  command FailSegmentBuild is {
    segmentId is SegmentId with {
      briefly "Segment ID"
      described by "Segment identifier."
    }
    reason is String(3, 500) with {
      briefly "Reason"
      described by "Failure reason."
    }
  } with {
    briefly "Fail segment build"
    described by "Marks a segment build as failed."
  }

  // Events
  event SegmentCreated is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentName is String(3, 200) with { briefly "Name" described by "Segment name." }
    segmentType is SegmentType with { briefly "Type" described by "Segment type." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Segment created"
    described by "Emitted when an audience segment is created."
  }

  event CriteriaUpdated is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    criteriaCount is Natural with { briefly "Count" described by "Number of criteria groups." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Criteria updated"
    described by "Emitted when segment criteria are updated."
  }

  event SegmentBuildStarted is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Build start time." }
  } with {
    briefly "Segment build started"
    described by "Emitted when segment member evaluation begins."
  }

  event SegmentBuildCompleted is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    memberCount is Natural with { briefly "Members" described by "Total members found." }
    completedAt is TimeStamp with { briefly "Completed" described by "Build completion time." }
  } with {
    briefly "Segment build completed"
    described by "Emitted when segment member evaluation completes."
  }

  event PersonaAttached is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    personaId is PersonaId with { briefly "Persona" described by "Persona ID." }
    attachedAt is TimeStamp with { briefly "Attached" described by "Attachment time." }
  } with {
    briefly "Persona attached"
    described by "Emitted when a persona is attached to a segment."
  }

  event SegmentActivated is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    channelType is ActivationChannel with { briefly "Channel" described by "Activation channel." }
    campaignId is CampaignId with { briefly "Campaign" described by "Campaign ID." }
    memberCount is Natural with { briefly "Members" described by "Members activated." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Segment activated"
    described by "Emitted when segment is pushed to a channel."
  }

  event LookalikeConfigured is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    sourceSegmentId is SegmentId with { briefly "Source" described by "Source segment ID." }
    configuredAt is TimeStamp with { briefly "Configured" described by "Configuration time." }
  } with {
    briefly "Lookalike configured"
    described by "Emitted when lookalike modeling is configured."
  }

  event SegmentPaused is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Pause reason." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Segment paused"
    described by "Emitted when segment is paused."
  }

  event SegmentArchived is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Archive reason." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Segment archived"
    described by "Emitted when segment is archived."
  }

  event SegmentBuildFailed is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    reason is String(3, 500) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Segment build failed"
    described by "Emitted when segment build fails."
  }

  // States
  record ActiveSegmentData is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentName is String(3, 200) with { briefly "Name" described by "Segment name." }
    segmentType is SegmentType with { briefly "Type" described by "Segment type." }
    status is SegmentStatus with { briefly "Status" described by "Segment status." }
    criteria is many SegmentCriteria with { briefly "Criteria" described by "Segmentation criteria." }
    personas is many optional PersonaProfile with { briefly "Personas" described by "Attached personas." }
    segmentMembers is many optional AudienceMember with { briefly "Members" described by "Audience members." }
    activations is many optional ActivationRecord with { briefly "Activations" described by "Channel activations." }
    currentLookalikeConfig is optional LookalikeConfig with { briefly "Lookalike" described by "Lookalike config." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active segment state"
    described by "State for an active audience segment."
  }

  record ArchivedSegmentData is {
    segmentId is SegmentId with { briefly "Segment" described by "Segment ID." }
    segmentName is String(3, 200) with { briefly "Name" described by "Segment name." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
    reason is String(3, 500) with { briefly "Reason" described by "Archive reason." }
  } with {
    briefly "Archived segment state"
    described by "State for an archived audience segment."
  }

  state ActiveSegment of AudienceSegment.ActiveSegmentData with {
    briefly "Segment active"
    described by "Audience segment is active and usable."
  }

  state ArchivedSegment of AudienceSegment.ArchivedSegmentData with {
    briefly "Segment archived"
    described by "Audience segment is archived."
  }

  handler AudienceSegmentHandler is {
    on command CreateSegment {
      morph entity AudienceContext.AudienceSegment to state AudienceContext.AudienceSegment.ActiveSegment with command CreateSegment
      tell event SegmentCreated to entity AudienceContext.AudienceSegment
    }
    on command UpdateCriteria {
      tell event CriteriaUpdated to entity AudienceContext.AudienceSegment
    }
    on command BuildSegment {
      tell event SegmentBuildStarted to entity AudienceContext.AudienceSegment
    }
    on command AttachPersona {
      tell event PersonaAttached to entity AudienceContext.AudienceSegment
    }
    on command ActivateSegment {
      tell event SegmentActivated to entity AudienceContext.AudienceSegment
    }
    on command ConfigureLookalike {
      tell event LookalikeConfigured to entity AudienceContext.AudienceSegment
    }
    on command PauseSegment {
      tell event SegmentPaused to entity AudienceContext.AudienceSegment
    }
    on command ArchiveSegment {
      morph entity AudienceContext.AudienceSegment to state AudienceContext.AudienceSegment.ArchivedSegment with command ArchiveSegment
      tell event SegmentArchived to entity AudienceContext.AudienceSegment
    }
    on command FailSegmentBuild {
      tell event SegmentBuildFailed to entity AudienceContext.AudienceSegment
    }
  } with {
    briefly "Processes audience segment commands"
    described by "Handles audience segment lifecycle."
  }

} with {
  briefly "AudienceSegment aggregate"
  described by "Manages audience segments and their lifecycle."
}
