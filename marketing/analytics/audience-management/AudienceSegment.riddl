// Audience Management - AudienceSegment Entity
entity AudienceSegment is {
  command CreateSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |New segment identifier.
      }
    }
    segmentName: String(3,200) with {
      briefly "Name"
      described as {
        |Segment name.
      }
    }
    segmentType: SegmentType with {
      briefly "Type"
      described as {
        |Segment classification.
      }
    }
    criteria: SegmentCriteria+ with {
      briefly "Criteria"
      described as {
        |Segmentation criteria.
      }
    }
    createdBy: String(3,100) with {
      briefly "Created by"
      described as {
        |User creating the segment.
      }
    }
  } with {
    briefly "Create segment"
    described as {
      |Creates a new audience segment.
    }
  }
  command UpdateCriteria is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    criteria: SegmentCriteria+ with {
      briefly "Criteria"
      described as {
        |Updated segmentation criteria.
      }
    }
  } with {
    briefly "Update criteria"
    described as {
      |Updates segment membership criteria.
    }
  }
  command BuildSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    requestedBy: String(3,100) with {
      briefly "Requested by"
      described as {
        |User requesting build.
      }
    }
  } with {
    briefly "Build segment"
    described as {
      |Triggers audience member evaluation.
    }
  }
  command AttachPersona is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    persona: PersonaProfile with {
      briefly "Persona"
      described as {
        |Persona to attach.
      }
    }
  } with {
    briefly "Attach persona"
    described as {
      |Attaches a marketing persona to the segment.
    }
  }
  command ActivateSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    channelType: ActivationChannel with {
      briefly "Channel"
      described as {
        |Target activation channel.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Target campaign.
      }
    }
  } with {
    briefly "Activate segment"
    described as {
      |Pushes audience segment to a marketing channel.
    }
  }
  command ConfigureLookalike is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    lookalikeConfig: LookalikeConfig with {
      briefly "Config"
      described as {
        |Lookalike model configuration.
      }
    }
  } with {
    briefly "Configure lookalike"
    described as {
      |Sets up lookalike audience modeling.
    }
  }
  command PauseSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
  } with {
    briefly "Pause segment"
    described as {
      |Pauses an active audience segment.
    }
  }
  command ArchiveSegment is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
  } with {
    briefly "Archive segment"
    described as {
      |Archives an audience segment.
    }
  }
  command FailSegmentBuild is  {
    segmentId: SegmentId with {
      briefly "Segment ID"
      described as {
        |Segment identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
  } with {
    briefly "Fail segment build"
    described as {
      |Marks a segment build as failed.
    }
  }
  // Events
  event SegmentCreated is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentName: String(3,200) with {
      briefly "Name"
      described as {
        |Segment name.
      }
    }
    segmentType: SegmentType with {
      briefly "Type"
      described as {
        |Segment type.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Segment created"
    described as {
      |Emitted when an audience segment is created.
    }
  }
  event CriteriaUpdated is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    criteriaCount: Natural with {
      briefly "Count"
      described as {
        |Number of criteria groups.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Criteria updated"
    described as {
      |Emitted when segment criteria are updated.
    }
  }
  event SegmentBuildStarted is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Build start time.
      }
    }
  } with {
    briefly "Segment build started"
    described as {
      |Emitted when segment member evaluation begins.
    }
  }
  event SegmentBuildCompleted is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    memberCount: Natural with {
      briefly "Members"
      described as {
        |Total members found.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Build completion time.
      }
    }
  } with {
    briefly "Segment build completed"
    described as {
      |Emitted when segment member evaluation completes.
    }
  }
  event PersonaAttached is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    personaId: PersonaId with {
      briefly "Persona"
      described as {
        |Persona ID.
      }
    }
    attachedAt: TimeStamp with {
      briefly "Attached"
      described as {
        |Attachment time.
      }
    }
  } with {
    briefly "Persona attached"
    described as {
      |Emitted when a persona is attached to a segment.
    }
  }
  event SegmentActivated is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    channelType: ActivationChannel with {
      briefly "Channel"
      described as {
        |Activation channel.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    memberCount: Natural with {
      briefly "Members"
      described as {
        |Members activated.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Segment activated"
    described as {
      |Emitted when segment is pushed to a channel.
    }
  }
  event LookalikeConfigured is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    sourceSegmentId: SegmentId with {
      briefly "Source"
      described as {
        |Source segment ID.
      }
    }
    configuredAt: TimeStamp with {
      briefly "Configured"
      described as {
        |Configuration time.
      }
    }
  } with {
    briefly "Lookalike configured"
    described as {
      |Emitted when lookalike modeling is configured.
    }
  }
  event SegmentPaused is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Segment paused"
    described as {
      |Emitted when segment is paused.
    }
  }
  event SegmentArchived is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Segment archived"
    described as {
      |Emitted when segment is archived.
    }
  }
  event SegmentBuildFailed is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Failure reason.
      }
    }
    failedAt: TimeStamp with {
      briefly "Failed"
      described as {
        |Failure time.
      }
    }
  } with {
    briefly "Segment build failed"
    described as {
      |Emitted when segment build fails.
    }
  }
  // States
  record ActiveSegmentData is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentName: String(3,200) with {
      briefly "Name"
      described as {
        |Segment name.
      }
    }
    segmentType: SegmentType with {
      briefly "Type"
      described as {
        |Segment type.
      }
    }
    status: SegmentStatus with {
      briefly "Status"
      described as {
        |Segment status.
      }
    }
    criteria: SegmentCriteria+ with {
      briefly "Criteria"
      described as {
        |Segmentation criteria.
      }
    }
    personas: PersonaProfile* with {
      briefly "Personas"
      described as {
        |Attached personas.
      }
    }
    segmentMembers: AudienceMember* with {
      briefly "Members"
      described as {
        |Audience members.
      }
    }
    activations: ActivationRecord* with {
      briefly "Activations"
      described as {
        |Channel activations.
      }
    }
    currentLookalikeConfig: LookalikeConfig? with {
      briefly "Lookalike"
      described as {
        |Lookalike config.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active segment state"
    described as {
      |State for an active audience segment.
    }
  }
  record ArchivedSegmentData is  {
    segmentId: SegmentId with {
      briefly "Segment"
      described as {
        |Segment ID.
      }
    }
    segmentName: String(3,200) with {
      briefly "Name"
      described as {
        |Segment name.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Archive reason.
      }
    }
  } with {
    briefly "Archived segment state"
    described as {
      |State for an archived audience segment.
    }
  }
  state ActiveSegment of type AudienceSegment.ActiveSegmentData
  state ArchivedSegment of type AudienceSegment.ArchivedSegmentData
  handler AudienceSegmentHandler is {
    on command CreateSegment is {
      morph entity AudienceContext.AudienceSegment to state AudienceContext.AudienceSegment.ActiveSegment with command CreateSegment
      tell event SegmentCreated to entity AudienceContext.AudienceSegment
    }
    on command UpdateCriteria is {
      tell event CriteriaUpdated to entity AudienceContext.AudienceSegment
    }
    on command BuildSegment is {
      tell event SegmentBuildStarted to entity AudienceContext.AudienceSegment
    }
    on command AttachPersona is {
      tell event PersonaAttached to entity AudienceContext.AudienceSegment
    }
    on command ActivateSegment is {
      tell event SegmentActivated to entity AudienceContext.AudienceSegment
    }
    on command ConfigureLookalike is {
      tell event LookalikeConfigured to entity AudienceContext.AudienceSegment
    }
    on command PauseSegment is {
      tell event SegmentPaused to entity AudienceContext.AudienceSegment
    }
    on command ArchiveSegment is {
      morph entity AudienceContext.AudienceSegment to state AudienceContext.AudienceSegment.ArchivedSegment with command ArchiveSegment
      tell event SegmentArchived to entity AudienceContext.AudienceSegment
    }
    on command FailSegmentBuild is {
      tell event SegmentBuildFailed to entity AudienceContext.AudienceSegment
    }
  } with {
    briefly "Processes audience segment commands"
    described as {
      |Handles audience segment lifecycle.
    }
  }
} with {
  briefly "AudienceSegment aggregate"
  described as {
    |Manages audience segments and their lifecycle.
  }
}
