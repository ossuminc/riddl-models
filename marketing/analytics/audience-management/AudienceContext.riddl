// Audience Management - Audience Context

context AudienceContext is {

  include "types.riddl"
  include "AudienceSegment.riddl"

  repository AudienceRepository is {
    schema AudienceData is relational
      of audienceSegments as AudienceSegment
      index on field AudienceSegment.segmentId
      index on field AudienceSegment.segmentName
      index on field AudienceSegment.status

    handler AudiencePersistence is {
      on command AudienceSegment.CreateSegment {
        prompt "Store new audience segment"
      }
      on command AudienceSegment.UpdateCriteria {
        prompt "Update segment criteria"
      }
      on command AudienceSegment.BuildSegment {
        prompt "Store segment members"
      }
      on command AudienceSegment.ActivateSegment {
        prompt "Record channel activation"
      }
      on command AudienceSegment.ArchiveSegment {
        prompt "Mark segment as archived"
      }
    } with {
      briefly "Persists audience commands"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Audience data persistence"
    described by "Persistent storage for audience segments."
  }

  projector AudienceMetrics is {
    updates repository AudienceRepository

    record SegmentMetrics is {
      totalSegments is Natural with { briefly "Total" described by "Total segments." }
      activeSegments is Natural with { briefly "Active" described by "Active segments." }
      totalMembers is Natural with { briefly "Members" described by "Total audience members." }
      activationsCount is Natural with { briefly "Activations" described by "Total activations." }
      averageSegmentSize is Decimal(10, 2) with { briefly "Avg size" described by "Average segment member count." }
    } with {
      briefly "Segment metrics"
      described by "Audience segment analytics."
    }

    handler MetricsHandler is {
      on event AudienceSegment.SegmentCreated {
        prompt "Increment total and active segments"
      }
      on event AudienceSegment.SegmentBuildCompleted {
        prompt "Update total members and average size"
      }
      on event AudienceSegment.SegmentActivated {
        prompt "Increment activations count"
      }
      on event AudienceSegment.SegmentArchived {
        prompt "Decrement active segments"
      }
    } with {
      briefly "Maintains audience metrics"
      described by "Projects events into audience analytics."
    }
  } with {
    briefly "Audience metrics"
    described by "Audience management analytics and reporting."
  }

} with {
  briefly "Bounded context for audience management"
  described by "Audience segmentation and activation context."
}
