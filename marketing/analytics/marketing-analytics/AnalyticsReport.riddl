// Marketing Analytics - AnalyticsReport Entity

entity AnalyticsReport is {

  command CreateReport is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "New report identifier."
    }
    reportName is String(1, 200) with {
      briefly "Name"
      described by "Report name."
    }
    parameters is ReportParameters with {
      briefly "Parameters"
      described by "Report parameters."
    }
    requestedBy is String(1, 100) with {
      briefly "Requested by"
      described by "Requester name."
    }
  } with {
    briefly "Create report"
    described by "Creates an analytics report."
  }

  command GenerateReport is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
  } with {
    briefly "Generate report"
    described by "Starts report generation."
  }

  command AddChannelMetrics is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    metrics is ChannelMetrics with {
      briefly "Metrics"
      described by "Channel metrics."
    }
  } with {
    briefly "Add channel metrics"
    described by "Adds channel metrics to report."
  }

  command AddCampaignPerformance is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    performance is CampaignPerformance with {
      briefly "Performance"
      described by "Campaign performance."
    }
  } with {
    briefly "Add campaign performance"
    described by "Adds campaign data to report."
  }

  command AddAttributionResults is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    results is many AttributionResult with {
      briefly "Results"
      described by "Attribution results."
    }
  } with {
    briefly "Add attribution results"
    described by "Adds attribution analysis to report."
  }

  command CompleteReport is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
    summary is String(1, 2000) with {
      briefly "Summary"
      described by "Report summary."
    }
  } with {
    briefly "Complete report"
    described by "Marks report as ready."
  }

  command FailReport is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Failure reason."
    }
  } with {
    briefly "Fail report"
    described by "Marks report as failed."
  }

  command ArchiveReport is {
    reportId is AnalyticsReportId with {
      briefly "Report ID"
      described by "Report identifier."
    }
    archivedAt is TimeStamp with {
      briefly "Archived"
      described by "Archive time."
    }
  } with {
    briefly "Archive report"
    described by "Archives completed report."
  }

  // Events
  event ReportCreated is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    reportName is String(1, 200) with { briefly "Name" described by "Report name." }
    parameters is ReportParameters with { briefly "Parameters" described by "Report params." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Report created"
    described by "Emitted when report is created."
  }

  event ReportGenerationStarted is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
  } with {
    briefly "Report generation started"
    described by "Emitted when generation begins."
  }

  event ChannelMetricsAdded is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    channelType is ChannelType with { briefly "Channel" described by "Channel type." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Channel metrics added"
    described by "Emitted when channel data is added."
  }

  event CampaignPerformanceAdded is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    campaignId is CampaignId with { briefly "Campaign" described by "Campaign ID." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Campaign performance added"
    described by "Emitted when campaign data is added."
  }

  event AttributionResultsAdded is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    channelCount is Natural with { briefly "Channels" described by "Channels analyzed." }
    addedAt is TimeStamp with { briefly "Added" described by "Add time." }
  } with {
    briefly "Attribution results added"
    described by "Emitted when attribution is added."
  }

  event ReportCompleted is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    summary is String(1, 2000) with { briefly "Summary" described by "Report summary." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Report completed"
    described by "Emitted when report is ready."
  }

  event ReportFailed is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Failure reason." }
    failedAt is TimeStamp with { briefly "Failed" described by "Failure time." }
  } with {
    briefly "Report failed"
    described by "Emitted when report fails."
  }

  event ReportArchived is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Report archived"
    described by "Emitted when report is archived."
  }

  // States
  record ActiveStateData is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    reportName is String(1, 200) with { briefly "Name" described by "Report name." }
    parameters is ReportParameters with { briefly "Parameters" described by "Report params." }
    status is ReportStatus with { briefly "Status" described by "Report status." }
    channelMetrics is many optional ChannelMetrics with { briefly "Channels" described by "Channel data." }
    campaignPerformance is many optional CampaignPerformance with { briefly "Campaigns" described by "Campaign data." }
    attributionResults is many optional AttributionResult with { briefly "Attribution" described by "Attribution results." }
    requestedBy is String(1, 100) with { briefly "Requested by" described by "Requester." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active report state"
    described by "State for active report."
  }

  record ArchivedStateData is {
    reportId is AnalyticsReportId with { briefly "Report" described by "Report ID." }
    reportName is String(1, 200) with { briefly "Name" described by "Report name." }
    summary is String(1, 2000) with { briefly "Summary" described by "Report summary." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Archived report state"
    described by "State for archived report."
  }

  state ActiveState of AnalyticsReport.ActiveStateData with {
    briefly "Report active"
    described by "Report is active."
  }

  state ArchivedState of AnalyticsReport.ArchivedStateData with {
    briefly "Report archived"
    described by "Report has been archived."
  }

  handler AnalyticsReportHandler is {
    on command CreateReport {
      morph entity AnalyticsContext.AnalyticsReport to state AnalyticsContext.AnalyticsReport.ActiveState with command CreateReport
      tell event ReportCreated to entity AnalyticsContext.AnalyticsReport
    }
    on command GenerateReport {
      tell event ReportGenerationStarted to entity AnalyticsContext.AnalyticsReport
    }
    on command AddChannelMetrics {
      tell event ChannelMetricsAdded to entity AnalyticsContext.AnalyticsReport
    }
    on command AddCampaignPerformance {
      tell event CampaignPerformanceAdded to entity AnalyticsContext.AnalyticsReport
    }
    on command AddAttributionResults {
      tell event AttributionResultsAdded to entity AnalyticsContext.AnalyticsReport
    }
    on command CompleteReport {
      tell event ReportCompleted to entity AnalyticsContext.AnalyticsReport
    }
    on command FailReport {
      tell event ReportFailed to entity AnalyticsContext.AnalyticsReport
    }
    on command ArchiveReport {
      morph entity AnalyticsContext.AnalyticsReport to state AnalyticsContext.AnalyticsReport.ArchivedState with command ArchiveReport
      tell event ReportArchived to entity AnalyticsContext.AnalyticsReport
    }
  } with {
    briefly "Processes report commands"
    described by "Handles analytics report lifecycle."
  }

} with {
  briefly "AnalyticsReport aggregate"
  described by "Manages marketing analytics reports."
}
