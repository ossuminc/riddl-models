// Ad Serving - Ad Context

context AdContext is {

  include "types.riddl"
  include "Ad.riddl"

  repository AdRepository is {
    schema AdData is relational
      of ads as Ad
      index on field Ad.adId
      index on field Ad.campaignId
      index on field Ad.status

    handler AdPersistence is {
      on event Ad.AdCreated {
        prompt "Store new ad record"
      }
      on event Ad.TargetingUpdated {
        prompt "Update ad targeting"
      }
      on event Ad.AdActivated {
        prompt "Update ad to active"
      }
      on event Ad.ImpressionRecorded {
        prompt "Store impression and update stats"
      }
      on event Ad.ClickRecorded {
        prompt "Store click and update stats"
      }
      on event Ad.AdCompleted {
        prompt "Update ad to completed"
      }
    } with {
      briefly "Persists ad events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Ad data persistence"
    described by "Persistent storage for ads."
  }

  projector AdPerformance is {
    updates repository AdRepository

    record CampaignPerformance is {
      campaignId is CampaignId with { briefly "Campaign" described by "Campaign ID." }
      totalImpressions is Natural with { briefly "Impressions" described by "Total impressions." }
      totalClicks is Natural with { briefly "Clicks" described by "Total clicks." }
      totalSpend is Decimal(15, 2) with { briefly "Spend" described by "Total spend." }
      ctr is Decimal(8, 6) with { briefly "CTR" described by "Click-through rate." }
      avgEcpm is Decimal(10, 4) with { briefly "eCPM" described by "Avg eCPM." }
    } with {
      briefly "Campaign performance"
      described by "Campaign delivery performance."
    }

    handler PerformanceHandler is {
      on event Ad.ImpressionRecorded {
        prompt "Aggregate impressions by campaign"
      }
      on event Ad.ClickRecorded {
        prompt "Calculate CTR by campaign"
      }
    } with {
      briefly "Maintains performance metrics"
      described by "Projects events into performance."
    }
  } with {
    briefly "Ad performance"
    described by "Ad delivery analytics."
  }

} with {
  briefly "Bounded context for ad serving"
  described by "Digital advertising delivery context."
}
