// Ad Serving - Ad Context
context AdContext is {
  include "types.riddl"
  include "Ad.riddl"
  repository AdRepository is {
    schema AdData is relational
      of ads as type Ad
        index on field Ad.adId
        index on field Ad.campaignId
        index on field Ad.status

    handler AdPersistence is {
      on command Ad.CreateAd is {
        prompt "Store new ad record"
      }
      on command Ad.UpdateTargeting is {
        prompt "Update ad targeting"
      }
      on command Ad.ActivateAd is {
        prompt "Update ad to active"
      }
      on command Ad.RecordImpression is {
        prompt "Store impression and update stats"
      }
      on command Ad.RecordClick is {
        prompt "Store click and update stats"
      }
      on command Ad.CompleteAd is {
        prompt "Update ad to completed"
      }
    } with {
      briefly "Persists ad commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Ad data persistence"
    described as {
      |Persistent storage for ads.
    }
  }
  projector AdPerformance is {
    record CampaignPerformance is  {
      campaignId: CampaignId with {
        briefly "Campaign"
        described as {
          |Campaign ID.
        }
      }
      totalImpressions: Natural with {
        briefly "Impressions"
        described as {
          |Total impressions.
        }
      }
      totalClicks: Natural with {
        briefly "Clicks"
        described as {
          |Total clicks.
        }
      }
      totalSpend: Decimal(15,2) with {
        briefly "Spend"
        described as {
          |Total spend.
        }
      }
      ctr: Decimal(8,6) with {
        briefly "CTR"
        described as {
          |Click-through rate.
        }
      }
      avgEcpm: Decimal(10,4) with {
        briefly "eCPM"
        described as {
          |Avg eCPM.
        }
      }
    } with {
      briefly "Campaign performance"
      described as {
        |Campaign delivery performance.
      }
    }
    handler PerformanceHandler is {
      on event Ad.ImpressionRecorded is {
        prompt "Aggregate impressions by campaign"
      }
      on event Ad.ClickRecorded is {
        prompt "Calculate CTR by campaign"
      }
    } with {
      briefly "Maintains performance metrics"
      described as {
        |Projects events into performance.
      }
    }
  } with {
    briefly "Ad performance"
    described as {
      |Ad delivery analytics.
    }
  }
} with {
  briefly "Bounded context for ad serving"
  described as {
    |Digital advertising delivery context.
  }
}
