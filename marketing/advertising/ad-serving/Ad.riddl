// Ad Serving - Ad Entity
entity Ad is {
  command CreateAd is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |New ad identifier.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Parent campaign.
      }
    }
    adName: String(1,200) with {
      briefly "Name"
      described as {
        |Ad name.
      }
    }
    creative: AdCreative with {
      briefly "Creative"
      described as {
        |Ad creative.
      }
    }
    targeting: TargetingCriteria with {
      briefly "Targeting"
      described as {
        |Targeting criteria.
      }
    }
    schedule: FlightSchedule with {
      briefly "Schedule"
      described as {
        |Flight schedule.
      }
    }
    bidInfo: BidInfo with {
      briefly "Bid"
      described as {
        |Bidding info.
      }
    }
  } with {
    briefly "Create ad"
    described as {
      |Creates a new ad.
    }
  }
  command UpdateTargeting is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    targeting: TargetingCriteria with {
      briefly "Targeting"
      described as {
        |New targeting.
      }
    }
  } with {
    briefly "Update targeting"
    described as {
      |Updates targeting criteria.
    }
  }
  command UpdateBid is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    bidInfo: BidInfo with {
      briefly "Bid"
      described as {
        |New bid info.
      }
    }
  } with {
    briefly "Update bid"
    described as {
      |Updates bid configuration.
    }
  }
  command ActivateAd is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Activate ad"
    described as {
      |Activates ad for delivery.
    }
  }
  command PauseAd is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
  } with {
    briefly "Pause ad"
    described as {
      |Pauses ad delivery.
    }
  }
  command RecordImpression is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    impression: ImpressionRecord with {
      briefly "Impression"
      described as {
        |Impression record.
      }
    }
  } with {
    briefly "Record impression"
    described as {
      |Records an ad impression.
    }
  }
  command RecordClick is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    click: ClickRecord with {
      briefly "Click"
      described as {
        |Click record.
      }
    }
  } with {
    briefly "Record click"
    described as {
      |Records an ad click.
    }
  }
  command CompleteAd is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
    finalStats: DeliveryStats with {
      briefly "Stats"
      described as {
        |Final delivery stats.
      }
    }
  } with {
    briefly "Complete ad"
    described as {
      |Marks ad as completed.
    }
  }
  command ArchiveAd is  {
    adId: AdId with {
      briefly "Ad ID"
      described as {
        |Ad identifier.
      }
    }
  } with {
    briefly "Archive ad"
    described as {
      |Archives the ad.
    }
  }
  // Events
  event AdCreated is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    adName: String(1,200) with {
      briefly "Name"
      described as {
        |Ad name.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Ad created"
    described as {
      |Emitted when ad is created.
    }
  }
  event TargetingUpdated is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    targeting: TargetingCriteria with {
      briefly "Targeting"
      described as {
        |New targeting.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Targeting updated"
    described as {
      |Emitted when targeting changes.
    }
  }
  event BidUpdated is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    bidInfo: BidInfo with {
      briefly "Bid"
      described as {
        |New bid.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Bid updated"
    described as {
      |Emitted when bid changes.
    }
  }
  event AdActivated is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    activatedAt: TimeStamp with {
      briefly "Activated"
      described as {
        |Activation time.
      }
    }
  } with {
    briefly "Ad activated"
    described as {
      |Emitted when ad activates.
    }
  }
  event AdPaused is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    reason: String(1,200) with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Ad paused"
    described as {
      |Emitted when ad is paused.
    }
  }
  event ImpressionRecorded is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    impression: ImpressionRecord with {
      briefly "Impression"
      described as {
        |Impression.
      }
    }
  } with {
    briefly "Impression recorded"
    described as {
      |Emitted when impression served.
    }
  }
  event ClickRecorded is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    click: ClickRecord with {
      briefly "Click"
      described as {
        |Click.
      }
    }
  } with {
    briefly "Click recorded"
    described as {
      |Emitted when click occurs.
    }
  }
  event AdCompleted is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    finalStats: DeliveryStats with {
      briefly "Stats"
      described as {
        |Final stats.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Ad completed"
    described as {
      |Emitted when ad completes.
    }
  }
  event AdArchived is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Ad archived"
    described as {
      |Emitted when ad archived.
    }
  }
  // States
  record ActiveStateData is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    campaignId: CampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    adName: String(1,200) with {
      briefly "Name"
      described as {
        |Ad name.
      }
    }
    status: AdStatus with {
      briefly "Status"
      described as {
        |Ad status.
      }
    }
    creative: AdCreative with {
      briefly "Creative"
      described as {
        |Creative.
      }
    }
    targeting: TargetingCriteria with {
      briefly "Targeting"
      described as {
        |Targeting.
      }
    }
    schedule: FlightSchedule with {
      briefly "Schedule"
      described as {
        |Schedule.
      }
    }
    bidInfo: BidInfo with {
      briefly "Bid"
      described as {
        |Bid info.
      }
    }
    currentStats: DeliveryStats? with {
      briefly "Stats"
      described as {
        |Current stats.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active ad state"
    described as {
      |State for active ad.
    }
  }
  record ArchivedStateData is  {
    adId: AdId with {
      briefly "Ad"
      described as {
        |Ad ID.
      }
    }
    adName: String(1,200) with {
      briefly "Name"
      described as {
        |Ad name.
      }
    }
    finalStats: DeliveryStats with {
      briefly "Stats"
      described as {
        |Final stats.
      }
    }
    archivedAt: TimeStamp with {
      briefly "Archived"
      described as {
        |Archive time.
      }
    }
  } with {
    briefly "Archived ad state"
    described as {
      |State for archived ad.
    }
  }
  state ActiveState of type Ad.ActiveStateData
  state ArchivedState of type Ad.ArchivedStateData
  handler AdHandler is {
    on command CreateAd is {
      morph entity AdContext.Ad to state AdContext.Ad.ActiveState with command CreateAd
      tell event AdCreated to entity AdContext.Ad
    }
    on command UpdateTargeting is {
      tell event TargetingUpdated to entity AdContext.Ad
    }
    on command UpdateBid is {
      tell event BidUpdated to entity AdContext.Ad
    }
    on command ActivateAd is {
      tell event AdActivated to entity AdContext.Ad
    }
    on command PauseAd is {
      tell event AdPaused to entity AdContext.Ad
    }
    on command RecordImpression is {
      tell event ImpressionRecorded to entity AdContext.Ad
    }
    on command RecordClick is {
      tell event ClickRecorded to entity AdContext.Ad
    }
    on command CompleteAd is {
      tell event AdCompleted to entity AdContext.Ad
    }
    on command ArchiveAd is {
      morph entity AdContext.Ad to state AdContext.Ad.ArchivedState with command ArchiveAd
      tell event AdArchived to entity AdContext.Ad
    }
  } with {
    briefly "Processes ad commands"
    described as {
      |Handles ad lifecycle.
    }
  }
} with {
  briefly "Ad aggregate"
  described as {
    |Manages digital advertisements.
  }
}
