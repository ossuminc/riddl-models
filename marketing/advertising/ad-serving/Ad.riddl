// Ad Serving - Ad Entity

entity Ad is {

  command CreateAd is {
    adId is AdId with {
      briefly "Ad ID"
      described by "New ad identifier."
    }
    campaignId is CampaignId with {
      briefly "Campaign"
      described by "Parent campaign."
    }
    adName is String(1, 200) with {
      briefly "Name"
      described by "Ad name."
    }
    creative is AdCreative with {
      briefly "Creative"
      described by "Ad creative."
    }
    targeting is TargetingCriteria with {
      briefly "Targeting"
      described by "Targeting criteria."
    }
    schedule is FlightSchedule with {
      briefly "Schedule"
      described by "Flight schedule."
    }
    bidInfo is BidInfo with {
      briefly "Bid"
      described by "Bidding info."
    }
  } with {
    briefly "Create ad"
    described by "Creates a new ad."
  }

  command UpdateTargeting is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    targeting is TargetingCriteria with {
      briefly "Targeting"
      described by "New targeting."
    }
  } with {
    briefly "Update targeting"
    described by "Updates targeting criteria."
  }

  command UpdateBid is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    bidInfo is BidInfo with {
      briefly "Bid"
      described by "New bid info."
    }
  } with {
    briefly "Update bid"
    described by "Updates bid configuration."
  }

  command ActivateAd is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    activatedAt is TimeStamp with {
      briefly "Activated"
      described by "Activation time."
    }
  } with {
    briefly "Activate ad"
    described by "Activates ad for delivery."
  }

  command PauseAd is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    reason is String(1, 200) with {
      briefly "Reason"
      described by "Pause reason."
    }
  } with {
    briefly "Pause ad"
    described by "Pauses ad delivery."
  }

  command RecordImpression is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    impression is ImpressionRecord with {
      briefly "Impression"
      described by "Impression record."
    }
  } with {
    briefly "Record impression"
    described by "Records an ad impression."
  }

  command RecordClick is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    click is ClickRecord with {
      briefly "Click"
      described by "Click record."
    }
  } with {
    briefly "Record click"
    described by "Records an ad click."
  }

  command CompleteAd is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
    completedAt is TimeStamp with {
      briefly "Completed"
      described by "Completion time."
    }
    finalStats is DeliveryStats with {
      briefly "Stats"
      described by "Final delivery stats."
    }
  } with {
    briefly "Complete ad"
    described by "Marks ad as completed."
  }

  command ArchiveAd is {
    adId is AdId with {
      briefly "Ad ID"
      described by "Ad identifier."
    }
  } with {
    briefly "Archive ad"
    described by "Archives the ad."
  }

  // Events
  event AdCreated is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    campaignId is CampaignId with { briefly "Campaign" described by "Campaign ID." }
    adName is String(1, 200) with { briefly "Name" described by "Ad name." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Ad created"
    described by "Emitted when ad is created."
  }

  event TargetingUpdated is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    targeting is TargetingCriteria with { briefly "Targeting" described by "New targeting." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Targeting updated"
    described by "Emitted when targeting changes."
  }

  event BidUpdated is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    bidInfo is BidInfo with { briefly "Bid" described by "New bid." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Bid updated"
    described by "Emitted when bid changes."
  }

  event AdActivated is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    activatedAt is TimeStamp with { briefly "Activated" described by "Activation time." }
  } with {
    briefly "Ad activated"
    described by "Emitted when ad activates."
  }

  event AdPaused is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    reason is String(1, 200) with { briefly "Reason" described by "Pause reason." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Ad paused"
    described by "Emitted when ad is paused."
  }

  event ImpressionRecorded is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    impression is ImpressionRecord with { briefly "Impression" described by "Impression." }
  } with {
    briefly "Impression recorded"
    described by "Emitted when impression served."
  }

  event ClickRecorded is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    click is ClickRecord with { briefly "Click" described by "Click." }
  } with {
    briefly "Click recorded"
    described by "Emitted when click occurs."
  }

  event AdCompleted is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    finalStats is DeliveryStats with { briefly "Stats" described by "Final stats." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Ad completed"
    described by "Emitted when ad completes."
  }

  event AdArchived is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Ad archived"
    described by "Emitted when ad archived."
  }

  // States
  record ActiveStateData is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    campaignId is CampaignId with { briefly "Campaign" described by "Campaign ID." }
    adName is String(1, 200) with { briefly "Name" described by "Ad name." }
    status is AdStatus with { briefly "Status" described by "Ad status." }
    creative is AdCreative with { briefly "Creative" described by "Creative." }
    targeting is TargetingCriteria with { briefly "Targeting" described by "Targeting." }
    schedule is FlightSchedule with { briefly "Schedule" described by "Schedule." }
    bidInfo is BidInfo with { briefly "Bid" described by "Bid info." }
    currentStats is optional DeliveryStats with { briefly "Stats" described by "Current stats." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active ad state"
    described by "State for active ad."
  }

  record ArchivedStateData is {
    adId is AdId with { briefly "Ad" described by "Ad ID." }
    adName is String(1, 200) with { briefly "Name" described by "Ad name." }
    finalStats is DeliveryStats with { briefly "Stats" described by "Final stats." }
    archivedAt is TimeStamp with { briefly "Archived" described by "Archive time." }
  } with {
    briefly "Archived ad state"
    described by "State for archived ad."
  }

  state ActiveState of Ad.ActiveStateData with {
    briefly "Ad active"
    described by "Ad is in active lifecycle."
  }

  state ArchivedState of Ad.ArchivedStateData with {
    briefly "Ad archived"
    described by "Ad has been archived."
  }

  handler AdHandler is {
    on command CreateAd {
      morph entity AdContext.Ad to state AdContext.Ad.ActiveState with command CreateAd
      tell event AdCreated to entity AdContext.Ad
    }
    on command UpdateTargeting {
      tell event TargetingUpdated to entity AdContext.Ad
    }
    on command UpdateBid {
      tell event BidUpdated to entity AdContext.Ad
    }
    on command ActivateAd {
      tell event AdActivated to entity AdContext.Ad
    }
    on command PauseAd {
      tell event AdPaused to entity AdContext.Ad
    }
    on command RecordImpression {
      tell event ImpressionRecorded to entity AdContext.Ad
    }
    on command RecordClick {
      tell event ClickRecorded to entity AdContext.Ad
    }
    on command CompleteAd {
      tell event AdCompleted to entity AdContext.Ad
    }
    on command ArchiveAd {
      morph entity AdContext.Ad to state AdContext.Ad.ArchivedState with command ArchiveAd
      tell event AdArchived to entity AdContext.Ad
    }
  } with {
    briefly "Processes ad commands"
    described by "Handles ad lifecycle."
  }

} with {
  briefly "Ad aggregate"
  described by "Manages digital advertisements."
}
