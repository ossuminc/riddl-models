// Media Buying - MediaOrder Entity
entity MediaOrder is {
  command CreateMediaOrder is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |New media order identifier.
      }
    }
    orderInfo: MediaOrderInfo with {
      briefly "Order info"
      described as {
        |Media order details.
      }
    }
    placements: PlacementSpec+ with {
      briefly "Placements"
      described as {
        |Planned ad placements.
      }
    }
  } with {
    briefly "Create media order"
    described as {
      |Creates a new media order.
    }
  }
  command SubmitForApproval is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    submittedBy: String(3,100) with {
      briefly "Submitted by"
      described as {
        |Person submitting for approval.
      }
    }
  } with {
    briefly "Submit for approval"
    described as {
      |Submits media order for approval.
    }
  }
  command NegotiateRate is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    placementId: UUID with {
      briefly "Placement"
      described as {
        |Placement to renegotiate.
      }
    }
    proposedRate: Decimal(10,2) with {
      briefly "Proposed rate"
      described as {
        |Newly proposed rate.
      }
    }
    notes: String(3,500) with {
      briefly "Notes"
      described as {
        |Negotiation notes.
      }
    }
  } with {
    briefly "Negotiate rate"
    described as {
      |Negotiates rate for a placement.
    }
  }
  command ApproveOrder is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    approvedBy: String(3,100) with {
      briefly "Approved by"
      described as {
        |Person approving the order.
      }
    }
    approvedBudget: Decimal(12,2) with {
      briefly "Budget"
      described as {
        |Approved total budget.
      }
    }
  } with {
    briefly "Approve order"
    described as {
      |Approves the media order.
    }
  }
  command BookInventory is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    insertionOrder: InsertionOrder with {
      briefly "IO"
      described as {
        |Signed insertion order.
      }
    }
  } with {
    briefly "Book inventory"
    described as {
      |Books ad inventory with vendor.
    }
  }
  command RecordSpend is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    spendRecord: SpendRecord with {
      briefly "Spend"
      described as {
        |Period spend record.
      }
    }
  } with {
    briefly "Record spend"
    described as {
      |Records actual media spend.
    }
  }
  command RecordPerformance is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    metrics: PerformanceMetric+ with {
      briefly "Metrics"
      described as {
        |Performance metrics.
      }
    }
  } with {
    briefly "Record performance"
    described as {
      |Records campaign performance metrics.
    }
  }
  command CompleteOrder is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion timestamp.
      }
    }
  } with {
    briefly "Complete order"
    described as {
      |Marks media order as completed.
    }
  }
  command CancelOrder is  {
    orderId: MediaOrderId with {
      briefly "Order ID"
      described as {
        |Order identifier.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancellation reason.
      }
    }
  } with {
    briefly "Cancel order"
    described as {
      |Cancels the media order.
    }
  }
  // Events
  event MediaOrderCreated is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: MediaOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Media order created"
    described as {
      |Emitted when a media order is created.
    }
  }
  event OrderSubmitted is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    submittedAt: TimeStamp with {
      briefly "Submitted"
      described as {
        |Submission time.
      }
    }
  } with {
    briefly "Order submitted"
    described as {
      |Emitted when order is submitted for approval.
    }
  }
  event RateNegotiated is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    placementId: UUID with {
      briefly "Placement"
      described as {
        |Placement ID.
      }
    }
    newRate: Decimal(10,2) with {
      briefly "Rate"
      described as {
        |New rate.
      }
    }
    negotiatedAt: TimeStamp with {
      briefly "Negotiated"
      described as {
        |Negotiation time.
      }
    }
  } with {
    briefly "Rate negotiated"
    described as {
      |Emitted when a placement rate is negotiated.
    }
  }
  event OrderApproved is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    approvedBudget: Decimal(12,2) with {
      briefly "Budget"
      described as {
        |Approved budget.
      }
    }
    approvedAt: TimeStamp with {
      briefly "Approved"
      described as {
        |Approval time.
      }
    }
  } with {
    briefly "Order approved"
    described as {
      |Emitted when order is approved.
    }
  }
  event InventoryBooked is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    insertionOrderId: InsertionOrderId with {
      briefly "IO"
      described as {
        |Insertion order ID.
      }
    }
    bookedAt: TimeStamp with {
      briefly "Booked"
      described as {
        |Booking time.
      }
    }
  } with {
    briefly "Inventory booked"
    described as {
      |Emitted when inventory is booked with vendor.
    }
  }
  event SpendRecorded is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    actualSpend: Decimal(12,2) with {
      briefly "Spend"
      described as {
        |Actual spend.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Spend recorded"
    described as {
      |Emitted when spend is recorded.
    }
  }
  event PerformanceRecorded is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    metricCount: Natural with {
      briefly "Count"
      described as {
        |Number of metrics.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Performance recorded"
    described as {
      |Emitted when performance metrics are recorded.
    }
  }
  event OrderCompleted is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Order completed"
    described as {
      |Emitted when media order is completed.
    }
  }
  event OrderCancelled is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    reason: String(3,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Order cancelled"
    described as {
      |Emitted when media order is cancelled.
    }
  }
  // States
  record ActiveStateData is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    orderInfo: MediaOrderInfo with {
      briefly "Info"
      described as {
        |Order info.
      }
    }
    status: OrderStatus with {
      briefly "Status"
      described as {
        |Order status.
      }
    }
    currentPlacements: PlacementSpec* with {
      briefly "Placements"
      described as {
        |Ad placements.
      }
    }
    currentInsertionOrder: InsertionOrder? with {
      briefly "IO"
      described as {
        |Insertion order.
      }
    }
    spendRecords: SpendRecord* with {
      briefly "Spend"
      described as {
        |Spend records.
      }
    }
    performanceMetrics: PerformanceMetric* with {
      briefly "Metrics"
      described as {
        |Performance metrics.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active order state"
    described as {
      |State for an active media order.
    }
  }
  record CompletedStateData is  {
    orderId: MediaOrderId with {
      briefly "Order"
      described as {
        |Order ID.
      }
    }
    totalSpend: Decimal(12,2) with {
      briefly "Total spend"
      described as {
        |Total media spend.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed order state"
    described as {
      |State for a completed media order.
    }
  }
  state ActiveState of type MediaOrder.ActiveStateData
  state CompletedState of type MediaOrder.CompletedStateData
  handler MediaOrderHandler is {
    on command CreateMediaOrder is {
      morph entity MediaBuyingContext.MediaOrder to state MediaBuyingContext.MediaOrder.ActiveState with command CreateMediaOrder
      tell event MediaOrderCreated to entity MediaBuyingContext.MediaOrder
    }
    on command SubmitForApproval is {
      tell event OrderSubmitted to entity MediaBuyingContext.MediaOrder
    }
    on command NegotiateRate is {
      tell event RateNegotiated to entity MediaBuyingContext.MediaOrder
    }
    on command ApproveOrder is {
      tell event OrderApproved to entity MediaBuyingContext.MediaOrder
    }
    on command BookInventory is {
      tell event InventoryBooked to entity MediaBuyingContext.MediaOrder
    }
    on command RecordSpend is {
      tell event SpendRecorded to entity MediaBuyingContext.MediaOrder
    }
    on command RecordPerformance is {
      tell event PerformanceRecorded to entity MediaBuyingContext.MediaOrder
    }
    on command CompleteOrder is {
      morph entity MediaBuyingContext.MediaOrder to state MediaBuyingContext.MediaOrder.CompletedState with command CompleteOrder
      tell event OrderCompleted to entity MediaBuyingContext.MediaOrder
    }
    on command CancelOrder is {
      tell event OrderCancelled to entity MediaBuyingContext.MediaOrder
    }
  } with {
    briefly "Processes media order commands"
    described as {
      |Handles media order lifecycle.
    }
  }
} with {
  briefly "MediaOrder aggregate"
  described as {
    |Manages media buying orders.
  }
}
