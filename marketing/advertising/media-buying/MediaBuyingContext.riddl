// Media Buying - Media Buying Context

context MediaBuyingContext is {

  include "types.riddl"
  include "MediaOrder.riddl"

  repository MediaBuyingRepository is {
    schema MediaBuyingData is relational
      of mediaOrders as MediaOrder
      index on field MediaOrder.orderId
      index on field MediaOrder.orderInfo.campaignId
      index on field MediaOrder.status

    handler MediaBuyingPersistence is {
      on command MediaOrder.CreateMediaOrder {
        prompt "Store new media order"
      }
      on command MediaOrder.SubmitForApproval {
        prompt "Update order to submitted"
      }
      on command MediaOrder.ApproveOrder {
        prompt "Update order to approved"
      }
      on command MediaOrder.BookInventory {
        prompt "Store insertion order and update to booked"
      }
      on command MediaOrder.RecordSpend {
        prompt "Store spend record"
      }
      on command MediaOrder.CompleteOrder {
        prompt "Update order to completed"
      }
    } with {
      briefly "Persists media buying events"
      described by "Handles command-driven persistence."
    }
  } with {
    briefly "Media buying data persistence"
    described by "Persistent storage for media buying."
  }

  projector MediaBuyingMetrics is {
    updates repository MediaBuyingRepository

    record SpendMetrics is {
      ordersPlaced is Natural with { briefly "Placed" described by "Orders placed." }
      ordersCompleted is Natural with { briefly "Completed" described by "Orders completed." }
      ordersCancelled is Natural with { briefly "Cancelled" described by "Orders cancelled." }
      totalMediaSpend is Decimal(14, 2) with { briefly "Total spend" described by "Total media spend." }
    } with {
      briefly "Spend metrics"
      described by "Media spend metrics."
    }

    handler MetricsHandler is {
      on event MediaOrder.MediaOrderCreated {
        prompt "Increment orders placed"
      }
      on event MediaOrder.OrderCompleted {
        prompt "Increment orders completed"
      }
      on event MediaOrder.OrderCancelled {
        prompt "Increment orders cancelled"
      }
      on event MediaOrder.SpendRecorded {
        prompt "Accumulate total media spend"
      }
    } with {
      briefly "Maintains media buying metrics"
      described by "Projects events into spend metrics."
    }
  } with {
    briefly "Media buying metrics"
    described by "Media buying analytics and reporting."
  }

} with {
  briefly "Bounded context for media buying"
  described by "Media buying operations context."
}
