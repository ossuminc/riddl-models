// Marketing Automation - Automation Context
context AutomationContext is {
  include "types.riddl"
  include "AutomationWorkflow.riddl"
  repository AutomationRepository is {
    schema AutomationData is relational
      of automationWorkflows as type AutomationWorkflow
        index on field AutomationWorkflow.workflowId
        index on field AutomationWorkflow.campaignId
        index on field AutomationWorkflow.status

    handler AutomationPersistence is {
      on command AutomationWorkflow.CreateWorkflow is {
        prompt "Store new automation workflow"
      }
      on command AutomationWorkflow.ActivateWorkflow is {
        prompt "Update workflow to activated"
      }
      on command AutomationWorkflow.EnrollLead is {
        prompt "Store lead enrollment"
      }
      on command AutomationWorkflow.AdvanceLeadStep is {
        prompt "Update lead step progress"
      }
      on command AutomationWorkflow.RecordABTestResult is {
        prompt "Store A/B test results"
      }
      on command AutomationWorkflow.CompleteWorkflow is {
        prompt "Update workflow to completed"
      }
    } with {
      briefly "Persists automation commands"
      described as {
        |Handles command-driven persistence.
      }
    }
  } with {
    briefly "Automation data persistence"
    described as {
      |Persistent storage for automation workflows.
    }
  }
  projector AutomationMetrics is {
    record WorkflowMetrics is  {
      workflowsCreated: Natural with {
        briefly "Created"
        described as {
          |Workflows created.
        }
      }
      workflowsActive: Natural with {
        briefly "Active"
        described as {
          |Workflows active.
        }
      }
      workflowsCompleted: Natural with {
        briefly "Completed"
        described as {
          |Workflows completed.
        }
      }
      totalLeadsEnrolled: Natural with {
        briefly "Enrolled"
        described as {
          |Total leads enrolled.
        }
      }
      averageConversionRate: Decimal(8,4) with {
        briefly "Conversion"
        described as {
          |Average conversion rate.
        }
      }
    } with {
      briefly "Workflow metrics"
      described as {
        |Automation workflow metrics.
      }
    }
    handler MetricsHandler is {
      on event AutomationWorkflow.WorkflowCreated is {
        prompt "Increment workflows created"
      }
      on event AutomationWorkflow.WorkflowActivated is {
        prompt "Increment workflows active"
      }
      on event AutomationWorkflow.LeadEnrolled is {
        prompt "Increment total leads enrolled"
      }
      on event AutomationWorkflow.WorkflowCompleted is {
        prompt "Increment workflows completed and calculate conversion rate"
      }
    } with {
      briefly "Maintains automation metrics"
      described as {
        |Projects events into automation metrics.
      }
    }
  } with {
    briefly "Automation metrics"
    described as {
      |Marketing automation analytics.
    }
  }
} with {
  briefly "Bounded context for marketing automation"
  described as {
    |Marketing automation workflow context.
  }
}
