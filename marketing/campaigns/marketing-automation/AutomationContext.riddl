// Marketing Automation - Automation Context

context AutomationContext is {

  include "types.riddl"
  include "AutomationWorkflow.riddl"

  repository AutomationRepository is {
    schema AutomationData is relational
      of automationWorkflows as AutomationWorkflow
      index on field AutomationWorkflow.workflowId
      index on field AutomationWorkflow.campaignId
      index on field AutomationWorkflow.status

    handler AutomationPersistence is {
      on event AutomationWorkflow.WorkflowCreated {
        prompt "Store new automation workflow"
      }
      on event AutomationWorkflow.WorkflowActivated {
        prompt "Update workflow to activated"
      }
      on event AutomationWorkflow.LeadEnrolled {
        prompt "Store lead enrollment"
      }
      on event AutomationWorkflow.LeadStepAdvanced {
        prompt "Update lead step progress"
      }
      on event AutomationWorkflow.ABTestResultRecorded {
        prompt "Store A/B test results"
      }
      on event AutomationWorkflow.WorkflowCompleted {
        prompt "Update workflow to completed"
      }
    } with {
      briefly "Persists automation events"
      described by "Handles event-driven persistence."
    }
  } with {
    briefly "Automation data persistence"
    described by "Persistent storage for automation workflows."
  }

  projector AutomationMetrics is {
    updates repository AutomationRepository

    record WorkflowMetrics is {
      workflowsCreated is Natural with { briefly "Created" described by "Workflows created." }
      workflowsActive is Natural with { briefly "Active" described by "Workflows active." }
      workflowsCompleted is Natural with { briefly "Completed" described by "Workflows completed." }
      totalLeadsEnrolled is Natural with { briefly "Enrolled" described by "Total leads enrolled." }
      averageConversionRate is Decimal(8, 4) with { briefly "Conversion" described by "Average conversion rate." }
    } with {
      briefly "Workflow metrics"
      described by "Automation workflow metrics."
    }

    handler MetricsHandler is {
      on event AutomationWorkflow.WorkflowCreated {
        prompt "Increment workflows created"
      }
      on event AutomationWorkflow.WorkflowActivated {
        prompt "Increment workflows active"
      }
      on event AutomationWorkflow.LeadEnrolled {
        prompt "Increment total leads enrolled"
      }
      on event AutomationWorkflow.WorkflowCompleted {
        prompt "Increment workflows completed and calculate conversion rate"
      }
    } with {
      briefly "Maintains automation metrics"
      described by "Projects events into automation metrics."
    }
  } with {
    briefly "Automation metrics"
    described by "Marketing automation analytics."
  }

} with {
  briefly "Bounded context for marketing automation"
  described by "Marketing automation workflow context."
}
