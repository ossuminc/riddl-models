// Email Marketing - Email Campaign Entity

entity EmailCampaign is {

  command CreateCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "New campaign identifier."
    }
    name is String(1, 200) with {
      briefly "Name"
      described by "Campaign name."
    }
    campaignType is CampaignType with {
      briefly "Type"
      described by "Campaign type."
    }
    template is EmailTemplate with {
      briefly "Template"
      described by "Email template."
    }
    sendSettings is SendSettings with {
      briefly "Settings"
      described by "Send settings."
    }
  } with {
    briefly "Create campaign"
    described by "Creates a new email campaign."
  }

  command SetAudience is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    lists is many ListId with {
      briefly "Lists"
      described by "Target mailing lists."
    }
    segments is many optional AudienceSegment with {
      briefly "Segments"
      described by "Audience segments."
    }
    excludeLists is many optional ListId with {
      briefly "Exclude"
      described by "Lists to exclude."
    }
  } with {
    briefly "Set audience"
    described by "Sets campaign recipients."
  }

  command UpdateTemplate is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    template is EmailTemplate with {
      briefly "Template"
      described by "Updated template."
    }
  } with {
    briefly "Update template"
    described by "Updates email content."
  }

  command ConfigureABTest is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    testConfig is ABTestConfig with {
      briefly "Config"
      described by "A/B test configuration."
    }
  } with {
    briefly "Configure A/B test"
    described by "Sets up A/B testing."
  }

  command ScheduleCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    schedule is ScheduleInfo with {
      briefly "Schedule"
      described by "Send schedule."
    }
  } with {
    briefly "Schedule campaign"
    described by "Schedules campaign send."
  }

  command SendImmediately is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
  } with {
    briefly "Send immediately"
    described by "Sends campaign now."
  }

  command PauseCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    reason is optional String(1, 500) with {
      briefly "Reason"
      described by "Pause reason."
    }
  } with {
    briefly "Pause campaign"
    described by "Pauses sending."
  }

  command ResumeCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
  } with {
    briefly "Resume campaign"
    described by "Resumes sending."
  }

  command CancelCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    reason is String(1, 500) with {
      briefly "Reason"
      described by "Cancel reason."
    }
  } with {
    briefly "Cancel campaign"
    described by "Cancels campaign."
  }

  command RecordDelivery is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    metrics is DeliveryMetrics with {
      briefly "Metrics"
      described by "Delivery metrics."
    }
  } with {
    briefly "Record delivery"
    described by "Updates delivery metrics."
  }

  command RecordEngagement is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    subscriberId is SubscriberId with {
      briefly "Subscriber"
      described by "Subscriber ID."
    }
    engagementType is String(1, 20) with {
      briefly "Type"
      described by "Open, click, etc."
    }
    details is optional String(1, 500) with {
      briefly "Details"
      described by "Engagement details."
    }
  } with {
    briefly "Record engagement"
    described by "Records subscriber action."
  }

  command CompleteCampaign is {
    campaignId is EmailCampaignId with {
      briefly "Campaign ID"
      described by "Campaign identifier."
    }
    finalMetrics is DeliveryMetrics with {
      briefly "Metrics"
      described by "Final delivery metrics."
    }
    engagementRates is EngagementRates with {
      briefly "Rates"
      described by "Engagement rates."
    }
  } with {
    briefly "Complete campaign"
    described by "Marks campaign as sent."
  }

  // Events
  event CampaignCreated is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    name is String(1, 200) with { briefly "Name" described by "Campaign name." }
    campaignType is CampaignType with { briefly "Type" described by "Campaign type." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Campaign created"
    described by "Emitted when campaign created."
  }

  event AudienceSet is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    totalRecipients is Natural with { briefly "Recipients" described by "Total recipients." }
    setAt is TimeStamp with { briefly "Set" described by "Set time." }
  } with {
    briefly "Audience set"
    described by "Emitted when audience defined."
  }

  event TemplateUpdated is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    templateId is TemplateId with { briefly "Template" described by "Template ID." }
    updatedAt is TimeStamp with { briefly "Updated" described by "Update time." }
  } with {
    briefly "Template updated"
    described by "Emitted when content updated."
  }

  event ABTestConfigured is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    testConfig is ABTestConfig with { briefly "Config" described by "Test config." }
    configuredAt is TimeStamp with { briefly "Configured" described by "Config time." }
  } with {
    briefly "A/B test configured"
    described by "Emitted when test set up."
  }

  event CampaignScheduled is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    schedule is ScheduleInfo with { briefly "Schedule" described by "Send schedule." }
    scheduledAt is TimeStamp with { briefly "Scheduled" described by "Schedule time." }
  } with {
    briefly "Campaign scheduled"
    described by "Emitted when scheduled."
  }

  event CampaignSending is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    startedAt is TimeStamp with { briefly "Started" described by "Start time." }
    totalRecipients is Natural with { briefly "Recipients" described by "Total recipients." }
  } with {
    briefly "Campaign sending"
    described by "Emitted when send starts."
  }

  event CampaignPaused is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    reason is optional String(1, 500) with { briefly "Reason" described by "Pause reason." }
    pausedAt is TimeStamp with { briefly "Paused" described by "Pause time." }
  } with {
    briefly "Campaign paused"
    described by "Emitted when paused."
  }

  event CampaignResumed is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    resumedAt is TimeStamp with { briefly "Resumed" described by "Resume time." }
  } with {
    briefly "Campaign resumed"
    described by "Emitted when resumed."
  }

  event CampaignCancelled is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    reason is String(1, 500) with { briefly "Reason" described by "Cancel reason." }
    cancelledAt is TimeStamp with { briefly "Cancelled" described by "Cancel time." }
  } with {
    briefly "Campaign cancelled"
    described by "Emitted when cancelled."
  }

  event DeliveryRecorded is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    metrics is DeliveryMetrics with { briefly "Metrics" described by "Delivery metrics." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Delivery recorded"
    described by "Emitted when metrics updated."
  }

  event EngagementRecorded is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    subscriberId is SubscriberId with { briefly "Subscriber" described by "Subscriber." }
    engagementType is String(1, 20) with { briefly "Type" described by "Engagement type." }
    recordedAt is TimeStamp with { briefly "Recorded" described by "Record time." }
  } with {
    briefly "Engagement recorded"
    described by "Emitted when action tracked."
  }

  event CampaignCompleted is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    finalMetrics is DeliveryMetrics with { briefly "Metrics" described by "Final metrics." }
    engagementRates is EngagementRates with { briefly "Rates" described by "Engagement rates." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Campaign completed"
    described by "Emitted when fully sent."
  }

  // States
  record ActiveStateData is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    name is String(1, 200) with { briefly "Name" described by "Campaign name." }
    campaignType is CampaignType with { briefly "Type" described by "Campaign type." }
    status is CampaignStatus with { briefly "Status" described by "Campaign status." }
    template is EmailTemplate with { briefly "Template" described by "Email template." }
    sendSettings is SendSettings with { briefly "Settings" described by "Send settings." }
    targetLists is many optional ListId with { briefly "Lists" described by "Target lists." }
    segments is many optional AudienceSegment with { briefly "Segments" described by "Segments." }
    totalRecipients is optional Natural with { briefly "Recipients" described by "Total recipients." }
    schedule is optional ScheduleInfo with { briefly "Schedule" described by "Send schedule." }
    abTestConfig is optional ABTestConfig with { briefly "A/B test" described by "Test config." }
    currentMetrics is optional DeliveryMetrics with { briefly "Metrics" described by "Current metrics." }
    createdAt is TimeStamp with { briefly "Created" described by "Creation time." }
  } with {
    briefly "Active campaign state"
    described by "In-progress campaign data."
  }

  record CompletedStateData is {
    campaignId is EmailCampaignId with { briefly "Campaign" described by "Campaign ID." }
    name is String(1, 200) with { briefly "Name" described by "Campaign name." }
    finalMetrics is DeliveryMetrics with { briefly "Metrics" described by "Final metrics." }
    engagementRates is EngagementRates with { briefly "Rates" described by "Engagement rates." }
    completedAt is TimeStamp with { briefly "Completed" described by "Completion time." }
  } with {
    briefly "Completed campaign state"
    described by "Finished campaign data."
  }

  state ActiveState of EmailCampaign.ActiveStateData with {
    briefly "Campaign active"
    described by "Campaign is in progress."
  }

  state CompletedState of EmailCampaign.CompletedStateData with {
    briefly "Campaign completed"
    described by "Campaign has been sent."
  }

  handler EmailCampaignHandler is {
    on command CreateCampaign {
      morph entity EmailContext.EmailCampaign to state EmailContext.EmailCampaign.ActiveState with command CreateCampaign
      tell event CampaignCreated to entity EmailContext.EmailCampaign
    }
    on command SetAudience {
      tell event AudienceSet to entity EmailContext.EmailCampaign
    }
    on command UpdateTemplate {
      tell event TemplateUpdated to entity EmailContext.EmailCampaign
    }
    on command ConfigureABTest {
      tell event ABTestConfigured to entity EmailContext.EmailCampaign
    }
    on command ScheduleCampaign {
      tell event CampaignScheduled to entity EmailContext.EmailCampaign
    }
    on command SendImmediately {
      tell event CampaignSending to entity EmailContext.EmailCampaign
    }
    on command PauseCampaign {
      tell event CampaignPaused to entity EmailContext.EmailCampaign
    }
    on command ResumeCampaign {
      tell event CampaignResumed to entity EmailContext.EmailCampaign
    }
    on command CancelCampaign {
      tell event CampaignCancelled to entity EmailContext.EmailCampaign
    }
    on command RecordDelivery {
      tell event DeliveryRecorded to entity EmailContext.EmailCampaign
    }
    on command RecordEngagement {
      tell event EngagementRecorded to entity EmailContext.EmailCampaign
    }
    on command CompleteCampaign {
      morph entity EmailContext.EmailCampaign to state EmailContext.EmailCampaign.CompletedState with command CompleteCampaign
      tell event CampaignCompleted to entity EmailContext.EmailCampaign
    }
  } with {
    briefly "Processes campaign commands"
    described by "Handles campaign lifecycle."
  }

} with {
  briefly "Email campaign aggregate"
  described by "Manages email campaigns."
}
