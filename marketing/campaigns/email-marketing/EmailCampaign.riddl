// Email Marketing - Email Campaign Entity
entity EmailCampaign is {
  command CreateCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |New campaign identifier.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Campaign name.
      }
    }
    campaignType: CampaignType with {
      briefly "Type"
      described as {
        |Campaign type.
      }
    }
    template: EmailTemplate with {
      briefly "Template"
      described as {
        |Email template.
      }
    }
    sendSettings: SendSettings with {
      briefly "Settings"
      described as {
        |Send settings.
      }
    }
  } with {
    briefly "Create campaign"
    described as {
      |Creates a new email campaign.
    }
  }
  command SetAudience is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    lists: ListId+ with {
      briefly "Lists"
      described as {
        |Target mailing lists.
      }
    }
    segments: AudienceSegment* with {
      briefly "Segments"
      described as {
        |Audience segments.
      }
    }
    excludeLists: ListId* with {
      briefly "Exclude"
      described as {
        |Lists to exclude.
      }
    }
  } with {
    briefly "Set audience"
    described as {
      |Sets campaign recipients.
    }
  }
  command UpdateTemplate is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    template: EmailTemplate with {
      briefly "Template"
      described as {
        |Updated template.
      }
    }
  } with {
    briefly "Update template"
    described as {
      |Updates email content.
    }
  }
  command ConfigureABTest is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    testConfig: ABTestConfig with {
      briefly "Config"
      described as {
        |A/B test configuration.
      }
    }
  } with {
    briefly "Configure A/B test"
    described as {
      |Sets up A/B testing.
    }
  }
  command ScheduleCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    schedule: ScheduleInfo with {
      briefly "Schedule"
      described as {
        |Send schedule.
      }
    }
  } with {
    briefly "Schedule campaign"
    described as {
      |Schedules campaign send.
    }
  }
  command SendImmediately is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
  } with {
    briefly "Send immediately"
    described as {
      |Sends campaign now.
    }
  }
  command PauseCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    pauseReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
  } with {
    briefly "Pause campaign"
    described as {
      |Pauses sending.
    }
  }
  command ResumeCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
  } with {
    briefly "Resume campaign"
    described as {
      |Resumes sending.
    }
  }
  command CancelCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
  } with {
    briefly "Cancel campaign"
    described as {
      |Cancels campaign.
    }
  }
  command RecordDelivery is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    metrics: DeliveryMetrics with {
      briefly "Metrics"
      described as {
        |Delivery metrics.
      }
    }
  } with {
    briefly "Record delivery"
    described as {
      |Updates delivery metrics.
    }
  }
  command RecordEngagement is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber ID.
      }
    }
    engagementType: String(1,20) with {
      briefly "Type"
      described as {
        |Open, click, etc.
      }
    }
    details: String(1,500)? with {
      briefly "Details"
      described as {
        |Engagement details.
      }
    }
  } with {
    briefly "Record engagement"
    described as {
      |Records subscriber action.
    }
  }
  command CompleteCampaign is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign ID"
      described as {
        |Campaign identifier.
      }
    }
    finalMetrics: DeliveryMetrics with {
      briefly "Metrics"
      described as {
        |Final delivery metrics.
      }
    }
    engagementRates: EngagementRates with {
      briefly "Rates"
      described as {
        |Engagement rates.
      }
    }
  } with {
    briefly "Complete campaign"
    described as {
      |Marks campaign as sent.
    }
  }
  // Events
  event CampaignCreated is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Campaign name.
      }
    }
    campaignType: CampaignType with {
      briefly "Type"
      described as {
        |Campaign type.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Campaign created"
    described as {
      |Emitted when campaign created.
    }
  }
  event AudienceSet is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    totalRecipients: Natural with {
      briefly "Recipients"
      described as {
        |Total recipients.
      }
    }
    setAt: TimeStamp with {
      briefly "Set"
      described as {
        |Set time.
      }
    }
  } with {
    briefly "Audience set"
    described as {
      |Emitted when audience defined.
    }
  }
  event TemplateUpdated is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    templateId: TemplateId with {
      briefly "Template"
      described as {
        |Template ID.
      }
    }
    updatedAt: TimeStamp with {
      briefly "Updated"
      described as {
        |Update time.
      }
    }
  } with {
    briefly "Template updated"
    described as {
      |Emitted when content updated.
    }
  }
  event ABTestConfigured is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    testConfig: ABTestConfig with {
      briefly "Config"
      described as {
        |Test config.
      }
    }
    configuredAt: TimeStamp with {
      briefly "Configured"
      described as {
        |Config time.
      }
    }
  } with {
    briefly "A/B test configured"
    described as {
      |Emitted when test set up.
    }
  }
  event CampaignScheduled is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    schedule: ScheduleInfo with {
      briefly "Schedule"
      described as {
        |Send schedule.
      }
    }
    scheduledAt: TimeStamp with {
      briefly "Scheduled"
      described as {
        |Schedule time.
      }
    }
  } with {
    briefly "Campaign scheduled"
    described as {
      |Emitted when scheduled.
    }
  }
  event CampaignSending is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    startedAt: TimeStamp with {
      briefly "Started"
      described as {
        |Start time.
      }
    }
    totalRecipients: Natural with {
      briefly "Recipients"
      described as {
        |Total recipients.
      }
    }
  } with {
    briefly "Campaign sending"
    described as {
      |Emitted when send starts.
    }
  }
  event CampaignPaused is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    pauseReason: String(1,500)? with {
      briefly "Reason"
      described as {
        |Pause reason.
      }
    }
    pausedAt: TimeStamp with {
      briefly "Paused"
      described as {
        |Pause time.
      }
    }
  } with {
    briefly "Campaign paused"
    described as {
      |Emitted when paused.
    }
  }
  event CampaignResumed is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    resumedAt: TimeStamp with {
      briefly "Resumed"
      described as {
        |Resume time.
      }
    }
  } with {
    briefly "Campaign resumed"
    described as {
      |Emitted when resumed.
    }
  }
  event CampaignCancelled is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    reason: String(1,500) with {
      briefly "Reason"
      described as {
        |Cancel reason.
      }
    }
    cancelledAt: TimeStamp with {
      briefly "Cancelled"
      described as {
        |Cancel time.
      }
    }
  } with {
    briefly "Campaign cancelled"
    described as {
      |Emitted when cancelled.
    }
  }
  event DeliveryRecorded is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    metrics: DeliveryMetrics with {
      briefly "Metrics"
      described as {
        |Delivery metrics.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Delivery recorded"
    described as {
      |Emitted when metrics updated.
    }
  }
  event EngagementRecorded is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    subscriberId: SubscriberId with {
      briefly "Subscriber"
      described as {
        |Subscriber.
      }
    }
    engagementType: String(1,20) with {
      briefly "Type"
      described as {
        |Engagement type.
      }
    }
    recordedAt: TimeStamp with {
      briefly "Recorded"
      described as {
        |Record time.
      }
    }
  } with {
    briefly "Engagement recorded"
    described as {
      |Emitted when action tracked.
    }
  }
  event CampaignCompleted is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    finalMetrics: DeliveryMetrics with {
      briefly "Metrics"
      described as {
        |Final metrics.
      }
    }
    engagementRates: EngagementRates with {
      briefly "Rates"
      described as {
        |Engagement rates.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Campaign completed"
    described as {
      |Emitted when fully sent.
    }
  }
  // States
  record ActiveStateData is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Campaign name.
      }
    }
    campaignType: CampaignType with {
      briefly "Type"
      described as {
        |Campaign type.
      }
    }
    status: CampaignStatus with {
      briefly "Status"
      described as {
        |Campaign status.
      }
    }
    template: EmailTemplate with {
      briefly "Template"
      described as {
        |Email template.
      }
    }
    sendSettings: SendSettings with {
      briefly "Settings"
      described as {
        |Send settings.
      }
    }
    targetLists: ListId* with {
      briefly "Lists"
      described as {
        |Target lists.
      }
    }
    segments: AudienceSegment* with {
      briefly "Segments"
      described as {
        |Segments.
      }
    }
    estimatedRecipients: Natural? with {
      briefly "Recipients"
      described as {
        |Total recipients.
      }
    }
    currentSchedule: ScheduleInfo? with {
      briefly "Schedule"
      described as {
        |Send schedule.
      }
    }
    abTestConfig: ABTestConfig? with {
      briefly "A/B test"
      described as {
        |Test config.
      }
    }
    currentMetrics: DeliveryMetrics? with {
      briefly "Metrics"
      described as {
        |Current metrics.
      }
    }
    createdAt: TimeStamp with {
      briefly "Created"
      described as {
        |Creation time.
      }
    }
  } with {
    briefly "Active campaign state"
    described as {
      |In-progress campaign data.
    }
  }
  record CompletedStateData is  {
    campaignId: EmailCampaignId with {
      briefly "Campaign"
      described as {
        |Campaign ID.
      }
    }
    name: String(1,200) with {
      briefly "Name"
      described as {
        |Campaign name.
      }
    }
    finalMetrics: DeliveryMetrics with {
      briefly "Metrics"
      described as {
        |Final metrics.
      }
    }
    engagementRates: EngagementRates with {
      briefly "Rates"
      described as {
        |Engagement rates.
      }
    }
    completedAt: TimeStamp with {
      briefly "Completed"
      described as {
        |Completion time.
      }
    }
  } with {
    briefly "Completed campaign state"
    described as {
      |Finished campaign data.
    }
  }
  state ActiveState of type EmailCampaign.ActiveStateData
  state CompletedState of type EmailCampaign.CompletedStateData
  handler EmailCampaignHandler is {
    on command CreateCampaign is {
      morph entity EmailContext.EmailCampaign to state EmailContext.EmailCampaign.ActiveState with command CreateCampaign
      tell event CampaignCreated to entity EmailContext.EmailCampaign
    }
    on command SetAudience is {
      tell event AudienceSet to entity EmailContext.EmailCampaign
    }
    on command UpdateTemplate is {
      tell event TemplateUpdated to entity EmailContext.EmailCampaign
    }
    on command ConfigureABTest is {
      tell event ABTestConfigured to entity EmailContext.EmailCampaign
    }
    on command ScheduleCampaign is {
      tell event CampaignScheduled to entity EmailContext.EmailCampaign
    }
    on command SendImmediately is {
      tell event CampaignSending to entity EmailContext.EmailCampaign
    }
    on command PauseCampaign is {
      tell event CampaignPaused to entity EmailContext.EmailCampaign
    }
    on command ResumeCampaign is {
      tell event CampaignResumed to entity EmailContext.EmailCampaign
    }
    on command CancelCampaign is {
      tell event CampaignCancelled to entity EmailContext.EmailCampaign
    }
    on command RecordDelivery is {
      tell event DeliveryRecorded to entity EmailContext.EmailCampaign
    }
    on command RecordEngagement is {
      tell event EngagementRecorded to entity EmailContext.EmailCampaign
    }
    on command CompleteCampaign is {
      morph entity EmailContext.EmailCampaign to state EmailContext.EmailCampaign.CompletedState with command CompleteCampaign
      tell event CampaignCompleted to entity EmailContext.EmailCampaign
    }
  } with {
    briefly "Processes campaign commands"
    described as {
      |Handles campaign lifecycle.
    }
  }
} with {
  briefly "Email campaign aggregate"
  described as {
    |Manages email campaigns.
  }
}
